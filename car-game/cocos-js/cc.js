System.register([],(function(e,t){"use strict";return{execute:function(){e({BitMask:Ye,CCClass:Vt,CacheMode:void 0,DebugMode:void 0,EAxisDirection:void 0,ERigidBodyType:void 0,Enum:Qe,Eventify:sn,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:BA,WorldNode3DToWorldNodeUI:FA,absMax:pi,absMaxComponent:_i,approx:Zn,assert:m,assertID:I,bezier:U_,bezierByTime:ip,ccenum:$e,clamp:Jn,clamp01:$n,color:gi,computeRatioByType:oG,createDefaultPipeline:FM,debug:v,deserialize:Hh,earcut:$8,enumerableProps:di,equals:Qn,error:d,errorID:A,find:MO,fragmentText:L$,getBaselineOffset:function(){return 0},getError:P,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[fl]},getWorldTransformUntilRoot:HW,instantiate:af,inverseLerp:fi,isCustomTargetModifier:KW,isDisplayStats:O,isElementModifier:YW,isPropertyModifier:XW,isUnicodeCJK:O$,isUnicodeSpace:D$,isValid:Jt,lerp:ei,log:_,logID:T,markAsWarning:void 0,mat4:Fi,murmurhash2_32_gc:Ma,nextPow2:li,pingPong:hi,pseudoRandom:ai,pseudoRandomRange:si,pseudoRandomRangeInt:ci,quat:Di,randomRange:ri,randomRangeInt:oi,rect:Yi,removeProperty:void 0,repeat:ui,replaceProperty:void 0,safeMeasureText:M$,sampleAnimationCurve:rG,setDefaultLogTimes:function(e){e>0&&(jn=e)},setDisplayStats:D,size:qi,toDegree:ni,toRadian:ti,tween:uDe,tweenUtil:hDe,v2:Gi,v3:Ti,v4:Vi,warn:p,warnID:b});var n="undefined"==typeof window?global:window,i=e("cclegacy",{_global:n});i.internal={},n.CC_BUILD=!0,n.CC_TEST=!1,n.CC_EDITOR=false,n.CC_PREVIEW=!1,n.CC_DEV=!1,n.CC_DEBUG=!1,n.CC_JSB=!1,n.CC_BYTEDANCE=!1,n.CC_WECHAT=!1,n.CC_ALIPAY=!1,n.CC_XIAOMI=!1,n.CC_BAIDU=!1,n.CC_COCOSPLAY=!1,n.CC_HUAWEI=!1,n.CC_OPPO=!1,n.CC_VIVO=!1,n.CC_MINIGAME=!1,n.CC_RUNTIME_BASED=!1,n.CC_SUPPORT_JIT=!0,n.CC_UI_GPU_DRIVEN=!1;var r=e("VERSION","3.4.0");n.CocosEngine=i.ENGINE_VERSION=r,n.cc=i;var o="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",a=null,s=console.log.bind(console),c=s,l=s,u=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+f.apply(void 0,[t].concat(i)))}},h=s;function f(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return i.js.formatStr.apply(null,[e].concat(n))}function _(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return s.apply(void 0,[e].concat(n))}function p(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return c.apply(void 0,[e].concat(n))}function d(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return l.apply(void 0,[e].concat(n))}function m(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return u.apply(void 0,[e,t].concat(i))}function v(){return h.apply(void 0,arguments)}function g(e){if(s=c=l=u=h=function(){},e!==w.NONE){if(e>w.ERROR){var t=function(e){if(i.game.canvas){if(!a){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",i.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(a=document.createElement("textarea")).setAttribute("rows","20"),a.setAttribute("cols","30"),a.setAttribute("disabled","true");var r=a.style;r.backgroundColor="transparent",r.borderBottom="1px solid #cccccc",r.borderTopWidth=r.borderLeftWidth=r.borderRightWidth="0px",r.borderTopStyle=r.borderLeftStyle=r.borderRightStyle="none",r.padding="0px",r.margin="0px",t.appendChild(a),i.game.canvas.parentNode.appendChild(t)}a.value=a.value+e+"\r\n",a.scrollTop=a.scrollHeight}};l=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  "+f.apply(void 0,[e].concat(i)))},u=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];t("ASSERT: "+f.apply(void 0,[n].concat(r)))}},e!==w.ERROR_FOR_WEB_PAGE&&(c=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  "+f.apply(void 0,[e].concat(i)))}),e===w.INFO_FOR_WEB_PAGE&&(s=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(f.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),l=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},u=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=f.apply(void 0,[t].concat(i));throw new Error(o)}});if(e!==w.ERROR&&(c=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e<=w.INFO&&(s=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=w.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);h=function(){return n.apply(void 0,arguments)}}}}function y(e){d(e.stack||e)}function S(e){return function(t){for(var n=e+" "+t+", please go to "+o+"#"+t+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),a=1;a<i;a++)r[a-1]=arguments[a];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var x=S("Log");function T(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];_(x.apply(void 0,[e].concat(n)))}var E=S("Warning");function b(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];p(E.apply(void 0,[e].concat(n)))}var C=S("Error");function A(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];d(C.apply(void 0,[e].concat(n)))}var w,R=S("Assert");function I(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];m(!1,R.apply(void 0,[t].concat(i)))}}function P(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return C.apply(void 0,[e].concat(n))}function O(){return!!i.profiler&&i.profiler.isShowingStats()}function D(e){i.profiler&&(e?i.profiler.showStats():i.profiler.hideStats(),i.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(w||(w=e("DebugMode",{})));var M=Object.freeze({__proto__:null,log:_,warn:p,error:d,assert:m,debug:v,_resetDebugSetting:g,_throw:y,logID:T,warnID:b,errorID:A,assertID:I,get DebugMode(){return w},getError:P,isDisplayStats:O,setDisplayStats:D});function N(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function L(e,t,n){return t&&N(e.prototype,t),n&&N(e,n),e}function B(){return(B=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function F(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,U(e,t)}function z(e){return(z=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function U(e,t){return(U=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function k(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function G(e,t,n){return(G=k()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&U(r,n.prototype),r}).apply(null,arguments)}function H(e){var t="function"==typeof Map?new Map:void 0;return(H=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return G(e,arguments,z(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),U(i,e)})(e)}function V(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function j(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function W(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return j(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?j(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function q(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function X(e,t,n,i,r){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}var Y=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},L(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function K(e,t){e.splice(t,1)}function Q(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function Z(e,t){var n=e.indexOf(t);return n>=0&&(K(e,n),!0)}function J(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return K(e,n),i}}function $(e,t){return e.indexOf(t)>=0}var ee=Object.freeze({__proto__:null,removeAt:K,fastRemoveAt:Q,remove:Z,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:J,verifyType:function(e,t){if(e&&e.length>0)for(var n,i=W(e);!(n=i()).done;)if(!(n.value instanceof t))return T(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)Z(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:$,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:Y}),te=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();te.global=new te("global");var ne=new te("TmpCId."),ie="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),re="__cid__";function oe(e){return"number"==typeof e||e instanceof Number}function ae(e){return"string"==typeof e||e instanceof String}function se(e){for(var t in e)return!1;return!0}var ce,le=(ce={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){ce.value=n,ce.writable=i,ce.enumerable=r,Object.defineProperty(e,t,ce),ce.value=void 0}),ue=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),e.get=i,e.set=r,e.enumerable=o,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),he=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.get=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0}}(),fe=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.set=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.set=void 0}}();function _e(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function pe(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?pe(e.constructor):""}function de(e,t,n,i){var r=/([^.]+)$/,o=r.exec(t)[0],a=r.exec(n)[0];function s(){return this[a]}i?ue(e,o,s,(function(e){this[a]=e})):he(e,o,s)}function me(e,t,n,i){for(var r in n)de(e,t+"."+r,n[r],i)}var ve=/(%d)|(%s)/,ge=/%s/;function ye(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var r="string"==typeof e&&ve.test(e);if(r)for(var o,a=W(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?ve:ge;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=W(n);!(u=h()).done;){var f=u.value;e+=" "+f}return e}function Se(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function xe(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function Te(e,t,n){var i=xe(t,e);i&&Object.defineProperty(n,e,i)}function Ee(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){A(5402,a);continue}for(var s in a)s in e||Te(s,a,e)}}return e}function be(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){A(5403,a);continue}for(var s in a)Te(s,a,e)}}return e}function Ce(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ae(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function we(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ae(e)))return!1;if(e===t)return!0}}return!1}function Re(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var Ie=_e(!0),Pe=_e(!0);function Oe(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],le(i.prototype,e,n),n){var r=t[n];r&&r!==i?d("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var De=Oe("__cid__",Ie),Me=Oe("__classname__",Pe);function Ne(e,t){if(Me(e,t),!t.prototype.hasOwnProperty(re)){var n=e||ne.getNewId();n&&De(n,t)}}function Le(e,t){var n=Pe[t],i=Ie[t],r=!0;if(n&&n!==e&&(d('"'+t+'" has already been set as name or alias of another class.'),r=!1),i&&i!==e&&(d('"'+t+'" has already been set as id or alias of another class.'),r=!1),r){var o=e[ie];o||(o=[],e[ie]=o),o.push(t),Pe[t]=e,Ie[t]=e}}function Be(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete Ie[s];var c=a.__classname__;c&&delete Pe[c];var l=a[ie];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete Pe[h],delete Ie[h]}}}function Fe(e){return Ie[e]}function ze(e){return Pe[e]}function Ue(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(re))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(re))return e.__cid__}return""}var ke=function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}(),Ge=ee,He={IDGenerator:te,Pool:ke,array:ee,isNumber:oe,isString:ae,isEmptyObject:se,getPropertyDescriptor:xe,addon:Ee,mixin:be,extend:Ce,getSuper:Ae,isChildClassOf:we,clear:Re,value:le,getset:ue,get:he,set:fe,unregisterClass:Be,getClassName:pe,setClassName:Ne,setClassAlias:Le,getClassByName:ze,get _registeredClassNames(){return B({},Pe)},set _registeredClassNames(e){Re(Pe),Object.assign(Pe,e)},get _registeredClassIds(){return B({},Ie)},set _registeredClassIds(e){Re(Ie),Object.assign(Ie,e)},_getClassId:Ue,_setClassId:De,_getClassById:Fe,obsolete:de,obsoletes:me,formatStr:ye,shiftArguments:Se,createMap:_e};i.js=He,e("js",Object.freeze({__proto__:null,array:Ge,js:He,IDGenerator:te,Pool:ke,isNumber:oe,isString:ae,isEmptyObject:se,value:le,getset:ue,get:he,set:fe,createMap:_e,getClassName:pe,obsolete:de,obsoletes:me,formatStr:ye,shiftArguments:Se,getPropertyDescriptor:xe,addon:Ee,mixin:be,extend:Ce,getSuper:Ae,isChildClassOf:we,clear:Re,_idToClass:Ie,_nameToClass:Pe,_setClassId:De,setClassName:Ne,setClassAlias:Le,unregisterClass:Be,_getClassById:Fe,getClassByName:ze,_getClassId:Ue}));var Ve=new(function(){function e(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var t=e.prototype;return t.addContainer=function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))},t.removeContainer=function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,He.array.fastRemoveAt(this._pools,e._poolHandle),e._poolHandle=-1)},t.tryShrink=function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()},t.update=function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},e}()),je=function(){function e(){this._poolHandle=-1,Ve.addContainer(this)}return e.prototype.destroy=function(){Ve.removeContainer(this)},e}(),We=e("Pool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=t,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(t());return r}F(t,e);var n=t.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(e){this._freepool[++this._nextAvail]=e},n.freeArray=function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var t=arguments.length>0?arguments[0]:null;t&&b(14100);var n=t||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,e.prototype.destroy.call(this)},t}(je)),qe=e("RecyclePool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=t,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=t();return r}F(t,e);var n=t.prototype;return n.reset=function(){this._count=0},n.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,e.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}},n.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},L(t,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(je)),Xe=e("CachedArray",function(e){function t(t,n){var i;return(i=e.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(t),i._initSize=t,i.length=0,i._compareFn=void 0!==n?n:function(e,t){return e-t},i}F(t,e);var n=t.prototype;return n.push=function(e){this.array[this.length++]=e},n.pop=function(){return this.array[--this.length]},n.get=function(e){return this.array[e]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,e.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},n.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},n.indexOf=function(e){for(var t=0,n=this.length;t<n;++t)if(this.array[t]===e)return t;return-1},t}(je));function Ye(e){if("__bitmask__"in e)return e;le(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&le(e,a,r)}return e}function Ke(e,t){t>=0&&e.length,e.length}function Qe(e){return"__enums__"in e?e:(le(e,"__enums__",null,!0),Qe.update(e))}function Ze(e){e.hasOwnProperty("__enums__")}function Je(e){Ze(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function $e(e){"__enums__"in e||le(e,"__enums__",null,!0)}e("memop",Object.freeze({__proto__:null,Pool:We,RecyclePool:qe,CachedArray:Xe})),Ye.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},Ye.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},i.BitMask=Ye,Qe.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&le(e,a,r)}return Array.isArray(e.__enums__)&&Je(e),e},Qe||(Qe=e("Enum",{})),Qe.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},Qe.getList=function(e){return Ze(e),e.__enums__?e.__enums__:Je(e)},i.Enum=Qe;var et=e("ValueType",function(){function e(){}var t=e.prototype;return t.clone=function(){return A(100,pe(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){A(100,pe(this)+".set")},t.toString=function(){return""+{}},e}());Ne("cc.ValueType",et),i.ValueType=et;var tt=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20});i.macro=tt;for(var nt=/^(?:cc|dragonBones|sp|ccsg)\..+/,it=new Array(123),rt=0;rt<123;++rt)it[rt]=64;for(var ot=0;ot<64;++ot)it["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(ot)]=ot;var at=it;function st(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var o=e[n];ue(e,t,o,e[i])}}for(var r,o=e.prototype,a=0;a<t.length;a++){var s=(r=t[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function ct(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function lt(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function ut(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function ht(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function ft(e){return!(!e||e.constructor!==Object)&&se(e)}function _t(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function pt(e){return e*tt.RAD}function dt(e){return e*tt.DEG}i.misc={BUILTIN_CLASSID_RE:nt,BASE64_VALUES:at,propertyDefine:st,pushToMap:ct,contains:lt,isDomNode:ut,callInNextTick:ht,isPlainEmptyObj_DEV:ft,clampf:_t,degreesToRadians:pt,radiansToDegrees:dt},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:nt,BASE64_VALUES:at,propertyDefine:st,pushToMap:ct,contains:lt,isDomNode:ut,callInNextTick:ht,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:ft,clampf:_t,degreesToRadians:pt,radiansToDegrees:dt}));var mt="$_$";function vt(e,t){var n=t?Object.create(t):{};return le(e,"__attrs__",n),n}function gt(e){if("function"!=typeof e)return vt(e,St(e.constructor));for(var t,n=i.Class.getInheritanceChain(e),r=n.length-1;r>=0;r--){var o=n[r];o.hasOwnProperty("__attrs__")&&o.__attrs__||vt(o,(t=n[r+1])&&t.__attrs__)}return vt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function yt(e,t){var n=St(e),i=t+mt,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function St(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||gt(e)}function xt(e,t,n,i){St(e)[t+mt+n]=i}var Tt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),Et=e("CCInteger",new Tt("Integer",0));i.Integer=Et,i.CCInteger=Et;var bt=e("CCFloat",new Tt("Float",0));i.Float=bt,i.CCFloat=bt;var Ct=e("CCBoolean",new Tt("Boolean",!1));i.Boolean=Ct,i.CCBoolean=Ct;var At=e("CCString",new Tt("String",""));function wt(e,t){return function(n,i){var r='"'+pe(n)+"."+i+'"',o=yt(n,i),a=o.type;if(a===Et||a===bt?a="Number":a!==At&&a!==Ct||(a=""+a),a===e){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!ft(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;b(3605,r,pe(o.ctor))}else"Number"!==e&&b(3606,t,r,e);else{if("function"===c)return;e===At.default&&null==s?b(3607,r):b(3611,t,r,c)}delete o.type}}}else b(3604,r)}}i.String=At,i.CCString=At;var Rt=Object.freeze({__proto__:null,DELIMETER:mt,createAttrsSingle:vt,createAttrs:gt,attr:yt,getClassAttrs:St,setClassAttr:xt,PrimitiveType:Tt,CCInteger:Et,CCFloat:bt,CCBoolean:Ct,CCString:At,getTypeChecker_ET:wt,getObjTypeChecker_ET:function(e){return function(t,n){wt("Object","type")(t,n);var r=St(t)[n+mt+"default"],o=i.Class.getDefault(r);if(!Array.isArray(o)&&we(e,i.ValueType)){var a=pe(e),s=ye('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',pe(t),n,a);r?_(s):b(3612,s,a,pe(t),n,a)}}}}),It={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Pt(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var o={};for(var a in i[r]=o,It){var s=It[a];e.hasOwnProperty(a)&&(o[a]=e[a],s.canUsedInGet||delete e[a])}}}function Ot(e,t,n,r){if(Array.isArray(t)){if(!(t.length>0))return A(5508,n,r);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=i.String:t===Boolean?e.type=i.Boolean:t===Number&&(e.type=i.Float))}function Dt(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function Mt(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return Dt(t,[],e);if("function"==typeof e){var n=e;return Dt(t,we(n,i.ValueType)?new n:null,n)}return Dt(t,e instanceof Tt?e.default:e)}return null}var Nt=[];function Lt(){return Nt[Nt.length-1]}i._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),Nt.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=Nt.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:Lt};var Bt=mt,Ft={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=pe(i);r?Ht(i,o,r,i.$super,n.mixins):A(3633,o)}this.datas=null}}};function zt(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),Wt(e,i,t,n)}function Ut(e,t,n,i){var r=i.get;i.set,r&&(Wt(e,i,t,n),xt(e,n,"serializable",!1))}function kt(e){return"function"==typeof e?e():e}function Gt(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,xe(t,i))}function Ht(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(e.__props__=e.__props__.concat(a.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=Mt(i,!1);if(r&&(i=e[n]=r),i){var o=i.notify;o&&Pt(i,n,o,e),"type"in i&&Ot(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?Ut(e,t,s,c):zt(e,t,s,c)}var l=St(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+Bt+"serializable"]}))}function Vt(e){var t=e.name,n=e.extends,r=e.mixins,o=function(e,t,n,r){var o=i.Component,a=Lt();if(a&&we(t,o)){if(we(a.cls,o))return A(3615),null;e=e||a.script}var s=function(e,t,n,i){var r=i.ctor,o=[r],a=r;le(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(t&&(a.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Gt(s,l.prototype),Vt._isCCClass(l)&&Gt(St(a),St(l))}s.constructor=a}return Ne(e,a),a}(e,t,n,r);if(a)if(we(t,o)){var c=a.uuid;c&&De(c,s),a.cls=s}else we(a.cls,o)||(a.cls=s);return s}(t,n,r,e);t||(t=i.js.getClassName(o)),o._sealed=!0,n&&(n._sealed=!1);var a=e.properties;"function"==typeof a||n&&null===n.__props__||r&&r.some((function(e){return null===e.__props__}))?(Ft.push({cls:o,props:a,mixins:r}),o.__props__=o.__values__=null):Ht(o,t,a,n,e.mixins);var s=e.editor;return s&&we(n,i.Component)&&i.Component._registerEditorProps(o,s),o}Vt._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},Vt.fastDefine=function(e,t,n){Ne(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=St(t),o=0;o<i.length;o++){var a=i[o];r[a+Bt+"visible"]=!1,r[a+Bt+"default"]=n[a]}},Vt.Attr=Rt,Vt.attr=yt,Vt.getInheritanceChain=function(e){for(var t=[];e=Ae(e);)e!==Object&&t.push(e);return t};var jt={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Wt(e,t,n,i){var r=null,o="";function a(){return o=i+Bt,r=St(e)}"type"in t&&void 0===t.type&&b(3660,i,n);var s=t.type;s&&(jt[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?Qe.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=Qe.getList(s)):Ye.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=Ye.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in t&&((r||a())[o+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((r||a())[o+e]=i)}};t.editorOnly&&((r||a())[o+"editorOnly"]=!0),t.__noImplicit?(r||a())[o+"serializable"]=null!==(c=t.serializable)&&void 0!==c&&c:!1===t.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Vt.isArray=function(e){return e=kt(e),Array.isArray(e)},Vt.getDefault=kt,Vt.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Vt.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Vt.getNewValueTypeCode=function(e){for(var t=pe(e),n=e.constructor,i="new "+t+"(",r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},i.Class=Vt;var qt,Xt=e("editorExtrasTag","__editorExtras__"),Yt=1<<22,Kt=[],Qt=e("CCObject",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=Kt.length,t=0;t<e;++t){var n=Kt[t];1&n._objFlags||n._destroyImmediate()}e===Kt.length?Kt.length=0:Kt.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(b(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Kt.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,r=e instanceof i._BaseNode||e instanceof i.Component,o=r?"_id":null,a={};for(n in e)if(e.hasOwnProperty(n)){if(n===o)continue;switch(typeof e[n]){case"string":a[n]="";break;case"object":case"function":a[n]=null}}if(Vt._isCCClass(t))for(var s=i.Class.Attr.getClassAttrs(t),c=t.__props__,l=0;l<c.length;l++){var u=(n=c[l])+i.Class.Attr.DELIMETER+"default";if(u in s){if(r&&"_id"===n)continue;switch(typeof s[u]){case"string":a[n]="";break;case"object":case"function":a[n]=null;break;case"undefined":a[n]=void 0}}}var h="";for(n in a){var f;f=Vt.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Vt.escapeForJS(n)+"]=";var _=a[n];""===_&&(_='""'),h+=f+_+";\n"}return Function("o",h)}(this,e),le(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?A(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},L(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&Yt)},set:function(e){e?this._objFlags|=Yt:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),Zt=Qt.prototype;function Jt(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}Zt._deserialize=null,Zt._onPreDestroy=null,Vt.fastDefine("cc.Object",Qt,((qt={_name:"",_objFlags:0})[Xt]={},qt)),Vt.Attr.setClassAttr(Qt,Xt,"editorOnly",!0),Vt.Attr.setClassAttr(Qt,"replicated","visible",!1),le(Qt,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),i.isValid=Jt,i.Object=Qt;var $t=Ge.fastRemoveAt;function en(){}var tn=function(){function e(){this.callback=en,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||en,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=en,this.once=!1},t.check=function(){return!(this.target instanceof Qt&&!Jt(this.target,!0))},e}(),nn=new We((function(){return new tn}),32),rn=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),nn.free(n),$t(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),nn.free(n),$t(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:$t(this.callbackInfos,e),nn.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),nn.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||$t(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),on=new We((function(){return new rn}),16),an=function(){function e(){this._callbackTable=_e(!0),this._offCallback=void 0}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=on.alloc());var o=nn.alloc();o.set(t,n,i),r.callbackInfos.push(o)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){var t=typeof e;if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),on.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===e&&r.cancel(a)}else r.removeByTarget(e)}},t.off=function(e,t,n){var i,r=this._callbackTable&&this._callbackTable[e];if(r){var o=r.callbackInfos;if(t)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===t&&s.target===n){r.cancel(a);break}}else this.removeAll(e)}null===(i=this._offCallback)||void 0===i||i.call(this)},t.emit=function(e,t,n,i,r,o){var a=this._callbackTable&&this._callbackTable[e];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var f=h.callback,_=h.target;h.once&&this.off(e,f,_),h.check()?_?f.call(_,t,n,i,r,o):f(t,n,i,r,o):this.off(e,f,_)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),on.free(t),delete this._callbackTable[e])}},t._registerOffCallback=function(e){this._offCallback=e},e}();function sn(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=_e(!0),t}F(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=an.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in t.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(t.prototype,o,a)}}return t}var cn,ln,un,hn,fn,_n,pn=e("EventTarget",sn((function(){})));i.EventTarget=pn,function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(cn||(cn={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(ln||(ln={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(un||(un={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(hn||(hn={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(fn||(fn={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(_n||(_n={}));var dn=new(function(e){function t(){var t,n,i;(i=e.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(t=o.getBattery)||void 0===t||t.call(o).then((function(e){i._battery=e})),i.networkType=un.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?fn.MOBILE_BROWSER:fn.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:ln.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,f=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);f&&(c=!0,u=f[1]||"",h=parseInt(u)||0),(f=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=f[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var _=hn.UNKNOWN;-1!==o.appVersion.indexOf("Win")?_=hn.WINDOWS:l?_=hn.IOS:-1!==o.appVersion.indexOf("Mac")?_=hn.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?_=hn.LINUX:c?_=hn.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(_=hn.LINUX),i.os=_,i.osVersion=u,i.osMainVersion=h,i.browserType=cn.UNKNOWN;var p=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),d=p?p[0].toLowerCase():hn.UNKNOWN;("safari"===d&&c||"qq"===d&&/android.*applewebkit/i.test(a))&&(d=cn.ANDROID);var m={micromessenger:cn.WECHAT,wechat:cn.WECHAT,weixin:cn.WECHAT,trident:cn.IE,edge:cn.EDGE,"360 aphone":cn.BROWSER_360,mxbrowser:cn.MAXTHON,"opr/":cn.OPERA,ubrowser:cn.UC,huaweibrowser:cn.HUAWEI};i.browserType=m[d]||d,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){g=!1}var S=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(e){S=!0,null==e||e.close()})).catch((function(){})));var x=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,T=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[_n.WEBP]=g,n[_n.IMAGE_BITMAP]=S,n[_n.WEB_VIEW]=!0,n[_n.VIDEO_PLAYER]=!0,n[_n.SAFE_AREA]=!1,n[_n.INPUT_TOUCH]=x,n[_n.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[_n.EVENT_MOUSE]=T,n[_n.EVENT_TOUCH]=x||T,n[_n.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}F(t,e);var n=t.prototype;return n._registerEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,o,a){n&&(n=!1,t.emit("show",e,i,r,o,a))};if(e)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(e){return this._featureMap[e]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(e){window.open(e)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},t}(pn)),mn=/(\.[^\.\/\?\\]*)(\?.*)?$/,vn=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,gn=/[^\.\/]+\/\.\.\//;function yn(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function Sn(e){var t=mn.exec(e);return t?t[1]:""}function xn(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function Tn(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function En(e){var t=vn.exec(e);return t?t[2]:""}function bn(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function Cn(e,t,n){if(0===t.indexOf("."))return bn(e,t);var i=e.indexOf("?"),r="",o=n?Sn(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+o+r}function An(e){var t=e=String(e);do{t=e,e=e.replace(gn,"")}while(t.length!==e.length);return e}function wn(e){return e.replace(/[\/\\]$/,"")}function Rn(){return dn.os===hn.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:yn,extname:Sn,mainFileName:xn,basename:Tn,dirname:En,changeExtname:bn,changeBasename:Cn,_normalize:An,stripSep:wn,getSeperator:Rn})),i.log=_,i.warn=p,i.error=d,i.assert=m,i._throw=y,i.logID=T,i.warnID=b,i.errorID=A,i.assertID=I,i.debug=M,i.path={join:yn,extname:Sn,mainFileName:xn,basename:Tn,dirname:En,changeExtname:bn,changeBasename:Cn,_normalize:An,stripSep:wn,get sep(){return Rn()}};var In=0,Pn={},On=2147483647;function Dn(e){return(e>0)-(e<0)}function Mn(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function Nn(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function Ln(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}var Bn=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(Bn);var Fn=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:On,INT_MIN:-2147483648,sign:Dn,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:Mn,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:Nn,nextPow2:Ln,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return Bn[255&e]<<24|Bn[e>>>8&255]<<16|Bn[e>>>16&255]<<8|Bn[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>Nn(e)+1}});e("bits",Fn);var zn,Un,kn,Gn,Hn,Vn,jn=10,Wn=0,qn=new Map;Gn=function(e,t,n,i,r,o,a){var s=qn.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,e+"."+t,n+"."+i),s.count++)},zn=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=Wn++;qn.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:jn});var r=null!=n.target?n.target:e,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return Gn(t,n.name,a,o,p,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return Gn(t,n.name,a,o,p,i,c),n.customGetter.call(this)},set:function(e){Gn(t,n.name,a,o,p,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){Gn(t,n.name,a,o,p,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return Gn(t,n.name,a,o,p,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return Gn(t,n.name,a,o,p,i,c),s?this[o]:r[o]},set:function(e){Gn(t,n.name,a,o,p,i,c),s?this[o]=e:r[o]=e},enumerable:!1})}))})),Vn=function(e,t,n,i,r){var o=qn.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,e+"."+t),o.count++)},Un=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=Wn++;qn.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:jn});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return Vn(t,n.name,d,i,r)},set:function(){Vn(t,n.name,d,i,r)},enumerable:!1})}))})),Hn=function(e,t,n,i,r){var o=qn.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,e+"."+t),o.count++)},kn=e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var o=Wn++;qn.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:jn});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return Hn(t,i,p,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return Hn(t,i,p,o,a),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){Hn(t,i,p,o,a),c=e}})}else!function(t,n,i,r,o,a){if(t.get){var s=t.get;t.get=function(){return Hn(n,i,r,o,a),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){Hn(n,i,r,o,a),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,p,o,a);Object.defineProperty(e,i,{enumerable:!1})}}))}));var Xn=Math.PI/180,Yn=180/Math.PI,Kn=e("EPSILON",1e-6);function Qn(e,t){return Math.abs(e-t)<=Kn*Math.max(1,Math.abs(e),Math.abs(t))}function Zn(e,t,n){return n=n||Kn,Math.abs(e-t)<=n}function Jn(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function $n(e){return e<0?0:e>1?1:e}function ei(e,t,n){return e+(t-e)*n}function ti(e){return e*Xn}function ni(e){return e*Yn}var ii=e("random",Math.random);function ri(e,t){return Math.random()*(t-e)+e}function oi(e,t){return Math.floor(ri(e,t))}function ai(e){return(e=(9301*e+49297)%233280)/233280}function si(e,t,n){return ai(e)*(n-t)+t}function ci(e,t,n){return Math.floor(si(e,t,n))}function li(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function ui(e,t){return e-Math.floor(e/t)*t}function hi(e,t){return e=ui(e,2*t),t-Math.abs(e-t)}function fi(e,t,n){return(n-e)/(t-e)}function _i(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function pi(e,t){return Math.abs(e)>Math.abs(t)?e:t}function di(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var mi=1/255,vi=e("Color",function(e){function t(t,n,i,r){var o;return(o=e.call(this)||this)._val=0,"string"==typeof t?o.fromHEX(t):void 0!==n?o.set(t,n,i,r):o.set(t),o}F(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e},t.fromHEX=function(e,t){return t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0,e.a=parseInt(t.substr(6,2),16),e.a=Number.isNaN(e.a)?255:e.a,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var r=t.r,o=t.g,a=t.b,s=t.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var r=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*r,e[i+1]=n.g*r,e[i+2]=n.b*r,e[i+3]=n.a*r,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=Kn),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,o+=(e.a-o)*t,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*mi).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,r=0,o=0;if(0===t)i=r=o=n;else if(0===n)i=r=o=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),s=e-a,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var e=this.r*mi,t=this.g*mi,n=this.b*mi,i={h:0,s:0,v:0},r=Math.max(e,t,n),o=Math.min(e,t,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=e===r?(t-n)/a:t===r?2+(n-e)/a:4+(e-t)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},L(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~Jn(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~Jn(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~Jn(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~Jn(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*mi},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*mi},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*mi},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*mi},set:function(e){this.a=255*e}}]),t}(et));function gi(e,t,n,i){return new vi(e,t,n,i)}vi.WHITE=Object.freeze(new vi(255,255,255,255)),vi.GRAY=Object.freeze(new vi(127,127,127,255)),vi.BLACK=Object.freeze(new vi(0,0,0,255)),vi.TRANSPARENT=Object.freeze(new vi(0,0,0,0)),vi.RED=Object.freeze(new vi(255,0,0,255)),vi.GREEN=Object.freeze(new vi(0,255,0,255)),vi.BLUE=Object.freeze(new vi(0,0,255,255)),vi.CYAN=Object.freeze(new vi(0,255,255,255)),vi.MAGENTA=Object.freeze(new vi(255,0,255,255)),vi.YELLOW=Object.freeze(new vi(255,255,0,255)),Vt.fastDefine("cc.Color",vi,{r:0,g:0,b:0,a:255}),i.Color=vi,i.color=gi;var yi=e("Vec3",function(e){function t(t,n,i){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z):(r.x=t||0,r.y=n||0,r.z=i||0),r}F(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<Kn?e.x=0:e.x=1/n,Math.abs(i)<Kn?e.y=0:e.y=1/i,Math.abs(r)<Kn?e.z=0:e.z=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z;return e.x=r*c-o*s,e.y=o*a-i*c,e.z=i*s-r*a,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*ii()*Math.PI,i=2*ii()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,e.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,e.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,e},t.transformMat4Normal=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o)*a,e.y=(n.m01*i+n.m05*r+n.m09*o)*a,e.z=(n.m02*i+n.m06*r+n.m10*o)*a,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=i*n.m00+r*n.m03+o*n.m06,e.y=i*n.m01+r*n.m04+o*n.m07,e.z=i*n.m02+r*n.m05+o*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13,e.x=n.m02*i+n.m06*r+n.m10*o+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,o=n.w*t.z+n.x*t.y-n.y*t.x,a=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,e.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,e.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,e},t.transformRTS=function(e,t,n,i,r){var o=t.x*r.x,a=t.y*r.y,s=t.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,r){var o=t.x-i.x,a=t.y-i.y,s=t.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e},t.rotateX=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=Kn);var i=e.x,r=e.y,o=e.z,a=t.x,s=t.y,c=t.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},t.angle=function(e,n){t.normalize(Si,e),t.normalize(xi,n);var i=t.dot(Si,xi);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var r=t.lengthSqr(i);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/r)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=Kn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=Kn),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=Jn(this.x,e.x,t.x),this.y=Jn(this.y,e.y,t.y),this.z=Jn(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this},t}(et));yi.UNIT_X=Object.freeze(new yi(1,0,0)),yi.UNIT_Y=Object.freeze(new yi(0,1,0)),yi.UNIT_Z=Object.freeze(new yi(0,0,1)),yi.RIGHT=Object.freeze(new yi(1,0,0)),yi.UP=Object.freeze(new yi(0,1,0)),yi.FORWARD=Object.freeze(new yi(0,0,-1)),yi.ZERO=Object.freeze(new yi(0,0,0)),yi.ONE=Object.freeze(new yi(1,1,1)),yi.NEG_ONE=Object.freeze(new yi(-1,-1,-1));var Si=new yi,xi=new yi;function Ti(e,t,n){return new yi(e,t,n)}Vt.fastDefine("cc.Vec3",yi,{x:0,y:0,z:0}),i.Vec3=yi,i.v3=Ti;var Ei=e("Mat3",function(e){function t(t,n,i,r,o,a,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}F(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,r,o,a,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*a-s*l,f=-u*o+s*c,_=l*o-a*c,p=n*h+i*f+r*_;return 0===p?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(p=1/p,e.m00=h*p,e.m01=(-u*i+r*l)*p,e.m02=(s*i-r*a)*p,e.m03=f*p,e.m04=(u*n-r*c)*p,e.m05=(-s*n+r*o)*p,e.m06=_*p,e.m07=(-l*n+i*c)*p,e.m08=(a*n-i*o)*p,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=n.m00,_=n.m01,p=n.m02,d=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,S=n.m08;return e.m00=f*i+_*a+p*l,e.m01=f*r+_*s+p*u,e.m02=f*o+_*c+p*h,e.m03=d*i+m*a+v*l,e.m04=d*r+m*s+v*u,e.m05=d*o+m*c+v*h,e.m06=g*i+y*a+S*l,e.m07=g*r+y*s+S*u,e.m08=g*o+y*c+S*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=n.m00,_=n.m01,p=n.m02,d=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,S=n.m10;return e.m00=f*i+_*a+p*l,e.m01=f*r+_*s+p*u,e.m02=f*o+_*c+p*h,e.m03=d*i+m*a+v*l,e.m04=d*r+m*s+v*u,e.m05=d*o+m*c+v*h,e.m06=g*i+y*a+S*l,e.m07=g*r+y*s+S*u,e.m08=g*o+y*c+S*h,e},t.transform=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=n.x,_=n.y;return e.m00=i,e.m01=r,e.m02=o,e.m03=a,e.m04=s,e.m05=c,e.m06=f*i+_*a+l,e.m07=f*r+_*s+u,e.m08=f*o+_*c+h,e},t.scale=function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=Math.sin(n),_=Math.cos(n);return e.m00=_*i+f*a,e.m01=_*r+f*s,e.m02=_*o+f*c,e.m03=_*a-f*i,e.m04=_*s-f*r,e.m05=_*c-f*o,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return yi.lengthSqr(n)<Kn*Kn?(t.identity(e),e):(i=i||yi.UNIT_Y,yi.normalize(bi,yi.cross(bi,i,n)),yi.lengthSqr(bi)<Kn*Kn?(t.identity(e),e):(yi.cross(Ci,n,bi),t.set(e,bi.x,bi.y,bi.z,Ci.x,Ci.y,Ci.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,f=r*a,_=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return e.m00=1-h-p,e.m03=u-v,e.m06=f+m,e.m01=u+v,e.m04=1-l-p,e.m07=_-d,e.m02=f-m,e.m05=_+d,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,f=t.m10,_=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,x=i*c-r*s,T=i*l-o*s,E=r*l-o*c,b=u*d-h*p,C=u*m-f*p,A=u*v-_*p,w=h*m-f*d,R=h*v-_*d,I=f*v-_*m,P=g*I-y*R+S*w+x*A-T*C+E*b;return P?(P=1/P,e.m00=(s*I-c*R+l*w)*P,e.m01=(c*A-a*I-l*C)*P,e.m02=(a*R-s*A+l*b)*P,e.m03=(r*R-i*I-o*w)*P,e.m04=(n*I-r*A+o*C)*P,e.m05=(i*A-n*R-o*b)*P,e.m06=(d*E-m*T+v*x)*P,e.m07=(m*S-p*E-v*y)*P,e.m08=(p*T-d*S+v*g)*P,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=Kn),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,r,o,a,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=Kn),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,f=e*l+t*u+n*h;return 0===f?(this.set(0,0,0,0,0,0,0,0,0),this):(f=1/f,this.m00=l*f,this.m01=(-c*t+n*s)*f,this.m02=(o*t-n*r)*f,this.m03=u*f,this.m04=(c*e-n*a)*f,this.m05=(-o*e+n*i)*f,this.m06=h*f,this.m07=(-s*e+t*a)*f,this.m08=(r*e-t*i)*f,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return e*(c*r-o*s)+t*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,f=e.m02,_=e.m03,p=e.m04,d=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+f*s,this.m01=u*n+h*o+f*c,this.m02=u*i+h*a+f*l,this.m03=_*t+p*r+d*s,this.m04=_*n+p*o+d*c,this.m05=_*i+p*a+d*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*t,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,f=i*a,_=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-_,this.m03=l-m,this.m06=h+d,this.m01=l+m,this.m04=1-c-_,this.m07=f-p,this.m02=h-d,this.m05=f+p,this.m08=1-c-u,this},t}(et));Ei.IDENTITY=Object.freeze(new Ei);var bi=new yi,Ci=new yi;Vt.fastDefine("cc.Mat3",Ei,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),i.Mat3=Ei;var Ai=e("Quat",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}F(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var r=yi.dot(n,i);return r<-.999999?(yi.cross(Ii,yi.UNIT_X,n),Ii.length()<1e-6&&yi.cross(Ii,yi.UNIT_Y,n),yi.normalize(Ii,Ii),t.fromAxisAngle(e,Ii,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(yi.cross(Ii,n,i),e.x=Ii.x,e.y=Ii.y,e.z=Ii.z,e.w=1+r,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,o=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,a=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=o,e.w=a,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+c*i,e.y=a*r+s*i,e.z=s*r-a*i,e.w=c*r-o*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r-s*i,e.y=a*r+c*i,e.z=s*r+o*i,e.w=c*r-a*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+a*i,e.y=a*r-o*i,e.z=s*r+c*i,e.w=c*r-s*i,e},t.rotateAround=function(e,n,i,r){return t.invert(wi,n),yi.transformQuat(Ii,i,wi),t.fromAxisAngle(wi,Ii,r),t.multiply(e,n,wi),e},t.rotateAroundLocal=function(e,n,i,r){return t.fromAxisAngle(wi,i,r),t.multiply(e,n,wi),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),f=Math.sin(h);r=Math.sin((1-i)*h)/f,o=Math.sin(i*h)/f}else r=1-i,o=i;return e.x=r*t.x+o*a,e.y=r*t.y+o*s,e.z=r*t.z+o*c,e.w=r*t.w+o*l,e},t.sqlerp=function(e,n,i,r,o,a){return t.slerp(wi,n,o,a),t.slerp(Ri,i,r,a),t.slerp(e,wi,Ri,2*a*(1-a)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,r){return Ei.set(Pi,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,Pi))},t.fromViewUp=function(e,n,i){return Ei.fromViewUp(Pi,n,i),t.normalize(e,t.fromMat3(e,Pi))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,r=t.m06,o=t.m01,a=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+a+u;if(h>0){var f=.5/Math.sqrt(h+1);e.w=.25/f,e.x=(l-s)*f,e.y=(r-c)*f,e.z=(o-i)*f}else if(n>a&&n>u){var _=2*Math.sqrt(1+n-a-u);e.w=(l-s)/_,e.x=.25*_,e.y=(i+o)/_,e.z=(r+c)/_}else if(a>u){var p=2*Math.sqrt(1+a-n-u);e.w=(r-c)/p,e.x=(i+o)/p,e.y=.25*p,e.z=(s+l)/p}else{var d=2*Math.sqrt(1+u-n-a);e.w=(o-i)/d,e.x=(r+c)/d,e.y=(s+l)/d,e.z=.25*d}return e},t.fromEuler=function(e,t,n,i){t*=Oi,n*=Oi,i*=Oi;var r=Math.sin(t),o=Math.cos(t),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+o*a*c,e.y=o*a*l+r*s*c,e.z=o*s*c-r*a*l,e.w=o*s*l-r*a*c,e},t.fromAngleZ=function(e,t){return t*=Oi,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=ni(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-ni(2*Math.atan2(i,a)),l=-90;else{var h=i*i,f=r*r,_=o*o;s=ni(Math.atan2(2*i*a-2*r*o,1-2*h-2*_)),c=ni(Math.atan2(2*r*a-2*i*o,1-2*f-2*_)),l=ni(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=Kn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=Kn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}(et));Ai.IDENTITY=Object.freeze(new Ai);var wi=new Ai,Ri=new Ai,Ii=new yi,Pi=new Ei,Oi=.5*Math.PI/180;function Di(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new Ai(e,t,n,i)}Vt.fastDefine("cc.Quat",Ai,{x:0,y:0,z:0,w:1}),i.Quat=Ai,i.quat=Di;var Mi=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Ni=e("Mat4",function(e){function t(t,n,i,r,o,a,s,c,l,u,h,f,_,p,d,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===f&&(f=0),void 0===_&&(_=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=f,v.m12=_,v.m13=p,v.m14=d,v.m15=m),v}F(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=f,e.m12=_,e.m13=p,e.m14=d,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,o=t.m06,a=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=o,e.m11=t.m14,e.m12=r,e.m13=a,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,f=t.m10,_=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,x=i*c-r*s,T=i*l-o*s,E=r*l-o*c,b=u*d-h*p,C=u*m-f*p,A=u*v-_*p,w=h*m-f*d,R=h*v-_*d,I=f*v-_*m,P=g*I-y*R+S*w+x*A-T*C+E*b;return 0===P?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(P=1/P,e.m00=(s*I-c*R+l*w)*P,e.m01=(r*R-i*I-o*w)*P,e.m02=(d*E-m*T+v*x)*P,e.m03=(f*T-h*E-_*x)*P,e.m04=(c*A-a*I-l*C)*P,e.m05=(n*I-r*A+o*C)*P,e.m06=(m*S-p*E-v*y)*P,e.m07=(u*E-f*S+_*y)*P,e.m08=(a*R-s*A+l*b)*P,e.m09=(i*A-n*R-o*b)*P,e.m10=(p*T-d*S+v*g)*P,e.m11=(h*S-u*T-_*g)*P,e.m12=(s*C-a*w-c*b)*P,e.m13=(n*w-i*C+r*b)*P,e.m14=(d*y-p*x-m*g)*P,e.m15=(u*x-h*y+f*g)*P,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,f=e.m11,_=e.m12,p=e.m13,d=e.m14,m=e.m15;return(t*a-n*o)*(h*m-f*d)-(t*s-i*o)*(u*m-f*p)+(t*c-r*o)*(u*d-h*p)+(n*s-i*a)*(l*m-f*_)-(n*c-r*a)*(l*d-h*_)+(i*c-r*s)*(l*p-u*_)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=t.m09,_=t.m10,p=t.m11,d=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,S=n.m01,x=n.m02,T=n.m03;return e.m00=y*i+S*s+x*h+T*d,e.m01=y*r+S*c+x*f+T*m,e.m02=y*o+S*l+x*_+T*v,e.m03=y*a+S*u+x*p+T*g,y=n.m04,S=n.m05,x=n.m06,T=n.m07,e.m04=y*i+S*s+x*h+T*d,e.m05=y*r+S*c+x*f+T*m,e.m06=y*o+S*l+x*_+T*v,e.m07=y*a+S*u+x*p+T*g,y=n.m08,S=n.m09,x=n.m10,T=n.m11,e.m08=y*i+S*s+x*h+T*d,e.m09=y*r+S*c+x*f+T*m,e.m10=y*o+S*l+x*_+T*v,e.m11=y*a+S*u+x*p+T*g,y=n.m12,S=n.m13,x=n.m14,T=n.m15,e.m12=y*i+S*s+x*h+T*d,e.m13=y*r+S*c+x*f+T*m,e.m14=y*o+S*l+x*_+T*v,e.m15=y*a+S*u+x*p+T*g,e},t.transform=function(e,t,n){var i=n.x,r=n.y,o=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*o+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*o+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*o+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*o+t.m15;else{var a=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,f=t.m06,_=t.m07,p=t.m08,d=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=a,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=f,e.m07=_,e.m08=p,e.m09=d,e.m10=m,e.m11=v,e.m12=a*i+u*r+p*o+t.m12,e.m13=s*i+h*r+d*o+t.m13,e.m14=c*i+f*r+m*o+t.m14,e.m15=l*i+_*r+v*o+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,r=n.y,o=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*o,e.m09=t.m09*o,e.m10=t.m10*o,e.m11=t.m11*o,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<Kn)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,f=t.m01,_=t.m02,p=t.m03,d=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,S=t.m09,x=t.m10,T=t.m11,E=r*r*u+l,b=o*r*u+a*c,C=a*r*u-o*c,A=r*o*u-a*c,w=o*o*u+l,R=a*o*u+r*c,I=r*a*u+o*c,P=o*a*u-r*c,O=a*a*u+l;return e.m00=h*E+d*b+y*C,e.m01=f*E+m*b+S*C,e.m02=_*E+v*b+x*C,e.m03=p*E+g*b+T*C,e.m04=h*A+d*w+y*R,e.m05=f*A+m*w+S*R,e.m06=_*A+v*w+x*R,e.m07=p*A+g*w+T*R,e.m08=h*I+d*P+y*O,e.m09=f*I+m*P+S*O,e.m10=_*I+v*P+x*O,e.m11=p*I+g*P+T*O,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=o*r+l*i,e.m05=a*r+u*i,e.m06=s*r+h*i,e.m07=c*r+f*i,e.m08=l*r-o*i,e.m09=u*r-a*i,e.m10=h*r-s*i,e.m11=f*r-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r-l*i,e.m01=a*r-u*i,e.m02=s*r-h*i,e.m03=c*r-f*i,e.m08=o*i+l*r,e.m09=a*i+u*r,e.m10=s*i+h*r,e.m11=c*i+f*r,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,f=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r+l*i,e.m01=a*r+u*i,e.m02=s*r+h*i,e.m03=c*r+f*i,e.m04=l*r-o*i,e.m05=u*r-a*i,e.m06=h*r-s*i,e.m07=f*r-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<Kn)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+o*s,e.m02=o*i*l-r*s,e.m03=0,e.m04=i*r*l-o*s,e.m05=r*r*l+c,e.m06=o*r*l+i*s,e.m07=0,e.m08=i*o*l+r*s,e.m09=r*o*l-i*s,e.m10=o*o*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,f=i*l,_=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l;return e.m00=1-(_+d),e.m01=h+g,e.m02=f-v,e.m03=0,e.m04=h-g,e.m05=1-(u+d),e.m06=p+m,e.m07=0,e.m08=f+v,e.m09=p-m,e.m10=1-(u+_),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=Bi.m00=t.m00,i=Bi.m01=t.m01,r=Bi.m02=t.m02,o=Bi.m03=t.m04,a=Bi.m04=t.m05,s=Bi.m05=t.m06,c=Bi.m06=t.m08,l=Bi.m07=t.m09,u=Bi.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(o*o+a*a+s*s),e.z=Math.sqrt(c*c+l*l+u*u),Ei.determinant(Bi)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=yi.set(Li,e.m00,e.m01,e.m02).length(),Bi.m00=e.m00/i.x,Bi.m01=e.m01/i.x,Bi.m02=e.m02/i.x,i.y=yi.set(Li,e.m04,e.m05,e.m06).length(),Bi.m03=e.m04/i.y,Bi.m04=e.m05/i.y,Bi.m05=e.m06/i.y,i.z=yi.set(Li,e.m08,e.m09,e.m10).length(),Bi.m06=e.m08/i.z,Bi.m07=e.m09/i.z,Bi.m08=e.m10/i.z,Ei.determinant(Bi)<0&&(i.x*=-1,Bi.m00*=-1,Bi.m01*=-1,Bi.m02*=-1),Ai.fromMat3(t,Bi),yi.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=t.w,c=r+r,l=o+o,u=a+a,h=r*c,f=r*l,_=r*u,p=o*l,d=o*u,m=a*u,v=s*c,g=s*l,y=s*u,S=i.x,x=i.y,T=i.z;return e.m00=(1-(p+m))*S,e.m01=(f+y)*S,e.m02=(_-g)*S,e.m03=0,e.m04=(f-y)*x,e.m05=(1-(h+m))*x,e.m06=(d+v)*x,e.m07=0,e.m08=(_+g)*T,e.m09=(d-v)*T,e.m10=(1-(h+p))*T,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,r){var o=t.x,a=t.y,s=t.z,c=t.w,l=o+o,u=a+a,h=s+s,f=o*l,_=o*u,p=o*h,d=a*u,m=a*h,v=s*h,g=c*l,y=c*u,S=c*h,x=i.x,T=i.y,E=i.z,b=r.x,C=r.y,A=r.z;return e.m00=(1-(d+v))*x,e.m01=(_+S)*x,e.m02=(p-y)*x,e.m03=0,e.m04=(_-S)*T,e.m05=(1-(f+v))*T,e.m06=(m+g)*T,e.m07=0,e.m08=(p+y)*E,e.m09=(m-g)*E,e.m10=(1-(f+d))*E,e.m11=0,e.m12=n.x+b-(e.m00*b+e.m04*C+e.m08*A),e.m13=n.y+C-(e.m01*b+e.m05*C+e.m09*A),e.m14=n.z+A-(e.m02*b+e.m06*C+e.m10*A),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,f=r*a,_=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return e.m00=1-h-p,e.m01=u+v,e.m02=f-m,e.m03=0,e.m04=u-v,e.m05=1-l-p,e.m06=_+d,e.m07=0,e.m08=f+m,e.m09=_-d,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,r,o,a){var s=1/(n-t),c=1/(r-i),l=1/(o-a);return e.m00=2*o*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*o*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(a+o)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*o*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-r),h=o?l/n:l,f=(o?l:l*n)*s,_=Mi[c];return e.m00=h*_[0],e.m01=h*_[1],e.m02=0,e.m03=0,e.m04=f*_[2],e.m05=f*_[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-a*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-a),e.m15=0,e},t.ortho=function(e,t,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-r)*c,f=1/(o-a),_=-2*u,p=-2*h,d=(t+n)*u,m=(r+i)*h,v=Mi[l];return e.m00=_*v[0],e.m01=_*v[1],e.m02=0,e.m03=0,e.m04=p*v[2],e.m05=p*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=f*(1-s),e.m11=0,e.m12=d*v[0]+m*v[2],e.m13=d*v[1]+m*v[3],e.m14=(o-s*a)*f,e.m15=1,e},t.lookAt=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,f=a-n.z,_=1/Math.sqrt(u*u+h*h+f*f),p=c*(f*=_)-l*(h*=_),d=l*(u*=_)-s*f,m=s*h-c*u,v=h*(m*=_=1/Math.sqrt(p*p+d*d+m*m))-f*(d*=_),g=f*(p*=_)-u*m,y=u*d-h*p;return e.m00=p,e.m01=v,e.m02=u,e.m03=0,e.m04=d,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=f,e.m11=0,e.m12=-(p*r+d*o+m*a),e.m13=-(v*r+g*o+y*a),e.m14=-(u*r+h*o+f*a),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,f=t.m10,_=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,S=n*l-o*a,x=i*c-r*s,T=i*l-o*s,E=r*l-o*c,b=u*d-h*p,C=u*m-f*p,A=u*v-_*p,w=h*m-f*d,R=h*v-_*d,I=f*v-_*m,P=g*I-y*R+S*w+x*A-T*C+E*b;return P?(P=1/P,e.m00=(s*I-c*R+l*w)*P,e.m01=(c*A-a*I-l*C)*P,e.m02=(a*R-s*A+l*b)*P,e.m03=0,e.m04=(r*R-i*I-o*w)*P,e.m05=(n*I-r*A+o*C)*P,e.m06=(i*A-n*R-o*b)*P,e.m07=0,e.m08=(d*E-m*T+v*x)*P,e.m09=(m*S-p*E-v*y)*P,e.m10=(p*T-d*S+v*g)*P,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=Kn),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===_&&(_=0),void 0===p&&(p=0),void 0===d&&(d=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=f,this.m13=_,this.m14=p,this.m15=d,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=Kn),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,f=this.m12,_=this.m13,p=this.m14,d=this.m15,m=e*o-t*r,v=e*a-n*r,g=e*s-i*r,y=t*a-n*o,S=t*s-i*o,x=n*s-i*a,T=c*_-l*f,E=c*p-u*f,b=c*d-h*f,C=l*p-u*_,A=l*d-h*_,w=u*d-h*p,R=m*w-v*A+g*C+y*b-S*E+x*T;return 0===R?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(R=1/R,this.m00=(o*w-a*A+s*C)*R,this.m01=(n*A-t*w-i*C)*R,this.m02=(_*x-p*S+d*y)*R,this.m03=(u*S-l*x-h*y)*R,this.m04=(a*b-r*w-s*E)*R,this.m05=(e*w-n*b+i*E)*R,this.m06=(p*g-f*x-d*v)*R,this.m07=(c*x-u*g+h*v)*R,this.m08=(r*A-o*b+s*T)*R,this.m09=(t*b-e*A-i*T)*R,this.m10=(f*S-_*g+d*m)*R,this.m11=(l*g-c*S-h*m)*R,this.m12=(o*E-r*C-a*T)*R,this.m13=(e*C-t*E+n*T)*R,this.m14=(_*v-f*y-p*m)*R,this.m15=(c*y-l*v+u*m)*R,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,f=this.m12,_=this.m13,p=this.m14,d=this.m15;return(e*o-t*r)*(u*d-h*p)-(e*a-n*r)*(l*d-h*_)+(e*s-i*r)*(l*p-u*_)+(t*a-n*o)*(c*d-h*f)-(t*s-i*o)*(c*p-u*f)+(n*s-i*a)*(c*_-l*f)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,f=this.m11,_=this.m12,p=this.m13,d=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,S=e.m03;return this.m00=v*t+g*o+y*l+S*_,this.m01=v*n+g*a+y*u+S*p,this.m02=v*i+g*s+y*h+S*d,this.m03=v*r+g*c+y*f+S*m,v=e.m04,g=e.m05,y=e.m06,S=e.m07,this.m04=v*t+g*o+y*l+S*_,this.m05=v*n+g*a+y*u+S*p,this.m06=v*i+g*s+y*h+S*d,this.m07=v*r+g*c+y*f+S*m,v=e.m08,g=e.m09,y=e.m10,S=e.m11,this.m08=v*t+g*o+y*l+S*_,this.m09=v*n+g*a+y*u+S*p,this.m10=v*i+g*s+y*h+S*d,this.m11=v*r+g*c+y*f+S*m,v=e.m12,g=e.m13,y=e.m14,S=e.m15,this.m12=v*t+g*o+y*l+S*_,this.m13=v*n+g*a+y*u+S*p,this.m14=v*i+g*s+y*h+S*d,this.m15=v*r+g*c+y*f+S*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,r=t.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<Kn)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,f=this.m03,_=this.m04,p=this.m05,d=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,S=this.m11,x=n*n*c+s,T=i*n*c+r*a,E=r*n*c-i*a,b=n*i*c-r*a,C=i*i*c+s,A=r*i*c+n*a,w=n*r*c+i*a,R=i*r*c-n*a,I=r*r*c+s;return this.m00=l*x+_*T+v*E,this.m01=u*x+p*T+g*E,this.m02=h*x+d*T+y*E,this.m03=f*x+m*T+S*E,this.m04=l*b+_*C+v*A,this.m05=u*b+p*C+g*A,this.m06=h*b+d*C+y*A,this.m07=f*b+m*C+S*A,this.m08=l*w+_*R+v*I,this.m09=u*w+p*R+g*I,this.m10=h*w+d*R+y*I,this.m11=f*w+m*R+S*I,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=Bi.m00=this.m00,n=Bi.m01=this.m01,i=Bi.m02=this.m02,r=Bi.m03=this.m04,o=Bi.m04=this.m05,a=Bi.m05=this.m06,s=Bi.m06=this.m08,c=Bi.m07=this.m09,l=Bi.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+o*o+a*a),e.z=Math.sqrt(s*s+c*c+l*l),Ei.determinant(Bi)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,f=i*l,_=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l,y=n.x,S=n.y,x=n.z;return this.m00=(1-(_+d))*y,this.m01=(h+g)*y,this.m02=(f-v)*y,this.m03=0,this.m04=(h-g)*S,this.m05=(1-(u+d))*S,this.m06=(p+m)*S,this.m07=0,this.m08=(f+v)*x,this.m09=(p-m)*x,this.m10=(1-(u+_))*x,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,f=i*a,_=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-_,this.m01=l+m,this.m02=h-d,this.m03=0,this.m04=l-m,this.m05=1-c-_,this.m06=f+p,this.m07=0,this.m08=h+d,this.m09=f-p,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}(et));Ni.IDENTITY=Object.freeze(new Ni);var Li=new yi,Bi=new Ei;function Fi(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d){return new Ni(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d)}Vt.fastDefine("cc.Mat4",Ni,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),i.Mat4=Ni,i.mat4=Fi;var zi=e("Vec2",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}F(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<Kn?e.x=0:e.x=1/n,Math.abs(i)<Kn?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e instanceof yi?(e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e):e.x*t.y-e.y*t.x},t.lerp=function(e,t,n,i){var r=t.x,o=t.y;return e.x=r+i*(n.x-r),e.y=o+i*(n.y-o),e},t.random=function(e,t){t=t||1;var n=2*ii()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=Kn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize(Ui,e),t.normalize(ki,n);var i=t.dot(Ui,ki);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=Kn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=Kn),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=Jn(this.x,e.x,t.x),this.y=Jn(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=Jn(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}(et));zi.ZERO=Object.freeze(new zi(0,0)),zi.ONE=Object.freeze(new zi(1,1)),zi.NEG_ONE=Object.freeze(new zi(-1,-1)),zi.UNIT_X=Object.freeze(new zi(1,0)),zi.UNIT_Y=Object.freeze(new zi(0,1));var Ui=new zi,ki=new zi;function Gi(e,t){return new zi(e,t)}Vt.fastDefine("cc.Vec2",zi,{x:0,y:0}),i.Vec2=zi,i.v2=Gi;var Hi=e("Vec4",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=r||0),o}F(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+o*o)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return n*n+i*i+r*r+o*o},t.len=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w;return Math.abs(n)<Kn?e.x=0:e.x=1/n,Math.abs(i)<Kn?e.y=0:e.y=1/i,Math.abs(r)<Kn?e.z=0:e.z=1/r,Math.abs(o)<Kn?e.w=0:e.w=1/o,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a,e.w=o*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*ii()*Math.PI,i=2*ii()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m01*r+n.m02*o+n.m03*a,e.y=n.m04*i+n.m05*r+n.m06*o+n.m07*a,e.x=n.m08*i+n.m09*r+n.m10*o+n.m11*a,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,f=l*o+a*r-s*i,_=-a*i-s*r-c*o;return e.x=u*l+_*-a+h*-c-f*-s,e.y=h*l+_*-s+f*-a-u*-c,e.z=f*l+_*-c+u*-s-h*-a,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=Kn),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=Kn),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,r){return void 0===r&&(r=Kn),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=o+t*(e.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=Jn(this.x,e.x,t.x),this.y=Jn(this.y,e.y,t.y),this.z=Jn(this.z,e.z,t.z),this.w=Jn(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this},t}(et));function Vi(e,t,n,i){return new Hi(e,t,n,i)}Hi.ZERO=Object.freeze(new Hi(0,0,0,0)),Hi.ONE=Object.freeze(new Hi(1,1,1,1)),Hi.NEG_ONE=Object.freeze(new Hi(-1,-1,-1,-1)),Vt.fastDefine("cc.Vec4",Hi,{x:0,y:0,z:0,w:0}),i.Vec4=Hi,i.v4=Vi,zn(zi,"Vec2",[{name:"sub",newName:"subtract",target:zi,targetName:"Vec2"},{name:"mul",newName:"multiply",target:zi,targetName:"Vec2"},{name:"div",newName:"divide",target:zi,targetName:"Vec2"},{name:"dist",newName:"distance",target:zi,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:zi,targetName:"Vec2"},{name:"mag",newName:"len",target:zi,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:zi,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:zi,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:zi,targetName:"Vec2"}]),zn(zi.prototype,"Vec2",[{name:"mag",newName:"length",target:zi.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:zi.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:zi.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:zi.prototype,targetName:"Vec2"}]),zn(yi,"Vec3",[{name:"sub",newName:"subtract",target:yi,targetName:"Vec3"},{name:"mul",newName:"multiply",target:yi,targetName:"Vec3"},{name:"div",newName:"divide",target:yi,targetName:"Vec3"},{name:"dist",newName:"distance",target:yi,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:yi,targetName:"Vec3"},{name:"mag",newName:"len",target:yi,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:yi,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:yi,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:yi,targetName:"Vec3"}]),zn(yi.prototype,"Vec3",[{name:"mag",newName:"length",target:yi.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:yi.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:yi.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:yi.prototype,targetName:"Vec3"}]),zn(Hi,"Vec4",[{name:"sub",newName:"subtract",target:Hi,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Hi,targetName:"Vec4"},{name:"div",newName:"divide",target:Hi,targetName:"Vec4"},{name:"dist",newName:"distance",target:Hi,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Hi,targetName:"Vec4"},{name:"mag",newName:"len",target:Hi,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Hi,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Hi,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Hi,targetName:"Vec4"}]),zn(Hi.prototype,"Vec4",[{name:"mag",newName:"length",target:Hi.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Hi.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Hi.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Hi.prototype,targetName:"Vec4"}]),zn(Ai,"Quat",[{name:"mag",newName:"len",target:Ai,targetName:"Quat"},{name:"mul",newName:"multiply",target:Ai,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Ai,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Ai,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Ai,targetName:"Quat"}]),zn(Ai.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Ai.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Ai.prototype,targetName:"Quat"}]),zn(vi,"Color",[{name:"sub",newName:"subtract",target:vi,targetName:"Color"},{name:"mul",newName:"multiply",target:vi,targetName:"Color"},{name:"div",newName:"divide",target:vi,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:vi,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=t[1].toString(16);return i.Color.fromHEX(t[0],r)}}]),zn(Ei,"Mat3",[{name:"sub",newName:"subtract",target:Ei,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Ei,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Ei,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Ei,targetName:"Mat3"}]),zn(Ei.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Ei.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Ei.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Ei.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Ei.prototype,targetName:"Mat3"}]),zn(Ni,"Mat4",[{name:"sub",newName:"subtract",target:Ni,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Ni,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Ni,targetName:"Mat4"}]),zn(Ni.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Ni.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Ni.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Ni.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Ni.prototype,targetName:"Mat4"}]);var ji=e("AffineTransform",function(){function e(e,t,n,i,r,o){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=o}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,r=t.b,o=t.c,a=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=o*n.a+a*n.c,e.d=o*n.b+a*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var r,o;void 0===i?(i=n,r=t.x,o=t.y):(r=t,o=n),e.x=i.a*r+i.c*o+i.tx,e.y=i.b*r+i.d*o+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,r=t.y+t.height,o=n.a*t.x+n.c*t.y+n.tx,a=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,f=n.b*i+n.d*r+n.ty,_=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,f),m=Math.max(a,c,u,f);e.x=_,e.y=d,e.width=p-_,e.height=m-d},e.transformObb=function(e,t,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;t.x=a,t.y=s,n.x=c+a,n.y=l+s,e.x=u+a,e.y=h+s,i.x=c+u+a,i.y=l+h+s},e}());i.AffineTransform=ji;var Wi=e("Size",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}F(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},L(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}(et));function qi(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new Wi(e,t)}Wi.ZERO=Object.freeze(new Wi(0,0)),Wi.ONE=Object.freeze(new Wi(1,1)),Vt.fastDefine("cc.Size",Wi,{width:0,height:0}),i.size=qi,i.Size=Wi;var Xi=e("Rect",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.y=t.y,o.width=t.width,o.height=t.height,o.x=t.x):(o.x=t||0,o.y=n||0,o.width=i||0,o.height=r||0),o}F(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),o=Math.max(t.x,n.x),a=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=o-i,e.height=a-r,e},t.lerp=function(e,t,n,i){var r=t.x,o=t.y,a=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=o+(n.y-o)*i,e.width=a+(n.width-a)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,r=t.y,o=t.x+t.width,a=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(o,l)-e.x,e.height=Math.min(a,u)-e.y,e},t.union=function(e,t,n){var i=t.x,r=t.y,o=t.width,a=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+o,s+l)-e.x,e.height=Math.max(r+a,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=o+(e.height-o)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,o=e.m00*t+e.m04*n+e.m12,a=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,f=e.m01*i+e.m05*r+e.m13,_=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,f),m=Math.max(a,c,u,f);return this.x=_,this.y=d,this.width=p-_,this.height=m-d,this},n.transformMat4ToPoints=function(e,t,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;t.x=e.m00*o+e.m04*a+e.m12,t.y=e.m01*o+e.m05*a+e.m13,r.x=e.m00*s+e.m04*a+e.m12,r.y=e.m01*s+e.m05*a+e.m13,n.x=e.m00*o+e.m04*c+e.m12,n.y=e.m01*o+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},L(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new zi(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new zi(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new Wi(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}(et));function Yi(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new Xi(e,t,n,i)}Vt.fastDefine("cc.Rect",Xi,{x:0,y:0,width:0,height:0}),i.Rect=Xi,i.rect=Yi;var Ki=e("MATH_FLOAT_ARRAY",Float64Array),Qi=e("MathBase",function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t.createFloatArray=function(e){return new Ki(e)},L(t,[{key:"array",get:function(){return this._array}}]),t}(et)),Zi=Object.freeze({__proto__:null,bits:Fn,Vec2:zi,v2:Gi,Vec3:yi,v3:Ti,Vec4:Hi,v4:Vi,Quat:Ai,quat:Di,Mat3:Ei,Mat4:Ni,mat4:Fi,AffineTransform:ji,Size:Wi,size:qi,Rect:Xi,rect:Yi,Color:vi,color:gi,EPSILON:Kn,equals:Qn,approx:Zn,clamp:Jn,clamp01:$n,lerp:ei,toRadian:ti,toDegree:ni,random:ii,randomRange:ri,randomRangeInt:oi,pseudoRandom:ai,pseudoRandomRange:si,pseudoRandomRangeInt:ci,nextPow2:li,repeat:ui,pingPong:hi,inverseLerp:fi,absMaxComponent:_i,absMax:pi,enumerableProps:di,MATH_FLOAT_ARRAY:Ki,MathBase:Qi});e("math",Zi);var Ji=function(){function e(){this._groundAlbedoHDR=new Hi(.2,.2,.2,1),this._skyColorHDR=new Hi(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Hi(.2,.2,.2,1),this._skyColorLDR=new Hi(.2,.5,.8,1),this._skyIllumLDR=0,this._enabled=!1}var t=e.prototype;return t.initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.x=e.groundAlbedoHDR.x,this._groundAlbedoHDR.y=e.groundAlbedoHDR.y,this._groundAlbedoHDR.z=e.groundAlbedoHDR.z,this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.x=e.groundAlbedoLDR.x,this._groundAlbedoLDR.y=e.groundAlbedoLDR.y,this._groundAlbedoLDR.z=e.groundAlbedoLDR.z,this._skyIllumLDR=e.skyIllumLDR},t._destroy=function(){},t.destroy=function(){this._destroy()},L(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?(this._skyColorHDR.x=e.x,this._skyColorHDR.y=e.y,this._skyColorHDR.z=e.z):(this._skyColorLDR.x=e.x,this._skyColorLDR.y=e.y,this._skyColorLDR.z=e.z)}},{key:"skyIllum",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?(this._groundAlbedoHDR.x=e.x,this._groundAlbedoHDR.y=e.y,this._groundAlbedoHDR.z=e.z):(this._groundAlbedoLDR.x=e.x,this._groundAlbedoLDR.y=e.y,this._groundAlbedoLDR.z=e.z)}},{key:"native",get:function(){return this._nativeObj}}]),e}();Ji.SUN_ILLUM=65e3,Ji.SKY_ILLUM=2e4,i.Ambient=Ji;var $i=function(){function e(){this._enabled=!1,this._minPos=new yi(0,0,0),this._maxPos=new yi(0,0,0),this._depth=0}var t=e.prototype;return t.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},t._destroy=function(){},t.destroy=function(){this._destroy()},L(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),er=new yi,tr=new yi,nr=new yi,ir=new yi,rr=new yi,or=new yi,ar=new Array(3),sr=new Array(3);function cr(e,t){return yi.dot(t.n,e)-t.d}function lr(e,t,n){return yi.copy(e,t),yi.subtract(rr,n.center,n.halfExtents),yi.add(or,n.center,n.halfExtents),e.x=e.x<rr.x?rr.x:e.x,e.y=e.y<rr.y?rr.y:e.y,e.z=e.z<rr.z?rr.z:e.z,e.x=e.x>or.x?or.x:e.x,e.y=e.y>or.y?or.y:e.y,e.z=e.z>or.z?or.z:e.z,e}function ur(e,t,n){yi.set(er,n.orientation.m00,n.orientation.m01,n.orientation.m02),yi.set(tr,n.orientation.m03,n.orientation.m04,n.orientation.m05),yi.set(nr,n.orientation.m06,n.orientation.m07,n.orientation.m08),ar[0]=er,ar[1]=tr,ar[2]=nr,sr[0]=n.halfExtents.x,sr[1]=n.halfExtents.y,sr[2]=n.halfExtents.z,yi.subtract(ir,t,n.center),yi.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=yi.dot(ir,ar[i]);r>sr[i]&&(r=sr[i]),r<-sr[i]&&(r=-sr[i]),e.x+=r*ar[i].x,e.y+=r*ar[i].y,e.z+=r*ar[i].z}return e}var hr=Object.freeze({__proto__:null,point_plane:cr,pt_point_plane:function(e,t,n){var i=cr(t,n);return yi.subtract(e,t,yi.multiplyScalar(e,n.n,i))},pt_point_aabb:lr,pt_point_obb:ur,pt_point_line:function(e,t,n,i){yi.subtract(er,n,i);var r=er,o=yi.lengthSqr(r);if(0==o)yi.copy(e,n);else{yi.subtract(er,t,n);var a=yi.dot(er,r)/o;a<0?yi.copy(e,n):a>1?yi.copy(e,i):yi.scaleAndAdd(e,n,r,a)}}}),fr={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},_r=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=fr.SHAPE_LINE,this.s=new yi(e,t,n),this.e=new yi(i,r,o)}return e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return yi.copy(e.s,t.s),yi.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return yi.copy(e.s,t),yi.copy(e.e,n),e},e.set=function(e,t,n,i,r,o,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=o,e.e.z=a,e},e.len=function(e){return yi.distance(e.s,e.e)},e.prototype.length=function(){return yi.distance(this.s,this.e)},L(e,[{key:"type",get:function(){return this._type}}]),e}(),pr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=fr.SHAPE_RAY,this.o=new yi(e,t,n),this.d=new yi(i,r,o)}return e.create=function(t,n,i,r,o,a){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return yi.copy(e.o,t.o),yi.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return yi.copy(e.o,t),yi.normalize(e.d,yi.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,r,o,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=o,e.d.z=a,e},e.prototype.computeHit=function(e,t){yi.normalize(e,this.d),yi.scaleAndAdd(e,this.o,e,t)},L(e,[{key:"type",get:function(){return this._type}}]),e}(),dr=new yi,mr=new yi,vr=new yi,gr=new yi;function yr(e){return Math.max(Math.max(e.x,e.y),e.z)}var Sr,xr,Tr,Er,br,Cr,Ar,wr,Rr,Ir,Pr,Or,Dr,Mr,Nr,Lr,Br,Fr,zr,Ur,kr,Gr,Hr,Vr,jr,Wr,qr,Xr,Yr,Kr,Qr,Zr,Jr,$r,eo,to,no,io,ro,oo,ao,so=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new yi(0,0,0),this._radius=0,this._type=void 0,this._type=fr.SHAPE_SPHERE,this._center=new yi(e,t,n),this._radius=i}e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return yi.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return yi.multiplyScalar(e.center,yi.add(dr,t,n),.5),e.radius=.5*yi.subtract(dr,n,t).length(),e},e.set=function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e};var t=e.prototype;return t.destroy=function(){},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){yi.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),yi.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,r){yi.transformMat4(r.center,this.center,e),r.radius=this.radius*yr(i)},t.translateAndRotate=function(e,t,n){yi.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*yr(e)},t.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),yi.subtract(mr,e,this.center);var t=mr.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,yi.multiplyScalar(mr,mr,n/t),yi.add(this.center,this.center,mr)}},t.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}},t.mergeAABB=function(e){e.getBoundary(vr,gr),this.mergePoint(vr),this.mergePoint(gr)},L(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]),e}(),co=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=fr.SHAPE_TRIANGLE,this.a=new yi(e,t,n),this.b=new yi(i,r,o),this.c=new yi(a,s,c)}return e.create=function(t,n,i,r,o,a,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,r,o,a,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return yi.copy(e.a,t.a),yi.copy(e.b,t.b),yi.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return yi.copy(e.a,t),yi.copy(e.b,n),yi.copy(e.c,i),e},e.set=function(e,t,n,i,r,o,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e},L(e,[{key:"type",get:function(){return this._type}}]),e}(),lo=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(Sr||(Sr={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(xr||(xr={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.WEBGL=5]="WEBGL",e[e.WEBGL2=6]="WEBGL2",e[e.WEBGPU=7]="WEBGPU"}(Tr||(Tr={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(Er||(Er={})),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_SRGB=7]="FORMAT_SRGB",e[e.FORMAT_ETC1=8]="FORMAT_ETC1",e[e.FORMAT_ETC2=9]="FORMAT_ETC2",e[e.FORMAT_DXT=10]="FORMAT_DXT",e[e.FORMAT_PVRTC=11]="FORMAT_PVRTC",e[e.FORMAT_ASTC=12]="FORMAT_ASTC",e[e.FORMAT_RGB8=13]="FORMAT_RGB8",e[e.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=17]="BLEND_MINMAX",e[e.COMPUTE_SHADER=18]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=20]="COUNT"}(br||(br={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(Cr||(Cr={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Ar||(Ar={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(wr||(wr={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(Rr||(Rr={})),function(e){e[e.NONE=0]="NONE"}(Ir||(Ir={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(Pr||(Pr={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(Or||(Or={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Dr||(Dr={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Mr||(Mr={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Nr||(Nr={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Lr||(Lr={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(Br||(Br={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(Fr||(Fr={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(zr||(zr={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Ur||(Ur={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(kr||(kr={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Gr||(Gr={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Hr||(Hr={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(Vr||(Vr={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(jr||(jr={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(Wr||(Wr={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(qr||(qr={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=3]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=17]="TRANSFER_READ",e[e.HOST_READ=18]="HOST_READ",e[e.PRESENT=19]="PRESENT",e[e.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=25]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",e[e.HOST_WRITE=27]="HOST_WRITE"}(Xr||(Xr={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Yr||(Yr={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(Kr||(Kr={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Qr||(Qr={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Zr||(Zr={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Jr||(Jr={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}($r||($r={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(eo||(eo={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(to||(to={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(no||(no={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(io||(io={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(ro||(ro={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(oo||(oo={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(ao||(ao={}));var uo,ho=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),fo=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d,m,v,g,y,S,x){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===f&&(f=0),void 0===_&&(_=1),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=new ho),void 0===v&&(v=new ho),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===S&&(S=1),void 0===x&&(x=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=f,this.uboOffsetAlignment=_,this.maxComputeSharedMemorySize=p,this.maxComputeWorkGroupInvocations=d,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=S,this.clipSpaceSignY=x}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}(),_o=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),po=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),mo=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}(),vo=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),go=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),yo=function(){function e(e,t,n,i,r){void 0===e&&(e=new vo),void 0===t&&(t=new _o),void 0===n&&(n=new vo),void 0===i&&(i=new _o),void 0===r&&(r=new mo),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}(),So=function(){function e(e,t,n,i,r,o){void 0===e&&(e=new vo),void 0===t&&(t=new _o),void 0===n&&(n=new mo),void 0===i&&(i=new vo),void 0===r&&(r=new _o),void 0===o&&(o=new mo),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}(),xo=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new _o),void 0===i&&(i=new mo),void 0===r&&(r=new vo),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=r}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}(),To=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}(),Eo=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}(),bo=function(){function e(e,t,n){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=0),this.bufferOffsets=e,this.samplerOffsets=t,this.flexibleSet=n}return e.prototype.copy=function(e){return this.bufferOffsets=e.bufferOffsets.slice(),this.samplerOffsets=e.samplerOffsets.slice(),this.flexibleSet=e.flexibleSet,this},e}(),Co=function(){function e(e,t,n,i){void 0===e&&(e=null),void 0===t&&(t=Br.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=e,this.vsyncMode=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this},e}(),Ao=function(){function e(e){void 0===e&&(e=new bo),this.bindingMappingInfo=e}return e.prototype.copy=function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this},e}(),wo=function(){function e(e,t,n,i,r){void 0===e&&(e=Rr.NONE),void 0===t&&(t=Or.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=Ir.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=r}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}(),Ro=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}(),Io=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}(),Po=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}(),Oo=function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return lo(this.drawInfos,e.drawInfos,Io),this},e}(),Do=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=Dr.TEX2D),void 0===t&&(t=Mr.NONE),void 0===n&&(n=Cr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=Nr.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=Lr.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this},e}(),Mo=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=null),void 0===t&&(t=Dr.TEX2D),void 0===n&&(n=Cr.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}(),No=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=Fr.LINEAR),void 0===t&&(t=Fr.LINEAR),void 0===n&&(n=Fr.NONE),void 0===i&&(i=zr.WRAP),void 0===r&&(r=zr.WRAP),void 0===o&&(o=zr.WRAP),void 0===a&&(a=0),void 0===s&&(s=Ur.ALWAYS),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this},e}(),Lo=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=wr.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Bo=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,lo(this.members,e.members,Lo),this.count=e.count,this},e}(),Fo=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=wr.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),zo=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Uo=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=wr.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),ko=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=wr.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=Pr.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Go=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=Pr.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Ho=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Vo=function(){function e(e,t){void 0===e&&(e=jr.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}(),jo=function(){function e(e,t,n,i,r,o){void 0===e&&(e=""),void 0===t&&(t=Cr.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}(),Wo=function(){function e(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,lo(this.stages,e.stages,Vo),lo(this.attributes,e.attributes,jo),lo(this.blocks,e.blocks,Bo),lo(this.buffers,e.buffers,Go),lo(this.samplerTextures,e.samplerTextures,Fo),lo(this.samplers,e.samplers,zo),lo(this.textures,e.textures,Uo),lo(this.images,e.images,ko),lo(this.subpassInputs,e.subpassInputs,Ho),this},e}(),qo=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return lo(this.attributes,e.attributes,jo),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}(),Xo=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=Cr.UNKNOWN),void 0===t&&(t=Lr.ONE),void 0===n&&(n=Wr.CLEAR),void 0===i&&(i=qr.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Xr.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),Yo=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=Cr.UNKNOWN),void 0===t&&(t=Lr.ONE),void 0===n&&(n=Wr.CLEAR),void 0===i&&(i=qr.STORE),void 0===r&&(r=Wr.CLEAR),void 0===o&&(o=qr.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Xr.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),Ko=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Yr.NONE),void 0===s&&(s=Yr.NONE),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},e}(),Qo=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=e,this.dstSubpass=t,this.srcAccesses=n,this.dstAccesses=i}return e.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.srcAccesses=e.srcAccesses.slice(),this.dstAccesses=e.dstAccesses.slice(),this},e}(),Zo=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=new Yo),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n,this.dependencies=i}return e.prototype.copy=function(e){return lo(this.colorAttachments,e.colorAttachments,Xo),this.depthStencilAttachment.copy(e.depthStencilAttachment),lo(this.subpasses,e.subpasses,Ko),lo(this.dependencies,e.dependencies,Qo),this},e}(),Jo=function(){function e(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this},e}(),$o=function(){function e(e,t,n,i,r){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}(),ea=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},e}(),ta=function(){function e(e,t,n,i,r){void 0===e&&(e=-1),void 0===t&&(t=no.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=jr.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}(),na=function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return lo(this.bindings,e.bindings,ta),this},e}(),ia=function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}(),ra=function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}(),oa=function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return lo(this.attributes,e.attributes,jo),this},e}(),aa=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=oo.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}(),sa=function(){function e(e){void 0===e&&(e=io.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}(),ca=function(){function e(e,t,n){void 0===e&&(e=ro.OCCLUSION),void 0===t&&(t=65536),void 0===n&&(n=!0),this.type=e,this.maxQueryObjects=t,this.forceWait=n}return e.prototype.copy=function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this},e}(),la=function(e,t,n,i,r,o,a,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=Ar.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},ua=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}(),ha=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.writeMask=e,this.compareMask=t,this.reference=n}return e.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},e}(),fa=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=new To),void 0===t&&(t=new po),void 0===n&&(n=new Eo),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new ha),void 0===u&&(u=new ha),this.viewport=e,this.scissor=t,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return e.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},e}(),_a=function(){function e(t){this._objectType=Sr.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=t,this._objectID=e._idTable[Sr.UNKNOWN]++,this._typedID=e._idTable[t]++}return L(e,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),e}();_a._idTable=Array(Sr.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(uo||(uo={}));var pa=Object.freeze([new la("UNKNOWN",0,0,Ar.NONE,!1,!1,!1,!1),new la("A8",1,1,Ar.UNORM,!0,!1,!1,!1),new la("L8",1,1,Ar.UNORM,!1,!1,!1,!1),new la("LA8",1,2,Ar.UNORM,!0,!1,!1,!1),new la("R8",1,1,Ar.UNORM,!1,!1,!1,!1),new la("R8SN",1,1,Ar.SNORM,!1,!1,!1,!1),new la("R8UI",1,1,Ar.UINT,!1,!1,!1,!1),new la("R8I",1,1,Ar.INT,!1,!1,!1,!1),new la("R16F",2,1,Ar.FLOAT,!1,!1,!1,!1),new la("R16UI",2,1,Ar.UINT,!1,!1,!1,!1),new la("R16I",2,1,Ar.INT,!1,!1,!1,!1),new la("R32F",4,1,Ar.FLOAT,!1,!1,!1,!1),new la("R32UI",4,1,Ar.UINT,!1,!1,!1,!1),new la("R32I",4,1,Ar.INT,!1,!1,!1,!1),new la("RG8",2,2,Ar.UNORM,!1,!1,!1,!1),new la("RG8SN",2,2,Ar.SNORM,!1,!1,!1,!1),new la("RG8UI",2,2,Ar.UINT,!1,!1,!1,!1),new la("RG8I",2,2,Ar.INT,!1,!1,!1,!1),new la("RG16F",4,2,Ar.FLOAT,!1,!1,!1,!1),new la("RG16UI",4,2,Ar.UINT,!1,!1,!1,!1),new la("RG16I",4,2,Ar.INT,!1,!1,!1,!1),new la("RG32F",8,2,Ar.FLOAT,!1,!1,!1,!1),new la("RG32UI",8,2,Ar.UINT,!1,!1,!1,!1),new la("RG32I",8,2,Ar.INT,!1,!1,!1,!1),new la("RGB8",3,3,Ar.UNORM,!1,!1,!1,!1),new la("SRGB8",3,3,Ar.UNORM,!1,!1,!1,!1),new la("RGB8SN",3,3,Ar.SNORM,!1,!1,!1,!1),new la("RGB8UI",3,3,Ar.UINT,!1,!1,!1,!1),new la("RGB8I",3,3,Ar.INT,!1,!1,!1,!1),new la("RGB16F",6,3,Ar.FLOAT,!1,!1,!1,!1),new la("RGB16UI",6,3,Ar.UINT,!1,!1,!1,!1),new la("RGB16I",6,3,Ar.INT,!1,!1,!1,!1),new la("RGB32F",12,3,Ar.FLOAT,!1,!1,!1,!1),new la("RGB32UI",12,3,Ar.UINT,!1,!1,!1,!1),new la("RGB32I",12,3,Ar.INT,!1,!1,!1,!1),new la("RGBA8",4,4,Ar.UNORM,!0,!1,!1,!1),new la("BGRA8",4,4,Ar.UNORM,!0,!1,!1,!1),new la("SRGB8_A8",4,4,Ar.UNORM,!0,!1,!1,!1),new la("RGBA8SN",4,4,Ar.SNORM,!0,!1,!1,!1),new la("RGBA8UI",4,4,Ar.UINT,!0,!1,!1,!1),new la("RGBA8I",4,4,Ar.INT,!0,!1,!1,!1),new la("RGBA16F",8,4,Ar.FLOAT,!0,!1,!1,!1),new la("RGBA16UI",8,4,Ar.UINT,!0,!1,!1,!1),new la("RGBA16I",8,4,Ar.INT,!0,!1,!1,!1),new la("RGBA32F",16,4,Ar.FLOAT,!0,!1,!1,!1),new la("RGBA32UI",16,4,Ar.UINT,!0,!1,!1,!1),new la("RGBA32I",16,4,Ar.INT,!0,!1,!1,!1),new la("R5G6B5",2,3,Ar.UNORM,!1,!1,!1,!1),new la("R11G11B10F",4,3,Ar.FLOAT,!1,!1,!1,!1),new la("RGB5A1",2,4,Ar.UNORM,!0,!1,!1,!1),new la("RGBA4",2,4,Ar.UNORM,!0,!1,!1,!1),new la("RGB10A2",2,4,Ar.UNORM,!0,!1,!1,!1),new la("RGB10A2UI",2,4,Ar.UINT,!0,!1,!1,!1),new la("RGB9E5",2,4,Ar.FLOAT,!0,!1,!1,!1),new la("DEPTH",4,1,Ar.FLOAT,!1,!0,!1,!1),new la("DEPTH_STENCIL",5,2,Ar.FLOAT,!1,!0,!0,!1),new la("BC1",1,3,Ar.UNORM,!1,!1,!1,!0),new la("BC1_ALPHA",1,4,Ar.UNORM,!0,!1,!1,!0),new la("BC1_SRGB",1,3,Ar.UNORM,!1,!1,!1,!0),new la("BC1_SRGB_ALPHA",1,4,Ar.UNORM,!0,!1,!1,!0),new la("BC2",1,4,Ar.UNORM,!0,!1,!1,!0),new la("BC2_SRGB",1,4,Ar.UNORM,!0,!1,!1,!0),new la("BC3",1,4,Ar.UNORM,!0,!1,!1,!0),new la("BC3_SRGB",1,4,Ar.UNORM,!0,!1,!1,!0),new la("BC4",1,1,Ar.UNORM,!1,!1,!1,!0),new la("BC4_SNORM",1,1,Ar.SNORM,!1,!1,!1,!0),new la("BC5",1,2,Ar.UNORM,!1,!1,!1,!0),new la("BC5_SNORM",1,2,Ar.SNORM,!1,!1,!1,!0),new la("BC6H_UF16",1,3,Ar.UFLOAT,!1,!1,!1,!0),new la("BC6H_SF16",1,3,Ar.FLOAT,!1,!1,!1,!0),new la("BC7",1,4,Ar.UNORM,!0,!1,!1,!0),new la("BC7_SRGB",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ETC_RGB8",1,3,Ar.UNORM,!1,!1,!1,!0),new la("ETC2_RGB8",1,3,Ar.UNORM,!1,!1,!1,!0),new la("ETC2_SRGB8",1,3,Ar.UNORM,!1,!1,!1,!0),new la("ETC2_RGB8_A1",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ETC2_SRGB8_A1",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ETC2_RGBA8",2,4,Ar.UNORM,!0,!1,!1,!0),new la("ETC2_SRGB8_A8",2,4,Ar.UNORM,!0,!1,!1,!0),new la("EAC_R11",1,1,Ar.UNORM,!1,!1,!1,!0),new la("EAC_R11SN",1,1,Ar.SNORM,!1,!1,!1,!0),new la("EAC_RG11",2,2,Ar.UNORM,!1,!1,!1,!0),new la("EAC_RG11SN",2,2,Ar.SNORM,!1,!1,!1,!0),new la("PVRTC_RGB2",2,3,Ar.UNORM,!1,!1,!1,!0),new la("PVRTC_RGBA2",2,4,Ar.UNORM,!0,!1,!1,!0),new la("PVRTC_RGB4",2,3,Ar.UNORM,!1,!1,!1,!0),new la("PVRTC_RGBA4",2,4,Ar.UNORM,!0,!1,!1,!0),new la("PVRTC2_2BPP",2,4,Ar.UNORM,!0,!1,!1,!0),new la("PVRTC2_4BPP",2,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_4x4",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_5x4",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_5x5",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_6x5",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_6x6",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_8x5",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_8x6",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_8x8",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_10x5",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_10x6",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_10x8",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_10x10",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_12x10",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_RGBA_12x12",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_4x4",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_5x4",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_5x5",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_6x5",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_6x6",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_8x5",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_8x6",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_8x8",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_10x5",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_10x6",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_10x8",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_10x10",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_12x10",1,4,Ar.UNORM,!0,!1,!1,!0),new la("ASTC_SRGBA_12x12",1,4,Ar.UNORM,!0,!1,!1,!0)]),da=no.UNIFORM_BUFFER|no.DYNAMIC_UNIFORM_BUFFER|no.STORAGE_BUFFER|no.DYNAMIC_STORAGE_BUFFER,ma=no.SAMPLER_TEXTURE|no.SAMPLER|no.TEXTURE|no.STORAGE_IMAGE|no.INPUT_ATTACHMENT,va=no.DYNAMIC_STORAGE_BUFFER|no.DYNAMIC_UNIFORM_BUFFER,ga=28;function ya(e){return e>0&&0==(e&e-1)}function Sa(e,t,n,i){if(!pa[e].isCompressed)return t*n*i*pa[e].size;switch(e){case Cr.BC1:case Cr.BC1_ALPHA:case Cr.BC1_SRGB:case Cr.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Cr.BC2:case Cr.BC2_SRGB:case Cr.BC3:case Cr.BC3_SRGB:case Cr.BC4:case Cr.BC4_SNORM:case Cr.BC6H_SF16:case Cr.BC6H_UF16:case Cr.BC7:case Cr.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Cr.BC5:case Cr.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case Cr.ETC_RGB8:case Cr.ETC2_RGB8:case Cr.ETC2_SRGB8:case Cr.ETC2_RGB8_A1:case Cr.EAC_R11:case Cr.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case Cr.ETC2_RGBA8:case Cr.ETC2_SRGB8_A1:case Cr.EAC_RG11:case Cr.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Cr.PVRTC_RGB2:case Cr.PVRTC_RGBA2:case Cr.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case Cr.PVRTC_RGB4:case Cr.PVRTC_RGBA4:case Cr.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case Cr.ASTC_RGBA_4X4:case Cr.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case Cr.ASTC_RGBA_5X4:case Cr.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case Cr.ASTC_RGBA_5X5:case Cr.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case Cr.ASTC_RGBA_6X5:case Cr.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case Cr.ASTC_RGBA_6X6:case Cr.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case Cr.ASTC_RGBA_8X5:case Cr.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case Cr.ASTC_RGBA_8X6:case Cr.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case Cr.ASTC_RGBA_8X8:case Cr.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case Cr.ASTC_RGBA_10X5:case Cr.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case Cr.ASTC_RGBA_10X6:case Cr.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case Cr.ASTC_RGBA_10X8:case Cr.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case Cr.ASTC_RGBA_10X10:case Cr.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case Cr.ASTC_RGBA_12X10:case Cr.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case Cr.ASTC_RGBA_12X12:case Cr.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function xa(e,t,n,i,r){for(var o=0,a=0;a<r;++a)o+=Sa(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return o}var Ta=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Ea(e){return Ta[e]||0}function ba(e){var t=e.size/e.count;switch(e.type){case Ar.UNORM:case Ar.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Ar.SNORM:case Ar.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Ar.FLOAT:return Float32Array}return Float32Array}var Ca=Object.freeze({__proto__:null,get ObjectType(){return Sr},get Status(){return xr},get API(){return Tr},get SurfaceTransform(){return Er},get Feature(){return br},get Format(){return Cr},get FormatType(){return Ar},get Type(){return wr},get BufferUsageBit(){return Rr},get BufferFlagBit(){return Ir},get MemoryAccessBit(){return Pr},get MemoryUsageBit(){return Or},get TextureType(){return Dr},get TextureUsageBit(){return Mr},get TextureFlagBit(){return Nr},get SampleCount(){return Lr},get VsyncMode(){return Br},get Filter(){return Fr},get Address(){return zr},get ComparisonFunc(){return Ur},get StencilOp(){return kr},get BlendFactor(){return Gr},get BlendOp(){return Hr},get ColorMask(){return Vr},get ShaderStageFlagBit(){return jr},get LoadOp(){return Wr},get StoreOp(){return qr},get AccessType(){return Xr},get ResolveMode(){return Yr},get PipelineBindPoint(){return Kr},get PrimitiveMode(){return Qr},get PolygonMode(){return Zr},get ShadeModel(){return Jr},get CullMode(){return $r},get DynamicStateFlagBit(){return eo},get StencilFace(){return to},get DescriptorType(){return no},get QueueType(){return io},get QueryType(){return ro},get CommandBufferType(){return oo},get ClearFlagBit(){return ao},Size:ho,DeviceCaps:fo,Offset:_o,Rect:po,Extent:mo,TextureSubresLayers:vo,TextureSubresRange:go,TextureCopy:yo,TextureBlit:So,BufferTextureCopy:xo,Viewport:To,Color:Eo,BindingMappingInfo:bo,SwapchainInfo:Co,DeviceInfo:Ao,BufferInfo:wo,BufferViewInfo:Ro,DrawInfo:Io,DispatchInfo:Po,IndirectBuffer:Oo,TextureInfo:Do,TextureViewInfo:Mo,SamplerInfo:No,Uniform:Lo,UniformBlock:Bo,UniformSamplerTexture:Fo,UniformSampler:zo,UniformTexture:Uo,UniformStorageImage:ko,UniformStorageBuffer:Go,UniformInputAttachment:Ho,ShaderStage:Vo,Attribute:jo,ShaderInfo:Wo,InputAssemblerInfo:qo,ColorAttachment:Xo,DepthStencilAttachment:Yo,SubpassInfo:Ko,SubpassDependency:Qo,RenderPassInfo:Zo,GlobalBarrierInfo:Jo,TextureBarrierInfo:$o,FramebufferInfo:ea,DescriptorSetLayoutBinding:ta,DescriptorSetLayoutInfo:na,DescriptorSetInfo:ia,PipelineLayoutInfo:ra,InputState:oa,CommandBufferInfo:aa,QueueInfo:sa,QueryPoolInfo:ca,FormatInfo:la,MemoryStatus:ua,DynamicStencilStates:ha,DynamicStates:fa,GFXObject:_a,get AttributeName(){return uo},FormatInfos:pa,DESCRIPTOR_BUFFER_TYPE:da,DESCRIPTOR_SAMPLER_TYPE:ma,DESCRIPTOR_DYNAMIC_TYPE:va,DRAW_INFO_SIZE:ga,IsPowerOf2:ya,FormatSize:Sa,FormatSurfaceSize:xa,GetTypeSize:Ea,getTypedArrayConstructor:ba}),Aa=function(e){function t(){var t;return(t=e.call(this,Sr.BUFFER)||this)._usage=Rr.NONE,t._memUsage=Or.NONE,t._size=0,t._stride=1,t._count=0,t._flags=Ir.NONE,t._isBufferView=!1,t}return F(t,e),L(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}(_a),wa=function(e){function t(){var t;return(t=e.call(this,Sr.COMMAND_BUFFER)||this)._queue=null,t._type=oo.PRIMARY,t._numDrawCalls=0,t._numInstances=0,t._numTris=0,t}return F(t,e),L(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(_a),Ra=function(){function e(){this._gfxAPI=Tr.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(br.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new ua,this._caps=new fo,this._bindingMappingInfo=new bo,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return e.prototype.hasFeature=function(e){return this._features[e]},L(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),e}();Ra.canvas=void 0;var Ia=function(e){function t(){var t;return(t=e.call(this,Sr.SWAPCHAIN)||this)._transform=Er.IDENTITY,t._colorTexture=null,t._depthStencilTexture=null,t}return F(t,e),L(t,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),t}(_a),Pa=function(e){function t(){var t;return(t=e.call(this,Sr.FRAMEBUFFER)||this)._renderPass=null,t._colorTextures=[],t._depthStencilTexture=null,t}return F(t,e),L(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(_a),Oa=String.prototype.charCodeAt;function Da(e){return this[e]}function Ma(e,t){for(var n=e.length,i=t^n,r=0,o="string"==typeof e?Oa:Da;n>=4;){var a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(e,r+2))<<16;case 2:i^=(255&o.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var Na=function(e){function t(){var t;return(t=e.call(this,Sr.INPUT_ASSEMBLER)||this)._attributes=[],t._attributesHash=0,t._vertexBuffers=[],t._indexBuffer=null,t._indirectBuffer=null,t._drawInfo=new Io,t}F(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return Ma(e,666)},L(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}}]),t}(_a),La=function(e){function t(){var t;return(t=e.call(this,Sr.DESCRIPTOR_SET)||this)._layout=null,t._buffers=[],t._textures=[],t._samplers=[],t._isDirty=!1,t}F(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&da){var o=this._layout.descriptorIndices[e];this._buffers[o+n]!==t&&(this._buffers[o+n]=t,this._isDirty=!0)}},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ma){var o=this._layout.descriptorIndices[e];this._samplers[o+n]!==t&&(this._samplers[o+n]=t,this._isDirty=!0)}},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ma){var o=this._layout.descriptorIndices[e];this._textures[o+n]!==t&&(this._textures[o+n]=t,this._isDirty=!0)}},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},L(t,[{key:"layout",get:function(){return this._layout}}]),t}(_a),Ba=function(e){function t(){var t;return(t=e.call(this,Sr.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],t._bindingIndices=[],t._descriptorIndices=[],t}return F(t,e),L(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(_a),Fa=function(e){function t(){var t;return(t=e.call(this,Sr.PIPELINE_LAYOUT)||this)._setLayouts=[],t}return F(t,e),L(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(_a),za=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=Zr.FILL),void 0===n&&(n=Jr.GOURAND),void 0===i&&(i=$r.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=Zr.FILL,this.shadeModel=Jr.GOURAND,this.cullMode=$r.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},L(e,[{key:"native",get:function(){return this}}]),e}(),Ua=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=Ur.LESS),void 0===i&&(i=!1),void 0===r&&(r=Ur.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=kr.KEEP),void 0===c&&(c=kr.KEEP),void 0===l&&(l=kr.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===f&&(f=Ur.ALWAYS),void 0===_&&(_=65535),void 0===p&&(p=65535),void 0===d&&(d=kr.KEEP),void 0===m&&(m=kr.KEEP),void 0===v&&(v=kr.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=f,this.stencilReadMaskBack=_,this.stencilWriteMaskBack=p,this.stencilFailOpBack=d,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Ur.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Ur.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=kr.KEEP,this.stencilZFailOpFront=kr.KEEP,this.stencilPassOpFront=kr.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Ur.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=kr.KEEP,this.stencilZFailOpBack=kr.KEEP,this.stencilPassOpBack=kr.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},L(e,[{key:"native",get:function(){return this}}]),e}(),ka=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=!1),void 0===t&&(t=Gr.ONE),void 0===n&&(n=Gr.ZERO),void 0===i&&(i=Hr.ADD),void 0===r&&(r=Gr.ONE),void 0===o&&(o=Gr.ZERO),void 0===a&&(a=Hr.ADD),void 0===s&&(s=Vr.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=Gr.ONE,this.blendDst=Gr.ZERO,this.blendEq=Hr.ADD,this.blendSrcAlpha=Gr.ONE,this.blendDstAlpha=Gr.ZERO,this.blendAlphaEq=Hr.ADD,this.blendColorMask=Vr.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},e}(),Ga=function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new Eo),void 0===i&&(i=[new ka]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new ka),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},L(e,[{key:"native",get:function(){return this}}]),e}(),Ha=function(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new oa),void 0===r&&(r=new za),void 0===o&&(o=new Ua),void 0===a&&(a=new Ga),void 0===s&&(s=Qr.TRIANGLE_LIST),void 0===c&&(c=eo.NONE),void 0===l&&(l=Kr.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Va=function(e){function t(){var t;return(t=e.call(this,Sr.PIPELINE_STATE)||this)._shader=null,t._pipelineLayout=null,t._primitive=Qr.TRIANGLE_LIST,t._is=null,t._rs=new za,t._dss=new Ua,t._bs=new Ga,t._dynamicStates=eo.NONE,t._renderPass=null,t}return F(t,e),L(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(_a),ja=function(e){function t(){var t;return(t=e.call(this,Sr.QUEUE)||this)._type=io.GRAPHICS,t}return F(t,e),L(t,[{key:"type",get:function(){return this._type}}]),t}(_a),Wa=function(e){function t(){var t;return(t=e.call(this,Sr.RENDER_PASS)||this)._colorInfos=[],t._depthStencilInfo=null,t._subpasses=[],t._hash=0,t}return F(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=","+r.format+","+r.sampleCount}}if(n.colors.length){e+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];e+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return Ma(e,666)},L(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}(_a),qa=function(e){function t(t,n){var i;return(i=e.call(this,Sr.SAMPLER)||this)._info=new No,i._hash=0,i._info.copy(t),i._hash=n,i}return F(t,e),t.computeHash=function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16},t.unpackFromHash=function(e){var t=new No;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t},L(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(_a),Xa=function(e){function t(){var t;return(t=e.call(this,Sr.SHADER)||this)._name="",t._stages=[],t._attributes=[],t._blocks=[],t._samplers=[],t}return F(t,e),L(t,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(_a),Ya=function(e){function t(){var t;return(t=e.call(this,Sr.TEXTURE)||this)._type=Dr.TEX2D,t._usage=Mr.NONE,t._format=Cr.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._layerCount=1,t._levelCount=1,t._samples=Lr.ONE,t._flags=Nr.NONE,t._isPowerOf2=!1,t._size=0,t}return F(t,e),L(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),t}(_a),Ka=function(e){function t(t,n){var i;return(i=e.call(this,Sr.GLOBAL_BARRIER)||this)._info=new Jo,i._hash=0,i._info.copy(t),i._hash=n,i}return F(t,e),t.computeHash=function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" "+e.prevAccesses[n];t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" "+e.nextAccesses[i];return Ma(t,666)},L(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(_a),Qa=function(e){function t(t,n){var i;return(i=e.call(this,Sr.TEXTURE_BARRIER)||this)._info=new $o,i._hash=0,i._info.copy(t),i._hash=n,i}return F(t,e),t.computeHash=function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" "+e.prevAccesses[n];t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" "+e.nextAccesses[i];return t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,Ma(t+=e.dstQueue?e.dstQueue.type:0,666)},L(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(_a),Za={Device:Ra,Swapchain:Ia,Buffer:Aa,Texture:Ya,Sampler:qa,Shader:Xa,InputAssembler:Na,RenderPass:Wa,Framebuffer:Pa,DescriptorSet:La,DescriptorSetLayout:Ba,PipelineLayout:Fa,PipelineState:Va,CommandBuffer:wa,Queue:ja,GlobalBarrier:Ka,TextureBarrier:Qa,RasterizerState:za,BlendState:Ga,BlendTarget:ka,DepthStencilState:Ua,PipelineStateInfo:Ha};Object.assign(Za,Ca),i.gfx=Za;var Ja,$a={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var es in i.gfx)if("__esModule"!==es){var ts=$a[es];""===ts?ts=es:void 0===ts&&(ts="GFX"+es),zn(i,"cc",[{name:ts,newName:es,target:i.gfx,targetName:"cc.gfx"}])}e("gfx",Object.freeze({__proto__:null,DescriptorSet:La,Buffer:Aa,CommandBuffer:wa,get ObjectType(){return Sr},get Status(){return xr},get API(){return Tr},get SurfaceTransform(){return Er},get Feature(){return br},get Format(){return Cr},get FormatType(){return Ar},get Type(){return wr},get BufferUsageBit(){return Rr},get BufferFlagBit(){return Ir},get MemoryAccessBit(){return Pr},get MemoryUsageBit(){return Or},get TextureType(){return Dr},get TextureUsageBit(){return Mr},get TextureFlagBit(){return Nr},get SampleCount(){return Lr},get VsyncMode(){return Br},get Filter(){return Fr},get Address(){return zr},get ComparisonFunc(){return Ur},get StencilOp(){return kr},get BlendFactor(){return Gr},get BlendOp(){return Hr},get ColorMask(){return Vr},get ShaderStageFlagBit(){return jr},get LoadOp(){return Wr},get StoreOp(){return qr},get AccessType(){return Xr},get ResolveMode(){return Yr},get PipelineBindPoint(){return Kr},get PrimitiveMode(){return Qr},get PolygonMode(){return Zr},get ShadeModel(){return Jr},get CullMode(){return $r},get DynamicStateFlagBit(){return eo},get StencilFace(){return to},get DescriptorType(){return no},get QueueType(){return io},get QueryType(){return ro},get CommandBufferType(){return oo},get ClearFlagBit(){return ao},Size:ho,DeviceCaps:fo,Offset:_o,Rect:po,Extent:mo,TextureSubresLayers:vo,TextureSubresRange:go,TextureCopy:yo,TextureBlit:So,BufferTextureCopy:xo,Viewport:To,Color:Eo,BindingMappingInfo:bo,SwapchainInfo:Co,DeviceInfo:Ao,BufferInfo:wo,BufferViewInfo:Ro,DrawInfo:Io,DispatchInfo:Po,IndirectBuffer:Oo,TextureInfo:Do,TextureViewInfo:Mo,SamplerInfo:No,Uniform:Lo,UniformBlock:Bo,UniformSamplerTexture:Fo,UniformSampler:zo,UniformTexture:Uo,UniformStorageImage:ko,UniformStorageBuffer:Go,UniformInputAttachment:Ho,ShaderStage:Vo,Attribute:jo,ShaderInfo:Wo,InputAssemblerInfo:qo,ColorAttachment:Xo,DepthStencilAttachment:Yo,SubpassInfo:Ko,SubpassDependency:Qo,RenderPassInfo:Zo,GlobalBarrierInfo:Jo,TextureBarrierInfo:$o,FramebufferInfo:ea,DescriptorSetLayoutBinding:ta,DescriptorSetLayoutInfo:na,DescriptorSetInfo:ia,PipelineLayoutInfo:ra,InputState:oa,CommandBufferInfo:aa,QueueInfo:sa,QueryPoolInfo:ca,FormatInfo:la,MemoryStatus:ua,DynamicStencilStates:ha,DynamicStates:fa,GFXObject:_a,get AttributeName(){return uo},FormatInfos:pa,DESCRIPTOR_BUFFER_TYPE:da,DESCRIPTOR_SAMPLER_TYPE:ma,DESCRIPTOR_DYNAMIC_TYPE:va,DRAW_INFO_SIZE:ga,IsPowerOf2:ya,FormatSize:Sa,FormatSurfaceSize:xa,GetTypeSize:Ea,getTypedArrayConstructor:ba,Device:Ra,Swapchain:Ia,Framebuffer:Pa,InputAssembler:Na,DescriptorSetLayout:Ba,PipelineLayout:Fa,RasterizerState:za,DepthStencilState:Ua,BlendTarget:ka,BlendState:Ga,PipelineStateInfo:Ha,PipelineState:Va,Queue:ja,RenderPass:Wa,Sampler:qa,Shader:Xa,Texture:Ya,GlobalBarrier:Ka,TextureBarrier:Qa})),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(Ja||(Ja={}));var ns,is,rs,os,as,ss,cs,ls,us=(ns=new yi(0,0,0),function(e,t){var n=yi.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;yi.multiplyScalar(ns,t.n,t.d);var i=yi.dot(yi.subtract(ns,ns,e.o),t.n)/n;return i<0?0:i}),hs=(is=new yi(0,0,0),rs=new yi(0,0,0),os=new yi(0,0,0),as=new yi(0,0,0),ss=new yi(0,0,0),function(e,t,n){yi.subtract(is,t.b,t.a),yi.subtract(rs,t.c,t.a),yi.cross(os,e.d,rs);var i=yi.dot(is,os);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;yi.subtract(as,e.o,t.a);var o=yi.dot(as,os)*r;if(o<0||o>1)return 0;yi.cross(ss,as,is);var a=yi.dot(e.d,ss)*r;if(a<0||o+a>1)return 0;var s=yi.dot(rs,ss)*r;return s<0?0:s}),fs=function(){var e=new yi(0,0,0);return function(t,n){var i=n.radius,r=n.center,o=t.o,a=t.d,s=i*i;yi.subtract(e,r,o);var c=e.lengthSqr(),l=yi.dot(e,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),f=c<s?l+h:l-h;return f<0?0:f}}(),_s=(cs=new yi,ls=new yi,function(e,t){return yi.subtract(cs,t.center,t.halfExtents),yi.add(ls,t.center,t.halfExtents),ps(e,cs,ls)});function ps(e,t,n){var i=e.o,r=e.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(t.x-i.x)*o,l=(n.x-i.x)*o,u=(t.y-i.y)*a,h=(n.y-i.y)*a,f=(t.z-i.z)*s,_=(n.z-i.z)*s,p=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(f,_)),d=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(f,_));return d<0||p>d?0:p>0?p:d}var ds,ms,vs,gs,ys=function(){var e=new yi,t=new yi,n=new yi,i=new yi,r=new yi,o=new yi,a=new yi,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,f){s[0]=f.halfExtents.x,s[1]=f.halfExtents.y,s[2]=f.halfExtents.z,e=f.center,t=h.o,n=h.d,yi.set(i,f.orientation.m00,f.orientation.m01,f.orientation.m02),yi.set(r,f.orientation.m03,f.orientation.m04,f.orientation.m05),yi.set(o,f.orientation.m06,f.orientation.m07,f.orientation.m08),yi.subtract(a,e,t),c[0]=yi.dot(i,n),c[1]=yi.dot(r,n),c[2]=yi.dot(o,n),l[0]=yi.dot(i,a),l[1]=yi.dot(r,a),l[2]=yi.dot(o,a);for(var _=0;_<3;++_){if(0===c[_]){if(-l[_]-s[_]>0||-l[_]+s[_]<0)return 0;c[_]=1e-7}u[2*_+0]=(l[_]+s[_])/c[_],u[2*_+1]=(l[_]-s[_])/c[_]}var p=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),d=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return d<0||p>d?0:p>0?p:d}}(),Ss=function(){var e=new yi,t=new yi,n=new yi,i=new yi,r=new yi,o=new yi,a=new yi,s=new so;return function(c,l){var u=l.radius*l.radius,h=yi.normalize(e,c.d),f=l.ellipseCenter0,_=l.ellipseCenter1,p=yi.subtract(t,_,f);if(p.equals(yi.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),rc.raySphere(c,s);var d=c.o,m=yi.subtract(n,d,f),v=yi.cross(i,h,p),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=yi.subtract(r,_,d);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),rc.raySphere(c,s)}var S=yi.cross(r,m,p),x=p.lengthSqr(),T=2*yi.dot(v,S),E=T*T-4*g*(S.lengthSqr()-u*x);if(E<0)return 0;var b=(-T-Math.sqrt(E))/(2*g);if(b<0){s.radius=l.radius;var C=yi.subtract(o,_,d);return m.lengthSqr()<C.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),rc.raySphere(c,s)}var A=yi.scaleAndAdd(o,c.o,h,b),w=yi.subtract(a,A,f),R=yi.dot(w,p)/x;return R>=0&&R<=1?b:R<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),rc.raySphere(c,s)):R>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),rc.raySphere(c,s)):0}}(),xs=(ds=co.create(),ms={distance:1/0,doubleSided:!1,mode:Ja.ANY},vs=0,gs=function(e,t,n,i,r,o){e===Ja.CLOSEST?(vs>t||0===vs)&&(vs=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(vs=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(vs=0,0===t.geometricInfo.positions.length)return vs;var i=void 0===n?ms:n;if(ps(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,o=t.geometricInfo;!function(e,t,n,i,r){if(n===Qr.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var s=3*t[a],c=3*t[a+1],l=3*t[a+2];yi.set(ds.a,e[s],e[s+1],e[s+2]),yi.set(ds.b,e[c],e[c+1],e[c+2]),yi.set(ds.c,e[l],e[l+1],e[l+2]);var u=rc.rayTriangle(i,ds,r.doubleSided);if(!(0===u||u>r.distance)&&(gs(r.mode,u,s,c,l,r.result),r.mode===Ja.ANY))return u}else if(n===Qr.TRIANGLE_STRIP)for(var h=t.length-2,f=0,_=0;_<h;_+=1){var p=3*t[_-f],d=3*t[_+f+1],m=3*t[_+2];yi.set(ds.a,e[p],e[p+1],e[p+2]),yi.set(ds.b,e[d],e[d+1],e[d+2]),yi.set(ds.c,e[m],e[m+1],e[m+2]),f=~f;var v=rc.rayTriangle(i,ds,r.doubleSided);if(!(0===v||v>r.distance)&&(gs(r.mode,v,p,d,m,r.result),r.mode===Ja.ANY))return v}else if(n===Qr.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];yi.set(ds.a,e[y],e[y+1],e[y+2]);for(var S=1;S<g;S+=1){var x=3*t[S],T=3*t[S+1];yi.set(ds.b,e[x],e[x+1],e[x+2]),yi.set(ds.c,e[T],e[T+1],e[T+2]);var E=rc.rayTriangle(i,ds,r.doubleSided);if(!(0===E||E>r.distance)&&(gs(r.mode,E,y,x,T,r.result),r.mode===Ja.ANY))return E}}}(o.positions,o.indices,r,e,i)}return vs}),Ts=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Ja.ANY};return function(n,i,r){e=0;var o=void 0===r?t:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!ps(n,s,c))return e;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=xs(n,u,o);if(h)if(o.mode===Ja.CLOSEST)(0===e||e>h)&&(e=h,o.subIndices&&(o.subIndices[0]=l));else if(e=h,o.subIndices&&o.subIndices.push(l),o.mode===Ja.ANY)return h}return e&&o.mode===Ja.CLOSEST&&(o.result&&(o.result[0].distance=e,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),e}}(),Es=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Ja.ANY},n=new pr,i=new Ni;return function(r,o,a){e=0;var s=void 0===a?t:a,c=o.worldBounds;if(c&&!_s(r,c))return e;pr.copy(n,r),o.node&&(Ni.invert(i,o.node.getWorldMatrix(i)),yi.transformMat4(n.o,r.o,i),yi.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,f=xs(n,h,s);if(f)if(s.mode===Ja.CLOSEST)(0===e||e>f)&&(e=f,s.subIndices&&(s.subIndices[0]=u));else if(e=f,s.subIndices&&s.subIndices.push(u),s.mode===Ja.ANY)return f}return e&&s.mode===Ja.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),bs=function(){var e=new yi(0,0,0);return function(t,n){yi.subtract(e,t.e,t.s);var i=(n.d-yi.dot(t.s,n.n))/yi.dot(e,n.n);return i<0||i>1?0:i}}(),Cs=function(){var e=new yi(0,0,0),t=new yi(0,0,0),n=new yi(0,0,0),i=new yi(0,0,0),r=new yi(0,0,0),o=new yi(0,0,0);return function(a,s,c){yi.subtract(e,s.b,s.a),yi.subtract(t,s.c,s.a),yi.subtract(n,a.s,a.e),yi.cross(r,e,t);var l=yi.dot(n,r);if(l<=0)return 0;yi.subtract(i,a.s,s.a);var u=yi.dot(i,r);if(u<0||u>l)return 0;yi.cross(o,n,i);var h=yi.dot(t,o);if(h<0||h>l)return 0;var f=-yi.dot(e,o);if(f<0||h+f>l)return 0;if(c){var _=1/l,p=1-(h*=_)-(f*=_);yi.set(c,s.a.x*p+s.b.x*h+s.c.x*f,s.a.y*p+s.b.y*h+s.c.y*f,s.a.z*p+s.b.z*h+s.c.z*f)}return 1}}(),As=new pr;function ws(e,t){As.o.set(e.s),yi.subtract(As.d,e.e,e.s),As.d.normalize();var n=_s(As,t);return n<=e.length()?n:0}function Rs(e,t){As.o.set(e.s),yi.subtract(As.d,e.e,e.s),As.d.normalize();var n=ys(As,t);return n<=e.length()?n:0}function Is(e,t){As.o.set(e.s),yi.subtract(As.d,e.e,e.s),As.d.normalize();var n=fs(As,t);return n<=e.length()?n:0}var Ps,Os,Ds,Ms,Ns=(Ps=new yi,Os=new yi,Ds=new yi,Ms=new yi,function(e,t){return yi.subtract(Ps,e.center,e.halfExtents),yi.add(Os,e.center,e.halfExtents),yi.subtract(Ds,t.center,t.halfExtents),yi.add(Ms,t.center,t.halfExtents),Ps.x<=Ms.x&&Os.x>=Ds.x&&Ps.y<=Ms.y&&Os.y>=Ds.y&&Ps.z<=Ms.z&&Os.z>=Ds.z});function Ls(e,t,n,i,r,o){yi.set(o[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),yi.set(o[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),yi.set(o[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),yi.set(o[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),yi.set(o[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),yi.set(o[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),yi.set(o[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),yi.set(o[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function Bs(e,t){for(var n=yi.dot(t,e[0]),i=n,r=1;r<8;++r){var o=yi.dot(t,e[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Fs,zs,Us,ks=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new yi(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new yi(0,0,0),i[r]=new yi(0,0,0);var o=new yi,a=new yi;return function(t,r){yi.set(e[0],1,0,0),yi.set(e[1],0,1,0),yi.set(e[2],0,0,1),yi.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),yi.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),yi.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)yi.cross(e[6+3*s],e[s],e[3]),yi.cross(e[7+3*s],e[s],e[4]),yi.cross(e[7+3*s],e[s],e[5]);yi.subtract(o,t.center,t.halfExtents),yi.add(a,t.center,t.halfExtents),function(e,t,n){yi.set(n[0],e.x,t.y,t.z),yi.set(n[1],e.x,t.y,e.z),yi.set(n[2],e.x,e.y,t.z),yi.set(n[3],e.x,e.y,e.z),yi.set(n[4],t.x,t.y,t.z),yi.set(n[5],t.x,t.y,e.z),yi.set(n[6],t.x,e.y,t.z),yi.set(n[7],t.x,e.y,e.z)}(o,a,n),Ls(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=Bs(n,e[c]),u=Bs(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Gs=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=yi.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},Hs=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Gs(e,t.planes[n]))return 0;return 1},Vs=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new yi(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Gs(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)yi.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),js=(Fs=new yi(0,0,0),zs=new Ei,function(e,t){return yi.subtract(Fs,t,e.center),yi.transformMat3(Fs,Fs,Ei.transpose(zs,e.orientation)),n=Fs,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),Ws=(Us=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*Us(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Us(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Us(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=yi.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),qs=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Ws(e,t.planes[n]))return 0;return 1},Xs=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new yi(0,0,0);var o=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=Ws(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)yi.subtract(e[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=o(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=o(e[f],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(t=o(e[_],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),Ys=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new yi(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new yi(0,0,0),i[r]=new yi(0,0,0);return function(t,r){yi.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),yi.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),yi.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),yi.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),yi.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),yi.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)yi.cross(e[6+3*o],e[o],e[3]),yi.cross(e[7+3*o],e[o],e[4]),yi.cross(e[8+3*o],e[o],e[5]);Ls(t.center,t.halfExtents,e[0],e[1],e[2],n),Ls(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var s=Bs(n,e[a]),c=Bs(i,e[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),Ks=function(){for(var e=new so,t=new yi,n=new yi,i=new yi,r=new Array(8),o=0;o<8;o++)r[o]=new yi;for(var a=new Array(8),s=0;s<8;s++)a[s]=new yi;return function(o,s){if(0===yi.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),rc.sphereOBB(e,o);t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,Ls(o.center,o.halfExtents,t,n,i,r);var c=a,l=yi.copy(c[0],t),u=yi.copy(c[1],n),h=yi.copy(c[2],i);yi.subtract(c[3],s.center,o.center).normalize();var f=yi.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);f.normalize(),yi.cross(c[5],l,f),yi.cross(c[6],u,f),yi.cross(c[7],h,f);for(var _=0;_<8;++_){var p=Bs(r,c[_]),d=yi.dot(c[_],s.ellipseCenter0),m=yi.dot(c[_],s.ellipseCenter1),v=Math.max(d,m),g=Math.min(d,m)-s.radius,y=v+s.radius;if(g>p[1]||p[0]>y)return 0}return 1}}(),Qs=function(e,t){var n=yi.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},Zs=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Qs(e,t.planes[n]))return 0;return 1},Js=function(){var e=new yi(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=yi.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){yi.add(e,s,yi.multiplyScalar(e,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var f=i.planes[h];if(yi.dot(f.n,e)<f.d)return 0}}}return 1}}(),$s=function(e,t){var n=e.radius+t.radius;return yi.squaredDistance(e.center,t.center)<n*n},ec=function(){var e=new yi;return function(t,n){return lr(e,t.center,n),yi.squaredDistance(t.center,e)<t.radius*t.radius}}(),tc=function(){var e=new yi;return function(t,n){return ur(e,t.center,n),yi.squaredDistance(t.center,e)<t.radius*t.radius}}(),nc=function(){var e=new yi,t=new yi;return function(n,i){var r=n.radius+i.radius,o=r*r,a=yi.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return yi.squaredDistance(n.center,i.center)<o;yi.subtract(e,n.center,i.ellipseCenter0),yi.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=yi.dot(e,t)/a;return s<0?yi.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?yi.squaredDistance(n.center,i.ellipseCenter1)<o:(yi.scaleAndAdd(e,i.ellipseCenter0,t,s),yi.squaredDistance(n.center,e)<o)}}(),ic=function(){var e=new yi,t=new yi,n=new yi,i=new yi,r=new yi,o=new yi;return function(a,s){var c,l,u=yi.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=yi.subtract(t,s.ellipseCenter1,s.ellipseCenter0),f=yi.subtract(n,a.ellipseCenter0,s.ellipseCenter0),_=yi.dot(u,u),p=yi.dot(u,h),d=yi.dot(h,h),m=yi.dot(u,f),v=yi.dot(h,f),g=_*d-p*p,y=g,S=g;g<Kn?(c=0,y=1,l=v,S=d):(l=_*v-p*m,(c=p*v-d*m)<0?(c=0,l=v,S=d):c>y&&(c=y,l=v+p,S=d)),l<0?(l=0,-m<0?c=0:-m>_?c=y:(c=-m,y=_)):l>S&&(l=S,-m+p<0?c=0:-m+p>_?c=y:(c=-m+p,y=_));var x=Math.abs(c)<Kn?0:c/y,T=Math.abs(l)<Kn?0:l/S,E=i;E.set(f),E.add(yi.multiplyScalar(r,u,x)),E.subtract(yi.multiplyScalar(o,h,T));var b=a.radius+s.radius;return E.lengthSqr()<b*b}}(),rc={raySphere:fs,rayAABB:_s,rayOBB:ys,rayPlane:us,rayTriangle:hs,rayCapsule:Ss,raySubMesh:xs,rayMesh:Ts,rayModel:Es,lineSphere:Is,lineAABB:ws,lineOBB:Rs,linePlane:bs,lineTriangle:Cs,sphereWithSphere:$s,sphereAABB:ec,sphereOBB:tc,spherePlane:Qs,sphereFrustum:Zs,sphereFrustumAccurate:Js,sphereCapsule:nc,aabbWithAABB:Ns,aabbWithOBB:ks,aabbPlane:Gs,aabbFrustum:Hs,aabbFrustumAccurate:Vs,obbWithOBB:Ys,obbPlane:Ws,obbFrustum:qs,obbFrustumAccurate:Xs,obbPoint:js,obbCapsule:Ks,capsuleWithCapsule:ic,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,r=t._type,o=this[i|r];return i<r?o(e,t,n):o(t,e,n)}};rc[fr.SHAPE_RAY|fr.SHAPE_SPHERE]=fs,rc[fr.SHAPE_RAY|fr.SHAPE_AABB]=_s,rc[fr.SHAPE_RAY|fr.SHAPE_OBB]=ys,rc[fr.SHAPE_RAY|fr.SHAPE_PLANE]=us,rc[fr.SHAPE_RAY|fr.SHAPE_TRIANGLE]=hs,rc[fr.SHAPE_RAY|fr.SHAPE_CAPSULE]=Ss,rc[fr.SHAPE_LINE|fr.SHAPE_SPHERE]=Is,rc[fr.SHAPE_LINE|fr.SHAPE_AABB]=ws,rc[fr.SHAPE_LINE|fr.SHAPE_OBB]=Rs,rc[fr.SHAPE_LINE|fr.SHAPE_PLANE]=bs,rc[fr.SHAPE_LINE|fr.SHAPE_TRIANGLE]=Cs,rc[fr.SHAPE_SPHERE]=$s,rc[fr.SHAPE_SPHERE|fr.SHAPE_AABB]=ec,rc[fr.SHAPE_SPHERE|fr.SHAPE_OBB]=tc,rc[fr.SHAPE_SPHERE|fr.SHAPE_PLANE]=Qs,rc[fr.SHAPE_SPHERE|fr.SHAPE_FRUSTUM]=Zs,rc[fr.SHAPE_SPHERE|fr.SHAPE_FRUSTUM_ACCURATE]=Js,rc[fr.SHAPE_SPHERE|fr.SHAPE_CAPSULE]=nc,rc[fr.SHAPE_AABB]=Ns,rc[fr.SHAPE_AABB|fr.SHAPE_OBB]=ks,rc[fr.SHAPE_AABB|fr.SHAPE_PLANE]=Gs,rc[fr.SHAPE_AABB|fr.SHAPE_FRUSTUM]=Hs,rc[fr.SHAPE_AABB|fr.SHAPE_FRUSTUM_ACCURATE]=Vs,rc[fr.SHAPE_OBB]=Ys,rc[fr.SHAPE_OBB|fr.SHAPE_PLANE]=Ws,rc[fr.SHAPE_OBB|fr.SHAPE_FRUSTUM]=qs,rc[fr.SHAPE_OBB|fr.SHAPE_FRUSTUM_ACCURATE]=Xs,rc[fr.SHAPE_OBB|fr.SHAPE_CAPSULE]=Ks,rc[fr.SHAPE_CAPSULE]=ic,zn(_r.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),Un(rc,"intersect",[{name:"line_quad"}]);var oc,ac,sc,cc,lc,uc,hc,fc=new yi(0,0,0),_c=new yi(0,0,0),pc=i.mat4(),dc=i.v4(),mc=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=fr.SHAPE_PLANE,this.n=new yi(e,t,n),this.d=i}return e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return yi.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return yi.subtract(fc,n,t),yi.subtract(_c,i,t),yi.normalize(e.n,yi.cross(e.n,fc,_c)),e.d=yi.dot(e.n,t),e},e.set=function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e},e.fromNormalAndPoint=function(e,t,n){return yi.copy(e.n,t),e.d=yi.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return yi.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){Ni.invert(pc,e),Ni.transpose(pc,pc),Hi.set(dc,this.n.x,this.n.y,this.n.z,this.d),Hi.transformMat4(dc,dc,pc),yi.set(this.n,dc.x,dc.y,dc.z),this.d=dc.w},L(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),vc=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(hc||(hc={}));var gc,yc,Sc=function(){function e(e,t,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new vc(e,r,this._stride);var o=hc.NEVER,a=!1,s=!1;for(var c in t){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=t[c],a||o!==hc.FLOAT32?s||o!==hc.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag},t.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]},t.getTypedArray=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,o=(this._dataType[t]===hc.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[t];return o.subarray(r,r+a)},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)},e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(gc||(gc={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(yc||(yc={}));var xc,Tc=((oc={})[yc.DIRTY_FLAG]=hc.UINT32,oc[yc.LAYER]=hc.UINT32,oc[yc.WORLD_SCALE]=hc.FLOAT32,oc[yc.WORLD_POSITION]=hc.FLOAT32,oc[yc.WORLD_ROTATION]=hc.FLOAT32,oc[yc.WORLD_MATRIX]=hc.FLOAT32,oc[yc.LOCAL_SCALE]=hc.FLOAT32,oc[yc.LOCAL_POSITION]=hc.FLOAT32,oc[yc.LOCAL_ROTATION]=hc.FLOAT32,oc[yc.COUNT]=hc.NEVER,oc),Ec=((ac={})[yc.DIRTY_FLAG]=yc.LAYER-yc.DIRTY_FLAG,ac[yc.LAYER]=yc.WORLD_SCALE-yc.LAYER,ac[yc.WORLD_SCALE]=yc.WORLD_POSITION-yc.WORLD_SCALE,ac[yc.WORLD_POSITION]=yc.WORLD_ROTATION-yc.WORLD_POSITION,ac[yc.WORLD_ROTATION]=yc.WORLD_MATRIX-yc.WORLD_ROTATION,ac[yc.WORLD_MATRIX]=yc.LOCAL_SCALE-yc.WORLD_MATRIX,ac[yc.LOCAL_SCALE]=yc.LOCAL_POSITION-yc.LOCAL_SCALE,ac[yc.LOCAL_POSITION]=yc.LOCAL_ROTATION-yc.LOCAL_POSITION,ac[yc.LOCAL_ROTATION]=yc.COUNT-yc.LOCAL_ROTATION,ac[yc.COUNT]=1,ac),bc=new Sc(gc.NODE,Tc,Ec,yc);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(xc||(xc={}));var Cc,Ac=((sc={})[xc.PRIORITY]=hc.UINT32,sc[xc.STAGE]=hc.UINT32,sc[xc.PHASE]=hc.UINT32,sc[xc.PRIMITIVE]=hc.UINT32,sc[xc.BATCHING_SCHEME]=hc.UINT32,sc[xc.DYNAMIC_STATE]=hc.UINT32,sc[xc.HASH]=hc.UINT32,sc[xc.COUNT]=hc.NEVER,sc),wc=((cc={})[xc.PRIORITY]=xc.STAGE-xc.PRIORITY,cc[xc.STAGE]=xc.PHASE-xc.STAGE,cc[xc.PHASE]=xc.PRIMITIVE-xc.PHASE,cc[xc.PRIMITIVE]=xc.BATCHING_SCHEME-xc.PRIMITIVE,cc[xc.BATCHING_SCHEME]=xc.DYNAMIC_STATE-xc.BATCHING_SCHEME,cc[xc.DYNAMIC_STATE]=xc.HASH-xc.DYNAMIC_STATE,cc[xc.HASH]=xc.COUNT-xc.HASH,cc[xc.COUNT]=1,cc),Rc=new Sc(gc.PASS,Ac,wc,xc);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(Cc||(Cc={}));var Ic=((lc={})[Cc.CENTER]=hc.FLOAT32,lc[Cc.HALFEXTENTS]=hc.FLOAT32,lc[Cc.COUNT]=hc.NEVER,lc),Pc=((uc={})[Cc.CENTER]=Cc.HALFEXTENTS-Cc.CENTER,uc[Cc.HALFEXTENTS]=Cc.COUNT-Cc.HALFEXTENTS,uc[Cc.COUNT]=1,uc),Oc=new Sc(gc.AABB,Ic,Pc,Cc),Dc=new yi,Mc=new yi,Nc=new yi,Lc=new yi,Bc=new Ei,Fc=function(e,t,n){Bc.m00=Math.abs(n.m00),Bc.m01=Math.abs(n.m01),Bc.m02=Math.abs(n.m02),Bc.m03=Math.abs(n.m04),Bc.m04=Math.abs(n.m05),Bc.m05=Math.abs(n.m06),Bc.m06=Math.abs(n.m08),Bc.m07=Math.abs(n.m09),Bc.m08=Math.abs(n.m10),yi.transformMat3(e,t,Bc)},zc=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=fr.SHAPE_AABB,this.center=new yi(e,t,n),this.halfExtents=new yi(i,r,o)}e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return yi.copy(e.center,t.center),yi.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return yi.add(Dc,n,t),yi.subtract(Mc,n,t),yi.multiplyScalar(e.center,Dc,.5),yi.multiplyScalar(e.halfExtents,Mc,.5),e},e.set=function(e,t,n,i,r,o,a){return e.center.set(t,n,i),e.halfExtents.set(r,o,a),e},e.merge=function(t,n,i){return yi.subtract(Dc,n.center,n.halfExtents),yi.subtract(Mc,i.center,i.halfExtents),yi.add(Nc,n.center,n.halfExtents),yi.add(Lc,i.center,i.halfExtents),yi.max(Lc,Nc,Lc),yi.min(Nc,Dc,Mc),e.fromPoints(t,Nc,Lc)},e.toBoundingSphere=function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e},e.transform=function(e,t,n){return yi.transformMat4(e.center,t.center,n),Fc(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){yi.subtract(e,this.center,this.halfExtents),yi.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,r){yi.transformMat4(r.center,this.center,e),Fc(r.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.mergePoint=function(e){this.getBoundary(Dc,Mc),e.x<Dc.x&&(Dc.x=e.x),e.y<Dc.y&&(Dc.y=e.y),e.z<Dc.z&&(Dc.z=e.z),e.x>Mc.x&&(Mc.x=e.x),e.y>Mc.y&&(Mc.y=e.y),e.z>Mc.z&&(Mc.z=e.z),yi.add(Nc,Dc,Mc),this.center.set(yi.multiplyScalar(Nc,Nc,.5)),this.halfExtents.set(Mc.x-Nc.x,Mc.y-Nc.y,Mc.z-Nc.z)},t.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},t.mergeFrustum=function(e){return this.mergePoints(e.vertices)},L(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Uc=new yi,kc=new yi,Gc=new Ei,Hc=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===_&&(_=0),void 0===p&&(p=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=fr.SHAPE_OBB,this.center=new yi(e,t,n),this.halfExtents=new yi(i,r,o),this.orientation=new Ei(a,s,c,l,u,h,f,_,p)}e.create=function(t,n,i,r,o,a,s,c,l,u,h,f,_,p,d){return new e(t,n,i,r,o,a,s,c,l,u,h,f,_,p,d)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return yi.copy(e.center,t.center),yi.copy(e.halfExtents,t.halfExtents),Ei.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return yi.multiplyScalar(e.center,yi.add(Uc,t,n),.5),yi.multiplyScalar(e.halfExtents,yi.subtract(kc,n,t),.5),Ei.identity(e.orientation),e},e.set=function(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d){return yi.set(e.center,t,n,i),yi.set(e.halfExtents,r,o,a),Ei.set(e.orientation,s,c,l,u,h,f,_,p,d),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){Gc.m00=Math.abs(n.m00),Gc.m01=Math.abs(n.m01),Gc.m02=Math.abs(n.m02),Gc.m03=Math.abs(n.m03),Gc.m04=Math.abs(n.m04),Gc.m05=Math.abs(n.m05),Gc.m06=Math.abs(n.m06),Gc.m07=Math.abs(n.m07),Gc.m08=Math.abs(n.m08),yi.transformMat3(e,t,Gc)}(Uc,this.halfExtents,this.orientation),yi.subtract(e,this.center,Uc),yi.add(t,this.center,Uc)},t.transform=function(e,t,n,i,r){yi.transformMat4(r.center,this.center,e),Ei.fromQuat(r.orientation,n),yi.multiply(r.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){yi.transformMat4(n.center,this.center,e),Ei.fromQuat(n.orientation,t)},t.setScale=function(e,t){yi.multiply(t.halfExtents,this.halfExtents,e)},L(e,[{key:"type",get:function(){return this._type}}]),e}(),Vc=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=fr.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new yi,this.rotation=new Ai,this.ellipseCenter0=new yi(0,t,0),this.ellipseCenter1=new yi(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,r){var o=i,a=_i(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,yi.transformMat4(r.center,this.center,e),Ai.multiply(r.rotation,this.rotation,n),r.updateCache()},t.updateCache=function(){this.updateLocalCenter(),yi.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),yi.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},L(e,[{key:"type",get:function(){return this._type}}]),e}(),jc=new Array(8);jc[0]=new yi(1,1,1),jc[1]=new yi(-1,1,1),jc[2]=new yi(-1,-1,1),jc[3]=new yi(1,-1,1),jc[4]=new yi(1,1,-1),jc[5]=new yi(-1,1,-1),jc[6]=new yi(-1,-1,-1),jc[7]=new yi(1,-1,-1);var Wc,qc,Xc=new yi,Yc=new yi,Kc=new yi,Qc=function(){function e(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=fr.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=mc.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new yi}e.createFromAABB=function(e,t){var n=new yi,i=new yi;return yi.subtract(n,t.center,t.halfExtents),yi.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==fr.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e},e.split=function(e,t,n,i,r){var o=Math.tan(.5*t.fov),a=o*t.aspect;Xc.set(i*a,i*o,i),Yc.set(r*a,r*o,r);var s=e.vertices;return Kc.set(Xc.x,Xc.y,Xc.z),yi.transformMat4(s[0],Kc,n),Kc.set(-Xc.x,Xc.y,Xc.z),yi.transformMat4(s[1],Kc,n),Kc.set(-Xc.x,-Xc.y,Xc.z),yi.transformMat4(s[2],Kc,n),Kc.set(Xc.x,-Xc.y,Xc.z),yi.transformMat4(s[3],Kc,n),Kc.set(Yc.x,Yc.y,Yc.z),yi.transformMat4(s[4],Kc,n),Kc.set(-Yc.x,Yc.y,Yc.z),yi.transformMat4(s[5],Kc,n),Kc.set(-Yc.x,-Yc.y,Yc.z),yi.transformMat4(s[6],Kc,n),Kc.set(Yc.x,-Yc.y,Yc.z),yi.transformMat4(s[7],Kc,n),e.updatePlanes(),e},e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)mc.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)yi.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(yi.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),yi.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),yi.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),yi.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),yi.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),yi.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===fr.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();yi.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)yi.transformMat4(this.vertices[o],jc[o],t)}},t.transform=function(e){if(this._type===fr.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)yi.transformMat4(this.vertices[t],this.vertices[t],e);mc.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),mc.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),mc.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),mc.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),mc.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),mc.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},t.updatePlanes=function(){mc.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),mc.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),mc.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),mc.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),mc.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),mc.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},L(e,[{key:"accurate",set:function(e){this._type=e?fr.SHAPE_FRUSTUM_ACCURATE:fr.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();Qc.createOrtho=function(e,t,n,i,r,o){var a=t/2,s=n/2;yi.set(Kc,a,s,-i),yi.transformMat4(e.vertices[0],Kc,o),yi.set(Kc,-a,s,-i),yi.transformMat4(e.vertices[1],Kc,o),yi.set(Kc,-a,-s,-i),yi.transformMat4(e.vertices[2],Kc,o),yi.set(Kc,a,-s,-i),yi.transformMat4(e.vertices[3],Kc,o),yi.set(Kc,a,s,-r),yi.transformMat4(e.vertices[4],Kc,o),yi.set(Kc,-a,s,-r),yi.transformMat4(e.vertices[5],Kc,o),yi.set(Kc,-a,-s,-r),yi.transformMat4(e.vertices[6],Kc,o),yi.set(Kc,a,-s,-r),yi.transformMat4(e.vertices[7],Kc,o),mc.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),mc.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),mc.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),mc.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),mc.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),mc.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(Wc||(Wc={})),function(e){e[e.Default=Wc.Default]="Default",e[e.Normal=Wc.Normal]="Normal",e[e.Reverse=Wc.Reverse]="Reverse",e[e.Loop=Wc.Loop]="Loop",e[e.LoopReverse=Wc.Loop|Wc.Reverse]="LoopReverse",e[e.PingPong=Wc.PingPong]="PingPong",e[e.PingPongReverse=Wc.PingPong|Wc.Reverse]="PingPongReverse"}(qc||(qc={})),$e(qc);var Zc=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}();function Jc(e,t,n){void 0===n&&(n=1e-6);for(var i=0,r=e.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=e[o];if(a>t+n)r=o-1;else{if(!(a<t-n))return o;i=o+1}}return~i}var $c=function(){},el=function(){return $c},tl=nl((function(){}));function nl(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function il(e){return function(t){return function(n){!function(e,t,n){var i=ol(e);if(i){var r=al(i,"proto");al(r,"editor")[t]=n}}(n,e,t)}}}var rl="__ccclassCache__";function ol(e){return al(e,rl)}function al(e,t){return e[t]||(e[t]={})}var sl=nl((function(e,t){var n=He.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[rl];if(r){var o=r.proto;o&&He.mixin(i,o),e[rl]=void 0}return Vt(i)})),cl=il("requireComponent"),ll=il("executionOrder"),ul=tl;function hl(e,t,n){var i=null;function r(e,t,n){var r=ol(e.constructor);if(r){var o=al(r,"proto"),a=al(o,"properties");!function(e,t,n,i,r,o){var a,s=r&&(r.get||r.set);i&&(a=Mt(i,s));var c=t[n],l=He.mixin(c||{},a||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(r.initializer));else{var u=o.default||(o.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(n)&&(l.default=u[n])}t[n]=l}(e.constructor,a,t,i,n,r)}}return void 0===e?hl({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}var fl=Symbol("cc:SerializationMetadata"),_l=function(e,t,n){return hl(ml({}))(e,t,n)};function pl(e){return hl(ml({formerlySerializedAs:e}))}var dl=function(e,t,n){return hl({editorOnly:!0})(e,t,n)};function ml(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}var vl=$c,gl=tl,yl=el,Sl=tl,xl=el,Tl=el,El=el,bl=$c,Cl=el,Al=$c,wl=el,Rl=el,Il=el,Pl=el,Ol=el,Dl=el,Ml=$c,Nl=el,Ll=$c,Bl=$c,Fl=$c,zl=Hl(Et),Ul=Hl(bt),kl=Hl(Ct),Gl=Hl(At);function Hl(e){return hl({type:e})}var Vl,jl,Wl,ql,Xl,Yl,Kl,Ql,Zl,Jl=function(e,t,n){return hl({__noImplicit:!0,override:!0})(e,t,n)},$l=sl("cc.KeyframeCurve")((Vl=Symbol.iterator,Yl=function(){function e(){q(this,"_times",ql,this),q(this,"_values",Xl,this)}var t=e.prototype;return t[Vl]=function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}},t.keyframes=function(){return this},t.times=function(){return this._times},t.values=function(){return this._values},t.getKeyframeTime=function(e){return this._times[e]},t.getKeyframeValue=function(e){return this._values[e]},t.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},t.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},t.indexOfKeyframe=function(e){return Jc(this._times,e)},t.updateTime=function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)},t.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return e[1]})))}},t.clear=function(){this._times.length=0,this._values.length=0},t.searchKeyframe=function(e){return Jc(this._times,e)},t.setKeyframes=function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||Zn(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t},t._insertNewKeyframe=function(e,t){var n=this._times,i=this._values,r=n.length,o=Jc(n,e);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(e),i.unshift(t)):a===r?(n.push(e),i.push(t)):(n.splice(a-1,0,e),i.splice(a-1,0,t)),a},L(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),e}(),ql=X((Wl=Yl).prototype,"_times",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xl=X(Wl.prototype,"_values",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jl=Wl))||jl;function eu(e){return e>-1e-9&&e<1e-9}!function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(Kl||(Kl=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(Ql||(Ql=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(Zl||(Zl=e("TangentWeightMode",{})));var tu=function(){},nu=Object.freeze({__proto__:null,uniquelyReferenced:vl,ccclass:sl,property:hl,requireComponent:cl,executionOrder:ll,disallowMultiple:ul,allowReplicated:function(e){Vt.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:gl,menu:yl,playOnFocus:Sl,inspector:xl,icon:Tl,help:El,type:Hl,integer:zl,float:Ul,boolean:kl,string:Gl});e("_decorator",nu);var iu=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=He.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=He.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},L(e,[{key:"count",get:function(){return this._count}}]),e}(),ru=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(b(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();ru._pipelineId=0,function(){function e(e){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(e)for(var t in e)this._weakMap[t]=new WeakRef(e[t])}var t=e.prototype;t.add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},t.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},t.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},t.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},t.clear=function(){this._weakMap=He.createMap(!0)},t.forEach=function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}},t.find=function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null},t.destroy=function(){this._weakMap={}},L(e,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}}])}();var ou,au=new iu,su=new iu,cu=new iu,lu=new iu,uu=new ru("normal load",[]),hu=new ru("fetch",[]),fu=new ru("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(ou||(ou={}));var _u,pu={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(_u||(_u={}));var du=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var o="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[o]&&this[o](t,n,i,r)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();du.MAX_DEAD_NUM=500,du._taskId=0,du._deadPool=[];var mu="0123456789abcdef".split(""),vu=["","","",""],gu=vu.concat(vu,"-",vu,"-",vu,"-",vu,"-",vu,vu,vu),yu=gu.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function Su(e){var t=e.split("@")[0];if(22!==t.length)return e;gu[0]=e[0],gu[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=at[e.charCodeAt(n)],o=at[e.charCodeAt(n+1)];gu[yu[i++]]=mu[r>>2],gu[yu[i++]]=mu[(3&r)<<2|o>>4],gu[yu[i++]]=mu[15&o]}return e.replace(t,gu.join(""))}var xu=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function Tu(e){var t=xu.exec(e);return t?t[1]:""}function Eu(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.ext=t.nativeExt;var n=lu.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),Au(e,t)}function bu(e){return!!e&&(e instanceof i.SceneAsset||e instanceof i.Scene)}function Cu(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function Au(e,t){var n=du.create({input:e,options:t}),i=[];try{for(var r,o=W(fu.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(e){for(var c,l=W(n.output);!(c=l()).done;)c.value.recycle();d(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var wu,Ru,Iu,Pu,Ou,Du,Mu,Nu,Lu=Object.freeze({__proto__:null,getUuidFromURL:Tu,getUrlWithUuid:Eu,isScene:bu,normalize:Cu,transform:Au,decodeUuid:Su}),Bu=new(function(){function e(){this._finalizationRegistry=null}var t=e.prototype;return t.registerGCObject=function(e){return e},t.unregisterGCObject=function(){},t.init=function(){},t.finalizationRegistryCallback=function(e){e.isValid&&e.destroy()},t.destroy=function(){},e}()),Fu=sl("cc.GCObject")(wu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return t=e.call.apply(e,[this].concat(i))||this,Bu.registerGCObject(V(t))||V(t)}F(t,e);var n=t.prototype;return n.equals=function(e){return!!e&&e===this},n.destroy=function(){return Bu.unregisterGCObject(this),e.prototype.destroy.call(this)},t}(Qt))||wu,zu=e("Asset",sl("cc.Asset")((Ou=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,q(t,"_native",Pu,V(t)),t._nativeUrl="",t._file=null,t._ref=0,Object.defineProperty(V(t),"_uuid",{value:"",writable:!0}),t}F(t,e),t.deserialize=function(e){return i.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&i.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return v(P(12101,this._uuid)),e.prototype.destroy.call(this)},L(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=Eu(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=Eu(this._uuid,{__nativeName__:e,nativeExt:Sn(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}(sn(Fu)),Pu=X((Iu=Ou).prototype,"_native",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),X(Iu.prototype,"_nativeAsset",[hl],Object.getOwnPropertyDescriptor(Iu.prototype,"_nativeAsset"),Iu.prototype),Ru=Iu))||Ru);zu.prototype.createNode=null,i.Asset=zu;var Uu=e("Script",sl("cc.Script")(Du=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t}(zu))||Du);i._Script=Uu;var ku=e("JavaScript",sl("cc.JavaScript")(Mu=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t}(Uu))||Mu);i._JavaScript=ku;var Gu,Hu,Vu,ju,Wu,qu,Xu,Yu,Ku,Qu,Zu,Ju=e("TypeScript",sl("cc.TypeScript")(Nu=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t}(Uu))||Nu);i._TypeScript=Ju;var $u,eh,th,nh,ih=new te("Comp"),rh=Qt.Flags.IsOnLoadCalled,oh=e("Component",(Gu=sl("cc.Component"),Hu=wl(),Vu=Hl(Uu),ju=Rl(),Gu((Zu=Qu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"node",Xu,V(t)),q(t,"_enabled",Yu,V(t)),q(t,"__prefab",Ku,V(t)),t._sceneGetter=null,t._id=ih.getNewId(),t}F(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&i.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),i.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=i.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,r){void 0===t&&(t=0),void 0===n&&(n=i.macro.REPEAT_FOREVER),void 0===r&&(r=0),I(e,1619),I((t=t||0)>=0,1620),n=Number.isNaN(n)?i.macro.REPEAT_FOREVER:n,r=r||0;var o=i.director.getScheduler(),a=o.isTargetPaused(this);o.schedule(e,this,t,n,r,a)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&i.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){i.director.getScheduler().unscheduleAllForTarget(this)},L(t,[{key:"name",get:function(){if(this._name)return this._name;var e=pe(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?this.node.name+"<"+e+">":e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=i.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&rh}}]),t}(Qt),Qu.system=null,X((qu=Zu).prototype,"__scriptAsset",[Hu,Vu,ju,Fl],Object.getOwnPropertyDescriptor(qu.prototype,"__scriptAsset"),qu.prototype),Xu=X(qu.prototype,"node",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yu=X(qu.prototype,"_enabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ku=X(qu.prototype,"__prefab",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wu=qu))||Wu)),ah=oh.prototype;ah.update=null,ah.lateUpdate=null,ah.__preload=null,ah.onLoad=null,ah.start=null,ah.onEnable=null,ah.onDisable=null,ah.onDestroy=null,ah.onFocusInEditor=null,ah.onLostFocusInEditor=null,ah.resetInEditor=null,ah._getLocalBounds=null,ah.onRestore=null,oh._requireComponent=null,oh._executionOrder=0,le(oh,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),i.Component=oh;var sh,ch=e("MissingScript",sl("cc.MissingScript")($u=xl()((nh=function(e){function t(){var t;return q(t=e.call(this)||this,"_$erialized",th,V(t)),t}return F(t,e),t.safeFindClass=function(e){var t=Fe(e);if(t)return t;i.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){b(4600,this.node.name)},t}(oh),th=X((eh=nh).prototype,"_$erialized",[_l,dl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$u=eh))||$u)||$u);i._MissingScript=ch;try{var lh=ch.__values__;0!==lh.length&&"_$erialized"===lh[lh.length-1]||(d("The '_$erialized' prop in MissingScript is missing. Please contact jare."),d("    Error props: ['"+lh+"']"))}catch(sr){d("Error when checking MissingScript 5, "+sr)}!function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(sh||(sh={}));var uh,hh={auto:sh.AUTO,landscape:sh.LANDSCAPE,portrait:sh.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(uh||(uh={}));var fh=new(function(e){function t(){var t,n,i,r,o,a;(t=e.call(this)||this).isFrameRotated=!1,t.handleResizeEvent=!0,t._gameFrame=void 0,t._gameContainer=void 0,t._gameCanvas=void 0,t._isProportionalToFrame=!1,t._cachedFrameStyle={width:"0px",height:"0px"},t._cachedContainerStyle={width:"0px",height:"0px"},t._cbToUpdateFrameBuffer=void 0,t._supportFullScreen=!1,t._touchEventName=void 0,t._onFullscreenChange=void 0,t._onFullscreenError=void 0,t._orientationChangeTimeoutId=-1,t._cachedFrameSize=new Wi(0,0),t._exactFitScreen=!1,t._fn={},t._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],t._resolutionScale=1,t._orientation=sh.AUTO,t._gameFrame=document.getElementById("GameDiv"),t._gameContainer=document.getElementById("Cocos3dGameContainer"),t._gameCanvas=document.getElementById("GameCanvas"),t._gameFrame||(t._gameFrame=document.createElement("div"),t._gameFrame.setAttribute("id","GameDiv"),null===(n=t._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(t._gameFrame,t._gameCanvas),t._gameFrame.appendChild(t._gameCanvas)),t._gameContainer||(t._gameContainer=document.createElement("div"),t._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=t._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(t._gameContainer,t._gameCanvas),t._gameContainer.appendChild(t._gameCanvas));for(var s=t._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)t._fn[s[0][l]]=a[l];break}return t._supportFullScreen=void 0!==t._fn.requestFullscreen,t._touchEventName="ontouchstart"in window?"touchend":"mousedown",t._registerEvent(),t}F(t,e);var n=t.prototype;return n.init=function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=hh[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var e=this;return new Promise((function(t,n){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var i=e._getFullscreenTarget();i?i.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(n):(e.windowSize=e._cachedFrameSize,t())}))},n._registerEvent=function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){e.emit("window-resize"),t()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change"),e._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(e){var t=e.clone(),n=this.devicePixelRatio;return t.width/=n,t.height/=n,t},n._resizeFrame=function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===uh.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width=e.width+"px",this._gameFrame.style.height=e.height+"px"}else{var t=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+t+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=t+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=t+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var e=this._windowType;return e===uh.Fullscreen?document[this._fn.fullscreenElement]:e===uh.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var e=this;return new Promise((function(t,n){if(e._supportFullScreen){var i=e._getFullscreenTarget();if(i){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=i[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=dn.isMobile&&(t&&e===sh.PORTRAIT||!t&&e===sh.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void b(9201);var e,t,n=i.view.getDesignResolutionSize(),r=this._gameFrame,o=r.clientWidth,a=r.clientHeight,s=n.width,c=n.height,l=o/s,u=a/c,h=this._gameContainer.style;l<u?(e=o,t=c*l):(e=s*u,t=a),h.width=e+"px",h.height=t+"px"}else{var f=this._gameContainer.style;f.width="100%",f.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else b(9201)},L(t,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){return window.devicePixelRatio||1}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===uh.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):b(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new Wi(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new Wi(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(b(9201),new Wi(0,0));var e,t,n;switch(this._windowType){case uh.SubFrame:return this._gameFrame?new Wi(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(b(9201),new Wi(0,0));case uh.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,n=this.isFrameRotated?e.clientWidth:e.clientHeight,new Wi(t,n);case uh.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new Wi(t,n);case uh.Unknown:default:return new Wi(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?uh.Fullscreen:this._gameFrame?this._exactFitScreen?uh.BrowserWindow:uh.SubFrame:(b(9201),uh.Unknown)}}]),t}(pn)),_h=function(){function e(){}var t=e.prototype;return t._init=function(e){fh.init(e,(function(){var e,t=i.director;(null===(e=t.root)||void 0===e?void 0:e.pipeline)?t.root.pipeline.pipelineSceneData.shadingScale=fh.resolutionScale:b(1220)}))},t.fullScreen=function(){return fh.isFullScreen},t.requestFullScreen=function(e,t,n){return arguments.length>0&&b(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),fh.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))},t.exitFullScreen=function(){return fh.exitFullScreen()},t.autoFullScreen=function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))},t.disableAutoFullScreen=function(){},L(e,[{key:"windowSize",get:function(){return fh.windowSize},set:function(e){fh.windowSize=e}},{key:"resolution",get:function(){return fh.resolution}},{key:"supportsFullScreen",get:function(){return fh.supportFullScreen}}]),e}(),ph=e("screen",new _h);i.screen=ph;var dh=e("sys",{Feature:_n,hasFeature:function(e){return dn.hasFeature(e)},NetworkType:un,Language:ln,OS:hn,Platform:fn,BrowserType:cn,isNative:dn.isNative,isBrowser:dn.isBrowser,isMobile:dn.isMobile,isLittleEndian:dn.isLittleEndian,platform:dn.platform,language:dn.language,languageCode:dn.nativeLanguage,os:dn.os,osVersion:dn.osVersion,osMainVersion:dn.osMainVersion,browserType:dn.browserType,browserVersion:dn.browserVersion,windowPixelResolution:ph.windowSize,capabilities:{canvas:!0,opengl:!0,webp:dn.hasFeature(_n.WEBP),imageBitmap:dn.hasFeature(_n.IMAGE_BITMAP),touches:dn.hasFeature(_n.INPUT_TOUCH),mouse:dn.hasFeature(_n.EVENT_MOUSE),keyboard:dn.hasFeature(_n.EVENT_KEYBOARD),accelerometer:dn.hasFeature(_n.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return dn.networkType},getBatteryLevel:function(){return dn.getBatteryLevel()},garbageCollect:function(){dn.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",_(e+="Using "+(i.game.renderType===i.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){dn.openURL(e)},now:function(){return dn.now()},restartVM:function(){dn.restartJSVM()},getSafeAreaRect:function(){var e=i.view,t=fh.safeAreaEdge,n=fh.windowSize,r=new zi(t.left,t.bottom),o=new zi(n.width-t.right,n.height-t.top);e._convertToUISpace(r),e._convertToUISpace(o);var a=r.x,s=r.y,c=o.x-r.x,l=o.y-r.y;return new Xi(a,s,c,l)}});!function(){try{var e=dh.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){b(5200)};dh.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}dh.__isWebIOS14OrIPadOS14Env=(dh.os===hn.IOS||dh.os===hn.OSX)&&dn.isBrowser&&/(OS 1[4-9])|(Version\/1[4-9])/.test(window.navigator.userAgent)}(),i.sys=dh;var mh=e("serializeTag",Symbol("[[Serialize]]")),vh=e("deserializeTag",Symbol("[[Deserialize]]")),gh=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return L(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function yh(e){var t=e;return{chunks:t.chunks,document:t.document}}function Sh(e){if(e.length<16)throw new xh(P(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new xh(P(13100));var n=t.getUint32(4,!0);if(1!==n)throw new xh(P(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new xh(P(13102));var i=12,r=t.getUint32(i,!0);i+=4;var o=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var a,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(P(13104))}(o);try{a=JSON.parse(s)}catch(e){throw new xh(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new xh(P(13102));return new gh(a,c)}var xh=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t}(H(Error));function Th(e,t,n,r,o){if(t instanceof i.ValueType){o||e.push("if(prop){");var a=pe(t);e.push("s._deserializeFastDefinedObject(o"+n+",prop,"+a+");"),o||e.push("}else o"+n+"=null;")}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+r+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e},L(e,[{key:"byteLength",get:function(){return this._length}}])}(),i.internal.parseCCONJson=yh,i.internal.decodeCCONBinary=Sh,i.internal.CCON=gh;var Eh="$_$default",bh="$_$formerlySerializedAs",Ch=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return F(t,e),t.prototype.get=function(e,t,n,i,r){var o=this._get();return o?(o.reset(e,t,n,i,r),o):new Ah(e,t,n,i,r)},t}(ke),Ah=function(){function e(e,t,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,n=!1;e instanceof gh?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)},t._deserializeArray=function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"==typeof(t=e[i])&&t?this._deserializeAndAssignField(n,t,""+i)&&(n[i]=null):n[i]=t;return n},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,n,i){var r=this,o=e.__type__,a=this._classFinder(o,e,n,i);if(!a)return this._classFinder===Fe&&this._reportMissingClass(o),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(a);return this._deserializeInto(e,s,a),s},t._deserializeInto=function(e,t,n,r){void 0===r&&(r=!1),r||!t[vh]?t._deserialize?t._deserialize(e.content,this):i.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)},t._runCustomizedDeserialize=function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=Ae(n);r&&i._deserializeInto(e,t,r)}};t[vh](r,this._context)},t._deserializeFireClass=function(e,t,n){var r;if(n.hasOwnProperty("__deserialize__"))r=n.__deserialize__;else{r=function(e,t){for(var n=St(t),r=t.__values__,o=["var prop;"],a=nt.test(Ue(t)),s=0;s<r.length;s++){var c=r[s],l=void 0,u=void 0;Vt.IDENTIFIER_RE.test(c)?(u='"'+c+'"',l="."+c):l="["+(u=Vt.escapeForJS(c))+"]";var h=l;if(n[c+bh]){var f=n[c+bh];h=Vt.IDENTIFIER_RE.test(f)?"."+f:"["+Vt.escapeForJS(f)+"]"}o.push("prop=d"+h+";"),o.push('if(typeof prop!=="undefined"){');var _=Vt.getDefault(n[c+Eh]);if(a){var p=void 0,d=n[c+"$_$type"];if(void 0===_&&d)p=d instanceof Tt;else{var m=typeof _;p="string"===m||"number"===m||"boolean"===m}p?o.push("o"+l+"=prop;"):Th(o,_,l,u,!0)}else o.push('if(typeof prop!=="object"){o'+l+"=prop;}else{"),Th(o,_,l,u,!1),o.push("}");o.push("}")}return(i.js.isChildClassOf(t,i._BaseNode)||i.js.isChildClassOf(t,i.Component))&&o.push("d._id&&(o._id=d._id);"),"_$erialized"===r[r.length-1]&&(o.push("o._$erialized=JSON.parse(JSON.stringify(d));"),o.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",o.join(""))}(0,n);try{if(n===ch){var o=n.__values__;0!==o.length&&"_$erialized"===o[o.length-1]||(d("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),d("    Error props: ['"+o+"']. Please contact jare."));var a=r;r=function(e,t,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||d("Unable to load previously serialized data. "+JSON.stringify(n))}catch(e){d("Error when checking MissingScript 7, "+e)}a(e,t,n,i)}}}catch(e){d("Error when checking MissingScript 6, "+e)}le(n,"__deserialize__",r,!0)}r(this,e,t,n)},t._deserializeAndAssignField=function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var o,a=this._serializedData[i];e[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!=typeof i?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}},t._deserializeFastDefinedObject=function(e,t,n){if(n===i.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===i.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==i.Color){if(n===i.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var r=St(n),o=n.__values__,a=0;a<o.length;a++){var s=o[a],c=t[s];void 0!==c||t.hasOwnProperty(s)||(c=Vt.getDefault(r[s+Eh])),"object"!=typeof c?e[s]=c:c?this._deserializeAndAssignField(e,c,s):e[s]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var l=t.a;e.a=void 0===l?255:l}},e}();Ah.pool=new Ch;var wh=[zi,yi,Hi,Ai,vi,Wi,Xi,Ni];function Rh(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var Ih=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},Rh,Rh,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){Ni.fromArray(e,t,1)}],Ph=e("Details",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function Oh(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=t[c];for(;c<t.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,Fh[u])(e,r,l,t[c])}return r}function Dh(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):A(5303,pe(t)),i}function Mh(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function Nh(e){return function(t,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)e(t,r,o,r[o])}}function Lh(e,t,n,i){t[n]=null,e[8][i]=t}function Bh(e,t,n,i){t[n]=Oh(e,i)}Ph.pool=new ke((function(e){e.reset()}),5),Ph.pool.get=function(){return this._get()||new Ph};var Fh=new Array(13);function zh(e,t,n){return e||n(t),Object}function Uh(e,t,n,i,r,o,a){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||zh(o,i,a);return t[n]=r,new r}}(n,i,t));s=zh(o,t,a)}n[i]=s}function kh(e,t,n,i){for(var r=n||Fe,o=e[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Uh(r,s[0],s,0,t,n,i):Uh(r,s,o,a,t,n,i)}}function Gh(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function Hh(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var r,o=!t;if(t=t||Ph.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof Vh}return!1}(e)){t.init(e),n=n||{};var a,s=e[0],c=!1;if("object"==typeof s&&(c=s.preprocessed,s=s.version),s<1)throw new Error(P(5304,s));n._version=s,n.result=t,e[0]=n,c||(kh(e,!1,n.classFinder,null!==(a=n.reportMissingClass)&&void 0!==a?a:Hh.reportMissingClass),Gh(e)),i.game._isCloning=!0;var l=e[5],u=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],o=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)t[a]=Oh(e,t[a]);for(var s=e[3],c=0;c<i;++c,++a){var l=n[c],u=t[a];if(l>=0){var h=s[l];t[a]=Dh(e,h,u)}else(0,Fh[l=~l])(e,t,a,u)}return r}(e);i.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,o=3*e[i];r<o;r+=3){var a=e[r],s=t[e[r+2]],c=e[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],l,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],o=e[9],a=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(e),r=l[u]}else r=function(e,t,n){var r,o=(n=n||{}).classFinder||Fe,a=n.createAssetRefs||dh.platform===fn.EDITOR_CORE,s=n.customEnv,c=n.ignoreEditorOnly,l=null!==(r=n.reportMissingClass)&&void 0!==r?r:i.deserialize.reportMissingClass;t.init();var u=Ah.pool.get(t,o,l,s,c);i.game._isCloning=!0;var h=u.deserialize(e);return i.game._isCloning=!1,Ah.pool.put(u),a&&t.assignAssetsBy(EditorExtends.serialize.asAsset),h}(e,t,n);return o&&Ph.pool.put(t),r}Fh[0]=function(e,t,n,i){t[n]=i},Fh[1]=Mh,Fh[2]=Nh(Mh),Fh[3]=Nh(Lh),Fh[4]=Bh,Fh[5]=function(e,t,n,i){Ih[i[0]](t[n],i)},Fh[6]=Lh,Fh[7]=function(e,t,n,i){t[n].set(i)},Fh[8]=function(e,t,n,i){var r=new wh[i[0]];Ih[i[0]](r,i),t[n]=r},Fh[9]=Nh(Bh),Fh[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=Dh(e,r,i[1])},Fh[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,Fh[s])(e,r,a,c)}},Fh[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,Fh[s])(e,r,o,a)}},Hh.Details=Ph,Hh.reportMissingClass=function(e){A(5302,e)};var Vh=function(e){this.preprocessed=!0,this.version=e};function jh(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}i.deserialize=Hh;var Wh,qh,Xh,Yh,Kh,Qh,Zh,Jh,$h,ef,tf,nf=Qt.Flags.Destroyed,rf=Qt.Flags.PersistentMask,of=[];function af(e){var t;if(e instanceof Qt){if(e._instantiate)return i.game._isCloning=!0,t=e._instantiate(null,!0),i.game._isCloning=!1,t;if(e instanceof i.Asset)throw new TypeError(P(6903))}return i.game._isCloning=!0,t=sf(e),i.game._isCloning=!1,t}function sf(e,t){var n;cf(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=of.length;i<r;++i)of[i]._iN$t=null;return of.length=0,n}function cf(e,t,n){He.value(e,"_iN$t",t,!0),of.push(e);var r=e.constructor;if(i.Class._isCCClass(r))!function(e,t,n,i){for(var r=e.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];if("object"==typeof s&&s){var c=n[a];c instanceof et&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||lf(s,i)}else n[a]=s}}(r,e,t,n);else for(var o in e)if(e.hasOwnProperty(o)&&(95!==o.charCodeAt(0)||95!==o.charCodeAt(1)||"__type__"===o||"__prefab"===o)){var a=e[o];if("object"==typeof a&&a){if(a===t)continue;t[o]=a._iN$t||lf(a,n)}else t[o]=a}e instanceof Qt&&(t._objFlags&=rf)}function lf(e,t){if(e instanceof et)return e.clone();if(e instanceof i.Asset)return e;var n;if(ArrayBuffer.isView(e)){var r=e.length;n=new e.constructor(r),e._iN$t=n,of.push(e);for(var o=0;o<r;++o)n[o]=e[o];return n}if(Array.isArray(e)){var a=e.length;n=new Array(a),e._iN$t=n,of.push(e);for(var s=0;s<a;++s){var c=e[s];n[s]="object"==typeof c&&c?c._iN$t||lf(c,t):c}return n}if(e._objFlags&nf)return null;var l=e.constructor;if(i.Class._isCCClass(l)){if(t)if(t instanceof i.Component){if(e instanceof i._BaseNode||e instanceof i.Component)return e}else if(t instanceof i._BaseNode)if(e instanceof i._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof i.Component&&e.node&&!e.node.isChildOf(t))return e;n=new l}else if(l===Object)n={};else{if(l)return e;n=Object.create(null)}return cf(e,n,t),n}function uf(e,t){return(t<<3)+e}function hf(e){return _f[e]}function ff(e){switch(e){case ef.Uint8:return Uint8Array;case ef.Uint16:return Uint16Array;case ef.Uint32:return Uint32Array;case ef.Int8:return Int8Array;case ef.Int16:return Int16Array;case ef.Int32:return Int32Array;case ef.Float32:return Float32Array;case ef.Float64:return Float64Array}}af._clone=sf,i.instantiate=af,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(ef||(ef={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(tf||(tf={})),e("CompactValueTypeArray",sl("cc.CompactValueTypeArray")((Jh=Zh=function(){function e(){q(this,"_byteOffset",Xh,this),q(this,"_unitCount",Yh,this),q(this,"_unitElement",Kh,this),q(this,"_length",Qh,this)}return e.lengthFor=function(e,t,n){return hf(t).requiredUnits*e.length*ff(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,r,o,a){for(var s=hf(n),c=ff(i),l=s.requiredUnits*t.length,u=new c(r,o,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var f=new e;return f._unitElement=uf(i,n),f._byteOffset=a,f._unitCount=l,f._length=t.length,f},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=hf(n.elementType),o=new(ff(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},e}(),Zh.StorageUnit=ef,Zh.ElementType=tf,Xh=X((qh=Jh).prototype,"_byteOffset",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yh=X(qh.prototype,"_unitCount",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kh=X(qh.prototype,"_unitElement",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uf(ef.Uint8,tf.Scalar)}}),Qh=X(qh.prototype,"_length",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wh=qh))||Wh);var _f=(($h={})[tf.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},$h[tf.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new yi(e[2*t],e[2*t+1])}},$h[tf.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new yi(e[3*t],e[3*t+1],e[3*t+2])}},$h[tf.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Hi(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},$h[tf.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Ai(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},$h[tf.Mat4]={requiredUnits:16,compress:function(e,t,n){Ni.toArray(e,n,16*t)},decompress:function(e,t){return Ni.fromArray(new Ni,e,16*t)}},$h);function pf(){return 0}function df(e){return e}function mf(e){return e*e}function vf(e){return e*(2-e)}function gf(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function yf(e){return e*e*e}function Sf(e){return--e*e*e+1}function xf(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function Tf(e){return e*e*e*e}function Ef(e){return 1- --e*e*e*e}function bf(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function Cf(e){return e*e*e*e*e}function Af(e){return--e*e*e*e*e+1}function wf(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function Rf(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function If(e){return Math.sin(e*Math.PI/2)}function Pf(e){return.5*(1-Math.cos(Math.PI*e))}function Of(e){return 0===e?0:Math.pow(1024,e-1)}function Df(e){return 1===e?1:1-Math.pow(2,-10*e)}function Mf(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function Nf(e){return 1-Math.sqrt(1-e*e)}function Lf(e){return Math.sqrt(1- --e*e)}function Bf(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function Ff(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function zf(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function Uf(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function kf(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function Gf(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function Hf(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function Vf(e){return 1-jf(1-e)}function jf(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function Wf(e){return e<.5?.5*Vf(2*e):.5*jf(2*e-1)+.5}function qf(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function Xf(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}i._decorator=nu;var Yf=r_(mf,vf),Kf=r_(yf,Sf),Qf=r_(Tf,Ef),Zf=r_(Cf,Af),Jf=r_(Rf,If),$f=r_(Of,Df),e_=r_(Nf,Lf),t_=r_(Ff,zf),n_=r_(kf,Gf),i_=r_(Vf,jf);function r_(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var o_,a_,s_=Object.freeze({__proto__:null,constant:pf,linear:df,quadIn:mf,quadOut:vf,quadInOut:gf,cubicIn:yf,cubicOut:Sf,cubicInOut:xf,quartIn:Tf,quartOut:Ef,quartInOut:bf,quintIn:Cf,quintOut:Af,quintInOut:wf,sineIn:Rf,sineOut:If,sineInOut:Pf,expoIn:Of,expoOut:Df,expoInOut:Mf,circIn:Nf,circOut:Lf,circInOut:Bf,elasticIn:Ff,elasticOut:zf,elasticInOut:Uf,backIn:kf,backOut:Gf,backInOut:Hf,bounceIn:Vf,bounceOut:jf,bounceInOut:Wf,smooth:qf,fade:Xf,quadOutIn:Yf,cubicOutIn:Kf,quartOutIn:Qf,quintOutIn:Zf,sineOutIn:Jf,expoOutIn:$f,circOutIn:e_,elasticOutIn:t_,backOutIn:n_,bounceOutIn:i_});e("easing",s_),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(a_||(a_={}));var c_,l_,u_,h_,f_,__=((o_={})[a_.CONSTANT]=pf,o_[a_.LINEAR]=df,o_[a_.QUAD_IN]=mf,o_[a_.QUAD_OUT]=vf,o_[a_.QUAD_IN_OUT]=gf,o_[a_.QUAD_OUT_IN]=Yf,o_[a_.CUBIC_IN]=yf,o_[a_.CUBIC_OUT]=Sf,o_[a_.CUBIC_IN_OUT]=xf,o_[a_.CUBIC_OUT_IN]=Kf,o_[a_.QUART_IN]=Tf,o_[a_.QUART_OUT]=Ef,o_[a_.QUART_IN_OUT]=bf,o_[a_.QUART_OUT_IN]=Qf,o_[a_.QUINT_IN]=Cf,o_[a_.QUINT_OUT]=Af,o_[a_.QUINT_IN_OUT]=wf,o_[a_.QUINT_OUT_IN]=Zf,o_[a_.SINE_IN]=Rf,o_[a_.SINE_OUT]=If,o_[a_.SINE_IN_OUT]=Pf,o_[a_.SINE_OUT_IN]=Jf,o_[a_.EXPO_IN]=Of,o_[a_.EXPO_OUT]=Df,o_[a_.EXPO_IN_OUT]=Mf,o_[a_.EXPO_OUT_IN]=$f,o_[a_.CIRC_IN]=Nf,o_[a_.CIRC_OUT]=Lf,o_[a_.CIRC_IN_OUT]=Bf,o_[a_.CIRC_OUT_IN]=e_,o_[a_.ELASTIC_IN]=Ff,o_[a_.ELASTIC_OUT]=zf,o_[a_.ELASTIC_IN_OUT]=Uf,o_[a_.ELASTIC_OUT_IN]=t_,o_[a_.BACK_IN]=kf,o_[a_.BACK_OUT]=Gf,o_[a_.BACK_IN_OUT]=Hf,o_[a_.BACK_OUT_IN]=n_,o_[a_.BOUNCE_IN]=Vf,o_[a_.BOUNCE_OUT]=jf,o_[a_.BOUNCE_IN_OUT]=Wf,o_[a_.BOUNCE_OUT_IN]=i_,o_[a_.SMOOTH]=qf,o_[a_.FADE]=Xf,o_);function p_(e){return __[e]}var d_,m_,v_,g_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).interpolationMode=Kl.LINEAR,t.tangentWeightMode=Zl.NONE,t.value=0,t.rightTangent=0,t.rightTangentWeight=0,t.leftTangent=0,t.leftTangentWeight=0,t.easingMethod=a_.LINEAR,t}return F(t,e),t}(tu);function y_(e){var t=new g_;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,o=e.rightTangent,a=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[Xt];t.value=null!=r?r:t.value,t.rightTangent=null!=o?o:t.rightTangent,t.rightTangentWeight=null!=a?a:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[Xt]=u)}return t}Vt.fastDefine("cc.RealKeyframeValue",g_,{interpolationMode:Kl.LINEAR,tangentWeightMode:Zl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:a_.LINEAR}),Vt.Attr.setClassAttr(g_,Xt,"editorOnly",!0),(d_=g_,null!==(v_=(m_=d_)[fl])&&void 0!==v_?v_:m_[fl]={}).uniquelyReferenced=!0;var S_,x_=e("RealCurve",sl("cc.RealCurve")((f_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",u_,V(t)),q(t,"postExtrapolation",h_,V(t)),t}F(t,e);var n=t.prototype;return n.evaluate=function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],o=t[i-1];if(e<r){var a=this.preExtrapolation,s=n[0];if(a===Ql.CLAMP||i<2)return s.value;switch(a){case Ql.LINEAR:return F_(r,n[0].value,t[1],n[1].value,e);case Ql.LOOP:e=L_(e,r,o);break;case Ql.PING_PONG:e=B_(e,r,o);break;default:return s.value}}else if(e>o){var c=this.postExtrapolation,l=n[i-1];if(c===Ql.CLAMP||i<2)return l.value;switch(c){case Ql.LINEAR:return F_(o,l.value,t[i-2],n[i-2].value,e);case Ql.LOOP:e=L_(e,r,o);break;case Ql.PING_PONG:e=B_(e,r,o);break;default:return l.value}}var u=Jc(t,e);if(u>=0)return n[u].value;var h=~u,f=h-1,_=t[f],p=n[f],d=t[h];return function(e,t,n,i,r){var o=n-e;switch(t.interpolationMode){default:case Kl.CONSTANT:return t.value;case Kl.LINEAR:var a=t.easingMethod===a_.LINEAR?r:p_(t.easingMethod)(r);return ei(t.value,i.value,a);case Kl.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&Zl.RIGHT),h=i.leftTangent,f=i.leftTangentWeight,_=0!=(i.tangentWeightMode&Zl.LEFT);if(u||_){var p=0;if(u)p=l;else{var d=o,m=o*c;p=Math.sqrt(d*d+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*p+e,y=Math.sin(v)*p+t.value,S=0;if(_)S=f;else{var x=o,T=o*h;S=Math.sqrt(x*x+T*T)*s}var E=Math.atan(h),b=(g-e)/o,C=(-Math.cos(E)*S+n-e)/o,A=y,w=-Math.sin(E)*S+i.value,R=[0,0,0],I=function(e,t,n,i,r){var o=n/i,a=t/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+e/i),u=c*c*c,h=l*l+u,f=0;if(eu(h)){if(eu(l))return r[0]=0,1;var _=Math.cbrt(-l);return r[0]=2*_,r[1]=-_,2}if(h<0){var p=1/3*Math.acos(-l/Math.sqrt(-u)),d=2*Math.sqrt(-c);r[0]=d*Math.cos(p),r[1]=-d*Math.cos(p+Math.PI/3),r[2]=-d*Math.cos(p-Math.PI/3),f=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,f=1}for(var y=1/3*o,S=0;S<f;++S)r[S]-=y;return f}(0-r,3*b,3*C-6*b,3*(b-C)+1,R),P=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var o=e[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(R,I,r);return z_(t.value,A,w,i.value,P)}var O=t.value+s*c*o,D=i.value-s*h*o;return z_(t.value,O,D,i.value,r)}}(_,p,d,n[h],(e-_)/(d-_))},n.addKeyFrame=function(t,n){return e.prototype.addKeyFrame.call(this,t,y_(n))},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return y_(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return y_(e[1])})))}},n.isConstant=function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return Zn(n.value,t,e)}))},n[mh]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+T_+T_+E_+b_*r+D_*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=T_,o.setUint8(a,this.postExtrapolation),a+=T_,o.setUint32(a,r,!0),a+=E_,n.forEach((function(e,t){return o.setFloat32(a+b_*t,e,!0)})),a+=b_*r;for(var s,c=W(i);!(s=c()).done;){var l=s.value;a=M_(o,l,a)}var u=new Uint8Array(o.buffer,0,a);e.writeProperty("bytes",u);var h=i.map((function(e){return e[Xt]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()},n[vh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=T_,this.postExtrapolation=i.getUint8(r),r+=T_;var o=i.getUint32(r,!0);r+=E_;var a=Array.from({length:o},(function(e,t){return i.getFloat32(r+b_*t,!0)}));r+=b_*o;for(var s=new Array(o),c=0;c<o;++c){var l=y_({});r=N_(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][Xt]=e}))),this._times=a,this._values=s}else e.readThis()},t}($l),u_=X((l_=f_).prototype,"preExtrapolation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ql.CLAMP}}),h_=X(l_.prototype,"postExtrapolation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ql.CLAMP}}),c_=l_))||c_);!function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(S_||(S_={}));var T_=1,E_=4,b_=4,C_=y_({}),A_=C_.interpolationMode,w_=C_.tangentWeightMode,R_=C_.leftTangent,I_=C_.leftTangentWeight,P_=C_.rightTangent,O_=C_.rightTangentWeight,D_=26;function M_(e,t,n){var i=0,r=n,o=r;r+=4;var a=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,f=t.leftTangentWeight,_=t.easingMethod;return e.setFloat32(r,a,!0),r+=4,s!==A_&&(i|=S_.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==w_&&(i|=S_.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==R_&&(i|=S_.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),f!==I_&&(i|=S_.LEFT_TANGENT_WEIGHT,e.setFloat32(r,f,!0),r+=4),l!==P_&&(i|=S_.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==O_&&(i|=S_.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=_<<8,e.setUint32(o,i,!0),r}function N_(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&S_.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&S_.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&S_.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&S_.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&S_.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&S_.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return t.easingMethod=o,i}function L_(e,t,n){return t+ui(e-t,n-t)}function B_(e,t,n){return t+hi(e-t,n-t)}function F_(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function z_(e,t,n,i,r){var o=1-r;return o*o*o*e+3*o*o*r*t+3*o*r*r*n+r*r*r*i}function U_(e,t,n,i,r){var o=1-r;return o*(o*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}i.bezier=U_;var k_,G_,H_,V_,j_,W_,q_,X_,Y_,K_,Q_,Z_=Math.cos,J_=Math.acos,$_=Math.max,ep=2*Math.PI,tp=Math.sqrt;function np(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function ip(e,t){var n=function(e,t){var n,i,r,o,a=t-0,s=t-e[0],c=3*a,l=3*s,u=3*(t-e[2]),h=1/(-a+l-u+(t-1)),f=1/3,_=(c-6*s+u)*h,p=_*f,d=(-c+l)*h,m=(3*d-_*_)*f,v=m*f,g=(2*_*_*_-9*_*d+a*h*27)/27,y=g/2,S=y*y+v*v*v;if(S<0){var x=-m*f,T=tp(x*x*x),E=-g/(2*T),b=J_(E<-1?-1:E>1?1:E),C=2*np(T);return i=C*Z_(b*f)-p,r=C*Z_((b+ep)*f)-p,o=C*Z_((b+2*ep)*f)-p,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?$_(i,r,o):$_(i,r):o>=0&&o<=1?$_(i,o):i:r>=0&&r<=1?o>=0&&o<=1?$_(r,o):r:o}if(0===S)return r=-(n=y<0?np(-y):-np(y))-p,(i=2*n-p)>=0&&i<=1?r>=0&&r<=1?$_(i,r):i:r;var A=tp(S);return(n=np(-y+A))-np(y+A)-p}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}i.bezierByTime=ip,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(Q_||(Q_=e("QuatInterpolationMode",{})));var rp=sl("cc.QuatKeyframeValue")(k_=vl((H_=X((G_=function(e){var t=void 0===e?{}:e,n=t.value,i=t.interpolationMode,r=t.easingMethod;q(this,"interpolationMode",H_,this),q(this,"value",V_,this),q(this,"easingMethod",j_,this),this.value=n?Ai.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Q_.SLERP}}),V_=X(G_.prototype,"value",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ai.clone(Ai.IDENTITY)}}),j_=X(G_.prototype,"easingMethod",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return a_.LINEAR}}),k_=G_))||k_)||k_;function op(e){return new rp(e)}var ap,sp=e("QuatCurve",sl("cc.QuatCurve")((K_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",X_,V(t)),q(t,"postExtrapolation",Y_,V(t)),t}F(t,e);var n=t.prototype;return n.evaluate=function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new Ai);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(a){case Ql.LOOP:e=c+ui(e-c,l-c);break;case Ql.PING_PONG:e=c+hi(e-c,l-c);break;case Ql.CLAMP:default:return Ai.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(o){case Ql.LOOP:e=c+ui(e-c,l-c);break;case Ql.PING_PONG:e=c+hi(e-c,l-c);break;case Ql.CLAMP:default:return Ai.copy(t,h.value)}}var f=Jc(i,e);if(f>=0)return Ai.copy(t,r[f].value);var _=~f,p=_-1,d=i[p],m=r[p],v=i[_],g=r[_],y=(e-d)/(v-d);switch(m.interpolationMode){default:case Q_.CONSTANT:return Ai.copy(t,m.value);case Q_.SLERP:var S=m.easingMethod,x=S===a_.LINEAR?y:Array.isArray(S)?ip(S,y):p_(S)(y);return Ai.slerp(t,m.value,g.value,x)}},n.addKeyFrame=function(t,n){var i=new rp(n);return e.prototype.addKeyFrame.call(this,t,i)},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return op(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return op(e[1])})))}},n[mh]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=n[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=gp*(r?1:o),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?yp+4*xp:yp)}),0),c=0,l=new DataView(new ArrayBuffer(c+=pp+dp+mp*o+4*vp*o+s+a+0)),u=0,h=0;r&&(h|=ap.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=pp,l.setUint32(u,o,!0),u+=dp,n.forEach((function(e,t){return l.setFloat32(u+mp*t,e,!0)})),u+=mp*o,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*vp*t;l.setFloat32(s+0*vp,i,!0),l.setFloat32(s+1*vp,r,!0),l.setFloat32(s+2*vp,o,!0),l.setFloat32(s+3*vp,a,!0)})),u+=4*vp*o,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,Sp),++u,l.setFloat32(u+0*xp,t[0],!0),l.setFloat32(u+1*xp,t[1],!0),l.setFloat32(u+2*xp,t[2],!0),l.setFloat32(u+3*xp,t[3],!0),u+=4*xp):(l.setUint8(u,t),++u)}));var f=u;u+=a;var _=f;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(_,t),r||(_+=gp)}));var p=new Uint8Array(l.buffer);e.writeProperty("bytes",p)}else e.writeThis()},n[vh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=pp;var a=o&ap.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=dp;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+mp*t,!0)})),l=r+=mp*s;r+=4*vp*s;var u=Array.from({length:s},(function(e,t){var n=l+4*vp*t,o=i.getFloat32(n+0*vp,!0),a=i.getFloat32(n+1*vp,!0),s=i.getFloat32(n+2*vp,!0),c=i.getFloat32(n+3*vp,!0),u=i.getUint8(r);++r;var h=op({value:{x:o,y:a,z:s,w:c}});return u!==Sp?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*xp,!0),i.getFloat32(r+1*xp,!0),i.getFloat32(r+2*xp,!0),i.getFloat32(r+3*xp,!0)],r+=4*xp),h}));if(a){var h=i.getUint8(r);++r;for(var f=0;f<s;++f)u[f].interpolationMode=h}else{for(var _=0;_<s;++_){var p=i.getUint8(r+_);u[_].interpolationMode=p}r+=s}this._times=c,this._values=u}else e.readThis()},t}($l),X_=X((q_=K_).prototype,"preExtrapolation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ql.CLAMP}}),Y_=X(q_.prototype,"postExtrapolation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ql.CLAMP}}),W_=q_))||W_);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(ap||(ap={}));var cp,lp,up,hp,fp,_p,pp=1,dp=4,mp=4,vp=4,gp=1,yp=1,Sp=255,xp=4,Tp=e("ObjectCurve",sl("cc.ObjectCurve")(cp=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t.prototype.evaluate=function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=Jn(~t-1,0,this._values.length-1);return this._values[n]},t}($l))||cp),Ep=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Vt.fastDefine("cc.Keyframe",Ep,{time:0,value:0,inTangent:0,outTangent:0});var bp=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),Cp=sl("cc.AnimationCurve")((_p=fp=function(){function e(e){if(void 0===e&&(e=null),q(this,"_curve",hp,this),this.cachedKey=void 0,e instanceof x_)this._curve=e;else{var t=new x_;this._curve=t,t.preExtrapolation=Ql.LOOP,t.postExtrapolation=Ql.CLAMP,e?t.assignSorted(e.map((function(e){return[e.time,{interpolationMode:Kl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):t.assignSorted([[0,{interpolationMode:Kl.CUBIC,value:1}],[1,{interpolationMode:Kl.CUBIC,value:1}]])}this.cachedKey=new bp}var t=e.prototype;return t.addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:Kl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},t.evaluate_slow=function(e){return this._curve.evaluate(e)},t.evaluate=function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,o=e<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case Ql.LOOP:r=ui(e-a,s-a)+a;break;case Ql.PING_PONG:r=hi(e-a,s-a)+a;break;case Ql.CLAMP:default:r=Jn(e,a,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)},t.calcOptimizedKey=function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(t),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,f=l-a,_=1/(h*h),p=s*h,d=u*h;e.coefficient[0]=(p+d-f-f)*_/h,e.coefficient[1]=(f+f+f-p-p-d)*_,e.coefficient[2]=s,e.coefficient[3]=a},t.findIndex=function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>t)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u},L(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=e[0],n=e[1],i=new Ep;return i.time=t,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:Kl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return wp(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=Ap(e)}},{key:"postWrapMode",get:function(){return wp(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=Ap(e)}}]),e}(),fp.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],hp=X((up=_p).prototype,"_curve",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lp=up))||lp;function Ap(e){switch(e){default:case Wc.Default:case Wc.Normal:case Wc.Clamp:return Ql.CLAMP;case Wc.PingPong:return Ql.PING_PONG;case Wc.Loop:return Ql.LOOP}}function wp(e){switch(e){default:case Ql.LINEAR:case Ql.CLAMP:return Wc.Clamp;case Ql.PING_PONG:return Wc.PingPong;case Ql.LOOP:return Wc.Loop}}function Rp(){var e=new x_;return e.assignSorted([[0,{interpolationMode:Kl.CUBIC,value:1}],[1,{interpolationMode:Kl.CUBIC,value:1}]]),e}function Ip(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}zn(rc,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var Pp=function(e){function t(){var t;return t=e.call(this)||this,Ip("line","Line"),t}return F(t,e),t}(_r),Op=function(e){function t(){var t;return t=e.call(this)||this,Ip("plane","Plane"),t}return F(t,e),t}(mc),Dp=function(e){function t(){var t;return t=e.call(this)||this,Ip("ray","Ray"),t}return F(t,e),t}(pr),Mp=function(e){function t(){var t;return t=e.call(this)||this,Ip("triangle","Triangle"),t}return F(t,e),t}(co),Np=function(e){function t(){var t;return t=e.call(this)||this,Ip("sphere","Sphere"),t}return F(t,e),t}(so),Lp=function(e){function t(){var t;return t=e.call(this)||this,Ip("aabb","AABB"),t}return F(t,e),t}(zc),Bp=function(e){function t(){var t;return t=e.call(this)||this,Ip("obb","OBB"),t}return F(t,e),t}(Hc),Fp=function(e){function t(){var t;return t=e.call(this)||this,Ip("capsule","Capsule"),t}return F(t,e),t}(Vc),zp=function(e){function t(){var t;return t=e.call(this)||this,Ip("frustum","Frustum"),t}return F(t,e),t}(Qc),Up=Object.freeze({__proto__:null,distance:hr,enums:fr,intersect:rc,Line:_r,Plane:mc,Ray:pr,Triangle:co,Sphere:so,AABB:zc,OBB:Hc,Capsule:Vc,Frustum:Qc,Keyframe:Ep,AnimationCurve:Cp,get ERaycastMode(){return Ja},line:Pp,plane:Op,ray:Dp,triangle:Mp,sphere:Np,aabb:Lp,obb:Bp,capsule:Fp,frustum:zp});e("geometry",Up);var kp={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Gp=e("Layers",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=W(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;e.Enum[t],P(2104,t),e.Enum[t]=i,He.value(e.Enum,String(i),t),e.BitMask[t]=i,He.value(e.BitMask,String(i),t)}else console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var n=1<<t;delete e.Enum[e.Enum[n]],delete e.Enum[n],delete e.BitMask[e.BitMask[n]],delete e.BitMask[n]}},e.nameToLayer=function(t){return void 0===t?(console.warn("name can't be undefined"),-1):Mn(e.Enum[t])},e.layerToName=function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]},e}());Gp.Enum=Qe(kp),Gp.BitMask=Ye(B({},kp)),i.Layers=Gp;var Hp,Vp,jp="MainFlow",Wp="ForwardFlow",qp="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(Hp||(Hp={})),i.RenderPassStage=Hp,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Vp||(Vp={}));var Xp,Yp={bindings:[],layouts:{}},Kp={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",e[e.COUNT=7]="COUNT"}(Xp||(Xp={}));var Qp,Zp=Xp.SAMPLER_SHADOWMAP,Jp=Xp.COUNT-Zp;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",e[e.COUNT=14]="COUNT"}(Qp||(Qp={}));var $p,ed=Qp.SAMPLER_JOINTS,td=Qp.COUNT-ed;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}($p||($p={}));var nd=new bo;nd.bufferOffsets=[0,Zp+ed,Zp],nd.samplerOffsets=[-Zp,Jp+td,Jp-ed],nd.flexibleSet=1;var id=function(){};id.SIZE=4*(id.COUNT=4+(id.SCREEN_SIZE_OFFSET=4+(id.NATIVE_SIZE_OFFSET=4+(id.TIME_OFFSET=0)))),id.NAME="CCGlobal",id.BINDING=Xp.UBO_GLOBAL,id.DESCRIPTOR=new ta(id.BINDING,no.UNIFORM_BUFFER,1,jr.ALL),id.LAYOUT=new Bo($p.GLOBAL,id.BINDING,id.NAME,[new Lo("cc_time",wr.FLOAT4,1),new Lo("cc_screenSize",wr.FLOAT4,1),new Lo("cc_nativeSize",wr.FLOAT4,1)],1),Yp.layouts[id.NAME]=id.LAYOUT,Yp.bindings[id.BINDING]=id.DESCRIPTOR;var rd=function(){};rd.SIZE=4*(rd.COUNT=4+(rd.VIEW_PORT_OFFSET=4+(rd.NEAR_FAR_OFFSET=4+(rd.GLOBAL_FOG_ADD_OFFSET=4+(rd.GLOBAL_FOG_BASE_OFFSET=4+(rd.GLOBAL_FOG_COLOR_OFFSET=4+(rd.AMBIENT_GROUND_OFFSET=4+(rd.AMBIENT_SKY_OFFSET=4+(rd.MAIN_LIT_COLOR_OFFSET=4+(rd.MAIN_LIT_DIR_OFFSET=4+(rd.EXPOSURE_OFFSET=4+(rd.SCREEN_SCALE_OFFSET=4+(rd.CAMERA_POS_OFFSET=16+(rd.MAT_VIEW_PROJ_INV_OFFSET=16+(rd.MAT_VIEW_PROJ_OFFSET=16+(rd.MAT_PROJ_INV_OFFSET=16+(rd.MAT_PROJ_OFFSET=16+(rd.MAT_VIEW_INV_OFFSET=16+(rd.MAT_VIEW_OFFSET=0))))))))))))))))))),rd.NAME="CCCamera",rd.BINDING=Xp.UBO_CAMERA,rd.DESCRIPTOR=new ta(rd.BINDING,no.UNIFORM_BUFFER,1,jr.ALL),rd.LAYOUT=new Bo($p.GLOBAL,rd.BINDING,rd.NAME,[new Lo("cc_matView",wr.MAT4,1),new Lo("cc_matViewInv",wr.MAT4,1),new Lo("cc_matProj",wr.MAT4,1),new Lo("cc_matProjInv",wr.MAT4,1),new Lo("cc_matViewProj",wr.MAT4,1),new Lo("cc_matViewProjInv",wr.MAT4,1),new Lo("cc_cameraPos",wr.FLOAT4,1),new Lo("cc_screenScale",wr.FLOAT4,1),new Lo("cc_exposure",wr.FLOAT4,1),new Lo("cc_mainLitDir",wr.FLOAT4,1),new Lo("cc_mainLitColor",wr.FLOAT4,1),new Lo("cc_ambientSky",wr.FLOAT4,1),new Lo("cc_ambientGround",wr.FLOAT4,1),new Lo("cc_fogColor",wr.FLOAT4,1),new Lo("cc_fogBase",wr.FLOAT4,1),new Lo("cc_fogAdd",wr.FLOAT4,1),new Lo("cc_nearFar",wr.FLOAT4,1),new Lo("cc_viewPort",wr.FLOAT4,1)],1),Yp.layouts[rd.NAME]=rd.LAYOUT,Yp.bindings[rd.BINDING]=rd.DESCRIPTOR;var od=function(){};od.SIZE=4*(od.COUNT=4+(od.SHADOW_COLOR_OFFSET=4+(od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(od.SHADOW_PROJ_INFO_OFFSET=4+(od.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(od.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(od.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(od.MAT_LIGHT_VIEW_OFFSET=16+(od.MAT_LIGHT_PLANE_PROJ_OFFSET=0))))))))))),od.NAME="CCShadow",od.BINDING=Xp.UBO_SHADOW,od.DESCRIPTOR=new ta(od.BINDING,no.UNIFORM_BUFFER,1,jr.ALL),od.LAYOUT=new Bo($p.GLOBAL,od.BINDING,od.NAME,[new Lo("cc_matLightPlaneProj",wr.MAT4,1),new Lo("cc_matLightView",wr.MAT4,1),new Lo("cc_matLightViewProj",wr.MAT4,1),new Lo("cc_shadowInvProjDepthInfo",wr.FLOAT4,1),new Lo("cc_shadowProjDepthInfo",wr.FLOAT4,1),new Lo("cc_shadowProjInfo",wr.FLOAT4,1),new Lo("cc_shadowNFLSInfo",wr.FLOAT4,1),new Lo("cc_shadowWHPBInfo",wr.FLOAT4,1),new Lo("cc_shadowLPNNInfo",wr.FLOAT4,1),new Lo("cc_shadowColor",wr.FLOAT4,1)],1),Yp.layouts[od.NAME]=od.LAYOUT,Yp.bindings[od.BINDING]=od.DESCRIPTOR;var ad=Xp.SAMPLER_SHADOWMAP,sd=new ta(ad,no.SAMPLER_TEXTURE,1,jr.FRAGMENT),cd=new Fo($p.GLOBAL,ad,"cc_shadowMap",wr.SAMPLER2D,1);Yp.layouts.cc_shadowMap=cd,Yp.bindings[ad]=sd;var ld=Xp.SAMPLER_ENVIRONMENT,ud=new ta(ld,no.SAMPLER_TEXTURE,1,jr.FRAGMENT),hd=new Fo($p.GLOBAL,ld,"cc_environment",wr.SAMPLER_CUBE,1);Yp.layouts.cc_environment=hd,Yp.bindings[ld]=ud;var fd=Xp.SAMPLER_DIFFUSEMAP,_d=new ta(fd,no.SAMPLER_TEXTURE,1,jr.FRAGMENT),pd=new Fo($p.GLOBAL,fd,"cc_diffuseMap",wr.SAMPLER_CUBE,1);Yp.layouts.cc_diffuseMap=pd,Yp.bindings[fd]=_d;var dd=Xp.SAMPLER_SPOT_LIGHTING_MAP,md=new ta(dd,no.SAMPLER_TEXTURE,1,jr.FRAGMENT),vd=new Fo($p.GLOBAL,dd,"cc_spotLightingMap",wr.SAMPLER2D,1);Yp.layouts.cc_spotLightingMap=vd,Yp.bindings[dd]=md;var gd=function(){};gd.SIZE=4*(gd.COUNT=4+(gd.LIGHTINGMAP_UVPARAM=16+(gd.MAT_WORLD_IT_OFFSET=16+(gd.MAT_WORLD_OFFSET=0)))),gd.NAME="CCLocal",gd.BINDING=Qp.UBO_LOCAL,gd.DESCRIPTOR=new ta(gd.BINDING,no.UNIFORM_BUFFER,1,jr.VERTEX|jr.COMPUTE),gd.LAYOUT=new Bo($p.LOCAL,gd.BINDING,gd.NAME,[new Lo("cc_matWorld",wr.MAT4,1),new Lo("cc_matWorldIT",wr.MAT4,1),new Lo("cc_lightingMapUVParam",wr.FLOAT4,1)],1),Kp.layouts[gd.NAME]=gd.LAYOUT,Kp.bindings[gd.BINDING]=gd.DESCRIPTOR;var yd=function(){};yd.SIZE=4*(yd.COUNT=4+(yd.WORLD_BOUND_HALF_EXTENTS=4+(yd.WORLD_BOUND_CENTER=0))),yd.NAME="CCWorldBound",yd.BINDING=Qp.UBO_LOCAL,yd.DESCRIPTOR=new ta(yd.BINDING,no.UNIFORM_BUFFER,1,jr.VERTEX|jr.COMPUTE),yd.LAYOUT=new Bo($p.LOCAL,yd.BINDING,yd.NAME,[new Lo("cc_worldBoundCenter",wr.FLOAT4,1),new Lo("cc_worldBoundHalfExtents",wr.FLOAT4,1)],1),Kp.layouts[yd.NAME]=yd.LAYOUT,Kp.bindings[yd.BINDING]=yd.DESCRIPTOR;var Sd="a_matWorld0",xd=function(){};xd.BATCHING_COUNT=10,xd.MAT_WORLDS_OFFSET=0,xd.SIZE=4*(xd.COUNT=16*xd.BATCHING_COUNT),xd.NAME="CCLocalBatched",xd.BINDING=Qp.UBO_LOCAL,xd.DESCRIPTOR=new ta(xd.BINDING,no.UNIFORM_BUFFER,1,jr.VERTEX|jr.COMPUTE),xd.LAYOUT=new Bo($p.LOCAL,xd.BINDING,xd.NAME,[new Lo("cc_matWorlds",wr.MAT4,xd.BATCHING_COUNT)],1),Kp.layouts[xd.NAME]=xd.LAYOUT,Kp.bindings[xd.BINDING]=xd.DESCRIPTOR;var Td=function(){};Td.LIGHTS_PER_PASS=1,Td.SIZE=4*(Td.COUNT=(Td.LIGHT_DIR_OFFSET=(Td.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Td.LIGHT_COLOR_OFFSET=(Td.LIGHT_POS_OFFSET=0)+4*Td.LIGHTS_PER_PASS)+4*Td.LIGHTS_PER_PASS)+4*Td.LIGHTS_PER_PASS)+4*Td.LIGHTS_PER_PASS),Td.NAME="CCForwardLight",Td.BINDING=Qp.UBO_FORWARD_LIGHTS,Td.DESCRIPTOR=new ta(Td.BINDING,no.DYNAMIC_UNIFORM_BUFFER,1,jr.FRAGMENT),Td.LAYOUT=new Bo($p.LOCAL,Td.BINDING,Td.NAME,[new Lo("cc_lightPos",wr.FLOAT4,Td.LIGHTS_PER_PASS),new Lo("cc_lightColor",wr.FLOAT4,Td.LIGHTS_PER_PASS),new Lo("cc_lightSizeRangeAngle",wr.FLOAT4,Td.LIGHTS_PER_PASS),new Lo("cc_lightDir",wr.FLOAT4,Td.LIGHTS_PER_PASS)],1),Kp.layouts[Td.NAME]=Td.LAYOUT,Kp.bindings[Td.BINDING]=Td.DESCRIPTOR;var Ed=function(){};Ed.LIGHTS_PER_PASS=10;var bd=function(){};bd.SIZE=4*(bd.COUNT=4+(bd.JOINTS_TEXTURE_INFO_OFFSET=0)),bd.NAME="CCSkinningTexture",bd.BINDING=Qp.UBO_SKINNING_TEXTURE,bd.DESCRIPTOR=new ta(bd.BINDING,no.UNIFORM_BUFFER,1,jr.VERTEX),bd.LAYOUT=new Bo($p.LOCAL,bd.BINDING,bd.NAME,[new Lo("cc_jointTextureInfo",wr.FLOAT4,1)],1),Kp.layouts[bd.NAME]=bd.LAYOUT,Kp.bindings[bd.BINDING]=bd.DESCRIPTOR;var Cd=function(){};Cd.SIZE=4*(Cd.COUNT=4+(Cd.JOINTS_ANIM_INFO_OFFSET=0)),Cd.NAME="CCSkinningAnimation",Cd.BINDING=Qp.UBO_SKINNING_ANIMATION,Cd.DESCRIPTOR=new ta(Cd.BINDING,no.UNIFORM_BUFFER,1,jr.VERTEX),Cd.LAYOUT=new Bo($p.LOCAL,Cd.BINDING,Cd.NAME,[new Lo("cc_jointAnimInfo",wr.FLOAT4,1)],1),Kp.layouts[Cd.NAME]=Cd.LAYOUT,Kp.bindings[Cd.BINDING]=Cd.DESCRIPTOR;var Ad="a_jointAnimInfo",wd=function(){};wd.SIZE=4*(wd.COUNT=360+(wd.JOINTS_OFFSET=0)),wd.NAME="CCSkinning",wd.BINDING=Qp.UBO_SKINNING_TEXTURE,wd.DESCRIPTOR=new ta(wd.BINDING,no.UNIFORM_BUFFER,1,jr.VERTEX),wd.LAYOUT=new Bo($p.LOCAL,wd.BINDING,wd.NAME,[new Lo("cc_joints",wr.FLOAT4,90)],1),Kp.layouts[wd.NAME]=wd.LAYOUT,Kp.bindings[wd.BINDING]=wd.DESCRIPTOR;var Rd=function(){};Rd.MAX_MORPH_TARGET_COUNT=60,Rd.OFFSET_OF_WEIGHTS=0,Rd.OFFSET_OF_VERTICES_COUNT=4+(Rd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(Rd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Rd.MAX_MORPH_TARGET_COUNT)),Rd.COUNT_BASE_4_BYTES=4*Math.ceil(Rd.MAX_MORPH_TARGET_COUNT/4)+4,Rd.SIZE=4*Rd.COUNT_BASE_4_BYTES,Rd.NAME="CCMorph",Rd.BINDING=Qp.UBO_MORPH,Rd.DESCRIPTOR=new ta(Rd.BINDING,no.UNIFORM_BUFFER,1,jr.VERTEX),Rd.LAYOUT=new Bo($p.LOCAL,Rd.BINDING,Rd.NAME,[new Lo("cc_displacementWeights",wr.FLOAT4,Rd.MAX_MORPH_TARGET_COUNT/4),new Lo("cc_displacementTextureInfo",wr.FLOAT4,1)],1),Kp.layouts[Rd.NAME]=Rd.LAYOUT,Kp.bindings[Rd.BINDING]=Rd.DESCRIPTOR;var Id=function(){};Id.NAME="CCUILocal",Id.BINDING=Qp.UBO_UI_LOCAL,Id.DESCRIPTOR=new ta(Id.BINDING,no.DYNAMIC_UNIFORM_BUFFER,1,jr.VERTEX),Id.LAYOUT=new Bo($p.LOCAL,Id.BINDING,Id.NAME,[new Lo("cc_local_data",wr.FLOAT4,1)],1),Kp.layouts[Id.NAME]=Id.LAYOUT,Kp.bindings[Id.BINDING]=Id.DESCRIPTOR;var Pd=Qp.SAMPLER_JOINTS,Od=new ta(Pd,no.SAMPLER_TEXTURE,1,jr.VERTEX),Dd=new Fo($p.LOCAL,Pd,"cc_jointTexture",wr.SAMPLER2D,1);Kp.layouts.cc_jointTexture=Dd,Kp.bindings[Pd]=Od;var Md=Qp.SAMPLER_MORPH_POSITION,Nd=new ta(Md,no.SAMPLER_TEXTURE,1,jr.VERTEX),Ld=new Fo($p.LOCAL,Md,"cc_PositionDisplacements",wr.SAMPLER2D,1);Kp.layouts.cc_PositionDisplacements=Ld,Kp.bindings[Md]=Nd;var Bd=Qp.SAMPLER_MORPH_NORMAL,Fd=new ta(Bd,no.SAMPLER_TEXTURE,1,jr.VERTEX),zd=new Fo($p.LOCAL,Bd,"cc_NormalDisplacements",wr.SAMPLER2D,1);Kp.layouts.cc_NormalDisplacements=zd,Kp.bindings[Bd]=Fd;var Ud=Qp.SAMPLER_MORPH_TANGENT,kd=new ta(Ud,no.SAMPLER_TEXTURE,1,jr.VERTEX),Gd=new Fo($p.LOCAL,Ud,"cc_TangentDisplacements",wr.SAMPLER2D,1);Kp.layouts.cc_TangentDisplacements=Gd,Kp.bindings[Ud]=kd;var Hd=Qp.SAMPLER_LIGHTMAP,Vd=new ta(Hd,no.SAMPLER_TEXTURE,1,jr.FRAGMENT),jd=new Fo($p.LOCAL,Hd,"cc_lightingMap",wr.SAMPLER2D,1);Kp.layouts.cc_lightingMap=jd,Kp.bindings[Hd]=Vd;var Wd=Qp.SAMPLER_SPRITE,qd=new ta(Wd,no.SAMPLER_TEXTURE,1,jr.FRAGMENT),Xd=new Fo($p.LOCAL,Wd,"cc_spriteTexture",wr.SAMPLER2D,1);Kp.layouts.cc_spriteTexture=Xd,Kp.bindings[Wd]=qd;var Yd=Qp.SAMPLER_REFLECTION,Kd=new ta(Yd,no.SAMPLER_TEXTURE,1,jr.FRAGMENT),Qd=new Fo($p.LOCAL,Yd,"cc_reflectionTexture",wr.SAMPLER2D,1);Kp.layouts.cc_reflectionTexture=Qd,Kp.bindings[Yd]=Kd;var Zd=Qp.STORAGE_REFLECTION,Jd=new ta(Zd,no.STORAGE_IMAGE,1,jr.COMPUTE),$d=new ko($p.LOCAL,Zd,"cc_reflectionStorage",wr.IMAGE2D,1);Kp.layouts.cc_reflectionStorage=$d,Kp.bindings[Zd]=Jd;var em,tm,nm,im,rm,om=Gp.makeMaskExclude([Gp.BitMask.UI_2D,Gp.BitMask.GIZMOS,Gp.BitMask.EDITOR,Gp.BitMask.SCENE_GIZMO,Gp.BitMask.PROFILER]),am=Gp.makeMaskExclude([Gp.BitMask.UI_2D,Gp.BitMask.PROFILER]),sm=Gp.Enum.ALL;function cm(e){return e.hasFeature(br.COLOR_FLOAT)&&e.hasFeature(br.TEXTURE_FLOAT)&&!(e.gfxAPI===Tr.WEBGL)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:jp,PIPELINE_FLOW_FORWARD:Wp,PIPELINE_FLOW_SHADOW:qp,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Hp},get RenderPriority(){return Vp},globalDescriptorSetLayout:Yp,localDescriptorSetLayout:Kp,get PipelineGlobalBindings(){return Xp},get ModelLocalBindings(){return Qp},get SetIndex(){return $p},bindingMappingInfo:nd,UBOGlobal:id,UBOCamera:rd,UBOShadow:od,UNIFORM_SHADOWMAP_BINDING:ad,UNIFORM_ENVIRONMENT_BINDING:ld,UNIFORM_DIFFUSEMAP_BINDING:fd,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:dd,UBOLocal:gd,UBOWorldBound:yd,INST_MAT_WORLD:Sd,UBOLocalBatched:xd,UBOForwardLight:Td,UBODeferredLight:Ed,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:bd,UBOSkinningAnimation:Cd,INST_JOINT_ANIM_INFO:Ad,UBOSkinning:wd,UBOMorph:Rd,UBOUILocal:Id,UNIFORM_JOINT_TEXTURE_BINDING:Pd,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Md,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Bd,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Ud,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Hd,UNIFORM_SPRITE_TEXTURE_BINDING:Wd,UNIFORM_REFLECTION_TEXTURE_BINDING:Yd,UNIFORM_REFLECTION_STORAGE_BINDING:Zd,CAMERA_DEFAULT_MASK:om,CAMERA_EDITOR_MASK:am,MODEL_ALWAYS_MASK:sm,supportsHalfFloatTexture:function(e){return e.hasFeature(br.COLOR_HALF_FLOAT)&&e.hasFeature(br.TEXTURE_HALF_FLOAT)&&!(e.gfxAPI===Tr.WEBGL)},supportsFloatTexture:cm})),function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(em||(em={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(tm||(tm={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(nm||(nm={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(im||(im={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(rm||(rm={}));var lm,um,hm,fm,_m,pm,dm,mm=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],vm=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],gm=[100,200,400,800],ym=new yi,Sm=new yi,xm=new Ni,Tm=ao.STENCIL<<1,Em=[],bm=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=em.VERTICAL,this._fov=ti(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Eo(.2,.2,.2,1),this._viewport=new Xi(0,0,1,1),this._orientedViewport=new Xi(0,0,1,1),this._curTransform=Er.IDENTITY,this._isProjDirty=!0,this._matView=new Ni,this._matProj=new Ni,this._matProjInv=new Ni,this._matViewProj=new Ni,this._matViewProjInv=new Ni,this._frustum=new Qc,this._forward=new yi,this._position=new yi,this._priority=0,this._aperture=nm.F16_0,this._apertureValue=void 0,this._shutter=rm.D125,this._shutterValue=0,this._iso=im.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=ao.NONE,this._clearDepth=1,this._visibility=om,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=mm[this._aperture],this._shutterValue=vm[this._shutter],this._isoValue=gm[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!Em.length){var t=e.capabilities.clipSpaceSignY;Em[Er.IDENTITY]=new Ni(1,0,0,0,0,t),Em[Er.ROTATE_90]=new Ni(0,1,0,0,-t,0),Em[Er.ROTATE_180]=new Ni(-1,0,0,0,0,-t),Em[Er.ROTATE_270]=new Ni(0,-1,0,0,t,0)}}var t=e.prototype;return t._setWidth=function(e){this._width=e},t._setHeight=function(e){this._height=e},t._setScene=function(e){this._scene=e},t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||Er.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t._init=function(){},t.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=ao.NONE,this.clearDepth=1,this.visibility=om,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t._destroy=function(){},t.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},t.attachToScene=function(e){this._enabled=!0,this._setScene(e)},t.detachFromScene=function(){this._enabled=!1,this._setScene(null)},t.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())},t.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var n=!1;(this._node.hasChangedFlags||e)&&(Ni.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(t=this.window)||void 0===t?void 0:t.swapchain,r=i&&i.surfaceTransform||Er.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===tm.PERSPECTIVE)Ni.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===em.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;Ni.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}Ni.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(Ni.multiply(this._matViewProj,this._matProj,this._matView),Ni.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,n=e.x,i=e.width,r=e.height,o=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,a=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(a&&a.surfaceTransform||Er.IDENTITY){case Er.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case Er.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case Er.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case Er.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||i.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var n=t.swapchain;(n&&n.surfaceTransform||Er.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===tm.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Mi[this._curTransform];yi.set(ym,(t-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var f=ym.x,_=ym.y;return ym.x=f*h[0]+_*h[2]*u,ym.y=f*h[1]+_*h[3]*u,yi.transformMat4(l?ym:e.o,ym,this._matViewProjInv),l?(this._node.getWorldPosition(Sm),pr.fromPoints(e,Sm,ym)):yi.transformQuat(e.d,yi.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Mi[this._curTransform];if(this._proj===tm.PERSPECTIVE){yi.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,yi.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(ym),yi.lerp(e,ym,e,ei(this._nearClip/this._farClip,1,t.z))}else{yi.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,2*t.z-1);var f=e.x,_=e.y;e.x=f*l[0]+_*l[2]*c,e.y=f*l[1]+_*l[3]*c,yi.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this._device.capabilities.clipSpaceSignY,i=Mi[this._curTransform];yi.transformMat4(e,t,this._matViewProj);var r=e.x,o=e.y;e.x=r*i[0]+o*i[2]*n,e.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return e.x=c+.5*(e.x+1)*u,e.y=l+.5*(e.y+1)*h,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){Ni.multiply(e,this._matViewProj,t),Ni.multiply(e,Em[this._curTransform],e);var r=n/2,o=i/2;return Ni.identity(xm),Ni.transform(xm,xm,yi.set(ym,r,o,0)),Ni.scale(xm,xm,yi.set(ym,r,o,1)),Ni.multiply(e,xm,e),e},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},L(e,[{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"viewport",get:function(){return this._viewport},set:function(e){b(8302),this.setViewportInOrientedSpace(e)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=mm[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=vm[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=gm[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),Cm=1024;function Am(e){return!!(i.sys.hasFeature(i.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}!function(e){e[e.RGB565=Cr.R5G6B5]="RGB565",e[e.RGB5A1=Cr.RGB5A1]="RGB5A1",e[e.RGBA4444=Cr.RGBA4]="RGBA4444",e[e.RGB888=Cr.RGB8]="RGB888",e[e.RGB32F=Cr.RGB32F]="RGB32F",e[e.RGBA8888=Cr.RGBA8]="RGBA8888",e[e.RGBA32F=Cr.RGBA32F]="RGBA32F",e[e.A8=Cr.A8]="A8",e[e.I8=Cr.L8]="I8",e[e.AI8=Cr.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=Cr.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=Cr.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=Cm++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=Cr.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=Cr.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=Cm++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=Cr.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=Cm++]="RGBA_ETC1",e[e.RGB_ETC2=Cr.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=Cr.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=Cr.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=Cr.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=Cr.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=Cr.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=Cr.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=Cr.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=Cr.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=Cr.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=Cr.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=Cr.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=Cr.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=Cr.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=Cr.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=Cr.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(lm||(lm={})),function(e){e[e.REPEAT=zr.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=zr.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=zr.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=zr.BORDER]="CLAMP_TO_BORDER"}(um||(um={})),function(e){e[e.NONE=Fr.NONE]="NONE",e[e.LINEAR=Fr.LINEAR]="LINEAR",e[e.NEAREST=Fr.POINT]="NEAREST"}(hm||(hm={}));var wm,Rm,Im,Pm,Om,Dm,Mm,Nm,Lm,Bm,Fm,zm,Um=e("ImageAsset",sl("cc.ImageAsset")((dm=pm=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=lm.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}F(t,e);var n=t.prototype;return n.reset=function(e){Am(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Am(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var r,o=i.director.root?i.director.root.device:null,a=n.split("_"),s=Number.MAX_VALUE,c=this._format,l="",u=i.macro.SUPPORT_TEXTURE_FORMATS,h=W(a);!(r=h()).done;){var f=r.value.split("@"),_=parseInt(f[0],void 0),p=t.extnames[_]||f[0],d=u.indexOf(p);if(-1!==d&&d<s){var m=f[1]?parseInt(f[1]):this._format;if(!(".astc"!==p||o&&o.hasFeature(br.FORMAT_ASTC)))continue;if(!(".pvr"!==p||o&&o.hasFeature(br.FORMAT_PVRTC)))continue;if(!(m!==lm.RGB_ETC1&&m!==lm.RGBA_ETC1||o&&o.hasFeature(br.FORMAT_ETC1)))continue;if(!(m!==lm.RGB_ETC2&&m!==lm.RGBA_ETC2||o&&o.hasFeature(br.FORMAT_ETC2)))continue;if(".webp"===p&&!i.sys.hasFeature(i.sys.Feature.WEBP))continue;s=d,l=p,c=m}}l?(this._setRawAsset(l),this._format=c):b(3121)},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},L(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||Am(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||Am(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=lm.RGB_ETC1&&this._format<=lm.RGBA_ASTC_12x12||this._format>=lm.RGB_A_PVRTC_2BPPV1&&this._format<=lm.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),t}(zu),pm.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],pm._sharedPlaceHolderCanvas=null,X((_m=dm).prototype,"_nativeAsset",[Jl],Object.getOwnPropertyDescriptor(_m.prototype,"_nativeAsset"),_m.prototype),fm=_m))||fm);i.ImageAsset=Um,$e(Cr);var km=new te("Tex"),Gm=sl("cc.TextureBase")((zm=Fm=function(e){function t(){var t;return q(t=e.call(this)||this,"_format",Im,V(t)),q(t,"_minFilter",Pm,V(t)),q(t,"_magFilter",Om,V(t)),q(t,"_mipFilter",Dm,V(t)),q(t,"_wrapS",Mm,V(t)),q(t,"_wrapT",Nm,V(t)),q(t,"_wrapR",Lm,V(t)),q(t,"_anisotropy",Bm,V(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=new No,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=km.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=Ma(t._id,666),t}F(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){void 0===n&&(n=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var t,n=e.prototype.destroy.call(this);return n&&(null===(t=i.director.root)||void 0===t?void 0:t.batcher2D)&&i.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):A(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return i.director.root?i.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?lm.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===lm.RGBA_ETC1?e=lm.RGB_ETC1:e===lm.RGB_A_PVRTC_4BPPV1?e=lm.RGB_PVRTC_4BPPV1:e===lm.RGB_A_PVRTC_2BPPV1&&(e=lm.RGB_PVRTC_2BPPV1),e},L(t,[{key:"isCompressed",get:function(){return this._format>=lm.RGB_ETC1&&this._format<=lm.RGBA_ASTC_12x12||this._format>=lm.RGB_A_PVRTC_2BPPV1&&this._format<=lm.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(zu),Fm.PixelFormat=lm,Fm.WrapMode=um,Fm.Filter=hm,Im=X((Rm=zm).prototype,"_format",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lm.RGBA8888}}),Pm=X(Rm.prototype,"_minFilter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hm.LINEAR}}),Om=X(Rm.prototype,"_magFilter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hm.LINEAR}}),Dm=X(Rm.prototype,"_mipFilter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hm.NONE}}),Mm=X(Rm.prototype,"_wrapS",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return um.REPEAT}}),Nm=X(Rm.prototype,"_wrapT",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return um.REPEAT}}),Lm=X(Rm.prototype,"_wrapR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return um.REPEAT}}),Bm=X(Rm.prototype,"_anisotropy",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wm=Rm))||wm;i.TextureBase=Gm;var Hm=new WeakMap,Vm=new WeakSet,jm=new WeakSet;function Wm(e,t){var n;n=ch.safeFindClass;var i,r=Ph.pool.get();try{i=Hh(e,r,{classFinder:n,customEnv:t})}catch(e){throw d(e),Ph.pool.put(r),e}i._uuid=t.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:Su(h),owner:a[u],prop:s[u],type:He._getClassById(c[u])}}return Hm.set(i,l),i._native&&Vm.add(i),Ph.pool.put(r),i}var qm,Xm=new(function(){function e(){this._depends=new iu}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?B({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof gh){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var o=Wm(t,{__uuid__:e});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=e),cu.add(e+"@import",o)}catch(t){su.remove(e+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=Hm.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return Vm.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=Su(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var o=i[r];t[o]||(t[o]=!0,n.push(o),this._descend(o,t,n))}},e}()),Ym=[new xo];function Km(e){return e&&0==(e&e-1)}var Qm,Zm,Jm,$m,ev,tv,nv=sl("cc.SimpleTexture")(qm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t}F(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=Ym[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,Ym):i.copyTexImagesToTexture([e],this._gfxTexture,Ym)}}},n._assignImage=function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),tt.CLEANUP_IMAGE_CACHE)){var r=Xm.getDeps(this._uuid),o=r.indexOf(e._uuid);-1!==o&&(Q(r,o),e.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=Nr.NONE;this._mipFilter!==hm.NONE&&function(e,t,n){return!(e.gfxAPI===Tr.WEBGL)||Km(t)&&Km(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=Nr.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Mr.SAMPLED|Mr.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},L(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(Gm))||qm;i.SimpleTexture=nv;var iv,rv,ov,av,sv,cv,lv,uv=e("Texture2D",(Qm=sl("cc.Texture2D"),Zm=Hl([Um]),Qm((tv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",ev,V(t)),t}F(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.create=function(e,t,n,i){void 0===n&&(n=lm.RGBA8888),void 0===i&&(i=1),this.reset({width:e,height:t,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new Um,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,He._getClassId(Um))}},n._getGfxTextureCreateInfo=function(e){var t=new Do(Dr.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Um;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},L(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(nv),ev=X(($m=tv).prototype,"_mipmaps",[Zm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jm=$m))||Jm));i.Texture2D=uv,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(lv||(lv={}));var hv=e("TextureCube",sl("cc.TextureCube")((cv=sv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"isRGBE",ov,V(t)),q(t,"_mipmaps",av,V(t)),t}F(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],r=e.length/6,o=0;o<r;o++){var a=6*o;i.push({front:e[a+lv.front].image,back:e[a+lv.back].image,left:e[a+lv.left].image,right:e[a+lv.right].image,top:e[a+lv.top].image,bottom:e[a+lv.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var i=e+t;fv(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new Um,back:new Um,left:new Um,right:new Um,top:new Um,bottom:new Um};var o=i.mipmaps[r],a=He._getClassId(Um);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(e){var t=new Do(Dr.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Um;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},L(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){fv(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(nv),sv.FaceIndex=lv,ov=X((rv=cv).prototype,"isRGBE",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),av=X(rv.prototype,"_mipmaps",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iv=rv))||iv);function fv(e,t){t(e.front,lv.front),t(e.back,lv.back),t(e.left,lv.left),t(e.right,lv.right),t(e.top,lv.top),t(e.bottom,lv.bottom)}i.TextureCube=hv;var _v,pv,dv=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1813246314,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2766437914,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite-gpu",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite-gpu|sprite-vs-gpu:vert|sprite-fs-gpu:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"sprite-gpu|sprite-vs-gpu:vert|sprite-fs-gpu:frag",hash:2450198964,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCUILocal",defines:[]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_batch_id",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:2864919663,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:221,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:64},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_ENABLE_DIR_SHADOW",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:1774012115,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:182,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:64},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:1017881636,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:69,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:60},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_ENABLE_DIR_SHADOW",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:809389262,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:67,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3340914951,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:58},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_ENABLE_DIR_SHADOW",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_positionMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2954155677,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:215,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:58},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:3653711100,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),mv=4227858432,vv=66060288,gv=1044480,yv=function(e,t,n,i){return void 0===i&&(i=0),t<<26&mv|e<<20&vv|n<<12&gv|4095&i},Sv=function(e){return(e&mv)>>>26},xv=function(e){return(e&vv)>>>20},Tv=function(e){return(e&gv)>>>12},Ev=function(e){return 4095&e},bv=function(e,t){return 67108863&e|t<<26&mv},Cv=((_v={})[wr.UNKNOWN]=function(){return console.warn("illegal uniform handle")},_v[wr.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},_v[wr.INT2]=function(e,t,n){return void 0===n&&(n=0),zi.fromArray(t,e,n)},_v[wr.INT3]=function(e,t,n){return void 0===n&&(n=0),yi.fromArray(t,e,n)},_v[wr.INT4]=function(e,t,n){return void 0===n&&(n=0),Hi.fromArray(t,e,n)},_v[wr.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},_v[wr.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),zi.fromArray(t,e,n)},_v[wr.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),yi.fromArray(t,e,n)},_v[wr.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Hi.fromArray(t,e,n)},_v[wr.MAT3]=function(e,t,n){return void 0===n&&(n=0),Ei.fromArray(t,e,n)},_v[wr.MAT4]=function(e,t,n){return void 0===n&&(n=0),Ni.fromArray(t,e,n)},_v),Av=((pv={})[wr.UNKNOWN]=function(){return console.warn("illegal uniform handle")},pv[wr.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},pv[wr.INT2]=function(e,t,n){return void 0===n&&(n=0),zi.toArray(e,t,n)},pv[wr.INT3]=function(e,t,n){return void 0===n&&(n=0),yi.toArray(e,t,n)},pv[wr.INT4]=function(e,t,n){return void 0===n&&(n=0),Hi.toArray(e,t,n)},pv[wr.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},pv[wr.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),zi.toArray(e,t,n)},pv[wr.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),yi.toArray(e,t,n)},pv[wr.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Hi.toArray(e,t,n)},pv[wr.MAT3]=function(e,t,n){return void 0===n&&(n=0),Ei.toArray(e,t,n)},pv[wr.MAT4]=function(e,t,n){return void 0===n&&(n=0),Ni.toArray(e,t,n)},pv),wv=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Rv(e){switch(e){case wr.BOOL:case wr.INT:case wr.UINT:case wr.FLOAT:return wv[0];case wr.BOOL2:case wr.INT2:case wr.UINT2:case wr.FLOAT2:return wv[1];case wr.BOOL4:case wr.INT4:case wr.UINT4:case wr.FLOAT4:return wv[2];case wr.MAT4:return wv[3];case wr.SAMPLER2D:return"default-texture";case wr.SAMPLER_CUBE:return"default-cube-texture"}return wv[0]}function Iv(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var Pv=new na;function Ov(e){return Math.ceil(Math.log2(Math.max(e,2)))}function Dv(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function Mv(e,t,n,i,r){for(var o=e.builtins[i],a=[],s=function(e){var t=o.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&da))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.shaderInfo.blocks,a);for(var l=[],u=function(e){var t=o.samplerTextures[e],i=n.layouts[t.name],a=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&a&&a.descriptorType&ma))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function Nv(e){return e.members.reduce((function(e,t){return e+Ea(t.type)*t.count}),0)}function Lv(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function Bv(e){switch(e.gfxAPI){case Tr.GLES2:case Tr.WEBGL:return"glsl1";case Tr.GLES3:case Tr.WEBGL2:return"glsl3";default:return"glsl4"}}var Fv=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var n=0;n<e.techniques.length;n++)for(var i=e.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=B({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var o=t.range;r=Ov(o[1]-o[0]+1),t._map=function(e){return e-o[0]}}else"string"===t.type?(r=Ov(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Wo,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(Nv(l)),s.bindings.push(new ta(l.binding,no.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new Bo($p.MATERIAL,l.binding,l.name,l.members.map((function(e){return new Lo(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new ta(h.binding,no.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Fo($p.MATERIAL,h.binding,h.name,h.type,h.count))}for(var f=0;f<n.samplers.length;f++){var _=n.samplers[f];s.bindings.push(new ta(_.binding,no.SAMPLER,_.count,_.stageFlags)),s.shaderInfo.samplers.push(new zo($p.MATERIAL,_.binding,_.name,_.count))}for(var p=0;p<n.textures.length;p++){var d=n.textures[p];s.bindings.push(new ta(d.binding,no.TEXTURE,d.count,d.stageFlags)),s.shaderInfo.textures.push(new Uo($p.MATERIAL,d.binding,d.name,d.type,d.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new ta(v.binding,no.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Go($p.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new ta(y.binding,no.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new ko($p.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var S=0;S<n.subpassInputs.length;S++){var x=n.subpassInputs[S];s.bindings.push(new ta(x.binding,no.INPUT_ATTACHMENT,x.count,x.stageFlags)),s.shaderInfo.subpassInputs.push(new Ho($p.MATERIAL,x.binding,x.name,x.count))}s.gfxAttributes=[];for(var T=0;T<n.attributes.length;T++){var E=n.attributes[T];s.gfxAttributes.push(new jo(E.name,E.format,E.isNormalized,0,E.isInstanced,E.location))}Mv(n,s,Kp,"locals"),s.shaderInfo.stages.push(new Vo(jr.VERTEX,"")),s.shaderInfo.stages.push(new Vo(jr.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=yv(i.binding,s.type,s.count,o),o+=(Ea(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=yv(l.binding,l.type,l.count)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(Pv.bindings=r.bindings,r.setLayouts[$p.MATERIAL]=e.createDescriptorSetLayout(Pv),Pv.bindings=Kp.bindings,r.setLayouts[$p.LOCAL]=e.createDescriptorSetLayout(Pv)),r.setLayouts[n?$p.LOCAL:$p.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=t[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],f=t[h.name];f&&h._map&&(l|=h._map(f)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];v("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),Mv(a,s,Yp,"globals"),s.setLayouts[$p.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new ra(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=r.name,a=e[o],s=Dv(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=a.glsl3,h=Bv(e);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(e,t,n){for(var i=[],r=e.attributes,o=t.gfxAttributes,a=0;a<r.length;a++)Lv(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),this._cache[r]=e.createShader(s.shaderInfo)},e}());i.programLib=Fv;var zv,Uv,kv,Gv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute float a_batch_id;\nvarying vec2 v_uv0;\nvarying float v_uvMode;\nvarying vec4 v_uvSizeOffset;\nvarying vec4 v_uvParams0;\nvarying vec4 v_uvParams1;\nstruct SpriteVertexInternalData {\nvec4 rotation;\nvec3 translation;\nvec3 scale;\nvec4 uvSizeOffset;\nfloat uvMode;\nvec4 uvParams;\nfloat filltype;\n};\nuniform vec4 cc_local_data[(CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS - CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS) / 5 * 5];\nvec3 VectorTransformQuat (vec3 v, vec4 q) {\nreturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\nvoid CCSpriteInput(out SpriteVertexData i0) {\nvec4 data0 = cc_local_data[int(a_batch_id) * 5];\nvec4 data1 = cc_local_data[int(a_batch_id) * 5 + 1];\nvec4 data2 = cc_local_data[int(a_batch_id) * 5 + 2];\nvec4 data3 = cc_local_data[int(a_batch_id) * 5 + 3];\nvec4 data4 = cc_local_data[int(a_batch_id) * 5 + 4];\nfloat rg = data0.w;\nfloat r = floor(rg);\nfloat ba = data2.z;\nfloat b = floor(ba);\nSpriteVertexInternalData i1;\ni1.rotation = data1;\ni1.translation = data0.xyz;\ni1.scale = vec3(data2.xy, 1.0);\ni1.uvSizeOffset = data3;\ni1.filltype = fract(data2.w) * 10.0;\ni1.uvMode = data2.w;\ni1.uvParams = data4;\ni0.position = vec4(VectorTransformQuat(a_position * i1.scale, i1.rotation) + i1.translation, 1.0);\ni0.color = vec4(r * (1.0 / 255.0), rg - r, b * (1.0 / 255.0), ba - b);\nvec2 uvWithRotation;\nif (i1.uvSizeOffset.x < 0.0) {\ni1.uvSizeOffset.x = abs(i1.uvSizeOffset.x);\nuvWithRotation = vec2(1.0 - a_texCoord.y, a_texCoord.x);\n} else {\nuvWithRotation = a_texCoord;\n}\nif (i1.uvMode >= 3.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nv_uvParams0 = vec4(i1.uvParams.xy, i1.filltype, 0);\nif (i1.filltype >= 2.0) {\nv_uvParams1 = i1.uvParams;\n} else if (i1.filltype >= 1.0) {\nv_uvParams0 = vec4(1.0 - v_uvParams0.y, 1.0 - v_uvParams0.x, v_uvParams0.zw);\n}\n} else if (i1.uvMode >= 2.0) {\nv_uv0 = uvWithRotation * i1.uvParams.xy;\nv_uv0.y -= fract(i1.uvParams.y);\nv_uvSizeOffset = i1.uvSizeOffset;\n} else if (i1.uvMode >= 1.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nvec4 params0 = fract(i1.uvParams);\nvec4 params1 = floor(i1.uvParams) / 2048.0;\nv_uvParams0 = vec4(params0.xy, params1.xy);\nv_uvParams1 = vec4(params0.zw, params1.zw);\n} else {\nv_uv0 = uvWithRotation * i1.uvSizeOffset.xy + i1.uvSizeOffset.zw;\n}\nv_uvMode = i1.uvMode;\n#if SAMPLE_FROM_RT\nv_uv0 = cc_cameraPos.w > 1.0 ? vec2(v_uv0.x, 1.0 - v_uv0.y) : v_uv0;\n#endif\n}\nvarying vec4 v_color;\nvec4 vert () {\nSpriteVertexData i;\nCCSpriteInput(i);\nv_color = i.color;\nvec4 pos = i.position;\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\nvarying vec2 v_uv0;\nvarying float v_uvMode;\nvarying vec4 v_uvSizeOffset;\nvarying vec4 v_uvParams0;\nvarying vec4 v_uvParams1;\nvec2 evalSlicedUV(vec2 uv) {\nvec4 p0 = mix(vec4(0.0), v_uvParams0, step(v_uvParams0.xyxy, uv.xyxy));\np0 = mix(       p0, v_uvParams1, step(v_uvParams1.xyxy, uv.xyxy));\nvec4 p1 = mix(vec4(1.0), v_uvParams1, step(uv.xyxy, v_uvParams1.xyxy));\np1 = mix(       p1, v_uvParams0, step(uv.xyxy, v_uvParams0.xyxy));\nvec2 k = (p1.zw - p0.zw) / (p1.xy - p0.xy);\nvec2 b = (p1.xy * p0.zw - p0.xy * p1.zw) / (p1.xy - p0.xy);\nreturn k * uv + b;\n}\nfloat evalFilledUV(vec2 uv, float mode) {\nfloat alpha = 1.0;\nif (mode >= 2.0) {\nfloat start = v_uvParams1.x;\nfloat range = v_uvParams1.y;\nvec2 dir = uv - v_uvParams1.zw;\nfloat angle = -atan(dir.y, dir.x) * 0.3183098861838;\nif (range < 0.0) {\nangle += mix(0.0, -2.0, step(start, angle));\nalpha = step(start + range, angle);\n} else {\nangle += mix(0.0, 2.0, step(angle, start));\nalpha = step(angle, start + range);\n}\n} else if (mode >= 1.0) {\nif (uv.y >= v_uvParams0.x && uv.y <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n} else {\nif (uv.x >= v_uvParams0.x && uv.x <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n}\nreturn alpha;\n}\nvoid CCSpriteInput(out SpriteFragmentData i) {\n#if USE_TEXTURE\nif(v_uvMode >= 3.0) {\ni.uv = v_uv0 * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 2.0) {\ni.uv = fract(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 1.0) {\ni.uv = evalSlicedUV(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else {\ni.uv = v_uv0;\n}\n#endif\n}\nvec4 CCSpriteSample(sampler2D tex, vec2 uv) {\nvec4 o = CCSampleWithAlphaSeparated(tex, uv);\nif (v_uvMode >= 3.0) {\no.a *= evalFilledUV(v_uv0, v_uvParams0.z);\n}\nreturn o;\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec4 v_color;\n#if USE_TEXTURE\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nSpriteFragmentData i;\nCCSpriteInput(i);\n#if USE_TEXTURE\nvec4 color = v_color * CCSpriteSample(cc_spriteTexture, i.uv);\n#else\nvec4 color = v_color;\n#endif\n#if IS_GRAY\ncolor.rgb = SRGBToLinear(color.rgb);\ncolor.rgb = vec3(dot(color.rgb, vec3(0.2126, 0.7152, 0.0722)));\ncolor.rgb = sqrt(color.rgb);\n#endif\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_positionMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 positionMap = gl_LastFragData[1];\nvec4 normalMap = gl_LastFragData[2];\nvec4 emissiveMap = gl_LastFragData[3];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture2D(gbuffer_positionMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(s.position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[3] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec2 a_texCoord;\nin float a_batch_id;\nout vec2 v_uv0;\nout float v_uvMode;\nout vec4 v_uvSizeOffset;\nout vec4 v_uvParams0;\nout vec4 v_uvParams1;\nstruct SpriteVertexInternalData {\nvec4 rotation;\nvec3 translation;\nvec3 scale;\nvec4 uvSizeOffset;\nfloat uvMode;\nvec4 uvParams;\nfloat filltype;\n};\nlayout(std140) uniform CCUILocal {\nvec4 cc_local_data[(CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS - CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS) / 5 * 5];\n};\nvec3 VectorTransformQuat (vec3 v, vec4 q) {\nreturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\nvoid CCSpriteInput(out SpriteVertexData i0) {\nvec4 data0 = cc_local_data[int(a_batch_id) * 5];\nvec4 data1 = cc_local_data[int(a_batch_id) * 5 + 1];\nvec4 data2 = cc_local_data[int(a_batch_id) * 5 + 2];\nvec4 data3 = cc_local_data[int(a_batch_id) * 5 + 3];\nvec4 data4 = cc_local_data[int(a_batch_id) * 5 + 4];\nfloat rg = data0.w;\nfloat r = floor(rg);\nfloat ba = data2.z;\nfloat b = floor(ba);\nSpriteVertexInternalData i1;\ni1.rotation = data1;\ni1.translation = data0.xyz;\ni1.scale = vec3(data2.xy, 1.0);\ni1.uvSizeOffset = data3;\ni1.filltype = fract(data2.w) * 10.0;\ni1.uvMode = data2.w;\ni1.uvParams = data4;\ni0.position = vec4(VectorTransformQuat(a_position * i1.scale, i1.rotation) + i1.translation, 1.0);\ni0.color = vec4(r * (1.0 / 255.0), rg - r, b * (1.0 / 255.0), ba - b);\nvec2 uvWithRotation;\nif (i1.uvSizeOffset.x < 0.0) {\ni1.uvSizeOffset.x = abs(i1.uvSizeOffset.x);\nuvWithRotation = vec2(1.0 - a_texCoord.y, a_texCoord.x);\n} else {\nuvWithRotation = a_texCoord;\n}\nif (i1.uvMode >= 3.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nv_uvParams0 = vec4(i1.uvParams.xy, i1.filltype, 0);\nif (i1.filltype >= 2.0) {\nv_uvParams1 = i1.uvParams;\n} else if (i1.filltype >= 1.0) {\nv_uvParams0 = vec4(1.0 - v_uvParams0.y, 1.0 - v_uvParams0.x, v_uvParams0.zw);\n}\n} else if (i1.uvMode >= 2.0) {\nv_uv0 = uvWithRotation * i1.uvParams.xy;\nv_uv0.y -= fract(i1.uvParams.y);\nv_uvSizeOffset = i1.uvSizeOffset;\n} else if (i1.uvMode >= 1.0) {\nv_uv0 = uvWithRotation;\nv_uvSizeOffset = i1.uvSizeOffset;\nvec4 params0 = fract(i1.uvParams);\nvec4 params1 = floor(i1.uvParams) / 2048.0;\nv_uvParams0 = vec4(params0.xy, params1.xy);\nv_uvParams1 = vec4(params0.zw, params1.zw);\n} else {\nv_uv0 = uvWithRotation * i1.uvSizeOffset.xy + i1.uvSizeOffset.zw;\n}\nv_uvMode = i1.uvMode;\n#if SAMPLE_FROM_RT\nv_uv0 = cc_cameraPos.w > 1.0 ? vec2(v_uv0.x, 1.0 - v_uv0.y) : v_uv0;\n#endif\n}\nout vec4 v_color;\nvec4 vert () {\nSpriteVertexData i;\nCCSpriteInput(i);\nv_color = i.color;\nvec4 pos = i.position;\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nstruct SpriteVertexData {\nvec4 position;\nvec4 color;\n};\nstruct SpriteFragmentData {\nvec2 uv;\n};\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\nin vec2 v_uv0;\nin float v_uvMode;\nin vec4 v_uvSizeOffset;\nin vec4 v_uvParams0;\nin vec4 v_uvParams1;\nvec2 evalSlicedUV(vec2 uv) {\nvec4 p0 = mix(vec4(0.0), v_uvParams0, step(v_uvParams0.xyxy, uv.xyxy));\np0 = mix(       p0, v_uvParams1, step(v_uvParams1.xyxy, uv.xyxy));\nvec4 p1 = mix(vec4(1.0), v_uvParams1, step(uv.xyxy, v_uvParams1.xyxy));\np1 = mix(       p1, v_uvParams0, step(uv.xyxy, v_uvParams0.xyxy));\nvec2 k = (p1.zw - p0.zw) / (p1.xy - p0.xy);\nvec2 b = (p1.xy * p0.zw - p0.xy * p1.zw) / (p1.xy - p0.xy);\nreturn k * uv + b;\n}\nfloat evalFilledUV(vec2 uv, float mode) {\nfloat alpha = 1.0;\nif (mode >= 2.0) {\nfloat start = v_uvParams1.x;\nfloat range = v_uvParams1.y;\nvec2 dir = uv - v_uvParams1.zw;\nfloat angle = -atan(dir.y, dir.x) * 0.3183098861838;\nif (range < 0.0) {\nangle += mix(0.0, -2.0, step(start, angle));\nalpha = step(start + range, angle);\n} else {\nangle += mix(0.0, 2.0, step(angle, start));\nalpha = step(angle, start + range);\n}\n} else if (mode >= 1.0) {\nif (uv.y >= v_uvParams0.x && uv.y <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n} else {\nif (uv.x >= v_uvParams0.x && uv.x <= v_uvParams0.y) {\nalpha = 1.0;\n} else {\nalpha = 0.0;\n}\n}\nreturn alpha;\n}\nvoid CCSpriteInput(out SpriteFragmentData i) {\n#if USE_TEXTURE\nif(v_uvMode >= 3.0) {\ni.uv = v_uv0 * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 2.0) {\ni.uv = fract(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else if (v_uvMode >= 1.0) {\ni.uv = evalSlicedUV(v_uv0) * v_uvSizeOffset.xy + v_uvSizeOffset.zw;\n} else {\ni.uv = v_uv0;\n}\n#endif\n}\nvec4 CCSpriteSample(sampler2D tex, vec2 uv) {\nvec4 o = CCSampleWithAlphaSeparated(tex, uv);\nif (v_uvMode >= 3.0) {\no.a *= evalFilledUV(v_uv0, v_uvParams0.z);\n}\nreturn o;\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec4 v_color;\n#if USE_TEXTURE\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nSpriteFragmentData i;\nCCSpriteInput(i);\n#if USE_TEXTURE\nvec4 color = v_color * CCSpriteSample(cc_spriteTexture, i.uv);\n#else\nvec4 color = v_color;\n#endif\n#if IS_GRAY\ncolor.rgb = SRGBToLinear(color.rgb);\ncolor.rgb = vec3(dot(color.rgb, vec3(0.2126, 0.7152, 0.0722)));\ncolor.rgb = sqrt(color.rgb);\n#endif\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW && CC_ENABLE_DIR_SHADOW\nif (NL > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_screenSize.x / float(16));\nfloat clusterSizeY = ceil(cc_screenSize.y / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(s.position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_positionMap;\nlayout(location = 2) inout vec4 gbuffer_normalMap;\nlayout(location = 3) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_positionMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 positionMap = gbuffer_positionMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(s.position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Hv=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;var n=this._resources,r=document.createElement("canvas"),o=r.getContext("2d"),a=new Um(r),s=r.width=r.height=2;o.fillStyle="#000",o.fillRect(0,0,s,s);var c=new uv;c._uuid="black-texture",c.image=a,n[c._uuid]=c,o.fillStyle="rgba(0,0,0,0)",o.fillRect(0,0,s,s);var l=new uv;l._uuid="empty-texture",l.image=a,n[l._uuid]=l;var u=new hv;u._uuid="black-cube-texture",u.setMipFilter(hv.Filter.NEAREST),u.image={front:new Um(r),back:new Um(r),left:new Um(r),right:new Um(r),top:new Um(r),bottom:new Um(r)},n[u._uuid]=u,o.fillStyle="#777",o.fillRect(0,0,s,s);var h=new uv;h._uuid="grey-texture",h.image=a,n[h._uuid]=h,o.fillStyle="#fff",o.fillRect(0,0,s,s);var f=new uv;f._uuid="white-texture",f.image=a,n[f._uuid]=f;var _=new hv;_._uuid="white-cube-texture",_.setMipFilter(hv.Filter.NEAREST),_.image={front:new Um(r),back:new Um(r),left:new Um(r),right:new Um(r),top:new Um(r),bottom:new Um(r)},n[_._uuid]=_,o.fillStyle="#7f7fff",o.fillRect(0,0,s,s);var p=new uv;p._uuid="normal-texture",p.image=a,n[p._uuid]=p,r.width=r.height=16,o.fillStyle="#ddd",o.fillRect(0,0,16,16),o.fillStyle="#555",o.fillRect(0,0,8,8),o.fillStyle="#555",o.fillRect(8,8,8,8);var d=new uv;d._uuid="default-texture",d.image=a,n[d._uuid]=d;var m=new hv;if(m.setMipFilter(hv.Filter.NEAREST),m._uuid="default-cube-texture",m.image={front:new Um(r),back:new Um(r),left:new Um(r),right:new Um(r),top:new Um(r),bottom:new Um(r)},n[m._uuid]=m,i.SpriteFrame){var v=new i.SpriteFrame,g=a,y=new uv;y.image=g,v.texture=y,v._uuid="default-spriteframe",n[v._uuid]=v}var S=Bv(e);if(!S)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var x=Gv[S];return x?Promise.resolve().then((function(){dv.forEach((function(e,t){var n=Object.assign(new i.EffectAsset,e);n.shaders.forEach((function(e,n){var i=x[t][n];i&&(e[S]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+S+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new i.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var r=new i.Material;r._uuid="missing-effect-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",i.color("#ffff00")),e[r._uuid]=r,t.push(r);var o=new i.Material;o._uuid="missing-material",o.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),o.setProperty("mainColor",i.color("#ff00ff")),e[o._uuid]=o,t.push(o);var a=new i.Material;a._uuid="default-clear-stencil",a.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[a._uuid]=a,t.push(a);var s=new i.Material;s._uuid="ui-base-material",s.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var c=new i.Material;c._uuid="ui-sprite-material",c.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var l=new i.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[l._uuid]=l,t.push(l);var u=new i.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var h=new i.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var f=new i.Material;f._uuid="ui-sprite-gray-alpha-sep-material",f.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[f._uuid]=f,t.push(f);var _=new i.Material;_._uuid="ui-graphics-material",_.initialize({effectName:"graphics"}),e[_._uuid]=_,t.push(_);var p=new i.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),e[p._uuid]=p,t.push(p);var d=new i.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),e[d._uuid]=d,t.push(d);var m=new i.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);var v=new i.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),e[v._uuid]=v,t.push(v);var g=new i.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[g._uuid]=g,t.push(g),i.game.on(i.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),Vv=e("builtinResMgr",i.builtinResMgr=new Hv),jv=e("getPhaseID",(zv=new Map,Uv=0,function(e){return"number"==typeof e?e:(zv.has(e)||(zv.set(e,1<<Uv),Uv++),zv.get(e))})),Wv=e("InstancedBuffer",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var r=t.buffer.length;if(r){var o=e.inputAssembler,a=e.descriptorSet.getTexture(Hd),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,f=u.data;u.data=new Uint8Array(h),u.data.set(f),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var _=this._device.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,32*r,r)),p=new Uint8Array(32*r),d=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],S=new jo(y.name,y.format,y.isNormalized,d.length,!0);m.push(S)}p.set(t.buffer),d.push(_);var x=new qo(m,d,v),T=this._device.createInputAssembler(x);this.instances.push({count:1,capacity:32,vb:_,data:p,ia:T,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}()),qv=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var f=this.batches[h];if(f.vbs.length===i.length&&f.mergeCount<xd.BATCHING_COUNT){u=!0;for(var _=0;_<f.vbs.length;++_)if(f.vbs[_].stride!==i[_].stride){u=!1;break}if(u){for(var p=0;p<f.vbs.length;++p){var d=i[p],m=f.vbs[p],v=f.vbDatas[p];(r=(a+f.vbCount)*d.stride)>m.size&&(m.resize(r),f.vbDatas[p]=new Uint8Array(r),f.vbDatas[p].set(v)),f.vbDatas[p].set(d.buffer,f.vbCount*d.stride)}var g=f.vbIdxData;(o=4*(a+f.vbCount))>f.vbIdx.size&&(f.vbIdx.resize(o),f.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),f.vbIdxData.set(g),g=f.vbIdxData);var y=f.vbCount,S=y+a,x=f.mergeCount;if(g[y]!==x||g[S-1]!==x)for(var T=y;T<S;T++)g[T]=x+.1;return Ni.toArray(f.uboData,n.transform.worldMatrix,xd.MAT_WORLDS_OFFSET+16*f.mergeCount),f.mergeCount||(l.bindBuffer(xd.BINDING,f.ubo),l.update(),f.pass=s,f.shader=c,f.descriptorSet=l),++f.mergeCount,f.vbCount+=a,void(f.ia.vertexCount+=a)}}}for(var E=[],b=[],C=[],A=0;A<i.length;++A){var w=i[A],R=this._device.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,w.count*w.stride,w.stride));R.update(w.buffer.buffer),E.push(R),b.push(new Uint8Array(R.size)),C.push(R)}var I=this._device.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,4*a,4)),P=new Float32Array(a);P.fill(0),I.update(P),C.push(I);for(var O=e.inputAssembler.attributes,D=new Array(O.length+1),M=0;M<O.length;++M)D[M]=O[M];D[O.length]=new jo("a_dyn_batch_id",Cr.R32F,!1,i.length);var N=new qo(D,C),L=this._device.createInputAssembler(N),B=this._device.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,xd.SIZE,xd.SIZE));l.bindBuffer(xd.BINDING,B),l.update();var F=new Float32Array(xd.COUNT);Ni.toArray(F,n.transform.worldMatrix,xd.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:E,vbDatas:b,vbIdx:I,vbIdxData:P,vbCount:a,ia:L,ubo:B,uboData:F,pass:s,shader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}(),Xv=new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.DEVICE),Yv=new Ro(null),Kv=new ia(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(kv||(kv={}));var Qv=function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Ga,this._dss=new Ua,this._rs=new za,this._priority=Vp.DEFAULT,this._stage=Hp.DEFAULT,this._phase=jv("default"),this._primitive=Qr.TRIANGLE_LIST,this._batchingScheme=kv.NONE,this._dynamicStates=eo.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(jv(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t,n=Fv.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return n+=function(e){for(var t,n=",bs,"+e.isA2C,i=W(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(e._bs),n+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),Ma(n+=",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=wr.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=bv(i,n):t&&(i=bv(i,Sv(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);Av[r](a,n,o),this._setRootBufferDirty(!0)},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);return Cv[r](a,n,o)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=Ea(r)>>2,a=this._getBlockView(r,i),s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=o)null!==n[c]&&Av[r](a,n[c],s);this._setRootBufferDirty(!0)},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t._setRootBufferDirty=function(e){this._rootBufferDirty=e},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):A(12006)},t.getInstancedBuffer=function(e){return void 0===e&&(e=0),this._instancedBuffers[e]||(this._instancedBuffers[e]=new Wv(this))},t.getBatchedBuffer=function(e){return void 0===e&&(e=0),this._batchedBuffers[e]||(this._batchedBuffers[e]=new qv(this))},t._initNative=function(){},t._destroy=function(){},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},t.resetUniform=function(t){var n=this.getHandle(t);if(n){for(var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),o=e.getOffsetFromHandle(n),a=e.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[t],l=c&&c.value||Rv(i),u=(Ea(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),o=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":Rv(r),l=Vv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?qa.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),f=this._device.getSampler(h);this._descriptorSet.bindSampler(o,f,n),this._descriptorSet.bindTexture(o,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=0,i=0;i<t.members.length;i++){for(var r=t.members[i],o=this._getBlockView(r.type,t.binding),a=this._properties[r.name],s=a&&a.value||Rv(r.type),c=(Ea(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=Fv.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout(Fv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=Fv.getGFXShader(this._device,this._programName,this._defines,t),o=0;o<e.length;o++){var a=e[o];delete this._defines[a.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._setPriority=function(e){this._priority=e},t._setStage=function(e){this._stage=e},t._setPhase=function(e){this._phase=e},t._setPrimitive=function(e){this._primitive=e},t._setState=function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i},t._doInit=function(t,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(Vp.DEFAULT),this._setStage(Hp.DEFAULT),this._setPhase(jv("default")),this._setPrimitive(Qr.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?B({},t.defines):t.defines,this._shaderInfo=Fv.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),Kv.layout=Fv.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(Kv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=Fv.getTemplateInfo(t.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,f=0;f<r.length;f++){var _=a[f];l.push(h),h+=Math.ceil(_/c)*c,u=_}var p=l[l.length-1]+u;p&&(Xv.size=16*Math.ceil(p/16),this._rootBuffer=i.createBuffer(Xv),this._rootBlock=new ArrayBuffer(p));for(var d=0,m=0;d<r.length;d++){var v=r[d].binding,g=a[d];Yv.buffer=this._rootBuffer,Yv.offset=l[m++],Yv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Yv);this._blocks[v]=new Float32Array(this._rootBlock,Yv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var S=this._propertyHandleMap=s,x={};for(var T in this._properties){var E=this._properties[T];E.handleInfo&&(x[T]=this.getHandle.apply(this,E.handleInfo))}Object.assign(S,x)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(br.INSTANCED_ARRAYS)?this._setBatchingScheme(kv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(kv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(kv.VB_MERGING):this._setBatchingScheme(kv.NONE)},t._setBatchingScheme=function(e){this._batchingScheme=e},t._setDynamicState=function(e){this._dynamicStates=e},t._setHash=function(e){this._hash=e},t._getBlockView=function(e,t){return e<wr.FLOAT?this._blocksInt[t]:this._blocks[t]},t._setPipelineLayout=function(e){this._pipelineLayout=e},t._initPassFromTarget=function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(Fv.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)},L(e,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Fv.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}();Qv.getTypeFromHandle=Sv,Qv.getBindingFromHandle=xv,Qv.getCountFromHandle=Tv,Qv.getOffsetFromHandle=Ev;var Zv,Jv=new ia(null),$v=function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Vp.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._createWorldBoundDescriptorSet=function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,n){void 0===n&&(n=null);var r=i.director.root;this._device=r.device,Jv.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(Jv);var o=i.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),a=new ia(null);if(a.layout=o.localSetLayout,this._createWorldBoundDescriptorSet(a),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===kv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Vp.DEFAULT,t[0].phase===jv("reflection")){var s=r.mainWindow.width,c=r.mainWindow.height,l=512;c<s?(s=l*s/c,c=l):c=l*c/(s=l),this._reflectionTex=this._device.createTexture(new Do(Dr.TEX2D,Mr.STORAGE|Mr.TRANSFER_SRC|Mr.SAMPLED,Cr.RGBA8,s,c)),this.descriptorSet.bindTexture(Yd,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new No(Fr.LINEAR,Fr.LINEAR,Fr.NONE,zr.CLAMP,zr.CLAMP,zr.CLAMP)),this.descriptorSet.bindSampler(Yd,this._reflectionSampler),this.descriptorSet.bindTexture(Zd,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=i.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=i.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Vp.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},L(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?A(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===kv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),Jv.layout=e[0].localSetLayout,this._createDescriptorSet(Jv)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===kv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}(),eg=new Ni,tg=[{name:"CC_ENABLE_DIR_SHADOW",value:!0},{name:"CC_RECEIVE_SHADOW",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Zv||(Zv={}));var ng,ig,rg=new No(Fr.LINEAR,Fr.LINEAR,Fr.NONE,zr.CLAMP,zr.CLAMP,zr.CLAMP),og=new No(Fr.LINEAR,Fr.LINEAR,Fr.LINEAR,zr.CLAMP,zr.CLAMP,zr.CLAMP),ag=function(){function e(){this.type=Zv.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(gd.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Hi,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=Gp.Enum.NONE,this._device=i.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Gp.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t._applyWorldBoundBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){Ni.toArray(this._localData,i,gd.MAT_WORLD_OFFSET),Ni.inverseTranspose(eg,i);var a=Math.abs(Ni.determinant(eg)),s=1/Math.sqrt(a);Ni.multiplyScalar(eg,eg,s),Ni.toArray(this._localData,eg,gd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=zc.fromPoints(zc.create(),e,t),this._worldBounds=zc.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new $v},t.initSubModel=function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){Hi.toArray(this._localData,t,gd.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=Vv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=this._device.getSampler(e.mipmaps.length>1?og:rg),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(Hd,n),a.bindSampler(Hd,i),a.update()}},t.getMacroPatches=function(){return this.receiveShadow?tg:null},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(br.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=pa[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new jo;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=pa[c.format],h=new(ba(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}t.batchingScheme===kv.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(Sd)),this._localDataUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.DEVICE,gd.SIZE,gd.SIZE)),this._applyLocalBuffer())},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.DEVICE,yd.SIZE,yd.SIZE)),this._applyWorldBoundBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(gd.BINDING,this._localBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(yd.BINDING,this._worldBoundBuffer)},L(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(ng||(ng={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(ig||(ig={})),i.internal.TransformBit=ig;var sg,cg,lg,ug,hg,fg,_g,pg,dg=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,!0},t.activate=function(){},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t._destroy=function(){},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=W(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=ig.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=W(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=W(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._createNativeObject=function(){},L(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),e}(),mg=e("EffectAsset",sl("cc.EffectAsset")((pg=_g=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"techniques",lg,V(t)),q(t,"shaders",ug,V(t)),q(t,"combinations",hg,V(t)),q(t,"hideInEditor",fg,V(t)),t}F(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name].equals(e)&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){Fv.register(this),t.register(this),i.game.once(i.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=i.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],o=0;o<i.length;++o){var a=B({},n);a[t]=i[o],e.push(a)}return e}),[])}),[{}]).forEach((function(e){return Fv.getGFXShader(t.device,i.name,e,t.pipeline)}))},r=0;r<this.shaders.length;r++)n(r)},n.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(zu),_g._effects={},lg=X((cg=pg).prototype,"techniques",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ug=X(cg.prototype,"shaders",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hg=X(cg.prototype,"combinations",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fg=X(cg.prototype,"hideInEditor",[_l,dl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sg=cg))||sg);i.EffectAsset=mg;var vg=e("PipelineStateManager",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,r){var o=t.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=t.pipelineLayout,c=new oa(r.attributes),l=new Ha(n,s,i,c,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},e}());vg._PSOHashMap=new Map;var gg=new To,yg=new po;function Sg(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var xg,Tg,Eg,bg,Cg,Ag,wg,Rg,Ig,Pg,Og=null;function Dg(e,t,n,i,r){if(i&&i.enabled&&r===Og){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;gg.width=yg.width=r.window.width,gg.height=yg.height=r.window.height;var u=vg.getOrCreatePipelineState(e,s[0],c[0],t,a);n.setViewport(gg),n.setScissor(yg),n.bindPipelineState(u),n.bindDescriptorSet($p.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet($p.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var Mg=new Hi,Ng=e("Material",(xg=sl("cc.Material"),Tg=Hl(mg),xg((Pg=function(e){function t(){var t;return q(t=e.call(this)||this,"_effectAsset",Cg,V(t)),q(t,"_techIdx",Ag,V(t)),q(t,"_defines",wg,V(t)),q(t,"_states",Rg,V(t)),q(t,"_props",Ig,V(t)),t._passes=[],t._hash=0,t}F(t,e),t.getHash=function(e){for(var t,n=0,i=W(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._passes.length?b(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=mg.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update())},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=W(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},n.copy=function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=B({},e._props[t]);this._defines.length=e._defines.length;for(var n=0;n<e._defines.length;n++)this._defines[n]=B({},e._defines[n]);this._states.length=e._states.length;for(var i=0;i<e._states.length;i++)this._states[i]=B({},e._states[i]);this._effectAsset=e._effectAsset,this._update()},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],r=0;r<t;++r){var o=e.passes[r],a=o.passIndex=r,s=o.defines=this._defines[a]||(this._defines[a]={});if(o.stateOverrides=this._states[a]||(this._states[a]={}),void 0!==o.propertyIndex&&Object.assign(s,this._defines[o.propertyIndex]),void 0!==o.embeddedMacros&&Object.assign(s,o.embeddedMacros),!o.switch||s[o.switch]){var c=new Qv(i.director.root);c.initialize(o),n.push(c)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var r in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;if(Qv.getTypeFromHandle(i)<wr.SAMPLER1D)if(Array.isArray(n))e.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=e.properties[t])||void 0===r?void 0:r.linear){var o=n;Sg(Mg,o),Mg.w=o.w,n=Mg}e.setUniform(i,n)}else e.resetUniform(t);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(e,i,n[a],a);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var r=Qv.getBindingFromHandle(t);if(n instanceof Ya)e.bindTexture(r,n,i);else if(n instanceof Gm){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;e.bindTexture(r,o,i),e.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=W(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new vi("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},L(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(zu),Cg=X((bg=Pg).prototype,"_effectAsset",[Tg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ag=X(bg.prototype,"_techIdx",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wg=X(bg.prototype,"_defines",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rg=X(bg.prototype,"_states",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ig=X(bg.prototype,"_props",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Eg=bg))||Eg));i.Material=Ng;var Lg=Qe({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Bg=Qe({Planar:0,ShadowMap:1}),Fg=Qe({HARD:0,SOFT:1,SOFT_2X:2}),zg=Bg.ShadowMap+1,Ug=function(){function e(){this.fixedSphere=new so(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Ni,this.matShadowProj=new Ni,this.matShadowViewProj=new Ni,this._normal=new yi(0,1,0),this._shadowColor=new vi(0,0,0,76),this._matLight=new Ni,this._material=null,this._instancingMaterial=null,this._size=new zi(512,512),this._enabled=!1,this._distance=0,this._type=zg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new Ng,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new Ng,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},t._setEnable=function(e){this._enabled=e},t._setType=function(e){this._type=this.enabled?e:zg},t.initialize=function(e){this.near=e.near,this.far=e.far,this.invisibleOcclusionRange=e.invisibleOcclusionRange,this.shadowDistance=e.shadowDistance,this.orthoSize=e.orthoSize,this.size=e.size,this.pcf=e.pcf,this.normal=e.normal,this.distance=e.distance,this.shadowColor=e.shadowColor,this.bias=e.bias,this.normalBias=e.normalBias,this.maxReceived=e.maxReceived,this.fixedArea=e.fixedArea,this._setEnable(e.enabled),this._setType(e.type),this.saturation=e.saturation},t.activate=function(){if(this.enabled)this.type===Bg.ShadowMap?this._updatePipeline():this._updatePlanarInfo();else{var e=i.director.root;e.pipeline.macros.CC_ENABLE_DIR_SHADOW=0,e.onGlobalPipelineStateChanged()}},t._updatePlanarInfo=function(){this._material||(this._material=new Ng,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Ng,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}));var e=i.director.root;e.pipeline.macros.CC_ENABLE_DIR_SHADOW=0,e.onGlobalPipelineStateChanged()},t._updatePipeline=function(){var e=i.director.root;e.pipeline.macros.CC_ENABLE_DIR_SHADOW=1,e.onGlobalPipelineStateChanged()},t._destroy=function(){},t.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},L(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){yi.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"near",get:function(){return this._near},set:function(e){this._near=e}},{key:"far",get:function(){return this._far},set:function(e){this._far=e}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e}},{key:"saturation",get:function(){return this._saturation},set:function(e){this._saturation=e}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),e}();Ug.MAX_FAR=2e3,Ug.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),i.Shadows=Ug,Un(dg.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Un(dg.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var kg={};Un(kg,"CameraVisFlags",[{name:"GENERAL"}]),zn(kg,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Gp.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Gp.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Gp.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Gp.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Gp.BitMask,targetName:"UI_2D"}]),i.CameraVisFlags=kg;var Gg,Hg={};function Vg(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}Un(Hg,"VisibilityFlags",[{name:"GENERAL"}]),zn(Hg,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Gp.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Gp.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Gp.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Gp.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Gp.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Gp.Enum,targetName:"UI_2D"}]),i.VisibilityFlags=Hg,zn(Qv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),Un(bm.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),Un(Ug.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(Gg||(Gg={}));var jg=function(e){return 4*Math.PI*Math.PI*e*e},Wg=function(){function e(){this._baked=!1,this._color=new yi(1,1,1),this._colorTemp=6550,this._colorTempRGB=new yi(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Gg.UNKNOWN}var t=e.prototype;return t._init=function(){},t._destroy=function(){},t.initialize=function(){this._init(),this.color=new yi(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._destroy()},t.update=function(){},L(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,Vg(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=ig.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}(),qg=new yi(0,0,-1),Xg=new yi,Yg=function(e){function t(){var t;return(t=e.call(this)||this)._dir=new yi(1,-1,-1),t._illuminanceHDR=Ji.SUN_ILLUM,t._illuminanceLDR=1,t._type=Gg.DIRECTIONAL,t}F(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=Ji.SUN_ILLUM,this.direction=new yi(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=yi.transformQuat(Xg,qg,this._node.worldRotation))},L(t,[{key:"direction",get:function(){return this._dir},set:function(e){yi.normalize(this._dir,e)}},{key:"illuminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}}]),t}(Wg),Kg=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var f=c._descriptorSet.getSampler(u.binding,h),_=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,f,h),i._descriptorSet.bindTexture(u.binding,_,h)}return e.prototype.tryCompile.call(V(i)),i}F(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),Qv.fillPipelineInfo(this,e),Qv.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!Iv(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(kv.NONE)},n._onStateChange=function(){this._setHash(Qv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},L(t,[{key:"parent",get:function(){return this._parent}}]),t}(Qv),Qg=function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}F(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=W(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in e)o[a]=e[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=Ng.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new Kg(t[n],this));return e},L(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(Ng),Zg=null,Jg=null,$g=function(){function e(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setUseHDR=function(e){this._useHDR=e},t._setUseDiffuseMap=function(e){this._useDiffuseMap=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)},t.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t;var n=i.director.root;n.pipeline.pipelineSceneData.isHDR?e&&(n.pipeline.pipelineSceneData.ambient.groundAlbedo.w=e.mipmapLevel):t&&(n.pipeline.pipelineSceneData.ambient.groundAlbedo.w=t.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},t.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.activate=function(){var e=i.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=Vv.get("default-cube-texture"),this._model||(this._model=i.director.root.createModel(i.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var t=this._default.isRGBE;if(this.envmap&&(t=this.envmap.isRGBE),!Jg){var n=new Ng;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),Jg=new Qg({parent:n})}this.enabled&&(Zg||(Zg=i.utils.createMesh(i.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,Zg.renderingSubMeshes[0],Jg)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){this.enabled&&Jg&&Jg.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,Jg);var e=i.director.root,t=e.pipeline,n=this.useIBL?this.isRGBE?2:1:0,r=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,o=this.useHDR;t.macros.CC_USE_IBL===n&&t.macros.CC_USE_DIFFUSEMAP===r&&t.macros.CC_USE_HDR===o||(t.macros.CC_USE_IBL=n,t.macros.CC_USE_DIFFUSEMAP=r,t.macros.CC_USE_HDR=o,e.onGlobalPipelineStateChanged())},t._updateGlobalBinding=function(){if(this._globalDSManager){var e=i.director.root.device,t=this.envmap?this.envmap:this._default;if(t){var n=t.getGFXTexture(),r=e.getSampler(t.getSamplerInfo());this._globalDSManager.bindSampler(ld,r),this._globalDSManager.bindTexture(ld,n)}var o=this.diffuseMap?this.diffuseMap:this._default;if(o){var a=o.getGFXTexture(),s=e.getSampler(o.getSamplerInfo());this._globalDSManager.bindSampler(fd,s),this._globalDSManager.bindTexture(fd,a)}this._globalDSManager.update()}},t._destroy=function(){},t.destroy=function(){this._destroy()},L(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this._updateGlobalBinding(),this._updatePipeline()}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();i.Skybox=$g;var ey,ty,ny=function(e){F(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=zc.create(),t._pos=new yi,t._type=Gg.SPHERE,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/jg(.15),this.luminanceLDR=1},t.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;zc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},L(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(Wg),iy=new yi(0,0,-1),ry=new Ai,oy=new Ni,ay=new Ni,sy=new Ni,cy=new Ni,ly=function(e){F(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._dir=new yi(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._aspect=0,t._aabb=zc.create(),t._frustum=Qc.create(),t._pos=new yi,t._type=Gg.SPOT,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t._setDirection=function(e){this._dir.set(e)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/jg(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new yi(1,-1,-1))},t.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),yi.transformQuat(this._dir,iy,this._node.getWorldRotation(ry)),yi.normalize(this._dir,this._dir),zc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(oy),Ni.invert(oy,oy),Ni.perspective(ay,this._angle,1,.001,this._range),Ni.multiply(sy,ay,oy),this._frustum.update(sy,cy),this._needUpdate=!1)},L(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(e){this._aspect=e,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(Wg),uy=Object.freeze({__proto__:null,Ambient:Ji,Octree:$i,get CameraFOVAxis(){return em},get CameraProjection(){return tm},get CameraAperture(){return nm},get CameraISO(){return im},get CameraShutter(){return rm},SKYBOX_FLAG:Tm,Camera:bm,CameraVisFlags:kg,VisibilityFlags:Hg,DirectionalLight:Yg,ColorTemperatureToRGB:Vg,get LightType(){return Gg},nt2lm:jg,Light:Wg,get ModelType(){return Zv},Model:ag,ShadowSize:Lg,ShadowType:Bg,PCFType:Fg,Shadows:Ug,RenderScene:dg,Skybox:$g,SphereLight:ny,SpotLight:ly,SubModel:$v,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null});function hy(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function fy(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(ey||(ey={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(ty||(ty={}));var _y=function(){function e(e){this._device=void 0,this._format=Cr.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new xo,this._region1=new xo,this._region2=new xo,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=pa[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=ba(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=fy(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,hy(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;v("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new Do(Dr.TEX2D,Mr.SAMPLED|Mr.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1},t._McDonaldAlloc=function(e){e=fy(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var o={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,hy(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}(),py=function(e){if(void 0===Pn[e]){var t=1<<In;Pn[e]=t,In+=1}},dy=Object.freeze({__proto__:null,addStage:py,scene:uy,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var o=[];o.push(new jo(uo.ATTR_POSITION,Cr.RGB32F)),t.normals&&o.push(new jo(uo.ATTR_NORMAL,Cr.RGB32F)),t.uvs&&o.push(new jo(uo.ATTR_TEX_COORD,Cr.RG32F)),t.colors&&o.push(new jo(uo.ATTR_COLOR,Cr.RGB32F));var a=e.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new wo(Rr.INDEX|Rr.TRANSFER_DST,Or.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new qo(o,[a],s))},get RenderQueue(){return ey},get PassStage(){return ty},genHandle:yv,getTypeFromHandle:Sv,getBindingFromHandle:xv,getCountFromHandle:Tv,getOffsetFromHandle:Ev,customizeType:bv,type2reader:Cv,type2writer:Av,getDefaultFromType:Rv,overrideMacros:Iv,get BatchingSchemes(){return kv},Pass:Qv,getDeviceShaderVersion:Bv,programLib:Fv,nearestPOT:hy,TextureBufferPool:_y,MaterialInstance:Qg,PassInstance:Kg,get PoolType(){return gc},NULL_HANDLE:0,get NodeView(){return yc},NodePool:bc,get PassView(){return xc},PassPool:Rc,get AABBView(){return Cc},AABBPool:Oc});e("renderer",dy);var my=new yi,vy=(new yi,new yi,new yi),gy=new Ni,yy=new zc,Sy=new zc,xy=!1,Ty=so.create(0,0,0,1),Ey=new so,by=new Qc;by.accurate=!0;var Cy=new Qc;Cy.accurate=!0;var Ay=new Qc,wy=new Ni,Ry=new Ni,Iy=new Ni,Py=new Ni,Oy=new Ni,Dy=new Ni,My=new Ni,Ny=new yi,Ly=new zi,By=new yi,Fy=new yi,zy=new yi(0,0,0),Uy=new zc,ky=new We((function(){return{model:null,depth:0}}),128),Gy=new We((function(){return{model:null,depth:0}}),128),Hy=new We((function(){return{model:null,depth:0}}),128);function Vy(e,t){var n=0;e.node&&(yi.subtract(my,e.node.worldPosition,t.position),n=yi.dot(my,t.forward));var i=ky.alloc();return i.model=e,i.depth=n,i}function jy(e,t){var n=0;e.node&&(yi.subtract(my,e.node.worldPosition,t.position),n=yi.dot(my,t.forward));var i=Gy.alloc();return i.model=e,i.depth=n,i}function Wy(e,t){var n=0;e.node&&(yi.subtract(my,e.node.worldPosition,t.position),n=yi.dot(my,t.forward));var i=Hy.alloc();return i.model=e,i.depth=n,i}function qy(e,t,n){var i=t.direction,r=e.normal,o=e.distance+.001,a=1/yi.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,f=r.z,_=e.matLight;_.m00=1-u*s,_.m01=-u*c,_.m02=-u*l,_.m03=0,_.m04=-h*s,_.m05=1-h*c,_.m06=-h*l,_.m07=0,_.m08=-f*s,_.m09=-f*c,_.m10=1-f*l,_.m11=0,_.m12=s*o,_.m13=c*o,_.m14=l*o,_.m15=1,Ni.toArray(n,_,od.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Xy(e,t){var n=e.pipelineSceneData.validPunctualLights;n.length=0;for(var i=t.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(so.set(Ty,o.position.x,o.position.y,o.position.z,o.range),rc.sphereFrustum(Ty,t.frustum)&&n.push(o))}for(var a=t.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(so.set(Ty,c.position.x,c.position.y,c.position.z,c.range),rc.sphereFrustum(Ty,t.frustum)&&n.push(c))}}function Yy(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;ky.freeArray(s),s.length=0;var c=r.castShadowObjects;Hy.freeArray(c),c.length=0,xy=!1;var l=null;if(o.enabled&&(e.pipelineUBO.updateShadowUBORange(od.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===Bg.ShadowMap))if(l=e.pipelineSceneData.dirShadowObjects,Gy.freeArray(l),l.length=0,i&&i.node)!function(e,t,n,i,r){var o=t.device,a=r.invisibleOcclusionRange,s=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();Ni.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(gy,i),Qc.split(by,i,gy,.1,r.shadowDistance),Cy=Qc.clone(by),Ni.fromRT(wy,n.node.rotation,zy),Ni.invert(Ry,wy),Ni.invert(Iy,Ry);var c=Ry.clone();Cy.transform(Ry),zc.fromPoints(yy,new yi(1e7,1e7,1e7),new yi(-1e7,-1e7,-1e7)),yy.mergeFrustum(Cy);var l=2*yy.halfExtents.z;vy.set(yy.center.x,yy.center.y,yy.center.z+yy.halfExtents.z+a),yi.transformMat4(vy,vy,Iy),Ni.fromRT(wy,n.node.rotation,vy),Ni.invert(Ry,wy),Ni.invert(Iy,Ry);var u=yi.distance(by.vertices[0],by.vertices[6]);Ey.center.set(0,0,0),Ey.radius=-1,Ey.mergePoints(by.vertices);var h=.8*u+.4*Ey.radius;r.shadowCameraFar=l+a;var f=.5*h;if(Ni.ortho(Py,-f,f,-f,f,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),s>0){Ni.multiply(Dy,Py,c),yi.transformMat4(Ny,vy,Dy);var _=2/s;Ly.set(_,_);var p=Ny.x%Ly.x,d=Ny.y%Ly.y;By.set(Ny.x-p,Ny.y-d,Ny.z),Ni.invert(My,Dy),yi.transformMat4(Fy,By,My),Ni.fromRT(wy,n.node.rotation,Fy),Ni.invert(Ry,wy),Ni.invert(Iy,Ry),Qc.createOrtho(e,h,h,.1,r.shadowCameraFar,Iy)}else{for(var m=0;m<8;m++)e.vertices[m].set(0,0,0);e.updatePlanes()}Ni.multiply(Oy,Py,Ry),r.matShadowView=Ry,r.matShadowProj=Py,r.matShadowViewProj=Oy}(Ay,e,i,t,o);else{for(var u=0;u<8;u++)Ay.vertices[u].set(0,0,0);Ay.updatePlanes()}i&&o.type===Bg.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,o=n.distance+.001,a=1/yi.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,f=r.z,_=n.matLight;_.m00=1-u*s,_.m01=-u*c,_.m02=-u*l,_.m03=0,_.m04=-h*s,_.m05=1-h*c,_.m06=-h*l,_.m07=0,_.m08=-f*s,_.m09=-f*c,_.m10=1-f*l,_.m11=0,_.m12=s*o,_.m13=c*o,_.m14=l*o,_.m15=1,e.pipelineUBO.updateShadowUBORange(od.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),a.enabled&&a.model&&t.clearFlag&Tm&&s.push(Vy(a.model,t));for(var h=n.models,f=t.visibility,_=0;_<h.length;_++){var p=h[_];if(p.enabled&&(p.castShadow&&c.push(Wy(p,t)),o.firstSetCSM&&p.worldBounds&&(xy||(Sy.copy(p.worldBounds),xy=!0),zc.merge(Sy,Sy,p.worldBounds)),p.node&&(f&p.node.layer)===p.node.layer||f&p.visFlags)){if(null!=l&&p.castShadow&&p.worldBounds&&(o.fixedArea?(zc.transform(Uy,p.worldBounds,o.matLight),rc.aabbFrustum(Uy,t.frustum)&&l.push(jy(p,t))):rc.aabbFrustum(p.worldBounds,Ay)&&l.push(jy(p,t))),p.worldBounds&&!rc.aabbFrustum(p.worldBounds,t.frustum))continue;s.push(Vy(p,t))}}o.firstSetCSM&&(o.shadowDistance=2*Sy.halfExtents.length(),o.firstSetCSM=!1)}var Ky,Qy,Zy,Jy,$y,eS,tS,nS,iS,rS,oS=new No(Fr.LINEAR,Fr.LINEAR,Fr.NONE,zr.CLAMP,zr.CLAMP,zr.CLAMP),aS=new No(Fr.POINT,Fr.POINT,Fr.NONE,zr.CLAMP,zr.CLAMP,zr.CLAMP),sS=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(oS),this._pointSampler=this._device.getSampler(aS);var t=new na(Yp.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new ia(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new ia(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=Xp.UBO_GLOBAL;r<Xp.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=t.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,od.SIZE,od.SIZE));i.bindBuffer(od.BINDING,o),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},L(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),cS=new Ni,lS=new Ni,uS=new Ni,hS=new Hi,fS=function(){function e(){this._globalUBO=new Float32Array(id.COUNT),this._cameraUBO=new Float32Array(rd.COUNT),this._shadowUBO=new Float32Array(od.COUNT)}e.updateGlobalUBOView=function(e,t){var n=i.director.root,r=t,o=Math.floor(e.width),a=Math.floor(e.height);r[id.TIME_OFFSET]=n.cumulativeTime,r[id.TIME_OFFSET+1]=n.frameTime,r[id.TIME_OFFSET+2]=i.director.getTotalFrames(),r[id.SCREEN_SIZE_OFFSET]=o,r[id.SCREEN_SIZE_OFFSET+1]=a,r[id.SCREEN_SIZE_OFFSET+2]=1/o,r[id.SCREEN_SIZE_OFFSET+3]=1/a,r[id.NATIVE_SIZE_OFFSET]=o,r[id.NATIVE_SIZE_OFFSET+1]=a,r[id.NATIVE_SIZE_OFFSET+2]=1/r[id.NATIVE_SIZE_OFFSET],r[id.NATIVE_SIZE_OFFSET+3]=1/r[id.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){i.director.root;var r=(n.scene?n.scene:i.director.getScene().renderScene).mainLight,o=e.pipelineSceneData,a=o.ambient,s=o.fog,c=t,l=n.exposure,u=o.isHDR;if(c[rd.SCREEN_SCALE_OFFSET]=o.shadingScale,c[rd.SCREEN_SCALE_OFFSET+1]=o.shadingScale,c[rd.SCREEN_SCALE_OFFSET+2]=1/c[rd.SCREEN_SCALE_OFFSET],c[rd.SCREEN_SCALE_OFFSET+3]=1/c[rd.SCREEN_SCALE_OFFSET+1],c[rd.EXPOSURE_OFFSET]=l,c[rd.EXPOSURE_OFFSET+1]=1/l,c[rd.EXPOSURE_OFFSET+2]=u?1:0,c[rd.EXPOSURE_OFFSET+3]=0,r){if(yi.toArray(c,r.direction,rd.MAIN_LIT_DIR_OFFSET),yi.toArray(c,r.color,rd.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var h=r.colorTemperatureRGB;c[rd.MAIN_LIT_COLOR_OFFSET]*=h.x,c[rd.MAIN_LIT_COLOR_OFFSET+1]*=h.y,c[rd.MAIN_LIT_COLOR_OFFSET+2]*=h.z}c[rd.MAIN_LIT_COLOR_OFFSET+3]=u?r.illuminance*l:r.illuminance}else yi.toArray(c,yi.UNIT_Z,rd.MAIN_LIT_DIR_OFFSET),Hi.toArray(c,Hi.ZERO,rd.MAIN_LIT_COLOR_OFFSET);var f=a.skyColor;f.w=u?a.skyIllum*l:a.skyIllum,c[rd.AMBIENT_SKY_OFFSET+0]=f.x,c[rd.AMBIENT_SKY_OFFSET+1]=f.y,c[rd.AMBIENT_SKY_OFFSET+2]=f.z,c[rd.AMBIENT_SKY_OFFSET+3]=f.w,c[rd.AMBIENT_GROUND_OFFSET+0]=a.groundAlbedo.x,c[rd.AMBIENT_GROUND_OFFSET+1]=a.groundAlbedo.y,c[rd.AMBIENT_GROUND_OFFSET+2]=a.groundAlbedo.z,c[rd.AMBIENT_GROUND_OFFSET+3]=a.groundAlbedo.w,Ni.toArray(c,n.matView,rd.MAT_VIEW_OFFSET),Ni.toArray(c,n.node.worldMatrix,rd.MAT_VIEW_INV_OFFSET),yi.toArray(c,n.position,rd.CAMERA_POS_OFFSET),Ni.toArray(c,n.matProj,rd.MAT_PROJ_OFFSET),Ni.toArray(c,n.matProjInv,rd.MAT_PROJ_INV_OFFSET),Ni.toArray(c,n.matViewProj,rd.MAT_VIEW_PROJ_OFFSET),Ni.toArray(c,n.matViewProjInv,rd.MAT_VIEW_PROJ_INV_OFFSET),c[rd.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var _=s.colorArray;c[rd.GLOBAL_FOG_COLOR_OFFSET]=_.x,c[rd.GLOBAL_FOG_COLOR_OFFSET+1]=_.y,c[rd.GLOBAL_FOG_COLOR_OFFSET+2]=_.z,c[rd.GLOBAL_FOG_COLOR_OFFSET+3]=_.z,c[rd.GLOBAL_FOG_BASE_OFFSET]=s.fogStart,c[rd.GLOBAL_FOG_BASE_OFFSET+1]=s.fogEnd,c[rd.GLOBAL_FOG_BASE_OFFSET+2]=s.fogDensity,c[rd.GLOBAL_FOG_ADD_OFFSET]=s.fogTop,c[rd.GLOBAL_FOG_ADD_OFFSET+1]=s.fogRange,c[rd.GLOBAL_FOG_ADD_OFFSET+2]=s.fogAtten,c[rd.NEAR_FAR_OFFSET]=n.nearClip,c[rd.NEAR_FAR_OFFSET+1]=n.farClip,c[rd.VIEW_PORT_OFFSET]=n.viewport.x,c[rd.VIEW_PORT_OFFSET+1]=n.viewport.y,c[rd.VIEW_PORT_OFFSET+1]=n.viewport.z,c[rd.VIEW_PORT_OFFSET+1]=n.viewport.w},e.updateShadowUBOView=function(e,t,n){var i=e.device,r=n.scene.mainLight,o=e.pipelineSceneData.shadows,a=t;if(o.enabled){if(r&&o.type===Bg.ShadowMap){var s,c,l,u=.1,h=0;if(o.fixedArea){Ni.invert(cS,r.node.getWorldMatrix()),s=cS;var f=o.orthoSize,_=o.orthoSize;u=o.near,h=o.far,Ni.ortho(lS,-f,f,-_,_,u,h,i.capabilities.clipSpaceMinZ,i.capabilities.clipSpaceSignY),c=lS,Ni.multiply(uS,lS,cS),l=uS}else u=.1,h=o.shadowCameraFar,s=o.matShadowView,c=o.matShadowProj,l=o.matShadowViewProj;Ni.toArray(t,s,od.MAT_LIGHT_VIEW_OFFSET),a[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=c.m10,a[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=c.m14,a[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=c.m11,a[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=c.m15,a[od.SHADOW_PROJ_INFO_OFFSET+0]=c.m00,a[od.SHADOW_PROJ_INFO_OFFSET+1]=c.m05,a[od.SHADOW_PROJ_INFO_OFFSET+2]=1/c.m00,a[od.SHADOW_PROJ_INFO_OFFSET+3]=1/c.m05,Ni.toArray(t,l,od.MAT_LIGHT_VIEW_PROJ_OFFSET);var p=cm(i)?0:1;a[od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=u,a[od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h,a[od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=p,a[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===Bg.Planar&&qy(o,r,a);vi.toArray(a,o.shadowColor,od.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i,r,o,a=e.device,s=e.pipelineSceneData.shadows,c=t,l=cm(a)?0:1,u=.1,h=0;switch(n.type){case Gg.DIRECTIONAL:if(s.fixedArea){Ni.invert(cS,n.node.getWorldMatrix()),i=cS;var f=s.orthoSize,_=s.orthoSize;u=s.near,h=s.far,Ni.ortho(lS,-f,f,-_,_,u,h,a.capabilities.clipSpaceMinZ,a.capabilities.clipSpaceSignY),r=lS,Ni.multiply(uS,lS,cS),o=uS}else u=.1,h=s.shadowCameraFar,i=s.matShadowView,r=s.matShadowProj,o=s.matShadowViewProj;Ni.toArray(t,i,od.MAT_LIGHT_VIEW_OFFSET),c[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=r.m10,c[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=r.m14,c[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=r.m11,c[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=r.m15,c[od.SHADOW_PROJ_INFO_OFFSET+0]=r.m00,c[od.SHADOW_PROJ_INFO_OFFSET+1]=r.m05,c[od.SHADOW_PROJ_INFO_OFFSET+2]=1/r.m00,c[od.SHADOW_PROJ_INFO_OFFSET+3]=1/r.m05,Ni.toArray(t,o,od.MAT_LIGHT_VIEW_PROJ_OFFSET),hS.set(u,h,0,1-s.saturation),Hi.toArray(c,hS,od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),hS.set(0,l,s.normalBias,0),Hi.toArray(c,hS,od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case Gg.SPOT:Ni.invert(cS,n.node.getWorldMatrix()),Ni.toArray(c,cS,od.MAT_LIGHT_VIEW_OFFSET),Ni.perspective(lS,n.angle,n.aspect,.001,n.range),Ni.multiply(uS,lS,cS),Ni.toArray(c,uS,od.MAT_LIGHT_VIEW_PROJ_OFFSET),hS.set(.01,n.range,0,1-s.saturation),Hi.toArray(c,hS,od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),hS.set(1,l,s.normalBias,0),Hi.toArray(c,hS,od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}hS.set(s.size.x,s.size.y,s.pcf,s.bias),Hi.toArray(c,hS,od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),vi.toArray(c,s.shadowColor,od.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,id.SIZE,id.SIZE));n.bindBuffer(id.BINDING,i);var r=e.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,rd.SIZE,rd.SIZE));n.bindBuffer(rd.BINDING,r);var o=e.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,od.SIZE,od.SIZE));n.bindBuffer(od.BINDING,o)},t.updateGlobalUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(i.getBuffer(id.BINDING),this._globalUBO),n.bindBuffer(id.BINDING,i.getBuffer(id.BINDING)),n.update()},t.updateCameraUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(rd.BINDING),this._cameraUBO),n.bindBuffer(rd.BINDING,i.getBuffer(rd.BINDING)),n.update()},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=t.scene.mainLight;a&&o.has(a)&&i.bindTexture(ad,o.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),r[0].updateBuffer(i.getBuffer(od.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t,n){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),t.bindTexture(ad,Vv.get("default-texture").getGFXTexture()),t.bindTexture(dd,Vv.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(od.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof Ni?Ni.toArray(this._shadowUBO,t,e):t instanceof vi&&vi.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();fS._combineSignY=0;var _S,pS,dS,mS,vS,gS,yS,SS,xS,TS,ES,bS,CS,AS=e("RenderStage",(Ky=sl("RenderStage"),Qy=Nl(),Zy=Nl(),Jy=Nl(),Ky((rS=function(){function e(){q(this,"_name",tS,this),q(this,"_priority",nS,this),this._enabled=!0,q(this,"_tag",iS,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},L(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),tS=X((eS=rS).prototype,"_name",[Qy,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),nS=X(eS.prototype,"_priority",[Zy,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iS=X(eS.prototype,"_tag",[Jy,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$y=eS))||$y));i.RenderStage=AS;var wS,RS=e("RenderFlow",(_S=sl("RenderFlow"),pS=Nl(),dS=Nl(),mS=Nl(),vS=Nl(),gS=Hl([AS]),_S((CS=function(){function e(){q(this,"_name",xS,this),q(this,"_priority",TS,this),q(this,"_tag",ES,this),q(this,"_stages",bS,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},L(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),xS=X((SS=CS).prototype,"_name",[pS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),TS=X(SS.prototype,"_priority",[dS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ES=X(SS.prototype,"_tag",[mS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bS=X(SS.prototype,"_stages",[vS,gS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yS=SS))||yS));i.RenderFlow=RS,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(wS||(wS=e("PipelineEventType",{})));var IS,PS,OS,DS,MS,NS,LS,BS,FS,zS,US,kS,GS,HS,VS,jS=e("PipelineEventProcessor",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}F(t,e);var n=t.prototype;return n.on=function(e,t,n,i){return this.eventTargetOn(e,t,n,i)},n.once=function(e,t,n){return this.eventTargetOnce(e,t,n)},t}(pn)),WS=new po,qS=new To,XS=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},YS=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},KS=e("RenderPipeline",(IS=sl("cc.RenderPipeline"),PS=Nl(),OS=Nl(),DS=Hl([RS]),IS((FS=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_tag",LS,V(t)),q(t,"_flows",BS,V(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new jS,t._commandBuffers=[],t._pipelineUBO=new fS,t._macros={},t._constantMacros="",t._profiler=null,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new po,t._clusterEnabled=!1,t._bloomEnabled=!1,t}F(t,e);var n=t.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.createRenderPass=function(e,t,n){var i=this._device,r=new Xo,o=new Yo;r.format=t,o.format=n,o.stencilStoreOp=qr.DISCARD,o.depthStoreOp=qr.DISCARD,e&ao.COLOR||(e&Tm?r.loadOp=Wr.DISCARD:(r.loadOp=Wr.LOAD,r.beginAccesses=[Xr.COLOR_ATTACHMENT_WRITE])),(e&ao.DEPTH_STENCIL)!==ao.DEPTH_STENCIL&&(e&ao.DEPTH||(o.depthLoadOp=Wr.LOAD),e&ao.STENCIL||(o.stencilLoadOp=Wr.LOAD)),o.beginAccesses=[Xr.DEPTH_STENCIL_ATTACHMENT_WRITE];var a=new Zo([r],o);return i.createRenderPass(a)},n.getRenderPass=function(e,t){var n=this._renderPasses.get(e);return n||(n=this.createRenderPass(e,t.colorTexture.format,t.depthStencilTexture.format),this._renderPasses.set(e,n),n)},n.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,n=this._width*t.shadingScale,i=this._height*t.shadingScale,r=e.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);e.depthStencilTexture&&e.depthStencilTexture.resize(n,i),e.destroy(),e.initialize(new ea(e.renderPass,r,e.depthStencilTexture))},n.generateRenderArea=function(e,t){var n=e.viewport,i=e.window.width,r=e.window.height;t.x=n.x*i,t.y=n.y*r,t.width=n.width*i,t.height=n.height*r},n.generateViewport=function(e,t){this.generateRenderArea(e,WS),t||(t=qS);var n=this.pipelineSceneData.shadingScale;return t.left=WS.x*n,t.top=WS.y*n,t.width=WS.width*n,t.height=WS.height*n,t},n.generateScissor=function(e,t){t||(t=WS),this.generateRenderArea(e,t);var n=this.pipelineSceneData.shadingScale;return t.x*=n,t.y*=n,t.width*=n,t.height*=n,t},n.activate=function(){var e=i.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new sS(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(wS.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var n=e[t];if(n.window.swapchain)return void(Og=n)}Og=null}(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){this.emit(wS.RENDER_CAMERA_BEGIN,n),Xy(this,n),Yy(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(wS.RENDER_CAMERA_END,n)}}this.emit(wS.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var n=0;n<t.downsampleTexs.length;++n)t.downsampleTexs[n].destroy(),t.downsampleFramebuffers[n].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this._width,r=(t.x+t.width)/this._width,o=t.y/this._height,a=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(e){case Er.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case Er.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case Er.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case Er.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var e=new YS,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.DEVICE|Or.HOST,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new wo(Rr.INDEX|Rr.TRANSFER_DST,Or.DEVICE,o,r));if(!a)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new jo("a_position",Cr.RG32F),c[1]=new jo("a_texCoord",Cr.RG32F);var l=this._device.createInputAssembler(new qo(c,[i],a));return e.quadIB=a,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e,t){var n=this._lastUsedRenderArea;if(n.x!==e.x||n.y!==e.y||n.width!==e.width||n.height!==e.height){var i=this._genQuadVertexData(Er.IDENTITY,e);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||Er.IDENTITY,e);this._quadVBOnscreen.update(r),n.copy(e)}},n.destroy=function(){for(var t,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),e.prototype.destroy.call(this)},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(br.TEXTURE_FLOAT)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(br.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",this._constantMacros=e},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new XS,t=this.device,n=new Xo;n.format=Cr.RGBA8,n.loadOp=Wr.CLEAR,n.storeOp=qr.STORE,n.endAccesses=[Xr.COLOR_ATTACHMENT_WRITE],e.renderPass=t.createRenderPass(new Zo([n]));var i=this._width,r=this._height;e.prefiterTex=t.createTexture(new Do(Dr.TEX2D,Mr.COLOR_ATTACHMENT|Mr.SAMPLED,Cr.RGBA8,i>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new ea(e.renderPass,[e.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)e.downsampleTexs.push(t.createTexture(new Do(Dr.TEX2D,Mr.COLOR_ATTACHMENT|Mr.SAMPLED,Cr.RGBA8,i>>1,r>>1))),e.downsampleFramebuffers[o]=t.createFramebuffer(new ea(e.renderPass,[e.downsampleTexs[o]])),e.upsampleTexs.push(t.createTexture(new Do(Dr.TEX2D,Mr.COLOR_ATTACHMENT|Mr.SAMPLED,Cr.RGBA8,i,r))),e.upsampleFramebuffers[o]=t.createFramebuffer(new ea(e.renderPass,[e.upsampleTexs[o]])),i>>=1,r>>=1;e.combineTex=t.createTexture(new Do(Dr.TEX2D,Mr.COLOR_ATTACHMENT|Mr.SAMPLED,Cr.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new ea(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},n.on=function(e,t,n,i){return this._eventProcessor.on(e,t,n,i)},n.once=function(e,t,n){return this._eventProcessor.once(e,t,n)},n.off=function(e,t,n){this._eventProcessor.off(e,t,n)},n.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},n.targetOff=function(e){this._eventProcessor.targetOff(e)},n.removeAll=function(e){this._eventProcessor.removeAll(e)},n.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},L(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),t}(zu),LS=X((NS=FS).prototype,"_tag",[PS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BS=X(NS.prototype,"_flows",[OS,DS,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MS=NS))||MS));i.RenderPipeline=KS,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(zS||(zS={})),function(e){e[e.FORWARD=10]="FORWARD"}(US||(US={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(kS||(kS={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(GS||(GS={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(HS||(HS={}));var QS=new Xo;QS.format=Cr.RGBA8,QS.beginAccesses=[Xr.FRAGMENT_SHADER_READ_TEXTURE],QS.endAccesses=[Xr.FRAGMENT_SHADER_READ_TEXTURE];var ZS=new Yo;ZS.format=Cr.DEPTH_STENCIL;var JS,$S,ex,tx,nx,ix,rx,ox,ax,sx,cx,lx,ux,hx,fx,_x,px,dx,mx,vx,gx,yx,Sx,xx,Tx,Ex,bx,Cx,Ax,wx,Rx,Ix,Px,Ox,Dx,Mx,Nx,Lx,Bx,Fx,zx,Ux,kx,Gx,Hx,Vx,jx,Wx,qx,Xx,Yx,Kx,Qx,Zx,Jx,$x,eT,tT,nT,iT,rT,oT,aT,sT,cT,lT,uT,hT,fT,_T,pT,dT,mT,vT,gT,yT,ST,xT,TT,ET=new Zo([QS],ZS),bT={width:1,height:1,renderPassInfo:ET},CT=e("RenderTexture",sl("cc.RenderTexture")(VS=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._window=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){if(this._window){var t=i.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=Math.floor(Jn(e,1,2048)),this._height=Math.floor(Jn(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(t,n){var i=t;this._width=i.w,this._height=i.h,this._name=i.n,e.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(e){var t=i.director.root;bT.title=this._name,bT.width=this._width,bT.height=this._height,bT.renderPassInfo=e&&e.passInfo?e.passInfo:ET,this._window?(this._window.destroy(),this._window.initialize(t.device,bT)):this._window=t.createWindow(bT)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),i=(n=n||this.width)||this.height;var r=this.getGFXTexture();if(!r)return null;var o=this._getGFXDevice(),a=[],s=[],c=new xo;c.texOffset.x=e,c.texOffset.y=t,c.texExtent.width=n,c.texExtent.height=i,s.push(c);var l=new Uint8Array(n*i*4);return a.push(l),null==o||o.copyTextureToBuffers(r,a,s),l},L(t,[{key:"window",get:function(){return this._window}}]),t}(Gm))||VS);i.RenderTexture=CT,$e(Dr),$e(Mr),$e(qr),$e(Wr),$e(Xr),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(TT||(TT={})),$e(TT),JS=sl("RenderTextureDesc"),$S=Hl(Dr),ex=Hl(Mr),tx=Hl(Cr),JS((ix=X((nx=function(){q(this,"name",ix,this),q(this,"type",rx,this),q(this,"usage",ox,this),q(this,"format",ax,this),q(this,"width",sx,this),q(this,"height",cx,this)}).prototype,"name",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rx=X(nx.prototype,"type",[$S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dr.TEX2D}}),ox=X(nx.prototype,"usage",[ex],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mr.COLOR_ATTACHMENT}}),ax=X(nx.prototype,"format",[tx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cr.UNKNOWN}}),sx=X(nx.prototype,"width",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),cx=X(nx.prototype,"height",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),nx));var AT,wT=(lx=sl("RenderTextureConfig"),ux=Hl(CT),lx((_x=X((fx=function(){q(this,"name",_x,this),q(this,"texture",px,this)}).prototype,"name",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),px=X(fx.prototype,"texture",[ux],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hx=fx))||hx),RT=(dx=sl("MaterialConfig"),mx=Hl(Ng),dx((gx=X((vx=function(){q(this,"name",gx,this),q(this,"material",yx,this)}).prototype,"name",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yx=X(vx.prototype,"material",[mx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vx)),Sx=sl("FrameBufferDesc"),xx=Hl([At]),Tx=Hl(CT),Sx((bx=X((Ex=function(){q(this,"name",bx,this),q(this,"renderPass",Cx,this),q(this,"colorTextures",Ax,this),q(this,"depthStencilTexture",wx,this),q(this,"texture",Rx,this)}).prototype,"name",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Cx=X(Ex.prototype,"renderPass",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ax=X(Ex.prototype,"colorTextures",[xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wx=X(Ex.prototype,"depthStencilTexture",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Rx=X(Ex.prototype,"texture",[Tx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ex)),Ix=sl("ColorDesc"),Px=Hl(Cr),Ox=Hl(Wr),Dx=Hl(qr),Mx=Hl([Xr]),Nx=Hl([Xr]),Ix((Fx=X((Bx=function(){q(this,"format",Fx,this),q(this,"loadOp",zx,this),q(this,"storeOp",Ux,this),q(this,"sampleCount",kx,this),q(this,"beginAccesses",Gx,this),q(this,"endAccesses",Hx,this)}).prototype,"format",[Px],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cr.UNKNOWN}}),zx=X(Bx.prototype,"loadOp",[Ox],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wr.CLEAR}}),Ux=X(Bx.prototype,"storeOp",[Dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qr.STORE}}),kx=X(Bx.prototype,"sampleCount",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Gx=X(Bx.prototype,"beginAccesses",[Mx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hx=X(Bx.prototype,"endAccesses",[Nx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Xr.COLOR_ATTACHMENT_WRITE]}}),Lx=Bx))||Lx),IT=(Vx=sl("DepthStencilDesc"),jx=Hl(Cr),Wx=Hl(Wr),qx=Hl(qr),Xx=Hl(Wr),Yx=Hl(qr),Kx=Hl([Xr]),Qx=Hl([Xr]),Vx(($x=X((Jx=function(){q(this,"format",$x,this),q(this,"depthLoadOp",eT,this),q(this,"depthStoreOp",tT,this),q(this,"stencilLoadOp",nT,this),q(this,"stencilStoreOp",iT,this),q(this,"sampleCount",rT,this),q(this,"beginAccesses",oT,this),q(this,"endAccesses",aT,this)}).prototype,"format",[jx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cr.UNKNOWN}}),eT=X(Jx.prototype,"depthLoadOp",[Wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wr.CLEAR}}),tT=X(Jx.prototype,"depthStoreOp",[qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qr.STORE}}),nT=X(Jx.prototype,"stencilLoadOp",[Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wr.CLEAR}}),iT=X(Jx.prototype,"stencilStoreOp",[Yx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qr.STORE}}),rT=X(Jx.prototype,"sampleCount",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oT=X(Jx.prototype,"beginAccesses",[Kx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aT=X(Jx.prototype,"endAccesses",[Qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Xr.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),Zx=Jx))||Zx);sT=sl("RenderPassDesc"),cT=Hl([RT]),lT=Hl(IT),sT((hT=X((uT=function(){q(this,"index",hT,this),q(this,"colorAttachments",fT,this),q(this,"depthStencilAttachment",_T,this)}).prototype,"index",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),fT=X(uT.prototype,"colorAttachments",[cT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_T=X(uT.prototype,"depthStencilAttachment",[lT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new IT}}),uT)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(AT||(AT={})),$e(AT);var PT=(pT=sl("RenderQueueDesc"),dT=Hl(AT),mT=Hl([At]),pT((yT=X((gT=function(){q(this,"isTransparent",yT,this),q(this,"sortMode",ST,this),q(this,"stages",xT,this)}).prototype,"isTransparent",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ST=X(gT.prototype,"sortMode",[dT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AT.FRONT_TO_BACK}}),xT=X(gT.prototype,"stages",[mT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vT=gT))||vT);function OT(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function DT(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var MT=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new qe((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Xe(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=e.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=vg.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet($p.MATERIAL,c.descriptorSet),n.bindDescriptorSet($p.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function NT(e){for(var t=0,n=0;n<e.stages.length;n++)t|=jv(e.stages[n]);var i=OT;switch(e.sortMode){case AT.BACK_TO_FRONT:i=DT;break;case AT.FRONT_TO_BACK:i=OT}return new MT({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function LT(e){e.clear()}function BT(e){e.sort()}var FT=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=vg.getOrCreatePipelineState(e,s.pass,c,t,s.ia);n.bindPipelineState(l),n.bindDescriptorSet($p.MATERIAL,s.pass.descriptorSet),o=!0}n.bindDescriptorSet($p.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},e}(),zT=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){n.bindDescriptorSet($p.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,f=vg.getOrCreatePipelineState(e,s,h,t,u.ia);c!==f&&(n.bindPipelineState(f),c=f),n.bindDescriptorSet($p.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},e}(),UT=new We((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),kT=new Float32Array(4),GT=[],HT=[],VT=new Ni,jT=new Ni;function WT(e,t){return!(!t.worldBounds||rc.aabbWithAABB(t.worldBounds,e.aabb))}function qT(e,t){return!(!t.worldBounds||rc.aabbWithAABB(t.worldBounds,e.aabb)&&rc.aabbFrustum(t.worldBounds,e.frustum))}var XT=jv("forward-add"),YT=[];function KT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===XT){o=a,n=!0;break}t.push(o)}return n}var QT,ZT,JT,$T,eE,tE,nE,iE,rE,oE,aE,sE=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(od.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new zT,this._batchedQueue=new FT;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Td.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new Ro(this._lightBuffer,0,Td.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}UT.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(od.BINDING).destroy(),r.getTexture(ad).destroy(),r.getTexture(dd).destroy(),r.destroy()),e.delete(i)}},t.gatherLightPasses=function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(KT(a,YT)&&(HT.length=0,this._lightCulling(o,n),HT.length))for(var s=0;s<a.length;s++){var c=YT[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(Td.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],f=a.inputAssembler,_=vg.getOrCreatePipelineState(e,u,h,t,f),p=u.descriptorSet,d=a.descriptorSet;n.bindPipelineState(_),n.bindDescriptorSet($p.MATERIAL,p),n.bindInputAssembler(f);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);GT[0]=c[m],n.bindDescriptorSet($p.GLOBAL,g),n.bindDescriptorSet($p.LOCAL,d,GT),n.draw(f)}}},t._lightCulling=function(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=!1;switch(i.type){case Gg.SPHERE:r=WT(i,e);break;case Gg.SPOT:r=qT(i,e)}r||HT.push(n)}},t._addRenderQueue=function(e,t,n,i){var r=e.batchingScheme;if(r===kv.INSTANCING)for(var o=0;o<HT.length;o++){var a=HT[o],s=e.getInstancedBuffer(a);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===kv.VB_MERGING)for(var c=0;c<HT.length;c++){var l=HT[c],u=e.getBatchedBuffer(l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=UT.alloc();h.subModel=t,h.passIdx=i;for(var f=0;f<HT.length;f++){var _=HT[f];h.lights.push(_),h.dynamicOffsets.push(this._lightBufferStride*_)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=e.scene.mainLight,s=cm(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],f=c.getOrCreateDescriptorSet(u);if(f){var _=void 0,p=void 0;switch(h.type){case Gg.SPHERE:a&&qy(r,a,this._shadowUBO),this._shadowUBO[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,vi.toArray(this._shadowUBO,r.shadowColor,od.SHADOW_COLOR_OFFSET);break;case Gg.SPOT:if(a&&qy(r,a,this._shadowUBO),Ni.invert(VT,h.node.getWorldMatrix()),Ni.perspective(jT,h.angle,h.aspect,.001,h.range),_=jT.clone(),p=jT.clone().invert(),Ni.multiply(jT,jT,VT),Ni.toArray(this._shadowUBO,VT,od.MAT_LIGHT_VIEW_OFFSET),Ni.toArray(this._shadowUBO,jT,od.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[od.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[od.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[od.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=_.m10,this._shadowUBO[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=_.m14,this._shadowUBO[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=_.m11,this._shadowUBO[od.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=_.m15,this._shadowUBO[od.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[od.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[od.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[od.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[od.SHADOW_PROJ_INFO_OFFSET+0]=_.m00,this._shadowUBO[od.SHADOW_PROJ_INFO_OFFSET+1]=_.m05,this._shadowUBO[od.SHADOW_PROJ_INFO_OFFSET+2]=1/_.m00,this._shadowUBO[od.SHADOW_PROJ_INFO_OFFSET+3]=1/_.m05,vi.toArray(this._shadowUBO,r.shadowColor,od.SHADOW_COLOR_OFFSET),o.has(h)){var d,m=null===(d=o.get(h))||void 0===d?void 0:d.colorTextures[0];m&&f.bindTexture(dd,m)}}f.update(),t.updateBuffer(f.getBuffer(od.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=li(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new Ro(this._lightBuffer,0,Td.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case Gg.SPHERE:if(yi.toArray(kT,l.position),kT[3]=0,this._lightBufferData.set(kT,c+Td.LIGHT_POS_OFFSET),kT[0]=l.size,kT[1]=l.range,kT[2]=0,kT[3]=o.enabled&&o.type===Bg.ShadowMap?1:0,this._lightBufferData.set(kT,c+Td.LIGHT_SIZE_RANGE_ANGLE_OFFSET),yi.toArray(kT,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;kT[0]*=u.x,kT[1]*=u.y,kT[2]*=u.z}kT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(kT,c+Td.LIGHT_COLOR_OFFSET);break;case Gg.SPOT:if(yi.toArray(kT,l.position),kT[3]=1,this._lightBufferData.set(kT,c+Td.LIGHT_POS_OFFSET),kT[0]=l.size,kT[1]=l.range,kT[2]=l.spotAngle,kT[3]=o.enabled&&o.type===Bg.ShadowMap?1:0,this._lightBufferData.set(kT,c+Td.LIGHT_SIZE_RANGE_ANGLE_OFFSET),yi.toArray(kT,l.direction),this._lightBufferData.set(kT,c+Td.LIGHT_DIR_OFFSET),yi.toArray(kT,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;kT[0]*=h.x,kT[1]*=h.y,kT[2]*=h.z}kT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(kT,c+Td.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),cE=new zc,lE=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new zT,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===Bg.Planar){var r=e.scene,o=e.frustum,a=0!=(e.visibility&Gp.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var f=this._castModels[h];if(!f.worldBounds||(zc.transform(cE,f.worldBounds,i.matLight),rc.aabbFrustum(cE,o)))if(f.isInstancingEnabled)for(var _=f.subModels,p=0;p<_.length;p++){var d=_[p];u.merge(d,f.instancedAttributes,0,d.planarInstanceShader)}else this._pendingModels.push(f)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Bg.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet($p.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,f=u.inputAssembler,_=vg.getOrCreatePipelineState(e,r,h,t,f);n.bindPipelineState(_),n.bindDescriptorSet($p.LOCAL,u.descriptorSet),n.bindInputAssembler(f),n.draw(f)}}},e}(),uE=function(){function e(){this._phaseID=jv("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=e.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var f=s.shaders[u],_=s.inputAssembler,p=vg.getOrCreatePipelineState(i,h,f,t,_);r.bindPipelineState(p),r.bindDescriptorSet($p.MATERIAL,h.descriptorSet);var d=s.descriptorSet;r.bindDescriptorSet($p.LOCAL,d),r.bindInputAssembler(_),r.draw(_)}}}},e}(),hE=[new Eo(0,0,0,1)],fE=e("ForwardStage",(QT=sl("ForwardStage"),ZT=Hl([PT]),JT=Nl(),QT((iE=nE=function(e){function t(){var t;return q(t=e.call(this)||this,"renderQueues",tE,V(t)),t._renderQueues=[],t._renderArea=new po,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=jv("default"),t._clearFlag=4294967295,t._batchedQueue=new FT,t._instancedQueue=new zT,t._uiPhase=new uE,t}F(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=NT(this.renderQueues[i]);this._additiveLightQueue=new sE(this._pipeline),this._planarQueue=new lE(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(LT);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var f=h[o];if(f.phase===this._phaseID){var _=f.batchingScheme;if(_===kv.INSTANCING){var p=f.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(_===kv.VB_MERGING){var d=f.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(BT);var m=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&ao.COLOR&&(hE[0].x=e.clearColor.x,hE[0].y=e.clearColor.y,hE[0].z=e.clearColor.z,hE[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var v=e.window.swapchain,g=e.window.framebuffer,y=v?t.getRenderPass(e.clearFlag&this._clearFlag,v):g.renderPass;m.beginRenderPass(y,g,this._renderArea,hE,e.clearDepth,e.clearStencil),m.bindDescriptorSet($p.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,y,m),this._instancedQueue.recordCommandBuffer(n,y,m),this._batchedQueue.recordCommandBuffer(n,y,m),this._additiveLightQueue.recordCommandBuffer(n,y,m),m.bindDescriptorSet($p.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(n,y,m),this._renderQueues[1].recordCommandBuffer(n,y,m),this._uiPhase.render(e,y),Dg(n,y,m,t.profiler,e),m.endRenderPass()},t}(AS),nE.initInfo={name:"ForwardStage",priority:US.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:AT.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:AT.BACK_TO_FRONT,stages:["default","planarShadow"]}]},tE=X((eE=iE).prototype,"renderQueues",[ZT,_l,JT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$T=eE))||$T)),_E=e("ForwardFlow",sl("ForwardFlow")((aE=oE=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new fE;n.initialize(fE.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(RS),oE.initInfo={name:Wp,priority:kS.FORWARD,stages:[]},rE=aE))||rE),pE=new Ni,dE=new Ni,mE=new Ni,vE=new zc,gE=jv("shadow-caster"),yE=[];function SE(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===gE){o=a,n=!0;break}t.push(o)}return n}var xE,TE,EE,bE,CE,AE,wE=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new zT,this._batchedQueue=new FT}var t=e.prototype;return t.gatherLightPasses=function(e,t,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows,a=r.dirShadowObjects,s=r.castShadowObjects;if(n&&o.enabled&&o.type===Bg.ShadowMap)switch(n.type){case Gg.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;SE(l.subModels,yE)&&this.add(l,i,yE)}break;case Gg.SPOT:Ni.invert(pE,n.node.getWorldMatrix()),Ni.perspective(dE,n.angle,n.aspect,.001,n.range),Ni.multiply(mE,dE,pE);for(var u=0;u<s.length;u++){var h=s[u].model;SE(h.subModels,yE)&&(h.worldBounds&&(zc.transform(vE,h.worldBounds,mE),!rc.aabbFrustum(vE,t.frustum))||this.add(h,i,yE))}}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t,n){for(var i=e.subModels,r=0;r<i.length;r++){var o=i[r],a=n[r],s=o.passes[a];if(s.batchingScheme===kv.INSTANCING){var c=s.getInstancedBuffer();c.merge(o,e.instancedAttributes,a),this._instancedQueue.queue.add(c)}else if(s.batchingScheme===kv.VB_MERGING){var l=s.getBatchedBuffer();l.merge(o,a,e),this._batchedQueue.queue.add(l)}else{var u=o.shaders[a];this._subModelsArray.push(o),u&&this._shaderArray.push(u),this._passArray.push(s)}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=vg.getOrCreatePipelineState(e,a,o,t,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet($p.MATERIAL,l),n.bindDescriptorSet($p.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),RE=[new Eo(1,1,1,1)],IE=e("ShadowStage",sl("ShadowStage")((EE=TE=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new po,t._light=null,t._globalDS=null,t}F(t,e);var n=t.prototype;return n.setUsage=function(e,t,n){this._globalDS=e,this._light=t,this._shadowFrameBuffer=n},n.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){RE[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,RE,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,e,this._light,a);var s=e.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=t.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,RE,e.clearDepth,e.clearStencil),a.bindDescriptorSet($p.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new wE(t)},t}(AS),TE.initInfo={name:"ShadowStage",priority:US.FORWARD,tag:0},xE=EE))||xE),PE=[],OE=e("ShadowFlow",sl("ShadowFlow")((AE=CE=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}F(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new IE;n.initialize(IE.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===Bg.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===Gg.SPOT&&(PE.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;i.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=i.get(l),f=0;f<this._stages.length;f++){var _=this._stages[f];_.setUsage(u,l,h),_.render(e)}}for(var p=0;p<PE.length;p++){var d=PE[p],m=t.globalDSManager.getOrCreateDescriptorSet(p);i.has(d)||this._initShadowFrameBuffer(t,d,e.window.swapchain);for(var v=i.get(d),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,d,v),y.render(e)}}PE.length=0}else this.clearShadowMap(PE,e)}},n.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,o=cm(n)?Cr.R32F:Cr.RGBA8;if(!this._shadowRenderPass){var a=new Xo;a.format=o,a.loadOp=Wr.CLEAR,a.storeOp=qr.STORE,a.sampleCount=1;var s=new Yo;s.format=Cr.DEPTH_STENCIL,s.depthLoadOp=Wr.CLEAR,s.depthStoreOp=qr.DISCARD,s.stencilLoadOp=Wr.CLEAR,s.stencilStoreOp=qr.DISCARD,s.sampleCount=1;var c=new Zo([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new Do(Dr.TEX2D,Mr.COLOR_ATTACHMENT|Mr.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new Do(Dr.TEX2D,Mr.DEPTH_STENCIL_ATTACHMENT,Cr.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new ea(this._shadowRenderPass,l,u));r.set(t,h)},n.clearShadowMap=function(e,t){var n=this._pipeline,i=n.pipelineSceneData,r=t.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=i.shadowFrameBufferMap.get(u),f=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var _=0;_<this._stages.length;_++){var p=this._stages[_];p.setUsage(f,u,h),p.clearFramebuffer(t)}}},n.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=cm(i)?Cr.R32F:Cr.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new Do(Dr.TEX2D,Mr.COLOR_ATTACHMENT|Mr.SAMPLED,o,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new ea(h,l,u)),s=a.next()}else s=a.next()}e.shadowMapDirty=!1},t}(RS),CE.initInfo={name:qp,priority:kS.SHADOW,tag:TT.SCENE,stages:[]},bE=AE))||bE),DE=new Hi,ME=Qe({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),NE=ME.LAYERED+1,LE=function(){function e(){this._fogColor=new vi("#C8C8C8"),this._colorArray=new Hi(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var t=e.prototype;return t._setType=function(e){this._type=this.enabled?e:NE},t._setEnable=function(e){this._enabled=e},t._setAccurate=function(e){this._accurate=e},t.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=i.director.root,t=this.enabled?this.type:NE,n=this.accurate?1:0,r=e.pipeline;r.macros.CC_USE_FOG===t&&r.macros.CC_USE_ACCURATE_FOG===n||(r.macros.CC_USE_FOG=t,r.macros.CC_USE_ACCURATE_FOG=n,e.onGlobalPipelineStateChanged())},t._destroy=function(){},t.destroy=function(){this._destroy()},L(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=NE,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),DE.set(e.x,e.y,e.z,e.w),Sg(this._colorArray,DE)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),e}();function BE(e,t){for(var n,i=W(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?BE(e,r):e.push(r)}}function FE(e){var t=[];return BE(t,e),t.join("")}i.Fog=LE;var zE=Qt.Flags.Destroyed,UE=Qt.Flags.PersistentMask,kE=Vt.IDENTIFIER_RE,GE="var ",HE="o",VE={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},jE=Vt.escapeForJS,WE=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return GE+this.varName+"="+this.expression+";"},e}();function qE(e,t){return t instanceof WE?new WE(t.varName,e+t.expression):e+t}function XE(e,t,n){Array.isArray(n)?(n[0]=qE(t,n[0]),e.push(n)):e.push(qE(t,n)+";")}var YE=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];XE(e,t+KE(i[0])+"=",i[1])}},e}();function KE(e){return kE.test(e)?"."+e:"["+jE(e)+"]"}YE.pool=void 0,YE.pool=new ke((function(e){e._exps.length=0,e._targetExp=null}),1),YE.pool.get=function(e){var t=this._get()||new YE;return t._targetExp=e,t};var QE=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=_e(),be(this.funcModuleCache,VE),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=GE+this.globalVariables.join(",")+";");var i=FE(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=pe(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var o=this.funcs.indexOf(e);o<0&&(o=this.funcs.length,this.funcs.push(e));var a="F["+o+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var r=YE.pool.get(i),o=t.constructor.__props__;o||(o=Object.keys(t));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),YE.pool.put(r)},t.enumerateCCClass=function(e,t,n){for(var r=n.__values__,o=St(n),a=0;a<r.length;a++){var s=r[a],c=t[s],l=o[s+"$_$default"];if(!ZE(l,c))if("object"==typeof c&&c instanceof i.ValueType&&(l=Vt.getDefault(l))&&l.constructor===c.constructor){var u=HE+KE(s);this.setValueType(e,l,c,u)}else this.setObjProp(e,t,s,c)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new WE(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)XE(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new WE(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&XE(i,n+"["+r+"]=",e[r]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=qE(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?jE(n):("_objFlags"===t&&e instanceof Qt&&(n&=UE),n)},t.setObjProp=function(e,t,n,i){XE(e,HE+KE(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if(i.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var o=t[r];"object"==typeof o&&o&&o===t._iN$t||this.setObjProp(e,t,r,o)}},t.instantiateObj=function(e){if(e instanceof i.ValueType)return Vt.getNewValueTypeCode(e);if(e instanceof i.Asset)return this.getObjRef(e);if(e._objFlags&zE)return null;var t,n=e.constructor;if(i.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof i.Component){if(e instanceof i._BaseNode||e instanceof i.Component)return this.getObjRef(e)}else if(this.parent instanceof i._BaseNode)if(e instanceof i._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof i.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new WE(HE,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new WE(HE,"{}");else{if(n)return this.getObjRef(e);t=new WE(HE,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]},e}();function ZE(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof i.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return se(e)&&se(t)}return!1}var JE,$E,eb,tb,nb,ib,rb,ob,ab,sb,cb=function(){function e(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.opacityDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}return e.prototype.applyOpacity=function(e){this._opacity=this._localOpacity*e},e.markOpacityTree=function(t,n){void 0===n&&(n=!0),t._uiProps.opacityDirty=n;for(var i=0,r=t.children.length;i<r;i++){var o=t.children[i];e.markOpacityTree(o,n)}},L(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?b(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(t){this._localOpacity=t,e.markOpacityTree(this._node)}}]),e}();Qt.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(JE||(JE={}));var lb=Qt.Flags.Destroying,ub=Qt.Flags.DontDestroy,hb=Qt.Flags.Deactivating,fb=new te("Node");function _b(e){return e?"string"==typeof e?ze(e):e:(A(3804),null)}var pb,db,mb,vb,gb,yb,Sb,xb,Tb,Eb,bb,Cb=e("BaseNode",sl("cc.BaseNode")((sb=ab=function(e){F(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===t)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===t&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],o=n._findComponent(r,t);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,t)))return o}return null},n._findChildComponents=function(e,t,i){for(var r=0;r<e.length;++r){var o=e[r];n._findComponents(o,t,i),o._children.length>0&&n._findChildComponents(o._children,t,i)}};var t=n.prototype;function n(t){var n;return q(n=e.call(this,t)||this,"_parent",tb,V(n)),q(n,"_children",nb,V(n)),q(n,"_active",ib,V(n)),q(n,"_components",rb,V(n)),q(n,"_prefab",ob,V(n)),n._scene=null,n._activeInHierarchy=!1,n._id=fb.getNewId(),n._name=void 0,n._eventProcessor=new i.NodeEventProcessor(V(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?d("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){be(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(JE.PARENT_CHANGED,n),n&&!(n._objFlags&lb)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(JE.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(JE.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return _("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return _("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&hb)A(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&e?e(o):l&&t&&t(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=_b(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=_b(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=_b(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=_b(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=ze(e)))throw i._RF.peek()&&A(3808,e),TypeError(P(3807,e))}else{if(!e)throw TypeError(P(3804));t=e}if("function"!=typeof t)throw TypeError(P(3809));if(!we(t,i.Component))throw TypeError(P(3810));var n=t._requireComponent;if(n)if(Array.isArray(n))for(var r=0;r<n.length;r++){var o=n[r];this.getComponent(o)||this.addComponent(o)}else{var a=n;this.getComponent(a)||this.addComponent(a)}var s=new t;return s.node=this,this._components.push(s),this._activeInHierarchy&&i.director._nodeActivator.activateComp(s),s},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof oh?e:this.getComponent(e))&&t.destroy()}else A(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case JE.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case JE.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(JE.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&lb)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&A(3815)}}else A(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(JE.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=i.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof i.Scene||i.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&i.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=lb;var e=this._parent,t=!!e&&0!=(e._objFlags&lb);if(this._persistNode&&i.game.removePersistRootNode(this),!t&&e){this.emit(JE.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(JE.CHILD_REMOVED,this)}this.emit(JE.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var r=this._children,o=0;o<r.length;++o)r[o]._destroyImmediate();for(var a=this._components,s=0;s<a.length;++s)a[s]._destroyImmediate();return t},L(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&ub)>0},set:function(e){e?this._objFlags|=ub:this._objFlags&=~ub}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&i.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(Qt),ab.idGenerator=fb,ab._stacks=[[]],ab._stackId=0,X((eb=sb).prototype,"_persistNode",[hl],Object.getOwnPropertyDescriptor(eb.prototype,"_persistNode"),eb.prototype),X(eb.prototype,"name",[bl],Object.getOwnPropertyDescriptor(eb.prototype,"name"),eb.prototype),X(eb.prototype,"children",[bl],Object.getOwnPropertyDescriptor(eb.prototype,"children"),eb.prototype),X(eb.prototype,"active",[bl],Object.getOwnPropertyDescriptor(eb.prototype,"active"),eb.prototype),X(eb.prototype,"activeInHierarchy",[bl],Object.getOwnPropertyDescriptor(eb.prototype,"activeInHierarchy"),eb.prototype),X(eb.prototype,"parent",[bl],Object.getOwnPropertyDescriptor(eb.prototype,"parent"),eb.prototype),tb=X(eb.prototype,"_parent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nb=X(eb.prototype,"_children",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ib=X(eb.prototype,"_active",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rb=X(eb.prototype,"_components",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ob=X(eb.prototype,"_prefab",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$E=eb))||$E);i._BaseNode=Cb;var Ab=new yi,wb=new Ai,Rb=new Ai,Ib=new Ai,Pb=new Ei,Ob=new Ei,Db=new Ni,Mb=[],Nb=[],Lb=[],Bb=function(){function e(){this._chunks=[],this._freelists=[],this._createChunk()}var t=e.prototype;return t.alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},t.free=function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)},t.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},t._createChunk=function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)},t._createView=function(e){return Lb[0]=this._chunks[e],Lb[1]=this._freelists[e].pop(),Lb},e}();Bb.CAPACITY_PER_CHUNK=256;var Fb,zb,Ub,kb,Gb,Hb,Vb,jb,Wb,qb,Xb,Yb,Kb,Qb,Zb,Jb,$b,eC,tC,nC,iC,rC,oC,aC,sC,cC,lC,uC,hC,fC,_C,pC,dC,mC,vC,gC,yC,SC,xC,TC,EC,bC,CC,AC,wC,RC,IC,PC,OC,DC,MC,NC,LC,BC,FC,zC,UC,kC,GC,HC,VC,jC,WC,qC,XC,YC,KC,QC,ZC,JC=new Bb,$C=Symbol("ReserveContentsForAllSyncablePrefab"),eA=e("Node",(pb=sl("cc.Node"),db=Hl(yi),pb((bb=Eb=function(e){F(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._uiProps=new cb(V(n)),n._static=!1,q(n,"_lpos",gb,V(n)),q(n,"_lrot",yb,V(n)),q(n,"_lscale",Sb,V(n)),q(n,"_layer",xb,V(n)),q(n,"_euler",Tb,V(n)),n._dirtyFlagsPri=ig.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return t._init=function(){var e=JC.alloc(),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new yi,this._rot=new Ai,this._scale=new yi(1,1,1),this._mat=new Ni},n.isNode=function(e){return e instanceof n&&(e.constructor===n||!(e instanceof i.Scene))},t._onPreDestroy=function(){var e=this._onPreDestroyBase();return JC.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},t[mh]=function(e){e.writeThis()},t.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},t._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),Ni.multiply(Db,Ni.invert(Db,i._mat),this._mat),Ni.toRTS(Db,this._lrot,this._lpos,this._lscale)):(yi.copy(this._lpos,this._pos),Ai.copy(this._lrot,this._rot),yi.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(ig.TRS)},t._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},t._onBatchCreated=function(e){this.hasChangedFlags=ig.TRS,this._dirtyFlags|=ig.TRS;for(var t=this._children.length,n=0;n<t;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(ig.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},t.translate=function(e,t){var n=t||ng.LOCAL;if(n===ng.LOCAL)yi.transformQuat(Ab,e,this._lrot),this._lpos.x+=Ab.x,this._lpos.y+=Ab.y,this._lpos.z+=Ab.z;else if(n===ng.WORLD)if(this._parent){Ai.invert(wb,this._parent.worldRotation),yi.transformQuat(Ab,e,wb);var i=this.worldScale;this._lpos.x+=Ab.x/i.x,this._lpos.y+=Ab.y/i.y,this._lpos.z+=Ab.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(ig.POSITION),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.POSITION)},t.rotate=function(e,t){var n=t||ng.LOCAL;if(Ai.normalize(wb,e),n===ng.LOCAL)Ai.multiply(this._lrot,this._lrot,wb);else if(n===ng.WORLD){var i=this.worldRotation;Ai.multiply(Rb,wb,i),Ai.invert(wb,i),Ai.multiply(Rb,wb,Rb),Ai.multiply(this._lrot,this._lrot,Rb)}this._eulerDirty=!0,this.invalidateChildren(ig.ROTATION),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(Ab),yi.subtract(Ab,Ab,e),yi.normalize(Ab,Ab),Ai.fromViewUp(wb,Ab,t),this.setWorldRotation(wb)},t._setDirtyNode=function(e,t){Mb[e]=t},t.invalidateChildren=function(e){var t,n,i,r=0,o=0,a=0,s=0,c=0,l=e|ig.POSITION;for(Mb[0]=this;r>=0;){if(c=(t=Mb[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._hasChangedFlags[0]=c|e,a=(i=t._children).length,o=0;o<a;o++)n=i[o],Mb[++r]=n;e=l}},t.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=Mb[--n])._dirtyFlags,t?(i&ig.POSITION&&(yi.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&ig.RS&&(Ni.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Ni.multiply(e._mat,t._mat,e._mat),i&ig.ROTATION&&Ai.multiply(e._rot,t._rot,e._lrot),Ei.fromQuat(Pb,Ai.conjugate(Ib,e._rot)),Ei.multiplyMat4(Pb,Pb,e._mat),e._scale.x=Pb.m00,e._scale.y=Pb.m04,e._scale.z=Pb.m08)):(i&ig.POSITION&&(yi.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&ig.RS&&(i&ig.ROTATION&&Ai.copy(e._rot,e._lrot),i&ig.SCALE&&(yi.copy(e._scale,e._lscale),Ni.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=ig.NONE,t=e}},t.setPosition=function(e,t,n){void 0===t&&void 0===n?yi.copy(this._lpos,e):void 0===n?yi.set(this._lpos,e,t,this._lpos.z):yi.set(this._lpos,e,t,n),this.invalidateChildren(ig.POSITION),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.POSITION)},t.getPosition=function(e){return e?yi.set(e,this._lpos.x,this._lpos.y,this._lpos.z):yi.copy(new yi,this._lpos)},t.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Ai.copy(this._lrot,e):Ai.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(ig.ROTATION),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.ROTATION)},t.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(yi.copy(this._euler,e),Ai.fromEuler(this._lrot,e.x,e.y,e.z)):(yi.set(this._euler,e,t,i),Ai.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(ig.ROTATION),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.ROTATION)},t.getRotation=function(e){return e?Ai.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Ai.copy(new Ai,this._lrot)},t.setScale=function(e,t,n){void 0===t&&void 0===n?yi.copy(this._lscale,e):void 0===n?yi.set(this._lscale,e,t,this._lscale.z):yi.set(this._lscale,e,t,n),this.invalidateChildren(ig.SCALE),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.SCALE)},t.getScale=function(e){return e?yi.set(e,this._lscale.x,this._lscale.y,this._lscale.z):yi.copy(new yi,this._lscale)},t.inverseTransformPoint=function(e,t){yi.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)yi.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=Mb[--i];return e},t.setWorldPosition=function(e,t,n){void 0===t||void 0===n?yi.copy(this._pos,e):yi.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),yi.transformMat4(r,this._pos,Ni.invert(Db,i._mat))):yi.copy(r,this._pos),this.invalidateChildren(ig.POSITION),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?yi.copy(e,this._pos):yi.copy(new yi,this._pos)},t.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Ai.copy(this._rot,e):Ai.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),Ai.multiply(this._lrot,Ai.conjugate(this._lrot,this._parent._rot),this._rot)):Ai.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(ig.ROTATION),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.ROTATION)},t.setWorldRotationFromEuler=function(e,t,n){Ai.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),Ai.multiply(this._lrot,Ai.conjugate(this._lrot,this._parent._rot),this._rot)):Ai.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(ig.ROTATION),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?Ai.copy(e,this._rot):Ai.copy(new Ai,this._rot)},t.setWorldScale=function(e,t,n){void 0===t||void 0===n?yi.copy(this._scale,e):yi.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),Ei.fromQuat(Pb,Ai.conjugate(Ib,i._rot)),Ei.multiplyMat4(Pb,Pb,i._mat),Ob.m00=this._scale.x,Ob.m04=this._scale.y,Ob.m08=this._scale.z,Ei.multiply(Pb,Ob,Ei.invert(Pb,Pb)),this._lscale.x=yi.set(Ab,Pb.m00,Pb.m01,Pb.m02).length(),this._lscale.y=yi.set(Ab,Pb.m03,Pb.m04,Pb.m05).length(),this._lscale.z=yi.set(Ab,Pb.m06,Pb.m07,Pb.m08).length()):yi.copy(this._lscale,this._scale),this.invalidateChildren(ig.SCALE),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?yi.copy(e,this._scale):yi.copy(new yi,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new Ni;return Ni.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new Ni;return Ni.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new Ni;return Ni.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,n){var i=0;e&&(i|=ig.ROTATION,void 0!==e.w?(Ai.copy(this._lrot,e),this._eulerDirty=!0):(yi.copy(this._euler,e),Ai.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(yi.copy(this._lpos,t),i|=ig.POSITION),n&&(yi.copy(this._lscale,n),i|=ig.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,i))},t.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},t.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},n.resetHasChangedFlags=function(){JC.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,Mb.length=0,Nb.length=0)},L(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Ai.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){yi.set(this._euler,0,0,e),Ai.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(ig.ROTATION),1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){Ni.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(ig.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(JE.TRANSFORM_CHANGED,ig.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return yi.transformQuat(new yi,yi.FORWARD,this.worldRotation)},set:function(e){var t=e.length();yi.multiplyScalar(Ab,e,-1/t),Ai.fromViewUp(wb,Ab),this.setWorldRotation(wb)}},{key:"up",get:function(){return yi.transformQuat(new yi,yi.UP,this.worldRotation)}},{key:"right",get:function(){return yi.transformQuat(new yi,yi.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(JE.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),n}(Cb),Eb.EventType=JE,Eb.NodeSpace=ng,Eb.TransformDirtyBit=ig,Eb.TransformBit=ig,Eb.reserveContentsForAllSyncablePrefabTag=$C,Eb.ClearFrame=0,Eb.ClearRound=1e3,gb=X((vb=bb).prototype,"_lpos",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),yb=X(vb.prototype,"_lrot",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ai}}),Sb=X(vb.prototype,"_lscale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(1,1,1)}}),xb=X(vb.prototype,"_layer",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gp.Enum.DEFAULT}}),Tb=X(vb.prototype,"_euler",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),X(vb.prototype,"eulerAngles",[db],Object.getOwnPropertyDescriptor(vb.prototype,"eulerAngles"),vb.prototype),X(vb.prototype,"angle",[bl],Object.getOwnPropertyDescriptor(vb.prototype,"angle"),vb.prototype),X(vb.prototype,"layer",[bl],Object.getOwnPropertyDescriptor(vb.prototype,"layer"),vb.prototype),mb=vb))||mb));i.Node=eA;var tA=sl("cc.TargetInfo")((Ub=X((zb=function(){q(this,"localID",Ub,this)}).prototype,"localID",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fb=zb))||Fb,nA=(kb=sl("cc.TargetOverrideInfo"),Gb=Hl(Qt),Hb=Hl(tA),Vb=Hl(eA),jb=Hl(tA),kb((Xb=X((qb=function(){q(this,"source",Xb,this),q(this,"sourceInfo",Yb,this),q(this,"propertyPath",Kb,this),q(this,"target",Qb,this),q(this,"targetInfo",Zb,this)}).prototype,"source",[_l,Gb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yb=X(qb.prototype,"sourceInfo",[_l,Hb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kb=X(qb.prototype,"propertyPath",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qb=X(qb.prototype,"target",[_l,Vb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zb=X(qb.prototype,"targetInfo",[_l,jb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wb=qb))||Wb),iA=sl("cc.CompPrefabInfo")((eC=X(($b=function(){q(this,"fileId",eC,this)}).prototype,"fileId",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Jb=$b))||Jb,rA=(tC=sl("CCPropertyOverrideInfo"),nC=Hl(tA),tC((cC=function(){function e(){q(this,"targetInfo",oC,this),q(this,"propertyPath",aC,this),q(this,"value",sC,this)}return e.prototype.isTarget=function(){},e}(),oC=X((rC=cC).prototype,"targetInfo",[_l,nC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aC=X(rC.prototype,"propertyPath",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sC=X(rC.prototype,"value",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),iC=rC))||iC),oA=(lC=sl("cc.MountedChildrenInfo"),uC=Hl(tA),hC=Hl([eA]),lC((mC=function(){function e(){q(this,"targetInfo",pC,this),q(this,"nodes",dC,this)}return e.prototype.isTarget=function(){},e}(),pC=X((_C=mC).prototype,"targetInfo",[_l,uC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dC=X(_C.prototype,"nodes",[_l,hC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fC=_C))||fC),aA=(vC=sl("cc.MountedComponentsInfo"),gC=Hl(tA),yC=Hl([oh]),vC((bC=function(){function e(){q(this,"targetInfo",TC,this),q(this,"components",EC,this)}return e.prototype.isTarget=function(){},e}(),TC=X((xC=bC).prototype,"targetInfo",[_l,gC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EC=X(xC.prototype,"components",[_l,yC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SC=xC))||SC),sA=(CC=sl("cc.PrefabInstance"),AC=Hl(eA),wC=Hl([oA]),RC=Hl([aA]),IC=Hl([rA]),PC=Hl([tA]),CC((UC=function(){function e(){q(this,"fileId",MC,this),q(this,"prefabRootNode",NC,this),q(this,"mountedChildren",LC,this),q(this,"mountedComponents",BC,this),q(this,"propertyOverrides",FC,this),q(this,"removedComponents",zC,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),MC=X((DC=UC).prototype,"fileId",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),NC=X(DC.prototype,"prefabRootNode",[_l,AC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),LC=X(DC.prototype,"mountedChildren",[_l,wC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BC=X(DC.prototype,"mountedComponents",[_l,RC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),FC=X(DC.prototype,"propertyOverrides",[_l,IC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zC=X(DC.prototype,"removedComponents",[_l,PC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),OC=DC))||OC),cA=(kC=sl("cc.PrefabInfo"),GC=Hl(eA),HC=Hl(sA),VC=Hl([nA]),kC((qC=X((WC=function(){q(this,"root",qC,this),q(this,"asset",XC,this),q(this,"fileId",YC,this),q(this,"instance",KC,this),q(this,"targetOverrides",QC,this),q(this,"nestedPrefabInstanceRoots",ZC,this)}).prototype,"root",[_l,GC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),XC=X(WC.prototype,"asset",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),YC=X(WC.prototype,"fileId",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),KC=X(WC.prototype,"instance",[_l,HC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QC=X(WC.prototype,"targetOverrides",[_l,VC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ZC=X(WC.prototype,"nestedPrefabInstanceRoots",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),jC=WC))||jC);function lA(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return A(3701,e.name),void(t.instance=void 0);var n=e._objFlags,r=e._parent,o=e._id,a=e._prefab;e[Xt],i.game._isCloning=!0,t.asset._doInstantiate(e),i.game._isCloning=!1,e._objFlags=n,e._parent=r,e._id=o,e._prefab&&(e._prefab.instance=null==a?void 0:a.instance)}}function uA(e,t,n){var i;if(t&&e){var r=t,o=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&o&&(t[o.fileId]={},r=t[o.fileId]);var a=e._prefab;a&&(r[a.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)uA(e.children[u],r,!1)}}function hA(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function fA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=hA(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,uA(u,a,!1),u._siblingIndex=o._children.length-1,vA(u,!0))}}}}function _A(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=hA(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function pA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var o=hA(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function dA(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var o=t[r];if(o&&o.targetInfo){if(!(i=hA(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof et?a[c].set(o.value):a[c]=o.value}}}}function mA(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=hA(c.localID,h.targetMap))}if(s){var f,_=a.targetInfo;if(_){var p=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(p&&p.targetMap&&(f=hA(_.localID,p.targetMap))){var d=a.propertyPath.slice(),m=s;if(d.length>0){var v=d.pop();if(!v)return;for(var g=0;g<d.length&&(m=m[d[g]]);g++);if(!m)continue;m[v]=f}}}}}}function vA(e,t){void 0===t&&(t=!1);var n=e._prefab,i=null==n?void 0:n.instance;if(i){lA(e);var r={};i.targetMap=r,uA(e,r,!0),fA(0,i.mountedChildren,r),pA(0,i.removedComponents,r),_A(0,i.mountedComponents,r),dA(0,i.propertyOverrides,r)}t&&e&&e.children&&e.children.forEach((function(e){vA(e,!0)}))}function gA(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){vA(e)}))}i._PrefabInfo=cA;var yA,SA,xA,TA,EA,bA,CA,AA,wA,RA,IA,PA,OA,DA=Object.freeze({__proto__:null,TargetInfo:tA,TargetOverrideInfo:nA,CompPrefabInfo:iA,PropertyOverrideInfo:rA,MountedChildrenInfo:oA,MountedComponentsInfo:aA,PrefabInstance:sA,PrefabInfo:cA,createNodeWithPrefab:lA,generateTargetMap:uA,getTarget:hA,applyMountedChildren:fA,applyMountedComponents:_A,applyRemovedComponents:pA,applyPropertyOverrides:dA,applyTargetOverrides:mA,expandPrefabInstanceNode:vA,expandNestedPrefabInstanceNode:gA}),MA=Qe({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),NA=e("Prefab",sl("cc.Prefab")((bA=EA=function(e){function t(){var t;return q(t=e.call(this)||this,"data",xA,V(t)),q(t,"optimizationPolicy",TA,V(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}F(t,e);var n=t.prototype;return n.createNode=function(e){var t=i.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof i._BaseNode&&e,new QE(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||b(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==MA.SINGLE_INSTANCE&&(this.optimizationPolicy===MA.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new eA,this.data.name="(Missing Node)";var n=new i._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var e=this.data;gA(e),mA(e)},t}(zu),EA.OptimizationPolicy=MA,EA.OptimizationPolicyThreshold=3,xA=X((SA=bA).prototype,"data",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TA=X(SA.prototype,"optimizationPolicy",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MA.AUTO}}),yA=SA))||yA);He.value(NA,"_utils",DA),i.Prefab=NA,de(i,"cc._Prefab","Prefab"),e("PrefabLink",(CA=sl("cc.PrefabLink"),AA=Hl(NA),wA=Cl(),CA((OA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"prefab",PA,V(t)),t}return F(t,e),t}(oh),PA=X((IA=OA).prototype,"prefab",[AA,_l,wA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RA=IA))||RA));var LA=new yi;function BA(e,t,n,i){i||(i=new yi),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function FA(e,t,n){return n||(n=new yi),e.worldToScreen(t,n),n.x/=i.view.getScaleX(),n.y/=i.view.getScaleY(),n}var zA,UA,kA=e("convertUtils",{WorldNode3DToLocalNodeUI:BA,WorldNode3DToWorldNodeUI:FA});i.pipelineUtils=kA,zn(i.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||LA;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),Un(Gm.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),zn(CT.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var GA,HA=e("BufferAsset",sl("cc.BufferAsset")((X((UA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}F(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},L(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(zu)).prototype,"_nativeAsset",[Jl],Object.getOwnPropertyDescriptor(UA.prototype,"_nativeAsset"),UA.prototype),zA=UA))||zA);i.BufferAsset=HA;var VA=((GA={})[Ar.UNORM]="Uint",GA[Ar.SNORM]="Int",GA[Ar.UINT]="Uint",GA[Ar.INT]="Int",GA[Ar.UFLOAT]="Float",GA[Ar.FLOAT]="Float",GA.default="Uint",GA);function jA(e){return""+(VA[e.type]||VA.default)+e.size/e.count*8}function WA(e,t,n,i,r){void 0===n&&(n=Cr.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=pa[n];r||(r=o.size);for(var a="set"+jA(o),s=o.size/o.count,c=Math.floor(t.length/o.count),l=dh.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,f=0;f<o.count;++f){var _=h+s*f;e[a](_,t[o.count*u+f],l)}}function qA(e,t,n,i,r,o){void 0===t&&(t=Cr.R32F),void 0===n&&(n=0),void 0===i&&(i=e.byteLength-n),void 0===r&&(r=0),void 0===o&&(o=[]);var a=pa[t];r||(r=a.size);for(var s="get"+jA(a),c=a.size/a.count,l=Math.floor(i/r),u=dh.isLittleEndian,h=0;h<l;++h)for(var f=n+r*h,_=0;_<a.count;++_){var p=f+c*_;o[a.count*h+_]=e[s](p,u)}return o}function XA(e,t,n,i,r,o,a){void 0===n&&(n=Cr.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=pa[n];o||(o=s.size);for(var c="set"+jA(s),l="get"+jA(s),u=s.size/s.count,h=Math.floor(r/o),f=dh.isLittleEndian,_=0;_<h;++_)for(var p=i+o*_,d=0;d<s.count;++d){var m=p+u*d,v=e[l](m,f);a[c](m,t(v,d,e),f)}return a}var YA,KA,QA=e("RenderingSubMesh",function(){var e=t.prototype;function t(e,t,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new qo(t,e,i,r),this._init()}return e._init=function(){},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=e.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(e.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),f=0;f<t;++f)for(var _=f*s,p=h[f]*s,d=0;d<s;++d)u[_+d]=l[p+d];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(e.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},e.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new jo("a_vertexId",Cr.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},e._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},L(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:yi.ZERO,max:yi.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:yi.ZERO,max:yi.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,uo.ATTR_POSITION),i=e.readIndices(t),r=new yi,o=new yi,a=this.attributes.find((function(e){return e.name===uo.ATTR_POSITION}));if(a){var s=pa[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var r,o,a=this.mesh.struct,s=a.primitives[this.subMeshIdx];if(!a.jointMaps||void 0===s.jointMapIndex||!a.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var c=i.director.root.device,l=0;l<s.vertexBundelIndices.length;l++){var u=a.vertexBundles[s.vertexBundelIndices[l]];o=0,r=Cr.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var f=u.attributes[h];if(f.name===uo.ATTR_JOINTS){r=f.format;break}o+=pa[f.format].size}r?function(){var i=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(i.slice().buffer),f=a.jointMaps[s.jointMapIndex];XA(h,(function(e){return f.indexOf(e)}),r,o,u.view.length,u.view.stride,h);var _=c.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.DEVICE,u.view.length,u.view.stride));_.update(h.buffer),t.push(_),n.push(l)}():t.push(this.vertexBuffers[s.vertexBundelIndices[l]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(c)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}());!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(YA||(YA=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion"}(KA||(KA={})),i.SystemEventType=YA;var ZA,JA=new Array(16),$A=null,ew=new zi,tw=[JE.TOUCH_START,JE.TOUCH_MOVE,JE.TOUCH_END,JE.TOUCH_CANCEL],nw=[JE.MOUSE_DOWN,JE.MOUSE_ENTER,JE.MOUSE_MOVE,JE.MOUSE_LEAVE,JE.MOUSE_UP,JE.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR"}(ZA||(ZA={}));var iw,rw,ow,aw,sw,cw,lw,uw,hw,fw,_w,pw,dw,mw,vw,gw,yw,Sw,xw,Tw,Ew,bw,Cw,Aw,ww,Rw,Iw,Pw,Ow,Dw,Mw,Nw,Lw,Bw,Fw,zw,Uw,kw,Gw,Hw,Vw,jw,Ww,qw,Xw,Yw,Kw,Qw,Zw,Jw,$w,eR,tR,nR,iR,rR,oR,aR,sR,cR,lR,uR,hR,fR,_R,pR,dR,mR,vR,gR,yR,SR,xR,TR,ER,bR,CR,AR,wR,RR,IR,PR,OR,DR,MR,NR,LR,BR,FR,zR,UR,kR,GR,HR,VR,jR,WR,qR,XR,YR,KR,QR,ZR,JR,$R,eI,tI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,fI,_I,pI,dI,mI,vI,gI,yI,SI,xI,TI,EI,bI,CI,AI,wI,RI,II,PI,OI,DI,MI,NI,LI,BI,FI,zI,UI,kI,GI,HI,VI,jI,WI,qI,XI,YI,KI,QI,ZI,JI,$I,eP,tP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,fP,_P,pP,dP,mP,vP,gP,yP,SP,xP,TP,EP,bP,CP,AP,wP,RP,IP,PP,OP,DP,MP,NP,LP,BP,FP=function(){var e=t.prototype;function t(e){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=e}return e.setEnabled=function(e,t){void 0===t&&(t=!1),this._isEnabled=e;var n=this.node.children;if(e&&this._attachMask(),t&&n.length>0)for(var i=0;i<n.length;++i)n[i]._eventProcessor.setEnabled(e,!0)},e._searchComponentsInParent=function(e){var t=this.node;if(e){for(var n=0,i=[],r=t;r&&eA.isNode(r);r=r.parent,++n){var o=r.getComponent(e);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},e._attachMask=function(){this.maskList=this._searchComponentsInParent(t._maskComp)},e.reattach=function(){var e,n=this;this.node.walk((function(i){e||(e=n._searchComponentsInParent(t._maskComp)),i.eventProcessor.maskList=e}))},e.destroy=function(){$A===this._node&&($A=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),t.callbacksInvoker.emit(ZA.REMOVE_POINTER_EVENT_PROCESSOR,this)},e._isTouchEvent=function(e){return-1!==tw.indexOf(e)},e._isMouseEvent=function(e){return-1!==nw.indexOf(e)},e._hasTouchListeners=function(){for(var e=0;e<tw.length;++e){var t=tw[e];if(this.hasEventListener(t))return!0}return!1},e._hasMouseListeners=function(){for(var e=0;e<nw.length;++e){var t=nw[e];if(this.hasEventListener(t))return!0}return!1},e._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},e._tryEmittingAddEvent=function(e){var n=this._isTouchEvent(e),i=this._isMouseEvent(e);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||t.callbacksInvoker.emit(ZA.ADD_POINTER_EVENT_PROCESSOR,this)},e._newCallbacksInvoker=function(){var e=this,n=new an;return n._registerOffCallback((function(){e.shouldHandleEventTouch&&!e._hasTouchListeners()&&(e.shouldHandleEventTouch=!1),e.shouldHandleEventMouse&&!e._hasMouseListeners()&&(e.shouldHandleEventMouse=!1),e._hasPointerListeners()||t.callbacksInvoker.emit(ZA.REMOVE_POINTER_EVENT_PROCESSOR,e)})),n},e.on=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n),t},e.once=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n,!0),t},e.off=function(e,t,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,n)},e.targetOff=function(e){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(e),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(e),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||t.callbacksInvoker.emit(ZA.REMOVE_POINTER_EVENT_PROCESSOR,this)},e.emit=function(e,t,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(e,t,n,i,r,o)},e.dispatchEvent=function(e){var t,n=this.node,i=0;for(e.target=n,JA.length=0,this.getCapturingTargets(e.type,JA),e.eventPhase=1,i=JA.length-1;i>=0;--i)if((t=JA[i]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,JA),e.propagationStopped))return void(JA.length=0);if(JA.length=0,e.eventPhase=2,e.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,JA),e.eventPhase=3,i=0;i<JA.length;++i)if((t=JA[i]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(JA.length=0);JA.length=0},e.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(e,t,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(e,t,n)),i},e.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},e.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},e._handleEventMouse=function(e){switch(e.type){case KA.MOUSE_DOWN:return this._handleMouseDown(e);case KA.MOUSE_MOVE:return this._handleMouseMove(e);case KA.MOUSE_UP:return this._handleMouseUp(e);case KA.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},e._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(ew=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(ew)||(e.type=JE.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(ew=e.getUILocation(),t._uiProps.uiTransformComp.isHit(ew)?(this.previousMouseIn||($A&&$A!==t&&(e.type=JE.MOUSE_LEAVE,$A.dispatchEvent(e),$A.eventProcessor.previousMouseIn=!1),$A=t,e.type=JE.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=JE.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=JE.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,$A=null),1)))},e._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(ew=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(ew)||(e.type=JE.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(ew=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(ew)||(e.type=JE.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleEventTouch=function(e){switch(e.type){case KA.TOUCH_START:return this._handleTouchStart(e);case KA.TOUCH_MOVE:return this._handleTouchMove(e);case KA.TOUCH_END:return this._handleTouchEnd(e);case KA.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},e._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getUILocation(ew),!t._uiProps.uiTransformComp.isHit(ew)||(e.type=JE.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))},e._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=JE.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))},e._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getUILocation(ew),t._uiProps.uiTransformComp.isHit(ew)?e.type=JE.TOUCH_END:e.type=JE.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},e._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=JE.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},L(t,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),t}();FP._maskComp=null,FP.callbacksInvoker=new an,i.NodeEventProcessor=FP;var zP=new yi(0,1,0),UP=new yi,kP=new Hi,GP=new vi,HP=new Ai,VP=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},jP=(iw=sl("cc.AmbientInfo"),rw=El(),ow=pl("_skyColor"),aw=pl("_skyIllum"),sw=pl("_groundAlbedo"),cw=Cl(),lw=Rl(),uw=Hl(bt),hw=Rl(),fw=Cl(),_w=Rl(),iw(pw=rw((Tw=function(){function e(){q(this,"_skyColorHDR",mw,this),q(this,"_skyIllumHDR",vw,this),q(this,"_groundAlbedoHDR",gw,this),q(this,"_skyColorLDR",yw,this),q(this,"_skyIllumLDR",Sw,this),q(this,"_groundAlbedoLDR",xw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},L(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=i.director.root.pipeline.pipelineSceneData.isHDR;return kP.set(e?this._skyColorHDR:this._skyColorLDR),VP(kP),GP.set(255*kP.x,255*kP.y,255*kP.z,255)},set:function(e){kP.set(e.x,e.y,e.z,e.w),i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(kP):this._skyColorLDR.set(kP),this._resource&&this._resource.skyColor.set(kP)}},{key:"skyColor",set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=i.director.root.pipeline.pipelineSceneData.isHDR;return kP.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),VP(kP),GP.set(255*kP.x,255*kP.y,255*kP.z,255)},set:function(e){kP.set(e.x,e.y,e.z,e.w),i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(kP):this._groundAlbedoLDR.set(kP),this._resource&&this._resource.groundAlbedo.set(kP)}},{key:"groundAlbedo",set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),e}(),mw=X((dw=Tw).prototype,"_skyColorHDR",[_l,ow],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hi(.2,.5,.8,1)}}),vw=X(dw.prototype,"_skyIllumHDR",[_l,aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ji.SKY_ILLUM}}),gw=X(dw.prototype,"_groundAlbedoHDR",[_l,sw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hi(.2,.2,.2,1)}}),yw=X(dw.prototype,"_skyColorLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hi(.2,.5,.8,1)}}),Sw=X(dw.prototype,"_skyIllumLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ji.SKY_ILLUM}}),xw=X(dw.prototype,"_groundAlbedoLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hi(.2,.2,.2,1)}}),X(dw.prototype,"skyLightingColor",[cw,bl,lw],Object.getOwnPropertyDescriptor(dw.prototype,"skyLightingColor"),dw.prototype),X(dw.prototype,"skyIllum",[bl,uw,hw],Object.getOwnPropertyDescriptor(dw.prototype,"skyIllum"),dw.prototype),X(dw.prototype,"groundLightingColor",[fw,bl,_w],Object.getOwnPropertyDescriptor(dw.prototype,"groundLightingColor"),dw.prototype),pw=dw))||pw)||pw);i.AmbientInfo=jP;var WP=(Ew=sl("cc.SkyboxInfo"),bw=El(),Cw=Hl(hv),Aw=pl("_envmap"),ww=Hl(hv),Rw=Hl(hv),Iw=Hl(hv),Pw=Cl(),Ow=Rl(),Dw=Rl(),Mw=Rl(),Nw=Rl(),Lw=Hl(hv),Bw=Rl(),Fw=Cl(),zw=Hl(hv),Ew(Uw=bw((Kw=function(){function e(){q(this,"_applyDiffuseMap",Gw,this),q(this,"_envmapHDR",Hw,this),q(this,"_envmapLDR",Vw,this),q(this,"_diffuseMapHDR",jw,this),q(this,"_diffuseMapLDR",Ww,this),q(this,"_enabled",qw,this),q(this,"_useIBL",Xw,this),q(this,"_useHDR",Yw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},L(e,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(e){this._applyDiffuseMap=e,this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=e:this._envmapLDR=e,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),e}(),Gw=X((kw=Kw).prototype,"_applyDiffuseMap",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hw=X(kw.prototype,"_envmapHDR",[_l,Cw,Aw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vw=X(kw.prototype,"_envmapLDR",[_l,ww],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jw=X(kw.prototype,"_diffuseMapHDR",[_l,Rw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ww=X(kw.prototype,"_diffuseMapLDR",[_l,Iw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qw=X(kw.prototype,"_enabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Xw=X(kw.prototype,"_useIBL",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Yw=X(kw.prototype,"_useHDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(kw.prototype,"applyDiffuseMap",[Pw,bl,Ow],Object.getOwnPropertyDescriptor(kw.prototype,"applyDiffuseMap"),kw.prototype),X(kw.prototype,"enabled",[bl,Dw],Object.getOwnPropertyDescriptor(kw.prototype,"enabled"),kw.prototype),X(kw.prototype,"useIBL",[bl,Mw],Object.getOwnPropertyDescriptor(kw.prototype,"useIBL"),kw.prototype),X(kw.prototype,"useHDR",[bl,Nw],Object.getOwnPropertyDescriptor(kw.prototype,"useHDR"),kw.prototype),X(kw.prototype,"envmap",[bl,Lw,Bw],Object.getOwnPropertyDescriptor(kw.prototype,"envmap"),kw.prototype),X(kw.prototype,"diffuseMap",[Fw,bl,Al,zw],Object.getOwnPropertyDescriptor(kw.prototype,"diffuseMap"),kw.prototype),Uw=kw))||Uw)||Uw);i.SkyboxInfo=WP;var qP=(Qw=sl("cc.FogInfo"),Zw=El(),Jw=Rl(),$w=Rl(),eR=Rl(),tR=Hl(ME),nR=Rl(),iR=Cl(),rR=Hl(bt),oR=Il(),aR=Dl(),sR=Nl(),cR=Rl(),lR=Cl(),uR=Hl(bt),hR=Dl(),fR=Nl(),_R=Rl(),pR=Cl(),dR=Hl(bt),mR=Dl(),vR=Nl(),gR=Rl(),yR=Cl(),SR=Hl(bt),xR=Pl(),TR=Dl(),ER=Nl(),bR=Rl(),CR=Cl(),AR=Hl(bt),wR=Dl(),RR=Nl(),IR=Rl(),PR=Cl(),OR=Hl(bt),DR=Dl(),MR=Nl(),NR=Rl(),Qw(LR=Zw((YR=XR=function(){function e(){q(this,"_type",FR,this),q(this,"_fogColor",zR,this),q(this,"_enabled",UR,this),q(this,"_fogDensity",kR,this),q(this,"_fogStart",GR,this),q(this,"_fogEnd",HR,this),q(this,"_fogAtten",VR,this),q(this,"_fogTop",jR,this),q(this,"_fogRange",WR,this),q(this,"_accurate",qR,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},L(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),XR.FogType=ME,FR=X((BR=YR).prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ME.LINEAR}}),zR=X(BR.prototype,"_fogColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi("#C8C8C8")}}),UR=X(BR.prototype,"_enabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kR=X(BR.prototype,"_fogDensity",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),GR=X(BR.prototype,"_fogStart",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),HR=X(BR.prototype,"_fogEnd",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),VR=X(BR.prototype,"_fogAtten",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),jR=X(BR.prototype,"_fogTop",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),WR=X(BR.prototype,"_fogRange",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),qR=X(BR.prototype,"_accurate",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(BR.prototype,"enabled",[bl,Jw],Object.getOwnPropertyDescriptor(BR.prototype,"enabled"),BR.prototype),X(BR.prototype,"accurate",[bl,$w],Object.getOwnPropertyDescriptor(BR.prototype,"accurate"),BR.prototype),X(BR.prototype,"fogColor",[bl,eR],Object.getOwnPropertyDescriptor(BR.prototype,"fogColor"),BR.prototype),X(BR.prototype,"type",[bl,tR,nR],Object.getOwnPropertyDescriptor(BR.prototype,"type"),BR.prototype),X(BR.prototype,"fogDensity",[iR,rR,oR,aR,Ml,sR,cR],Object.getOwnPropertyDescriptor(BR.prototype,"fogDensity"),BR.prototype),X(BR.prototype,"fogStart",[lR,uR,hR,fR,_R],Object.getOwnPropertyDescriptor(BR.prototype,"fogStart"),BR.prototype),X(BR.prototype,"fogEnd",[pR,dR,mR,vR,gR],Object.getOwnPropertyDescriptor(BR.prototype,"fogEnd"),BR.prototype),X(BR.prototype,"fogAtten",[yR,SR,xR,TR,ER,bR],Object.getOwnPropertyDescriptor(BR.prototype,"fogAtten"),BR.prototype),X(BR.prototype,"fogTop",[CR,AR,wR,RR,IR],Object.getOwnPropertyDescriptor(BR.prototype,"fogTop"),BR.prototype),X(BR.prototype,"fogRange",[PR,OR,DR,MR,NR],Object.getOwnPropertyDescriptor(BR.prototype,"fogRange"),BR.prototype),LR=BR))||LR)||LR),XP=(KR=sl("cc.ShadowsInfo"),QR=El(),ZR=Rl(),JR=Hl(Bg),$R=Cl(),eI=Cl(),tI=Rl(),nI=Hl(bt),iI=Rl(),rI=Cl(),oI=Il(),aI=Hl(bt),sI=Rl(),cI=Cl(),lI=Hl(Fg),uI=Rl(),hI=Cl(),fI=Hl(Et),_I=Cl(),pI=Hl(bt),dI=Rl(),mI=Cl(),vI=Hl(bt),gI=Rl(),yI=Cl(),SI=Hl(Lg),xI=Rl(),TI=Cl(),EI=Hl(Ct),bI=Rl(),CI=Cl(),AI=Hl(bt),wI=Rl(),RI=Cl(),II=Hl(bt),PI=Rl(),OI=Cl(),DI=Il(),MI=Hl(bt),NI=Rl(),LI=Cl(),BI=Il(),FI=Hl(bt),zI=Rl(),UI=Cl(),kI=Hl(bt),GI=Rl(),HI=Cl(),KR(VI=QR((lP=function(){function e(){q(this,"_type",WI,this),q(this,"_enabled",qI,this),q(this,"_normal",XI,this),q(this,"_distance",YI,this),q(this,"_shadowColor",KI,this),q(this,"_firstSetCSM",QI,this),q(this,"_fixedArea",ZI,this),q(this,"_pcf",JI,this),q(this,"_bias",$I,this),q(this,"_normalBias",eP,this),q(this,"_near",tP,this),q(this,"_far",nP,this),q(this,"_shadowDistance",iP,this),q(this,"_invisibleOcclusionRange",rP,this),q(this,"_orthoSize",oP,this),q(this,"_maxReceived",aP,this),q(this,"_size",sP,this),q(this,"_saturation",cP,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(HP),this.normal=yi.transformQuat(UP,zP,HP),e.getWorldPosition(UP),this.distance=yi.dot(this._normal,UP)},t.activate=function(e){this.pcf=Math.min(this._pcf,Fg.SOFT_2X),this._resource=e,this._resource.initialize(this),this._resource.activate()},L(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"normal",get:function(){return this._normal},set:function(e){yi.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"saturation",get:function(){return this._saturation},set:function(e){e>1?(this._saturation=e/e,this._resource&&(this._resource.saturation=e/e)):(this._saturation=e,this._resource&&(this._resource.saturation=e))}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e,this._resource&&(this._resource.bias=e)}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e,this._resource&&(this._resource.normalBias=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e,this._resource&&(this._resource.fixedArea=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._resource&&(this._resource.near=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=Math.min(e,Ug.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=Math.min(e,Ug.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,Ug.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}}]),e}(),WI=X((jI=lP).prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bg.Planar}}),qI=X(jI.prototype,"_enabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),XI=X(jI.prototype,"_normal",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(0,1,0)}}),YI=X(jI.prototype,"_distance",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KI=X(jI.prototype,"_shadowColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(0,0,0,76)}}),QI=X(jI.prototype,"_firstSetCSM",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZI=X(jI.prototype,"_fixedArea",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JI=X(jI.prototype,"_pcf",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fg.HARD}}),$I=X(jI.prototype,"_bias",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),eP=X(jI.prototype,"_normalBias",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tP=X(jI.prototype,"_near",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),nP=X(jI.prototype,"_far",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),iP=X(jI.prototype,"_shadowDistance",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),rP=X(jI.prototype,"_invisibleOcclusionRange",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),oP=X(jI.prototype,"_orthoSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),aP=X(jI.prototype,"_maxReceived",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),sP=X(jI.prototype,"_size",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(512,512)}}),cP=X(jI.prototype,"_saturation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),X(jI.prototype,"enabled",[bl,ZR],Object.getOwnPropertyDescriptor(jI.prototype,"enabled"),jI.prototype),X(jI.prototype,"type",[bl,JR],Object.getOwnPropertyDescriptor(jI.prototype,"type"),jI.prototype),X(jI.prototype,"shadowColor",[$R],Object.getOwnPropertyDescriptor(jI.prototype,"shadowColor"),jI.prototype),X(jI.prototype,"normal",[eI,tI],Object.getOwnPropertyDescriptor(jI.prototype,"normal"),jI.prototype),X(jI.prototype,"distance",[nI,iI,rI],Object.getOwnPropertyDescriptor(jI.prototype,"distance"),jI.prototype),X(jI.prototype,"saturation",[bl,oI,Ml,aI,sI,cI],Object.getOwnPropertyDescriptor(jI.prototype,"saturation"),jI.prototype),X(jI.prototype,"pcf",[lI,uI,hI],Object.getOwnPropertyDescriptor(jI.prototype,"pcf"),jI.prototype),X(jI.prototype,"maxReceived",[fI,_I],Object.getOwnPropertyDescriptor(jI.prototype,"maxReceived"),jI.prototype),X(jI.prototype,"bias",[pI,dI,mI],Object.getOwnPropertyDescriptor(jI.prototype,"bias"),jI.prototype),X(jI.prototype,"normalBias",[vI,gI,yI],Object.getOwnPropertyDescriptor(jI.prototype,"normalBias"),jI.prototype),X(jI.prototype,"shadowMapSize",[SI,xI,TI],Object.getOwnPropertyDescriptor(jI.prototype,"shadowMapSize"),jI.prototype),X(jI.prototype,"fixedArea",[EI,bI,CI],Object.getOwnPropertyDescriptor(jI.prototype,"fixedArea"),jI.prototype),X(jI.prototype,"near",[AI,wI,RI],Object.getOwnPropertyDescriptor(jI.prototype,"near"),jI.prototype),X(jI.prototype,"far",[II,PI,OI],Object.getOwnPropertyDescriptor(jI.prototype,"far"),jI.prototype),X(jI.prototype,"invisibleOcclusionRange",[bl,DI,Ml,MI,NI,LI],Object.getOwnPropertyDescriptor(jI.prototype,"invisibleOcclusionRange"),jI.prototype),X(jI.prototype,"shadowDistance",[bl,BI,Ml,FI,zI,UI],Object.getOwnPropertyDescriptor(jI.prototype,"shadowDistance"),jI.prototype),X(jI.prototype,"orthoSize",[kI,GI,HI],Object.getOwnPropertyDescriptor(jI.prototype,"orthoSize"),jI.prototype),VI=jI))||VI)||VI);i.ShadowsInfo=XP;var YP=new yi(-1024,-1024,-1024),KP=new yi(1024,1024,1024),QP=(uP=sl("cc.OctreeInfo"),hP=El(),fP=Rl(),_P=Rl(),pP=wl(),dP=Rl(),mP=wl(),vP=Il(),gP=Hl(Et),yP=Rl(),uP(SP=hP((AP=function(){function e(){q(this,"_enabled",TP,this),q(this,"_minPos",EP,this),q(this,"_maxPos",bP,this),q(this,"_depth",CP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},L(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),e}(),TP=X((xP=AP).prototype,"_enabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),EP=X(xP.prototype,"_minPos",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(YP)}}),bP=X(xP.prototype,"_maxPos",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(KP)}}),CP=X(xP.prototype,"_depth",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),X(xP.prototype,"enabled",[bl,fP],Object.getOwnPropertyDescriptor(xP.prototype,"enabled"),xP.prototype),X(xP.prototype,"minPos",[bl,_P,pP],Object.getOwnPropertyDescriptor(xP.prototype,"minPos"),xP.prototype),X(xP.prototype,"maxPos",[bl,dP,mP],Object.getOwnPropertyDescriptor(xP.prototype,"maxPos"),xP.prototype),X(xP.prototype,"depth",[bl,vP,gP,yP],Object.getOwnPropertyDescriptor(xP.prototype,"depth"),xP.prototype),SP=xP))||SP)||SP),ZP=(wP=sl("cc.SceneGlobals"),RP=Hl(WP),wP((BP=function(){function e(){q(this,"ambient",OP,this),q(this,"shadows",DP,this),q(this,"_skybox",MP,this),q(this,"fog",NP,this),q(this,"octree",LP,this)}return e.prototype.activate=function(){var e=i.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)},L(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),OP=X((PP=BP).prototype,"ambient",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jP}}),DP=X(PP.prototype,"shadows",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new XP}}),MP=X(PP.prototype,"_skybox",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new WP}}),NP=X(PP.prototype,"fog",[bl,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qP}}),X(PP.prototype,"skybox",[bl,RP],Object.getOwnPropertyDescriptor(PP.prototype,"skybox"),PP.prototype),LP=X(PP.prototype,"octree",[bl,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QP}}),IP=PP))||IP);i.SceneGlobals=ZP;var JP=e("Event",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());JP.NO_TYPE="no_type",JP.TOUCH="touch",JP.MOUSE="mouse",JP.KEYBOARD="keyboard",JP.ACCELERATION="acceleration",JP.NONE=0,JP.CAPTURING_PHASE=1,JP.AT_TARGET=2,JP.BUBBLING_PHASE=3,i.Event=JP;var $P=e("EventAcceleration",function(e){function t(t,n){var i;return(i=e.call(this,YA.DEVICEMOTION,n)||this).acc=void 0,i.acc=t,i}return F(t,e),t}(JP));JP.EventAcceleration=$P;var eO=e("EventKeyboard",function(e){function t(t,n,i){var r;return"boolean"==typeof n&&(n=n?YA.KEY_DOWN:YA.KEY_UP),(r=e.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==YA.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return F(t,e),L(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(JP));JP.EventKeyboard=eO;var tO=e("EventMouse",function(e){function t(n,i,r){var o;return(o=e.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=t.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}F(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new zi),zi.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new zi),zi.set(e,this._x,i.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new zi),zi.set(e,this._x,this._y),i.view._convertToUISpace(e),e},n.getPreviousLocation=function(e){return e||(e=new zi),zi.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new zi),zi.set(e,this._prevX,this._prevY),i.view._convertToUISpace(e),e},n.getDelta=function(e){return e||(e=new zi),zi.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new zi),zi.set(e,(this._x-this._prevX)/i.view.getScaleX(),(this._y-this._prevY)/i.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/i.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/i.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=i.view.getViewportRect();return(this._x-e.x)/i.view.getScaleX()},n.getUILocationY=function(){var e=i.view.getViewportRect();return(this._y-e.y)/i.view.getScaleY()},L(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(JP));tO.BUTTON_MISSING=-1,tO.BUTTON_LEFT=0,tO.BUTTON_RIGHT=2,tO.BUTTON_MIDDLE=1,tO.BUTTON_4=3,tO.BUTTON_5=4,tO.BUTTON_6=5,tO.BUTTON_7=6,tO.BUTTON_8=7,JP.EventMouse=tO;var nO=new zi,iO=e("EventTouch",function(e){function t(t,n,i,r){var o;return void 0===r&&(r=[]),(o=e.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=t||[],o._allTouches=r,o}F(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new zi},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new zi},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new zi},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new zi},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new zi},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new zi},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new zi},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new zi},n.getDeltaX=function(){return this.touch?this.touch.getDelta(nO).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(nO).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(JP));iO.MAX_TOUCHES=5,JP.EventTouch=iO;var rO,oO=e("Acceleration",(function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i}));!function(e){e[e.NONE=0]="NONE",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(rO||(rO=e("KeyCode",{})));var aO=new zi,sO=e("Touch",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new zi,this._prevPoint=new zi,this._lastModified=0,this._id=0,this._startPoint=new zi,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new zi),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new zi),e.set(this._point.x,this._point.y),i.view._convertToUISpace(e),e},t.getUILocationX=function(){var e=i.view.getViewportRect();return(this._point.x-e.x)/i.view.getScaleX()},t.getUILocationY=function(){var e=i.view.getViewportRect();return(this._point.y-e.y)/i.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new zi),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new zi),e.set(this._prevPoint.x,this._prevPoint.y),i.view._convertToUISpace(e),e},t.getStartLocation=function(e){return e||(e=new zi),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new zi),e.set(this._startPoint.x,this._startPoint.y),i.view._convertToUISpace(e),e},t.getDelta=function(e){return e||(e=new zi),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new zi),aO.set(this._point),aO.subtract(this._prevPoint),e.set(i.view.getScaleX(),i.view.getScaleY()),zi.divide(e,aO,e),e},t.getLocationInView=function(e){return e||(e=new zi),e.set(this._point.x,i.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new zi),e.set(this._prevPoint.x,i.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new zi),e.set(this._startPoint.x,i.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new zi(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new zi(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=i.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new zi(e.x,e.y):new zi(e||0,t||0),this._lastModified=i.game.frameStartTime},L(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());i.Touch=sO;var cO,lO=function(){function e(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new pn,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,dn.browserType===cn.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=e.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=e;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(fh.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),dn.os===hn.ANDROID&&dn.browserType!==cn.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new oO(n,i,r,l),h=new $P(u);this._eventTarget.emit(KA.DEVICEMOTION,h)}},t.start=function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileSeconds=e},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),uO={Backspace:rO.BACKSPACE,Tab:rO.TAB,Enter:rO.ENTER,ShiftLeft:rO.SHIFT_LEFT,ControlLeft:rO.CTRL_LEFT,AltLeft:rO.ALT_LEFT,ShiftRight:rO.SHIFT_RIGHT,ControlRight:rO.CTRL_RIGHT,AltRight:rO.ALT_RIGHT,Pause:rO.PAUSE,CapsLock:rO.CAPS_LOCK,Escape:rO.ESCAPE,Space:rO.SPACE,PageUp:rO.PAGE_UP,PageDown:rO.PAGE_DOWN,End:rO.END,Home:rO.HOME,ArrowLeft:rO.ARROW_LEFT,ArrowUp:rO.ARROW_UP,ArrowRight:rO.ARROW_RIGHT,ArrowDown:rO.ARROW_DOWN,Insert:rO.INSERT,Delete:rO.DELETE,Digit0:rO.DIGIT_0,Digit1:rO.DIGIT_1,Digit2:rO.DIGIT_2,Digit3:rO.DIGIT_3,Digit4:rO.DIGIT_4,Digit5:rO.DIGIT_5,Digit6:rO.DIGIT_6,Digit7:rO.DIGIT_7,Digit8:rO.DIGIT_8,Digit9:rO.DIGIT_9,KeyA:rO.KEY_A,KeyB:rO.KEY_B,KeyC:rO.KEY_C,KeyD:rO.KEY_D,KeyE:rO.KEY_E,KeyF:rO.KEY_F,KeyG:rO.KEY_G,KeyH:rO.KEY_H,KeyI:rO.KEY_I,KeyJ:rO.KEY_J,KeyK:rO.KEY_K,KeyL:rO.KEY_L,KeyM:rO.KEY_M,KeyN:rO.KEY_N,KeyO:rO.KEY_O,KeyP:rO.KEY_P,KeyQ:rO.KEY_Q,KeyR:rO.KEY_R,KeyS:rO.KEY_S,KeyT:rO.KEY_T,KeyU:rO.KEY_U,KeyV:rO.KEY_V,KeyW:rO.KEY_W,KeyX:rO.KEY_X,KeyY:rO.KEY_Y,KeyZ:rO.KEY_Z,Numpad0:rO.NUM_0,Numpad1:rO.NUM_1,Numpad2:rO.NUM_2,Numpad3:rO.NUM_3,Numpad4:rO.NUM_4,Numpad5:rO.NUM_5,Numpad6:rO.NUM_6,Numpad7:rO.NUM_7,Numpad8:rO.NUM_8,Numpad9:rO.NUM_9,NumpadMultiply:rO.NUM_MULTIPLY,NumpadAdd:rO.NUM_PLUS,NumpadSubtract:rO.NUM_SUBTRACT,NumpadDecimal:rO.NUM_DECIMAL,NumpadDivide:rO.NUM_DIVIDE,NumpadEnter:rO.NUM_ENTER,F1:rO.F1,F2:rO.F2,F3:rO.F3,F4:rO.F4,F5:rO.F5,F6:rO.F6,F7:rO.F7,F8:rO.F8,F9:rO.F9,F10:rO.F10,F11:rO.F11,F12:rO.F12,NumLock:rO.NUM_LOCK,ScrollLock:rO.SCROLL_LOCK,Semicolon:rO.SEMICOLON,Equal:rO.EQUAL,Comma:rO.COMMA,Minus:rO.DASH,Period:rO.PERIOD,Slash:rO.SLASH,Backquote:rO.BACK_QUOTE,BracketLeft:rO.BRACKET_LEFT,Backslash:rO.BACKSLASH,BracketRight:rO.BRACKET_RIGHT,Quote:rO.QUOTE},hO=function(){function e(){this._eventTarget=new pn,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var n=e._getInputEvent(t,KA.KEY_PRESSING);e._eventTarget.emit(KA.KEY_PRESSING,n)}else{var i=e._getInputEvent(t,KA.KEY_DOWN);e._eventTarget.emit(KA.KEY_DOWN,i)}})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,KA.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit(KA.KEY_UP,n)}))},t._getInputEvent=function(e,t){var n,i=(n=e.code,uO[n]||rO.NONE);return new eO(i,t)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),fO=function(){function e(){this._canvas=void 0,this._eventTarget=new pn,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new zi,dn.hasFeature(_n.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Xi(t.x,t.y,t.width,t.height):new Xi(0,0,0,0)},t._getLocation=function(e){var t=this._getCanvasRect(),n=fh.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/n-e.movementY:t.y+t.height-e.clientY;return new zi(i*=n,r*=n)},t._registerEvent=function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(KA.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(KA.MOUSE_MOVE));var o=this._createCallback(KA.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,r=t._getLocation(n),o=n.button;switch(e){case KA.MOUSE_DOWN:null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case KA.MOUSE_UP:t._isPressed=!1;break;case KA.MOUSE_MOVE:t._isPressed||(o=tO.BUTTON_MISSING)}var a=new tO(e,!1,t._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,t._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,a)}},t._handleMouseWheel=function(e){var t=KA.MOUSE_WHEEL,n=this._getLocation(e),i=e.button,r=new tO(t,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(n.x,n.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),_O=new zi,pO=new(function(){function e(){this._touchMap={},this._touches=void 0,this._maxTouches=8,this._touches=new Array(this._maxTouches)}var t=e.prototype;return t._cloneTouch=function(e){var t=e.getID();e.getStartLocation(_O);var n=new sO(_O.x,_O.y,t);return e.getLocation(_O),n.setPoint(_O.x,_O.y),e.getPreviousLocation(_O),n.setPrevPoint(_O),n},t._createTouch=function(e,t,n){if(e in this._touchMap)console.log("Cannot create the same touch object.");else{var i=this._getAvailableTouchIndex(e);if(-1!==i){var r=new sO(t,n,e);return this._touches[i]=r,this._touchMap[e]=i,this._updateTouch(r,t,n),this._cloneTouch(r)}console.log("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){if(e in this._touchMap){var t=this._touchMap[e];this._touches[t]=void 0,delete this._touchMap[e]}},t.getTouch=function(e,t,n){var i=this._touchMap[e],r=this._touches[i];return r?this._updateTouch(r,t,n):r=this._createTouch(e,t,n),r?this._cloneTouch(r):void 0},t.getAllTouches=function(){var e=this,t=[];return this._touches.forEach((function(n){if(n){var i=e._cloneTouch(n);t.push(i)}})),t},t._updateTouch=function(e,t,n){e.getLocation(_O),e.setPrevPoint(_O),e.setPoint(t,n)},t._getAvailableTouchIndex=function(e){var t=this._touchMap[e];if(void 0!==t)return t;for(var n=0;n<this._maxTouches;n++)if(!this._touches[n])return n;for(var i=performance.now(),r=tt.TOUCH_TIMEOUT,o=0;o<this._maxTouches;o++){var a=this._touches[o];if(i-a.lastModified>r)return console.log("The touches is more than MAX_TOUCHES, release touch id "+a.getID()+"."),this.releaseTouch(a.getID()),o}return-1},e}()),dO=function(){function e(){this._canvas=void 0,this._eventTarget=new pn,dn.hasFeature(_n.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(KA.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(KA.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(KA.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(KA.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var i,r=t._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=t._getLocation(c,r),h=pO.getTouch(l,u.x,u.y);if(h&&(e!==KA.TOUCH_END&&e!==KA.TOUCH_CANCEL||pO.releaseTouch(l),o.push(h),!tt.ENABLE_MULTI_TOUCH))break}}if(n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),e===KA.TOUCH_START&&(null===(i=t._canvas)||void 0===i||i.focus()),o.length>0){var f=new iO(o,!1,e,tt.ENABLE_MULTI_TOUCH?pO.getAllTouches():o);t._eventTarget.emit(e,f)}}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new Xi(t.x,t.y,t.width,t.height):new Xi(0,0,0,0)},t._getLocation=function(e,t){var n=e.clientX-t.x,i=t.y+t.height-e.clientY;if(fh.isFrameRotated){var r=n;n=t.height-i,i=r}var o=fh.devicePixelRatio;return new zi(n*=o,i*=o)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),mO=((cO={})[KA.MOUSE_DOWN]=KA.TOUCH_START,cO[KA.MOUSE_MOVE]=KA.TOUCH_MOVE,cO[KA.MOUSE_UP]=KA.TOUCH_END,cO),vO=e("Input",function(){function e(){this._dispatchImmediately=!0,this._eventTarget=new pn,this._touchInput=new dO,this._mouseInput=new fO,this._keyboardInput=new hO,this._accelerometerInput=new lO,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._registerEvent()}var t=e.prototype;return t._simulateEventTouch=function(e){var t=mO[e.type],n=pO.getTouch(0,e.getLocationX(),e.getLocationY());if(n){var i=[n],r=new iO(i,!1,t,i);t===KA.TOUCH_END&&pO.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},t._registerEvent=function(){var e=this;if(dh.hasFeature(dh.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(KA.TOUCH_START,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(KA.TOUCH_MOVE,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(KA.TOUCH_END,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(KA.TOUCH_CANCEL,(function(n){e._dispatchOrPushEventTouch(n,t)}))}if(dh.hasFeature(dh.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(KA.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(KA.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(KA.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(KA.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,n)}))}if(dh.hasFeature(dh.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(KA.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(KA.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(KA.KEY_UP,(function(t){e._dispatchOrPushEvent(t,i)}))}if(dh.hasFeature(dh.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(KA.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._eventTarget.emit(e.type,e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var n=e.getTouches(),i=n.length,r=0;r<i;++r)e.touch=n[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._eventTarget.emit(e.type,e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventMouseList,t=0,n=e.length;t<n;++t){var i=e[t];this._eventTarget.emit(i.type,i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._eventTarget.emit(s.type,s);for(var h=this._eventKeyboardList,f=0,_=h.length;f<_;++f){var p=h[f];this._eventTarget.emit(p.type,p)}for(var d=this._eventAccelerationList,m=0,v=d.length;m<v;++m){var g=d[m];this._eventTarget.emit(g.type,g)}this._clearEvents()},t.on=function(e,t,n){return this._eventTarget.on(e,t,n),t},t.once=function(e,t,n){return this._eventTarget.once(e,t,n),t},t.off=function(e,t,n){this._eventTarget.off(e,t,n)},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},e}());vO.EventType=KA;var gO,yO=e("input",new vO),SO=e("pointerEvent2SystemEvent",((gO={})[KA.TOUCH_START]="system-event-"+KA.TOUCH_START,gO[KA.TOUCH_MOVE]="system-event-"+KA.TOUCH_MOVE,gO[KA.TOUCH_END]="system-event-"+KA.TOUCH_END,gO[KA.TOUCH_CANCEL]="system-event-"+KA.TOUCH_CANCEL,gO[KA.MOUSE_DOWN]="system-event-"+KA.MOUSE_DOWN,gO[KA.MOUSE_MOVE]="system-event-"+KA.MOUSE_MOVE,gO[KA.MOUSE_UP]="system-event-"+KA.MOUSE_UP,gO)),xO=Object.values(KA),TO=e("SystemEvent",function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){yO.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){yO.setAccelerometerInterval(e)},n.on=function(t,n,i,r){var o=r?yO.once:yO.on;if(xO.includes(t)){var a=SO[t];a?o.call(yO,a,n,i):t===YA.KEY_DOWN?(o.call(yO,KA.KEY_DOWN,n,i),o.call(yO,KA.KEY_PRESSING,n,i,r)):o.call(yO,t,n,i)}else e.prototype.on.call(this,t,n,i,r);return n},n.off=function(t,n,i){if(xO.includes(t)){var r=SO[t];r?yO.off(r,n,i):t===YA.KEY_DOWN?(yO.off(KA.KEY_DOWN,n,i),yO.off(KA.KEY_PRESSING,n,i)):yO.off(t,n,i)}else e.prototype.off.call(this,t,n,i)},t}(pn));TO.EventType=YA,i.SystemEvent=TO;var EO,bO=e("systemEvent",new TO);i.systemEvent=bO,zn(YA,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),zn(JP,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:TO.EventType,targetName:"SystemEvent.EventType"}]),kn(JP,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),zn(tO,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:TO.EventType,targetName:"SystemEvent.EventType"}}))),zn(tO,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:TO.EventType,targetName:"SystemEvent.EventType"}]),kn(tO.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),zn(iO,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:TO.EventType,targetName:"SystemEvent.EventType"}]),zn(iO,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:TO.EventType,targetName:"SystemEvent.EventType"}]),zn(iO,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:TO.EventType,targetName:"SystemEvent.EventType"}]),zn(iO,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:TO.EventType,targetName:"SystemEvent.EventType"}]),kn(iO.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),zn(iO.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:iO,targetName:"EventTouch"}]),kn(tt.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),kn(tt.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),kn(tt.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),kn(tt.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),kn(tt,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),zn(Cb.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),zn(eA.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new zi),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Wi),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),Un(ZP.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),Un(eA.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),Un(Gp,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),zn(Gp,"Layers",[{name:"Default",newName:"DEFAULT",target:Gp.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Gp.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Gp.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Gp.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Gp.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Gp.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Gp.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Gp.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Gp,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Gp,targetName:"Layers"}]),Un(Gp.Enum,"Layers.Enum",[{name:"ALWAYS"}]),Un(Gp.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var CO,AO,wO,RO,IO=Qt.Flags.HideInHierarchy,PO=Qt.Flags.DontSave,OO=e("PrivateNode",sl("cc.PrivateNode")(EO=function(e){function t(t){var n;return b(12003,(n=e.call(this,t)||this).name),n.hideFlags|=PO|IO,n}return F(t,e),t}(eA))||EO);zn(YA,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:eA.EventType,targetName:"Node.EventType"}}))),zn(eA.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:TO.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:TO.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:TO.EventType,targetName:"SystemEvent.EventType"}]),i.PrivateNode=OO;var DO=e("Scene",sl("cc.Scene")((X((AO=function(e){F(n,e);var t=n.prototype;function n(t){var n;return q(n=e.call(this,t)||this,"autoReleaseAssets",wO,V(n)),q(n,"_globals",RO,V(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=yi.ZERO,n._rot=Ai.IDENTITY,n._scale=yi.ONE,n._mat=Ni.IDENTITY,n._dirtyFlags=0,n._lpos=yi.ZERO,n._lrot=Ai.IDENTITY,n._lscale=yi.ONE,n._activeInHierarchy=!1,i.director&&i.director.root&&(n._renderScene=i.director.root.createScene({})),n._inited=!i.game||!i.game._isCloning,n._init(),n}return t._updateScene=function(){this._scene=this},t._init=function(){},t.destroy=function(){var e=Qt.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&i.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(P(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},t.getPosition=function(e){return yi.copy(e||new yi,yi.ZERO)},t.getRotation=function(e){return Ai.copy(e||new Ai,Ai.IDENTITY)},t.getScale=function(e){return yi.copy(e||new yi,yi.ONE)},t.getWorldPosition=function(e){return yi.copy(e||new yi,yi.ZERO)},t.getWorldRotation=function(e){return Ai.copy(e||new Ai,Ai.IDENTITY)},t.getWorldScale=function(e){return yi.copy(e||new yi,yi.ONE)},t.getWorldMatrix=function(e){return Ni.copy(e||new Ni,Ni.IDENTITY)},t.getWorldRS=function(e){return Ni.copy(e||new Ni,Ni.IDENTITY)},t.getWorldRT=function(e){return Ni.copy(e||new Ni,Ni.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(gA(this),mA(this),this._onBatchCreated(false),this._inited=!0),this.walk(Cb._setScene)},t._activate=function(e){e=!1!==e,i.director._nodeActivator.activateNode(this,e),this._globals.activate(),this._renderScene&&this._renderScene.activate()},L(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return yi.ZERO}},{key:"worldPosition",get:function(){return yi.ZERO}},{key:"rotation",get:function(){return Ai.IDENTITY}},{key:"worldRotation",get:function(){return Ai.IDENTITY}},{key:"scale",get:function(){return yi.ONE}},{key:"worldScale",get:function(){return yi.ONE}},{key:"eulerAngles",get:function(){return yi.ZERO}},{key:"worldMatrix",get:function(){return Ni.IDENTITY}}]),n}(Cb)).prototype,"globals",[bl],Object.getOwnPropertyDescriptor(AO.prototype,"globals"),AO.prototype),wO=X(AO.prototype,"autoReleaseAssets",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RO=X(AO.prototype,"_globals",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ZP}}),CO=AO))||CO);function MO(e,t){if(!t){var n=i.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}i.Scene=DO,i.find=MO;var NO=Ge.fastRemoveAt,LO=Qt.Flags.IsStartCalled,BO=Qt.Flags.IsOnEnableCalled;function FO(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function zO(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}Qt.Flags.IsEditorOnEnableCalled;var UO=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=Y;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function kO(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}UO.stableRemoveInactive=zO;var GO=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){zO(this._zero,e),zO(this._neg,e),zO(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(kO),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(kO),this._invoke(t),t.array.length=0)},t}(UO),HO=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=FO(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=FO(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(UO);function VO(e,t,n){var r="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",o=t?Function("it","dt",r):Function("it",r);return function(e,t,n){return function(r,o){try{t(r,o)}catch(t){i._throw(t);var a=r.array;for(n&&(a[r.i]._objFlags|=n),++r.i;r.i<a.length;++r.i)try{e(a[r.i],o)}catch(e){i._throw(e),n&&(a[r.i]._objFlags|=n)}}}}(Function("c","dt",e),o,n)}var jO=VO("c.start();c._objFlags|="+LO,!1,LO),WO=VO("c.update(dt)",!0),qO=VO("c.lateUpdate(dt)",!0),XO=function(e){var t=i.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var r=n[e.i];r._enabled&&(r.onEnable(),!r.node._activeInHierarchy||t._onEnabled(r))}},YO=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new GO(jO),this.updateInvoker=new HO(WO),this.lateUpdateInvoker=new HO(qO),this._updating=!1},t._onEnabled=function(e){i.director.getScheduler().resumeTarget(e),e._objFlags|=BO,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){i.director.getScheduler().pauseTarget(e),e._objFlags&=~BO;var t=this._deferredComps.indexOf(e);t>=0?NO(this._deferredComps,t):(!e.start||e._objFlags&LO||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&BO)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&BO&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&LO||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),KO=Qt.Flags.IsPreloadStarted,QO=Qt.Flags.IsOnLoadStarted,ZO=Qt.Flags.IsOnLoadCalled,JO=Qt.Flags.Deactivating,$O=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){UO.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(UO),eD=VO("c.__preload();"),tD=VO("c.onLoad();c._objFlags|="+ZO,!1,ZO),nD=new ke(4);function iD(e,t,n){A(3817,e.name,n),console.log("Corrupted component value:",t),t?e._removeComponent(t):Ge.removeAt(e._components,n)}nD.get=function(){var e=this._get()||{preload:new $O(eD),onLoad:new GO(tD),onEnable:new GO(XO)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var rD,oD,aD,sD,cD,lD,uD,hD,fD=e("NodeActivator",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=nD.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),nD.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=W(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(KO),o.onLoad.cancelInactive(QO),o.onEnable.cancelInactive()}}e.emit(JE.ACTIVE_IN_HIERARCHY_CHANGED,e)},t.activateComp=function(e,t,n,r){if(Jt(e,!0)&&(e._objFlags&KO||(e._objFlags|=KO,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&QO||(e._objFlags|=QO,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=ZO):e._objFlags|=ZO),e._enabled)){if(!e.node._activeInHierarchy)return;i.director._compScheduler.enableComp(e,r)}},t.destroyComp=function(e){i.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&ZO&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,r){if(e._objFlags&JO)A(3816,e.name);else{e._activeInHierarchy=!0;for(var o=e._components.length,a=0;a<o;++a){var s=e._components[a];s instanceof i.Component?this.activateComp(s,t,n,r):(iD(e,s,a),--a,--o)}for(var c=0,l=e._children.length;c<l;++c){var u=e._children[c];u._active&&this._activateNodeRecursively(u,t,n,r)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=JO,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var r=e._components[n];if(r._enabled&&(i.director._compScheduler.disableComp(r),e._activeInHierarchy))return void(e._objFlags&=~JO)}for(var o=0,a=e._children.length;o<a;++o){var s=e._children[o];if(s._activeInHierarchy&&(this._deactivateNodeRecursively(s),e._activeInHierarchy))return void(e._objFlags&=~JO)}e._onPostActivated(!1),e._objFlags&=~JO},e}()),_D=e("SceneAsset",sl("cc.SceneAsset")((sD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"scene",aD,V(t)),t}F(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new DO("New Scene")},n.validate=function(){return!!this.scene},t}(zu),aD=X((oD=sD).prototype,"scene",[bl,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rD=oD))||rD);i.SceneAsset=_D;var pD,dD,mD,vD,gD=e("TextAsset",sl("cc.TextAsset")((hD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"text",uD,V(t)),t}return F(t,e),t.prototype.toString=function(){return this.text},t}(zu),uD=X((lD=hD).prototype,"text",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cD=lD))||cD);i.TextAsset=gD;var yD=e("JsonAsset",sl("cc.JsonAsset")((vD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"json",mD,V(t)),t}return F(t,e),t}(zu),mD=X((dD=vD).prototype,"json",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pD=dD))||pD);i.JsonAsset=yD;var SD,xD,TD,ED,bD,CD,AD,wD,RD,ID,PD,OD,DD,MD,ND,LD,BD,FD,zD,UD,kD,GD,HD,VD,jD,WD,qD,XD,YD,KD,QD,ZD,JD,$D,eM,tM,nM,iM,rM=function(){var e=t.prototype;function t(){this.fog=new LE,this.ambient=new Ji,this.skybox=new $g,this.shadows=new Ug,this.octree=new $i,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,this.initOcclusionQuery(),!0},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new Ng;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){var e,t,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=e.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=e.createBuffer(new wo(Rr.INDEX|Rr.TRANSFER_DST,Or.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new jo("a_position",Cr.RGB32F)],c=new qo(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(c)},L(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(wS.ATTACHMENT_SCALE_CAHNGED,e))}}]),t}(),oM=e("ForwardPipeline",(SD=sl("ForwardPipeline"),xD=Hl([wT]),TD=Nl(),SD((AD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",CD,V(t)),t._postRenderPass=null,t}F(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new OE;n.initialize(OE.initInfo),this._flows.push(n);var i=new _E;i.initialize(_E.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new rM,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(A(2402),1))},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(ad,t),this._descriptorSet.bindTexture(ad,Vv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(dd,t),this._descriptorSet.bindTexture(dd,Vv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(id.BINDING).destroy(),this._descriptorSet.getBuffer(od.BINDING).destroy(),this._descriptorSet.getBuffer(rd.BINDING).destroy(),this._descriptorSet.getTexture(ad).destroy(),this._descriptorSet.getTexture(dd).destroy())},L(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(KS),CD=X((bD=AD).prototype,"renderTextures",[xD,_l,TD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ED=bD))||ED)),aM=[new Eo(0,0,0,0),new Eo(0,0,0,0),new Eo(0,0,0,0),new Eo(0,0,0,0)],sM=e("GbufferStage",(wD=sl("GbufferStage"),RD=Hl([PT]),ID=Nl(),wD((ND=MD=function(e){function t(){var t;return q(t=e.call(this)||this,"renderQueues",DD,V(t)),t._renderQueues=[],t._renderArea=new po,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=jv("default"),t._batchedQueue=new FT,t._instancedQueue=new zT,t}F(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=NT(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(LT),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var f=h[o];if(f.phase===this._phaseID){var _=f.batchingScheme;if(_===kv.INSTANCING){var p=f.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(_===kv.VB_MERGING){var d=f.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(BT);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),e.clearFlag&ao.COLOR&&(t.pipelineSceneData.isHDR?Sg(aM[0],e.clearColor):(aM[0].x=e.clearColor.x,aM[0].y=e.clearColor.y,aM[0].z=e.clearColor.z)),aM[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,aM,e.clearDepth,e.clearStencil),m.setScissor(t.generateScissor(e)),m.setViewport(t.generateViewport(e)),m.bindDescriptorSet($p.GLOBAL,t.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},t}(AS),MD.initInfo={name:"GbufferStage",priority:GS.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:AT.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:AT.BACK_TO_FRONT,stages:["default"]}]},DD=X((OD=ND).prototype,"renderQueues",[RD,_l,ID],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PD=OD))||PD)),cM=[new Eo(0,0,0,1)],lM=e("LightingStage",(LD=sl("LightingStage"),BD=Hl(Ng),FD=Nl(),zD=Hl([PT]),UD=Nl(),LD((WD=jD=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=Ed.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new po,t._uiPhase=void 0,q(t,"_deferredMaterial",HD,V(t)),q(t,"renderQueues",VD,V(t)),t._phaseID=jv("default"),t._renderQueues=[],t._uiPhase=new uE,t}F(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,o=so.create(0,0,0,1),a=new Float32Array(4),s=e.exposure,c=0,l=Hi.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var f=i[h];if(so.set(o,f.position.x,f.position.y,f.position.z,f.range),rc.sphereFrustum(o,e.frustum)){if(yi.toArray(a,f.position),a[3]=0,this._lightBufferData.set(a,c*l),yi.toArray(a,f.color),f.useColorTemperature){var _=f.colorTemperatureRGB;a[0]*=_.x,a[1]*=_.y,a[2]*=_.z}t.pipelineSceneData.isHDR?a[3]=f.luminance*s*this._lightMeterScale:a[3]=f.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=f.size,a[1]=f.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var p=0;p<r.length&&c<this._maxDeferredLights;p++,++c){var d=r[p];if(so.set(o,d.position.x,d.position.y,d.position.z,d.range),rc.sphereFrustum(o,e.frustum)){if(yi.toArray(a,d.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),yi.toArray(a,d.color),d.useColorTemperature){var m=d.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}t.pipelineSceneData.isHDR?a[3]=d.luminance*s*this._lightMeterScale:a[3]=d.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=d.size,a[1]=d.range,a[2]=d.spotAngle,this._lightBufferData.set(a,c*l+2*u),yi.toArray(a,d.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t);for(var i=t.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=NT(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,o,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new Ro(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new na(Kp.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new ia(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(Td.BINDING,a),this._planarQueue=new lE(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,o=r.renderObjects;this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,i),i.bindDescriptorSet($p.LOCAL,this._descriptorSet,[0]),t.generateRenderArea(e,this._renderArea),e.clearFlag&ao.COLOR&&(cM[0].x=e.clearColor.x,cM[0].y=e.clearColor.y,cM[0].z=e.clearColor.z),cM[0].w=0;var a=t.getPipelineRenderData(),s=a.outputFrameBuffer,c=s.renderPass;t.pipelineUBO.updateShadowUBO(e),i.beginRenderPass(c,s,this._renderArea,cM,e.clearDepth,e.clearStencil),i.setScissor(t.generateScissor(e)),i.setViewport(t.generateViewport(e)),i.bindDescriptorSet($p.GLOBAL,t.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<4;++h)l.descriptorSet.bindTexture(h,a.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,a.sampler);l.descriptorSet.update(),i.bindDescriptorSet($p.MATERIAL,l.descriptorSet);var f=t.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=f&&(_=vg.getOrCreatePipelineState(n,l,u,c,f)),null!=_&&(i.bindPipelineState(_),i.bindInputAssembler(f),i.draw(f)),this._renderQueues.forEach(LT);for(var p=0,d=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(p=0;p<y.length;++p){var S=y[p].passes;for(d=0;d<S.length;++d)if(S[d].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,p,d)}}if(o.length>0){this._renderQueues.forEach(BT);for(var x=0;x<this._renderQueues.length;x++)this._renderQueues[x].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(e,c),i.endRenderPass()},t}(AS),jD.initInfo={name:"LightingStage",priority:GS.LIGHTING,tag:0},HD=X((GD=WD).prototype,"_deferredMaterial",[BD,_l,FD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VD=X(GD.prototype,"renderQueues",[zD,_l,UD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kD=GD))||kD)),uM=[new Eo(0,0,0,1)],hM=e("PostProcessStage",(qD=sl("PostProcessStage"),XD=Hl(Ng),YD=Nl(),KD=Hl([PT]),QD=Nl(),qD((nM=tM=function(e){function t(){var t;return q(t=e.call(this)||this,"_postProcessMaterial",$D,V(t)),q(t,"renderQueues",eM,V(t)),t._renderArea=new po,t._uiPhase=new uE,t}F(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var o=e.viewport;this._renderArea.x=o.x*e.window.width,this._renderArea.y=o.y*e.window.height,this._renderArea.width=o.width*e.window.width,this._renderArea.height=o.height*e.window.height;var a=t.getPipelineRenderData(),s=e.window.framebuffer,c=e.window.swapchain,l=c?t.getRenderPass(e.clearFlag,c):s.renderPass;e.clearFlag&ao.COLOR&&(uM[0].x=e.clearColor.x,uM[0].y=e.clearColor.y,uM[0].z=e.clearColor.z),uM[0].w=e.clearColor.w,r.beginRenderPass(l,s,this._renderArea,uM,e.clearDepth,e.clearStencil),r.bindDescriptorSet($p.GLOBAL,t.descriptorSet);var u=i.postprocessMaterial.passes[0],h=u.getShaderVariant();t.bloomEnabled?u.descriptorSet.bindTexture(0,a.bloom.combineTex):u.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),u.descriptorSet.bindSampler(0,a.sampler),u.descriptorSet.update(),r.bindDescriptorSet($p.MATERIAL,u.descriptorSet);var f=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=u&&null!=h&&null!=f&&(_=vg.getOrCreatePipelineState(n,u,h,l,f));var p=t.pipelineSceneData.renderObjects;null!=_&&p.length>0&&(r.bindPipelineState(_),r.bindInputAssembler(f),r.draw(f)),this._uiPhase.render(e,l),Dg(n,l,r,t.profiler,e),r.endRenderPass()},t}(AS),tM.initInfo={name:"PostProcessStage",priority:zS.POST_PROCESS,tag:0},$D=X((JD=nM).prototype,"_postProcessMaterial",[XD,_l,YD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eM=X(JD.prototype,"renderQueues",[KD,_l,QD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZD=JD))||ZD));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(iM||(iM={}));var fM,_M,pM,dM,mM,vM,gM,yM,SM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._antiAliasing=iM.NONE,t}F(t,e);var n=t.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),t.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var e=new Ng;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new Ng;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new Ng;r._uuid="builtin-post-process-material",tt.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=iM.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(t,n){return e.prototype.activate.call(this,t,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},L(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var n=new Ng;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(rM),xM=[new Eo(0,0,0,1)],TM=function(){};TM.SIZE=4*(TM.COUNT=4+(TM.TEXTURE_SIZE_OFFSET=0));var EM,bM,CM,AM,wM,RM,IM,PM,OM,DM,MM=e("BloomStage",(fM=sl("BloomStage"),_M=Hl(Ng),pM=Nl(),fM((yM=gM=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,q(t,"_bloomMaterial",vM,V(t)),t._renderArea=new po,t._bloomUBO=[],t}F(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(e){var t,n=this._pipeline;if(n.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,TM.SIZE,TM.SIZE));e.clearFlag&ao.COLOR&&(xM[0].x=e.clearColor.x,xM[0].y=e.clearColor.y,xM[0].z=e.clearColor.z),xM[0].w=e.clearColor.w,this._prefilterPass(e,n),this._downsamplePass(e,n),this._upsamplePass(e,n),this._combinePass(e,n)}},n._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(TM.COUNT);a[TM.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,xM,0,0),n.bindDescriptorSet($p.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet($p.MATERIAL,i.descriptorSet);var s=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=vg.getOrCreatePipelineState(t.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,o=new Float32Array(TM.COUNT),a=0;a<this.iterations;++a){o[TM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[TM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,xM,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet($p.MATERIAL,s.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=vg.getOrCreatePipelineState(t.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(e,t){var n=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,o=new Float32Array(TM.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[TM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[TM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,xM,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet($p.MATERIAL,c.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=vg.getOrCreatePipelineState(t.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(TM.COUNT);a[TM.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,xM,0,0),n.bindDescriptorSet($p.GLOBAL,t.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet($p.MATERIAL,s.descriptorSet);var c=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=vg.getOrCreatePipelineState(t.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},t}(AS),gM.initInfo={name:"BloomStage",priority:zS.BLOOM,tag:0},vM=X((mM=yM).prototype,"_bloomMaterial",[_M,_l,pM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dM=mM))||dM)),NM=e("MainFlow",sl("MainFlow")((CM=bM=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new sM;n.initialize(sM.initInfo),this._stages.push(n);var i=new lM;i.initialize(lM.initInfo),this._stages.push(i);var r=new MM;r.initialize(MM.initInfo),this._stages.push(r);var o=new hM;o.initialize(hM.initInfo),this._stages.push(o)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(RS),bM.initInfo={name:jp,priority:HS.MAIN,stages:[]},EM=CM))||EM),LM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return F(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),BM=e("DeferredPipeline",(AM=sl("DeferredPipeline"),wM=Hl([wT]),RM=Nl(),AM((DM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,q(t,"renderTextures",OM,V(t)),t}F(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new OE;n.initialize(OE.initInfo),this._flows.push(n);var i=new NM;i.initialize(NM.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new SM,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(A(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(ad,n),this._descriptorSet.bindTexture(ad,Vv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(dd,n),this._descriptorSet.bindTexture(dd,Vv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new YS;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new Xo;o.format=Cr.RGBA16F,o.loadOp=Wr.CLEAR,o.storeOp=qr.STORE;var a=new Xo;a.format=Cr.RGBA16F,a.loadOp=Wr.CLEAR,a.storeOp=qr.STORE;var s=new Xo;s.format=Cr.RGBA16F,s.loadOp=Wr.CLEAR,s.storeOp=qr.STORE;var c=new Xo;c.format=Cr.RGBA16F,c.loadOp=Wr.CLEAR,c.storeOp=qr.STORE;var l=new Yo;l.format=Cr.DEPTH_STENCIL,l.depthLoadOp=Wr.CLEAR,l.depthStoreOp=qr.STORE,l.stencilLoadOp=Wr.CLEAR,l.stencilStoreOp=qr.STORE;var u=new Zo([o,a,s,c],l);this._gbufferRenderPass=t.createRenderPass(u)}if(!this._lightingRenderPass){var h=new Xo;h.format=Cr.RGBA8,h.loadOp=Wr.CLEAR,h.storeOp=qr.STORE,h.endAccesses=[Xr.COLOR_ATTACHMENT_WRITE];var f=new Yo;f.format=Cr.DEPTH_STENCIL,f.depthLoadOp=Wr.LOAD,f.depthStoreOp=qr.DISCARD,f.stencilLoadOp=Wr.LOAD,f.stencilStoreOp=qr.DISCARD,f.beginAccesses=[Xr.DEPTH_STENCIL_ATTACHMENT_WRITE],f.endAccesses=[Xr.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new Zo([h],f);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(id.BINDING).destroy(),this._descriptorSet.getBuffer(od.BINDING).destroy(),this._descriptorSet.getBuffer(rd.BINDING).destroy(),this._descriptorSet.getTexture(ad).destroy(),this._descriptorSet.getTexture(dd).destroy())},n._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.outputRenderTargets.length;n++)e.outputRenderTargets[n].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var e=this,t=this.device,n=this._pipelineRenderData=new LM,i=this.pipelineSceneData,r=0;r<4;++r)n.gbufferRenderTargets.push(t.createTexture(new Do(Dr.TEX2D,Mr.COLOR_ATTACHMENT|Mr.SAMPLED,Cr.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=t.createTexture(new Do(Dr.TEX2D,Mr.DEPTH_STENCIL_ATTACHMENT,Cr.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=t.createFramebuffer(new ea(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(t.createTexture(new Do(Dr.TEX2D,Mr.COLOR_ATTACHMENT|Mr.SAMPLED,Cr.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=t.createFramebuffer(new ea(this._lightingRenderPass,n.outputRenderTargets,n.outputDepth)),this.on(wS.ATTACHMENT_SCALE_CAHNGED,(function(t){n.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(n.gbufferFrameBuffer),e.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler},t}(KS),OM=X((PM=DM).prototype,"renderTextures",[wM,_l,RM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IM=PM))||IM));function FM(){var e=new oM;return e.initialize({flows:[]}),e}var zM=new zi,UM=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.pauseRendering=function(){this.isPause=!0},e.resumeRendering=function(){this.isPause=!1},e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new Eo(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new Eo(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{i.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?i.view.setDesignResolutionSize(n.width,n.height,n.policy):i.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,i.game.once(i.Game.EVENT_GAME_INITED,(function(){i.director._lateUpdate=performance.now()}),i.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else d("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),i.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new Eo(e.x,e.y,e.z,e.w)];var t=this.device,n=this.swapchain;this.renderArea=new po(0,0,n.width,n.height),this.cmdBuff=t.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=t.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=t.createBuffer(new wo(Rr.INDEX|Rr.TRANSFER_DST,Or.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new jo("a_position",Cr.RG32F),new jo("a_texCoord",Cr.RG32F)],u=new qo(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(u),this.projection=new Ni,Ni.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,n.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),i.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device,o=e.swapchain;Ni.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;e.startTime<0&&(e.startTime=n);var l=n-e.startTime,u=Sf($n(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=e.logoTexture.width,f=e.logoTexture.height,_=c*i.displayRatio,p=_*h/f,d=_;if(o.surfaceTransform!==Er.ROTATE_90&&o.surfaceTransform!==Er.ROTATE_270||(p=_*a/s,d=_*f/h*s/a),e.logoMat.setProperty("resolution",zM.set(a,s),0),e.logoMat.setProperty("scale",zM.set(p,d),0),e.logoMat.setProperty("translate",zM.set(.5*a,.5*s),0),e.logoMat.setProperty("percent",u),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var m=.5*c,v=e.watermarkTexture.width,g=m,y=m*e.watermarkTexture.height/v;o.surfaceTransform!==Er.ROTATE_90&&o.surfaceTransform!==Er.ROTATE_270||(g=.5*m,y=m*a/s*.5),e.watermarkMat.setProperty("resolution",zM.set(a,s),0),e.watermarkMat.setProperty("scale",zM.set(g,y),0),e.watermarkMat.setProperty("translate",zM.set(.5*a,.1*s),0),e.watermarkMat.setProperty("percent",u),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.isPause||(e.frame(),l>i.totalTime&&(e.splashFinish=!0)),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new Ng,this.logoMat.initialize({effectName:"splash-screen"});var t=new No;t.addressU=zr.CLAMP,t.addressV=zr.CLAMP,t.addressW=zr.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new Do(Dr.TEX2D,Mr.SAMPLED|Mr.TRANSFER_DST,Cr.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new xo;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new xo;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Do(Dr.TEX2D,Mr.SAMPLED|Mr.TRANSFER_DST,Cr.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new Ng,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},e.frame=function(){var e=this.device,t=this.swapchain;e.acquire([t]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=t.width,r.height=t.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=vg.getOrCreatePipelineState(e,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet($p.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=vg.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet($p.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),e.flushCommands([n]),e.queue.submit([n]),e.present()},e.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},L(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();UM._ins=void 0,i.internal.SplashScreen=UM;var kM=e("System",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},L(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}());kM.Priority=Qe({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var GM=new te("Scheduler"),HM=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};HM.get=function(e,t,n,i){var r=HM._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new HM(e,t,n,i),r},HM.put=function(e){HM._listEntries.length<20&&(e.target=null,HM._listEntries.push(e))},HM._listEntries=[];var VM=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};VM.get=function(e,t,n,i){var r=VM._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new VM(e,t,n,i),r},VM.put=function(e){VM._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,VM._hashUpdateEntries.push(e))},VM._hashUpdateEntries=[];var jM=function(e,t,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};jM.get=function(e,t,n,i,r,o){var a=jM._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new jM(e,t,n,i,r,o),a},jM.put=function(e){jM._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,jM._hashTimerEntries.push(e))},jM._hashTimerEntries=[];var WM=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,r,o,a){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=r,this._delay=a,this._useDelay=this._delay>0,this._repeat=o,this._runForever=this._repeat===i.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();WM._timers=[],WM.get=function(){return WM._timers.pop()||new WM},WM.put=function(e){WM._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,WM._timers.push(e))};var qM,XM=e("Scheduler",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=_e(!0),t._hashForTimers=_e(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}F(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?b(1513):e.id=GM.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(o=a[t],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(e),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,r,o,a){if("function"!=typeof e){var s=e;e=t,t=s}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!r,r=i.macro.REPEAT_FOREVER,o=0),I(t,1502);var c=t.uuid||t.id;if(c){var l,u,h=this._hashForTimers[c];if(h?h.paused!==a&&b(1511):(h=jM.get(null,t,0,null,null,a),this._arrayForTimers.push(h),this._hashForTimers[c]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((l=h.timers[u])&&e===l._callback)return T(1507,l.getInterval(),n),void(l._interval=n);(l=WM.get()).initWithCallback(this,e,t,n,r,o),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else A(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return T(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var o,a=HM.get(e,t,n,!1);0===t?(o=this._updates0List,this._appendIn(o,a)):(o=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,t)),this._hashForUpdates[i]=VM.get(o,a,e,null)}else A(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),WM.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else A(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else A(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)WM.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else A(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(kM.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var o=0;if(e<0)for(t=0;t<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){I(e,1508),I(t,1509);var n=t.uuid||t.id;if(!n)return A(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(e===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(kM.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(t=a[n])&&(t.paused=!0,o.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){I(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else A(1510)},n.resumeTarget=function(e){I(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else A(1510)},n.isTargetPaused=function(e){I(e,1505);var t=e.uuid||e.id;if(!t)return A(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}jM.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[t],HM.put(r),VM.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(kM));XM.ID="scheduler",i.Scheduler=XM;var YM=((qM={})[sh.PORTRAIT]=Er.IDENTITY,qM[sh.LANDSCAPE_RIGHT]=Er.ROTATE_90,qM[sh.PORTRAIT_UPSIDE_DOWN]=Er.ROTATE_180,qM[sh.LANDSCAPE_LEFT]=Er.ROTATE_270,qM),KM=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var n=0;n<t.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(e.createTexture(new Do(Dr.TEX2D,Mr.COLOR_ATTACHMENT|Mr.SAMPLED|Mr.TRANSFER_SRC,t.renderPassInfo.colorAttachments[n].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==Cr.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new Do(Dr.TEX2D,Mr.DEPTH_STENCIL_ATTACHMENT|Mr.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new ea(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,YM[fh.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new ea(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=W(this._cameras);!(i=r()).done;)i.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},t._init=function(){},t._destroy=function(){},t._setSwapchain=function(e){this._swapchain=e},t._setFrameBuffer=function(e){this._framebuffer=e},L(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),e}(),QM=function(){var e=t.prototype;function t(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=i.internal.DataPoolManager&&new i.internal.DataPoolManager(e),dg.registerCreateFunc(this),KM.registerCreateFunc(this),this._cameraPool=new We((function(){return new bm(t._device)}),4,(function(e){return e.destroy()}))}return e._init=function(){},e._destroy=function(){},e._setCumulativeTime=function(e){this._cumulativeTime+=e},e._setFrameTime=function(e){this._frameTime=e},e.initialize=function(){this._init();var e=i.game._swapchain,t=new Xo;t.format=e.colorTexture.format;var n=new Yo;n.format=e.depthStencilTexture.format,n.depthStoreOp=qr.DISCARD,n.stencilStoreOp=qr.DISCARD;var r=new Zo([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:r,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(Vv.initBuiltinRes(this._device))},e.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},e.resize=function(e,t){for(var n,i=W(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(e,t)}},e.setRenderPipeline=function(e){e instanceof BM&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=FM(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(br.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;var n=i.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&i.internal.Batcher2D&&(this._batcher=new i.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},e.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},e.activeWindow=function(e){this._curWindow=e},e.resetCumulativeTime=function(){this._setCumulativeTime(0)},e.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();this._batcher&&this._batcher.update();for(var n=this._windows,r=[],o=0;o<n.length;o++)n[o].extractRenderCameras(r);if(this._pipeline&&r.length>0){this._device.acquire([i.game._swapchain]);var a=this._scenes,s=i.director.getTotalFrames();this._batcher&&this._batcher.uploadBuffers();for(var c=0;c<a.length;c++)a[c].update(s);i.director.emit(i.Director.EVENT_BEFORE_COMMIT),r.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(r),this._device.present()}this._batcher&&this._batcher.reset()},e.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},e.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},e.destroyWindows=function(){for(var e,t=W(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},e.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},e.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},e.destroyScenes=function(){for(var e,t=W(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},e.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new We((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.destroy(),e.scene&&e.scene.removeModel(e)):b(1300,e.constructor.name)},e.createCamera=function(){return this._cameraPool.alloc()},e.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new We((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(e.destroy(),t&&(t.free(e),e.scene))switch(e.type){case Gg.SPHERE:e.scene.removeSphereLight(e);break;case Gg.SPOT:e.scene.removeSpotLight(e)}},L(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),t}();i.Root=QM;var ZM=e("Game",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._swapchain=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t}F(t,e);var n=t.prototype;return n.setFrameRate=function(e){this.frameRate=e},n.getFrameRate=function(){return this.frameRate},n.step=function(){i.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(yO._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var e=this;return new Promise((function(e){return i.director.once(i.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return i.director.getScene().destroy(),i.Object._deferredDestroy(),i.director.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},n.end=function(){dn.close()},n.on=function(e,n,i,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(e,n,i,r)},n.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},n.init=function(e){var t=this;if(this._initConfig(e),ph._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&i.assetManager.init(this.config.assetOptions),this.config.layers)for(var n=this.config.layers,r=0;r<n.length;r++){var o=n[r],a=Mn(o.value);Gp.addLayer(o.name,a)}return this._initEngine().then((function(){return t._initEvents(),i.director.root&&i.director.root.dataPoolManager&&i.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},n.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Bu.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},n.addPersistRootNode=function(e){if(i.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=i.director._scene;if(i.isValid(n))if(e.parent){if(!(e.parent instanceof i.Scene))return void b(3801);if(e.parent!==n)return void b(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,i.assetManager._releaseManager._addPersistNodeRef(e)}}else b(3800)},n.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",i.assetManager._releaseManager._removePersistNodeRef(e))},n.isPersistRootNode=function(e){return!!e._persistNode},n._initEngine=function(){var e=this;this._initDevice();var n=i.director;return Promise.resolve(n._init()).then((function(){i.view.init(),_("Cocos Creator v"+r),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,i.internal.dynamicAtlasManager&&(i.internal.dynamicAtlasManager.enabled=!tt.CLEANUP_IMAGE_CACHE)}))},n._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)},n._ctTime=function(e){window.clearTimeout(e)},n._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},n._updateCallback=function(){var e,t=this,n=i.director;if(30===this._frameRate){var r=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(r=!r)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},n._runMainLoop=function(){if(this._inited){var e=this.config,t=i.director;D(!!e.showFPS),t.startAnimation(),this.resume()}},n._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=w.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,g(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},n._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=t.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(P(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var n=new Ao(nd),r=!!window.WebGL2RenderingContext,o=window.navigator.userAgent.toLowerCase();(-1!==o.indexOf("safari")&&-1===o.indexOf("chrome")||dh.browserType===cn.UC)&&(r=!1);var a=[];r&&i.WebGL2Device&&a.push(i.WebGL2Device),i.WebGLDevice&&a.push(i.WebGLDevice),i.EmptyDevice&&a.push(i.EmptyDevice),Ra.canvas=this.canvas;for(var s=0;s<a.length&&(this._gfxDevice=new a[s],!this._gfxDevice.initialize(n));s++);}else this.renderType===t.RENDER_TYPE_HEADLESS&&i.EmptyDevice&&(this._gfxDevice=new i.EmptyDevice,this._gfxDevice.initialize(new Ao(nd)));if(!this._gfxDevice)return d("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);var c=new Co(this.canvas),l=ph.windowSize;c.width=l.width,c.height=l.height,this._swapchain=this._gfxDevice.createSwapchain(c),this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){dn.on("show",this._onShow,this),dn.on("hide",this._onHide,this)},n._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},n._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){i.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof KS?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){p(n),p("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(i.internal.SplashScreen){var e=i.internal.SplashScreen.instance;return e.main(i.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},n._setRenderPipeline=function(e){i.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},n._safeEmit=function(e){this.emit(e)},L(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(pn));ZM.EVENT_HIDE="game_on_hide",ZM.EVENT_SHOW="game_on_show",ZM.EVENT_LOW_MEMORY="game_on_low_memory",ZM.EVENT_GAME_INITED="game_inited",ZM.EVENT_ENGINE_INITED="engine_inited",ZM.EVENT_RENDERER_INITED="renderer_inited",ZM.EVENT_RESTART="game_on_restart",ZM.RENDER_TYPE_CANVAS=0,ZM.RENDER_TYPE_WEBGL=1,ZM.RENDER_TYPE_OPENGL=2,ZM.RENDER_TYPE_HEADLESS=3,ZM.DEBUG_DT_THRESHOLD=1,i.Game=ZM;var JM=e("game",i.game=new ZM),$M=e("Director",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new XM,t._compScheduler=new YO,t._nodeActivator=new fD,t._systems=[],JM.once(ZM.EVENT_RENDERER_INITED,t._initOnRendererInitialized,V(t)),t}F(t,e);var n=t.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),i.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),i.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof _D&&(e=e.scene),I(e instanceof DO,1216),e._load();for(var r=Object.keys(JM._persistRootNodes).map((function(e){return JM._persistRootNodes[e]})),o=0;o<r.length;o++){var a=r[o];a.emit(i.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var s=e.uuid===a._originalSceneId&&e.getChildByUuid(a.uuid);if(s){var c=s.getSiblingIndex();s._destroyImmediate(),e.insertChild(a,c)}else a.parent=e}var l=this._scene;i.isValid(l)&&l.destroy(),i.assetManager._releaseManager._autoRelease(l,e,JM._persistRootNodes),this._scene=null,Qt._deferredDestroy(),t&&t(),this.emit(i.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(i.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var r=this;e instanceof _D&&(e=e.scene),I(e,1205),I(e instanceof DO,1216),e._load(),this.once(i.Director.EVENT_END_FRAME,(function(){r.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var r=this;if(this._loadingScene)return b(1208,e,this._loadingScene),!1;var o=i.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return o?(this.emit(i.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),o.loadScene(e,(function(i,o){console.timeEnd("LoadScene "+e),r._loadingScene="",i?(d(i),t&&t(i)):r.runSceneImmediate(o,n,t)})),!0):(A(1209,e),!1)},n.preloadScene=function(e,t,n){var r=i.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(r)r.preloadScene(e,null,t,n);else{var o='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(o)),d("preloadScene: "+o)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return JM.deltaTime},n.getTotalTime=function(){return JM.totalTime},n.getCurrentTime=function(){return JM.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(XM.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(kM.sortByPriority)},n.unregisterSystem=function(e){Ge.fastRemove(this._systems,e),this._systems.sort(kM.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(i.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){var t;t=JM._calculateDT(e),this.tick(t)},n.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),yO._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var n=0;n<this._systems.length;++n)this._systems[n].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),Qt._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),eA.resetHasChangedFlags(),eA.clearNodeArray(),Ve.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(XM.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new QM(JM._gfxDevice),this._root.initialize({}).catch((function(e){return A(1217),Promise.reject(e)}))},L(t,[{key:"root",get:function(){return this._root}}]),t}(pn));$M.EVENT_INIT="director_init",$M.EVENT_RESET="director_reset",$M.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",$M.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",$M.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",$M.EVENT_BEFORE_UPDATE="director_before_update",$M.EVENT_AFTER_UPDATE="director_after_update",$M.EVENT_BEFORE_DRAW="director_before_draw",$M.EVENT_AFTER_DRAW="director_after_draw",$M.EVENT_BEFORE_COMMIT="director_before_commit",$M.EVENT_BEFORE_PHYSICS="director_before_physics",$M.EVENT_AFTER_PHYSICS="director_after_physics",$M.EVENT_BEGIN_FRAME="director_begin_frame",$M.EVENT_END_FRAME="director_end_frame",$M.instance=void 0,i.Director=$M;var eN=e("director",$M.instance=i.director=new $M),tN={};zn(tN,"vmath",[{name:"vec2",newName:"Vec2",target:Zi,targetName:"math"},{name:"vec3",newName:"Vec3",target:Zi,targetName:"math"},{name:"vec4",newName:"Vec4",target:Zi,targetName:"math"},{name:"quat",newName:"Quat",target:Zi,targetName:"math"},{name:"mat3",newName:"Mat3",target:Zi,targetName:"math"},{name:"mat4",newName:"Mat4",target:Zi,targetName:"math"},{name:"color4",newName:"Color",target:Zi,targetName:"math"},{name:"rect",newName:"Rect",target:Zi,targetName:"math"},{name:"approx",newName:"approx",target:Zi,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:Zi,targetName:"math"},{name:"equals",newName:"equals",target:Zi,targetName:"math"},{name:"clamp",newName:"clamp",target:Zi,targetName:"math"},{name:"clamp01",newName:"clamp01",target:Zi,targetName:"math"},{name:"lerp",newName:"lerp",target:Zi,targetName:"math"},{name:"toRadian",newName:"toRadian",target:Zi,targetName:"math"},{name:"toDegree",newName:"toDegree",target:Zi,targetName:"math"},{name:"random",newName:"random",target:Zi,targetName:"math"},{name:"randomRange",newName:"randomRange",target:Zi,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:Zi,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:Zi,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:Zi,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:Zi,targetName:"math"},{name:"repeat",newName:"repeat",target:Zi,targetName:"math"},{name:"pingPong",newName:"pingPong",target:Zi,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:Zi,targetName:"math"}]),i.vmath=tN,zn(XM.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:XM,targetName:"Scheduler"}]),zn(XM,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return kM.Priority.SCHEDULER}}]),Un(XM,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),zn($v.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),Un($v.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),zn(QM.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),kn(JM,"game",[{name:"collisionMatrix"},{name:"groupList"}]),kn($M.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),Un($M.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var nN,iN={topLeft:i.v2(0,0),topRight:i.v2(0,0),top:i.v2(0,0),bottomLeft:i.v2(0,0),bottomRight:i.v2(0,0),bottom:i.v2(0,0),center:i.v2(0,0),left:i.v2(0,0),right:i.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,o=r+n,a=i+t;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+t/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};i.visibleRect=iN;var rN=new Wi,oN=((nN={})[tt.ORIENTATION_AUTO]=sh.AUTO,nN[tt.ORIENTATION_LANDSCAPE]=sh.LANDSCAPE,nN[tt.ORIENTATION_PORTRAIT]=sh.PORTRAIT,nN),aN=e("View",function(e){function t(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=sN,i=cN;return t._designResolutionSize=new Wi(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new Xi(0,0,0,0),t._visibleRect=new Xi(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new lN(n.EQUAL_TO_FRAME,i.EXACT_FIT),t._rpShowAll=new lN(n.EQUAL_TO_FRAME,i.SHOW_ALL),t._rpNoBorder=new lN(n.EQUAL_TO_FRAME,i.NO_BORDER),t._rpFixedHeight=new lN(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),t._rpFixedWidth=new lN(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}F(t,e);var n=t.prototype;return n.init=function(){var e=ph.windowSize,t=e.width,n=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=n,this._viewportRect.width=t,this._viewportRect.height=n,this._visibleRect.width=t,this._visibleRect.height=n,rN.width=this._visibleRect.width,rN.height=this._visibleRect.height,iN&&iN.init(this._visibleRect),fh.on("window-resize",this._updateAdaptResult,this),fh.on("orientation-change",this._updateAdaptResult,this),fh.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(e){fh.handleResizeEvent=e},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){fh.orientation=oN[e]},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&ph.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){fh.resolutionScale=1;var n=fh.devicePixelRatio,i=new Wi(e*n,t*n);ph.windowSize=i},n.getCanvasSize=function(){return ph.windowSize},n.getFrameSize=function(){var e=fh.devicePixelRatio,t=ph.windowSize;return t.width/=e,t.height/=e,t},n.setFrameSize=function(e,t){var n=fh.devicePixelRatio;ph.windowSize=new Wi(e*n,t*n)},n.getVisibleSize=function(){return new Wi(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new Wi(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new zi(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new zi(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(e){if(e instanceof lN)this._resolutionPolicy=e;else{var t=lN;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=uN.getDesignResolutionSize();uN.setDesignResolutionSize(t.width,t.height,e)},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),rN.width=this._visibleRect.width,rN.height=this._visibleRect.height,iN&&iN.init(this._visibleRect),this.emit("design-resolution-changed")}else A(2200)},n.getDesignResolutionSize=function(){return new Wi(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return fh.devicePixelRatio},n.convertToLocationInView=function(e,t,n,i){void 0===i&&(i=new zi);var r=fh.devicePixelRatio*(e-n.left),o=fh.devicePixelRatio*(n.top+n.height-t);return fh.isFrameRotated?(i.x=ph.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._updateAdaptResult=function(){var e;i.director.root.resize(ph.windowSize.width,ph.windowSize.height);var t=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},t}(pn));aN.instance=void 0;var sN=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupCanvas=function(){var e=JM.canvas;if(e){var t=ph.windowSize;e.width=t.width,e.height=t.height}},e}();sN.EQUAL_TO_FRAME=void 0,sN.PROPORTION_TO_FRAME=void 0;var cN=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,r,o){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var a=new Xi(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},e}();cN.EXACT_FIT=void 0,cN.SHOW_ALL=void 0,cN.NO_BORDER=void 0,cN.FIXED_HEIGHT=void 0,cN.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return F(t,e),t.prototype.apply=function(){fh.isProportionalToFrame=!1,this._setupCanvas()},t}(sN),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return F(t,e),t.prototype.apply=function(){fh.isProportionalToFrame=!0,this._setupCanvas()},t}(sN);sN.EQUAL_TO_FRAME=new e,sN.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return F(t,e),t.prototype.apply=function(e,t){var n=ph.windowSize,i=n.width,r=n.height,o=i/t.width,a=r/t.height;return this._buildResult(i,r,i,r,o,a)},t}(cN),i=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return F(t,e),t.prototype.apply=function(e,t){var n,i,r=ph.windowSize,o=r.width,a=r.height,s=t.width,c=t.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},t}(cN),r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return F(t,e),t.prototype.apply=function(e,t){var n,i,r,o=ph.windowSize,a=o.width,s=o.height,c=t.width,l=t.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},t}(cN),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return F(t,e),t.prototype.apply=function(e,t){var n=ph.windowSize,i=n.width,r=n.height,o=r/t.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(cN),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return F(t,e),t.prototype.apply=function(e,t){var n=ph.windowSize,i=n.width,r=n.height,o=i/t.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(cN);cN.EXACT_FIT=new n,cN.SHOW_ALL=new i,cN.NO_BORDER=new r,cN.FIXED_HEIGHT=new o,cN.FIXED_WIDTH=new a}();var lN=e("ResolutionPolicy",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof sN&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof cN&&(this._contentStrategy=e)},L(e,[{key:"canvasSize",get:function(){return ph.windowSize}}]),e}());lN.EXACT_FIT=0,lN.NO_BORDER=1,lN.SHOW_ALL=2,lN.FIXED_HEIGHT=3,lN.FIXED_WIDTH=4,lN.UNKNOWN=5,lN.ContainerStrategy=sN,lN.ContentStrategy=cN,i.ResolutionPolicy=lN;var uN=e("view",aN.instance=i.view=new aN);i.winSize=rN,Un(aN.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),kn(aN.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"devicePixelRatio is a concept on web standard"},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),kn(i,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),kn(dh,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),zn(dh,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:dh.Language,targetName:"sys.Language"}}))),zn(dh,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:dh.OS,targetName:"sys.OS"}}))),zn(dh,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:dh.BrowserType,targetName:"sys.BrowserType"}}))),zn(dh,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:dh.BrowserType,targetName:"sys.BrowserType"}]),zn(dh,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:dh.Platform,targetName:"sys.Platform"}}))),zn(dh,"sys",[{name:"IPHONE",newName:"IOS",target:dh.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:dh.Platform,targetName:"sys.Platform"}]),Un(dh,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),zn(dh,"sys",[{name:"windowPixelResolution",target:ph,targetName:"screen",newName:"windowSize"}]),kn(ph,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var hN=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new iu,this.scenes=new iu,this.paths=new iu}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,o=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,s=t.length;a<s;a++)t[a]=Su(t[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),f=0,_=t.length;f<_;f++){var p=t[f];t[f]=h[p]=Su(p)}t=h}for(var d in n){var m=n[d];o[t[d]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var S=e.packs;for(var x in S)for(var T=S[x],E=0;E<T.length;++E)T[E]=t[T[E]];var b=e.versions;if(b)for(var C in b)for(var A=b[C],w=0;w<A.length;w+=2){var R=A[w];A[w]=t[R]||R}var I=e.redirect;if(I)for(var P=0;P<I.length;P+=2)I[P]=t[I[P]],I[P+1]=r[I[P+1]];if(e.extensionMap){var O=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var D in e.extensionMap)O(D)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)},t.getInfoWithPath=function(e,t){if(!e)return null;e=Cu(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(He.isChildClassOf(o.ctor,t))return o}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=Cu(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var o=0,a=n.length;o<a;o++){var s=n[o];t&&!He.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=He._getClassById(o),t.has(r)?a?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],o=n.get(r);o.url=i,t.add(i,o)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=t.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];t.get(o).ver=n[i+1]}if(n=e.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];t.get(c).nativeVer=n[a+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}},e}();function fN(e,t){e._uuid&&t.push(e._uuid)}function _N(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=e[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof zu&&fN(s,t)}else if(o.constructor&&o.constructor!==Object)o instanceof zu&&fN(o,t);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof zu&&fN(u,t)}}}}function pN(e,t){for(var n=0;n<e._components.length;n++)_N(e._components[n],t);for(var i=0;i<e._children.length;i++)pN(e._children[i],t)}function dN(e,t,n,i){n.push(e._uuid);for(var r=Xm.getDeps(e._uuid),o=0,a=r.length;o<a;o++){var s=au.get(r[o]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||dN(s,t,n,i)}}}var mN=[],vN=new(function(){function e(){this._persistNodeDeps=new iu,this._toDelete=new iu,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];pN(e,t);for(var n=0,i=t.length;n<i;n++){var r=au.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=au.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=Xm.getDeps(e.uuid),r=0,o=i.length;r<o;r++){var a=au.get(i[r]);a&&a.decRef(e.autoReleaseAssets)}var s=Xm._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=au.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&Xm.remove(e.uuid)}var f=Xm._depends.get(t.uuid);for(var _ in f&&(f.persistDeps=[]),n){for(var p,d,m=n[_],v=this._persistNodeDeps.get(m.uuid),g=W(v);!(d=g()).done;){var y=d.value,S=au.get(y);S&&S.addRef()}f&&(p=f.persistDeps).push.apply(p,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof zu&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,ht(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),Jt(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,dN(e,t,mN,-1),mN.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&dN(au.get(n),t,mN,1);return mN.length=0,t[e._uuid]}(e)>0)){au.remove(n);for(var i=Xm.getDeps(n),r=0,o=i.length;r<o;r++){var a=au.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),Xm.remove(n)}},e}()),gN=null;function yN(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof zu&&r.content.decRef(!1),r.recycle()}e.input=null}function SN(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function xN(e,t,n,i,r){void 0===r&&(r=0),e(r,(function(o,a){r++,!o||r>t?i&&i(o,a):setTimeout((function(){xN(e,t,n,i,r)}),n)}))}function TN(e,t,n,i,r){try{for(var o=Xm.parse(e,t),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(B({},o.nativeDep)))}catch(e){d(e.message,e.stack)}}function EN(e,t,n){t&&(n=void 0!==n?n:i.assetManager.cacheAsset,bu(t)||!n||t.isDefault||au.add(e,t))}function bN(e,t,n){var i=0,r=[],o=e.length;0===o&&n&&n(r);for(var a=function(e){e&&r.push(e),++i===o&&n&&n(r)},s=0;s<o;s++)t(e[s],a)}function CN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a="function"==typeof e;t?(o=t,a||(r=null)):void 0===t&&a&&(o=e,i=null,r=null),void 0!==t&&a&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function AN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a=He.isChildClassOf(e,zu);t?(o=t,a&&(r=null)):void 0!==t||a||(o=e,r=null,i=null),void 0===t||a||(r=e,i=null)}return{type:i,onProgress:r||gN,onComplete:o}}function wN(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var r=!1,o=Xm.getDeps(t);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===e||wN(e,c,n,i)){r=!0;break}}return r}function RN(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof zu&&i.push(e.addRef())})):n instanceof zu&&i.push(n.addRef()),ht((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var IN=function(){function e(){this._config=new hN}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),lu.add(e.name,this)},t.load=function(e,t,n,r){var o=AN(t,n,r),a=o.type,s=o.onProgress,c=o.onComplete,l={__requestType__:ou.PATH,type:a,bundle:this.name,__outputAsArray__:Array.isArray(e)};i.assetManager.loadAny(e,l,s,c)},t.preload=function(e,t,n,r){var o=AN(t,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.preloadAny(e,{__requestType__:ou.PATH,type:a,bundle:this.name},s,c)},t.loadDir=function(e,t,n,r){var o=AN(t,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.loadAny(e,{__requestType__:ou.DIR,type:a,bundle:this.name,__outputAsArray__:!0},s,c)},t.preloadDir=function(e,t,n,r){var o=AN(t,n,r),a=o.type,s=o.onProgress,c=o.onComplete;i.assetManager.preloadAny(e,{__requestType__:ou.DIR,type:a,bundle:this.name},s,c)},t.loadScene=function(e,t,n,r){var o=CN(t,n,r),a=o.options,s=o.onProgress,c=o.onComplete;a.preset=a.preset||"scene",a.bundle=this.name,i.assetManager.loadAny({scene:e},a,s,(function(e,t){if(e)d(e.message,e.stack);else if(t instanceof _D&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");c&&c(e,t)}))},t.preloadScene=function(e,t,n,r){var o=CN(t,n,r),a=o.options,s=o.onProgress,c=o.onComplete;a.bundle=this.name,i.assetManager.preloadAny({scene:e},a,s,(function(t){t&&A(1210,e,t.message),c&&c(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&au.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&vN.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;au.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&vN.tryRelease(t)}))},t.releaseAll=function(){var e=this;au.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&vN.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},L(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),PN=e("resources",new IN);function ON(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(P(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=e,i}function DN(e,t,n,i){var r=new XMLHttpRequest,o="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)r.setRequestHeader(a,t.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}i.resources=PN;var MN={};function NN(e,t,n){if(MN[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),MN[e]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(P(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var LN=/^(?:\w+:\/\/|\.+\/).+/,BN=function(e,t,n){(dh.hasFeature(dh.Feature.IMAGE_BITMAP)&&i.assetManager.allowImageBitmap?FN:ON)(e,t,n)},FN=function(e,t,n){t.xhrResponseType="blob",DN(e,t,t.onFileProgress,n)},zN=function(e,t,n){t.xhrResponseType="json",DN(e,t,t.onFileProgress,n)},UN=function(e,t,n){t.xhrResponseType="arraybuffer",DN(e,t,t.onFileProgress,n)},kN=function(e,t,n){zN(e,t,(function(t,i){if(t)n(t);else{var r=yh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){UN(""+xn(e)+n,{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new gh(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},GN=function(e,t,n){UN(e,t,(function(e,t){if(e)n(e);else try{var i=Sh(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},HN=function(e,t,n){t.xhrResponseType="text",DN(e,t,t.onFileProgress,n)},VN=function(e,t,n){var i=Tn(e),r=e;LN.test(r)||(r=-1!==jN.remoteBundles.indexOf(i)?jN.remoteServerAddress+"remote/"+i:"assets/"+i);var o=t.version||jN.bundleVers[i],a=0,s=null,c=null;zN(r+"/config."+(o?o+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=r+"/"),2==++a&&n(c,s)})),NN(r+"/index."+(o?o+".":"")+"js",t,(function(e){c=e,2==++a&&n(e,s)}))},jN=new(function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=ON,this.downloadDomAudio=null,this.downloadFile=DN,this.downloadScript=NN,this._downloaders={".png":BN,".jpg":BN,".bmp":BN,".jpeg":BN,".gif":BN,".ico":BN,".tiff":BN,".webp":BN,".image":BN,".pvr":UN,".pkm":UN,".astc":UN,".txt":HN,".xml":HN,".vsh":HN,".fsh":HN,".atlas":HN,".tmx":HN,".tsx":HN,".json":zN,".ExportJson":zN,".plist":HN,".ccon":kN,".cconb":GN,".fnt":HN,".binary":UN,".bin":UN,".dbbin":UN,".skel":UN,".js":NN,bundle:VN,default:HN},this._downloading=new iu,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?be(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,r){var o=this,a=su.get(e);if(a)r(null,a);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,f=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,_=this._downloaders[n]||this._downloaders.default;xN((function(n,a){if(0===n&&o._downloading.add(e,[r]),o.limited){o._updateTime();var s=function(e,t){o._totalNum--,o._handleQueueInNextFrame(h,f),a(e,t)};o._totalNum<h&&o._totalNumThisPeriod<f?(_(SN(t,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:_}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,f))}else _(SN(t,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(t,n){t||su.add(e,n);for(var i=o._downloading.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))}}},t.loadSubpackage=function(e,t){i.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=performance.now(),t=i.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(SN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(ht(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},L(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}());function WN(e,t,n,i){var r=null,o=null;try{(r=new Um)._nativeUrl=e,r._nativeAsset=t}catch(e){o=e}i(o,r)}function qN(e,t,n,i){var r=new yD;r.json=t,i(null,r)}function XN(e,t,n,i){var r=new gD;r.text=t,i(null,r)}function YN(e,t,n,i){var r=new HA;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function KN(e,t,n,i){var r=new zu;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function QN(e,n,i,r){var o=lu.get(n.name);o||(o=n.name===_u.RESOURCES?PN:new IN,n.base=n.base||e+"/",o.init(n)),t.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var ZN=new(function(){function e(){this._creating=new iu,this._producers={".png":WN,".jpg":WN,".bmp":WN,".jpeg":WN,".gif":WN,".ico":WN,".tiff":WN,".webp":WN,".image":WN,".pvr":WN,".pkm":WN,".txt":XN,".xml":XN,".vsh":XN,".fsh":XN,".atlas":XN,".tmx":XN,".tsx":XN,".fnt":XN,".json":qN,".ExportJson":qN,".binary":YN,".bin":YN,".dbbin":YN,".skel":YN,bundle:QN,default:KN}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?He.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=au.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),a(e,t,i,(function(t,n){!t&&n instanceof zu&&(n._uuid=e,EN(e,n,i.cacheAsset));for(var r=o._creating.remove(e),a=0,s=r.length;a<s;a++)r[a](t,n)})))}else r(null,s)},e}()),JN=new(function(){function e(){this._loading=new iu,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var r=He.createMap(!0),o=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(P(5304,e[0]));kh(e,!0,void 0,Hh.reportMissingClass),Gh(e);for(var t=new Vh(e[0]),n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=0;s<a.length;++s)a[s].unshift(t,n,i,r,o);return a}(t)).length!==e.length&&A(4915);for(var a=0;a<e.length;a++)r[e[a]+"@import"]=t[a]}else{var s=He._getClassId(uv),c=He._getClassId(Um);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&A(4915);for(var u=0;u<e.length;u++)r[e[u]+"@import"]=jh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&A(4915);for(var f=0;f<e.length;f++)r[e[f]+"@import"]=h[f]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?He.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(su.has(e.id))n(null,su.get(e.id));else{var r=e.info.packs,o=r.find((function(e){return i._loading.has(e.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:e.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:e.id}]);var a=Au(o.uuid,{ext:o.ext,bundle:e.config.name});jN.download(o.uuid,a,o.ext,e.options,(function(t,n){su.remove(o.uuid),t&&d(t.message,t.stack),i.unpack(o.packedUuids,n,o.ext,e.options,(function(e,n){if(!e)for(var r in n)su.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else jN.download(e.id,e.url,e.ext,e.options,n)},e}());function $N(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var r=e.options,o=e.progress,a=[],s=o.total,c=r.__exclude__=r.__exclude__||Object.create(null);e.output=[],bN(e.input,(function(r,l){if(!r.isNative&&au.has(r.uuid)){var u=au.get(r.uuid);return r.content=u.addRef(),e.output.push(r),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,r),void l()}JN.load(r,e.options,(function(u,h){u?e.isFinish||(!i.assetManager.force||n?(d(u.message,u.stack),o.canInvoke=!1,t(u)):(e.output.push(r),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,r))):e.isFinish||(r.file=h,e.output.push(r),r.isNative||(c[r.uuid]=!0,TN(r.uuid,h,c,a,r.config),o.total=s+a.length),o.canInvoke&&e.dispatch("progress",++o.finish,o.total,r)),l()}))}),(function(){if(e.isFinish)return yN(e,!0),void e.dispatch("error");if(a.length>0){var i=du.create({input:a,progress:o,options:r,onProgress:e.onProgress,onError:du.prototype.recycle,onComplete:function(r){var o;r||((o=e.output).push.apply(o,i.output),i.recycle()),n&&eL(e),t(r)}});hu.async(i)}else n&&eL(e),t()}))}function eL(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var tL=new(function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return b(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t},n._parseDict=function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var o=e.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:t[n]=this._parseNode(o))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function nL(e,t){return e[t]<<8|e[t+1]}var iL=new(function(){function e(){this._parsing=new iu,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parsePVRTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],f=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:f,height:h,format:0}}}catch(e){i=e}n(i,r)},t.parsePKMTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o),s=nL(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=nL(a,12),l=nL(a,14);nL(a,8),nL(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)},t.parseASTCTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?lm.RGBA_ASTC_4x4:5===e?4===t?lm.RGBA_ASTC_5x4:lm.RGBA_ASTC_5x5:6===e?5===t?lm.RGBA_ASTC_6x5:lm.RGBA_ASTC_6x6:8===e?5===t?lm.RGBA_ASTC_8x5:6===t?lm.RGBA_ASTC_8x6:lm.RGBA_ASTC_8x8:10===e?5===t?lm.RGBA_ASTC_10x5:6===t?lm.RGBA_ASTC_10x6:8===t?lm.RGBA_ASTC_10x8:lm.RGBA_ASTC_10x10:10===t?lm.RGBA_ASTC_12x10:lm.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),f=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:f,format:u}}catch(e){i=e}n(i,r)},t.parsePlist=function(e,t,n){var i=null,r=tL.parse(e);r||(i=new Error("parse failed")),n(i,r)},t.parseImport=function(e,t,n){if(e){var i=null,r=null;try{i=Wm(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?be(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,r){var o=this,a=cu.get(e);if(a)r(null,a);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?su.remove(e):bu(n)||cu.add(e,n);for(var i=o._parsing.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))):r(null,t)}}},e}());function rL(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var r=e.options,o=e.progress;r.__exclude__=r.__exclude__||Object.create(null),e.output=[],bN(e.input,(function(a,s){var c=du.create({input:a,onProgress:e.onProgress,options:r,progress:o,onComplete:function(r,l){r&&!e.isFinish&&(!i.assetManager.force||n?(d(r.message,r.stack),o.canInvoke=!1,t(r)):o.canInvoke&&e.dispatch("progress",++o.finish,o.total,a)),e.output.push(l),c.recycle(),s(null)}});oL.async(c)}),(function(){if(r.__exclude__=null,e.isFinish)return yN(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),yN(e,!0),t()}))}var oL=new ru("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&au.has(o)?t():JN.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)iL.parse(o,a,n.ext,s,(function(r,a){r?t(r):(n.content=a,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),su.remove(o),cu.remove(o),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,f=l.err,_=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||wN(c,c,r)?(h&&h.addRef(),n.content=h,t(f)):_.push({done:t,item:n})}else if(!s.reloadAsset&&au.has(c)){var p=au.get(c);n.content=p.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,iL.parse(o,a,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),TN(a,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var f=e.options.__exclude__[a]={content:t,finish:!1,callbacks:[{done:n,item:i}]},_=du.create({input:h,options:e.options,onProgress:e.onProgress,onError:du.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),f.finish=!0,f.err=e,!e){for(var n,i=Array.isArray(_.output)?_.output:[_.output],r=Object.create(null),o=W(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof zu?c._uuid+"@import":a+"@native"]=c)}!function(e,t,n){var i=Hm.get(t);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(d("The asset "+a.uuid+" is missing!"),a.type&&a.type!==zu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}Hm.delete(t)}Vm.has(t)&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),Vm.delete(t))}(a,t,r);try{"function"!=typeof t.onLoaded||jm.has(t)||Vm.has(t)||(t.onLoaded(),jm.add(t))}catch(e){d("The asset "+a+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}su.remove(s),cu.remove(s),EN(a,t,u),_.recycle()}for(var l=f.callbacks,h=0,p=l.length;h<p;h++){var m=l[h];t.addRef&&t.addRef(),m.item.content=t,m.done(e)}l.length=0}});uu.async(_)}(e,i,t)}))}}]);function aL(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case ou.PATH:case ou.UUID:case ou.DIR:case ou.SCENE:case ou.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}e.options=r;var a=du.create({input:e.input,options:i}),s=null;try{e.output=e.source=fu.sync(a)}catch(e){s=e;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),t(s)}var sL=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},L(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();sL.MAX_DEAD_NUM=500,sL._deadPool=[];var cL=[];function lL(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,o=n[i],a=sL.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[t.__requestType__||ou.UUID]=n[i]),"object"==typeof o)for(var l in Ee(o,t),o.preset&&Ee(o,pu[o.preset]),o){switch(l){case ou.UUID:if("break"===function(){var e,t=a.uuid=Su(o.uuid);if(!o.bundle){var n=lu.find((function(e){return!!e.getAssetInfo(t)}));o.bundle=n&&n.name}if(lu.has(o.bundle)){if(s=lu.get(o.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!lu.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=lu.get(c.redirect).config,c=s.getAssetInfo(t)}a.config=s,a.info=c}return a.ext=o.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case ou.DIR:if(lu.has(o.bundle)){lu.get(o.bundle).config.getDirWithPath(o.dir,o.type,cL);for(var u,h=W(cL);!(u=h()).done;){var f=u.value;n.push({uuid:f.uuid,__isNative__:!1,ext:f.extension||".json",bundle:o.bundle})}cL.length=0}a.recycle(),a=null;break;case ou.PATH:if(lu.has(o.bundle)){if(s=lu.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!lu.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=lu.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case ou.SCENE:if(!o.bundle){var _=lu.find((function(e){return!!e.getSceneInfo(o.scene)}));o.bundle=_&&_.name}if(lu.has(o.bundle)){if(s=lu.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!lu.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=lu.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case ou.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||Sn(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(e.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function uL(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var r=t[n];if(!r.url){var o,a,s=r.config;a=r.isNative?s&&s.nativeBase?s.base+s.nativeBase:i.assetManager.generalNativeBase:s&&s.importBase?s.base+s.importBase:i.assetManager.generalImportBase;var c=r.uuid,l="";r.info&&(l=r.isNative?r.info.nativeVer?"."+r.info.nativeVer:"":r.info.ver?"."+r.info.ver:""),o=".ttf"===r.ext?a+"/"+c.slice(0,2)+"/"+c+l+"/"+r.options.__nativeName__:a+"/"+c.slice(0,2)+"/"+c+l+r.ext,r.url=o}}return null}var hL=e("AssetManager",function(){function e(){this.pipeline=uu.append(aL).append(rL),this.fetchPipeline=hu.append(aL).append($N),this.transformPipeline=fu.append(lL).append(uL),this.bundles=lu,this.assets=au,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Xm,this.force=!1,this.allowImageBitmap=!dh.isMobile,this.utils=Lu,this.downloader=jN,this.parser=iL,this.packManager=JN,this.cacheAsset=!0,this.cacheManager=null,this.presets=pu,this.factory=ZN,this.preprocessPipe=aL,this.fetchPipe=$N,this.loadPipe=rL,this.references=null,this._releaseManager=vN,this._files=su,this._parsed=cu,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return lu.get(e)||null},t.removeBundle=function(e){e._destroy(),lu.remove(e.name)},t.loadAny=function(e,t,n,i){var r=CN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",e=Array.isArray(e)?e.slice():e;var c=du.create({input:e,onProgress:a,onComplete:RN(s),options:o});uu.async(c)},t.preloadAny=function(e,t,n,i){var r=CN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=du.create({input:e,onProgress:a,onComplete:RN(s),options:o});hu.async(c)},t.loadRemote=function(e,t,n){var i=CN(t,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(d(t.message,t.stack),o&&o(t,n)):ZN.create(e,n,r.ext||Sn(e),r,(function(e,t){o&&o(e,t)}))}))):RN(o)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=CN(t,void 0,n),r=i.options,o=i.onComplete,a=Tn(e);this.bundles.has(a)?RN(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(d(t.message,t.stack),o&&o(t,n)):ZN.create(e,n,"bundle",r,(function(e,t){o&&o(e,t)}))})))},t.releaseAsset=function(e){vN.tryRelease(e,!0)},t.releaseUnusedAssets=function(){au.forEach((function(e){vN.tryRelease(e)}))},t.releaseAll=function(){au.forEach((function(e){vN.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},L(e,[{key:"main",get:function(){return lu.get(_u.MAIN)||null}},{key:"resources",get:function(){return lu.get(_u.RESOURCES)||null}}]),e}());hL.Pipeline=ru,hL.Task=du,hL.Cache=iu,hL.RequestItem=sL,hL.Bundle=IN,hL.BuiltinBundleName=_u;var fL=e("assetManager",i.assetManager=new hL);i.AssetManager=hL;var _L=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],pL=[".mp3",".ogg",".wav",".m4a"];function dL(){return!0}var mL={transformURL:function(e){var t=Tu(e);if(!t)return e;var n=lu.find((function(e){return!!e.getAssetInfo(t)}));if(!n)return e;var i,r=n.getAssetInfo(t);if(!(i=e.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(i))return e;var o=!1;if(".ttf"===Sn(e)&&(o=!0),o){var a=En(e),s=Tn(e);e=a+"."+i+"/"+s}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return e+"."+i}));return e}},vL=e("CCLoader",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=AN}var t=e.prototype;return t.load=function(e,t,n){void 0===n&&void 0!==t&&(n=t,t=null);for(var i=Array.isArray(e)?e:[e],r=0;r<i.length;r++){var o=i[r];"string"==typeof o?i[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];fL.loadAny(i,null,(function(e,n,i){i.content&&(_L.includes(i.ext)?a.push(i.content):pL.includes(i.ext)&&s.push(i.content)),t&&t(e,n,i)}),(function(e,t){var r=null;if(!e){t=Array.isArray(t)?t:[t];for(var o=function(e){var n=t[e];if(!(n instanceof zu)){var r=n,o=i[e].url;a.includes(r)?ZN.create(o,n,".png",{},(function(n,i){r=t[e]=i})):s.includes(r)&&ZN.create(o,n,".mp3",{},(function(n,i){r=t[e]=i})),au.add(o,r)}},c=0;c<t.length;c++)o(c);if(t.length>1){var l=Object.create(null);t.forEach((function(e){l[e._uuid]=e})),r={isCompleted:dL,_map:l}}else r=t[0]}n&&n(e,r)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return fL.assets.has(e)?{content:fL.assets.get(e)}:null},t.loadRes=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c=Sn(e);c&&!PN.getInfoWithPath(e,o)&&(e=e.slice(0,-c.length)),PN.load(e,o,a,s)},t.loadResArray=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;e.forEach((function(t,n){var i=Sn(t);i&&!PN.getInfoWithPath(t,o)&&(e[n]=t.slice(0,-i.length))})),PN.load(e,o,a,s)},t.loadResDir=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;PN.loadDir(e,o,a,(function(t,n){var i=[];t||(i=PN.getDirWithPath(e,o).map((function(e){return e.path}))),s&&s(t,n,i)}))},t.getRes=function(e,t){return au.has(e)?au.get(e):PN.get(e,t)},t.getResCount=function(){return au.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return Xm.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({url:e},n)}};for(var i in e)n(i);jN.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({content:e},n)}};for(var i in e)n(i);iL.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];"string"==typeof n&&(n=au.get(n)),fL.releaseAsset(n)}else e&&("string"==typeof e&&(e=au.get(e)),fL.releaseAsset(e))},t.releaseAsset=function(e){fL.releaseAsset(e)},t.releaseRes=function(e,t){PN.release(e,t)},t.releaseAll=function(){fL.releaseAll(),au.clear()},t.removeItem=function(e){return!!au.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=Xm.getDepsRecursively(e),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},L(e,[{key:"onProgress",set:function(e){gN=e}},{key:"_cache",get:function(){if(au instanceof iu)return au._map;var e={};return au.forEach((function(t,n){e[n]=t})),e}},{key:"md5Pipe",get:function(){return mL}},{key:"downloader",get:function(){return jN}},{key:"loader",get:function(){return fL.parser}}]),e}()),gL=e("loader",new vL),yL=e("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,fL.init(e),e.rawAssets&&PN.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:_u.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){fL.loadAny(e,t)}}),SL=e("url",{});zn(SL,"url",[{name:"normalize",target:fL.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?Au({path:bn(e.substr(10)),bundle:_u.RESOURCES,__isNative__:!0,ext:Sn(e)}):""}}]),Un(yL,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),Un(gL,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),zn(i,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return gL}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return yL}},{name:"Pipeline",target:hL,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return SL}}]),Un(i,"cc",[{name:"LoadingItems",suggest:P(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),zn(tt,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:jN,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),zn(eN,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return fL.main?null===(t=fL.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),zn(JM,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return fL.main&&fL.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var xL,TL,EL,bL,CL,AL,wL,RL,IL,PL,OL,DL,ML,NL,LL=vN._autoRelease;vN._autoRelease=function(e,t,n){LL.call(vN,e,t,n);for(var i=gL._autoReleaseSetting,r=Object.keys(i),o=0;o<r.length;o++){var a=r[o];if(!0===i[a]){var s=au.get(a);s&&vN.tryRelease(s)}}};var BL,FL,zL,UL,kL,GL,HL,VL,jL,WL,qL,XL,YL,KL,QL,ZL,JL,$L,eB,tB,nB,iB,rB,oB,aB,sB,cB,lB,uB,hB,fB,_B,pB,dB,mB,vB,gB,yB,SB,xB,TB,EB,bB,CB,AB,wB,RB,IB,PB,OB,DB,MB,NB,LB,BB,FB,zB,UB,kB,GB,HB,VB,jB,WB,qB,XB,YB,KB=e("EventHandler",(xL=sl("cc.ClickEvent"),TL=Hl(i.Node),EL=Rl(),bL=Rl(),CL=Rl(),AL=Rl(),xL((NL=function(){function e(){q(this,"target",IL,this),q(this,"component",PL,this),q(this,"_componentId",OL,this),q(this,"handler",DL,this),q(this,"customEventData",ML,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=t.length;o<a;o++){var s=t[o];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(i.isValid(t)){this._genCompIdIfNeeded();var n=i.js._getClassById(this._componentId),r=t.getComponent(n);if(i.isValid(r)){var o=r[this.handler];"function"==typeof o&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),o.apply(r,e))}}},t._compName2Id=function(e){var t=i.js.getClassByName(e);return i.js._getClassId(t)},t._compId2Name=function(e){var t=i.js._getClassById(e);return i.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},L(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),IL=X((RL=NL).prototype,"target",[_l,TL,_l,EL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PL=X(RL.prototype,"component",[_l,bl,bL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),OL=X(RL.prototype,"_componentId",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),DL=X(RL.prototype,"handler",[_l,bl,CL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ML=X(RL.prototype,"customEventData",[_l,bl,AL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wL=RL))||wL));i.Component.EventHandler=KB;var QB,ZB,JB,$B,eF,tF,nF,iF,rF,oF,aF,sF=new yi,cF=Qe(tm),lF=Qe(em),uF=Qe(nm),hF=Qe(rm),fF=Qe(im),_F=Qe({SKYBOX:Tm|ao.DEPTH_STENCIL,SOLID_COLOR:ao.ALL,DEPTH_ONLY:ao.DEPTH_STENCIL,DONT_CLEAR:ao.NONE}),pF=(BL=sl("cc.Camera"),FL=El(),zL=yl(),UL=Nl(),kL=Rl(),GL=Hl(Gp.BitMask),HL=Nl(),VL=Rl(),jL=Hl(_F),WL=Nl(),qL=Rl(),XL=Nl(),YL=Rl(),KL=Nl(),QL=Rl(),ZL=Nl(),JL=Rl(),$L=Hl(cF),eB=Nl(),tB=Rl(),nB=Hl(lF),iB=Nl(),rB=Rl(),oB=Nl(),aB=Rl(),sB=Nl(),cB=Rl(),lB=Nl(),uB=Rl(),hB=Nl(),fB=Rl(),_B=Hl(uF),pB=Nl(),dB=Rl(),mB=Hl(hF),vB=Nl(),gB=Rl(),yB=Hl(fF),SB=Nl(),xB=Rl(),TB=Nl(),EB=Rl(),bB=Hl(CT),CB=Nl(),AB=Rl(),QB=BL(wB=FL(wB=zL(wB=gl((YB=XB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_projection",IB,V(t)),q(t,"_priority",PB,V(t)),q(t,"_fov",OB,V(t)),q(t,"_fovAxis",DB,V(t)),q(t,"_orthoHeight",MB,V(t)),q(t,"_near",NB,V(t)),q(t,"_far",LB,V(t)),q(t,"_color",BB,V(t)),q(t,"_depth",FB,V(t)),q(t,"_stencil",zB,V(t)),q(t,"_clearFlags",UB,V(t)),q(t,"_rect",kB,V(t)),q(t,"_aperture",GB,V(t)),q(t,"_shutter",HB,V(t)),q(t,"_iso",VB,V(t)),q(t,"_screenScale",jB,V(t)),q(t,"_visibility",WB,V(t)),q(t,"_targetTexture",qB,V(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}F(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=ig.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=pr.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new yi),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new yi),!this._camera)return n;this.worldToScreen(e,sF);var r=t.getComponent("cc.UITransform"),o=uN.getVisibleSize(),a=sF.x-.5*this._camera.width,s=sF.y-.5*this._camera.height;return sF.x=a/i.view.getScaleX()+.5*o.width,sF.y=s/i.view.getScaleY()+.5*o.height,r&&r.convertToNodeSpaceAR(sF,n),n},n._createCamera=function(){this._camera||(this._camera=i.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=ti(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},L(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===em.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=ti(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var n=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow)}}]),t}(oh),XB.ProjectionType=cF,XB.FOVAxis=lF,XB.ClearFlag=_F,XB.Aperture=uF,XB.Shutter=hF,XB.ISO=fF,XB.TARGET_TEXTURE_CHANGE="tex-change",IB=X((RB=YB).prototype,"_projection",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cF.PERSPECTIVE}}),PB=X(RB.prototype,"_priority",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OB=X(RB.prototype,"_fov",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),DB=X(RB.prototype,"_fovAxis",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lF.VERTICAL}}),MB=X(RB.prototype,"_orthoHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),NB=X(RB.prototype,"_near",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),LB=X(RB.prototype,"_far",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),BB=X(RB.prototype,"_color",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi("#333333")}}),FB=X(RB.prototype,"_depth",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),zB=X(RB.prototype,"_stencil",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UB=X(RB.prototype,"_clearFlags",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _F.SOLID_COLOR}}),kB=X(RB.prototype,"_rect",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xi(0,0,1,1)}}),GB=X(RB.prototype,"_aperture",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uF.F16_0}}),HB=X(RB.prototype,"_shutter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hF.D125}}),VB=X(RB.prototype,"_iso",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fF.ISO100}}),jB=X(RB.prototype,"_screenScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),WB=X(RB.prototype,"_visibility",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return om}}),qB=X(RB.prototype,"_targetTexture",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(RB.prototype,"priority",[UL,kL],Object.getOwnPropertyDescriptor(RB.prototype,"priority"),RB.prototype),X(RB.prototype,"visibility",[GL,HL,VL],Object.getOwnPropertyDescriptor(RB.prototype,"visibility"),RB.prototype),X(RB.prototype,"clearFlags",[jL,WL,qL],Object.getOwnPropertyDescriptor(RB.prototype,"clearFlags"),RB.prototype),X(RB.prototype,"clearColor",[XL,YL],Object.getOwnPropertyDescriptor(RB.prototype,"clearColor"),RB.prototype),X(RB.prototype,"clearDepth",[KL,QL],Object.getOwnPropertyDescriptor(RB.prototype,"clearDepth"),RB.prototype),X(RB.prototype,"clearStencil",[ZL,JL],Object.getOwnPropertyDescriptor(RB.prototype,"clearStencil"),RB.prototype),X(RB.prototype,"projection",[$L,eB,tB],Object.getOwnPropertyDescriptor(RB.prototype,"projection"),RB.prototype),X(RB.prototype,"fovAxis",[nB,iB,rB],Object.getOwnPropertyDescriptor(RB.prototype,"fovAxis"),RB.prototype),X(RB.prototype,"fov",[oB,aB],Object.getOwnPropertyDescriptor(RB.prototype,"fov"),RB.prototype),X(RB.prototype,"orthoHeight",[sB,cB],Object.getOwnPropertyDescriptor(RB.prototype,"orthoHeight"),RB.prototype),X(RB.prototype,"near",[lB,uB],Object.getOwnPropertyDescriptor(RB.prototype,"near"),RB.prototype),X(RB.prototype,"far",[hB,fB],Object.getOwnPropertyDescriptor(RB.prototype,"far"),RB.prototype),X(RB.prototype,"aperture",[_B,pB,dB],Object.getOwnPropertyDescriptor(RB.prototype,"aperture"),RB.prototype),X(RB.prototype,"shutter",[mB,vB,gB],Object.getOwnPropertyDescriptor(RB.prototype,"shutter"),RB.prototype),X(RB.prototype,"iso",[yB,SB,xB],Object.getOwnPropertyDescriptor(RB.prototype,"iso"),RB.prototype),X(RB.prototype,"rect",[TB,EB],Object.getOwnPropertyDescriptor(RB.prototype,"rect"),RB.prototype),X(RB.prototype,"targetTexture",[bB,CB,AB],Object.getOwnPropertyDescriptor(RB.prototype,"targetTexture"),RB.prototype),wB=RB))||wB)||wB)||wB)||wB,e({Camera:QB,CameraComponent:QB}),QB);i.Camera=pF;var dF,mF,vF,gF,yF,SF,xF,TF,EF={parent:null,owner:null,subModelIdx:0},bF=e("RenderableComponent",(ZB=sl("cc.RenderableComponent"),JB=Hl([Ng]),$B=Hl(Ng),eF=Nl(),tF=wl(),ZB((aF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_materials",rF,V(t)),q(t,"_visFlags",oF,V(t)),t._materialInstances=[],t._models=[],t}F(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof Qg&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){EF.parent=this._materials[e],EF.owner=this,EF.subModelIdx=e;var t=new Qg(EF);EF.parent=null,EF.owner=null,EF.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){if("number"==typeof e){b(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},L(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var n=this._materials.length-t;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=e[i]&&this.setMaterialInstance(e[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}}]),t}(oh),rF=X((iF=aF).prototype,"_materials",[JB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oF=X(iF.prototype,"_visFlags",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gp.Enum.NONE}}),X(iF.prototype,"sharedMaterials",[$B,eF,tF],Object.getOwnPropertyDescriptor(iF.prototype,"sharedMaterials"),iF.prototype),nF=iF))||nF));function CF(e){return"string"==typeof e||"number"==typeof e}i.RenderableComponent=bF,zn(pF,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),zn(pF.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),i.CameraComponent=pF,He.setClassAlias(pF,"cc.CameraComponent");var AF,wF,RF,IF,PF,OF,DF,MF,NF,LF,BF,FF,zF,UF,kF,GF,HF,VF,jF,WF,qF,XF,YF=sl("cc.animation.HierarchyPath")((gF=function(){function e(e){q(this,"path",vF,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof eA?e.getChildByPath(this.path)||(b(3926,e.name,this.path),null):(b(3925),null)},e}(),vF=X((mF=gF).prototype,"path",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dF=mF))||dF,KF=sl("cc.animation.ComponentPath")((TF=function(){function e(e){q(this,"component",xF,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof eA?e.getComponent(this.component)||(b(3928,e.name,this.component),null):(b(3927),null)},e}(),xF=X((SF=TF).prototype,"component",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yF=SF))||yF,QF=sl("cc.animation.UniformProxyFactory")((OF=function(){function e(e,t){q(this,"passIndex",RF,this),q(this,"uniformName",IF,this),q(this,"channelIndex",PF,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');if(Qv.getTypeFromHandle(n)<wr.SAMPLER1D){var r=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,wr.FLOAT);if(!r)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=W(e.shaderInfo.blocks);!(n=i()).done;)for(var r,o=W(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===t)return a.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(r,e)}}:{set:function(e){t.setUniform(r,e)}}}var o=Qv.getBindingFromHandle(n),a=t.properties[this.uniformName],s=a&&a.value?a.value+"-texture":Rv(a.type),c=Vv.get(s);return c||(p("Illegal texture default value: "+s+"."),c=Vv.get("default-texture")),{set:function(e){e||(e=c);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(o,n),e instanceof Gm&&t.bindSampler(o,i.game._gfxDevice.getSampler(e.getSamplerInfo())))}}},e}(),RF=X((wF=OF).prototype,"passIndex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IF=X(wF.prototype,"uniformName",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),PF=X(wF.prototype,"channelIndex",[Ul],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),AF=wF))||AF,ZF=sl("cc.animation.MorphWeightValueProxy")((BF=function(){function e(){q(this,"subMeshIndex",NF,this),q(this,"shapeIndex",LF,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}},e}(),NF=X((MF=BF).prototype,"subMeshIndex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LF=X(MF.prototype,"shapeIndex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DF=MF))||DF,JF=sl("cc.animation.MorphWeightsValueProxy")((kF=function(){function e(){q(this,"subMeshIndex",UF,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),UF=X((zF=kF).prototype,"subMeshIndex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FF=zF))||FF,$F=sl("cc.animation.MorphWeightsAllValueProxy")(GF=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)e.setWeights(t,o)}}},e}())||GF;function ez(e,t,n,i){var r,o,a,s,c,l,u=new t,h=new t,f=new t,_=sl(e)((l=function(){function e(e,n,i){q(this,"dataPoint",a,this),q(this,"inTangent",s,this),q(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var r=e.prototype;return r.lerp=function(e,t,r){var o=this.dataPoint,a=e.dataPoint;h=n(h,this.inTangent,r),f=n(f,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,_=-2*s+3*c,p=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,_),u=i(u,u,f,p)},r.getNoLerp=function(){return this.dataPoint},e}(),a=X((o=l).prototype,"dataPoint",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=X(o.prototype,"inTangent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=X(o.prototype,"outTangent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=o))||r;if(t===Ai){var p=_.prototype.lerp;_.prototype.lerp=function(e,t,n){var i=p.call(this,e,t,n);return Ai.normalize(i,i),i}}return _}var tz=e("CubicSplineVec2Value",ez("cc.CubicSplineVec2Value",zi,zi.multiplyScalar,zi.scaleAndAdd));i.CubicSplineVec2Value=tz;var nz=e("CubicSplineVec3Value",ez("cc.CubicSplineVec3Value",yi,yi.multiplyScalar,yi.scaleAndAdd));i.CubicSplineVec3Value=nz;var iz=e("CubicSplineVec4Value",ez("cc.CubicSplineVec4Value",Hi,Hi.multiplyScalar,Hi.scaleAndAdd));i.CubicSplineVec4Value=iz;var rz=e("CubicSplineQuatValue",ez("cc.CubicSplineQuatValue",Ai,Ai.multiplyScalar,Ai.scaleAndAdd));i.CubicSplineQuatValue=rz;var oz=e("CubicSplineNumberValue",sl("cc.CubicSplineNumberValue")((XF=function(){function e(e,t,n){q(this,"dataPoint",jF,this),q(this,"inTangent",WF,this),q(this,"outTangent",qF,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,r=e.dataPoint,o=t*t*t,a=t*t;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+t)+r*(-2*o+3*a)+e.inTangent*n*(o-a)},t.getNoLerp=function(){return this.dataPoint},e}(),jF=X((VF=XF).prototype,"dataPoint",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WF=X(VF.prototype,"inTangent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qF=X(VF.prototype,"outTangent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HF=VF))||HF);i.CubicSplineNumberValue=oz;var az,sz,cz,lz,uz,hz,fz,_z,pz,dz,mz,vz,gz,yz,Sz,xz,Tz,Ez,bz,Cz,Az,wz,Rz,Iz,Pz,Oz,Dz,Mz=Symbol("CreateEval"),Nz=Symbol("NormalizedFollow"),Lz=Symbol("ConvertAsTrsPath"),Bz=Symbol("TrackBinding"),Fz=sl("cc.animation.TrackPath")((lz=function(){function e(){q(this,"_paths",cz,this)}var t=e.prototype;return t.toProperty=function(e){return this._paths.push(e),this},t.toElement=function(e){return this._paths.push(e),this},t.toHierarchy=function(e){return this._paths.push(new YF(e)),this},t.toComponent=function(e){var t=new KF("string"==typeof e?e:He.getClassName(e));return this._paths.push(t),this},t.toCustomized=function(e){return this._paths.push(e),this},t.append=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,n.map((function(e){return e._paths})));return this._paths=r,this},t.isPropertyAt=function(e){return"string"==typeof this._paths[e]},t.parsePropertyAt=function(e){return this._paths[e]},t.isElementAt=function(e){return"number"==typeof this._paths[e]},t.parseElementAt=function(e){return this._paths[e]},t.isHierarchyAt=function(e){return this._paths[e]instanceof YF},t.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},t.isComponentAt=function(e){return this._paths[e]instanceof KF},t.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},t.slice=function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i},t.trace=function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[Nz](e,t,n)},t[Lz]=function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var o=t[i];if(!(o instanceof YF))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}},t[Nz]=function(e,t,n){for(var i=this._paths,r=e,o=t;o<n;++o){var a=i[o];if(CF(a)){if(!(a in r))return b(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},L(e,[{key:"length",get:function(){return this._paths.length}}]),e}(),cz=X((sz=lz).prototype,"_paths",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),az=sz))||az,zz=sl("cc.animation.TrackBinding")(uz=vl((pz=function(){function e(){q(this,"path",fz,this),q(this,"proxy",_z,this)}var t=e.prototype;return t.parseTrsPath=function(){return this.proxy?null:this.path[Lz]()},t.createRuntimeBinding=function(e,t,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[Nz](e,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return A(3921),null}var h,f=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),_=i[Nz](e,0,o-1);return null===_?null:t&&_ instanceof eA&&("position"===(h=f)||"rotation"===h||"scale"===h||"eulerAngles"===h)?t.createPoseWriter(_,f,n):{setValue:function(e){_[f]=e},getValue:function(){return _[f]}}},e}(),fz=X((hz=pz).prototype,"path",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fz}}),_z=X(hz.prototype,"proxy",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uz=hz))||uz)||uz,Uz=sl("cc.animation.Track")((gz=function(){function e(){q(this,"_binding",vz,this)}var t=e.prototype;return t.channels=function(){return[]},t.range=function(){for(var e,t={min:1/0,max:-1/0},n=W(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t},L(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:Bz,get:function(){return this._binding}}]),e}(),vz=X((mz=gz).prototype,"_binding",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zz}}),dz=mz))||dz,kz=sl("cc.animation.Channel")((Tz=function(){function e(e){this.name="",q(this,"_curve",xz,this),this._curve=e}return L(e,[{key:"curve",get:function(){return this._curve}}]),e}(),xz=X((Sz=Tz).prototype,"_curve",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),yz=Sz))||yz,Gz=sl("cc.animation.SingleChannelTrack")((Az=function(e){function t(){var t;return q(t=e.call(this)||this,"_channel",Cz,V(t)),t._channel=new kz(t.createCurve()),t}F(t,e);var n=t.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[Mz]=function(){var e=this._channel.curve;return new Hz(e)},L(t,[{key:"channel",get:function(){return this._channel}}]),t}(Uz),Cz=X((bz=Az).prototype,"_channel",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ez=bz))||Ez,Hz=function(){function e(e){this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e)},e}(),Vz=sl("cc.animation.RealTrack")(wz=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t.prototype.createCurve=function(){return new x_},t}(Gz))||wz;function jz(e){return 0===e.keyFramesCount?void 0:e}var Wz,qz,Xz,Yz,Kz,Qz,Zz,Jz,$z,eU,tU=["X","Y","Z","W"],nU=sl("cc.animation.VectorTrack")((Dz=function(e){function t(){var t;q(t=e.call(this)||this,"_channels",Pz,V(t)),q(t,"_nComponents",Oz,V(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new kz(new x_);i.name=tU[n],t._channels[n]=i}return t}F(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Mz]=function(){switch(this._nComponents){default:case 2:return new iU(jz(this._channels[0].curve),jz(this._channels[1].curve));case 3:return new rU(jz(this._channels[0].curve),jz(this._channels[1].curve),jz(this._channels[2].curve));case 4:return new oU(jz(this._channels[0].curve),jz(this._channels[1].curve),jz(this._channels[2].curve),jz(this._channels[3].curve))}},L(t,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),t}(Uz),Pz=X((Iz=Dz).prototype,"_channels",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Oz=X(Iz.prototype,"_nComponents",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),Rz=Iz))||Rz,iU=function(){function e(e,t){this._result=new zi,this._x=e,this._y=t}return e.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||zi.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},e}(),rU=function(){function e(e,t,n){this._result=new yi,this._x=e,this._y=t,this._z=n}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||yi.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},e}(),oU=function(){function e(e,t,n,i){this._result=new Hi,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Hi.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},e}(),aU=sl("cc.animation.QuatTrack")(Wz=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.createCurve=function(){return new sp},n[Mz]=function(){return new sU(this.channels()[0].curve)},t}(Gz))||Wz,sU=function(){function e(e){this._result=new Ai,this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},e}(),cU=["Red","Green","Blue","Alpha"],lU=sl("cc.animation.ColorTrack")((Kz=function(e){function t(){var t;q(t=e.call(this)||this,"_channels",Yz,V(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new kz(new x_);i.name=cU[n],t._channels[n]=i}return t}F(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Mz]=function(){return new uU(jz(this._channels[0].curve),jz(this._channels[1].curve),jz(this._channels[2].curve),jz(this._channels[3].curve))},t}(Uz),Yz=X((Xz=Kz).prototype,"_channels",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),qz=Xz))||qz,uU=function(){function e(e,t,n,i){this._result=new vi,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||vi.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},e}(),hU=["Width","Height"],fU=sl("cc.animation.SizeTrack")(($z=function(e){function t(){var t;q(t=e.call(this)||this,"_channels",Jz,V(t)),t._channels=new Array(2);for(var n=0;n<t._channels.length;++n){var i=new kz(new x_);i.name=hU[n],t._channels[n]=i}return t}F(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Mz]=function(){return new _U(jz(this._channels[0].curve),jz(this._channels[1].curve))},t}(Uz),Jz=X((Zz=$z).prototype,"_channels",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Qz=Zz))||Qz,_U=function(){function e(e,t){this._result=new Wi,this._width=e,this._height=t}return e.prototype.evaluate=function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},e}(),pU=sl("cc.animation.ObjectTrack")(eU=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t.prototype.createCurve=function(){return new Tp},t}(Gz))||eU,dU=Symbol("[[Owner]]");function mU(e){e[dU]}var vU,gU,yU,SU,xU,TU,EU,bU,CU,AU,wU,RU,IU,PU,OU,DU,MU,NU,LU,BU=function(e){function t(t){var n;return(n=e.call(this,t+" transition is invalid")||this).name="TransitionRejectError",n}return F(t,e),t}(H(Error)),FU=function(e){function t(t){return e.call(this,"Graph variable "+t+" is not defined")||this}return F(t,e),t}(H(Error)),zU=function(e){function t(t,n,i){return e.call(this,"Expect graph variable "+t+" to have type '"+n+"' instead of received '"+(null!=i?i:typeof i)+"'")||this}return F(t,e),t}(H(Error)),UU=Symbol("[[createEval]]"),kU=Symbol("[[Outgoing transitions]]"),GU=Symbol("[[Incoming transitions]]"),HU=sl("cc.animation.State")((SU=function(e){function t(){var t;return q(t=e.call(this)||this,"name",yU,V(t)),t[kU]=[],t[GU]=[],t}return F(t,e),t}(tu),yU=X((gU=SU).prototype,"name",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vU=gU))||vU,VU=sl("cc.animation.InteractiveState")((bU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_components",EU,V(t)),t}F(t,e);var n=t.prototype;return n.addComponent=function(e){var t=new e;return this._components.push(t),t},n.removeComponent=function(e){Z(this._components,e)},n.instantiateComponents=function(){return this._components.map((function(e){return af(e)}))},L(t,[{key:"components",get:function(){return this._components}}]),t}(HU),EU=X((TU=bU).prototype,"_components",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xU=TU))||xU;!function(e){e[e.FLOAT=0]="FLOAT",e[e.BOOLEAN=1]="BOOLEAN",e[e.TRIGGER=2]="TRIGGER",e[e.INTEGER=3]="INTEGER"}(LU||(LU={}));var jU,WU,qU,XU,YU,KU=sl("cc.animation.BindableNumber")((IU=function(){function e(e){void 0===e&&(e=0),q(this,"variable",wU,this),q(this,"value",RU,this),this.value=e}return e.prototype.clone=function(){var t=new e;return t.value=this.value,t.variable=this.variable,t},e}(),wU=X((AU=IU).prototype,"variable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),RU=X(AU.prototype,"value",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),CU=AU))||CU,QU=sl("cc.animation.BindableBoolean")((NU=function(){function e(e){void 0===e&&(e=!1),q(this,"variable",DU,this),q(this,"value",MU,this),this.value=e}return e.prototype.clone=function(){var t=new e;return t.value=this.value,t.variable=this.variable,t},e}(),DU=X((OU=NU).prototype,"variable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),MU=X(OU.prototype,"value",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),PU=OU))||PU;function ZU(e,t,n,i,r){var o=t.variable,a=t.value;if(!o)return a;var s=e.getVar(o);if(!$U(s,o))return a;if(s.type!==n)throw new zU(o,"number");for(var c=arguments.length,l=new Array(c>5?c-5:0),u=5;u<c;u++)l[u-5]=arguments[u];var h=s.bind.apply(s,[i,r].concat(l));return h}function JU(e,t,n,i,r){var o=t.variable,a=t.value;if(!o)return a;var s=e.getVar(o);if(!$U(s,o))return a;if(n!==LU.FLOAT&&n!==LU.INTEGER)throw new zU(o,"number or integer");for(var c=arguments.length,l=new Array(c>5?c-5:0),u=5;u<c;u++)l[u-5]=arguments[u];var h=s.bind.apply(s,[i,r].concat(l));return h}function $U(e,t){if(e)return!0;throw new FU(t)}var ek,tk,nk,ik,rk,ok,ak,sk,ck,lk,uk,hk,fk,_k,pk,dk,mk,vk,gk,yk,Sk,xk,Tk,Ek,bk,Ck,Ak,wk,Rk,Ik,Pk,Ok,Dk,Mk,Nk,Lk,Bk,Fk,zk,Uk,kk,Gk,Hk,Vk=sl("cc.animation.Motion")((YU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"motion",qU,V(t)),q(t,"speed",XU,V(t)),t}return F(t,e),t.prototype.clone=function(){var e,n,i=new t;return i.motion=null!==(e=null===(n=this.motion)||void 0===n?void 0:n.clone())&&void 0!==e?e:null,i.speed=this.speed.clone(),i},t}(VU),qU=X((WU=YU).prototype,"motion",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XU=X(WU.prototype,"speed",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KU(1)}}),jU=WU))||jU,jk=Symbol("[[OnAfterDeserialized]]"),Wk=sl("cc.animation.Transition")((ok=function(e){function t(t,n,i){var r;return q(r=e.call(this)||this,"from",nk,V(r)),q(r,"to",ik,V(r)),q(r,"conditions",rk,V(r)),r[dU]=void 0,r.from=t,r.to=n,i&&(r.conditions=i),r}return F(t,e),t}(tu),nk=X((tk=ok).prototype,"from",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ik=X(tk.prototype,"to",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rk=X(tk.prototype,"conditions",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ek=tk))||ek,qk=sl("cc.animation.AnimationTransition")((fk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"duration",ck,V(t)),q(t,"relativeDuration",lk,V(t)),q(t,"exitConditionEnabled",uk,V(t)),q(t,"_exitCondition",hk,V(t)),t}return F(t,e),L(t,[{key:"exitCondition",get:function(){return this._exitCondition},set:function(e){this._exitCondition=e}}]),t}(Wk),ck=X((sk=fk).prototype,"duration",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),lk=X(sk.prototype,"relativeDuration",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uk=X(sk.prototype,"exitConditionEnabled",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hk=X(sk.prototype,"_exitCondition",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ak=sk))||ak;function Xk(e){return e instanceof qk}var Yk,Kk=sl("cc.animation.StateMachine")((Sk=function(e){F(n,e);var t=n.prototype;function n(){var t;return q(t=e.call(this)||this,"_states",dk,V(t)),q(t,"_transitions",mk,V(t)),q(t,"_entryState",vk,V(t)),q(t,"_exitState",gk,V(t)),q(t,"_anyState",yk,V(t)),t._entryState=t._addState(new HU),t._entryState.name="Entry",t._exitState=t._addState(new HU),t._exitState.name="Exit",t._anyState=t._addState(new HU),t._anyState.name="Any",t}return t.__callOnAfterDeserializeRecursive=function(){this[jk]();for(var e=this._states.length,t=0;t<e;++t){var n=this._states[t];n instanceof Qk&&n.stateMachine.__callOnAfterDeserializeRecursive()}},t[jk]=function(){this._states.forEach((function(){})),this._transitions.forEach((function(e){e.from[kU].push(e),e.to[GU].push(e)}))},t[UU]=function(){throw new Error("Method not implemented.")},t.states=function(){return this._states},t.transitions=function(){return this._transitions},t.getTransitionsBetween=function(e,t){return mU(e),mU(t),e[kU].filter((function(e){return e.to===t}))},t.getOutgoings=function(e){return mU(e),e[kU]},t.getIncomings=function(e){return mU(e),e[GU]},t.addMotion=function(){return this._addState(new Vk)},t.addSubStateMachine=function(){return this._addState(new Qk)},t.remove=function(e){mU(e),e!==this.entryState&&e!==this.exitState&&e!==this.anyState&&(this.eraseTransitionsIncludes(e),Z(this._states,e))},t.connect=function(e,t,n){if(mU(e),mU(t),t===this.entryState)throw new BU("to-entry");if(t===this.anyState)throw new BU("to-any");if(e===this.exitState)throw new BU("from-exit");var i=e instanceof Vk||e===this._anyState?new qk(e,t,n):new Wk(e,t,n);return this._transitions.push(i),e[kU].push(i),t[GU].push(i),i},t.disconnect=function(e,t){mU(e),mU(t);for(var n=e[kU],i=t[GU],r=this._transitions,o=n.filter((function(e){return e.to===t})),a=o.length,s=function(e){var t=o[e];Z(n,t),Z(r,t),J(i,(function(e){return e===t}))},c=0;c<a;++c)s(c)},t.removeTransition=function(e){Z(this._transitions,e),J(e.from[kU],(function(t){return t===e})),J(e.to[GU],(function(t){return t===e}))},t.eraseOutgoings=function(e){var t=this;mU(e);for(var n=e[kU],i=function(e){var i=n[e],r=i.to;Z(t._transitions,i),J(r[GU],(function(e){return e===i}))},r=0;r<n.length;++r)i(r);n.length=0},t.eraseIncomings=function(e){var t=this;mU(e);for(var n=e[GU],i=function(e){var i=n[e],r=i.from;Z(t._transitions,i),J(r[kU],(function(e){return e===i}))},r=0;r<n.length;++r)i(r);n.length=0},t.eraseTransitionsIncludes=function(e){this.eraseIncomings(e),this.eraseOutgoings(e)},t.clone=function(){for(var e,t=new n,i=new Map,r=W(this._states);!(e=r()).done;){var o=e.value;switch(o){case this._entryState:i.set(o,t._entryState);break;case this._exitState:i.set(o,t._exitState);break;case this._anyState:i.set(o,t._anyState);break;default:if(o instanceof Vk||o instanceof Qk){var a=o.clone();t._addState(a),i.set(o,a)}}}for(var s,c=W(this._transitions);!(s=c()).done;){var l=s.value,u=i.get(l.from),h=i.get(l.to),f=t.connect(u,h);f.conditions=l.conditions.map((function(e){return e.clone()})),f instanceof qk&&(f.duration=l.duration,f.exitConditionEnabled=l.exitConditionEnabled,f.exitCondition=l.exitCondition)}return t},t._addState=function(e){return this._states.push(e),e},L(n,[{key:"entryState",get:function(){return this._entryState}},{key:"exitState",get:function(){return this._exitState}},{key:"anyState",get:function(){return this._anyState}}]),n}(tu),dk=X((pk=Sk).prototype,"_states",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mk=X(pk.prototype,"_transitions",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vk=X(pk.prototype,"_entryState",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),gk=X(pk.prototype,"_exitState",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),yk=X(pk.prototype,"_anyState",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_k=pk))||_k,Qk=sl("cc.animation.SubStateMachine")((bk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_stateMachine",Ek,V(t)),t}return F(t,e),t.prototype.clone=function(){var e=new t;return e._stateMachine=this._stateMachine.clone(),e},L(t,[{key:"stateMachine",get:function(){return this._stateMachine}}]),t}(VU),Ek=X((Tk=bk).prototype,"_stateMachine",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kk}}),xk=Tk))||xk,Zk=sl("cc.animation.Layer")((Dk=function(){function e(){this[dU]=void 0,q(this,"_stateMachine",wk,this),q(this,"name",Rk,this),q(this,"weight",Ik,this),q(this,"mask",Pk,this),q(this,"blending",Ok,this),this._stateMachine=new Kk}return L(e,[{key:"stateMachine",get:function(){return this._stateMachine}}]),e}(),wk=X((Ak=Dk).prototype,"_stateMachine",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Rk=X(Ak.prototype,"name",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ik=X(Ak.prototype,"weight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Pk=X(Ak.prototype,"mask",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ok=X(Ak.prototype,"blending",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yk.additive}}),Ck=Ak))||Ck;!function(e){e[e.override=0]="override",e[e.additive=1]="additive"}(Yk||(Yk={}));var Jk=sl("cc.animation.Variable")((Fk=function(){function e(e){if(q(this,"_type",Lk,this),q(this,"_value",Bk,this),void 0!==e)switch(this._type=e,e){default:break;case LU.FLOAT:case LU.INTEGER:this._value=0;break;case LU.BOOLEAN:case LU.TRIGGER:this._value=!1}}return L(e,[{key:"type",get:function(){return this._type}},{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),e}(),Lk=X((Nk=Fk).prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LU.FLOAT}}),Bk=X(Nk.prototype,"_value",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mk=Nk))||Mk,$k=sl("cc.animation.AnimationGraph")((Hk=function(e){function t(){var t;return q(t=e.call(this)||this,"_layers",kk,V(t)),q(t,"_variables",Gk,V(t)),t}F(t,e);var n=t.prototype;return n.onLoaded=function(){for(var e=this._layers,t=e.length,n=0;n<t;++n)e[n].stateMachine.__callOnAfterDeserializeRecursive()},n.addLayer=function(){var e=new Zk;return this._layers.push(e),e},n.removeLayer=function(e){Ge.removeAt(this._layers,e)},n.moveLayer=function(e,t){!function(e,t,n){if(Ke(e,t),Ke(e,n),t===n)return e;var i=e[t];if(t<n)for(var r=t+1;r<=n;++r)e[r-1]=e[r];else for(var o=t;o!==n;--o)e[o]=e[o-1];e[n]=i}(this._layers,e,t)},n.addVariable=function(e,t,n){var i=new Jk(t);void 0!==n&&(i.value=n),this._variables[e]=i},n.removeVariable=function(e){delete this._variables[e]},n.getVariable=function(e){return this._variables[e]},L(t,[{key:"layers",get:function(){return this._layers}},{key:"variables",get:function(){return Object.entries(this._variables)}}]),t}(zu),kk=X((Uk=Hk).prototype,"_layers",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gk=X(Uk.prototype,"_variables",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),zk=Uk))||zk,eG=Symbol("BakeNodeCurves"),tG=e("SkelAnimDataHub",function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&i.director.root.dataPoolManager.releaseAnimationClip(t);var r=Math.ceil(t.sample*t.duration)+1,o=t.sample;n=t[eG](0,o,r),e.pool.set(t,n)}return n},e.destroy=function(t){e.pool.delete(t)},e}());tG.pool=new Map;var nG=e("RatioSampler",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,r=1,o=e.length;r<o;r++)if(t=e[r]-e[r-1],1===r)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?aG:Jc}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());i.RatioSampler=nG;var iG=e("AnimCurve",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(t.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(t.easingMethods[a])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=dG(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,r){if(this._lerp){var o=this.types?this.types[t]:this.type,a=r-n,s=(e-n)/a;if(o&&(s=oG(s,o)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],f=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,f,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var _=0;_<this._array.length;++_)this._array[_]=this._values[this._array.length*t+_];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function rG(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function oG(e,t){if("string"==typeof t){var n=s_[t];n?e=n(e):A(3906,t)}else Array.isArray(t)&&(e=ip(t,e));return e}function aG(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var o=(t=(t-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}iG.Linear=null,i.AnimCurve=iG,e("EventInfo",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),i.sampleAnimationCurve=rG;var sG,cG,lG,uG,hG,fG,_G,pG,dG=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return ei;if("object"==typeof t&&t.constructor){if(t instanceof Ai)return n=new Ai,function(e,t,i){return Ai.slerp(n,e,t,i)};if(t instanceof et)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return ei;if("function"==typeof t.lerp)return e}var n}}}(),mG=sl("cc.animation.UntypedTrackChannel")((uG=function(e){function t(){var t;return q(t=e.call(this,new x_)||this,"property",lG,V(t)),t}return F(t,e),t}(kz),lG=X((cG=uG).prototype,"property",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sG=cG))||sG,vG=sl("cc.animation.UntypedTrack")((pG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_channels",_G,V(t)),t}F(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Mz]=function(e){var t=this;if(!e.getValue)throw new Error(P(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(P(3931));case i instanceof zi:return new iU(n("x"),n("y"));case i instanceof yi:return new rU(n("x"),n("y"),n("z"));case i instanceof Hi:return new oU(n("x"),n("y"),n("z"),n("w"));case i instanceof vi:return new uU(n("r"),n("g"),n("b"),n("a"));case i instanceof Wi:return new _U(n("width"),n("height"))}},n.addChannel=function(e){var t=new mG;return t.property=e,this._channels.push(t),t},n.upgrade=function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new nU;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new lU,h=u.channels(),f=h[0],_=h[1],p=h[2],d=h[3];return n("r",f),n("g",_),n("b",p),n("a",d),n("x",f),n("y",_),n("z",p),n("w",d),u;case"size":}return null},t}(Uz),_G=X((fG=pG).prototype,"_channels",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hG=fG))||hG,gG=function(){function e(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}var t=e.prototype;return t.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},t.toTracks=function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(e,t,n){for(var i,r=new Fz,o=W(t);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof YF?r.toHierarchy(a.path):a instanceof KF?r.toComponent(a.component):r.toCustomized(a)}e.path=r,e.proxy=n},a=r.map((function(e){var n=new vG;return o(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var f=new SG(s,l.length),_=function(e){o(e,r.modifiers,r.valueAdapter)},p=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return b(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return b(3933),"continue";var d=r.modifiers[0],m=a[r.commonTarget].addChannel(d).curve;p=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void b(3934);var e;if(p)e=p;else{var n=new Vz;_(n),t.push(n),e=n.channel.curve}var i=h?Kl.LINEAR:Kl.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void f.convert(e)}if("object"==typeof u)switch(!0){default:break;case yG(c,zi):case yG(c,yi):case yG(c,Hi):var r=u instanceof zi?2:u instanceof yi?3:4,o=new nU;_(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,d=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?Kl.LINEAR:Kl.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),f.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),f.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),f.convert(s),d.assignSorted(l,c.map((function(e){return y(e.y)}))),f.convert(d)}return void t.push(o);case yG(c,Ai):var S=new aU;_(S);var x=h?Q_.SLERP:Q_.CONSTANT;return S.channel.curve.assignSorted(l,c.map((function(e){return{value:Ai.clone(e),interpolationMode:x}}))),f.convertQuatCurve(S.channel.curve),void t.push(S);case yG(c,vi):var T=new lU;_(T);var E=T.channels(),C=E[0].curve,A=E[1].curve,w=E[2].curve,R=E[3].curve,I=h?Kl.LINEAR:Kl.CONSTANT,P=function(e){return{value:e,interpolationMode:I}};return C.assignSorted(l,c.map((function(e){return P(e.r)}))),f.convert(C),A.assignSorted(l,c.map((function(e){return P(e.g)}))),f.convert(A),w.assignSorted(l,c.map((function(e){return P(e.b)}))),f.convert(w),R.assignSorted(l,c.map((function(e){return P(e.a)}))),f.convert(R),void t.push(T);case yG(c,Wi):var O=new fU;_(O);var D=O.channels(),M=D[0].curve,N=D[1].curve,L=h?Kl.LINEAR:Kl.CONSTANT,B=function(e){return{value:e,interpolationMode:L}};return M.assignSorted(l,c.map((function(e){return B(e.width)}))),f.convert(M),N.assignSorted(l,c.map((function(e){return B(e.height)}))),f.convert(N),void t.push(O);case yG(c,oz):var F=new Vz;_(F);var z=h?Kl.CUBIC:Kl.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:z}}))),void t.push(F);case yG(c,tz):case yG(c,nz):case yG(c,iz):var U=u instanceof tz?2:u instanceof nz?3:4,k=new nU;_(k),k.componentsCount=U;var G=k.channels(),H=G[0],V=G[1],j=G[2],W=G[3],q=h?Kl.LINEAR:Kl.CONSTANT,X=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:q}};switch(U){case 4:W.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:H.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),V.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(k);case c.every((function(e){return e instanceof rz})):b(3935)}var Y=new pU;_(Y),Y.channel.curve.assignSorted(l,c),t.push(Y)}()},c=W(i);!(e=c()).done;)s();return t},t._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new nG(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new iG(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))},L(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),e}();function yG(e,t){return e.every((function(e){return e instanceof t}))}var SG=function(){function e(e,t){this._easingMethods=void 0;var n=e.easingMethods;Array.isArray(n)?0===n.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(t).fill(e.easingMethod):Array.from({length:t},(function(e,t){var i;return null!==(i=n[t])&&void 0!==i?i:null}))}var t=e.prototype;return t.convert=function(e){var t,n,i,r,o,a,s,c,l,u,h,f,_,p,d,m,v,g,y,S,x,T,E=this._easingMethods;if(E){var b=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(E)&&E.length;for(var C=b-1,A=0;A<C;++A){var w=E[A];w&&(Array.isArray(w)?(t=w,n=e.getKeyframeTime(A),i=e.getKeyframeValue(A),r=e.getKeyframeTime(A+1),o=e.getKeyframeValue(A+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,f=void 0,_=void 0,p=void 0,d=void 0,m=void 0,v=void 0,g=void 0,y=void 0,S=void 0,x=void 0,T=void 0,s=t[0],c=t[1],l=t[2],u=t[3],h=i.value,f=3*(r-n),_=3*(o.value-h),m=(1-l)*f,v=(1-u)*_,g=1/3,y=(d=c*_)/(p=s*f),S=Math.sqrt(p*p+d*d)*g,x=v/m,T=Math.sqrt(m*m+v*v)*g,i.interpolationMode=Kl.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===Zl.NONE?Zl.RIGHT:a===Zl.LEFT?Zl.BOTH:a,i.rightTangent=y,i.rightTangentWeight=S,o.tangentWeightMode=function(e){return e===Zl.NONE?Zl.LEFT:e===Zl.RIGHT?Zl.BOTH:e}(o.tangentWeightMode),o.leftTangent=x,o.leftTangentWeight=T):xG(w,e,A))}}}},t.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var o=t[r];o&&(Array.isArray(o)?e.getKeyframeValue(r).easingMethod=o.slice():TG(o,e,r))}}}},L(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}}]),e}();function xG(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=JG[e];r===a_.CONSTANT?i.interpolationMode=Kl.CONSTANT:(i.interpolationMode=Kl.LINEAR,i.easingMethod=r)}function TG(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=JG[e];i.easingMethod=r}var EG,bG,CG,AG,wG,RG,IG,PG,OG,DG,MG,NG,LG,BG,FG,zG,UG,kG,GG,HG,VG,jG,WG,qG,XG,YG,KG,QG,ZG,JG={constant:a_.CONSTANT,linear:a_.LINEAR,quadIn:a_.QUAD_IN,quadOut:a_.QUAD_OUT,quadInOut:a_.QUAD_IN_OUT,quadOutIn:a_.QUAD_OUT_IN,cubicIn:a_.CUBIC_IN,cubicOut:a_.CUBIC_OUT,cubicInOut:a_.CUBIC_IN_OUT,cubicOutIn:a_.CUBIC_OUT_IN,quartIn:a_.QUART_IN,quartOut:a_.QUART_OUT,quartInOut:a_.QUART_IN_OUT,quartOutIn:a_.QUART_OUT_IN,quintIn:a_.QUINT_IN,quintOut:a_.QUINT_OUT,quintInOut:a_.QUINT_IN_OUT,quintOutIn:a_.QUINT_OUT_IN,sineIn:a_.SINE_IN,sineOut:a_.SINE_OUT,sineInOut:a_.SINE_IN_OUT,sineOutIn:a_.SINE_OUT_IN,expoIn:a_.EXPO_IN,expoOut:a_.EXPO_OUT,expoInOut:a_.EXPO_IN_OUT,expoOutIn:a_.EXPO_OUT_IN,circIn:a_.CIRC_IN,circOut:a_.CIRC_OUT,circInOut:a_.CIRC_IN_OUT,circOutIn:a_.CIRC_OUT_IN,elasticIn:a_.ELASTIC_IN,elasticOut:a_.ELASTIC_OUT,elasticInOut:a_.ELASTIC_IN_OUT,elasticOutIn:a_.ELASTIC_OUT_IN,backIn:a_.BACK_IN,backOut:a_.BACK_OUT,backInOut:a_.BACK_IN_OUT,backOutIn:a_.BACK_OUT_IN,bounceIn:a_.BOUNCE_IN,bounceOut:a_.BOUNCE_OUT,bounceInOut:a_.BOUNCE_IN_OUT,bounceOutIn:a_.BOUNCE_OUT_IN,smooth:a_.SMOOTH,fade:a_.FADE};function $G(){throw new Error("split() only valid in Editor.")}sl("cc.animation.ExoticAnimation")((CG=function(){function e(){q(this,"_nodeAnimations",bG,this)}var t=e.prototype;return t.createEvaluator=function(e){return new lH(this._nodeAnimations,e)},t.addNodeAnimation=function(e){var t=new eH(e);return this._nodeAnimations.push(t),t},t.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))},t.split=function(){return $G()},t.toHashString=function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")},e}(),bG=X((EG=CG).prototype,"_nodeAnimations",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EG));var eH=sl("cc.animation.ExoticNodeAnimation")((DG=function(){function e(e){q(this,"_path",RG,this),q(this,"_position",IG,this),q(this,"_rotation",PG,this),q(this,"_scale",OG,this),this._path=e}var t=e.prototype;return t.createPosition=function(e,t){this._position=new aH(e,new rH(t))},t.createRotation=function(e,t){this._rotation=new aH(e,new oH(t))},t.createScale=function(e,t){this._scale=new aH(e,new rH(t))},t.createEvaluator=function(e){return new uH(this._path,this._position,this._rotation,this._scale,e)},t.split=function(){return $G()},t.toHashString=function(){var e,t,n,i,r,o;return this._path+"\n"+(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},L(e,[{key:"path",get:function(){return this._path}}]),e}(),RG=X((wG=DG).prototype,"_path",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),IG=X(wG.prototype,"_position",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PG=X(wG.prototype,"_rotation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OG=X(wG.prototype,"_scale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AG=wG))||AG;function tH(e){return e.toPrecision(2)}function nH(e){return e.map(tH).join(" ")}var iH=sl("cc.animation.ExoticVectorLikeTrackValues")((FG=function(){function e(e){q(this,"_values",LG,this),q(this,"_isQuantized",BG,this),this._values=e,this._isQuantized=!1}var t=e.prototype;return t.quantize=function(e){this._isQuantized,this._values=function(e,t){var n=fH[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),o=Math.max(e,o)}));var a=o-r,s=n.from(e,(function(e){return(e-r)/a*i}));return new wH(_H(e),s,a,r)}(this._values,e),this._isQuantized=!0},t.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():nH(t))},L(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:_H(this._values)}}]),e}(),LG=X((NG=FG).prototype,"_values",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),BG=X(NG.prototype,"_isQuantized",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),MG=NG))||MG,rH=sl("cc.animation.ExoticVec3TrackValues")(zG=function(e){function t(){return e.apply(this,arguments)||this}F(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?PH(n,e,t):yi.fromArray(t,n,3*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(PH(a,e,i),PH(a,t,r)):(yi.fromArray(i,a,3*e),yi.fromArray(r,a,3*t)),yi.lerp(o,i,r,n)},t}(iH))||zG,oH=sl("cc.animation.ExoticQuatTrackValues")(UG=function(e){function t(){return e.apply(this,arguments)||this}F(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?OH(n,e,t):Ai.fromArray(t,n,4*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(OH(a,e,i),OH(a,t,r)):(Ai.fromArray(i,a,4*e),Ai.fromArray(r,a,4*t)),Ai.slerp(o,i,r,n)},t}(iH))||UG,aH=sl("cc.animation.ExoticTrack")((jG=function(){function e(e,t){q(this,"times",HG,this),q(this,"values",VG,this),this.times=e,this.values=t}return e.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+nH(e)+"; values: "+t.toHashString()},e}(),HG=X((GG=jG).prototype,"times",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),VG=X(GG.prototype,"values",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kG=GG))||kG;function sH(e,t){e.length,e.length;var n=0,i=0,r=Jc(e,t);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=e[o],c=e[a];i=(t-c)/(s-c)}return{index:n,ratio:i}}!function(){function e(){this._reset()}var t=e.prototype;t.transformTime=function(e){return e-this._timeOffset},t.calculate=function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],o=e[i-1],a=Jn(t,r,o),s=Jn(n,r,o);this._timeOffset=a;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=sH(e,t),o=r.index,a=r.ratio,s=sH(e,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(e,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,f=c.toRatio,_=!u,p=!f;l!==h||u!==f?(_||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=_?l:l+1,this.directKeyframesEnd=h+1,p||(this.postLerpIndex=h,this.postLerpRatio=f)):_?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},t._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},L(e,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}])}();var cH,lH=function(){function e(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((function(e){return e.createEvaluator(t)}))}return e.prototype.evaluate=function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))},e}(),uH=function(){function e(e,t,n,i,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=IH(t.times,t.values,yi,e,"position",r)),n&&(this._rotation=IH(n.times,n.values,Ai,e,"rotation",r)),i&&(this._scale=IH(i.times,i.values,yi,e,"scale",r))}return e.prototype.evaluate=function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}},e}(),hH=function(){function e(e,t,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return e.prototype.evaluate=function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],o=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>o)n.just=!0,n.index=i-1;else{var a=Jc(e,t);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},e}(),fH={uint8:Uint8Array,uint16:Uint16Array};function _H(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return cH.FLOAT_32;case 8:return cH.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(cH||(cH={}));var pH,dH,mH,vH,gH,yH,SH,xH,TH,EH,bH,CH,AH,wH=sl("cc.animation.QuantizedFloatArray")((ZG=function(){function e(e,t,n,i){void 0===i&&(i=0),q(this,"originalPrecision",XG,this),q(this,"min",YG,this),q(this,"extent",KG,this),q(this,"values",QG,this),this.originalPrecision=e,this.values=t,this.extent=n,this.min=i}return e.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return e+" "+tH(t)+" "+tH(n)+" "+i.join(" ")},L(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),e}(),XG=X((qG=ZG).prototype,"originalPrecision",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),YG=X(qG.prototype,"min",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),KG=X(qG.prototype,"extent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),QG=X(qG.prototype,"values",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),WG=qG))||WG;function RH(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function IH(e,t,n,i,r,o){var a=new zz;a.path=(new Fz).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new hH(e,t,n)}:null}function PH(e,t,n){yi.set(n,RH(e,3*t+0),RH(e,3*t+1),RH(e,3*t+2))}function OH(e,t,n){Ai.set(n,RH(e,4*t+0),RH(e,4*t+1),RH(e,4*t+2),RH(e,4*t+3))}var DH=Symbol("SearchForRootBonePath"),MH=Symbol("ExoticAnimation"),NH=e("AnimationClip",sl("cc.AnimationClip")((AH=CH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"sample",mH,V(t)),q(t,"speed",vH,V(t)),q(t,"wrapMode",gH,V(t)),q(t,"enableTrsBlending",yH,V(t)),q(t,"_duration",SH,V(t)),q(t,"_hash",xH,V(t)),t.frameRate=0,q(t,"_tracks",TH,V(t)),q(t,"_exoticAnimation",EH,V(t)),t._legacyData=void 0,t._legacyDataDirty=!1,q(t,"_events",bH,V(t)),t._runtimeEvents={ratios:[],eventGroups:[]},t}F(t,e),t.createWithSpriteFrames=function(e,n){var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,o=new pU;return o.path=(new Fz).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(o),i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},n.getTrack=function(e){return this._tracks[e]},n.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},n.removeTrack=function(e){this._tracks.splice(e,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(e){return new HH(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}),e.rootMotion)},n.destroy=function(){var t;return(null===(t=i.director.root)||void 0===t?void 0:t.dataPoolManager)&&i.director.root.dataPoolManager.releaseAnimationClip(this),tG.destroy(this),e.prototype.destroy.call(this)},n[eG]=function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new Ni}))};var c=r.reduce((function(e,t){return e[t]=new FH,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var f=l.substring(0,h),_=c[f];_&&(u.parent=_)}}for(var p=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return GH(n,t.property)}}),void 0),d=0;d<n;++d){var m=e+i*d;p.evaluate(m);for(var v=0;v<o;++v){var g=r[v];Ni.copy(a[g].transforms[d],c[g].globalTransform)}for(var y=0;y<o;++y){var S=r[y];c[S].invalidate()}}return{samples:t,frames:n,joints:a}},n.upgradeUntypedTracks=function(e){for(var t=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof vG){var s=a.upgrade(e);s&&(t.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)Ge.remove(i,n[l]);i.push.apply(i,t)},n[DH]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var h=t(u[Bz]);if(h){var f=u[Mz](h);a.push({binding:h,trackEval:f})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(t)),new LH(a,o,i)},n._createRootMotionEvaluation=function(e,t,n){if(e instanceof eA){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var o=new BH,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[Bz].parseTrsPath();if(h&&h.node===i){n.push(u);var f=GH(o,h.property);if(f){var _=u[Mz](f);a.push({binding:f,trackEval:_})}}}return new UH(r,this._duration,o,a)}b(3924)}else b(3923)}else A(3920)},n._searchForRootBonePath=function(){var e=this._tracks.map((function(e){var t=e[Bz].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,o=t+1;o<n;++o){var a=e[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var e=new gG(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},n._fromLegacy=function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])},n._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][Bz].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)e.add(o[s]);return Array.from(e)},L(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:"+(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=Ma(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),o=r.length,a=function(e){var o=r[e],a=o.frame/t._duration,s=n.findIndex((function(e){return e===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:MH,get:function(){return this._exoticAnimation}},{key:MH,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),t}(zu),CH.WrapMode=qc,mH=X((dH=AH).prototype,"sample",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),vH=X(dH.prototype,"speed",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),gH=X(dH.prototype,"wrapMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qc.Normal}}),yH=X(dH.prototype,"enableTrsBlending",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),SH=X(dH.prototype,"_duration",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xH=X(dH.prototype,"_hash",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TH=X(dH.prototype,"_tracks",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EH=X(dH.prototype,"_exoticAnimation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bH=X(dH.prototype,"_events",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pH=dH))||pH);i.AnimationClip=NH;var LH=function(){function e(e,t,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=n}var t=e.prototype;return t.evaluate=function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var o=t[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)},t.evaluateRootMotion=function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)},e}(),BH=function(){function e(){this.position=new yi,this.scale=new yi(1,1,1),this.rotation=new Ai,this.eulerAngles=new yi}return e.prototype.getTransform=function(e){Ni.fromRTS(e,this.rotation,this.position,this.scale)},e}(),FH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).parent=null,t._dirty=!0,t._transform=new Ni,t}return F(t,e),t.prototype.invalidate=function(){this._dirty=!0},L(t,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,Ni.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&Ni.multiply(e,this.parent.globalTransform,e)),this._transform}}]),t}(BH),zH=new Ni,UH=function(){function e(e,t,n,i){this._initialTransformCache=new Ni,this._clipEndTransformCache=new Ni,this._startTransformCache=new Ni,this._endTransformCache=new Ni,this._motionTransformCache=new Ni,this._translationMotionCache=new yi,this._rotationMotionCache=new Ai,this._scaleMotionCache=new yi,this._rootBone=e,this._duration=t,this._boneTransform=n,this._trackEvalStatuses=i}var t=e.prototype;return t.evaluate=function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;Ni.toRTS(n,r,i,o),yi.add(i,i,a.position),a.setPosition(i),Ai.multiply(r,r,a.rotation),a.setRotation(r),yi.multiply(o,o,a.scale),a.setScale(o)},t._calcMotionTransform=function(e,t,n){var i=this._duration,r=i-e,o=this._evaluateAt(e,this._startTransformCache);if(t<r){var a=this._evaluateAt(e+t,this._endTransformCache);kH(n,o,a)}else{Ni.identity(n);var s=function(e,t){kH(zH,e,t),Ni.multiply(n,n,zH)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),f=this._evaluateAt(i,this._clipEndTransformCache),_=this._evaluateAt(u,this._endTransformCache);s(o,f),kH(zH,h,f);for(var p=0;p<l;++p)Ni.multiply(n,n,zH);s(h,_)}return n},t._evaluateAt=function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t},e}();function kH(e,t,n){Ni.invert(e,t),Ni.multiply(e,n,e)}function GH(e,t){switch(t){default:return;case"position":return{setValue:function(t){yi.copy(e.position,t)}};case"rotation":return{setValue:function(t){Ai.copy(e.rotation,t)}};case"scale":return{setValue:function(t){yi.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){yi.copy(e.eulerAngles,t)}}}}var HH=function(){function e(e,t,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=n,this._wrapMode=i}var t=e.prototype;return t.setWrapMode=function(e){this._wrapMode=e},t.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=jH(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)},t.sample=function(e,t,n){var i=this._eventGroups.length,r=jH(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var o=this._wrapMode,a=VH(n),s=VH(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((o&Wc.PingPong)===Wc.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((o&Wc.PingPong)===Wc.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t},t._doFire=function(e,t){t?i.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},t._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},e}();function VH(e){return e-(0|e)==0&&(e-=1),0|e}function jH(e,t){return Jc(t,e)}var WH,qH=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(P(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},L(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),XH=function(){function e(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},t.createPoseWriter=function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i},e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(WH||(WH={})),$e(WH);var YH=e("AnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=qc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new Zc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=0,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:t.duration},i._playbackDuration=t.duration,t.duration||v("Clip "+t.name+" has zero duration."),i}F(t,e);var n=t.prototype;return n.initialize=function(e,t){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&Wc.Loop)===Wc.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var r,o,a,s=null!==(r=null!=t?t:null===(o=i.director.getAnimationManager())||void 0===o?void 0:o.blendState)&&void 0!==r?r:null;s&&(this._poseOutput=new XH(s)),this._clipEval=n.createEvaluator({target:e,pose:null!==(a=this._poseOutput)&&void 0!==a?a:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||i.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];i.director.getAnimationManager().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(WH.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(WH.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(WH.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(WH.PAUSE,this)},n._sampleCurves=function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new Zc(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(WH.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(WH.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(WH.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&Wc.PingPong)===Wc.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&Wc.Reverse)===Wc.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new Zc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(e-=n)>0?e/i:-e/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&Wc.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=a,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._onReplayOrResume=function(){i.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){i.director.getAnimationManager().removeAnimation(this)},L(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&Wc.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&Wc.ShouldWrap,n=(this.wrapMode&Wc.Reverse)===Wc.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(qH));i.AnimationState=YH;var KH,QH,ZH,JH,$H,eV=nV,tV=nV;function nV(){}KH=sl("cc.animation.ClipMotion"),QH=Hl(NH),KH(($H=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"clip",JH,V(t)),t}F(t,e);var n=t.prototype;return n[UU]=function(e){return this.clip?new TV(e,this.clip):null},n.clone=function(){var e=new t;return e.clip=this.clip,e},t}(tu),JH=X((ZH=$H).prototype,"clip",[QH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZH));var iV,rV,oV,aV,sV,cV,lV,uV,hV,fV,_V,pV,dV,mV,vV,gV,yV,SV,xV,TV=function(){function e(e,t){this.duration=t.duration,this._state=new YH(t),this._state.initialize(e.node,e.blendBuffer)}var t=e.prototype;return t.getClipStatuses=function(e){var t=this,n=!1;return{next:function(){return n?{done:!0,value:void 0}:(n=!0,{done:!1,value:{__DEBUG_ID__:t.__DEBUG__ID__,clip:t._state.clip,weight:e}})}}},t.sample=function(e,t){if(0!==t){this._state.name;var n=this._state.duration*e;this._state.time=n,this._state.weight=t,this._state.sample(),this._state.weight=0}},L(e,[{key:"progress",get:function(){return this._state.time/this.duration}}]),e}(),EV=sl("cc.animation.AnimationBlendItem")((aV=function(){function e(){q(this,"motion",oV,this)}var t=e.prototype;return t.clone=function(){var t=new e;return this._assign(t),t},t._assign=function(e){var t,n;return e.motion=null!==(t=null===(n=this.motion)||void 0===n?void 0:n.clone())&&void 0!==t?t:null,e},e}(),oV=X((rV=aV).prototype,"motion",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iV=rV))||iV,bV=sl("cc.animation.AnimationBlend")((uV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"name",lV,V(t)),t}return F(t,e),t}(tu),lV=X((cV=uV).prototype,"name",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sV=cV))||sV,CV=function(){function e(e,t,n){this._childEvaluators=t.map((function(t){var n,i;return null!==(n=null===(i=t.motion)||void 0===i?void 0:i[UU](e))&&void 0!==n?n:null})),this._weights=new Array(this._childEvaluators.length).fill(0),this._inputs=[].concat(n)}var t=e.prototype;return t.getClipStatuses=function(e){var t,n=this._childEvaluators,i=this._weights,r=n.length,o=0;return{next:function(){for(;;){if(t){var a=t.next();if(!a.done)return a}if(o>=r)return{done:!0,value:void 0};var s=n[o];t=null==s?void 0:s.getClipStatuses(e*i[o]),++o}}}},t.sample=function(e,t){for(var n=0;n<this._childEvaluators.length;++n){var i;null===(i=this._childEvaluators[n])||void 0===i||i.sample(e,t*this._weights[n])}},t.setInput=function(e,t){this._inputs[t]=e,this.doEval()},t.doEval=function(){this.eval(this._weights,this._inputs)},t.eval=function(){},L(e,[{key:"duration",get:function(){for(var e=0,t=0;t<this._childEvaluators.length;++t){var n,i;e+=(null!==(n=null===(i=this._childEvaluators[t])||void 0===i?void 0:i.duration)&&void 0!==n?n:0)*this._weights[t]}return e}}]),e}(),AV=sl("cc.animation.AnimationBlend1DItem")((pV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"threshold",_V,V(t)),t}F(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return this._assign(e),e},n._assign=function(t){return e.prototype._assign.call(this,t),t.threshold=this.threshold,t},t}(EV),_V=X((fV=pV).prototype,"threshold",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hV=fV))||hV,wV=(sl("cc.animation.AnimationBlend1D")((yV=gV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_items",mV,V(t)),q(t,"param",vV,V(t)),t}F(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._items=this._items.map((function(e){return e.clone()})),e.param=this.param.clone(),e},n[UU]=function(e){var t=new wV(e,this._items,this._items.map((function(e){return e.threshold})),0),n=ZU(e,this.param,LU.FLOAT,t.setInput,t,0);return t.setInput(n,0),t},L(t,[{key:"items",get:function(){return this._items},set:function(e){this._items=Array.from(e).sort((function(e,t){return e.threshold-t.threshold}))}}]),t}(bV),gV.Item=AV,mV=X((dV=yV).prototype,"_items",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vV=X(dV.prototype,"param",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KU}}),dV)),function(e){function t(t,n,i,r){var o;return(o=e.call(this,t,n,[r])||this)._thresholds=i,o.doEval(),o}return F(t,e),t.prototype.eval=function(e,t){var n=t[0];!function(e,t,n){if(e.fill(0),0===t.length);else if(n<=t[0])e[0]=1;else if(n>=t[t.length-1])e[e.length-1]=1;else{for(var i=0,r=1;r<t.length;++r)if(t[r]>n){i=r;break}var o=t[i-1],a=t[i],s=a-o;e[i-1]=(a-n)/s,e[i]=(n-o)/s}}(e,this._thresholds,n)},t}(CV)),RV=(SV=new zi,xV={wA:0,wB:0},function(e,t,n){if(e.length,t.length,0!==t.length)if(1!==t.length)if(zi.strictEquals(n,zi.ZERO)){var i=t.findIndex((function(e){return zi.strictEquals(e,zi.ZERO)}));i>=0?e[i]=1:e.fill(1/t.length)}else{for(var r=-1,o=-1,a=-1,s=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=n.x,u=n.y,h=0;h<t.length;++h){var f=t[h];if(zi.equals(f,zi.ZERO))a=h;else{var _=zi.normalize(SV,f),p=zi.dot(_,n);_.x*u-_.y*l>0?p>=c&&(c=p,r=h):p>=s&&(s=p,o=h)}}var d=0;if(r<0||o<0)d=1;else{var m=(b=t[r],C=t[o],A=n,w=xV,(R=zi.cross(b,C))?(w.wA=zi.cross(A,C)/R,w.wB=zi.cross(A,b)/-R):(w.wA=0,w.wB=0),w),v=m.wA,g=m.wB,y=0,S=0,x=v+g;x>1?(y=v/x,S=g/x):x<0?(y=0,S=0,d=1):(y=v,S=g,d=1-x),e[r]=y,e[o]=S}if(d>0)if(a>=0)e[a]=d;else for(var T=d/e.length,E=0;E<e.length;++E)e[E]+=T}else e[0]=1;var b,C,A,w,R});function IV(e,t,n,i){e.fill(0);for(var r=new zi(0,0),o=new zi(0,0),a=0,s=t.length,c=0;c<s;++c){for(var l=Number.MAX_VALUE,u=!1,h=0;h<s;++h)if(c!==h){i(t[c],t[h],n,r,o);var f=1-zi.dot(r,o)/zi.lengthSqr(o);if(f<0){u=!0;break}l=Math.min(l,f)}u||(e[c]=l,a+=l)}a>0&&e.forEach((function(t,n){return e[n]=t/a}))}var PV,OV,DV,MV,NV,LV,BV,FV,zV,UV,kV,GV,HV,VV,jV,WV,qV,XV,YV=function(e,t,n,i,r){zi.subtract(i,n,e),zi.subtract(r,t,e)},KV=(PV=new yi(0,0,0),OV=new yi(0,0,0),DV=new yi(0,0,0),MV=new yi(0,0,0),NV=new yi(0,0,0),LV=new yi(0,0,0),function(e,t,n,i,r){var o=0,a=0,s=2;yi.set(DV,n.x,n.y,0),zi.equals(e,zi.ZERO)?(o=zi.angle(n,t),a=0,s=1):zi.equals(t,zi.ZERO)?(a=o=zi.angle(n,e),s=1):(o=zi.angle(e,t))<=0?a=0:zi.equals(n,zi.ZERO)?a=o:(yi.set(MV,e.x,e.y,0),yi.set(NV,t.x,t.y,0),yi.set(LV,n.x,n.y,0),yi.cross(PV,MV,NV),yi.projectOnPlane(DV,LV,PV),a=yi.angle(MV,DV),o<.99*Math.PI&&yi.dot(yi.cross(OV,MV,DV),PV)<0&&(a=-a));var c=zi.len(e),l=zi.len(t),u=(l+c)/2;zi.set(r,(l-c)/u,o*s),zi.set(i,(yi.len(DV)-c)/u,a*s)});!function(e){e[e.SIMPLE_DIRECTIONAL=0]="SIMPLE_DIRECTIONAL",e[e.FREEFORM_CARTESIAN=1]="FREEFORM_CARTESIAN",e[e.FREEFORM_DIRECTIONAL=2]="FREEFORM_DIRECTIONAL"}(XV||(XV={})),$e(XV);var QV,ZV,JV,$V,ej,tj,nj,ij,rj,oj,aj,sj,cj,lj,uj,hj,fj,_j,pj,dj,mj,vj,gj,yj,Sj=sl("cc.animation.AnimationBlend2DItem")((UV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"threshold",zV,V(t)),t}F(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return this._assign(e),e},n._assign=function(t){return e.prototype._assign.call(this,t),zi.copy(t.threshold,this.threshold),t},t}(EV),zV=X((FV=UV).prototype,"threshold",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi}}),BV=FV))||BV,xj=(sl("cc.animation.AnimationBlend2D")((qV=WV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"algorithm",GV,V(t)),q(t,"_items",HV,V(t)),q(t,"paramX",VV,V(t)),q(t,"paramY",jV,V(t)),t}F(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._items=this._items.map((function(e){var t;return null!==(t=null==e?void 0:e.clone())&&void 0!==t?t:null})),e.paramX=this.paramX.clone(),e.paramY=this.paramY.clone(),e},n[UU]=function(e){var t=new xj(e,this._items,this._items.map((function(e){return e.threshold})),this.algorithm,[0,0]),n=ZU(e,this.paramX,LU.FLOAT,t.setInput,t,0),i=ZU(e,this.paramY,LU.FLOAT,t.setInput,t,1);return t.setInput(n,0),t.setInput(i,1),t},L(t,[{key:"items",get:function(){return this._items},set:function(e){this._items=Array.from(e)}}]),t}(bV),WV.Algorithm=XV,WV.Item=Sj,GV=X((kV=qV).prototype,"algorithm",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XV.SIMPLE_DIRECTIONAL}}),HV=X(kV.prototype,"_items",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VV=X(kV.prototype,"paramX",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KU}}),jV=X(kV.prototype,"paramY",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KU}}),kV)),function(e){function t(t,n,i,r,o){var a;return(a=e.call(this,t,n,o)||this)._thresholds=void 0,a._algorithm=void 0,a._value=new zi,a._thresholds=i,a._algorithm=r,a.doEval(),a}return F(t,e),t.prototype.eval=function(e,t){var n=t[0],i=t[1];switch(zi.set(this._value,n,i),e.fill(0),this._algorithm){case XV.SIMPLE_DIRECTIONAL:RV(e,this._thresholds,this._value);break;case XV.FREEFORM_CARTESIAN:!function(e,t,n){IV(e,t,n,YV)}(e,this._thresholds,this._value);break;case XV.FREEFORM_DIRECTIONAL:!function(e,t,n){IV(e,t,n,KV)}(e,this._thresholds,this._value)}},t}(CV)),Tj=sl("cc.animation.AnimationBlendDirectItem")(($V=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"weight",JV,V(t)),t}F(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return this._assign(e),e},n._assign=function(t){return e.prototype._assign.call(this,t),t.weight=this.weight,t},t}(EV),JV=X((ZV=$V).prototype,"weight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QV=ZV))||QV,Ej=(sl("cc.animation.AnimationBlendDirect")((ij=nj=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_items",tj,V(t)),t}F(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._items=this._items.map((function(e){var t;return null!==(t=null==e?void 0:e.clone())&&void 0!==t?t:null})),e},n[UU]=function(e){return new Ej(e,this._items,this._items.map((function(e){return e.weight})))},L(t,[{key:"items",get:function(){return this._items},set:function(e){this._items=Array.from(e)}}]),t}(bV),nj.Item=Tj,tj=X((ej=ij).prototype,"_items",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ej)),function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).doEval(),t}return F(t,e),t.prototype.eval=function(e,t){for(var n=e.length,i=0;i<n;++i)e[i]=t[i]},t}(CV));!function(e){e[e.EQUAL_TO=0]="EQUAL_TO",e[e.NOT_EQUAL_TO=1]="NOT_EQUAL_TO",e[e.LESS_THAN=2]="LESS_THAN",e[e.LESS_THAN_OR_EQUAL_TO=3]="LESS_THAN_OR_EQUAL_TO",e[e.GREATER_THAN=4]="GREATER_THAN",e[e.GREATER_THAN_OR_EQUAL_TO=5]="GREATER_THAN_OR_EQUAL_TO"}(yj||(yj={})),sl("cc.animation.BinaryCondition")((lj=cj=function(){function e(){q(this,"operator",oj,this),q(this,"lhs",aj,this),q(this,"rhs",sj,this)}var t=e.prototype;return t.clone=function(){var t=new e;return t.operator=this.operator,t.lhs=this.lhs.clone(),t.rhs=this.rhs.clone(),t},t[UU]=function(e){var t=this.operator,n=this.lhs,i=this.rhs,r=new Cj(t,0,0),o=JU(e,n,LU.FLOAT,r.setLhs,r),a=JU(e,i,LU.FLOAT,r.setRhs,r);return r.reset(o,a),r},e}(),cj.Operator=yj,oj=X((rj=lj).prototype,"operator",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yj.EQUAL_TO}}),aj=X(rj.prototype,"lhs",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KU}}),sj=X(rj.prototype,"rhs",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new KU}}),rj));var bj,Cj=function(){function e(e,t,n){this._operator=e,this._lhs=t,this._rhs=n,this._eval()}var t=e.prototype;return t.reset=function(e,t){this._lhs=e,this._rhs=t,this._eval()},t.setLhs=function(e){this._lhs=e,this._eval()},t.setRhs=function(e){this._rhs=e,this._eval()},t.eval=function(){return this._result},t._eval=function(){var e=this._lhs,t=this._rhs;switch(this._operator){default:case yj.EQUAL_TO:this._result=e===t;break;case yj.NOT_EQUAL_TO:this._result=e!==t;break;case yj.LESS_THAN:this._result=e<t;break;case yj.LESS_THAN_OR_EQUAL_TO:this._result=e<=t;break;case yj.GREATER_THAN:this._result=e>t;break;case yj.GREATER_THAN_OR_EQUAL_TO:this._result=e>=t}},e}();!function(e){e[e.TRUTHY=0]="TRUTHY",e[e.FALSY=1]="FALSY"}(bj||(bj={})),sl("cc.animation.UnaryCondition")((pj=_j=function(){function e(){q(this,"operator",hj,this),q(this,"operand",fj,this)}var t=e.prototype;return t.clone=function(){var t=new e;return t.operator=this.operator,t.operand=this.operand.clone(),t},t[UU]=function(e){var t=this.operator,n=this.operand,i=new Ij(t,!1),r=ZU(e,n,LU.BOOLEAN,i.setOperand,i);return i.reset(r),i},e}(),_j.Operator=bj,hj=X((uj=pj).prototype,"operator",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bj.TRUTHY}}),fj=X(uj.prototype,"operand",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QU}}),uj));var Aj,wj,Rj,Ij=function(){function e(e,t){this._operator=e,this._operand=t,this._eval()}var t=e.prototype;return t.reset=function(e){this.setOperand(e)},t.setOperand=function(e){this._operand=e,this._eval()},t.eval=function(){return this._result},t._eval=function(){var e=this._operand;switch(this._operator){default:case bj.TRUTHY:this._result=!!e;break;case bj.FALSY:this._result=!e}},e}(),Pj=sl("cc.animation.TriggerCondition")((gj=function(){function e(){q(this,"trigger",vj,this)}var t=e.prototype;return t.clone=function(){var t=new e;return t.trigger=this.trigger,t},t[UU]=function(e){var t=new Oj(!1),n=e.getVar(this.trigger);return $U(n,this.trigger)&&(function(e,t,n){if(e!==t)throw new zU(n,"number")}(n.type,LU.TRIGGER,this.trigger),t.setTrigger(n.bind(t.setTrigger,t))),t},e}(),vj=X((mj=gj).prototype,"trigger",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dj=mj))||dj,Oj=function(){function e(e){this._triggered=!1,this._triggered=e}var t=e.prototype;return t.setTrigger=function(e){this._triggered=e},t.eval=function(){return this._triggered},e}(),Dj=function(){function e(){this._nodeBlendStates=new Map}var t=e.prototype;return t.createWriter=function(e,t,n,i){var r=this.ref(e,t);return new Mj(e,t,r,n,i)},t.destroyWriter=function(e){var t=e;this.deRef(t.node,t.property)},t.ref=function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=new Fj,this._nodeBlendStates.set(e,n)),n.refProperty(t)},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))},e}(),Mj=function(){function e(e,t,n,i,r){this._node=e,this._property=t,this._propertyBlendState=n,this._host=i,this._constants=r}var t=e.prototype;return t.getValue=function(){return this._node[this._property]},t.setValue=function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)},L(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),e}(),Nj=function(e){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=e},Lj=function(e){function t(){return e.call(this,new yi)||this}F(t,e);var n=t.prototype;return n.blend=function(e,t){var n=this.blendedValue;1===t?yi.copy(n,e):yi.scaleAndAdd(n,n,e,t),this.blendedWeight+=t},n.reset=function(){this.blendedWeight=0,yi.zero(this.blendedValue)},t}(Nj),Bj=function(e){function t(){return e.call(this,new Ai)||this}F(t,e);var n=t.prototype;return n.blend=function(e,t){if(0!==t){var n=this.blendedValue,i=this.blendedWeight;if(1===t)Ai.copy(n,e);else{var r=t/(i+t);Ai.slerp(n,n,e,r)}this.blendedWeight+=t}},n.reset=function(){this.blendedWeight=0,Ai.identity(this.blendedValue)},t}(Nj),Fj=function(){function e(){this._properties={}}var t=e.prototype;return t.refProperty=function(e){var t,n,i,r=this._properties;switch(e){default:case"position":case"scale":case"eulerAngles":i=null!==(t=r[e])&&void 0!==t?t:r[e]=new Lj;break;case"rotation":i=null!==(n=r[e])&&void 0!==n?n:r[e]=new Bj}return++i.refCount,i},t.deRefProperty=function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])},t.apply=function(e){var t,n,i,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,f=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(e.position,1-o.blendedWeight),t=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(e.scale,1-a.blendedWeight),n=a.blendedValue),c&&c.blendedWeight&&(f=!0,c.blendedWeight<1&&c.blend(e.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(e.rotation,1-s.blendedWeight),i=s.blendedValue),(i||t||n)&&e.setRTS(i,t,n),l&&o.reset(),u&&a.reset(),h&&s.reset(),f&&c.reset()},L(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),e}(),zj=sl("cc.animation.StateMachineComponent")(Aj=function(){function e(){}var t=e.prototype;return t.onMotionStateEnter=function(){},t.onMotionStateExit=function(){},t.onMotionStateUpdate=function(){},t.onStateMachineEnter=function(){},t.onStateMachineExit=function(){},e}())||Aj,Uj=function(){function e(e,t,n){var i=this;this._blendBuffer=new Dj,this._currentTransitionCache={duration:0,time:0},this._varInstances={};for(var r,o=W(e.variables);!(r=o()).done;){var a=r.value,s=a[0],c=a[1],l=c.type,u=c.value;this._varInstances[s]=new aW(l,u)}var h={controller:n,blendBuffer:this._blendBuffer,node:t,getVar:function(e){return i._varInstances[e]},triggerResetFn:function(e){i.setValue(e,!1)}};this._layerEvaluations=Array.from(e.layers).map((function(e){var t;return new kj(e,B({},h,{mask:null!==(t=e.mask)&&void 0!==t?t:void 0}))}))}var t=e.prototype;return t.update=function(e){for(var t,n=W(this._layerEvaluations);!(t=n()).done;)t.value.update(e);this._blendBuffer.apply()},t.getVariables=function(){return Object.entries(this._varInstances)},t.getCurrentStateStatus=function(e){return this._layerEvaluations[e].getCurrentStateStatus()},t.getCurrentClipStatuses=function(e){return this._layerEvaluations[e].getCurrentClipStatuses()},t.getCurrentTransition=function(e){var t=this._layerEvaluations,n=this._currentTransitionCache;return t[e].getCurrentTransition(n)?n:null},t.getNextStateStatus=function(e){return this._layerEvaluations[e].getNextStateStatus()},t.getNextClipStatuses=function(e){return this.getCurrentTransition(e),this._layerEvaluations[e].getNextClipStatuses()},t.getValue=function(e){var t=this._varInstances[e];return t?t.value:void 0},t.setValue=function(e,t){var n=this._varInstances[e];n&&(n.value=t)},e}(),kj=function(){function e(e,t){this._weight=void 0,this._nodes=[],this._topLevelEntry=void 0,this._topLevelExit=void 0,this._currentNode=void 0,this._currentTransitionToNode=null,this._currentTransitionPath=[],this._transitionProgress=0,this._fromWeight=0,this._toWeight=0,this._fromUpdated=!1,this._toUpdated=!1,this.name=e.name,this._controller=t.controller,this._weight=e.weight;var n=this._addStateMachine(e.stateMachine,null,B({},t),e.name),i=n.entry,r=n.exit;this._topLevelEntry=i,this._topLevelExit=r,this._currentNode=i,this._resetTrigger=t.triggerResetFn}var t=e.prototype;return t.update=function(e){this.exited||(this._fromWeight=1,this._toWeight=0,this._eval(e),this._sample())},t.getCurrentStateStatus=function(){var e=this._currentNode;return e.kind===Rj.animation?e.getFromPortStatus():null},t.getCurrentClipStatuses=function(){var e=this._currentNode;return e.kind===Rj.animation?e.getClipStatuses(this._fromWeight):Hj},t.getCurrentTransition=function(e){var t=this._currentTransitionPath;if(0!==t.length){if(t[t.length-1].to.kind!==Rj.animation)return!1;var n=t[0],i=n.duration,r=n.normalizedDuration,o=e.duration=r?i*(this._currentNode.kind===Rj.animation?this._currentNode.duration:0):i;return e.time=this._transitionProgress*o,!0}return!1},t.getNextStateStatus=function(){return this._currentTransitionToNode,this._currentTransitionToNode.getToPortStatus()},t.getNextClipStatuses=function(){var e,t=this._currentTransitionPath,n=t[t.length-1].to;return n.kind,Rj.animation,null!==(e=n.getClipStatuses(this._toWeight))&&void 0!==e?e:Hj},t._addStateMachine=function(e,t,n,i){for(var r,o,a,s=this,c=Array.from(e.states()),l=c.map((function(t){return t instanceof Vk?new Kj(t,n):t===e.entryState?r=new oW(t,Rj.entry,t.name):t===e.exitState?a=new oW(t,Rj.exit,t.name):t===e.anyState?o=new oW(t,Rj.any,t.name):null})),u={components:null,parent:t,entry:r,exit:a,any:o},h=0;h<c.length;++h){var f=l[h];f&&(f.stateMachine=u)}for(var _=c.map((function(e){if(e instanceof Qk){var t=s._addStateMachine(e.stateMachine,u,n,i+"/"+e.name);return t.components=new Yj(e),t}return null})),p=0;p<c.length;++p){var d=c[p],m=e.getOutgoings(d),v=[],g=void 0;g=d instanceof Qk?_[p].exit:l[p];for(var y,S=function(){var e=y.value,t=e.to,i=c.findIndex((function(t){return t===e.to})),r={to:t instanceof Qk?_[i].entry:l[i],conditions:e.conditions.map((function(e){return e[UU](n)})),duration:Xk(e)?e.duration:0,normalizedDuration:!!Xk(e)&&e.relativeDuration,exitConditionEnabled:!!Xk(e)&&e.exitConditionEnabled,exitCondition:Xk(e)?e.exitCondition:0,triggers:void 0};r.conditions.forEach((function(t,n){var i,o=e.conditions[n];o instanceof Pj&&o.trigger&&(null!==(i=r.triggers)&&void 0!==i?i:r.triggers=[]).push(o.trigger)})),v.push(r)},x=W(m);!(y=x()).done;)S();g.outgoingTransitions=v}return u},t._eval=function(e){if(this.exited,tV("[Layer "+this.name+"]: UpdateStart "+e+"s"),this._continueDanglingTransition())return 0;for(var t=e,n=!0,i=0;n||t>0;){if(n=!1,100===i){b(14e3,100);break}if(++i,this._currentTransitionPath.length>0){if(t-=this._updateCurrentTransition(t),this._currentNode.kind===Rj.exit)break;0===this._currentTransitionPath.length&&(n=!0)}else{var r=this._currentNode,o=this._matchCurrentNodeTransition(t);if(o){var a=o.transition,s=o.requires;if(eV("[SubStateMachine "+this.name+"]: CurrentNodeUpdate: "+r.name),t-=s,r.kind===Rj.animation&&(r.updateFromPort(s),this._fromUpdated=!0),this._switchTo(a))break;n=!0}else eV("[SubStateMachine "+this.name+"]: CurrentNodeUpdate: "+r.name),r.kind===Rj.animation&&(r.updateFromPort(t),this._fromUpdated=!0,t=0)}}return eV("[SubStateMachine "+this.name+"]: UpdateEnd"),this._fromUpdated&&this._currentNode.kind===Rj.animation&&(this._fromUpdated=!1,this._currentNode.triggerFromPortUpdate(this._controller)),this._currentTransitionToNode&&this._toUpdated&&this._currentNode.kind===Rj.animation&&(this._toUpdated=!1,this._currentTransitionToNode.triggerToPortUpdate(this._controller)),t},t._sample=function(){var e=this._currentNode,t=this._currentTransitionToNode,n=this._fromWeight;e.kind===Rj.animation&&e.sampleFromPort(n),t&&t.kind===Rj.animation&&t.sampleToPort(this._toWeight)},t._matchCurrentNodeTransition=function(e){var t=this._currentNode,n=1/0,i=null,r=this._matchTransition(t,t,e,Wj);if(r&&(n=r.requires,i=r.transition),t.kind===Rj.animation)for(var o=t.stateMachine;null!==o;o=o.parent){var a=this._matchTransition(o.any,t,e,qj);a&&a.requires<n&&(n=a.requires,i=a.transition)}return i?jj.set(i,n):null},t._matchTransition=function(e,t,n,i){e===t||(e.kind,Rj.any);for(var r=e.outgoingTransitions,o=r.length,a=1/0,s=null,c=0;c<o;++c){var l=r[c],u=l.conditions,h=u.length;if(0===h){if(e.kind===Rj.entry||e.kind===Rj.exit)return i.set(l,0);if(!l.exitConditionEnabled)continue}var f=0;if(t.kind===Rj.animation&&l.exitConditionEnabled){var _=t.duration*l.exitCondition;if((f=Math.max(_-t.fromPortTime,0))>n)continue}for(var p=!0,d=0;d<h;++d)if(!u[d].eval()){p=!1;break}if(p){if(0===f)return i.set(l,0);f<a&&(a=f,s=l)}}return s?i.set(s,a):null},t._switchTo=function(e){var t=this._currentNode;tV("[SubStateMachine "+this.name+"]: STARTED "+t.name+" -> "+e.to.name+".");var n=this._currentTransitionPath;this._consumeTransition(e),n.push(e);var i=this._matchTransitionPathUntilMotion();return!i||(this._doTransitionToMotion(i),!1)},t._continueDanglingTransition=function(){var e=this._currentTransitionPath,t=e.length;if(0===t)return!1;if(e[t-1].to.kind!==Rj.animation){var n=this._matchTransitionPathUntilMotion();return!n||(this._doTransitionToMotion(n),!1)}return!1},t._matchTransitionPathUntilMotion=function(){for(var e=this._currentTransitionPath,t=e[e.length-1].to;t.kind!==Rj.animation;){var n=this._matchTransition(t,t,0,jj);if(!n)break;var i=n.transition;this._consumeTransition(i),e.push(i),t=i.to}return t.kind===Rj.animation?t:null},t._consumeTransition=function(e){var t=e.to;t.kind===Rj.entry&&this._callEnterMethods(t)},t._resetTriggersAlongThePath=function(){for(var e=this._currentTransitionPath,t=e.length,n=0;n<t;++n){var i=e[n];this._resetTriggersOnTransition(i)}},t._doTransitionToMotion=function(e){this._resetTriggersAlongThePath(),this._transitionProgress=0,this._currentTransitionToNode=e,this._toUpdated=!1,e.resetToPort(),this._callEnterMethods(e)},t._updateCurrentTransition=function(e){var t,n=this._currentTransitionPath,i=this._currentTransitionToNode;n.length;var r=n[0],o=r.duration,a=r.normalizedDuration,s=this._currentNode,c=i,l=0,u=0;if(o<=0)l=0,u=1;else{s.kind,Rj.animation;var h=this._transitionProgress,f=a?o*s.duration:o,_=h*f,p=f-_;l=Math.min(p,e),u=this._transitionProgress=(_+l)/f}var d=null!==(t=null==c?void 0:c.name)&&void 0!==t?t:"<Empty>",m=this._weight;tV("[SubStateMachine "+this.name+"]: TransitionUpdate: "+s.name+" -> "+d+"with ratio "+u+" in base weight "+this._weight+"."),this._fromWeight=m*(1-u),this._toWeight=m*u;var v=0!==l,g=1===u;if(s.kind===Rj.animation&&v&&(tV("Update "+s.name),s.updateFromPort(l),this._fromUpdated=!0),c&&v&&(tV("Update "+c.name),c.updateToPort(l),this._toUpdated=!0),g){eV("[SubStateMachine "+this.name+"]: Transition finished:  "+s.name+" -> "+d+"."),this._callExitMethods(s);for(var y=this._currentTransitionPath,S=y.length,x=0;x<S;++x){var T=y[x].to;T.kind===Rj.exit&&this._callExitMethods(T)}this._fromUpdated=this._toUpdated,this._toUpdated=!1,c.finishTransition(),this._currentNode=c,this._currentTransitionToNode=null,this._currentTransitionPath.length=0,this._fromWeight=1,this._toWeight=0}return l},t._resetTriggersOnTransition=function(e){var t=e.triggers;if(t)for(var n=t.length,i=0;i<n;++i){var r=t[i];this._resetTrigger(r)}},t._resetTrigger=function(e){(0,this._triggerReset)(e)},t._callEnterMethods=function(e){var t,n=this._controller;switch(e.kind){default:break;case Rj.animation:e.components.callMotionStateEnterMethods(n,e.getToPortStatus());break;case Rj.entry:null===(t=e.stateMachine.components)||void 0===t||t.callStateMachineEnterMethods(n)}},t._callExitMethods=function(e){var t,n=this._controller;switch(e.kind){default:break;case Rj.animation:e.components.callMotionStateExitMethods(n,e.getFromPortStatus());break;case Rj.exit:null===(t=e.stateMachine.components)||void 0===t||t.callStateMachineExitMethods(n)}},L(e,[{key:"exited",get:function(){return this._currentNode===this._topLevelExit}}]),e}(),Gj=Object.freeze({next:function(){return{done:!0,value:void 0}}}),Hj=Object.freeze(((wj={})[Symbol.iterator]=function(){return Gj},wj)),Vj=function(){function e(){this.transition=null,this.requires=0}return e.prototype.set=function(e,t){return this.transition=e,this.requires=t,this},e}(),jj=new Vj,Wj=new Vj,qj=new Vj;!function(e){e[e.entry=0]="entry",e[e.exit=1]="exit",e[e.any=2]="any",e[e.animation=3]="animation"}(Rj||(Rj={}));var Xj=function(e){this.name=void 0,this.outgoingTransitions=[],this.name=e.name},Yj=function(){function e(e){this._components=e.instantiateComponents()}var t=e.prototype;return t.callMotionStateEnterMethods=function(e,t){this._callMotionStateCallbackIfNonDefault("onMotionStateEnter",e,t)},t.callMotionStateUpdateMethods=function(e,t){this._callMotionStateCallbackIfNonDefault("onMotionStateUpdate",e,t)},t.callMotionStateExitMethods=function(e,t){this._callMotionStateCallbackIfNonDefault("onMotionStateExit",e,t)},t.callStateMachineEnterMethods=function(e){this._callStateMachineCallbackIfNonDefault("onStateMachineEnter",e)},t.callStateMachineExitMethods=function(e){this._callStateMachineCallbackIfNonDefault("onStateMachineExit",e)},t._callMotionStateCallbackIfNonDefault=function(e,t,n){for(var i=this._components,r=i.length,o=0;o<r;++o){var a=i[o];a[e]!==zj.prototype[e]&&a[e](t,n)}},t._callStateMachineCallbackIfNonDefault=function(e,t){for(var n=this._components,i=n.length,r=0;r<i;++r){var o=n[r];o[e]!==zj.prototype[e]&&o[e](t)}},e}(),Kj=function(e){function t(t,n){var i,r,o;(o=e.call(this,t)||this).kind=Rj.animation,o._source=null,o._speed=1,o._fromPort={progress:0,statusCache:{progress:0}},o._toPort={progress:0,statusCache:{progress:0}};var a=ZU(n,t.speed,LU.FLOAT,o._setSpeed,V(o));o._speed=a;var s=B({},n),c=null!==(i=null===(r=t.motion)||void 0===r?void 0:r[UU](s))&&void 0!==i?i:null;return c&&Object.defineProperty(c,"__DEBUG_ID__",{value:o.name}),o._source=c,o.components=new Yj(t),o}F(t,e);var n=t.prototype;return n.updateFromPort=function(e){this._fromPort.progress=Qj(this._fromPort.progress,this.duration,e*this._speed)},n.updateToPort=function(e){this._toPort.progress=Qj(this._toPort.progress,this.duration,e*this._speed)},n.triggerFromPortUpdate=function(e){this.components.callMotionStateUpdateMethods(e,this.getFromPortStatus())},n.triggerToPortUpdate=function(e){this.components.callMotionStateUpdateMethods(e,this.getToPortStatus())},n.getFromPortStatus=function(){var e=this._fromPort.statusCache;return e.progress=Zj(this._fromPort.progress),e},n.getToPortStatus=function(){var e=this._toPort.statusCache;return e.progress=Zj(this._toPort.progress),e},n.resetToPort=function(){this._toPort.progress=0},n.finishTransition=function(){this._fromPort.progress=this._toPort.progress},n.sampleFromPort=function(e){var t;null===(t=this._source)||void 0===t||t.sample(this._fromPort.progress,e)},n.sampleToPort=function(e){var t;null===(t=this._source)||void 0===t||t.sample(this._toPort.progress,e)},n.getClipStatuses=function(e){var t,n=this._source;return n?((t={})[Symbol.iterator]=function(){return n.getClipStatuses(e)},t):Hj},n._setSpeed=function(e){this._speed=e},L(t,[{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._source)||void 0===t?void 0:t.duration)&&void 0!==e?e:0}},{key:"fromPortTime",get:function(){return this._fromPort.progress*this.duration}}]),t}(Xj);function Qj(e,t,n){return 0===t?0:e+n/t}function Zj(e){return e-Math.trunc(e)}var Jj,$j,eW,tW,nW,iW,rW,oW=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).kind=void 0,i.kind=n,i}return F(t,e),t}(Xj),aW=function(){function e(e,t){this.type=void 0,this._value=void 0,this._refs=[],this.type=e,this._value=t}return e.prototype.bind=function(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this._refs.push({fn:e,thisArg:t,args:i}),this._value},L(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e;for(var t,n=W(this._refs);!(t=n()).done;){var i=t.value,r=i.fn,o=i.thisArg,a=i.args;r.call.apply(r,[o,e].concat(a))}}}]),e}(),sW=(Jj=sl("cc.animation.AnimationController"),$j=yl(),eW=hl($k),Jj(tW=$j((rW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"graph",iW,V(t)),t._graphEval=null,t}F(t,e);var n=t.prototype;return n.start=function(){this.graph&&(this._graphEval=new Uj(this.graph,this.node,this))},n.update=function(e){var t;null===(t=this._graphEval)||void 0===t||t.update(e)},n.getVariables=function(){return this._graphEval.getVariables()},n.setValue=function(e,t){this._graphEval.setValue(e,t)},n.getValue=function(e){return this._graphEval.getValue(e)},n.getCurrentStateStatus=function(e){return this._graphEval.getCurrentStateStatus(e)},n.getCurrentClipStatuses=function(e){return this._graphEval.getCurrentClipStatuses(e)},n.getCurrentTransition=function(e){return this._graphEval.getCurrentTransition(e)},n.getNextStateStatus=function(e){return this._graphEval.getNextStateStatus(e)},n.getNextClipStatuses=function(e){return this._graphEval.getNextClipStatuses(e)},t}(oh),iW=X((nW=rW).prototype,"graph",[eW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tW=nW))||tW)||tW);e("animation",Object.freeze({__proto__:null,UniformProxyFactory:QF,MorphWeightValueProxy:ZF,MorphWeightsValueProxy:JF,MorphWeightsAllValueProxy:$F,Track:Uz,TrackPath:Fz,RealTrack:Vz,VectorTrack:nU,QuatTrack:aU,ColorTrack:lU,SizeTrack:fU,ObjectTrack:pU,isPropertyPath:CF,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:YF,ComponentPath:KF,CubicSplineVec2Value:tz,CubicSplineVec3Value:nz,CubicSplineVec4Value:iz,CubicSplineQuatValue:rz,CubicSplineNumberValue:oz,AnimationController:sW,get VariableType(){return LU},StateMachineComponent:zj}));var cW,lW,uW,hW,fW,_W,pW,dW,mW,vW,gW,yW,SW,xW,TW,EW,bW,CW=function(e){function t(t){var n;return(n=e.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=t?t:i.director.getAnimationManager(),n}F(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){e.prototype.onPause.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){e.prototype.onResume.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){e.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:$n(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var f=n[h];--f.target.reference,f.target.reference<=0&&(f.target.state&&f.target.state.stop(),Z(this._managedStates,f.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},t}(qH),AW=function(t){return e({AnimationComponent:t,Animation:t}),t}((cW=sl("cc.Animation"),lW=El(),uW=ll(99),hW=yl(),fW=Hl([NH]),_W=Rl(),pW=Hl(NH),dW=Rl(),mW=Rl(),vW=Hl([NH]),cW(gW=lW(gW=uW(gW=gl(gW=hW((bW=EW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",SW,V(t)),t._crossFade=new CW,t._nameToState=_e(!0),q(t,"_clips",xW,V(t)),q(t,"_defaultClip",TW,V(t)),t._hasBeenPlayed=!1,t}F(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=_e(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&(this._crossFade.play(),this._crossFade.crossFade(n,t))},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(e){return this.getState(e)},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return $(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void b(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void b(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return t===WH.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return t===WH.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===WH.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new YH(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(WH.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n._getStateByNameOrDefaultClip=function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}return this._nameToState[e]||null},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];wW(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(WH.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(WH.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},L(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=W(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=W(e);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=e.find((function(e){return wW(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return wW(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(sn(oh)),EW.EventType=WH,X((yW=bW).prototype,"clips",[fW,_W],Object.getOwnPropertyDescriptor(yW.prototype,"clips"),yW.prototype),X(yW.prototype,"defaultClip",[pW,dW],Object.getOwnPropertyDescriptor(yW.prototype,"defaultClip"),yW.prototype),SW=X(yW.prototype,"playOnLoad",[_l,mW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xW=X(yW.prototype,"_clips",[vW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TW=X(yW.prototype,"_defaultClip",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gW=yW))||gW)||gW)||gW)||gW)||gW));function wW(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}zn(AW.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return AW.prototype.removeState.call(this,e.name)}}]),i.AnimationComponent=AW,He.setClassAlias(AW,"cc.AnimationComponent");var RW,IW,PW,OW=[],DW=new Map;function MW(e,t){for(var n=0,i=Ni.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,OW[n++]=e,e=e.parent}for(;n>0;){e=OW[--n],OW[n]=null;var r=e.node;Ni.fromRTS(e.local,r.rotation,r.position,r.scale),i=Ni.multiply(e.world,i,e.local)}return i}function NW(e,t){for(var n,i=null,r=0;e!==t;){var o=e.uuid;if(DW.has(o)){i=DW.get(o);break}i={node:e,local:new Ni,world:new Ni,stamp:-1,parent:null},DW.set(o,i),OW[r++]=i,e=e.parent,i=null}for(;r>0;)n=OW[--r],OW[r]=null,n.parent=i,i=n;return i}function LW(e){for(var t=DW.get(e.uuid)||null;t;)DW.delete(t.node.uuid),t=t.parent}var BW=e("AnimationManager",sl((PW=IW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new Y([]),t._crossFades=new Y([]),t._delayEvents=[],t._blendStateBuffer=new Dj,t._sockets=[],t}F(t,e);var n=t.prototype;return n.addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},n.removeCrossFade=function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):A(3907)},n.update=function(e){var t=this._delayEvents,n=this._crossFades,r=this._sockets,o=n.array;for(n.i=0;n.i<o.length;++n.i)o[n.i].update(e);var a=this._anims,s=a.array;for(a.i=0;a.i<s.length;++a.i){var c=s[a.i];c.isMotionless||c.update(e)}this._blendStateBuffer.apply();for(var l=i.director.getTotalFrames(),u=0,h=r.length;u<h;u++){var f=r[u],_=f.target,p=f.transform;_.matrix=MW(p,l)}for(var d=0,m=t.length;d<m;d++){var v=t[d];v.fn.apply(v.thisArg,v.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):A(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var o=e.getChildByPath(r.path),a=r.target&&o&&NW(o,e);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<t.length;++r)i(r)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){LW(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},L(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(kM),IW.ID="animation",RW=PW))||RW);eN.on($M.EVENT_INIT,(function(){var e=new BW;eN.registerSystem(BW.ID,e,kM.Priority.HIGH)})),i.AnimationManager=BW;var FW,zW,UW,kW,GW=new Ni;function HW(e,t,n){for(Ni.identity(n);e!==t;)Ni.fromRTS(GW,e.rotation,e.position,e.scale),Ni.multiply(n,GW,n),e=e.parent;return n}i.easing=s_;var VW=e("HierachyModifier",sl("cc.HierachyModifier")(FW=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t}(YF))||FW);i.HierachyModifier=VW;var jW=e("ComponentModifier",sl("cc.ComponentModifier")(zW=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t}(KF))||zW);i.ComponentModifier=jW;var WW=e("CurveValueAdapter",sl("cc.CurveValueAdapter")(UW=function(){function e(){}return e.prototype.forTarget=function(){return{set:function(){}}},e}())||UW);i.CurveValueAdapter=WW;var qW=e("UniformCurveValueAdapter",sl("cc.UniformCurveValueAdapter")(kW=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t}(QF))||kW);function XW(e){return"string"==typeof e}function YW(e){return"number"==typeof e}function KW(e,t){return e instanceof t}i.UniformCurveValueAdapter=qW,i.isPropertyModifier=XW,i.isElementModifier=YW,i.isCustomTargetModifier=KW,i.math=Zi,i.geometry=Up;var QW=e("NodePool",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},e}());i.NodePool=QW,i.renderer=dy;var ZW,JW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&da){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&ma&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},L(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(La);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(ZW||(ZW={}));var $W=function(){function e(){}return e.setInstance=function(t){e._instance=t},L(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function eq(e,t){switch(e){case Cr.R8:return t.UNSIGNED_BYTE;case Cr.R8SN:return t.BYTE;case Cr.R8UI:return t.UNSIGNED_BYTE;case Cr.R8I:return t.BYTE;case Cr.R16F:return ZW.HALF_FLOAT_OES;case Cr.R16UI:return t.UNSIGNED_SHORT;case Cr.R16I:return t.SHORT;case Cr.R32F:return t.FLOAT;case Cr.R32UI:return t.UNSIGNED_INT;case Cr.R32I:return t.INT;case Cr.RG8:return t.UNSIGNED_BYTE;case Cr.RG8SN:return t.BYTE;case Cr.RG8UI:return t.UNSIGNED_BYTE;case Cr.RG8I:return t.BYTE;case Cr.RG16F:return ZW.HALF_FLOAT_OES;case Cr.RG16UI:return t.UNSIGNED_SHORT;case Cr.RG16I:return t.SHORT;case Cr.RG32F:return t.FLOAT;case Cr.RG32UI:return t.UNSIGNED_INT;case Cr.RG32I:return t.INT;case Cr.RGB8:case Cr.SRGB8:return t.UNSIGNED_BYTE;case Cr.RGB8SN:return t.BYTE;case Cr.RGB8UI:return t.UNSIGNED_BYTE;case Cr.RGB8I:return t.BYTE;case Cr.RGB16F:return ZW.HALF_FLOAT_OES;case Cr.RGB16UI:return t.UNSIGNED_SHORT;case Cr.RGB16I:return t.SHORT;case Cr.RGB32F:return t.FLOAT;case Cr.RGB32UI:return t.UNSIGNED_INT;case Cr.RGB32I:return t.INT;case Cr.BGRA8:case Cr.RGBA8:case Cr.SRGB8_A8:return t.UNSIGNED_BYTE;case Cr.RGBA8SN:return t.BYTE;case Cr.RGBA8UI:return t.UNSIGNED_BYTE;case Cr.RGBA8I:return t.BYTE;case Cr.RGBA16F:return ZW.HALF_FLOAT_OES;case Cr.RGBA16UI:return t.UNSIGNED_SHORT;case Cr.RGBA16I:return t.SHORT;case Cr.RGBA32F:return t.FLOAT;case Cr.RGBA32UI:return t.UNSIGNED_INT;case Cr.RGBA32I:return t.INT;case Cr.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Cr.R11G11B10F:return t.FLOAT;case Cr.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Cr.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Cr.RGB10A2:return t.UNSIGNED_BYTE;case Cr.RGB10A2UI:return t.UNSIGNED_INT;case Cr.RGB9E5:return t.UNSIGNED_BYTE;case Cr.DEPTH:return t.UNSIGNED_INT;case Cr.DEPTH_STENCIL:return ZW.UNSIGNED_INT_24_8_WEBGL;case Cr.BC1:case Cr.BC1_SRGB:case Cr.BC2:case Cr.BC2_SRGB:case Cr.BC3:case Cr.BC3_SRGB:case Cr.BC4:return t.UNSIGNED_BYTE;case Cr.BC4_SNORM:return t.BYTE;case Cr.BC5:return t.UNSIGNED_BYTE;case Cr.BC5_SNORM:return t.BYTE;case Cr.BC6H_SF16:case Cr.BC6H_UF16:return t.FLOAT;case Cr.BC7:case Cr.BC7_SRGB:case Cr.ETC_RGB8:case Cr.ETC2_RGB8:case Cr.ETC2_SRGB8:case Cr.ETC2_RGB8_A1:case Cr.ETC2_SRGB8_A1:case Cr.EAC_R11:return t.UNSIGNED_BYTE;case Cr.EAC_R11SN:return t.BYTE;case Cr.EAC_RG11:return t.UNSIGNED_BYTE;case Cr.EAC_RG11SN:return t.BYTE;case Cr.PVRTC_RGB2:case Cr.PVRTC_RGBA2:case Cr.PVRTC_RGB4:case Cr.PVRTC_RGBA4:case Cr.PVRTC2_2BPP:case Cr.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Cr.ASTC_RGBA_4X4:case Cr.ASTC_RGBA_5X4:case Cr.ASTC_RGBA_5X5:case Cr.ASTC_RGBA_6X5:case Cr.ASTC_RGBA_6X6:case Cr.ASTC_RGBA_8X5:case Cr.ASTC_RGBA_8X6:case Cr.ASTC_RGBA_8X8:case Cr.ASTC_RGBA_10X5:case Cr.ASTC_RGBA_10X6:case Cr.ASTC_RGBA_10X8:case Cr.ASTC_RGBA_10X10:case Cr.ASTC_RGBA_12X10:case Cr.ASTC_RGBA_12X12:case Cr.ASTC_SRGBA_4X4:case Cr.ASTC_SRGBA_5X4:case Cr.ASTC_SRGBA_5X5:case Cr.ASTC_SRGBA_6X5:case Cr.ASTC_SRGBA_6X6:case Cr.ASTC_SRGBA_8X5:case Cr.ASTC_SRGBA_8X6:case Cr.ASTC_SRGBA_8X8:case Cr.ASTC_SRGBA_10X5:case Cr.ASTC_SRGBA_10X6:case Cr.ASTC_SRGBA_10X8:case Cr.ASTC_SRGBA_10X10:case Cr.ASTC_SRGBA_12X10:case Cr.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function tq(e,t){switch(e){case wr.BOOL:return t.BOOL;case wr.BOOL2:return t.BOOL_VEC2;case wr.BOOL3:return t.BOOL_VEC3;case wr.BOOL4:return t.BOOL_VEC4;case wr.INT:return t.INT;case wr.INT2:return t.INT_VEC2;case wr.INT3:return t.INT_VEC3;case wr.INT4:return t.INT_VEC4;case wr.UINT:return t.UNSIGNED_INT;case wr.FLOAT:return t.FLOAT;case wr.FLOAT2:return t.FLOAT_VEC2;case wr.FLOAT3:return t.FLOAT_VEC3;case wr.FLOAT4:return t.FLOAT_VEC4;case wr.MAT2:return t.FLOAT_MAT2;case wr.MAT3:return t.FLOAT_MAT3;case wr.MAT4:return t.FLOAT_MAT4;case wr.SAMPLER2D:return t.SAMPLER_2D;case wr.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),wr.UNKNOWN}}function nq(e){switch(e){case wr.BOOL:case wr.BOOL2:case wr.BOOL3:case wr.BOOL4:case wr.INT:case wr.INT2:case wr.INT3:case wr.INT4:case wr.UINT:return Int32Array;case wr.FLOAT:case wr.FLOAT2:case wr.FLOAT3:case wr.FLOAT4:case wr.MAT2:case wr.MAT3:case wr.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function iq(e,t){switch(e){case t.BOOL:return wr.BOOL;case t.BOOL_VEC2:return wr.BOOL2;case t.BOOL_VEC3:return wr.BOOL3;case t.BOOL_VEC4:return wr.BOOL4;case t.INT:return wr.INT;case t.INT_VEC2:return wr.INT2;case t.INT_VEC3:return wr.INT3;case t.INT_VEC4:return wr.INT4;case t.UNSIGNED_INT:return wr.UINT;case t.FLOAT:return wr.FLOAT;case t.FLOAT_VEC2:return wr.FLOAT2;case t.FLOAT_VEC3:return wr.FLOAT3;case t.FLOAT_VEC4:return wr.FLOAT4;case t.FLOAT_MAT2:return wr.MAT2;case t.FLOAT_MAT3:return wr.MAT3;case t.FLOAT_MAT4:return wr.MAT4;case t.SAMPLER_2D:return wr.SAMPLER2D;case t.SAMPLER_CUBE:return wr.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),wr.UNKNOWN}}function rq(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function oq(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}$W._instance=null;var aq,sq=[512,513,514,515,516,517,518,519],cq=[0,7680,7681,7682,7683,5386,34055,34056],lq=[32774,32778,32779,32775,32776],uq=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(aq||(aq={}));var hq=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},fq=function(e){function t(){var t;return(t=e.call(this,aq.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new po,t.clearFlag=ao.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return F(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(hq),_q=function(e){function t(){var t;return(t=e.call(this,aq.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new fa,t}return F(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},t}(hq),pq=function(e){function t(){var t;return(t=e.call(this,aq.DRAW)||this).drawInfo=new Io,t}return F(t,e),t.prototype.clear=function(){},t}(hq),dq=function(e){function t(){var t;return(t=e.call(this,aq.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return F(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(hq),mq=function(e){function t(){var t;return(t=e.call(this,aq.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return F(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(hq),vq=function(){function e(){this.cmds=new Xe(1),this.beginRenderPassCmds=new Xe(1),this.bindStatesCmds=new Xe(1),this.drawCmds=new Xe(1),this.updateBufferCmds=new Xe(1),this.copyBufferToTextureCmds=new Xe(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function gq(e,t,n,i,r){if(t.usage&Rr.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&Rr.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),yq.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),yq.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r))}}var yq={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function Sq(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var f=t.colorAttachments[h];if(f.format!==Cr.UNKNOWN)switch(f.loadOp){case Wr.LOAD:break;case Wr.CLEAR:c.bs.targets[0].blendColorMask!==Vr.ALL&&s.colorMask(!0,!0,!0,!0);var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT;break;case Wr.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Cr.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Wr.LOAD:break;case Wr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Wr.DISCARD:}if(pa[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Wr.LOAD:break;case Wr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Wr.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var p=c.bs.targets[0].blendColorMask;if(p!==Vr.ALL){var d=(p&Vr.R)!==Vr.NONE,m=(p&Vr.G)!==Vr.NONE,v=(p&Vr.B)!==Vr.NONE,g=(p&Vr.A)!==Vr.NONE;s.colorMask(d,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function xq(e,t,n,i,r,o){var a,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,f=!1;if(t&&yq.gpuPipelineState!==t){if(yq.gpuPipelineState=t,yq.glPrimitive=t.glPrimitive,t.gpuShader){var _=t.gpuShader.glProgram;u.glProgram!==_&&(l.useProgram(_),u.glProgram=_,f=!0)}var p=t.rs;if(p){if(u.rs.cullMode!==p.cullMode){switch(p.cullMode){case $r.NONE:l.disable(l.CULL_FACE);break;case $r.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case $r.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=p.cullMode}var m=p.isFrontFaceCCW;u.rs.isFrontFaceCCW!==m&&(l.frontFace(m?l.CCW:l.CW),u.rs.isFrontFaceCCW=m),u.rs.depthBias===p.depthBias&&u.rs.depthBiasSlop===p.depthBiasSlop||(l.polygonOffset(p.depthBias,p.depthBiasSlop),u.rs.depthBias=p.depthBias,u.rs.depthBiasSlop=p.depthBiasSlop),u.rs.lineWidth!==p.lineWidth&&(l.lineWidth(p.lineWidth),u.rs.lineWidth=p.lineWidth)}var v=t.dss;v&&(u.dss.depthTest!==v.depthTest&&(v.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=v.depthTest),u.dss.depthWrite!==v.depthWrite&&(l.depthMask(v.depthWrite),u.dss.depthWrite=v.depthWrite),u.dss.depthFunc!==v.depthFunc&&(l.depthFunc(sq[v.depthFunc]),u.dss.depthFunc=v.depthFunc),u.dss.stencilTestFront===v.stencilTestFront&&u.dss.stencilTestBack===v.stencilTestBack||(v.stencilTestFront||v.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=v.stencilTestFront,u.dss.stencilTestBack=v.stencilTestBack),u.dss.stencilFuncFront===v.stencilFuncFront&&u.dss.stencilRefFront===v.stencilRefFront&&u.dss.stencilReadMaskFront===v.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,sq[v.stencilFuncFront],v.stencilRefFront,v.stencilReadMaskFront),u.dss.stencilFuncFront=v.stencilFuncFront,u.dss.stencilRefFront=v.stencilRefFront,u.dss.stencilReadMaskFront=v.stencilReadMaskFront),u.dss.stencilFailOpFront===v.stencilFailOpFront&&u.dss.stencilZFailOpFront===v.stencilZFailOpFront&&u.dss.stencilPassOpFront===v.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,cq[v.stencilFailOpFront],cq[v.stencilZFailOpFront],cq[v.stencilPassOpFront]),u.dss.stencilFailOpFront=v.stencilFailOpFront,u.dss.stencilZFailOpFront=v.stencilZFailOpFront,u.dss.stencilPassOpFront=v.stencilPassOpFront),u.dss.stencilWriteMaskFront!==v.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,v.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=v.stencilWriteMaskFront),u.dss.stencilFuncBack===v.stencilFuncBack&&u.dss.stencilRefBack===v.stencilRefBack&&u.dss.stencilReadMaskBack===v.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,sq[v.stencilFuncBack],v.stencilRefBack,v.stencilReadMaskBack),u.dss.stencilFuncBack=v.stencilFuncBack,u.dss.stencilRefBack=v.stencilRefBack,u.dss.stencilReadMaskBack=v.stencilReadMaskBack),u.dss.stencilFailOpBack===v.stencilFailOpBack&&u.dss.stencilZFailOpBack===v.stencilZFailOpBack&&u.dss.stencilPassOpBack===v.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,cq[v.stencilFailOpBack],cq[v.stencilZFailOpBack],cq[v.stencilPassOpBack]),u.dss.stencilFailOpBack=v.stencilFailOpBack,u.dss.stencilZFailOpBack=v.stencilZFailOpBack,u.dss.stencilPassOpBack=v.stencilPassOpBack),u.dss.stencilWriteMaskBack!==v.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,v.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=v.stencilWriteMaskBack));var g=t.bs;if(g){u.bs.isA2C!==g.isA2C&&(g.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=g.isA2C),u.bs.blendColor.x===g.blendColor.x&&u.bs.blendColor.y===g.blendColor.y&&u.bs.blendColor.z===g.blendColor.z&&u.bs.blendColor.w===g.blendColor.w||(l.blendColor(g.blendColor.x,g.blendColor.y,g.blendColor.z,g.blendColor.w),u.bs.blendColor.x=g.blendColor.x,u.bs.blendColor.y=g.blendColor.y,u.bs.blendColor.z=g.blendColor.z,u.bs.blendColor.w=g.blendColor.w);var y=g.targets[0],S=u.bs.targets[0];S.blend!==y.blend&&(y.blend?l.enable(l.BLEND):l.disable(l.BLEND),S.blend=y.blend),S.blendEq===y.blendEq&&S.blendAlphaEq===y.blendAlphaEq||(l.blendEquationSeparate(lq[y.blendEq],lq[y.blendAlphaEq]),S.blendEq=y.blendEq,S.blendAlphaEq=y.blendAlphaEq),S.blendSrc===y.blendSrc&&S.blendDst===y.blendDst&&S.blendSrcAlpha===y.blendSrcAlpha&&S.blendDstAlpha===y.blendDstAlpha||(l.blendFuncSeparate(uq[y.blendSrc],uq[y.blendDst],uq[y.blendSrcAlpha],uq[y.blendDstAlpha]),S.blendSrc=y.blendSrc,S.blendDst=y.blendDst,S.blendSrcAlpha=y.blendSrcAlpha,S.blendDstAlpha=y.blendDstAlpha),S.blendColorMask!==y.blendColorMask&&(l.colorMask((y.blendColorMask&Vr.R)!==Vr.NONE,(y.blendColorMask&Vr.G)!==Vr.NONE,(y.blendColorMask&Vr.B)!==Vr.NONE,(y.blendColorMask&Vr.A)!==Vr.NONE),S.blendColorMask=y.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var x=h.glBlocks.length,T=t.gpuPipelineLayout.dynamicOffsetIndices,E=0;E<x;E++){var b=h.glBlocks[E],C=i[b.set],A=C&&C.descriptorIndices[b.binding],w=A>=0&&C.gpuDescriptors[A],R=null,I=0;if(w&&w.gpuBuffer){var P=w.gpuBuffer,O=T[b.set],D=O&&O[b.binding];D>=0&&(I=r[D]),"vf32"in P?R=P.vf32:(I+=P.offset,R=P.gpuBuffer.vf32),I>>=2}if(R)for(var M=b.glActiveUniforms.length,N=0;N<M;N++){var L=b.glActiveUniforms[N];switch(L.glType){case l.BOOL:case l.INT:for(var B=0;B<L.array.length;++B){var F=L.offset+I+B;if(R[F]!==L.array[B]){for(var z=B,U=F;z<L.array.length;++z,++U)L.array[z]=R[U];l.uniform1iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var k=0;k<L.array.length;++k){var G=L.offset+I+k;if(R[G]!==L.array[k]){for(var H=k,V=G;H<L.array.length;++H,++V)L.array[H]=R[V];l.uniform2iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<L.array.length;++j){var W=L.offset+I+j;if(R[W]!==L.array[j]){for(var q=j,X=W;q<L.array.length;++q,++X)L.array[q]=R[X];l.uniform3iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<L.array.length;++Y){var K=L.offset+I+Y;if(R[K]!==L.array[Y]){for(var Q=Y,Z=K;Q<L.array.length;++Q,++Z)L.array[Q]=R[Z];l.uniform4iv(L.glLoc,L.array);break}}break;case l.FLOAT:for(var J=0;J<L.array.length;++J){var $=L.offset+I+J;if(R[$]!==L.array[J]){for(var ee=J,te=$;ee<L.array.length;++ee,++te)L.array[ee]=R[te];l.uniform1fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<L.array.length;++ne){var ie=L.offset+I+ne;if(R[ie]!==L.array[ne]){for(var re=ne,oe=ie;re<L.array.length;++re,++oe)L.array[re]=R[oe];l.uniform2fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC3:for(var ae=0;ae<L.array.length;++ae){var se=L.offset+I+ae;if(R[se]!==L.array[ae]){for(var ce=ae,le=se;ce<L.array.length;++ce,++le)L.array[ce]=R[le];l.uniform3fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<L.array.length;++ue){var he=L.offset+I+ue;if(R[he]!==L.array[ue]){for(var fe=ue,_e=he;fe<L.array.length;++fe,++_e)L.array[fe]=R[_e];l.uniform4fv(L.glLoc,L.array);break}}break;case l.FLOAT_MAT2:for(var pe=0;pe<L.array.length;++pe){var de=L.offset+I+pe;if(R[de]!==L.array[pe]){for(var me=pe,ve=de;me<L.array.length;++me,++ve)L.array[me]=R[ve];l.uniformMatrix2fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<L.array.length;++ge){var ye=L.offset+I+ge;if(R[ye]!==L.array[ge]){for(var Se=ge,xe=ye;Se<L.array.length;++Se,++xe)L.array[Se]=R[xe];l.uniformMatrix3fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT4:for(var Te=0;Te<L.array.length;++Te){var Ee=L.offset+I+Te;if(R[Ee]!==L.array[Te]){for(var be=Te,Ce=Ee;be<L.array.length;++be,++Ce)L.array[be]=R[Ce];l.uniformMatrix4fv(L.glLoc,!1,L.array);break}}}}else d("Buffer binding '"+b.name+"' at set "+b.set+" binding "+b.binding+" is not bounded")}for(var Ae=h.glSamplerTextures.length,we=0;we<Ae;we++)for(var Re=h.glSamplerTextures[we],Ie=i[Re.set],Pe=Ie&&Ie.descriptorIndices[Re.binding],Oe=Pe>=0&&Ie.gpuDescriptors[Pe],De=Re.units.length,Me=0;Me<De;Me++){var Ne=Re.units[Me];if(Oe&&Oe.gpuSampler){if(Oe.gpuTexture&&Oe.gpuTexture.size>0){var Le=Oe.gpuTexture,Be=u.glTexUnits[Ne];Be.glTexture!==Le.glTexture&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),Le.glTexture?l.bindTexture(Le.glTarget,Le.glTexture):l.bindTexture(Le.glTarget,e.nullTex2D.gpuTexture.glTexture),Be.glTexture=Le.glTexture);var Fe=Oe.gpuSampler;Le.isPowerOf2?(a=Fe.glWrapS,s=Fe.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Le.isPowerOf2?Le.mipLevel<=1&&(Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Fe.glMinFilter:Fe.glMinFilter===l.LINEAR||Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Le.glWrapS!==a&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_S,a),Le.glWrapS=a),Le.glWrapT!==s&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_T,s),Le.glWrapT=s),Le.glMinFilter!==c&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_MIN_FILTER,c),Le.glMinFilter=c),Le.glMagFilter!==Fe.glMagFilter&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_MAG_FILTER,Fe.glMagFilter),Le.glMagFilter=Fe.glMagFilter)}Oe=Ie.gpuDescriptors[++Pe]}else d("Sampler binding '"+Re.name+"' at set "+Re.set+" binding "+Re.binding+" index "+Me+" is not bounded")}}if(n&&h&&(f||yq.gpuInputAssembler!==n)){yq.gpuInputAssembler=n;var ze=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ue=e.extensions.OES_vertex_array_object,ke=n.glVAOs.get(h.glProgram);if(!ke){var Ge;ke=Ue.createVertexArrayOES(),n.glVAOs.set(h.glProgram,ke),Ue.bindVertexArrayOES(ke),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var He=h.glInputs.length,Ve=0;Ve<He;Ve++){var je=h.glInputs[Ve];Ge=null;for(var We=n.glAttribs.length,qe=0;qe<We;qe++){var Xe=n.glAttribs[qe];if(Xe.name===je.name){Ge=Xe;break}}if(Ge){u.glArrayBuffer!==Ge.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ge.glBuffer),u.glArrayBuffer=Ge.glBuffer);for(var Ye=0;Ye<Ge.componentCount;++Ye){var Ke=je.glLoc+Ye,Qe=Ge.offset+Ge.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,Ge.count,Ge.glType,Ge.isNormalized,Ge.stride,Qe),ze&&ze.vertexAttribDivisorANGLE(Ke,Ge.isInstanced?1:0)}}}var Ze=n.gpuIndexBuffer;Ze&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Ze.glBuffer),Ue.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==ke&&(Ue.bindVertexArrayOES(ke),u.glVAO=ke)}else{for(var Je=0;Je<e.capabilities.maxVertexAttributes;++Je)u.glCurrentAttribLocs[Je]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var ot=n.glAttribs[rt];if(ot.name===tt.name){nt=ot;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var at=0;at<nt.componentCount;++at){var st=tt.glLoc+at,ct=nt.offset+nt.size*at;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),ze&&ze.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,ft=0;ft<ht;ft++)switch(t.dynamicStates[ft]){case eo.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case eo.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case eo.BLEND_CONSTANTS:var _t=o.blendConstant;u.bs.blendColor.x===_t.x&&u.bs.blendColor.y===_t.y&&u.bs.blendColor.z===_t.z&&u.bs.blendColor.w===_t.w||(l.blendColor(_t.x,_t.y,_t.z,_t.w),u.bs.blendColor.copy(_t));break;case eo.STENCIL_WRITE_MASK:var pt=o.stencilStatesFront,dt=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==pt.writeMask&&(l.stencilMaskSeparate(l.FRONT,pt.writeMask),u.dss.stencilWriteMaskFront=pt.writeMask),u.dss.stencilWriteMaskBack!==dt.writeMask&&(l.stencilMaskSeparate(l.BACK,dt.writeMask),u.dss.stencilWriteMaskBack=dt.writeMask);break;case eo.STENCIL_COMPARE_MASK:var mt=o.stencilStatesFront,vt=o.stencilStatesBack;u.dss.stencilRefFront===mt.reference&&u.dss.stencilReadMaskFront===mt.compareMask||(l.stencilFuncSeparate(l.FRONT,sq[u.dss.stencilFuncFront],mt.reference,mt.compareMask),u.dss.stencilRefFront=mt.reference,u.dss.stencilReadMaskFront=mt.compareMask),u.dss.stencilRefBack===vt.reference&&u.dss.stencilReadMaskBack===vt.compareMask||(l.stencilFuncSeparate(l.BACK,sq[u.dss.stencilFuncBack],vt.reference,vt.compareMask),u.dss.stencilRefBack=vt.reference,u.dss.stencilReadMaskBack=vt.compareMask)}}function Tq(e,t){var n=e.gl,i=e.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=yq.gpuInputAssembler,s=yq.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var f=0;f<l.drawCount;f++)l.instances[f]&&r?r.drawArraysInstancedANGLE(s,l.offsets[f],l.counts[f],l.instances[f]):n.drawArrays(s,l.offsets[f],l.counts[f])}else if(t.instanceCount&&r)if(c){if(t.indexCount>0){var _=t.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,t.indexCount,a.glIndexType,_,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(c){if(t.indexCount>0){var p=t.firstIndex*c.stride;n.drawElements(s,t.indexCount,a.glIndexType,p)}}else t.vertexCount>0&&n.drawArrays(s,t.firstVertex,t.vertexCount)}}var Eq=new Array(aq.COUNT);function bq(e,t){Eq.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=Eq[i]++;switch(i){case aq.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];Sq(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case aq.BIND_STATES:var a=t.bindStatesCmds.array[r];xq(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case aq.DRAW:Tq(e,t.drawCmds.array[r].drawInfo);break;case aq.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];gq(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case aq.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];Cq(e,c.buffers,c.gpuTexture,c.regions)}}}function Cq(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=pa[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];s=f.texExtent.width,c=f.texExtent.height;var _=t[a++];u?n.glInternalFmt===ZW.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,n.glInternalFmt,s,c,0,_):r.compressedTexSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,_):r.texSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,n.glType,_)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=t[a++];u?n.glInternalFmt===ZW.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Nr.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var Aq=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=Ln(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),wq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&Rr.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new Aq,glTarget:0,glBuffer:null},this._usage&Rr.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Or.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&Rr.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),yq.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Rr.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),yq.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&Rr.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&Rr.INDIRECT||t.usage&Rr.TRANSFER_DST||t.usage&Rr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}($W.instance,this._gpuBuffer),$W.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),yq.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),yq.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}($W.instance,this._gpuBuffer),$W.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Or.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&Rr.VERTEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),yq.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&Rr.INDEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),yq.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Rr.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&Rr.INDIRECT||t.usage&Rr.TRANSFER_DST||t.usage&Rr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}($W.instance,this._gpuBuffer),$W.instance.memoryStatus.bufferSize-=t,$W.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&Rr.INDIRECT?0:e.byteLength,gq($W.instance,this._gpuBuffer,e,0,n))},L(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(Aa),Rq=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Xe(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),Iq=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new Rq(fq,1),this.bindStatesCmdPool=new Rq(_q,1),this.drawCmdPool=new Rq(pq,1),this.updateBufferCmdPool=new Rq(dq,1),this.copyBufferToTextureCmdPool=new Rq(mq,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),Pq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new vq,t._cmdAllocator=new Iq,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new fa,t._isStateInvalied=!1,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=$W.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(fq);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=n,a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(aq.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&to.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&to.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&to.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&to.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===oo.PRIMARY&&this._isInRenderPass||this._type===oo.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(pq);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(aq.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===oo.PRIMARY&&!this._isInRenderPass||this._type===oo.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(dq),a=0;e.usage&Rr.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(aq.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===oo.PRIMARY&&!this._isInRenderPass||this._type===oo.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(mq);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(aq.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<i.cmdPackage.copyBufferToTextureCmds.length;++f){var _=i.cmdPackage.copyBufferToTextureCmds.array[f];++_.refCount,this.cmdPackage.copyBufferToTextureCmds.push(_)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(_q);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(aq.BIND_STATES),this._isStateInvalied=!1)},t}(wa),Oq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;++n){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(e){o=e},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(e){a=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=pa[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}($W.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=$W.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)},L(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(Pa),Dq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=eq(o.format,n),l=pa[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:pa[o.format].count,stride:s.stride,componentCount:oq(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}($W.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=$W.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next();!i.done;)e.extensions.OES_vertex_array_object.deleteVertexArrayOES(i.value),i=n.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},L(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(Na),Mq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&va)for(var f=0;f<h.count;f++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},L(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Ba),Nq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},L(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Fa),Lq=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],Bq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:Lq[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},L(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Va),Fq=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){Sq($W.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;Tq($W.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=$W.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=$W.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&Rr.INDIRECT?0:t.byteLength,gq($W.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&Cq($W.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];bq($W.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){xq($W.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(Pq),zq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(ja),Uq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},L(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(Wa),kq=[10497,33648,33071,33071],Gq=function(e){function t(t,n){var i;(i=e.call(this,t,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===Fr.LINEAR||a===Fr.ANISOTROPIC?c===Fr.LINEAR||c===Fr.ANISOTROPIC?9987:c===Fr.POINT?9985:9729:c===Fr.LINEAR||c===Fr.ANISOTROPIC?9986:c===Fr.POINT?9984:9728,o=s===Fr.LINEAR||s===Fr.ANISOTROPIC?9729:9728;var l=kq[i._info.addressU],u=kq[i._info.addressV],h=kq[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return F(t,e),L(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(qa),Hq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case jr.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case jr.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));v("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var f=0;f<h;++f){var _=n.getActiveAttrib(t.glProgram,f);if(_){var p,d=_.name.indexOf("[");p=-1!==d?_.name.substr(0,d):_.name;var m=n.getAttribLocation(t.glProgram,p),g=iq(_.type,n),y=rq(_.type,n);t.glInputs[f]={binding:m,name:p,type:g,stride:y,count:_.size,size:y*_.size,glType:_.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var S=0;S<t.blocks.length;++S){var x=t.blocks[S],T={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};t.glBlocks[S]=T;for(var E=0;E<x.members.length;++E){var b=x.members[E],C=tq(b.type,n),A=rq(C,n),w=A*b.count;T.glUniforms[E]={binding:-1,name:b.name,type:b.type,stride:A,count:b.count,size:w,offset:0,glType:C,glLoc:null,array:null}}}}for(var R=0;R<t.subpassInputs.length;++R){var I=t.subpassInputs[R];t.samplerTextures.push(new Fo(I.set,I.binding,I.name,wr.SAMPLER2D,I.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var P=0;P<t.samplerTextures.length;++P){var O=t.samplerTextures[P];t.glSamplerTextures[P]={set:O.set,binding:O.binding,name:O.name,type:O.type,count:O.count,units:[],glUnits:null,glType:tq(O.type,n),glLoc:null}}}for(var D=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),M=0;M<D;++M){var N=n.getActiveUniform(t.glProgram,M);if(N&&N.type!==n.SAMPLER_2D&&N.type!==n.SAMPLER_CUBE){var L=n.getUniformLocation(t.glProgram,N.name);if(e.extensions.isLocationActive(L)){var B,F=N.name.indexOf("[");B=-1!==F?N.name.substr(0,F):N.name;for(var z=0;z<t.glBlocks.length;z++)for(var U=t.glBlocks[z],k=0;k<U.glUniforms.length;k++){var G=U.glUniforms[k];if(G.name===B){G.glLoc=L,G.count=N.size,G.size=G.stride*G.count,G.array=new(nq(G.type))(G.size/4),U.glActiveUniforms.push(G);break}}}}}for(var H=0;H<t.glBlocks.length;H++)for(var V=t.glBlocks[H],j=0;j<V.glUniforms.length;j++){var W=V.glUniforms[j];W.offset=V.size/4,V.size+=W.size}for(var q=[],X=[],Y=e.bindingMappingInfo,K=e.stateCache.texUnitCacheMap,Q=0,Z=0;Z<t.blocks.length;++Z)t.blocks[Z].set===Y.flexibleSet&&Q++;for(var J=0,$=0;$<t.samplerTextures.length;++$){var ee=t.samplerTextures[$],te=n.getUniformLocation(t.glProgram,ee.name);if(e.extensions.isLocationActive(te)&&(q.push(t.glSamplerTextures[$]),X.push(te)),void 0===K[ee.name]){var ne=ee.binding+Y.samplerOffsets[ee.set]+J;ee.set===Y.flexibleSet&&(ne-=Q),K[ee.name]=ne%e.capabilities.maxTextureUnits,J+=ee.count-1}}if(q.length){for(var ie=[],re=0;re<q.length;++re){var oe=q[re],ae=K[oe.name];if(void 0!==ae){oe.glLoc=X[re];for(var se=0;se<oe.count;++se){for(;ie[ae];)ae=(ae+1)%e.capabilities.maxTextureUnits;oe.units.push(ae),ie[ae]=!0}}}for(var ce=0,le=0;le<q.length;++le){var ue=q[le];if(!e.extensions.isLocationActive(ue.glLoc)){ue.glLoc=X[le];for(var he=0;he<ue.count;++he){for(;ie[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;void 0===K[ue.name]&&(K[ue.name]=ce),ue.units.push(ce),ie[ce]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var fe=0;fe<q.length;fe++){var _e=q[fe];_e.glUnits=new Int32Array(_e.units),n.uniform1iv(_e.glLoc,_e.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var pe=0;pe<t.glBlocks.length;)t.glBlocks[pe].glActiveUniforms.length?pe++:(t.glBlocks[pe]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=q}}($W.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.extensions.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),t.glProgram=null}}($W.instance,this._gpuShader),this._gpuShader=null)},L(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Xa),Vq=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new To,this.scissorRect=new po(0,0,0,0),this.rs=new za,this.dss=new Ua,this.bs=new Ga,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),jq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e,t){"texture"in e?console.log("WebGL does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=ya(this._width)&&ya(this._height),this._size=xa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case Cr.A8:return t.ALPHA;case Cr.L8:return t.LUMINANCE;case Cr.LA8:return t.LUMINANCE_ALPHA;case Cr.RGB8:case Cr.RGB16F:case Cr.RGB32F:return t.RGB;case Cr.BGRA8:case Cr.RGBA8:case Cr.SRGB8_A8:case Cr.RGBA16F:case Cr.RGBA32F:return t.RGBA;case Cr.R5G6B5:return t.RGB;case Cr.RGB5A1:case Cr.RGBA4:return t.RGBA;case Cr.DEPTH:return t.DEPTH_COMPONENT;case Cr.DEPTH_STENCIL:return t.DEPTH_STENCIL;case Cr.BC1:return ZW.COMPRESSED_RGB_S3TC_DXT1_EXT;case Cr.BC1_ALPHA:return ZW.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Cr.BC1_SRGB:return ZW.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Cr.BC1_SRGB_ALPHA:return ZW.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Cr.BC2:return ZW.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Cr.BC2_SRGB:return ZW.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Cr.BC3:return ZW.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Cr.BC3_SRGB:return ZW.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Cr.ETC_RGB8:return ZW.COMPRESSED_RGB_ETC1_WEBGL;case Cr.ETC2_RGB8:return ZW.COMPRESSED_RGB8_ETC2;case Cr.ETC2_SRGB8:return ZW.COMPRESSED_SRGB8_ETC2;case Cr.ETC2_RGB8_A1:return ZW.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_SRGB8_A1:return ZW.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_RGBA8:return ZW.COMPRESSED_RGBA8_ETC2_EAC;case Cr.ETC2_SRGB8_A8:return ZW.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Cr.EAC_R11:return ZW.COMPRESSED_R11_EAC;case Cr.EAC_R11SN:return ZW.COMPRESSED_SIGNED_R11_EAC;case Cr.EAC_RG11:return ZW.COMPRESSED_RG11_EAC;case Cr.EAC_RG11SN:return ZW.COMPRESSED_SIGNED_RG11_EAC;case Cr.PVRTC_RGB2:return ZW.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGBA2:return ZW.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGB4:return ZW.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Cr.PVRTC_RGBA4:return ZW.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Cr.ASTC_RGBA_4X4:return ZW.COMPRESSED_RGBA_ASTC_4x4_KHR;case Cr.ASTC_RGBA_5X4:return ZW.COMPRESSED_RGBA_ASTC_5x4_KHR;case Cr.ASTC_RGBA_5X5:return ZW.COMPRESSED_RGBA_ASTC_5x5_KHR;case Cr.ASTC_RGBA_6X5:return ZW.COMPRESSED_RGBA_ASTC_6x5_KHR;case Cr.ASTC_RGBA_6X6:return ZW.COMPRESSED_RGBA_ASTC_6x6_KHR;case Cr.ASTC_RGBA_8X5:return ZW.COMPRESSED_RGBA_ASTC_8x5_KHR;case Cr.ASTC_RGBA_8X6:return ZW.COMPRESSED_RGBA_ASTC_8x6_KHR;case Cr.ASTC_RGBA_8X8:return ZW.COMPRESSED_RGBA_ASTC_8x8_KHR;case Cr.ASTC_RGBA_10X5:return ZW.COMPRESSED_RGBA_ASTC_10x5_KHR;case Cr.ASTC_RGBA_10X6:return ZW.COMPRESSED_RGBA_ASTC_10x6_KHR;case Cr.ASTC_RGBA_10X8:return ZW.COMPRESSED_RGBA_ASTC_10x8_KHR;case Cr.ASTC_RGBA_10X10:return ZW.COMPRESSED_RGBA_ASTC_10x10_KHR;case Cr.ASTC_RGBA_12X10:return ZW.COMPRESSED_RGBA_ASTC_12x10_KHR;case Cr.ASTC_RGBA_12X12:return ZW.COMPRESSED_RGBA_ASTC_12x12_KHR;case Cr.ASTC_SRGBA_4X4:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Cr.ASTC_SRGBA_5X4:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Cr.ASTC_SRGBA_5X5:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Cr.ASTC_SRGBA_6X5:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Cr.ASTC_SRGBA_6X6:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Cr.ASTC_SRGBA_8X5:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Cr.ASTC_SRGBA_8X6:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Cr.ASTC_SRGBA_8X8:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Cr.ASTC_SRGBA_10X5:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Cr.ASTC_SRGBA_10X6:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Cr.ASTC_SRGBA_10X8:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Cr.ASTC_SRGBA_10X10:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Cr.ASTC_SRGBA_12X10:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Cr.ASTC_SRGBA_12X12:return ZW.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=eq(t.format,n);var i=t.width,r=t.height;switch(t.type){case Dr.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&A(9100,o,e.capabilities.maxTextureSize),!e.extensions.WEBGL_depth_texture&&pa[t.format].hasDepth)t.glInternalFmt=function(e,t){switch(e){case Cr.R5G6B5:return t.RGB565;case Cr.RGB5A1:return t.RGB5_A1;case Cr.RGBA4:return t.RGBA4;case Cr.RGBA16F:return ZW.RGBA16F_EXT;case Cr.RGBA32F:return ZW.RGBA32F_EXT;case Cr.SRGB8_A8:return ZW.SRGB8_ALPHA8_EXT;case Cr.DEPTH:return t.DEPTH_COMPONENT16;case Cr.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r));else if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),pa[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=Sa(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;case Dr.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>e.capabilities.maxCubeMapTextureSize&&A(9100,h,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var f=e.stateCache.glTexUnits[e.stateCache.texUnit];if(f.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),f.glTexture=t.glTexture),pa[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var d=Sa(t.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,p,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Dr.TEX2D,t.glTarget=n.TEXTURE_2D}}($W.instance,this._gpuTexture),$W.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){var e,t;this._gpuTexture&&(e=$W.instance,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),$W.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=xa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Dr.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&A(9100,o,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),pa[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=Sa(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case Dr.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&A(9100,h,e.capabilities.maxTextureSize);var f=e.stateCache.glTexUnits[e.stateCache.texUnit];if(f.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),f.glTexture=t.glTexture),pa[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var d=Sa(t.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,p,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Dr.TEX2D,t.glTarget=n.TEXTURE_2D}}}($W.instance,this._gpuTexture),$W.instance.memoryStatus.textureSize-=n,$W.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(e){var t=new Do;t.format=e.format,t.usage=pa[e.format].hasDepth?Mr.DEPTH_STENCIL_ATTACHMENT:Mr.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},L(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(Ya),Wq="webglcontextlost";function qq(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function Xq(e){var t={EXT_texture_filter_anisotropic:qq(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:qq(e,"EXT_blend_minmax"),EXT_frag_depth:qq(e,"EXT_frag_depth"),EXT_shader_texture_lod:qq(e,"EXT_shader_texture_lod"),EXT_sRGB:qq(e,"EXT_sRGB"),OES_vertex_array_object:qq(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:qq(e,"EXT_color_buffer_half_float"),WEBGL_multi_draw:qq(e,"WEBGL_multi_draw"),WEBGL_color_buffer_float:qq(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:qq(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:qq(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:qq(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:qq(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:qq(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:qq(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:qq(e,"WEBGL_draw_buffers"),WEBGL_lose_context:qq(e,"WEBGL_lose_context"),WEBGL_depth_texture:qq(e,"WEBGL_depth_texture"),OES_texture_half_float:qq(e,"OES_texture_half_float"),OES_texture_half_float_linear:qq(e,"OES_texture_half_float_linear"),OES_texture_float:qq(e,"OES_texture_float"),OES_texture_float_linear:qq(e,"OES_texture_float_linear"),OES_standard_derivatives:qq(e,"OES_standard_derivatives"),OES_element_index_uint:qq(e,"OES_element_index_uint"),ANGLE_instanced_arrays:qq(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:qq(e,"WEBGL_debug_renderer_info"),WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return dh.os===hn.IOS&&14===dh.osMainVersion&&dh.isBrowser||(t.WEBGL_compressed_texture_astc=qq(e,"WEBGL_compressed_texture_astc")),dh.browserType===cn.UC&&(t.ANGLE_instanced_arrays=null),dh.os===hn.IOS&&dh.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var Yq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new Vq,t.cmdAllocator=new Iq,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(Wq,this._onWebGLContextLost);var t=$W.instance.gl;this.stateCache.initialize($W.instance.capabilities.maxTextureUnits,$W.instance.capabilities.maxVertexAttributes),this._extensions=Xq(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=Cr.RGBA8,i=Cr.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=Cr.DEPTH_STENCIL:r&&(i=Cr.DEPTH),this._colorTexture=new jq,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new jq,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=$W.instance.createTexture(new Do(Dr.TEX2D,Mr.SAMPLED,Cr.RGBA8,2,2,Nr.GEN_MIPMAP)),this.nullTexCube=$W.instance.createTexture(new Do(Dr.CUBE,Mr.SAMPLED,Cr.RGBA8,2,2,Nr.GEN_MIPMAP,6));var a=new xo;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),$W.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,$W.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(Wq,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(v("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){b(11e3),p(e)},L(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(Ia),Kq=e("WebGLDevice",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){$W.setInstance(this),this._gfxAPI=Tr.WEBGL,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:tt.ENABLE_TRANSPARENT_CANVAS,antialias:tt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",n)}catch(e){return null}return t}(Ra.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new sa(io.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new aa(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE);var n=t.getSupportedExtensions(),i="";if(n)for(var r,o=W(n);!(r=o()).done;)i+=r.value+" ";var a=Xq(t);a.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var s=t.getParameter(t.VERSION);this._features.fill(!1),a.EXT_sRGB&&(this._features[br.FORMAT_SRGB]=!0),a.EXT_blend_minmax&&(this._features[br.BLEND_MINMAX]=!0),a.WEBGL_color_buffer_float&&(this._features[br.COLOR_FLOAT]=!0),a.EXT_color_buffer_half_float&&(this._features[br.COLOR_HALF_FLOAT]=!0),a.OES_texture_float&&(this._features[br.TEXTURE_FLOAT]=!0),a.OES_texture_half_float&&(this._features[br.TEXTURE_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[br.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[br.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[br.FORMAT_RGB8]=!0,a.OES_element_index_uint&&(this._features[br.ELEMENT_INDEX_UINT]=!0),a.ANGLE_instanced_arrays&&(this._features[br.INSTANCED_ARRAYS]=!0),a.WEBGL_draw_buffers&&(this._features[br.MULTIPLE_RENDER_TARGETS]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[br.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[br.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[br.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[br.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[br.FORMAT_ASTC]=!0,c+="astc "),v("WebGL device initialized."),v("RENDERER: "+this._renderer),v("VENDOR: "+this._vendor),v("VERSION: "+s),v("COMPRESSED_FORMAT: "+c),v("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===oo.PRIMARY?Fq:Pq);return t.initialize(e),t},n.createSwapchain=function(e){var t=new Yq;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new wq;return t.initialize(e),t},n.createTexture=function(e){var t=new jq;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new JW;return t.initialize(e),t},n.createShader=function(e){var t=new Hq;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new Dq;return t.initialize(e),t},n.createRenderPass=function(e){var t=new Uq;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new Oq;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new Mq;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new Nq;return t.initialize(e),t},n.createPipelineState=function(e){var t=new Bq;return t.initialize(e),t},n.createQueue=function(e){var t=new zq;return t.initialize(e),t},n.getSampler=function(e){var t=qa.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new Gq(e,t)),this._samplers.get(t)},n.getGlobalBarrier=function(e){var t=Ka.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new Ka(e,t)),this._globalBarriers.get(t)},n.getTextureBarrier=function(e){var t=Qa.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Qa(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){Cq(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,f.texSubres.mipLevel),s=f.texOffset.x,c=f.texOffset.y,l=f.texExtent.width,u=f.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],f=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<f;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Nr.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},L(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),t}(Ra));i.WebGLDevice=Kq;var Qq,Zq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&da?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&ma&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},L(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(La);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(Qq||(Qq={}));var Jq=function(){function e(){}return e.setInstance=function(t){e._instance=t},L(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();Jq._instance=null;var $q=[10497,33648,33071,33071],eX=new Float32Array(4);function tX(e,t){switch(e){case Cr.R8:return t.UNSIGNED_BYTE;case Cr.R8SN:return t.BYTE;case Cr.R8UI:return t.UNSIGNED_BYTE;case Cr.R8I:return t.BYTE;case Cr.R16F:return t.HALF_FLOAT;case Cr.R16UI:return t.UNSIGNED_SHORT;case Cr.R16I:return t.SHORT;case Cr.R32F:return t.FLOAT;case Cr.R32UI:return t.UNSIGNED_INT;case Cr.R32I:return t.INT;case Cr.RG8:return t.UNSIGNED_BYTE;case Cr.RG8SN:return t.BYTE;case Cr.RG8UI:return t.UNSIGNED_BYTE;case Cr.RG8I:return t.BYTE;case Cr.RG16F:return t.HALF_FLOAT;case Cr.RG16UI:return t.UNSIGNED_SHORT;case Cr.RG16I:return t.SHORT;case Cr.RG32F:return t.FLOAT;case Cr.RG32UI:return t.UNSIGNED_INT;case Cr.RG32I:return t.INT;case Cr.RGB8:case Cr.SRGB8:return t.UNSIGNED_BYTE;case Cr.RGB8SN:return t.BYTE;case Cr.RGB8UI:return t.UNSIGNED_BYTE;case Cr.RGB8I:return t.BYTE;case Cr.RGB16F:return t.HALF_FLOAT;case Cr.RGB16UI:return t.UNSIGNED_SHORT;case Cr.RGB16I:return t.SHORT;case Cr.RGB32F:return t.FLOAT;case Cr.RGB32UI:return t.UNSIGNED_INT;case Cr.RGB32I:return t.INT;case Cr.BGRA8:case Cr.RGBA8:case Cr.SRGB8_A8:return t.UNSIGNED_BYTE;case Cr.RGBA8SN:return t.BYTE;case Cr.RGBA8UI:return t.UNSIGNED_BYTE;case Cr.RGBA8I:return t.BYTE;case Cr.RGBA16F:return t.HALF_FLOAT;case Cr.RGBA16UI:return t.UNSIGNED_SHORT;case Cr.RGBA16I:return t.SHORT;case Cr.RGBA32F:return t.FLOAT;case Cr.RGBA32UI:return t.UNSIGNED_INT;case Cr.RGBA32I:return t.INT;case Cr.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case Cr.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case Cr.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case Cr.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case Cr.RGB10A2:case Cr.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case Cr.RGB9E5:case Cr.DEPTH:return t.FLOAT;case Cr.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case Cr.BC1:case Cr.BC1_SRGB:case Cr.BC2:case Cr.BC2_SRGB:case Cr.BC3:case Cr.BC3_SRGB:case Cr.BC4:return t.UNSIGNED_BYTE;case Cr.BC4_SNORM:return t.BYTE;case Cr.BC5:return t.UNSIGNED_BYTE;case Cr.BC5_SNORM:return t.BYTE;case Cr.BC6H_SF16:case Cr.BC6H_UF16:return t.FLOAT;case Cr.BC7:case Cr.BC7_SRGB:case Cr.ETC_RGB8:case Cr.ETC2_RGB8:case Cr.ETC2_SRGB8:case Cr.ETC2_RGB8_A1:case Cr.ETC2_SRGB8_A1:case Cr.EAC_R11:return t.UNSIGNED_BYTE;case Cr.EAC_R11SN:return t.BYTE;case Cr.EAC_RG11:return t.UNSIGNED_BYTE;case Cr.EAC_RG11SN:return t.BYTE;case Cr.PVRTC_RGB2:case Cr.PVRTC_RGBA2:case Cr.PVRTC_RGB4:case Cr.PVRTC_RGBA4:case Cr.PVRTC2_2BPP:case Cr.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case Cr.ASTC_RGBA_4X4:case Cr.ASTC_RGBA_5X4:case Cr.ASTC_RGBA_5X5:case Cr.ASTC_RGBA_6X5:case Cr.ASTC_RGBA_6X6:case Cr.ASTC_RGBA_8X5:case Cr.ASTC_RGBA_8X6:case Cr.ASTC_RGBA_8X8:case Cr.ASTC_RGBA_10X5:case Cr.ASTC_RGBA_10X6:case Cr.ASTC_RGBA_10X8:case Cr.ASTC_RGBA_10X10:case Cr.ASTC_RGBA_12X10:case Cr.ASTC_RGBA_12X12:case Cr.ASTC_SRGBA_4X4:case Cr.ASTC_SRGBA_5X4:case Cr.ASTC_SRGBA_5X5:case Cr.ASTC_SRGBA_6X5:case Cr.ASTC_SRGBA_6X6:case Cr.ASTC_SRGBA_8X5:case Cr.ASTC_SRGBA_8X6:case Cr.ASTC_SRGBA_8X8:case Cr.ASTC_SRGBA_10X5:case Cr.ASTC_SRGBA_10X6:case Cr.ASTC_SRGBA_10X8:case Cr.ASTC_SRGBA_10X10:case Cr.ASTC_SRGBA_12X10:case Cr.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function nX(e,t){switch(e){case wr.BOOL:return t.BOOL;case wr.BOOL2:return t.BOOL_VEC2;case wr.BOOL3:return t.BOOL_VEC3;case wr.BOOL4:return t.BOOL_VEC4;case wr.INT:return t.INT;case wr.INT2:return t.INT_VEC2;case wr.INT3:return t.INT_VEC3;case wr.INT4:return t.INT_VEC4;case wr.UINT:return t.UNSIGNED_INT;case wr.FLOAT:return t.FLOAT;case wr.FLOAT2:return t.FLOAT_VEC2;case wr.FLOAT3:return t.FLOAT_VEC3;case wr.FLOAT4:return t.FLOAT_VEC4;case wr.MAT2:return t.FLOAT_MAT2;case wr.MAT2X3:return t.FLOAT_MAT2x3;case wr.MAT2X4:return t.FLOAT_MAT2x4;case wr.MAT3X2:return t.FLOAT_MAT3x2;case wr.MAT3:return t.FLOAT_MAT3;case wr.MAT3X4:return t.FLOAT_MAT3x4;case wr.MAT4X2:return t.FLOAT_MAT4x2;case wr.MAT4X3:return t.FLOAT_MAT4x3;case wr.MAT4:return t.FLOAT_MAT4;case wr.SAMPLER2D:return t.SAMPLER_2D;case wr.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case wr.SAMPLER3D:return t.SAMPLER_3D;case wr.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),wr.UNKNOWN}}function iX(e,t){switch(e){case t.BOOL:return wr.BOOL;case t.BOOL_VEC2:return wr.BOOL2;case t.BOOL_VEC3:return wr.BOOL3;case t.BOOL_VEC4:return wr.BOOL4;case t.INT:return wr.INT;case t.INT_VEC2:return wr.INT2;case t.INT_VEC3:return wr.INT3;case t.INT_VEC4:return wr.INT4;case t.UNSIGNED_INT:return wr.UINT;case t.UNSIGNED_INT_VEC2:return wr.UINT2;case t.UNSIGNED_INT_VEC3:return wr.UINT3;case t.UNSIGNED_INT_VEC4:return wr.UINT4;case t.FLOAT:return wr.FLOAT;case t.FLOAT_VEC2:return wr.FLOAT2;case t.FLOAT_VEC3:return wr.FLOAT3;case t.FLOAT_VEC4:return wr.FLOAT4;case t.FLOAT_MAT2:return wr.MAT2;case t.FLOAT_MAT2x3:return wr.MAT2X3;case t.FLOAT_MAT2x4:return wr.MAT2X4;case t.FLOAT_MAT3x2:return wr.MAT3X2;case t.FLOAT_MAT3:return wr.MAT3;case t.FLOAT_MAT3x4:return wr.MAT3X4;case t.FLOAT_MAT4x2:return wr.MAT4X2;case t.FLOAT_MAT4x3:return wr.MAT4X3;case t.FLOAT_MAT4:return wr.MAT4;case t.SAMPLER_2D:return wr.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return wr.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return wr.SAMPLER3D;case t.SAMPLER_CUBE:return wr.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),wr.UNKNOWN}}function rX(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function oX(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var aX,sX=[512,513,514,515,516,517,518,519],cX=[0,7680,7681,7682,7683,5386,34055,34056],lX=[32774,32778,32779,32775,32776],uX=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(aX||(aX={}));var hX=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},fX=function(e){function t(){var t;return(t=e.call(this,aX.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new po,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return F(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(hX),_X=function(e){function t(){var t;return(t=e.call(this,aX.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new fa,t}return F(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},t}(hX),pX=function(e){function t(){var t;return(t=e.call(this,aX.DRAW)||this).drawInfo=new Io,t}return F(t,e),t.prototype.clear=function(){},t}(hX),dX=function(e){function t(){var t;return(t=e.call(this,aX.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return F(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(hX),mX=function(e){function t(){var t;return(t=e.call(this,aX.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return F(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(hX),vX=function(){function e(){this.cmds=new Xe(1),this.beginRenderPassCmds=new Xe(1),this.bindStatesCmds=new Xe(1),this.drawCmds=new Xe(1),this.updateBufferCmds=new Xe(1),this.copyBufferToTextureCmds=new Xe(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function gX(e,t,n,i,r){if(t.usage&Rr.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),xX.gpuInputAssembler=null,l.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),l.glArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),xX.gpuInputAssembler=null,l.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),l.glElementArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==t.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,t.glBuffer),l.glUniformBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function yX(e,t){var n=e.gl;t.glInternalFmt=function(e,t){switch(e){case Cr.A8:return t.ALPHA;case Cr.L8:return t.LUMINANCE;case Cr.LA8:return t.LUMINANCE_ALPHA;case Cr.R8:return t.R8;case Cr.R8SN:return t.R8_SNORM;case Cr.R8UI:return t.R8UI;case Cr.R8I:return t.R8I;case Cr.RG8:return t.RG8;case Cr.RG8SN:return t.RG8_SNORM;case Cr.RG8UI:return t.RG8UI;case Cr.RG8I:return t.RG8I;case Cr.RGB8:return t.RGB8;case Cr.RGB8SN:return t.RGB8_SNORM;case Cr.RGB8UI:return t.RGB8UI;case Cr.RGB8I:return t.RGB8I;case Cr.BGRA8:case Cr.RGBA8:return t.RGBA8;case Cr.RGBA8SN:return t.RGBA8_SNORM;case Cr.RGBA8UI:return t.RGBA8UI;case Cr.RGBA8I:return t.RGBA8I;case Cr.R16I:return t.R16I;case Cr.R16UI:return t.R16UI;case Cr.R16F:return t.R16F;case Cr.RG16I:return t.RG16I;case Cr.RG16UI:return t.RG16UI;case Cr.RG16F:return t.RG16F;case Cr.RGB16I:return t.RGB16I;case Cr.RGB16UI:return t.RGB16UI;case Cr.RGB16F:return t.RGB16F;case Cr.RGBA16I:return t.RGBA16I;case Cr.RGBA16UI:return t.RGBA16UI;case Cr.RGBA16F:return t.RGBA16F;case Cr.R32I:return t.R32I;case Cr.R32UI:return t.R32UI;case Cr.R32F:return t.R32F;case Cr.RG32I:return t.RG32I;case Cr.RG32UI:return t.RG32UI;case Cr.RG32F:return t.RG32F;case Cr.RGB32I:return t.RGB32I;case Cr.RGB32UI:return t.RGB32UI;case Cr.RGB32F:return t.RGB32F;case Cr.RGBA32I:return t.RGBA32I;case Cr.RGBA32UI:return t.RGBA32UI;case Cr.RGBA32F:return t.RGBA32F;case Cr.R5G6B5:return t.RGB565;case Cr.RGB5A1:return t.RGB5_A1;case Cr.RGBA4:return t.RGBA4;case Cr.SRGB8:return t.SRGB8;case Cr.SRGB8_A8:return t.SRGB8_ALPHA8;case Cr.RGB10A2:return t.RGB10_A2;case Cr.RGB10A2UI:return t.RGB10_A2UI;case Cr.R11G11B10F:return t.R11F_G11F_B10F;case Cr.DEPTH:return t.DEPTH_COMPONENT32F;case Cr.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case Cr.BC1:return Qq.COMPRESSED_RGB_S3TC_DXT1_EXT;case Cr.BC1_ALPHA:return Qq.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Cr.BC1_SRGB:return Qq.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Cr.BC1_SRGB_ALPHA:return Qq.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Cr.BC2:return Qq.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Cr.BC2_SRGB:return Qq.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Cr.BC3:return Qq.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Cr.BC3_SRGB:return Qq.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Cr.ETC_RGB8:return Qq.COMPRESSED_RGB_ETC1_WEBGL;case Cr.ETC2_RGB8:return Qq.COMPRESSED_RGB8_ETC2;case Cr.ETC2_SRGB8:return Qq.COMPRESSED_SRGB8_ETC2;case Cr.ETC2_RGB8_A1:return Qq.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_SRGB8_A1:return Qq.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_RGBA8:return Qq.COMPRESSED_RGBA8_ETC2_EAC;case Cr.ETC2_SRGB8_A8:return Qq.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Cr.EAC_R11:return Qq.COMPRESSED_R11_EAC;case Cr.EAC_R11SN:return Qq.COMPRESSED_SIGNED_R11_EAC;case Cr.EAC_RG11:return Qq.COMPRESSED_RG11_EAC;case Cr.EAC_RG11SN:return Qq.COMPRESSED_SIGNED_RG11_EAC;case Cr.PVRTC_RGB2:return Qq.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGBA2:return Qq.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGB4:return Qq.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Cr.PVRTC_RGBA4:return Qq.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Cr.ASTC_RGBA_4X4:return Qq.COMPRESSED_RGBA_ASTC_4x4_KHR;case Cr.ASTC_RGBA_5X4:return Qq.COMPRESSED_RGBA_ASTC_5x4_KHR;case Cr.ASTC_RGBA_5X5:return Qq.COMPRESSED_RGBA_ASTC_5x5_KHR;case Cr.ASTC_RGBA_6X5:return Qq.COMPRESSED_RGBA_ASTC_6x5_KHR;case Cr.ASTC_RGBA_6X6:return Qq.COMPRESSED_RGBA_ASTC_6x6_KHR;case Cr.ASTC_RGBA_8X5:return Qq.COMPRESSED_RGBA_ASTC_8x5_KHR;case Cr.ASTC_RGBA_8X6:return Qq.COMPRESSED_RGBA_ASTC_8x6_KHR;case Cr.ASTC_RGBA_8X8:return Qq.COMPRESSED_RGBA_ASTC_8x8_KHR;case Cr.ASTC_RGBA_10X5:return Qq.COMPRESSED_RGBA_ASTC_10x5_KHR;case Cr.ASTC_RGBA_10X6:return Qq.COMPRESSED_RGBA_ASTC_10x6_KHR;case Cr.ASTC_RGBA_10X8:return Qq.COMPRESSED_RGBA_ASTC_10x8_KHR;case Cr.ASTC_RGBA_10X10:return Qq.COMPRESSED_RGBA_ASTC_10x10_KHR;case Cr.ASTC_RGBA_12X10:return Qq.COMPRESSED_RGBA_ASTC_12x10_KHR;case Cr.ASTC_RGBA_12X12:return Qq.COMPRESSED_RGBA_ASTC_12x12_KHR;case Cr.ASTC_SRGBA_4X4:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Cr.ASTC_SRGBA_5X4:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Cr.ASTC_SRGBA_5X5:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Cr.ASTC_SRGBA_6X5:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Cr.ASTC_SRGBA_6X6:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Cr.ASTC_SRGBA_8X5:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Cr.ASTC_SRGBA_8X6:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Cr.ASTC_SRGBA_8X8:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Cr.ASTC_SRGBA_10X5:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Cr.ASTC_SRGBA_10X6:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Cr.ASTC_SRGBA_10X8:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Cr.ASTC_SRGBA_10X10:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Cr.ASTC_SRGBA_12X10:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Cr.ASTC_SRGBA_12X12:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glFormat=function(e,t){switch(e){case Cr.A8:return t.ALPHA;case Cr.L8:return t.LUMINANCE;case Cr.LA8:return t.LUMINANCE_ALPHA;case Cr.R8:case Cr.R8SN:return t.RED;case Cr.R8UI:case Cr.R8I:return t.RED;case Cr.RG8:case Cr.RG8SN:case Cr.RG8UI:case Cr.RG8I:return t.RG;case Cr.RGB8:case Cr.RGB8SN:case Cr.RGB8UI:case Cr.RGB8I:return t.RGB;case Cr.BGRA8:case Cr.RGBA8:case Cr.RGBA8SN:case Cr.RGBA8UI:case Cr.RGBA8I:return t.RGBA;case Cr.R16UI:case Cr.R16I:case Cr.R16F:return t.RED;case Cr.RG16UI:case Cr.RG16I:case Cr.RG16F:return t.RG;case Cr.RGB16UI:case Cr.RGB16I:case Cr.RGB16F:return t.RGB;case Cr.RGBA16UI:case Cr.RGBA16I:case Cr.RGBA16F:return t.RGBA;case Cr.R32UI:case Cr.R32I:case Cr.R32F:return t.RED;case Cr.RG32UI:case Cr.RG32I:case Cr.RG32F:return t.RG;case Cr.RGB32UI:case Cr.RGB32I:case Cr.RGB32F:return t.RGB;case Cr.RGBA32UI:case Cr.RGBA32I:case Cr.RGBA32F:case Cr.RGB10A2:return t.RGBA;case Cr.R11G11B10F:case Cr.R5G6B5:return t.RGB;case Cr.RGB5A1:case Cr.RGBA4:return t.RGBA;case Cr.SRGB8:return t.RGB;case Cr.SRGB8_A8:return t.RGBA;case Cr.DEPTH:return t.DEPTH_COMPONENT;case Cr.DEPTH_STENCIL:return t.DEPTH_STENCIL;case Cr.BC1:return Qq.COMPRESSED_RGB_S3TC_DXT1_EXT;case Cr.BC1_ALPHA:return Qq.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Cr.BC1_SRGB:return Qq.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Cr.BC1_SRGB_ALPHA:return Qq.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Cr.BC2:return Qq.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Cr.BC2_SRGB:return Qq.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Cr.BC3:return Qq.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Cr.BC3_SRGB:return Qq.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Cr.ETC_RGB8:return Qq.COMPRESSED_RGB_ETC1_WEBGL;case Cr.ETC2_RGB8:return Qq.COMPRESSED_RGB8_ETC2;case Cr.ETC2_SRGB8:return Qq.COMPRESSED_SRGB8_ETC2;case Cr.ETC2_RGB8_A1:return Qq.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_SRGB8_A1:return Qq.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Cr.ETC2_RGBA8:return Qq.COMPRESSED_RGBA8_ETC2_EAC;case Cr.ETC2_SRGB8_A8:return Qq.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Cr.EAC_R11:return Qq.COMPRESSED_R11_EAC;case Cr.EAC_R11SN:return Qq.COMPRESSED_SIGNED_R11_EAC;case Cr.EAC_RG11:return Qq.COMPRESSED_RG11_EAC;case Cr.EAC_RG11SN:return Qq.COMPRESSED_SIGNED_RG11_EAC;case Cr.PVRTC_RGB2:return Qq.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGBA2:return Qq.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Cr.PVRTC_RGB4:return Qq.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Cr.PVRTC_RGBA4:return Qq.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Cr.ASTC_RGBA_4X4:return Qq.COMPRESSED_RGBA_ASTC_4x4_KHR;case Cr.ASTC_RGBA_5X4:return Qq.COMPRESSED_RGBA_ASTC_5x4_KHR;case Cr.ASTC_RGBA_5X5:return Qq.COMPRESSED_RGBA_ASTC_5x5_KHR;case Cr.ASTC_RGBA_6X5:return Qq.COMPRESSED_RGBA_ASTC_6x5_KHR;case Cr.ASTC_RGBA_6X6:return Qq.COMPRESSED_RGBA_ASTC_6x6_KHR;case Cr.ASTC_RGBA_8X5:return Qq.COMPRESSED_RGBA_ASTC_8x5_KHR;case Cr.ASTC_RGBA_8X6:return Qq.COMPRESSED_RGBA_ASTC_8x6_KHR;case Cr.ASTC_RGBA_8X8:return Qq.COMPRESSED_RGBA_ASTC_8x8_KHR;case Cr.ASTC_RGBA_10X5:return Qq.COMPRESSED_RGBA_ASTC_10x5_KHR;case Cr.ASTC_RGBA_10X6:return Qq.COMPRESSED_RGBA_ASTC_10x6_KHR;case Cr.ASTC_RGBA_10X8:return Qq.COMPRESSED_RGBA_ASTC_10x8_KHR;case Cr.ASTC_RGBA_10X10:return Qq.COMPRESSED_RGBA_ASTC_10x10_KHR;case Cr.ASTC_RGBA_12X10:return Qq.COMPRESSED_RGBA_ASTC_12x10_KHR;case Cr.ASTC_RGBA_12X12:return Qq.COMPRESSED_RGBA_ASTC_12x12_KHR;case Cr.ASTC_SRGBA_4X4:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Cr.ASTC_SRGBA_5X4:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Cr.ASTC_SRGBA_5X5:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Cr.ASTC_SRGBA_6X5:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Cr.ASTC_SRGBA_6X6:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Cr.ASTC_SRGBA_8X5:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Cr.ASTC_SRGBA_8X6:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Cr.ASTC_SRGBA_8X8:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Cr.ASTC_SRGBA_10X5:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Cr.ASTC_SRGBA_10X6:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Cr.ASTC_SRGBA_10X8:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Cr.ASTC_SRGBA_10X10:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Cr.ASTC_SRGBA_12X10:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Cr.ASTC_SRGBA_12X12:return Qq.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=tX(t.format,n);var i=t.width,r=t.height;switch(t.type){case Dr.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&A(9100,o,e.capabilities.maxTextureSize),t.samples===Lr.ONE){if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),pa[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=Sa(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,t.mipLevel,t.glInternalFmt,i,r)}}else t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Dr.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>e.capabilities.maxCubeMapTextureSize&&A(9100,u,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),pa[t.format].isCompressed)for(var f=0;f<t.mipLevel;++f){for(var _=Sa(t.format,i,r,1),p=new Uint8Array(_),d=0;d<6;++d)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+d,f,t.glInternalFmt,i,r,0,p);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Dr.TEX2D,t.glTarget=n.TEXTURE_2D}}function SX(e,t){t.glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null)}var xX={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function TX(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),xX.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=t.colorAttachments[u];if(h.format!==Cr.UNKNOWN)switch(h.loadOp){case Wr.LOAD:break;case Wr.CLEAR:if(c.bs.targets[0].blendColorMask!==Vr.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)eX[0]=r[u].x,eX[1]=r[u].y,eX[2]=r[u].z,eX[3]=r[u].w,s.clearBufferfv(s.COLOR,u,eX);else{var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT}break;case Wr.DISCARD:xX.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==Cr.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Wr.LOAD:break;case Wr.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Wr.DISCARD:xX.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(pa[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Wr.LOAD:break;case Wr.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Wr.DISCARD:xX.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&xX.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,xX.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var _=c.bs.targets[0].blendColorMask;if(_!==Vr.ALL){var p=(_&Vr.R)!==Vr.NONE,d=(_&Vr.G)!==Vr.NONE,m=(_&Vr.B)!==Vr.NONE,v=(_&Vr.A)!==Vr.NONE;s.colorMask(p,d,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function EX(e,t,n,i,r,o){var a=e.gl,s=e.stateCache,c=t&&t.gpuShader,l=!1;if(t&&xX.gpuPipelineState!==t){if(xX.gpuPipelineState=t,xX.glPrimitive=t.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(a.useProgram(u),s.glProgram=u,l=!0)}var h=t.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case $r.NONE:a.disable(a.CULL_FACE);break;case $r.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case $r.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}e.stateCache.rs.cullMode=h.cullMode}var f=h.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==f&&(a.frontFace(f?a.CCW:a.CW),e.stateCache.rs.isFrontFaceCCW=f),e.stateCache.rs.depthBias===h.depthBias&&e.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(a.polygonOffset(h.depthBias,h.depthBiasSlop),e.stateCache.rs.depthBias=h.depthBias,e.stateCache.rs.depthBiasSlop=h.depthBiasSlop),e.stateCache.rs.lineWidth!==h.lineWidth&&(a.lineWidth(h.lineWidth),e.stateCache.rs.lineWidth=h.lineWidth)}var _=t.dss;_&&(s.dss.depthTest!==_.depthTest&&(_.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),s.dss.depthTest=_.depthTest),s.dss.depthWrite!==_.depthWrite&&(a.depthMask(_.depthWrite),s.dss.depthWrite=_.depthWrite),s.dss.depthFunc!==_.depthFunc&&(a.depthFunc(sX[_.depthFunc]),s.dss.depthFunc=_.depthFunc),s.dss.stencilTestFront===_.stencilTestFront&&s.dss.stencilTestBack===_.stencilTestBack||(_.stencilTestFront||_.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),s.dss.stencilTestFront=_.stencilTestFront,s.dss.stencilTestBack=_.stencilTestBack),s.dss.stencilFuncFront===_.stencilFuncFront&&s.dss.stencilRefFront===_.stencilRefFront&&s.dss.stencilReadMaskFront===_.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,sX[_.stencilFuncFront],_.stencilRefFront,_.stencilReadMaskFront),s.dss.stencilFuncFront=_.stencilFuncFront,s.dss.stencilRefFront=_.stencilRefFront,s.dss.stencilReadMaskFront=_.stencilReadMaskFront),s.dss.stencilFailOpFront===_.stencilFailOpFront&&s.dss.stencilZFailOpFront===_.stencilZFailOpFront&&s.dss.stencilPassOpFront===_.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,cX[_.stencilFailOpFront],cX[_.stencilZFailOpFront],cX[_.stencilPassOpFront]),s.dss.stencilFailOpFront=_.stencilFailOpFront,s.dss.stencilZFailOpFront=_.stencilZFailOpFront,s.dss.stencilPassOpFront=_.stencilPassOpFront),s.dss.stencilWriteMaskFront!==_.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,_.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=_.stencilWriteMaskFront),s.dss.stencilFuncBack===_.stencilFuncBack&&s.dss.stencilRefBack===_.stencilRefBack&&s.dss.stencilReadMaskBack===_.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,sX[_.stencilFuncBack],_.stencilRefBack,_.stencilReadMaskBack),s.dss.stencilFuncBack=_.stencilFuncBack,s.dss.stencilRefBack=_.stencilRefBack,s.dss.stencilReadMaskBack=_.stencilReadMaskBack),s.dss.stencilFailOpBack===_.stencilFailOpBack&&s.dss.stencilZFailOpBack===_.stencilZFailOpBack&&s.dss.stencilPassOpBack===_.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,cX[_.stencilFailOpBack],cX[_.stencilZFailOpBack],cX[_.stencilPassOpBack]),s.dss.stencilFailOpBack=_.stencilFailOpBack,s.dss.stencilZFailOpBack=_.stencilZFailOpBack,s.dss.stencilPassOpBack=_.stencilPassOpBack),s.dss.stencilWriteMaskBack!==_.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,_.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=_.stencilWriteMaskBack));var p=t.bs;if(p){s.bs.isA2C!==p.isA2C&&(p.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=p.isA2C),s.bs.blendColor.x===p.blendColor.x&&s.bs.blendColor.y===p.blendColor.y&&s.bs.blendColor.z===p.blendColor.z&&s.bs.blendColor.w===p.blendColor.w||(a.blendColor(p.blendColor.x,p.blendColor.y,p.blendColor.z,p.blendColor.w),s.bs.blendColor.x=p.blendColor.x,s.bs.blendColor.y=p.blendColor.y,s.bs.blendColor.z=p.blendColor.z,s.bs.blendColor.w=p.blendColor.w);var m=p.targets[0],v=s.bs.targets[0];v.blend!==m.blend&&(m.blend?a.enable(a.BLEND):a.disable(a.BLEND),v.blend=m.blend),v.blendEq===m.blendEq&&v.blendAlphaEq===m.blendAlphaEq||(a.blendEquationSeparate(lX[m.blendEq],lX[m.blendAlphaEq]),v.blendEq=m.blendEq,v.blendAlphaEq=m.blendAlphaEq),v.blendSrc===m.blendSrc&&v.blendDst===m.blendDst&&v.blendSrcAlpha===m.blendSrcAlpha&&v.blendDstAlpha===m.blendDstAlpha||(a.blendFuncSeparate(uX[m.blendSrc],uX[m.blendDst],uX[m.blendSrcAlpha],uX[m.blendDstAlpha]),v.blendSrc=m.blendSrc,v.blendDst=m.blendDst,v.blendSrcAlpha=m.blendSrcAlpha,v.blendDstAlpha=m.blendDstAlpha),v.blendColorMask!==m.blendColorMask&&(a.colorMask((m.blendColorMask&Vr.R)!==Vr.NONE,(m.blendColorMask&Vr.G)!==Vr.NONE,(m.blendColorMask&Vr.B)!==Vr.NONE,(m.blendColorMask&Vr.A)!==Vr.NONE),v.blendColorMask=m.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){for(var g=c.glBlocks.length,y=t.gpuPipelineLayout.dynamicOffsetIndices,S=0;S<g;S++){var x=c.glBlocks[S],T=i[x.set],E=T&&T.descriptorIndices[x.binding],b=E>=0&&T.gpuDescriptors[E];if(b&&b.gpuBuffer){var C=y[x.set],A=C&&C[x.binding],w=b.gpuBuffer.glOffset;A>=0&&(w+=r[A]),s.glBindUBOs[x.glBinding]===b.gpuBuffer.glBuffer&&s.glBindUBOOffsets[x.glBinding]===w||(w?a.bindBufferRange(a.UNIFORM_BUFFER,x.glBinding,b.gpuBuffer.glBuffer,w,b.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,x.glBinding,b.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[x.glBinding]=b.gpuBuffer.glBuffer,s.glBindUBOOffsets[x.glBinding]=w)}else d("Buffer binding '"+x.name+"' at set "+x.set+" binding "+x.binding+" is not bounded")}for(var R=c.glSamplerTextures.length,I=0;I<R;I++)for(var P=c.glSamplerTextures[I],O=i[P.set],D=O&&O.descriptorIndices[P.binding],M=D>=0&&O.gpuDescriptors[D],N=0;N<P.units.length;N++){var L=P.units[N],B=s.glTexUnits[L];if(M&&M.gpuTexture&&M.gpuSampler){if(M.gpuTexture&&M.gpuTexture.size>0){var F=M.gpuTexture;B.glTexture!==F.glTexture&&(s.texUnit!==L&&(a.activeTexture(a.TEXTURE0+L),s.texUnit=L),F.glTexture?a.bindTexture(F.glTarget,F.glTexture):a.bindTexture(F.glTarget,e.nullTex2D.gpuTexture.glTexture),B.glTexture=F.glTexture);var z=M.gpuSampler;s.glSamplerUnits[L]!==z.glSampler&&(a.bindSampler(L,z.glSampler),s.glSamplerUnits[L]=z.glSampler)}M=O.gpuDescriptors[++D]}else d("Sampler binding '"+P.name+"' at set "+P.set+" binding "+P.binding+" index "+N+" is not bounded")}}if(n&&c&&(l||xX.gpuInputAssembler!==n))if(xX.gpuInputAssembler=n,e.extensions.useVAO){var U=n.glVAOs.get(c.glProgram);if(!U){var k;U=a.createVertexArray(),n.glVAOs.set(c.glProgram,U),a.bindVertexArray(U),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var G=0;G<c.glInputs.length;G++){var H=c.glInputs[G];k=null;for(var V=0;V<n.glAttribs.length;V++){var j=n.glAttribs[V];if(j.name===H.name){k=j;break}}if(k){s.glArrayBuffer!==k.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,k.glBuffer),s.glArrayBuffer=k.glBuffer);for(var W=0;W<k.componentCount;++W){var q=H.glLoc+W,X=k.offset+k.size*W;a.enableVertexAttribArray(q),s.glCurrentAttribLocs[q]=!0,a.vertexAttribPointer(q,k.count,k.glType,k.isNormalized,k.stride,X),a.vertexAttribDivisor(q,k.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Y.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==U&&(a.bindVertexArray(U),s.glVAO=U)}else{for(var K=0;K<e.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var Q=0;Q<c.glInputs.length;Q++){for(var Z=c.glInputs[Q],J=null,$=0;$<n.glAttribs.length;$++){var ee=n.glAttribs[$];if(ee.name===Z.name){J=ee;break}}if(J){s.glArrayBuffer!==J.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,J.glBuffer),s.glArrayBuffer=J.glBuffer);for(var te=0;te<J.componentCount;++te){var ne=Z.glLoc+te,ie=J.offset+J.size*te;!s.glEnabledAttribLocs[ne]&&ne>=0&&(a.enableVertexAttribArray(ne),s.glEnabledAttribLocs[ne]=!0),s.glCurrentAttribLocs[ne]=!0,a.vertexAttribPointer(ne,J.count,J.glType,J.isNormalized,J.stride,ie),a.vertexAttribDivisor(ne,J.isInstanced?1:0)}}}var re=n.gpuIndexBuffer;re&&s.glElementArrayBuffer!==re.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,re.glBuffer),s.glElementArrayBuffer=re.glBuffer);for(var oe=0;oe<e.capabilities.maxVertexAttributes;++oe)s.glEnabledAttribLocs[oe]!==s.glCurrentAttribLocs[oe]&&(a.disableVertexAttribArray(oe),s.glEnabledAttribLocs[oe]=!1)}if(t&&t.dynamicStates.length)for(var ae=t.dynamicStates.length,se=0;se<ae;se++)switch(t.dynamicStates[se]){case eo.LINE_WIDTH:s.rs.lineWidth!==o.lineWidth&&(a.lineWidth(o.lineWidth),s.rs.lineWidth=o.lineWidth);break;case eo.DEPTH_BIAS:s.rs.depthBias===o.depthBiasConstant&&s.rs.depthBiasSlop===o.depthBiasSlope||(a.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),s.rs.depthBias=o.depthBiasConstant,s.rs.depthBiasSlop=o.depthBiasSlope);break;case eo.BLEND_CONSTANTS:var ce=o.blendConstant;s.bs.blendColor.x===ce.x&&s.bs.blendColor.y===ce.y&&s.bs.blendColor.z===ce.z&&s.bs.blendColor.w===ce.w||(a.blendColor(ce.x,ce.y,ce.z,ce.w),s.bs.blendColor.copy(ce));break;case eo.STENCIL_WRITE_MASK:var le=o.stencilStatesFront,ue=o.stencilStatesBack;s.dss.stencilWriteMaskFront!==le.writeMask&&(a.stencilMaskSeparate(a.FRONT,le.writeMask),s.dss.stencilWriteMaskFront=le.writeMask),s.dss.stencilWriteMaskBack!==ue.writeMask&&(a.stencilMaskSeparate(a.BACK,ue.writeMask),s.dss.stencilWriteMaskBack=ue.writeMask);break;case eo.STENCIL_COMPARE_MASK:var he=o.stencilStatesFront,fe=o.stencilStatesBack;s.dss.stencilRefFront===he.reference&&s.dss.stencilReadMaskFront===he.compareMask||(a.stencilFuncSeparate(a.FRONT,sX[s.dss.stencilFuncFront],he.reference,he.compareMask),s.dss.stencilRefFront=he.reference,s.dss.stencilReadMaskFront=he.compareMask),s.dss.stencilRefBack===fe.reference&&s.dss.stencilReadMaskBack===fe.compareMask||(a.stencilFuncSeparate(a.BACK,sX[s.dss.stencilFuncBack],fe.reference,fe.compareMask),s.dss.stencilRefBack=fe.reference,s.dss.stencilReadMaskBack=fe.compareMask)}}function bX(e,t){var n=e.gl,i=xX.gpuInputAssembler,r=xX.glPrimitive,o=e.extensions.WEBGL_multi_draw;if(i){var a=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*a.stride;if(o)s.instancedDraw?o.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):o.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(o)s.instancedDraw?o.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):o.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(t.instanceCount)if(a){if(t.indexCount>0){var h=t.firstIndex*a.stride;n.drawElementsInstanced(r,t.indexCount,i.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(a){if(t.indexCount>0){var f=t.firstIndex*a.stride;n.drawElements(r,t.indexCount,i.glIndexType,f)}}else t.vertexCount>0&&n.drawArrays(r,t.firstVertex,t.vertexCount)}}var CX=new Array(aX.COUNT);function AX(e,t){CX.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=CX[i]++;switch(i){case aX.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];TX(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case aX.BIND_STATES:var a=t.bindStatesCmds.array[r];EX(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case aX.DRAW:bX(e,t.drawCmds.array[r].drawInfo);break;case aX.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];gX(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case aX.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];wX(e,c.buffers,c.gpuTexture,c.regions)}}}function wX(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=pa[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];s=f.texExtent.width,c=f.texExtent.height;var _=t[a++];u?n.glInternalFmt!==Qq.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,_):r.compressedTexImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,n.glInternalFmt,s,c,0,_):r.texSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,n.glType,_)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=t[a++];u?n.glInternalFmt!==Qq.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Nr.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var RX=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=Ln(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),IX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new RX,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Or.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&Rr.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),xX.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&Rr.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),xX.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&Rr.UNIFORM){t.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&t.size>0&&(t.glBuffer=s,e.stateCache.glUniformBuffer!==t.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&Rr.INDIRECT||t.usage&Rr.TRANSFER_DST||t.usage&Rr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE}(Jq.instance,this._gpuBuffer),Jq.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),xX.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),xX.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(Jq.instance,this._gpuBuffer),Jq.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&Or.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&Rr.VERTEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),xX.gpuInputAssembler=null,i.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):t.usage&Rr.INDEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),xX.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&Rr.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&Rr.INDIRECT||t.usage&Rr.TRANSFER_DST||t.usage&Rr.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(Jq.instance,this._gpuBuffer),Jq.instance.memoryStatus.bufferSize-=t,Jq.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&Rr.INDIRECT?0:e.byteLength,gX(Jq.instance,this._gpuBuffer,e,0,n))},L(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),t}(Aa),PX=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Xe(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),OX=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new PX(fX,1),this.bindStatesCmdPool=new PX(_X,1),this.drawCmdPool=new PX(pX,1),this.updateBufferCmdPool=new PX(dX,1),this.copyBufferToTextureCmdPool=new PX(mX,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),DX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new vX,t._cmdAllocator=new OX,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new fa,t._isStateInvalied=!1,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=Jq.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(fX);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=n;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(aX.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&to.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&to.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&to.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&to.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===oo.PRIMARY&&this._isInRenderPass||this._type===oo.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(pX);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(aX.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===oo.PRIMARY&&!this._isInRenderPass||this._type===oo.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(dX),a=0;e.usage&Rr.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(aX.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===oo.PRIMARY&&!this._isInRenderPass||this._type===oo.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(mX);r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(aX.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<i.cmdPackage.copyBufferToTextureCmds.length;++f){var _=i.cmdPackage.copyBufferToTextureCmds.array[f];++_.refCount,this.cmdPackage.copyBufferToTextureCmds.push(_)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(_X);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(aX.BIND_STATES),this._isStateInvalied=!1},t}(wa),MX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;n++){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(e){o=e},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(e){a=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=pa[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}i.drawBuffers(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(Jq.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=Jq.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)},L(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(Pa),NX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=tX(o.format,n),l=pa[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:pa[o.format].count,stride:s.stride,componentCount:oX(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(Jq.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=Jq.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next();!i.done;)e.gl.deleteVertexArray(i.value),i=n.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},L(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(Na),LX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&va)for(var f=0;f<h.count;f++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},L(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Ba),BX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},L(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Fa),FX=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],zX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:FX[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},L(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Va),UX=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){TX(Jq.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;bX(Jq.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=Jq.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=Jq.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&Rr.INDIRECT?0:t.byteLength,gX(Jq.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&wX(Jq.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];AX(Jq.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){EX(Jq.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(DX),kX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=0;t<e.length;t++){var n=e[t];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(ja),GX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},L(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(Wa),HX=function(e){function t(t,n){var i,r,o,a,s;return(i=e.call(this,t,n)||this)._gpuSampler=null,i._gpuSampler={glSampler:null,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},r=Jq.instance,o=i._gpuSampler,(s=(a=r.gl).createSampler())&&(o.minFilter===Fr.LINEAR||o.minFilter===Fr.ANISOTROPIC?o.mipFilter===Fr.LINEAR||o.mipFilter===Fr.ANISOTROPIC?o.glMinFilter=a.LINEAR_MIPMAP_LINEAR:o.mipFilter===Fr.POINT?o.glMinFilter=a.LINEAR_MIPMAP_NEAREST:o.glMinFilter=a.LINEAR:o.mipFilter===Fr.LINEAR||o.mipFilter===Fr.ANISOTROPIC?o.glMinFilter=a.NEAREST_MIPMAP_LINEAR:o.mipFilter===Fr.POINT?o.glMinFilter=a.NEAREST_MIPMAP_NEAREST:o.glMinFilter=a.NEAREST,o.magFilter===Fr.LINEAR||o.magFilter===Fr.ANISOTROPIC?o.glMagFilter=a.LINEAR:o.glMagFilter=a.NEAREST,o.glWrapS=$q[o.addressU],o.glWrapT=$q[o.addressV],o.glWrapR=$q[o.addressW],o.glSampler=s,a.samplerParameteri(s,a.TEXTURE_MIN_FILTER,o.glMinFilter),a.samplerParameteri(s,a.TEXTURE_MAG_FILTER,o.glMagFilter),a.samplerParameteri(s,a.TEXTURE_WRAP_S,o.glWrapS),a.samplerParameteri(s,a.TEXTURE_WRAP_T,o.glWrapT),a.samplerParameteri(s,a.TEXTURE_WRAP_R,o.glWrapR),a.samplerParameterf(s,a.TEXTURE_MIN_LOD,0),a.samplerParameterf(s,a.TEXTURE_MAX_LOD,1e3)),i}return F(t,e),t.prototype.destroy=function(){var e,t;this._gpuSampler&&(e=Jq.instance,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null)},L(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(qa),VX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case jr.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case jr.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}n.linkProgram(t.glProgram);for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));v("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var f=0;f<h;++f){var _=n.getActiveAttrib(t.glProgram,f);if(_){var p,m=_.name.indexOf("[");p=-1!==m?_.name.substr(0,m):_.name;var g=n.getAttribLocation(t.glProgram,p),y=iX(_.type,n),S=rX(_.type,n);t.glInputs[f]={name:p,type:y,stride:S,count:_.size,size:S*_.size,glType:_.type,glLoc:g}}}var x,T,E,b,C=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(C){t.glBlocks=new Array(C);for(var A=0;A<C;++A){var w=(x=n.getActiveUniformBlockName(t.glProgram,A)).indexOf("[");-1!==w&&(x=x.substr(0,w)),b=null;for(var R=0;R<t.blocks.length;R++)if(t.blocks[R].name===x){b=t.blocks[R];break}if(b){T=A,E=n.getActiveUniformBlockParameter(t.glProgram,T,n.UNIFORM_BLOCK_DATA_SIZE);var I=b.binding+(e.bindingMappingInfo.bufferOffsets[b.set]||0);n.uniformBlockBinding(t.glProgram,T,I),t.glBlocks[A]={set:b.set,binding:b.binding,idx:T,name:x,size:E,glBinding:I}}else d("Block '"+x+"' does not bound")}}for(var P=0;P<t.subpassInputs.length;++P){var O=t.subpassInputs[P];t.samplerTextures.push(new Fo(O.set,O.binding,O.name,wr.SAMPLER2D,O.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var D=0;D<t.samplerTextures.length;++D){var M=t.samplerTextures[D];t.glSamplerTextures[D]={set:M.set,binding:M.binding,name:M.name,type:M.type,count:M.count,units:[],glUnits:null,glType:nX(M.type,n),glLoc:null}}}for(var N=[],L=[],B=e.stateCache.texUnitCacheMap,F=0,z=0;z<t.blocks.length;++z)t.blocks[z].set===e.bindingMappingInfo.flexibleSet&&F++;for(var U=0,k=0;k<t.samplerTextures.length;++k){var G=t.samplerTextures[k],H=n.getUniformLocation(t.glProgram,G.name);if(H&&-1!==H.id&&(N.push(t.glSamplerTextures[k]),L.push(H)),void 0===B[G.name]){var V=G.binding+e.bindingMappingInfo.samplerOffsets[G.set]+U;G.set===e.bindingMappingInfo.flexibleSet&&(V-=F),B[G.name]=V%e.capabilities.maxTextureUnits,U+=G.count-1}}if(N.length){for(var j=[],W=0;W<N.length;++W){var q=N[W],X=B[q.name];if(void 0!==X){q.glLoc=L[W];for(var Y=0;Y<q.count;++Y){for(;j[X];)X=(X+1)%e.capabilities.maxTextureUnits;q.units.push(X),j[X]=!0}}}for(var K=0,Q=0;Q<N.length;++Q){var Z=N[Q];if(!Z.glLoc){for(Z.glLoc=L[Q];j[K];)K++;for(var J=0;J<Z.count;++J){for(;j[K];)K=(K+1)%e.capabilities.maxTextureUnits;void 0===B[Z.name]&&(B[Z.name]=K),Z.units.push(K),j[K]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var $=0;$<N.length;$++){var ee=N[$];ee.glUnits=new Int32Array(ee.units),n.uniform1iv(ee.glLoc,ee.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=N}}(Jq.instance,this._gpuShader)},n.destroy=function(){var e,t;this._gpuShader&&(e=Jq.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null)},L(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Xa),jX=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new To,this.scissorRect=new po(0,0,0,0),this.rs=new za,this.dss=new Ua,this.bs=new Ga,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,n){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},e}(),WX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e,t){"texture"in e?console.log("WebGL2 does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=ya(this._width)&&ya(this._height),this._size=xa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},yX(Jq.instance,this._gpuTexture),Jq.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(SX(Jq.instance,this._gpuTexture),Jq.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=xa(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Dr.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&A(9100,o,e.capabilities.maxTextureSize),t.samples===Lr.ONE){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),pa[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=Sa(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else SX(e,t),yX(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Dr.CUBE:t.type=Dr.CUBE,t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>e.capabilities.maxCubeMapTextureSize&&A(9100,u,e.capabilities.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),pa[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var _=0;_<t.mipLevel;++_){var p=Sa(t.format,i,r,1),d=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,_,t.glInternalFmt,i,r,0,d),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else SX(e,t),yX(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Dr.TEX2D,t.glTarget=n.TEXTURE_2D}}}(Jq.instance,this._gpuTexture),Jq.instance.memoryStatus.textureSize-=n,Jq.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(e){var t=new Do;t.format=e.format,t.usage=pa[e.format].hasDepth?Mr.DEPTH_STENCIL_ATTACHMENT:Mr.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},L(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(Ya),qX="webglcontextlost";function XX(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function YX(e){return{EXT_texture_filter_anisotropic:XX(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:XX(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:XX(e,"EXT_color_buffer_float"),WEBGL_multi_draw:XX(e,"WEBGL_multi_draw"),WEBGL_compressed_texture_etc1:XX(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:XX(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:XX(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:XX(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:XX(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:XX(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:XX(e,"WEBGL_debug_shaders"),WEBGL_lose_context:XX(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:XX(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:XX(e,"OES_texture_half_float_linear"),OES_texture_float_linear:XX(e,"OES_texture_float_linear"),useVAO:!0}}var KX,QX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new jX,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGL2ContextLostHandler=null,t._extensions=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(qX,this._onWebGLContextLost);var t=Jq.instance.gl;this.stateCache.initialize(Jq.instance.capabilities.maxTextureUnits,Jq.instance.capabilities.maxUniformBufferBindings,Jq.instance.capabilities.maxVertexAttributes),this._extensions=YX(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=Cr.RGBA8,i=Cr.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=Cr.DEPTH_STENCIL:r&&(i=Cr.DEPTH),this._colorTexture=new WX,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new WX,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=Jq.instance.createTexture(new Do(Dr.TEX2D,Mr.SAMPLED,Cr.RGBA8,2,2,Nr.NONE)),this.nullTexCube=Jq.instance.createTexture(new Do(Dr.CUBE,Mr.SAMPLED,Cr.RGBA8,2,2,Nr.NONE,6));var a=new xo;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),Jq.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,Jq.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(qX,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(v("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){b(11e3),p(e)},L(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(Ia),ZX=e("WebGL2Device",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t}F(t,e);var n=t.prototype;return n.initialize=function(e){Jq.setInstance(this),this._gfxAPI=Tr.WEBGL2,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:tt.ENABLE_TRANSPARENT_CANVAS,antialias:tt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",n)}catch(e){return null}return t}(Ra.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new sa(io.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new aa(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var n=t.getSupportedExtensions(),i="";if(n)for(var r,o=W(n);!(r=o()).done;)i+=r.value+" ";var a=YX(t);a.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var s=t.getParameter(t.VERSION);this._features.fill(!1),this._features[br.TEXTURE_FLOAT]=!0,this._features[br.TEXTURE_HALF_FLOAT]=!0,this._features[br.FORMAT_R11G11B10F]=!0,this._features[br.FORMAT_SRGB]=!0,this._features[br.FORMAT_RGB8]=!0,this._features[br.ELEMENT_INDEX_UINT]=!0,this._features[br.INSTANCED_ARRAYS]=!0,this._features[br.MULTIPLE_RENDER_TARGETS]=!0,this._features[br.BLEND_MINMAX]=!0,a.EXT_color_buffer_float&&(this._features[br.COLOR_FLOAT]=!0,this._features[br.COLOR_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[br.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[br.TEXTURE_HALF_FLOAT_LINEAR]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[br.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[br.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[br.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[br.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[br.FORMAT_ASTC]=!0,c+="astc "),v("WebGL2 device initialized."),v("RENDERER: "+this._renderer),v("VENDOR: "+this._vendor),v("VERSION: "+s),v("COMPRESSED_FORMAT: "+c),v("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===oo.PRIMARY?UX:DX);return t.initialize(e),t},n.createSwapchain=function(e){var t=new QX;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new IX;return t.initialize(e),t},n.createTexture=function(e){var t=new WX;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new Zq;return t.initialize(e),t},n.createShader=function(e){var t=new VX;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new NX;return t.initialize(e),t},n.createRenderPass=function(e){var t=new GX;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new MX;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new LX;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new BX;return t.initialize(e),t},n.createPipelineState=function(e){var t=new zX;return t.initialize(e),t},n.createQueue=function(e){var t=new kX;return t.initialize(e),t},n.getSampler=function(e){var t=qa.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new HX(e,t)),this._samplers.get(t)},n.getGlobalBarrier=function(e){var t=Ka.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new Ka(e,t)),this._globalBarriers.get(t)},n.getTextureBarrier=function(e){var t=Qa.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Qa(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){wX(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,f.texSubres.mipLevel),s=f.texOffset.x,c=f.texOffset.y,l=f.texExtent.width,u=f.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],f=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<f;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Nr.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},L(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),t}(Ra));i.WebGL2Device=ZX,function(e){e[e.positions=uo.ATTR_POSITION]="positions",e[e.normals=uo.ATTR_NORMAL]="normals",e[e.uvs=uo.ATTR_TEX_COORD]="uvs",e[e.colors=uo.ATTR_COLOR]="colors"}(KX||(KX={}));var JX,$X,eY,tY,nY,iY=function(){function e(){this._arrayBufferOrPaddings=[],this._length=0}var t=e.prototype;return t.setNextAlignment=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}},t.addBuffer=function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t},t.getLength=function(){return this._length},t.getCombined=function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer},e}(),rY=function(){function e(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>Rd.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new aY(this._mesh,i,this._mesh.struct.morph,t):this._subMeshRenderings[i]=new oY(this._mesh,i,this._mesh.struct.morph,t))}}}return e.prototype.createInstance=function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(uo.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(uo.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(uo.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=W(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}},e}(),oY=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[t];this._subMeshMorph=r,uY(e,t,i);var o=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=lY(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(t,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(t,i){for(var r=t.displacements[n],s=new Float32Array(e.data.buffer,e.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:t,morphTexture:i}}))}var t=e.prototype;return t.destroy=function(){for(var e,t=W(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()},t.createInstance=function(){var e=this,t=new cY(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=W(e._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case uo.ATTR_POSITION:a=Md;break;case uo.ATTR_NORMAL:a=Bd;break;case uo.ATTR_TANGENT:a=Ud;break;default:p("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(Rd.BINDING,t.buffer),n.update()},destroy:function(){}}},e}(),aY=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[t];uY(e,t,i),this._attributes=r.attributes.map((function(t,n){return{name:t,targets:r.targets.map((function(t){return{displacements:new Float32Array(e.data.buffer,e.data.byteOffset+t.displacements[n].offset,t.displacements[n].count)}}))}}))}return e.prototype.createInstance=function(){return new sY(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},L(e,[{key:"data",get:function(){return this._attributes}}]),e}(),sY=function(){function e(e,t,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new cY(n,0);var i=lY(n,t);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=i.create();return{attributeName:e.name,morphTexture:t}}))}var t=e.prototype;return t.setWeights=function(e){for(var t=0;t<this._attributes.length;++t){var n=this._attributes[t],i=n.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=e[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},t.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},t.adaptPipelineState=function(e){for(var t,n=W(this._attributes);!(t=n()).done;){var i=t.value,r=void 0;switch(i.attributeName){case uo.ATTR_POSITION:r=Md;break;case uo.ATTR_NORMAL:r=Bd;break;case uo.ATTR_TANGENT:r=Ud;break;default:p("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,i.morphTexture.sampler),e.bindTexture(r,i.morphTexture.texture))}e.bindBuffer(Rd.BINDING,this._morphUniforms.buffer),e.update()},t.destroy=function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()},e}(),cY=function(){function e(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(Rd.SIZE)),this._remoteBuffer=e.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,Rd.SIZE,Rd.SIZE))}var t=e.prototype;return t.destroy=function(){this._remoteBuffer.destroy()},t.setWeights=function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(Rd.OFFSET_OF_WEIGHTS+4*t,e[t],i.sys.isLittleEndian)},t.setMorphTextureInfo=function(e,t){this._localBuffer.setFloat32(Rd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,i.sys.isLittleEndian),this._localBuffer.setFloat32(Rd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,i.sys.isLittleEndian)},t.setVerticesCount=function(e){this._localBuffer.setFloat32(Rd.OFFSET_OF_VERTICES_COUNT,e,i.sys.isLittleEndian)},t.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},L(e,[{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function lY(e,t){var n,i,r,o;e.hasFeature(br.TEXTURE_FLOAT)?(n=t,r=16,i=uv.PixelFormat.RGBA32F,o=Float32Array):(n=4*t,r=4,i=uv.PixelFormat.RGBA8888,o=Uint8Array);var a=function(e){e<5&&(e=5);var t=Mn(Ln(e)),n=t>>1;return{width:1<<(1&t?n+1:n),height:1<<n}}(n),s=a.width,c=a.height;return{width:s,height:c,create:function(){var t=new ArrayBuffer(s*c*r),n=new Float32Array(t),a=o===Float32Array?n:new o(t),l=new Um({width:s,height:c,_data:a,_compressed:!1,format:i}),u=new uv;u.setFilters(uv.Filter.NEAREST,uv.Filter.NEAREST),u.setMipFilter(uv.Filter.NONE),u.setWrapMode(uv.WrapMode.CLAMP_TO_EDGE,uv.WrapMode.CLAMP_TO_EDGE,uv.WrapMode.CLAMP_TO_EDGE),u.image=l,u.getGFXTexture()||p("Unexpected: failed to create morph texture?");var h=e.getSampler(u.getSamplerInfo());return{get texture(){return u.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){u.destroy()},updatePixels:function(){u.uploadData(a)}}}}}function uY(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}function hY(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var fY=new yi,_Y=new yi,pY=new Uint8Array,dY=e("Mesh",sl("cc.Mesh")((nY=function(e){function t(){var t;return(t=e.call(this)||this).morphRendering=null,q(t,"_struct",eY,V(t)),q(t,"_hash",tY,V(t)),t._data=pY,t._initialized=!1,t._renderingSubMeshes=null,t._boneSpaceBounds=new Map,t._jointBufferIndices=null,t}F(t,e);var n=t.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var e=this._data.buffer,t=i.director.root.device,n=this._createVertexBuffers(t,e),r=[],o=0;o<this._struct.primitives.length;o++){var a=this._struct.primitives[o];if(0!==a.vertexBundelIndices.length){var s=null,c=null;if(a.indexView){var l=a.indexView,u=l.stride,h=l.length;if(4===u&&!t.hasFeature(br.ELEMENT_INDEX_UINT)){var f=this._struct.vertexBundles[a.vertexBundelIndices[0]].view.count;if(f>=65536){b(10001,f,65536);continue}u>>=1,h>>=1}s=t.createBuffer(new wo(Rr.INDEX,Or.DEVICE,h,u)),c=new(hY(l.stride))(e,l.offset,l.count),l.stride!==u&&(c=hY(u).from(c)),s.update(c)}var _=a.vertexBundelIndices.map((function(e){return n[e]})),p=[];if(a.vertexBundelIndices.length>0)for(var d=a.vertexBundelIndices[0],m=this._struct.vertexBundles[d].attributes,v=0;v<m.length;++v){var g=m[v];p[v]=new jo(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new QA(_,p,a.primitiveMode,s);y.mesh=this,y.subMeshIdx=o,r.push(y)}}this._renderingSubMeshes=r,this._struct.morph&&(this.morphRendering=function(e,t){return new rY(e,t)}(this,t))}},n.destroy=function(){return this.destroyRenderingMesh(),e.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(e,t){this.reset({struct:e,data:t})},n.reset=function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0},n.getBoneSpaceBounds=function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new zc(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,uo.ATTR_JOINTS),c=this.readAttribute(a,uo.ATTR_WEIGHTS),l=this.readAttribute(a,uo.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){yi.set(fY,l[3*h+0],l[3*h+1],l[3*h+2]);for(var f=0;f<4;++f){var _=4*h+f,p=s[_];if(!(0===c[_]||p>=i.length)){yi.transformMat4(_Y,fY,i[p]),n[p]=!0;var d=t[p];yi.min(d.center,d.center,_Y),yi.max(d.halfExtents,d.halfExtents,_Y)}}}}for(var m=0;m<i.length;m++){var v=t[m];n[m]?zc.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t},n.merge=function(e,t,n){if(n&&!this.validateMergingMesh(e))return!1;var i=new yi,r=t&&new Ai,o=t&&new zc;if(r&&t.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){a.maxPosition&&a.minPosition&&(yi.add(o.center,a.maxPosition,a.minPosition),yi.multiplyScalar(o.center,o.center,.5),yi.subtract(o.halfExtents,a.maxPosition,a.minPosition),yi.multiplyScalar(o.halfExtents,o.halfExtents,.5),zc.transform(o,o,t),yi.add(a.maxPosition,o.center,o.halfExtents),yi.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===uo.ATTR_POSITION||l.attributes[u].name===uo.ATTR_NORMAL){var h=l.attributes[u].format,f=new DataView(s.buffer,l.view.offset+mY(l.attributes,u)),_=yY(f,h),p=SY(f,h);if(!_||!p)continue;for(var d=l.view.count,m=l.view.stride,v=gY(h),g=0;g<d;g++){var y=g*m,S=y+v,x=S+v;switch(i.set(_(y),_(S),_(x)),l.attributes[u].name){case uo.ATTR_POSITION:i.transformMat4(t);break;case uo.ATTR_NORMAL:yi.transformQuat(i,i,r)}p(y,i.x),p(S,i.y),p(x,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var T,E,b,C,A,w=new iY,R=0,I=0,P=0,O=0,D=0,M=0,N=0,L=0,B=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var U=this._struct.vertexBundles[z],k=e._struct.vertexBundles[z];P=U.view.offset,O=k.view.offset,I=U.view.stride,R=U.view.count+k.view.count,T=new ArrayBuffer(R*I),E=new Uint8Array(T),P+=(b=this._data.subarray(P,P+U.view.length)).length,O+=(C=e._data.subarray(O,O+k.view.length)).length,E.set(b),D=0;for(var G,H=W(U.attributes);!(G=H()).done;){var V=G.value;N=0,B=!1;for(var j,q=W(k.attributes);!(j=q()).done;){var X=j.value;if(V.name===X.name&&V.format===X.format){B=!0;break}N+=pa[X.format].size}if(B){L=pa[V.format].size,M=U.view.length+D;for(var Y=0;Y<k.view.count;++Y){if(A=C.subarray(N,N+L),E.set(A,M),(V.name===uo.ATTR_POSITION||V.name===uo.ATTR_NORMAL)&&t){var K=new Float32Array(E.buffer,M,3);switch(i.set(K[0],K[1],K[2]),V.name){case uo.ATTR_POSITION:i.transformMat4(t);break;case uo.ATTR_NORMAL:yi.transformQuat(i,i,r)}K[0]=i.x,K[1]=i.y,K[2]=i.z}M+=U.view.stride,N+=k.view.stride}}D+=pa[V.format].size}F[z]={attributes:U.attributes,view:{offset:w.getLength(),length:T.byteLength,count:R,stride:I}},w.addBuffer(T)}for(var Q,Z,J,$=0,ee=2,te=0,ne=new Array(this._struct.primitives.length),ie=0;ie<this._struct.primitives.length;++ie){var re=this._struct.primitives[ie],oe=e._struct.primitives[ie];ne[ie]={primitiveMode:re.primitiveMode,vertexBundelIndices:re.vertexBundelIndices};for(var ae,se=W(re.vertexBundelIndices);!(ae=se()).done;){var ce=ae.value;te=Math.max(te,this._struct.vertexBundles[ce].view.count)}if(re.indexView&&oe.indexView){$=re.indexView.count,$+=oe.indexView.count,P=re.indexView.offset,O=oe.indexView.offset,ee=$<256?1:$<65536?2:4;var le=new ArrayBuffer($*ee);if(Q=2===ee?new Uint16Array(le):1===ee?new Uint8Array(le):new Uint32Array(le),Z=2===re.indexView.stride?new Uint16Array(this._data.buffer,P,re.indexView.count):1===re.indexView.stride?new Uint8Array(this._data.buffer,P,re.indexView.count):new Uint32Array(this._data.buffer,P,re.indexView.count),ee===re.indexView.stride)Q.set(Z);else for(var ue=0;ue<re.indexView.count;++ue)Q[ue]=Z[ue];P+=re.indexView.length,J=2===oe.indexView.stride?new Uint16Array(e._data.buffer,O,oe.indexView.count):1===oe.indexView.stride?new Uint8Array(e._data.buffer,O,oe.indexView.count):new Uint32Array(e._data.buffer,O,oe.indexView.count);for(var he=0;he<oe.indexView.count;++he)Q[re.indexView.count+he]=te+J[he];O+=oe.indexView.length,ne[ie].indexView={offset:w.getLength(),length:le.byteLength,count:$,stride:ee},w.setNextAlignment(ee),w.addBuffer(le)}}var fe={vertexBundles:F,primitives:ne,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return fe.minPosition&&e._struct.minPosition&&fe.maxPosition&&e._struct.maxPosition&&(t?(yi.add(o.center,e._struct.maxPosition,e._struct.minPosition),yi.multiplyScalar(o.center,o.center,.5),yi.subtract(o.halfExtents,e._struct.maxPosition,e._struct.minPosition),yi.multiplyScalar(o.halfExtents,o.halfExtents,.5),zc.transform(o,o,t),yi.add(i,o.center,o.halfExtents),yi.max(fe.maxPosition,fe.maxPosition,i),yi.subtract(i,o.center,o.halfExtents),yi.min(fe.minPosition,fe.minPosition,i)):(yi.min(fe.minPosition,fe.minPosition,e._struct.minPosition),yi.max(fe.maxPosition,fe.maxPosition,e._struct.maxPosition))),this.reset({struct:fe,data:new Uint8Array(w.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=e._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,o=e.attributes[t].format,a=ba(pa[o]);if(0!==r){var s=new DataView(n._data.buffer,e.view.offset+mY(e.attributes,t)),c=pa[o],l=yY(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),f=e.view.stride,_=0;_<r;++_)for(var p=0;p<u;++p)h[u*_+p]=l(f*_+h.BYTES_PER_ELEMENT*p);i=h}}})),i},n.copyAttribute=function(e,t,n,i,r){var o=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(o._data.buffer,e.view.offset+mY(e.attributes,t)),u=new DataView(n,r),h=pa[c],f=yY(l,c),_=SY(u,c);if(f&&_){for(var p=h.count,d=e.view.stride,m=gY(c),v=i,g=m,y=0;y<s;++y)for(var S=0;S<p;++S)_(v*y+g*S,f(d*y+m*S));a=!0}}else a=!0})),a},n.readIndices=function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)},n.copyIndices=function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?Cr.R8UI:2===n.indexView.stride?Cr.R16UI:Cr.R32UI,o=yY(new DataView(this._data.buffer),r),a=0;a<i;++a)t[a]=o(n.indexView.offset+pa[r].size*a);return!0},n._accessAttribute=function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=W(this._struct.primitives[e].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(e,t){return this._struct.vertexBundles.map((function(n){var i=e.createBuffer(new wo(Rr.VERTEX,Or.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(t,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.reset({struct:{vertexBundles:[],primitives:[]},data:pY})},L(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=Ma(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),t}(zu),eY=X(($X=nY).prototype,"_struct",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),tY=X($X.prototype,"_hash",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JX=$X))||JX);function mY(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=pa[r.format].size}return n}i.Mesh=dY;var vY=dh.isLittleEndian;function gY(e){var t=pa[e];return t.size/t.count}function yY(e,t){var n=pa[t],i=n.size/n.count;switch(n.type){case Ar.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,vY)};case 4:return function(t){return e.getUint32(t,vY)}}break;case Ar.SNORM:case Ar.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,vY)};case 4:return function(t){return e.getInt32(t,vY)}}break;case Ar.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,vY)};case 4:return function(t){return e.getUint32(t,vY)}}break;case Ar.FLOAT:return function(t){return e.getFloat32(t,vY)}}return null}function SY(e,t){var n=pa[t],i=n.size/n.count;switch(n.type){case Ar.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,vY)};case 4:return function(t,n){return e.setUint32(t,n,vY)}}break;case Ar.SNORM:case Ar.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,vY)};case 4:return function(t,n){return e.setInt32(t,n,vY)}}break;case Ar.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,vY)};case 4:return function(t,n){return e.setUint32(t,n,vY)}}break;case Ar.FLOAT:return function(t,n){return e.setFloat32(t,n,vY)}}return null}var xY=[new jo(uo.ATTR_POSITION,Cr.RGB32F),new jo(uo.ATTR_NORMAL,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD,Cr.RG32F),new jo(uo.ATTR_TANGENT,Cr.RGBA32F),new jo(uo.ATTR_COLOR,Cr.RGBA32F)],TY=new yi;function EY(e,t,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=e.positions.slice();if(c.length>0){if(i=null,e.attributes)for(var l,u=W(e.attributes);!(l=u()).done;){var h=l.value;if(h.name===uo.ATTR_POSITION){i=h;break}}i||(i=xY[0]),r.push(i);var f=pa[i.format];s=Math.max(s,Math.floor(c.length/f.count)),a.push({offset:o,data:c,attribute:i}),o+=f.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var _,p=W(e.attributes);!(_=p()).done;){var d=_.value;if(d.name===uo.ATTR_NORMAL){i=d;break}}i||(i=xY[1]);var m=pa[i.format];r.push(i),s=Math.max(s,Math.floor(e.normals.length/m.count)),a.push({offset:o,data:e.normals,attribute:i}),o+=m.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var v,g=W(e.attributes);!(v=g()).done;){var y=v.value;if(y.name===uo.ATTR_TEX_COORD){i=y;break}}i||(i=xY[2]);var S=pa[i.format];r.push(i),s=Math.max(s,Math.floor(e.uvs.length/S.count)),a.push({offset:o,data:e.uvs,attribute:i}),o+=S.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var x,T=W(e.attributes);!(x=T()).done;){var E=x.value;if(E.name===uo.ATTR_TANGENT){i=E;break}}i||(i=xY[3]);var b=pa[i.format];r.push(i),s=Math.max(s,Math.floor(e.tangents.length/b.count)),a.push({offset:o,data:e.tangents,attribute:i}),o+=b.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var C,A=W(e.attributes);!(C=A()).done;){var w=C.value;if(w.name===uo.ATTR_COLOR){i=w;break}}i||(i=xY[4]);var R=pa[i.format];r.push(i),s=Math.max(s,Math.floor(e.colors.length/R.count)),a.push({offset:o,data:e.colors,attribute:i}),o+=R.size}if(e.customAttributes)for(var I,P=W(e.customAttributes);!(I=P()).done;){var O=I.value,D=pa[O.attr.format];r.push(O.attr),s=Math.max(s,Math.floor(O.values.length/D.count)),a.push({offset:o,data:O.values,attribute:O.attr}),o+=D.size}for(var M=new iY,N=new ArrayBuffer(s*o),L=new DataView(N),B=0,F=a;B<F.length;B++){var z=F[B];WA(L,z.data,z.attribute.format,z.offset,o)}M.setNextAlignment(0);var U={attributes:r,view:{offset:M.getLength(),length:N.byteLength,count:s,stride:o}};M.addBuffer(N);var k=null,G=0;if(e.indices){var H=e.indices;G=H.length,k=new ArrayBuffer(2*G),WA(new DataView(k),H,Cr.R16UI)}var V={primitiveMode:e.primitiveMode||Qr.TRIANGLE_LIST,vertexBundelIndices:[0]};k&&(M.setNextAlignment(2),V.indexView={offset:M.getLength(),length:k.byteLength,count:G,stride:2},M.addBuffer(k));var j=e.minPos;if(!j&&n.calculateBounds){j=yi.set(new yi,1/0,1/0,1/0);for(var q=0;q<s;++q)yi.set(TY,c[3*q+0],c[3*q+1],c[3*q+2]),yi.min(j,j,TY)}var X=e.maxPos;if(!X&&n.calculateBounds){X=yi.set(new yi,-1/0,-1/0,-1/0);for(var Y=0;Y<s;++Y)yi.set(TY,c[3*Y+0],c[3*Y+1],c[3*Y+2]),yi.max(X,X,TY)}var K={vertexBundles:[U],primitives:[V]};return j&&(K.minPosition=new yi(j.x,j.y,j.z)),X&&(K.maxPosition=new yi(X.x,X.y,X.z)),t||(t=new dY),t.reset({struct:K,data:new Uint8Array(M.getCombined())}),t}var bY=Object.freeze({__proto__:null,find:MO,toPPM:function(e,t,n){return"P3 "+t+" "+n+" 255\n"+e.filter((function(e,t){return t%4<3})).toString()+"\n"},readMesh:function(e,t){void 0===t&&(t=0);for(var n,i={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),o=e.struct,a=o.primitives[t],s=W(a.vertexBundelIndices);!(n=s()).done;)for(var c,l=n.value,u=o.vertexBundles[l],h=u.view.offset,f=u.view,_=f.length,p=f.stride,d=W(u.attributes);!(c=d()).done;){var m=c.value,v=KX[m.name];v&&(i[v]=(i[v]||[]).concat(qA(r,m.format,h,_,p))),h+=pa[m.format].size}var g=a.indexView;return i.indices=qA(r,Cr["R"+8*g.stride+"UI"],g.offset,g.length),i},createMesh:EY,readBuffer:qA,writeBuffer:WA,mapBuffer:XA});e("utils",bY);var CY,AY,wY,RY,IY,PY,OY,DY,MY,NY,LY,BY,FY,zY,UY,kY,GY,HY,VY,jY,WY,qY,XY,YY,KY,QY,ZY,JY,$Y,eK,tK,nK,iK,rK,oK,aK,sK,cK,lK,uK,hK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}F(t,e);var n=t.prototype;return n.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):null},n.initSubModel=function(t,n,i){return e.prototype.initSubModel.call(this,t,n,this._launderMaterial(i))},n.destroy=function(){e.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(t,n){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(n))},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,n)},n._launderMaterial=function(e){return e},n.setMorphRendering=function(e){this._morphRenderingInstance=e},t}(ag),fK=Qe({OFF:0,ON:1}),_K=Qe({OFF:0,ON:1}),pK=(CY=sl("cc.ModelLightmapSettings"),AY=pl("_recieveShadow"),CY((LY=function(){function e(){q(this,"texture",IY,this),q(this,"uvParam",PY,this),q(this,"_bakeable",OY,this),q(this,"_castShadow",DY,this),q(this,"_receiveShadow",MY,this),q(this,"_lightmapSize",NY,this)}return L(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),IY=X((RY=LY).prototype,"texture",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PY=X(RY.prototype,"uvParam",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hi}}),OY=X(RY.prototype,"_bakeable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),DY=X(RY.prototype,"_castShadow",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),MY=X(RY.prototype,"_receiveShadow",[AY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NY=X(RY.prototype,"_lightmapSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),X(RY.prototype,"bakeable",[bl],Object.getOwnPropertyDescriptor(RY.prototype,"bakeable"),RY.prototype),X(RY.prototype,"castShadow",[bl],Object.getOwnPropertyDescriptor(RY.prototype,"castShadow"),RY.prototype),X(RY.prototype,"receiveShadow",[bl],Object.getOwnPropertyDescriptor(RY.prototype,"receiveShadow"),RY.prototype),X(RY.prototype,"lightmapSize",[bl],Object.getOwnPropertyDescriptor(RY.prototype,"lightmapSize"),RY.prototype),wY=RY))||wY),dK=function(t){return e({MeshRenderer:t,ModelComponent:t}),t}((BY=sl("cc.MeshRenderer"),FY=El(),zY=ll(100),UY=yl(),kY=Hl(fK),GY=Rl(),HY=Hl(_K),VY=Rl(),jY=Hl(dY),WY=Rl(),qY=Cl(),BY(XY=FY(XY=zY(XY=UY(XY=gl((tK=eK=function(e){function t(){var t;return q(t=e.call(this)||this,"lightmapSettings",KY,V(t)),q(t,"_mesh",QY,V(t)),q(t,"_shadowCastingMode",ZY,V(t)),q(t,"_shadowReceivingMode",JY,V(t)),t._subMeshShapesWeights=[],t._modelType=void 0,t._model=null,t._morphInstance=null,q(t,"_enableMorph",$Y,V(t)),t._modelType=ag,t}F(t,e);var n=t.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(i.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(e,t){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[e];return n.length,n[t]},n.setWeights=function(e,t){var n=this._subMeshShapesWeights;t>=n.length||n[t].length===e.length&&(n[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))},n.setWeight=function(e,t,n){var i=this._subMeshShapesWeights;if(!(t>=i.length)){var r=i[t];n>=r.length||(r[n]=e,this._uploadSubMeshShapesWeights(t))}},n.setInstancedAttribute=function(e,t){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===e){r[o].set(t);break}},n._updateLightmap=function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var e=this._morphInstance&&this._modelType===ag?hK:this._modelType,t=this._model=i.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof hK&&t.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=ig.POSITION,this._model.transform.hasChangedFlags|=ig.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},n._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},n._getBuiltinMaterial=function(){return Vv.get("missing-material")},n._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===fK.OFF?this._model.castShadow=!1:(this._shadowCastingMode,fK.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===_K.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n)if(t.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof hK&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var n=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):n?(n.length,e.targets.length,n.slice(0)):new Array(e.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var n=e.struct.morph;return n.subMeshMorphs.length===t.length&&t.every((function(e,t){var i,r,o=e.length;return(null!==(i=null===(r=n.subMeshMorphs[t])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])},L(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,n=this._mesh=e;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),t}(bF),eK.ShadowCastingMode=fK,eK.ShadowReceivingMode=_K,KY=X((YY=tK).prototype,"lightmapSettings",[_l,bl,Fl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new pK}}),QY=X(YY.prototype,"_mesh",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZY=X(YY.prototype,"_shadowCastingMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fK.OFF}}),JY=X(YY.prototype,"_shadowReceivingMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _K.ON}}),X(YY.prototype,"shadowCastingMode",[kY,GY,Fl],Object.getOwnPropertyDescriptor(YY.prototype,"shadowCastingMode"),YY.prototype),X(YY.prototype,"receiveShadow",[HY,VY,Fl],Object.getOwnPropertyDescriptor(YY.prototype,"receiveShadow"),YY.prototype),X(YY.prototype,"mesh",[jY,WY],Object.getOwnPropertyDescriptor(YY.prototype,"mesh"),YY.prototype),X(YY.prototype,"enableMorph",[qY,Fl],Object.getOwnPropertyDescriptor(YY.prototype,"enableMorph"),YY.prototype),$Y=X(YY.prototype,"_enableMorph",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XY=YY))||XY)||XY)||XY)||XY)||XY));function mK(e,t){var n=e.sharedMaterials.length;if(n!==t.sharedMaterials.length)return!1;for(var i=0;i<n;i++)if(e.getRenderMaterial(i)!==t.getRenderMaterial(i))return!1;return!0}e("BatchingUtility",function(){function e(){}return e.batchStaticModel=function(e,t){var n=e.getComponentsInChildren(dK);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var i=1;i<n.length;i++){if(!n[0].mesh.validateMergingMesh(n[i].mesh))return console.error("the meshes of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1;if(!mK(n[0],n[i]))return console.error("the materials of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1}var r=new dY,o=new Ni,a=new Ni;e.getWorldMatrix(a),Ni.invert(a,a);for(var s=0;s<n.length;s++){var c=n[s];c.node.getWorldMatrix(o),Ni.multiply(o,a,o),r.merge(n[s].mesh,o),c.enabled=!1}var l=t.addComponent(dK);return l.mesh=r,l.sharedMaterials=n[0].sharedMaterials,!0},e.unbatchStaticModel=function(e,t){for(var n=e.getComponentsInChildren(dK),i=0;i<n.length;i++)n[i].enabled=!0;var r=t.getComponent(dK);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},e}()),zn(dY.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),Un(dY.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);var vK,gK,yK,SK,xK,TK,EK,bK,CK,AK,wK,RK,IK,PK,OK,DK,MK,NK,LK,BK,FK,zK=e("Skeleton",(nK=sl("cc.Skeleton"),iK=Hl([At]),rK=Hl([Ni]),nK((uK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_joints",sK,V(t)),q(t,"_bindposes",cK,V(t)),q(t,"_hash",lK,V(t)),t._invBindposes=null,t}F(t,e);var n=t.prototype;return n.destroy=function(){var t,n;return null===(t=null===(n=i.director.root)||void 0===n?void 0:n.dataPoolManager)||void 0===t||t.releaseSkeleton(this),e.prototype.destroy.call(this)},n.validate=function(){return this.joints.length>0&&this.bindposes.length>0},L(t,[{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new Ni;Ni.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var n=this._bindposes[t];e+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=Ma(e,666)}return this._hash}}]),t}(zu),sK=X((aK=uK).prototype,"_joints",[iK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cK=X(aK.prototype,"_bindposes",[rK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lK=X(aK.prototype,"_hash",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oK=aK))||oK));i.Skeleton=zK,Un(dK.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),i.ModelComponent=dK,He.setClassAlias(dK,"cc.ModelComponent");var UK,kK,GK,HK,VK,jK,WK,qK,XK,YK,KK,QK,ZK,JK,$K,eQ,tQ,nQ,iQ,rQ,oQ,aQ,sQ,cQ,lQ,uQ,hQ,fQ,_Q,pQ,dQ,mQ,vQ,gQ,yQ,SQ,xQ,TQ,EQ,bQ,CQ,AQ,wQ,RQ,IQ,PQ,OQ,DQ,MQ,NQ=Qe({LUMINOUS_FLUX:0,LUMINANCE:1}),LQ=new yi,BQ=sl("cc.StaticLightSettings")((EK=function(){function e(){q(this,"_baked",yK,this),q(this,"_editorOnly",SK,this),q(this,"_bakeable",xK,this),q(this,"_castShadow",TK,this)}return L(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}(),yK=X((gK=EK).prototype,"_baked",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),SK=X(gK.prototype,"_editorOnly",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xK=X(gK.prototype,"_bakeable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TK=X(gK.prototype,"_castShadow",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(gK.prototype,"editorOnly",[bl],Object.getOwnPropertyDescriptor(gK.prototype,"editorOnly"),gK.prototype),X(gK.prototype,"bakeable",[bl],Object.getOwnPropertyDescriptor(gK.prototype,"bakeable"),gK.prototype),X(gK.prototype,"castShadow",[bl],Object.getOwnPropertyDescriptor(gK.prototype,"castShadow"),gK.prototype),vK=gK))||vK,FQ=function(t){return e({Light:t,LightComponent:t}),t}((bK=sl("cc.Light"),CK=Rl(),AK=Rl(),wK=Il(),RK=Rl(),IK=Hl(BQ),bK((FK=BK=function(e){function t(){var t;return q(t=e.call(this)||this,"_color",DK,V(t)),q(t,"_useColorTemperature",MK,V(t)),q(t,"_colorTemperature",NK,V(t)),q(t,"_staticSettings",LK,V(t)),t._type=Gg.UNKNOWN,t._lightType=void 0,t._light=null,t._lightType=Wg,t}F(t,e);var n=t.prototype;return n.onLoad=function(){this._createLight()},n.onEnable=function(){this._attachToScene()},n.onDisable=function(){this._detachFromScene()},n.onDestroy=function(){this._destroyLight()},n._createLight=function(){this._light||(this._light=i.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},n._destroyLight=function(){this._light&&(i.director.root.destroyLight(this),this._light=null)},n._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case Gg.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case Gg.SPHERE:e.addSphereLight(this._light);break;case Gg.SPOT:e.addSpotLight(this._light)}}},n._detachFromScene=function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case Gg.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case Gg.SPHERE:e.removeSphereLight(this._light);break;case Gg.SPOT:e.removeSpotLight(this._light)}}},L(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(LQ.x=e.r/255,LQ.y=e.g/255,LQ.z=e.b/255,this._light.color=LQ)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}}]),t}(oh),BK.Type=Gg,BK.PhotometricTerm=NQ,DK=X((OK=FK).prototype,"_color",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.WHITE.clone()}}),MK=X(OK.prototype,"_useColorTemperature",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NK=X(OK.prototype,"_colorTemperature",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),LK=X(OK.prototype,"_staticSettings",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BQ}}),X(OK.prototype,"color",[CK],Object.getOwnPropertyDescriptor(OK.prototype,"color"),OK.prototype),X(OK.prototype,"useColorTemperature",[AK],Object.getOwnPropertyDescriptor(OK.prototype,"useColorTemperature"),OK.prototype),X(OK.prototype,"colorTemperature",[Ml,wK,RK],Object.getOwnPropertyDescriptor(OK.prototype,"colorTemperature"),OK.prototype),X(OK.prototype,"staticSettings",[IK],Object.getOwnPropertyDescriptor(OK.prototype,"staticSettings"),OK.prototype),PK=OK))||PK)),zQ=function(t){return e({DirectionalLight:t,DirectionalLightComponent:t}),t}((UK=sl("cc.DirectionalLight"),kK=El(),GK=yl(),HK=pl("_illuminance"),VK=Rl(),UK(jK=kK(jK=GK(jK=gl((YK=function(e){function t(){var t;return q(t=e.call(this)||this,"_illuminanceHDR",qK,V(t)),q(t,"_illuminanceLDR",XK,V(t)),t._type=Gg.DIRECTIONAL,t._light=null,t._lightType=Yg,t}return F(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._illuminanceLDR=this._illuminanceHDR*bm.standardExposureValue,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},L(t,[{key:"illuminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),t}(FQ),qK=X((WK=YK).prototype,"_illuminanceHDR",[hl,HK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),XK=X(WK.prototype,"_illuminanceLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X(WK.prototype,"illuminance",[VK],Object.getOwnPropertyDescriptor(WK.prototype,"illuminance"),WK.prototype),jK=WK))||jK)||jK)||jK)||jK)),UQ=function(t){return e({SphereLight:t,SphereLightComponent:t}),t}((KK=sl("cc.SphereLight"),QK=El(),ZK=yl(),JK=pl("_luminance"),$K=Rl(),eQ=Rl(),tQ=Hl(NQ),nQ=Rl(),iQ=Rl(),rQ=Rl(),KK(oQ=QK(oQ=ZK(oQ=gl((fQ=function(e){function t(){var t;return q(t=e.call(this)||this,"_size",sQ,V(t)),q(t,"_luminanceHDR",cQ,V(t)),q(t,"_luminanceLDR",lQ,V(t)),q(t,"_term",uQ,V(t)),q(t,"_range",hQ,V(t)),t._type=Gg.SPHERE,t._light=null,t._lightType=ny,t}return F(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*bm.standardExposureValue*bm.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/bm.standardExposureValue/bm.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},L(t,[{key:"luminousFlux",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*jg(this._size):this._luminanceLDR},set:function(e){var t=0;i.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/jg(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(FQ),sQ=X((aQ=fQ).prototype,"_size",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),cQ=X(aQ.prototype,"_luminanceHDR",[_l,JK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/jg(.15)}}),lQ=X(aQ.prototype,"_luminanceLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),uQ=X(aQ.prototype,"_term",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NQ.LUMINOUS_FLUX}}),hQ=X(aQ.prototype,"_range",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X(aQ.prototype,"luminousFlux",[$K],Object.getOwnPropertyDescriptor(aQ.prototype,"luminousFlux"),aQ.prototype),X(aQ.prototype,"luminance",[eQ],Object.getOwnPropertyDescriptor(aQ.prototype,"luminance"),aQ.prototype),X(aQ.prototype,"term",[tQ,nQ],Object.getOwnPropertyDescriptor(aQ.prototype,"term"),aQ.prototype),X(aQ.prototype,"size",[iQ],Object.getOwnPropertyDescriptor(aQ.prototype,"size"),aQ.prototype),X(aQ.prototype,"range",[rQ],Object.getOwnPropertyDescriptor(aQ.prototype,"range"),aQ.prototype),oQ=aQ))||oQ)||oQ)||oQ)||oQ)),kQ=function(t){return e({SpotLight:t,SpotLightComponent:t}),t}((_Q=sl("cc.SpotLight"),pQ=El(),dQ=yl(),mQ=pl("_luminance"),vQ=Rl(),gQ=Rl(),yQ=Hl(NQ),SQ=Rl(),xQ=Rl(),TQ=Rl(),EQ=Il(),bQ=Rl(),_Q(CQ=pQ(CQ=dQ(CQ=gl((MQ=function(e){function t(){var t;return q(t=e.call(this)||this,"_size",wQ,V(t)),q(t,"_luminanceHDR",RQ,V(t)),q(t,"_luminanceLDR",IQ,V(t)),q(t,"_term",PQ,V(t)),q(t,"_range",OQ,V(t)),q(t,"_spotAngle",DQ,V(t)),t._type=Gg.SPOT,t._light=null,t._lightType=ly,t}return F(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*bm.standardExposureValue*bm.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/bm.standardExposureValue/bm.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},L(t,[{key:"luminousFlux",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*jg(this._size):this._luminanceLDR},set:function(e){var t=0;i.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/jg(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return i.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){i.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=ti(e))}}]),t}(FQ),wQ=X((AQ=MQ).prototype,"_size",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),RQ=X(AQ.prototype,"_luminanceHDR",[_l,mQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/jg(.15)}}),IQ=X(AQ.prototype,"_luminanceLDR",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),PQ=X(AQ.prototype,"_term",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NQ.LUMINOUS_FLUX}}),OQ=X(AQ.prototype,"_range",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),DQ=X(AQ.prototype,"_spotAngle",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),X(AQ.prototype,"luminousFlux",[vQ],Object.getOwnPropertyDescriptor(AQ.prototype,"luminousFlux"),AQ.prototype),X(AQ.prototype,"luminance",[gQ],Object.getOwnPropertyDescriptor(AQ.prototype,"luminance"),AQ.prototype),X(AQ.prototype,"term",[yQ,SQ],Object.getOwnPropertyDescriptor(AQ.prototype,"term"),AQ.prototype),X(AQ.prototype,"size",[xQ],Object.getOwnPropertyDescriptor(AQ.prototype,"size"),AQ.prototype),X(AQ.prototype,"range",[TQ],Object.getOwnPropertyDescriptor(AQ.prototype,"range"),AQ.prototype),X(AQ.prototype,"spotAngle",[Ml,EQ,bQ],Object.getOwnPropertyDescriptor(AQ.prototype,"spotAngle"),AQ.prototype),CQ=AQ))||CQ)||CQ)||CQ)||CQ));i.LightComponent=FQ,He.setClassAlias(FQ,"cc.LightComponent"),i.DirectionalLightComponent=zQ,He.setClassAlias(zQ,"cc.DirectionalLightComponent"),i.SphereLightComponent=UQ,He.setClassAlias(UQ,"cc.SphereLightComponent"),i.SpotLightComponent=kQ,He.setClassAlias(kQ,"cc.SpotLightComponent"),zn(kQ.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),zn(UQ.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),zn(FQ.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var GQ=function(e,t,n){e[t+0]=n.m00,e[t+1]=n.m01,e[t+2]=n.m02,e[t+3]=n.m12,e[t+4]=n.m04,e[t+5]=n.m05,e[t+6]=n.m06,e[t+7]=n.m13,e[t+8]=n.m08,e[t+9]=n.m09,e[t+10]=n.m10,e[t+11]=n.m14};function HQ(e,t){var n=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*n,e)/12)}new Ai,new Ai,new yi,new Ai,new yi;var VQ=new No(Fr.POINT,Fr.POINT,Fr.NONE,zr.CLAMP,zr.CLAMP,zr.CLAMP),jQ=new yi,WQ=new yi,qQ=new yi,XQ=new yi,YQ=new Ni,KQ=new Ni,QQ=new zc,ZQ=Number.MAX_SAFE_INTEGER,JQ=function(){function e(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;var t=function(e){return e.hasFeature(br.TEXTURE_FLOAT)?Cr.RGBA32F:Cr.RGBA8}(this._device);this._formatSize=pa[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new _y(e),this._pool.initialize({format:t,roundUpFn:HQ}),this._customPool=new _y(e),this._customPool.initialize({format:t,roundUpFn:HQ})}var t=e.prototype;return t.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},t.registerCustomTextureLayouts=function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}},t.getDefaultPoseTexture=function(e,t,n){var i=0^e.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var o=e.joints,a=e.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(i),f=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!f)return r;r={pixelOffset:f.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:f},s=new Float32Array(u),c=!0}yi.set(qQ,ZQ,ZQ,ZQ),yi.set(XQ,-ZQ,-ZQ,-ZQ);for(var _=t.getBoneSpaceBounds(e),p=0,d=0;p<l;p++,d+=12){var m=n.getChildByPath(o[p]),v=m?HW(m,n,YQ):e.inverseBindposes[p],g=_[p];g&&(zc.transform(QQ,g,v),QQ.getBoundary(jQ,WQ),yi.min(qQ,qQ,jQ),yi.max(XQ,XQ,WQ)),c&&(m&&Ni.multiply(v,v,a[p]),GQ(s,d,m?v:Ni.IDENTITY))}var y=[new zc];return r.bounds.set(t.hash,y),zc.fromPoints(y[0],qQ,XQ),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(i,r)),r},t.getSequencePoseTexture=function(e,t,n,i){var r=e.hash^t.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=e.joints,s=e.bindposes,c=tG.getOrExtract(t).frames,l=null,u=!1,h=a.length;if(o)o.refCount++;else{var f=12*h*c,_=this._chunkIdxMap.get(r),p=void 0!==_?this._customPool.alloc(f*Float32Array.BYTES_PER_ELEMENT,_):this._pool.alloc(f*Float32Array.BYTES_PER_ELEMENT);if(!p)return null;var d=this._createAnimInfos(e,t,i);o={pixelOffset:p.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:p,animInfos:d},l=new Float32Array(f),u=!0}var m=n.getBoneSpaceBounds(e),v=[];o.bounds.set(n.hash,v);for(var g=0;g<c;g++)v.push(new zc(ZQ,ZQ,ZQ,-ZQ,-ZQ,-ZQ));for(var y=0,S=0;y<c;y++){for(var x=v[y],T=0;T<h;T++,S+=12){var E=o.animInfos[T],b=E.curveData,C=E.downstream,A=E.bindposeIdx,w=E.bindposeCorrection,R=void 0,I=!0;b&&C?R=Ni.multiply(YQ,b[y],C):b?R=b[y]:C?R=C:(R=e.inverseBindposes[A],I=!1);var P=m[T];if(P){var O=w?Ni.multiply(KQ,R,w):R;zc.transform(QQ,P,O),QQ.getBoundary(jQ,WQ),yi.min(x.center,x.center,jQ),yi.max(x.halfExtents,x.halfExtents,WQ)}u&&(I&&Ni.multiply(YQ,R,s[A]),GQ(l,S,I?YQ:Ni.IDENTITY))}zc.fromPoints(x,x.center,x.halfExtents)}return u&&(this._pool.update(o.handle,l.buffer),this._textureBuffers.set(r,o)),o},t.releaseHandle=function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}},t.releaseSkeleton=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.skeletonHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t.releaseAnimationClip=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.clipHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t._createAnimInfos=function(e,t,n){for(var i=[],r=e.joints,o=e.bindposes,a=r.length,s=tG.getOrExtract(t),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=n.getChildByPath(l),f=void 0,_=void 0;!u;){var p=l.lastIndexOf("/");if(l=l.substring(0,p),u=s.joints[l],h?(f||(f=new Ni),Ni.fromRTS(YQ,h.rotation,h.position,h.scale),Ni.multiply(f,YQ,f),h=h.parent):_=l,p<0)break}var d=c,m=void 0;if(void 0!==_&&u){d=c-1;for(var v=0;v<a;v++)if(r[v]===_){d=v,m=new Ni,Ni.multiply(m,o[v],e.inverseBindposes[c]);break}}i.push({curveData:u&&u.transforms,downstream:f,bindposeIdx:d,bindposeCorrection:m})}return i},L(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),e}(),$Q=function(){function e(e){this._pool=new Map,this._device=void 0,this._device=e}var t=e.prototype;return t.getData=function(e){void 0===e&&(e="-1");var t=this._pool.get(e);if(t)return t;var n=this._device.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,Cd.SIZE,Cd.SIZE)),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1};return this._setAnimInfoDirty(r,!1),this._pool.set(e,r),r},t.destroy=function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))},t._setAnimInfoDirty=function(e,t){e.dirty=t},t.switchClip=function(e){return e.data[0]=0,e.buffer.update(e.data),this._setAnimInfoDirty(e,!1),e},t.clear=function(){for(var e,t=W(this._pool.values());!(e=t()).done;)e.value.buffer.destroy();this._pool.clear()},e}(),eZ=function(){function e(e){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new JQ(e),this.jointAnimationInfo=new $Q(e)}var t=e.prototype;return t.releaseSkeleton=function(e){this.jointTexturePool.releaseSkeleton(e)},t.releaseAnimationClip=function(e){this.jointTexturePool.releaseAnimationClip(e)},t.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},e}();i.internal.DataPoolManager=eZ;var tZ=[{name:"CC_USE_SKINNING",value:!0}];function nZ(e,t,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(t.push(r),e.push(a))}}var iZ,rZ,oZ,aZ,sZ,cZ,lZ,uZ,hZ,fZ,_Z,pZ,dZ,mZ,vZ,gZ,yZ,SZ,xZ,TZ,EZ,bZ,CZ,AZ,wZ,RZ,IZ,PZ,OZ,DZ,MZ,NZ,LZ,BZ,FZ,zZ,UZ,kZ,GZ,HZ,VZ,jZ,WZ,qZ,XZ,YZ=new yi,KZ=new yi,QZ=new yi,ZZ=new yi,JZ=new Ni,$Z=new zc,eJ=function(e){function t(){var t;return(t=e.call(this)||this).uploadAnimation=null,t._buffers=[],t._dataArray=[],t._joints=[],t._bufferIndices=null,t.type=Zv.SKINNING,t}F(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null);for(var i=0;i<this._joints.length;i++)LW(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&n){this.transform=t;var r=n.getBoneSpaceBounds(e),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<e.joints.length;a++){var s=r[a],c=t.getChildByPath(e.joints[a]);if(s&&c){var l=NW(c,t),u=e.bindposes[a],h=[],f=[];o?nZ(h,f,o,a):(h.push(a),f.push(0)),this._joints.push({indices:h,buffers:f,bound:s,target:c,bindpose:u,transform:l})}}}},n.updateTransform=function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._localDataUpdated=!0),yi.set(YZ,1/0,1/0,1/0),yi.set(KZ,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=MW(i.transform,e);zc.transform($Z,r,o),$Z.getBoundary(QZ,ZZ),yi.min(YZ,YZ,QZ),yi.max(KZ,KZ,ZZ)}var a=this._worldBounds;this._modelBounds&&a&&(zc.fromPoints(this._modelBounds,YZ,KZ),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds),this._updateNativeBounds())},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;Ni.multiply(JZ,a.world,s);for(var c=0;c<o.length;c++)GQ(this._dataArray[o[c]],12*r[c],JZ)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},n.initSubModel=function(t,n,i){var r=n.vertexBuffers,o=n.iaInfo;o.vertexBuffers=n.jointMappedBuffers,e.prototype.initSubModel.call(this,t,n,i),o.vertexBuffers=r},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?tZ.concat(n):tZ},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._buffers[this._bufferIndices[t]];i&&n.bindBuffer(wd.BINDING,i)},n._updateInstancedAttributes=function(t,n){n.batchingScheme!==kv.NONE&&b(3936,this.node.name),e.prototype._updateInstancedAttributes.call(this,t,n)},n._ensureEnoughBuffers=function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,wd.SIZE,wd.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(wd.COUNT))},t}(hK),tJ=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],nJ=function(e){function t(){var t;(t=e.call(this)||this).uploadedAnim=void 0,t._jointsMedium=void 0,t._skeleton=null,t._mesh=null,t._dataPoolManager=void 0,t._instAnimInfoIdx=-1,t.type=Zv.BAKED_SKINNING,t._dataPoolManager=i.director.root.dataPoolManager;var n=new Float32Array(4),r=t._dataPoolManager.jointAnimationInfo.getData();return t._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:r,texture:null,boundsInfo:null},t}F(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){if(void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),this._skeleton=e,this._mesh=n,e&&t&&n){this.transform=t;var i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.DEVICE,bd.SIZE,bd.SIZE)))}},n.updateTransform=function(t){if(e.prototype.updateTransform.call(this,t),this.uploadedAnim){var n=this._jointsMedium,i=n.animInfo,r=n.boundsInfo[i.data[0]],o=this._worldBounds;if(o&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,o)}}},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);var n=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=n.data[0]:n.dirty&&(n.buffer.update(n.data),n.dirty=!1),!0},n._applyNativeJointMedium=function(){},n._updateModelBounds=function(e){this._modelBounds=e},n.uploadAnimation=function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,n=null;e?(n=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(n=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(n&&n.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(n),this._applyNativeJointMedium()}},n._applyJointTexture=function(e){void 0===e&&(e=null);var t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,e){var n=this._jointsMedium,i=n.buffer,r=n.jointTextureInfo;r[0]=e.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=e.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),i&&i.update(r);for(var o=e.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(Pd,o)}},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?n.concat(tJ):tJ},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._jointsMedium,r=i.buffer,o=i.texture,a=i.animInfo;if(n.bindBuffer(bd.BINDING,r),n.bindBuffer(Cd.BINDING,a.buffer),o){var s=this._device.getSampler(VQ);n.bindTexture(Pd,o.handle.texture),n.bindSampler(Pd,s)}},n._setInstAnimInfoIdx=function(e){this._instAnimInfoIdx=e},n._updateInstancedAttributes=function(t,n){e.prototype._updateInstancedAttributes.call(this,t,n),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(Ad)),this.updateInstancedJointTextureInfo()},n.updateInstancedJointTextureInfo=function(){var e=this._jointsMedium,t=e.jointTextureInfo,n=e.animInfo,i=this._instAnimInfoIdx;if(i>=0){var r=this.instancedAttributes.views[i];r[0]=n.data[0],r[1]=t[1],r[2]=t[2]}},t}(hK),iJ=function(t){return e({SkinnedMeshRenderer:t,SkinningModelComponent:t}),t}((iZ=sl("cc.SkinnedMeshRenderer"),rZ=El(),oZ=ll(100),aZ=yl(),sZ=Hl(zK),cZ=Hl(eA),lZ=Hl(zK),uZ=Hl(eA),hZ=Rl(),iZ(fZ=rZ(fZ=oZ(fZ=gl(fZ=aZ((mZ=function(e){function t(){var t;return q(t=e.call(this)||this,"_skeleton",pZ,V(t)),q(t,"_skinningRoot",dZ,V(t)),t._clip=null,t._modelType=nJ,t}F(t,e);var n=t.prototype;return n.__preload=function(){this._updateModelType()},n.uploadAnimation=function(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)},n.setUseBakedAnimation=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!1);var n=e?nJ:eJ;(t||this._modelType!==n)&&(this._modelType=n,this._model&&(i.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(t,n){e.prototype.setMaterial.call(this,t,n),this._modelType===eJ&&this.getMaterialInstance(n)},n._updateModelParams=function(){this._update(),e.prototype._updateModelParams.call(this)},n._updateModelType=function(){if(this._skinningRoot){var e=this._skinningRoot.getComponent("cc.SkeletalAnimation");e?this.setUseBakedAnimation(e.useBakedAnimation):this.setUseBakedAnimation(!1)}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},L(t,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){e!==this._skeleton&&(this._skeleton=e,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){e!==this._skinningRoot&&(this._skinningRoot=e,this._updateModelType(),this._update())}},{key:"model",get:function(){return this._model}}]),t}(dK),pZ=X((_Z=mZ).prototype,"_skeleton",[sZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dZ=X(_Z.prototype,"_skinningRoot",[cZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(_Z.prototype,"skeleton",[lZ],Object.getOwnPropertyDescriptor(_Z.prototype,"skeleton"),_Z.prototype),X(_Z.prototype,"skinningRoot",[uZ,hZ],Object.getOwnPropertyDescriptor(_Z.prototype,"skinningRoot"),_Z.prototype),fZ=_Z))||fZ)||fZ)||fZ)||fZ)||fZ)),rJ=new jo(uo.ATTR_BATCH_ID,Cr.R32F),oJ=new jo(uo.ATTR_BATCH_UV,Cr.RG32F),aJ=pa[rJ.format].size+pa[oJ.format].size,sJ=function(t){return e({SkinnedMeshUnit:t,SkinningModelUnit:t}),t}((vZ=sl("cc.SkinnedMeshUnit"),gZ=Hl(dY),yZ=Hl(zK),SZ=Hl(Ng),xZ=Hl(iJ),vZ((PZ=function(){function e(){q(this,"mesh",bZ,this),q(this,"skeleton",CZ,this),q(this,"material",AZ,this),q(this,"_localTransform",wZ,this),q(this,"_offset",RZ,this),q(this,"_size",IZ,this)}return L(e,[{key:"offset",get:function(){return this._offset},set:function(e){zi.copy(this._offset,e)}},{key:"size",get:function(){return this._size},set:function(e){zi.copy(this._size,e)}},{key:"copyFrom",get:function(){return null},set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&HW(e.node,e.skinningRoot,this._localTransform))}}]),e}(),bZ=X((EZ=PZ).prototype,"mesh",[gZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),CZ=X(EZ.prototype,"skeleton",[yZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AZ=X(EZ.prototype,"material",[SZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wZ=X(EZ.prototype,"_localTransform",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),RZ=X(EZ.prototype,"_offset",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,0)}}),IZ=X(EZ.prototype,"_size",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(1,1)}}),X(EZ.prototype,"offset",[bl],Object.getOwnPropertyDescriptor(EZ.prototype,"offset"),EZ.prototype),X(EZ.prototype,"size",[bl],Object.getOwnPropertyDescriptor(EZ.prototype,"size"),EZ.prototype),X(EZ.prototype,"copyFrom",[xZ],Object.getOwnPropertyDescriptor(EZ.prototype,"copyFrom"),EZ.prototype),TZ=EZ))||TZ)),cJ=new Ni,lJ=(new Ni,new yi),uJ=function(t){return e({SkinnedMeshBatchRenderer:t,BatchedSkinningModelComponent:t}),t}((OZ=sl("cc.SkinnedMeshBatchRenderer"),DZ=El(),MZ=ll(100),NZ=yl(),LZ=Rl(),BZ=Hl([At]),FZ=Rl(),zZ=Hl([sJ]),UZ=Rl(),kZ=Cl(),GZ=Cl(),OZ(HZ=DZ(HZ=MZ(HZ=gl(HZ=NZ((XZ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"atlasSize",jZ,V(t)),q(t,"batchableTextureNames",WZ,V(t)),q(t,"units",qZ,V(t)),t._textures={},t._batchMaterial=null,t}F(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this),this.cook()},n.onDestroy=function(){for(var t in this._textures)this._textures[t].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),e.prototype.onDestroy.call(this)},n._onMaterialModified=function(t){this.cookMaterials(),e.prototype._onMaterialModified.call(this,t,this.getMaterialInstance(t))},n.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},n.cookMaterials=function(){var e=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var t=this.getMaterialInstance(0);if(t&&this._batchMaterial&&this._batchMaterial.effectAsset){t.copy(this._batchMaterial),this.resizeAtlases();for(var n=t.effectAsset.techniques[t.technique],i=function(i){var r=n.passes[i];if(!r.properties)return"continue";var o=function(n){if(r.properties[n].type>=wr.SAMPLER1D){var o=null;e.batchableTextureNames.find((function(e){return e===n}))?((o=e._textures[n])||(o=e.createTexture(n)),e.cookTextures(o,n,i)):e.units.some((function(e){return o=e.material&&e.material.getProperty(n,i)})),o&&t.setProperty(n,o,i)}else{for(var a=[],s=0;s<e.units.length;s++){var c=e.units[s];c.material&&a.push(c.material.getProperty(n.slice(0,-3),i))}t.setProperty(n,a,i)}};for(var a in r.properties)o(a)},r=0;r<n.passes.length;r++)i(r)}else console.warn("incomplete batch material!")},n.cookSkeletons=function(){if(this._skinningRoot){for(var e=[],t=[],n=0;n<this.units.length;n++){var i=this.units[n];if(i&&i.skeleton){var r=i.skeleton;Ni.invert(cJ,i._localTransform);for(var o=function(n){var i=r.joints[n];if(e.findIndex((function(e){return e===i}))>=0)return"continue";e.push(i),t.push(Ni.multiply(new Ni,r.bindposes[n]||Ni.IDENTITY,cJ))},a=0;a<r.joints.length;a++)o(a)}}var s=Array.from(Array(e.length).keys()).sort((function(t,n){return e[t]>e[n]?1:e[t]<e[n]?-1:0})),c=new zK;c.joints=e.map((function(e,t,n){return n[s[t]]})),c.bindposes=t.map((function(e,t,n){return n[s[t]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},n.cookMeshes=function(){for(var e=this,t=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){t=!0;break}if(t&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new dY;for(var i=0,r=Cr.UNKNOWN,o=0,a=Cr.UNKNOWN,s=0,c=Cr.UNKNOWN,l=0,u=Cr.UNKNOWN,h=0,f=Cr.UNKNOWN,_=new Array(this.units.length),p=this.units.length,d=0;d<p;d++){var m=this.units[d];m&&m.skeleton&&(_[d]=m.skeleton.joints.map((function(t){return e._skeleton.joints.findIndex((function(e){return t===e}))})))}for(var v=function(t){var n=e.units[t];if(!n||!n.mesh||!n.mesh.data)return"continue";var p=e._createUnitMesh(t,n.mesh),d=new DataView(p.data.buffer);Ni.inverseTranspose(cJ,n._localTransform);for(var m=n.offset,v=n.size,g=function(e){var g=p.struct.vertexBundles[e];i=g.view.offset,r=Cr.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var S=g.attributes[y];if(S.name===uo.ATTR_POSITION){r=S.format;break}i+=pa[S.format].size}if(r){for(var x=qA(d,r,i,g.view.length,g.view.stride),T=0;T<x.length;T+=3)yi.fromArray(lJ,x,T),yi.transformMat4(lJ,lJ,n._localTransform),yi.toArray(x,lJ,T);WA(d,x,r,i,g.view.stride)}o=g.view.offset,a=Cr.UNKNOWN;for(var E=0;E<g.attributes.length;E++){var b=g.attributes[E];if(b.name===uo.ATTR_NORMAL){a=b.format;break}o+=pa[b.format].size}if(a){for(var C=qA(d,a,o,g.view.length,g.view.stride),A=0;A<C.length;A+=3)yi.fromArray(lJ,C,A),yi.transformMat4Normal(lJ,lJ,cJ),yi.toArray(C,lJ,A);WA(d,C,a,o,g.view.stride)}s=g.view.offset,c=Cr.UNKNOWN;for(var w=0;w<g.attributes.length;w++){var R=g.attributes[w];if(R.name===uo.ATTR_TANGENT){c=R.format;break}s+=pa[R.format].size}if(c){for(var I=qA(d,c,s,g.view.length,g.view.stride),P=0;P<I.length;P+=3)yi.fromArray(lJ,I,P),yi.transformMat4Normal(lJ,lJ,cJ),yi.toArray(I,lJ,P);WA(d,I,c,s,g.view.stride)}l=g.view.offset,u=Cr.UNKNOWN;for(var O=0;O<g.attributes.length;O++){var D=g.attributes[O];if(D.name===uo.ATTR_BATCH_UV){u=D.format;break}l+=pa[D.format].size}u&&XA(d,(function(e,t){var n,i=0===t?"x":"y";return(e=(n=e)-Math.floor(n))*v[i]+m[i]}),u,l,g.view.length,g.view.stride,d);var M=_[t];if(!M)return"continue";h=g.view.offset,f=Cr.UNKNOWN;for(var N=0;N<g.attributes.length;N++){var L=g.attributes[N];if(L.name===uo.ATTR_JOINTS){f=L.format;break}h+=pa[L.format].size}f&&XA(d,(function(e){return M[e]}),f,h,g.view.length,g.view.stride,d)},y=0;y<p.struct.vertexBundles.length;y++)g(y);e._mesh.merge(p)},g=0;g<p;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},n.cookTextures=function(e,t,n){for(var r=[],o=[],a=[],s=[],c=0;c<this.units.length;c++){var l=this.units[c];if(l.material){var u=l.material.getProperty(t,n);if(u&&u.image&&u.image.data){var h=new xo;h.texOffset.x=l.offset.x*this.atlasSize,h.texOffset.y=l.offset.y*this.atlasSize,h.texExtent.width=l.size.x*this.atlasSize,h.texExtent.height=l.size.y*this.atlasSize;var f=u.image.data;ArrayBuffer.isView(f)?(a.push(f),s.push(h)):(r.push(f),o.push(h))}}}var _=e.getGFXTexture(),p=i.director.root.device;a.length>0&&p.copyBuffersToTexture(a,_,s),r.length>0&&p.copyTexImagesToTexture(r,_,o)},n.createTexture=function(e){var t=new uv;return t.setFilters(hm.LINEAR,hm.LINEAR),t.setMipFilter(hm.NEAREST),t.reset({width:this.atlasSize,height:this.atlasSize,format:lm.RGBA8888}),this._textures[e]=t,t},n.resizeAtlases=function(){for(var e in this._textures)this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:lm.RGBA8888})},n._createUnitMesh=function(e,t){for(var n=JSON.parse(JSON.stringify(t.struct)),r={},o=0;o<t.struct.primitives.length;o++){for(var a=t.struct.primitives[o],s=0,c=Cr.UNKNOWN,l=0;l<a.vertexBundelIndices.length;l++){var u=t.struct.vertexBundles[a.vertexBundelIndices[l]];s=u.view.offset,c=Cr.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var f=u.attributes[h];if(f.name===uo.ATTR_TEX_COORD){c=f.format;break}s+=pa[f.format].size}if(c)break}if(void 0===r[l]){r[l]=[c,s];var _=n.vertexBundles[l];_.attributes.push(rJ),_.attributes.push(oJ),_.view.offset=0,_.view.length+=_.view.count*aJ,_.view.stride+=aJ}}for(var p=0,d=0;d<n.vertexBundles.length;d++)p+=n.vertexBundles[d].view.length;for(var m=0;m<n.primitives.length;m++){var v=n.primitives[m];v.indexView&&(v.indexView.offset=p,p+=v.indexView.length)}var g=new Uint8Array(p),y=t.data,S=new DataView(g.buffer),x=new DataView(y.buffer),T=i.sys.isLittleEndian;for(var E in r)for(var b=n.vertexBundles[E],C=t.struct.vertexBundles[E],A=r[E],w=qA(x,A[0],A[1],C.view.length,C.view.stride),R=C.view,I=b.view,P=R.stride,O=I.stride,D=R.offset,M=I.offset,N=0;N<I.count;N++){var L=y.subarray(D,D+P);g.set(L,M),S.setFloat32(M+P,e),S.setFloat32(M+P+4,w[2*N],T),S.setFloat32(M+P+8,w[2*N+1],T),M+=O,D+=P}for(var B=0;B<n.primitives.length;B++){var F=t.struct.primitives[B],z=n.primitives[B];if(F.indexView&&z.indexView)for(var U=F.indexView.stride,k=z.indexView.stride,G=F.indexView.offset,H=z.indexView.offset,V=0;V<z.indexView.count;V++){var j=y.subarray(G,G+U);g.set(j,H),H+=k,G+=U}}var W=new dY;return W.reset({struct:n,data:g}),W},L(t,[{key:"mesh",get:function(){return e.prototype.mesh},set:function(e){this.mesh=e}},{key:"skeleton",get:function(){return e.prototype.skeleton},set:function(e){this.skeleton=e}}]),t}(iJ),jZ=X((VZ=XZ).prototype,"atlasSize",[_l,LZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),WZ=X(VZ.prototype,"batchableTextureNames",[BZ,_l,FZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qZ=X(VZ.prototype,"units",[zZ,_l,UZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X(VZ.prototype,"mesh",[Jl,kZ],Object.getOwnPropertyDescriptor(VZ.prototype,"mesh"),VZ.prototype),X(VZ.prototype,"skeleton",[Jl,GZ],Object.getOwnPropertyDescriptor(VZ.prototype,"skeleton"),VZ.prototype),HZ=VZ))||HZ)||HZ)||HZ)||HZ)||HZ));i.SkinningModelComponent=iJ,He.setClassAlias(iJ,"cc.SkinningModelComponent"),i.SkinningModelUnit=sJ,He.setClassAlias(sJ,"cc.SkinningModelUnit"),i.BatchedSkinningModelComponent=uJ,He.setClassAlias(uJ,"cc.BatchedSkinningModelComponent");var hJ,fJ,_J,pJ,dJ,mJ,vJ,gJ,yJ,SJ,xJ,TJ,EJ,bJ,CJ,AJ,wJ,RJ,IJ,PJ,OJ=new Ni,DJ=new Ni,MJ=e("SkeletalAnimationState",function(e){function t(t,n){var r;return void 0===n&&(n=""),(r=e.call(this,t,n)||this)._frames=1,r._bakedDuration=0,r._animInfo=null,r._sockets=[],r._animInfoMgr=void 0,r._comps=[],r._parent=null,r._curvesInited=!1,r._animInfoMgr=i.director.root.dataPoolManager.jointAnimationInfo,r}F(t,e);var n=t.prototype;return n.initialize=function(t){if(!this._curveLoaded){this._comps.length=0;for(var n=t.getComponentsInChildren(iJ),i=0;i<n.length;++i){var r=n[i];r.skinningRoot===t&&this._comps.push(r)}this._parent=t.getComponent("cc.SkeletalAnimation");var o=this._parent.useBakedAnimation;this._doNotCreateEval=o,e.prototype.initialize.call(this,t),this._curvesInited=!o;var a=tG.getOrExtract(this.clip),s=a.frames,c=a.samples;this._frames=s-1,this._animInfo=this._animInfoMgr.getData(t.uuid),this._bakedDuration=this._frames/c}},n.onPlay=function(){if(e.prototype.onPlay.call(this),this._parent.useBakedAnimation){this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this.clip);for(var t=0;t<this._comps.length;++t)this._comps[t].uploadAnimation(this.clip)}else this._sampleCurves=e.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,e.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0)},n.rebuildSocketCurves=function(e){if(this._sockets.length=0,this._targetNode)for(var t=this._targetNode,n=0;n<e.length;++n){var i=e[n],r=t.getChildByPath(i.path);if(i.target){for(var o=tG.getOrExtract(this.clip),a=i.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/");if(a=a.substring(0,u),s=o.joints[a],c&&(l||(l=Ni.identity(DJ)),Ni.fromRTS(OJ,c.rotation,c.position,c.scale),Ni.multiply(l,OJ,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,f=o.frames,_=[],p=0;p<f;p++){var d;d=h&&l?Ni.multiply(OJ,h[p],l):h?h[p]:l||new Ni;var m={pos:new yi,rot:new Ai,scale:new yi};Ni.toRTS(d,m.rot,m.pos,m.scale),_.push(m)}this._sockets.push({target:i.target,frames:_})}}},n._setAnimInfoDirty=function(e,t){e.dirty=t},n._sampleCurvesBaked=function(e){var t=e/this.duration,n=this._animInfo,i=t*this._frames+.5|0;if(i!==n.data[0]){n.data[0]=i,this._setAnimInfoDirty(n,!0);for(var r=0;r<this._sockets.length;++r){var o=this._sockets[r],a=o.target,s=o.frames[i],c=s.pos,l=s.rot,u=s.scale;a.setRTS(l,c,u)}}},t}(YH)),NJ=e("Socket",(hJ=sl("cc.SkeletalAnimation.Socket"),fJ=Hl(eA),hJ((dJ=X((pJ=function(e,t){void 0===e&&(e=""),void 0===t&&(t=null),q(this,"path",dJ,this),q(this,"target",mJ,this),this.path=e,this.target=t}).prototype,"path",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mJ=X(pJ.prototype,"target",[fJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_J=pJ))||_J));He.setClassAlias(NJ,"cc.SkeletalAnimationComponent.Socket");var LJ=new Ni,BJ=new Ni;function FJ(e,t,n){void 0===t&&(t=""),void 0===n&&(n=[]);for(var i=0;i<e.children.length;i++){var r=e.children[i];if(r){var o=t?t+"/"+r.name:r.name;n.push(o),FJ(r,o,n)}}return n}var zJ=function(t){return e({SkeletalAnimation:t,SkeletalAnimationComponent:t}),t}((vJ=sl("cc.SkeletalAnimation"),gJ=El(),yJ=ll(99),SJ=yl(),xJ=Hl([NJ]),TJ=Rl(),EJ=Rl(),bJ=Hl([NJ]),vJ(CJ=gJ(CJ=yJ(CJ=gl(CJ=SJ((PJ=IJ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_useBakedAnimation",wJ,V(t)),q(t,"_sockets",RJ,V(t)),t}F(t,e);var n=t.prototype;return n.onDestroy=function(){e.prototype.onDestroy.call(this),i.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),i.director.getAnimationManager().removeSockets(this.node,this._sockets)},n.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,e.prototype.start.call(this)},n.querySockets=function(){var e=this._defaultClip&&Object.keys(tG.getOrExtract(this._defaultClip).joints).sort().reduce((function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e}),[])||[];if(!e.length)return["please specify a valid default animation clip first"];for(var t=[],n=0;n<e.length;n++){var i=e[n],r=this.node.getChildByPath(i);r&&(t.push(i),FJ(r,i,t))}return t},n.rebuildSocketAnimations=function(){for(var e,t=W(this._sockets);!(e=t()).done;){var n=e.value,i=this.node.getChildByPath(n.path),r=n.target;i&&r&&(r.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,HW(i,this.node,LJ),Ni.fromRTS(BJ,r.rotation,r.position,r.scale),Ni.equals(BJ,LJ)||(r.matrix=LJ))}for(var o=0,a=Object.keys(this._nameToState);o<a.length;o++){var s=a[o];this._nameToState[s].rebuildSocketCurves(this._sockets)}},n.createSocket=function(e){var t=this._sockets.find((function(t){return t.path===e}));if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;var n=new eA;return n.parent=this.node,this._sockets.push(new NJ(e,n)),this.rebuildSocketAnimations(),n},n._createState=function(e,t){return new MJ(e,t)},n._doCreateState=function(t,n){var i=e.prototype._doCreateState.call(this,t,n);return i.rebuildSocketCurves(this._sockets),i},L(t,[{key:"sockets",get:function(){return this._sockets},set:function(e){if(!this._useBakedAnimation){var t=i.director.getAnimationManager();t.removeSockets(this.node,this._sockets),t.addSockets(this.node,e)}this._sockets=e,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(e){this._useBakedAnimation=e;for(var t=this.node.getComponentsInChildren(iJ),n=0;n<t.length;++n){var r=t[n];r.skinningRoot===this.node&&r.setUseBakedAnimation(this._useBakedAnimation,!0)}this._useBakedAnimation?i.director.getAnimationManager().removeSockets(this.node,this._sockets):i.director.getAnimationManager().addSockets(this.node,this._sockets)}}]),t}(AW),IJ.Socket=NJ,X((AJ=PJ).prototype,"sockets",[xJ,TJ],Object.getOwnPropertyDescriptor(AJ.prototype,"sockets"),AJ.prototype),X(AJ.prototype,"useBakedAnimation",[EJ],Object.getOwnPropertyDescriptor(AJ.prototype,"useBakedAnimation"),AJ.prototype),wJ=X(AJ.prototype,"_useBakedAnimation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),RJ=X(AJ.prototype,"_sockets",[bJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CJ=AJ))||CJ)||CJ)||CJ)||CJ)||CJ));i.SkeletalAnimationComponent=zJ,He.setClassAlias(zJ,"cc.SkeletalAnimationComponent"),i.utils=bY;var UJ=new yi,kJ=new Ni;function GJ(e,t,n,i){var r=n.data,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(s,n.indicesCount)||(o=t.currBufferBatch,a=0,c=0,l=0);var u=o.vData,h=o.iData;e.getWorldMatrix(kJ);for(var f=0;f<s;f++){var _=r[f];yi.set(UJ,_.x,_.y,0),yi.transformMat4(UJ,UJ,kJ),u[a++]=UJ.x,u[a++]=UJ.y,u[a++]=UJ.z,u[a++]=_.u,u[a++]=_.v,vi.toArray(u,i,a),a+=4}for(var p=0,d=s/4;p<d;p++){var m=l+4*p;h[c++]=m,h[c++]=m+1,h[c++]=m+2,h[c++]=m+1,h[c++]=m+3,h[c++]=m+2}}var HJ=function(){function e(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new VJ;n.initWithSize(e,t),this._texture=n,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var t=e.prototype;return t.insertSpriteFrame=function(e){var t=e.rect,n=e.texture,r=this._innerTextureInfos[n.getId()],o=t.x,a=t.y;if(r)o+=r.x,a+=r.y;else{var s=n.width,c=n.height;if(this._x+s+2>this._width&&(this._x=2,this._y=this._nexty),this._y+c+2>this._nexty&&(this._nexty=this._y+c+2),this._nexty>this._height)return null;i.internal.dynamicAtlasManager.textureBleeding&&((s<=8||c<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,o+=this._x,a+=this._y,this._x+=s+2}var l={x:o,y:a,texture:this._texture};return this._innerSpriteFrames.push(e),l},t.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},t.isEmpty=function(){return this._count<=0},t.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},t.destroy=function(){this.reset(),this._texture.destroy()},e}(),VJ=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=lm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new xo;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(uv),jJ=function(){function e(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var t=e.prototype;return t.newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new HJ(this._textureSize,this._textureSize),this._atlases.push(e)),e},t.beforeSceneLoad=function(){this.reset()},t.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==hm.LINEAR||t.magFilter!==hm.LINEAR||t.mipFilter!==hm.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(e)},t.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},t.deleteAtlasSpriteFrame=function(e){if(e._original){for(var t,n=this._atlases.length-1;n>=0;n--)t=this._atlases[n],He.array.fastRemove(t._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}},t.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},t.packToDynamicAtlas=function(e,t){if(!t._original&&t.packable){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}},L(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),i.director.on(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),i.director.off(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),e}();jJ.instance=void 0;var WJ,qJ=e("dynamicAtlasManager",jJ.instance=new jJ);i.internal.dynamicAtlasManager=qJ;var XJ,YJ,KJ,QJ,ZJ=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],JJ=e("SpriteFrame",sl("cc.SpriteFrame")(WJ=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.uvHash=0,t.unbiasUV=[],t.uvSliced=[],t._rect=new Xi,t._offset=new zi,t._originalSize=new Wi,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t._original=null,t._packable=!0,t}F(t,e),t.createWithImage=function(e){var n=e instanceof Um?e:new Um(e),i=new uv;i.image=n;var r=new t;return r.texture=i,r};var n=t.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(e){this.rotated=e},n.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},n.setRect=function(e){this.rect=e},n.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},n.setOriginalSize=function(e){this.originalSize=e},n.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},n.setOffset=function(e){this.offset=e},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(e,t){void 0===t&&(t=!1);var n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(A(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height&&(A(3301,this.name+"/"+e.name,i,e.height),1))},n.destroy=function(){return this._packable&&qJ&&qJ.deleteAtlasSpriteFrame(this),e.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var e=this._rect,t=this.texture,n=t.width,i=t.height,r=this._capInsets[0],o=this._capInsets[2],a=e.width-r-o,s=this._capInsets[1],c=this._capInsets[3],l=e.height-s-c,u=this.uvSliced;if(u.length=0,this._rotated){ZJ[0].u=e.x/n,ZJ[1].u=(e.x+c)/n,ZJ[2].u=(e.x+c+l)/n,ZJ[3].u=(e.x+e.height)/n,ZJ[3].v=e.y/i,ZJ[2].v=(e.y+r)/i,ZJ[1].v=(e.y+r+a)/i,ZJ[0].v=(e.y+e.width)/i;for(var h=0;h<4;++h)for(var f=ZJ[h],_=0;_<4;++_){var p=ZJ[3-_];u.push({u:f.u,v:p.v})}}else{ZJ[0].u=e.x/n,ZJ[1].u=(e.x+r)/n,ZJ[2].u=(e.x+r+a)/n,ZJ[3].u=(e.x+e.width)/n,ZJ[3].v=e.y/i,ZJ[2].v=(e.y+s)/i,ZJ[1].v=(e.y+s+l)/i,ZJ[0].v=(e.y+e.height)/i;for(var d=0;d<4;++d)for(var m=ZJ[d],v=0;v<4;++v){var g=ZJ[v];u.push({u:g.u,v:m.v})}}},n._calculateUV=function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===o?0:e.y/o,l=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=a,t[5]=l,t[6]=a,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=a,t[5]=c,t[6]=a,t[7]=l):this._isFlipUVY?(t[0]=a,t[1]=l,t[2]=a,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=a,t[1]=c,t[2]=a,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,f=0===o?0:e.y/o,_=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVX?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVY?(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f):(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_)}else{var p=0===r?0:e.x/r,d=0===r?1:(e.x+e.width)/r,m=0===o?1:(e.y+e.height)/o,v=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):this._isFlipUVX?(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v):this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,S=0===o?1:(e.y+e.height)/o,x=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVX?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVY?(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S):(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x)}for(var T="",E=0;E<t.length;E++)T+=t[E];this.uvHash=Ma(T,666);var b=this.vertices;if(b){b.nu.length=0,b.nv.length=0;for(var C=0;C<b.u.length;C++)b.nu[C]=b.u[C]/r,b.nv[C]=b.v[C]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var e=qJ;if(e){var t=this._texture;if(t instanceof uv&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(e){var t=e,n=t.rect;n&&(this._rect=new Xi(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new zi(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new Wi(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var o=t.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var e,n,i,r,o,a,s,c,l=new t,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),l.uvHash=this.uvHash,(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new Xi(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new Wi(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new uv;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},n._calculateTillingOffset=function(){this._rotated?(this.tillingOffset[0]=this.uv[4]-this.uv[0],this.tillingOffset[1]=this.uv[3]-this.uv[5],this.tillingOffset[2]=this.uv[0],this.tillingOffset[3]=this.uv[5],this.tillingOffset[0]=-this.tillingOffset[0]):(this.tillingOffset[0]=this.uv[2]-this.uv[0],this.tillingOffset[1]=this.uv[1]-this.uv[5],this.tillingOffset[2]=this.uv[4],this.tillingOffset[3]=this.uv[5])},n._calculateSlicedData=function(){var e=this._rect,t=this._capInsets[0],n=this._capInsets[2],i=e.width-t-n,r=this._capInsets[1],o=this._capInsets[3],a=e.height-r-o,s=this.slicedData;s.length=0,s[0]=t/e.width,s[1]=r/e.height,s[2]=(t+i)/e.width,s[3]=(r+a)/e.height},L(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),t}(zu))||WJ);i.SpriteFrame=JJ;var $J,e$=e("SpriteAtlas",sl("cc.SpriteAtlas")((QJ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"spriteFrames",KJ,V(t)),t}F(t,e);var n=t.prototype;return n.getTexture=function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null},n.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},n.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e},n._serialize=function(){},n._deserialize=function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=_e();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],Ue(JJ))},t}(zu),KJ=X((YJ=QJ).prototype,"spriteFrames",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _e()}}),XJ=YJ))||XJ);i.SpriteAtlas=e$;var t$,n$,i$,r$,o$=e("Font",sl("cc.Font")($J=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t}(zu))||$J);i.Font=o$;var a$,s$,c$,l$,u$,h$,f$,_$,p$,d$=e("TTFFont",sl("cc.TTFFont")((r$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_fontFamily",i$,V(t)),t}return F(t,e),t.prototype.initDefault=function(t){this._fontFamily="Arial",e.prototype.initDefault.call(this,t)},L(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:Sn(this._native),__isNative__:!0}}}]),t}(o$),i$=X((n$=r$).prototype,"_fontFamily",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(n$.prototype,"_nativeAsset",[Jl,Gl],Object.getOwnPropertyDescriptor(n$.prototype,"_nativeAsset"),n$.prototype),X(n$.prototype,"_nativeDep",[Jl],Object.getOwnPropertyDescriptor(n$.prototype,"_nativeDep"),n$.prototype),t$=n$))||t$);i.TTFFont=d$;var m$,v$=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},g$=function(){function e(e){this.letterDefinitions={},this.texture=e}var t=e.prototype;return t.addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},t.cloneLetterDefinition=function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new v$;be(r,this.letterDefinitions[i]),e[i]=r}return e},t.getTexture=function(){return this.texture},t.getLetter=function(e){return this.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null},t.clear=function(){this.letterDefinitions={}},e}(),y$=e("BitmapFont",(a$=sl("cc.BitmapFont"),s$=Hl(JJ),a$((p$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"fntDataStr",u$,V(t)),q(t,"spriteFrame",h$,V(t)),q(t,"fontSize",f$,V(t)),q(t,"fntConfig",_$,V(t)),t}return F(t,e),t.prototype.onLoaded=function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new g$(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new v$,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else p("The fnt config is not exists!")},t}(o$),u$=X((l$=p$).prototype,"fntDataStr",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),h$=X(l$.prototype,"spriteFrame",[s$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f$=X(l$.prototype,"fontSize",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),_$=X(l$.prototype,"fntConfig",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c$=l$))||c$));i.BitmapFont=y$;var S$=e("LabelAtlas",sl("cc.LabelAtlas")(m$=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t}(y$))||m$);i.LabelAtlas=S$;var x$=e("BASELINE_RATIO",.26),T$=e("MIDDLE_RATIO",(x$+1)/2-x$);var E$=new ke(2);E$.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var b$,C$=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var n=E$.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,E$.put(i)}this.moveToHead(n)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),A$=/([a-zA-Z0-9--]+|\S)/,w$=/^[!,.:;'}\]%\?>]/,R$=/([a-zA-Z0-9--]+|\S)$/,I$=/[a-zA-Z0-9--]+$/,P$=/^[a-zA-Z0-9--]/;function O$(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function D$(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function M$(e,t,n){var i=(n||e.font)+""+t,r=C$.get(i);if(null!==r)return r;var o=e.measureText(t),a=o&&o.width||0;return C$.put(i,a),a}function N$(e,t,n){var i=t,r=n,o=e[t];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==t){var a=e[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return e.substring(i,r)}function L$(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var o=e;t>n&&o.length>1;){for(var a=o.length*(n/t)|0,s=N$(o,a),c=t-i(s),l=s,u=0,h=0;c>n&&h++<10;)a*=n/c,c=t-i(s=N$(o,a|=0));for(h=0;c<=n&&h++<10;){if(s){var f=A$.exec(s);u=f?f[0].length:1,l=s}c=t-i(s=N$(o,a+=u))}0==(a-=u)?(a=1,l=N$(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=N$(o,2));var _=N$(o,0,a),p=void 0;w$.test(l||s)&&(0==(a-=(p=R$.exec(_))?p[0].length:0)&&(a=1),l=N$(o,a),_=N$(o,0,a)),P$.test(l)&&(p=I$.exec(_))&&_!==p[0]&&(l=N$(o,a-=p[0].length),_=N$(o,0,a)),(0===r.length||(_=_.trim()).length>0)&&r.push(_),t=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var B$,F$,z$,U$,k$,G$,H$,V$,j$,W$,q$,X$,Y$,K$,Q$,Z$=e("CanvasPool",function(){function e(){this.pool=[]}e.getInstance=function(){return b$||(b$=new e),b$};var t=e.prototype;return t.get=function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e},t.put=function(e){this.pool.length>=tt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},e}()),J$=vi.WHITE.clone(),$$=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},e0="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",t0=function(){function e(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}var t=e.prototype;return t.updateRenderData=function(){this._updateProperties(),this._updateTexture()},t.destroy=function(){this.image=null},t._updateProperties=function(){if(this.data=Z$.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=M$(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+x$)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*x$/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Um),this.image.reset(this.canvas)},t._updateTexture=function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=e0,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,o=n/2,a=i/2+r*T$+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",t.isOutlined){var c=t.out||J$;e.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,o,a)}e.fillText(this.char,o,a)}},e}(),n0=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=lm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new xo;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(uv),i0=function(){function e(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new n0;n.initWithSize(e,t),this.fontDefDictionary=new g$(n),this._halfBleed=1,this._width=e,this._height=t,eN.on($M.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var t=e.prototype;return t.insertLetterTexture=function(e){var t=e.image,n=eN.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return b(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var o=new $$;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=e.width-2,o.h=e.height-2,o.xAdvance=o.w,o.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,o),o},t.update=function(){this._dirty&&(this._dirty=!1)},t.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},t.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},t.getTexture=function(){return this.fontDefDictionary.getTexture()},t.beforeSceneLoad=function(){this.clearAllCache()},t.clearAllCache=function(){this.destroy();var e=new n0;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},t.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new t0(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},L(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(),r0={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:vi.WHITE.clone(),isOutlined:!1,out:vi.WHITE.clone(),margin:0},o0=function(){this.material=null,this.vertexCount=0,this.indicesCount=0},a0=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).vData=null,t.uvDirty=!0,t.vertDirty=!0,t._data=[],t._indices=[],t._pivotX=0,t._pivotY=0,t._width=0,t._height=0,t.renderScene=null,t.layer=0,t.nodeDirty=!0,t.blendHash=-1,t.passDirty=!0,t.frame=void 0,t.textureHash=0,t.textureDirty=!0,t.hashDirty=!0,t.dataHash=0,t}F(t,e),t.add=function(){return l0.add()},t.remove=function(e){var t=l0.data.indexOf(e);-1!==t&&(l0.data[t].clear(),l0.removeAt(t))};var n=t.prototype;return n.updateNode=function(e){this.renderScene=e.node.scene?e._getRenderScene():null,this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var e=" "+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=Ma(e,666),this.hashDirty=!1},n.updateRenderData=function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty&&(this.renderScene=e.node.scene?e._getRenderScene():null,this.layer=e.node.layer,null!==this.renderScene&&(this.nodeDirty=!1),this.hashDirty=!0),this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty){var n=" "+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=Ma(n,666),this.hashDirty=!1}},n.updateSizeNPivot=function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.renderScene=null,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},L(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)c0.free(t[i]);for(i=n;i<e;i++)t[i]=c0.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}(o0),s0=function(e){function t(t){var n;return void 0===t&&(t=9),(n=e.call(this)||this).vData=void 0,n.iData=void 0,n.vertexStart=0,n.indicesStart=0,n.byteStart=0,n.byteCount=0,n.lastFilledIndices=0,n.lastFilledVertex=0,n._formatByte=void 0,n._formatByte=t*Float32Array.BYTES_PER_ELEMENT,n.vData=new Float32Array(256*t*Float32Array.BYTES_PER_ELEMENT),n.iData=new Uint16Array(1536),n}F(t,e),t.add=function(){return u0.add()},t.remove=function(e){var t=u0.data.indexOf(e);-1!==t&&(u0.data[t].reset(),u0.removeAt(t))};var n=t.prototype;return n.request=function(e,t){var n=this.byteCount+e*this._formatByte;return this.reserve(e,t),this.vertexCount+=e,this.indicesCount+=t,this.byteCount=n,!0},n.reserve=function(e,t){var n=this.byteCount+e*this._formatByte,i=this.indicesCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.advance=function(e,t){this.vertexCount+=e,this.indicesCount+=t,this.byteCount+=e*this._formatByte},n.reset=function(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.lastFilledIndices=0,this.lastFilledVertex=0},n._reallocBuffer=function(e,t){var n=this.vData;this.vData=new Float32Array(e),this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),this.iData.set(i,0)},L(t,[{key:"formatByte",get:function(){return this._formatByte},set:function(e){this._formatByte=e}},{key:"floatStride",get:function(){return this._formatByte>>2}},{key:"vDataOffset",get:function(){return this.byteCount>>>2}}]),t}(o0),c0=(function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;n._fillQuadBuffer=function(){for(var e=this.iData.length/6,t=this.iData,n=0,i=0;n<e;n++){var r=4*n;t[i++]=r,t[i++]=r+1,t[i++]=r+2,t[i++]=r+1,t[i++]=r+3,t[i++]=r+2}},n._reallocBuffer=function(t,n){e.prototype._reallocBuffer.call(this,t,n),this._fillQuadBuffer()}}(s0),new We((function(){return{x:0,y:0,z:0,u:0,v:0,color:vi.WHITE.clone()}}),128)),l0=new qe((function(){return new a0}),32),u0=new qe((function(){return new s0}),32),h0=new zi,f0=new zi,_0=new yi,p0=new Ni,d0=new Ni,m0=new Ni,v0=new Ni(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),g0=new Xi,y0=function(t){return e({UITransform:t,UITransformComponent:t}),t}((B$=sl("cc.UITransform"),F$=El(),z$=ll(110),U$=yl(),k$=Nl(),G$=Rl(),H$=Nl(),V$=Rl(),B$(j$=F$(j$=z$(j$=U$(j$=ul(j$=gl((K$=Y$=function(e){function t(){var t;return(t=e.call(this)||this)._priority=0,q(t,"_contentSize",q$,V(t)),q(t,"_anchorPoint",X$,V(t)),t}F(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&t.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(JE.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(JE.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(e,t){var n=this._contentSize;if(void 0===t){if((e=e).width===n.width&&e.height===n.height)return;n.width=e.width,n.height=e.height}else{if(e===n.width&&t===n.height)return;n.width=e,n.height=t}this.node.emit(JE.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(JE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(e){for(var t,n=this._contentSize.width,i=this._contentSize.height,r=h0,o=f0,a=null===(t=this.node)||void 0===t?void 0:t.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(p0);var u=p0.m12,h=p0.m13,f=iN.center;if(p0.m12=f.x-(p0.m00*u+p0.m04*h),p0.m13=f.y-(p0.m01*u+p0.m05*h),Ni.invert(p0,p0),zi.transformMat4(r,e,p0),this.node.getWorldMatrix(m0),Ni.invert(p0,m0),!Ni.strictEquals(p0,v0)){zi.transformMat4(o,r,p0),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i;var _=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i&&(_=!0,a&&a.maskList))for(var p=a.maskList,d=this.node,m=p?p.length:0,v=0,g=0;d&&g<m;++v,d=d.parent){var y=p[g];if(v===y.index){if(d!==y.comp.node){p.length=g;break}var S=y.comp;if(S&&S._enabled&&!S.isHit(r)){_=!1;break}g++}else if(v>y.index){p.length=g;break}}if(_)return!0}}}return!1},n.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(m0),Ni.invert(p0,m0),t||(t=new yi),yi.transformMat4(t,e,p0)},n.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(m0),t||(t=new yi),yi.transformMat4(t,e,m0)},n.getBoundingBox=function(){Ni.fromRTS(d0,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new Xi(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(d0),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(m0),this.getBoundingBoxTo(m0)):this.getBoundingBox()},n.getBoundingBoxTo=function(e){Ni.fromRTS(d0,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new Xi(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(Ni.multiply(m0,e,d0),r.transformMat4(m0),!this.node.children)return r;for(var o,a=W(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(t);if(c){var l=c.getBoundingBoxTo(e);l&&Xi.union(r,r,l)}}}return r},n.getComputeAABB=function(e){var t=this._contentSize.width,n=this._contentSize.height;g0.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),g0.transformMat4(this.node.worldMatrix);var i=g0.x+.5*g0.width,r=g0.y+.5*g0.height,o=this.node.worldPosition.z,a=g0.width/2,s=g0.height/2;return null!=e?(zc.set(e,i,r,o,a,s,.001),e):new zc(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))},n.checkAndUpdateRect=function(e,t){if(this._rectDirty){this._rectWithScale.x=t.x*this.width,this._rectWithScale.y=t.y*this.height,this._rectWithScale.z=t.z;var n=(.5-this.anchorPoint.x)*this.width*t.x,i=(.5-this.anchorPoint.y)*this.height*t.y;yi.transformQuat(this._anchorCache,_0.set(n,i,0),e)}},n.setRectDirty=function(e){e&ig.RS&&(this._rectDirty=!0)},t.insertChangeMap=function(e){var n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)},t._sortChildrenSibling=function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))},t._sortSiblings=function(){t.priorityChangeNodeMap.forEach((function(e){t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()},t._cleanChangeMap=function(){t.priorityChangeNodeMap.clear()},L(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(JE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(JE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(JE.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(JE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(JE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(JE.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?b(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=eN.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=eN.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),t}(oh),Y$.EventType=JE,Y$.priorityChangeNodeMap=new Map,X((W$=K$).prototype,"contentSize",[k$,G$],Object.getOwnPropertyDescriptor(W$.prototype,"contentSize"),W$.prototype),X(W$.prototype,"anchorPoint",[H$,V$],Object.getOwnPropertyDescriptor(W$.prototype,"anchorPoint"),W$.prototype),q$=X(W$.prototype,"_contentSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wi(100,100)}}),X$=X(W$.prototype,"_anchorPoint",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(.5,.5)}}),j$=W$))||j$)||j$)||j$)||j$)||j$)||j$));eN.on($M.EVENT_AFTER_UPDATE,y0._sortSiblings),eN.on($M.EVENT_BEFORE_SCENE_LAUNCH,y0._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(Q$||(Q$={}));var S0,x0,T0,E0,b0,C0,A0,w0,R0,I0,P0,O0,D0,M0,N0,L0,B0,F0,z0,U0,k0=e("StencilManager",function(){function e(){this.stage=Q$.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Ur.ALWAYS,stencilMask:65535,writeMask:65535,failOp:kr.KEEP,zFailOp:kr.KEEP,passOp:kr.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var t=e.prototype;return t.pushMask=function(e){this._maskStack.push(e)},t.clear=function(e){e.stencilStage=e.inverted?Q$.CLEAR_INVERTED:Q$.CLEAR},t.enterLevel=function(e){e.graphics.stencilStage=e.inverted?Q$.ENTER_LEVEL_INVERTED:Q$.ENTER_LEVEL},t.enableMask=function(){this.stage=Q$.ENABLED},t.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=Q$.DISABLED:this.stage=Q$.ENABLED)},t.getWriteMask=function(){return 1<<this._maskStack.length-1},t.getExitWriteMask=function(){return 1<<this._maskStack.length},t.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},t.reset=function(){this._maskStack.length=0,this.stage=Q$.DISABLED},t.destroy=function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()},t.getStencilStage=function(e,t){var n=0,i=!1,r=!1,o=Ur.LESS,a=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(e);var u=new Ua(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},t.getStencilHash=function(e){return e<<8|this._maskStack.length},t.setStateFromStage=function(e){var t=this._stencilPattern;e===Q$.DISABLED?(t.stencilTest=!1,t.func=Ur.ALWAYS,t.failOp=kr.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===Q$.ENABLED?(t.func=Ur.EQUAL,t.failOp=kr.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===Q$.CLEAR?(t.func=Ur.NEVER,t.failOp=kr.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===Q$.CLEAR_INVERTED||e===Q$.ENTER_LEVEL?(t.func=Ur.NEVER,t.failOp=kr.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===Q$.ENTER_LEVEL_INVERTED&&(t.func=Ur.NEVER,t.failOp=kr.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},L(e,[{key:"pattern",get:function(){return this._stencilPattern}}]),e}());k0.sharedManager=null,k0.sharedManager=new k0,$e(Gr),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(U0||(U0=e("InstanceMaterialType",{})));var G0,H0,V0,j0,W0,q0,X0,Y0,K0,Q0,Z0,J0,$0,e1,t1,n1,i1,r1,o1,a1,s1,c1,l1,u1,h1,f1,_1,p1,d1,m1,v1,g1,y1,S1,x1,T1,E1,b1,C1,A1,w1,R1,I1,P1,O1,D1,M1,N1,L1,B1,F1,z1,U1,k1,G1,H1,V1,j1,W1,q1,X1,Y1,K1,Q1,Z1,J1,$1,e2,t2,n2=function(t){return e({Renderable2D:t,RenderComponent:t,UIRenderable:t}),t}((S0=sl("cc.Renderable2D"),x0=cl(y0),T0=Cl(),E0=Hl(Ng),b0=Hl(Ng),C0=Nl(),A0=Rl(),w0=wl(),R0=Nl(),I0=Rl(),S0(P0=x0(P0=ul(P0=gl((z0=F0=function(e){F(n,e);var t=n.prototype;function n(){var t;return q(t=e.call(this)||this,"_materials",D0,V(t)),q(t,"_customMaterial",M0,V(t)),t.stencilStage=Q$.DISABLED,q(t,"_srcBlendFactor",N0,V(t)),q(t,"_dstBlendFactor",L0,V(t)),q(t,"_color",B0,V(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._delegateSrc=null,t._instanceMaterialType=-1,t._blendState=new Ga,t._blendHash=0,t._colorDirty=!0,t._lastParent=null,t}return t.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()},t.updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},t.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler(),cb.markOpacityTree(this.node)},t.onEnable=function(){this.node.on(JE.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(JE.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},t.onRestore=function(){this.updateMaterial(),this._renderFlag=this._canRender()},t.onDisable=function(){this.node.off(JE.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(JE.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},t.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++)this._materialInstances[e]&&this._materialInstances[e].destroy();this._renderData=null,this._blendState&&this._blendState.destroy()},t.markForUpdateRenderData=function(e){if(void 0===e&&(e=!0),this._renderFlag=this._canRender(),e&&this._renderFlag){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else e||(this._renderDataFlag=e)},t.requestRenderData=function(){var e=a0.add();return this._renderData=e,e},t.destroyRenderData=function(){this._renderData&&(a0.remove(this._renderData),this._renderData=null)},t.updateAssembler=function(e){this._updateColor(),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))},t.postUpdateAssembler=function(e){this._renderFlag&&this._postRender(e)},t._render=function(){},t._postRender=function(){},t._checkAndUpdateRenderData=function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)},t._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this.node._uiProps.opacity>0},t._postCanRender=function(){},t._updateColor=function(){this._colorDirty&&this._assembler&&this._assembler.updateColor&&(this._assembler.updateColor(this),this._renderFlag=this._canRender(),this._colorDirty=!1)},t.markColorDirty=function(){this._colorDirty=!0},t._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new ka,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=Gr.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},t.getBlendState=function(){return this._blendState},t._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var t=this.node.children[e].getComponent(n);t&&t.markForUpdateRenderData()}},t._onMaterialModified=function(t,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),e.prototype._onMaterialModified.call(this,t,n)},t._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case U0.ADD_COLOR:e=Vv.get("ui-base-material");break;case U0.GRAYSCALE:e=Vv.get("ui-sprite-gray-material");break;case U0.USE_ALPHA_SEPARATED:e=Vv.get("ui-sprite-alpha-sep-material");break;case U0.USE_ALPHA_SEPARATED_AND_GRAY:e=Vv.get("ui-sprite-gray-alpha-sep-material");break;default:e=Vv.get("ui-sprite-material")}return e},t.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},t.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},L(n,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&b(12001),this._srcBlendFactor},set:function(e){this._customMaterial?b(12001):this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&b(12001),this._dstBlendFactor},set:function(e){this._customMaterial?b(12001):this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){if(!this._color.equals(e)){var t=this._color.a;this._color.set(e),t!==this.color.a&&cb.markOpacityTree(this.node),this._colorDirty=!0}}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}}]),n}(bF),F0.BlendState=Gr,F0.Assembler=null,F0.PostAssembler=null,D0=X((O0=z0).prototype,"_materials",[Jl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X(O0.prototype,"sharedMaterials",[Jl,T0],Object.getOwnPropertyDescriptor(O0.prototype,"sharedMaterials"),O0.prototype),M0=X(O0.prototype,"_customMaterial",[E0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(O0.prototype,"customMaterial",[b0,C0,A0,w0],Object.getOwnPropertyDescriptor(O0.prototype,"customMaterial"),O0.prototype),X(O0.prototype,"color",[R0,I0],Object.getOwnPropertyDescriptor(O0.prototype,"color"),O0.prototype),N0=X(O0.prototype,"_srcBlendFactor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gr.SRC_ALPHA}}),L0=X(O0.prototype,"_dstBlendFactor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gr.ONE_MINUS_SRC_ALPHA}}),B0=X(O0.prototype,"_color",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.WHITE.clone()}}),P0=O0))||P0)||P0)||P0)||P0));i.internal.Renderable2D=n2,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(J1||(J1=e("HorizontalTextAlignment",{}))),$e(J1),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}($1||($1=e("VerticalTextAlignment",{}))),$e($1),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(e2||(e2=e("Overflow",{}))),$e(e2),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(t2||(t2=e("CacheMode",{}))),$e(t2);var i2,r2,o2,a2=function(t){return e({Label:t,LabelComponent:t}),t}((G0=sl("cc.Label"),H0=El(),V0=ll(110),j0=yl(),W0=Nl(),q0=Rl(),X0=Hl(J1),Y0=Nl(),K0=Rl(),Q0=Hl($1),Z0=Nl(),J0=Rl(),$0=Nl(),e1=Rl(),t1=Nl(),n1=Cl(),i1=Rl(),r1=Nl(),o1=Rl(),a1=Cl(),s1=Nl(),c1=Rl(),l1=Hl(e2),u1=Nl(),h1=Rl(),f1=Nl(),_1=Rl(),p1=Hl(o$),d1=Nl(),m1=Cl(),v1=Rl(),g1=Nl(),y1=Rl(),S1=Hl(t2),x1=Nl(),T1=Rl(),E1=Nl(),b1=Rl(),C1=Nl(),A1=Rl(),w1=Nl(),R1=Rl(),I1=Cl(),P1=Nl(),O1=Rl(),G0(D1=H0(D1=V0(D1=j0((Z1=Q1=function(e){function t(){var t;return q(t=e.call(this)||this,"_string",N1,V(t)),q(t,"_horizontalAlign",L1,V(t)),q(t,"_verticalAlign",B1,V(t)),q(t,"_actualFontSize",F1,V(t)),q(t,"_fontSize",z1,V(t)),q(t,"_fontFamily",U1,V(t)),q(t,"_lineHeight",k1,V(t)),q(t,"_overflow",G1,V(t)),q(t,"_enableWrapText",H1,V(t)),q(t,"_font",V1,V(t)),q(t,"_isSystemFontUsed",j1,V(t)),t._spacingX=0,q(t,"_isItalic",W1,V(t)),q(t,"_isBold",q1,V(t)),q(t,"_isUnderline",X1,V(t)),q(t,"_underlineHeight",Y1,V(t)),q(t,"_cacheMode",K1,V(t)),t._N$file=null,t._texture=null,t._ttfSpriteFrame=null,t._userDefinedFont=null,t._assemblerData=null,t._fontAtlas=null,t._letterTexture=null,t._ttfSpriteFrame=null,t}F(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){var n=t;n.image&&n.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,e.prototype.onDestroy.call(this)},n.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(e){e.commitComp(this,this._texture,this._assembler,null)},n._updateColor=function(){this._colorDirty&&(this.updateRenderData(!1),this._colorDirty=!1)},n._canRender=function(){if(!e.prototype._canRender.call(this)||!this._string)return!1;var t=this._font;if(t&&t instanceof y$){var n=t.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof y$){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===t2.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new JJ,this._assemblerData=this._assembler.getAssemblerData();var n=new Um(this._assemblerData.canvas),i=new uv;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==t2.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var e=!1;if(this.cacheMode!==t2.CHAR){var t=this._texture.texture;if(t instanceof Gm){var n=t.getPixelFormat();e=n===lm.RGBA_ETC1||n===lm.RGB_A_PVRTC_4BPPV1||n===lm.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?U0.USE_ALPHA_SEPARATED:U0.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},L(t,[{key:"string",get:function(){return this._string},set:function(e){e?e+="":e="",this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==t2.BITMAP||this._font instanceof y$||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===t2.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof y$?this._font.fontSize:-1}}]),t}(n2),Q1.HorizontalAlign=J1,Q1.VerticalAlign=$1,Q1.Overflow=e2,Q1.CacheMode=t2,Q1._canvasPool=Z$.getInstance(),X((M1=Z1).prototype,"string",[W0,q0,Bl],Object.getOwnPropertyDescriptor(M1.prototype,"string"),M1.prototype),X(M1.prototype,"horizontalAlign",[X0,Y0,K0],Object.getOwnPropertyDescriptor(M1.prototype,"horizontalAlign"),M1.prototype),X(M1.prototype,"verticalAlign",[Q0,Z0,J0],Object.getOwnPropertyDescriptor(M1.prototype,"verticalAlign"),M1.prototype),X(M1.prototype,"fontSize",[$0,e1],Object.getOwnPropertyDescriptor(M1.prototype,"fontSize"),M1.prototype),X(M1.prototype,"fontFamily",[t1,n1,i1],Object.getOwnPropertyDescriptor(M1.prototype,"fontFamily"),M1.prototype),X(M1.prototype,"lineHeight",[r1,o1],Object.getOwnPropertyDescriptor(M1.prototype,"lineHeight"),M1.prototype),X(M1.prototype,"spacingX",[a1,s1,c1],Object.getOwnPropertyDescriptor(M1.prototype,"spacingX"),M1.prototype),X(M1.prototype,"overflow",[l1,u1,h1],Object.getOwnPropertyDescriptor(M1.prototype,"overflow"),M1.prototype),X(M1.prototype,"enableWrapText",[f1,_1],Object.getOwnPropertyDescriptor(M1.prototype,"enableWrapText"),M1.prototype),X(M1.prototype,"font",[p1,d1,m1,v1],Object.getOwnPropertyDescriptor(M1.prototype,"font"),M1.prototype),X(M1.prototype,"useSystemFont",[g1,y1],Object.getOwnPropertyDescriptor(M1.prototype,"useSystemFont"),M1.prototype),X(M1.prototype,"cacheMode",[S1,x1,T1],Object.getOwnPropertyDescriptor(M1.prototype,"cacheMode"),M1.prototype),X(M1.prototype,"isBold",[E1,b1],Object.getOwnPropertyDescriptor(M1.prototype,"isBold"),M1.prototype),X(M1.prototype,"isItalic",[C1,A1],Object.getOwnPropertyDescriptor(M1.prototype,"isItalic"),M1.prototype),X(M1.prototype,"isUnderline",[w1,R1],Object.getOwnPropertyDescriptor(M1.prototype,"isUnderline"),M1.prototype),X(M1.prototype,"underlineHeight",[I1,bl,P1,O1],Object.getOwnPropertyDescriptor(M1.prototype,"underlineHeight"),M1.prototype),N1=X(M1.prototype,"_string",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),L1=X(M1.prototype,"_horizontalAlign",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return J1.CENTER}}),B1=X(M1.prototype,"_verticalAlign",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $1.CENTER}}),F1=X(M1.prototype,"_actualFontSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),z1=X(M1.prototype,"_fontSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),U1=X(M1.prototype,"_fontFamily",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),k1=X(M1.prototype,"_lineHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),G1=X(M1.prototype,"_overflow",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e2.NONE}}),H1=X(M1.prototype,"_enableWrapText",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),V1=X(M1.prototype,"_font",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),j1=X(M1.prototype,"_isSystemFontUsed",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),W1=X(M1.prototype,"_isItalic",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q1=X(M1.prototype,"_isBold",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X1=X(M1.prototype,"_isUnderline",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y1=X(M1.prototype,"_underlineHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),K1=X(M1.prototype,"_cacheMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return t2.NONE}}),D1=M1))||D1)||D1)||D1)||D1));!function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(i2||(i2={})),$e(i2),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(r2||(r2={})),$e(r2),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(o2||(o2={})),$e(o2);var s2=Math.PI,c2=Math.min,l2=Math.max,u2=Math.cos,h2=Math.sin,f2=Math.abs,_2=Math.sign,p2=.5522847493;function d2(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*p2,t-i*p2,n+r,t,n+r),e.bezierCurveTo(t+i*p2,n+r,t+i,n+r*p2,t+i,n),e.bezierCurveTo(t+i,n-r*p2,t+i*p2,n-r,t,n-r),e.bezierCurveTo(t-i*p2,n-r,t-i,n-r*p2,t-i,n),e.close()}function m2(e,t,n,i,r,o,a,s,c,l,u){var h,f,_,p,d,m,v,g,y,S,x,T,E,b,C,A;l>10||(d=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(t+i))+(_=.5*(i+o))),g=.5*((f=.5*(n+r))+(p=.5*(r+a))),((C=f2((i-s)*(b=c-n)-(r-c)*(E=s-t)))+(A=f2((o-s)*b-(a-c)*E)))*(C+A)<e.tessTol*(E*E+b*b)?e.addPoint(s,c,0===u?u|o2.PT_BEVEL:u):(m2(e,t,n,h,f,v,g,x=.5*(v+(y=.5*(_+d))),T=.5*(g+(S=.5*(p+m))),l+1,0),m2(e,x,T,y,S,d,m,s,c,l+1,u)))}var v2,g2,y2,S2,x2,T2,E2,b2,C2,A2,w2,R2,I2,P2,O2,D2,M2,N2,L2,B2,F2,z2,U2,k2=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return F(t,e),t.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},t}(zi),G2=function(){function e(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return e.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},e}(),H2=function(){function e(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=vi.WHITE.clone(),this.lineCap=i2.BUTT,this.strokeColor=vi.BLACK.clone(),this.lineJoin=r2.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var t=e.prototype;return t.moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,o2.PT_CORNER),this._commandX=e,this._commandY=t},t.lineTo=function(e,t){this.addPoint(e,t,o2.PT_CORNER),this._commandX=e,this._commandY=t},t.bezierCurveTo=function(e,t,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==o?(m2(this,s.x,s.y,e,t,n,i,r,o,0,o2.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},t.quadraticCurveTo=function(e,t,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(e-r),o+2/3*(t-o),n+2/3*(e-n),i+2/3*(t-i),n,i)},t.arc=function(e,t,n,i,r,o){!function(e,t,n,i,r,o,a){var s,c,l=0,u=0,h=0,f=0,_=0,p=0,d=0,m=0,v=0,g=0,y=0,S=0,x=0,T=0;if(u=o-r,a=a||!1)if(f2(u)>=2*s2)u=2*s2;else for(;u<0;)u+=2*s2;else if(f2(u)>=2*s2)u=2*-s2;else for(;u>0;)u-=2*s2;for(c=0|l2(1,c2(f2(u)/(.5*s2)+.5,5)),h=f2(4/3*(1-u2(s=u/c/2))/h2(s)),a||(h=-h),T=0;T<=c;T++)p=t+(f=u2(l=r+u*(T/c)))*i,d=n+(_=h2(l))*i,m=-_*i*h,v=f*i*h,0===T?e.moveTo(p,d):e.bezierCurveTo(g+S,y+x,p-m,d-v,p,d),g=p,y=d,S=m,x=v}(this,e,t,n,i,r,o)},t.ellipse=function(e,t,n,i){d2(this,e,t,n,i),this._curPath.complex=!1},t.circle=function(e,t,n){d2(this,e,t,n,n),this._curPath.complex=!1},t.rect=function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1},t.roundRect=function(e,t,n,i,r){!function(e,t,n,i,r,o){if(o<.1)e.rect(t,n,i,r);else{var a=c2(o,.5*f2(i))*_2(i),s=c2(o,.5*f2(r))*_2(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-p2),t+a*(1-p2),n+r,t+a,n+r),e.lineTo(t+i-a,n+r),e.bezierCurveTo(t+i-a*(1-p2),n+r,t+i,n+r-s*(1-p2),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-p2),t+i-a*(1-p2),n,t+i-a,n),e.lineTo(t+a,n),e.bezierCurveTo(t+a*(1-p2),n,t,n+s*(1-p2),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1},t.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&s0.remove(i)}this._renderDataList.length=0},t.close=function(){this._curPath.closed=!0},t.requestRenderData=function(){var e=s0.add();return this._renderDataList.push(e),e},t.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},t.addPoint=function(e,t,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=e,a.y=t):(a=new k2(e,t),r.push(a)),a.flags=n,o.push(a)}},t._addPath=function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new G2,this.paths.push(t)),this.pathLength++,this._curPath=t,t},e}(),V2=[new jo(uo.ATTR_POSITION,Cr.RGB32F)],j2=[new jo(uo.ATTR_POSITION,Cr.RGB32F),new jo(uo.ATTR_COLOR,Cr.RGBA32F)],W2=[new jo(uo.ATTR_POSITION,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD,Cr.RG32F),new jo(uo.ATTR_COLOR,Cr.RGBA32F)],q2=[new jo(uo.ATTR_POSITION,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD,Cr.RG32F),new jo(uo.ATTR_COLOR,Cr.RGBA32F),new jo(uo.ATTR_COLOR2,Cr.RGBA32F)];function X2(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=pa[i.format].count}return t}function Y2(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=pa[i.format].size}return t}i.internal.vfmtPosUvColor=W2,i.internal.vfmtPosUvTwoColor=q2,e("UIVertexFormat",Object.freeze({__proto__:null,vfmt:V2,vfmtPosColor:j2,vfmtPosUvColor:W2,vfmtPosUvTwoColor:q2,getComponentPerVertex:X2,getAttributeStride:Y2}));var K2,Q2,Z2,J2,$2,e4,t4,n4,i4,r4,o4,a4,s4,c4,l4,u4,h4,f4,_4,p4,d4,m4,v4,g4,y4,S4,x4=j2.concat([new jo("a_dist",Cr.R32F)]),T4=X2(x4),E4=Y2(x4),b4=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((v2=sl("cc.Graphics"),g2=El(),y2=ll(110),S2=yl(),x2=Rl(),T2=Hl(r2),E2=Rl(),b2=Hl(i2),C2=Rl(),A2=Rl(),w2=Rl(),R2=Rl(),I2=Cl(),v2(P2=g2(P2=y2(P2=S2((U2=z2=function(e){function t(){var t;return(t=e.call(this)||this).impl=null,t.model=null,q(t,"_lineWidth",D2,V(t)),q(t,"_strokeColor",M2,V(t)),q(t,"_lineJoin",N2,V(t)),q(t,"_lineCap",L2,V(t)),q(t,"_fillColor",B2,V(t)),q(t,"_miterLimit",F2,V(t)),t._isDrawing=!1,t._isNeedUploadData=!0,t._graphicsUseSubMeshes=[],t._instanceMaterialType=U0.ADD_COLOR,t.impl=new H2,t}F(t,e);var n=t.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=eN.root.createModel(ag),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._sceneGetter=null,this.model&&(eN.root.destroyModel(this.model),this.model=null);var t=this._graphicsUseSubMeshes.length;if(t>0){for(var n=0;n<t;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,n,i,r,o){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,o)},n.quadraticCurveTo=function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)},n.arc=function(e,t,n,i,r,o){this.impl&&this.impl.arc(e,t,n,i,r,o)},n.ellipse=function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)},n.circle=function(e,t,n){this.impl&&this.impl.circle(e,t,n)},n.rect=function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)},n.roundRect=function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)},n.fillRect=function(e,t,n,i){this.rect(e,t,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=Vv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){if(this.model){if(this.model.subModels.length<=e){var t=i.director.root.device,n=t.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.DEVICE,65535*E4,E4)),r=t.createBuffer(new wo(Rr.INDEX|Rr.TRANSFER_DST,Or.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),o=new QA([n],x4,Qr.TRIANGLE_LIST,r);o.subMeshIdx=0,this.model.initSubModel(e,o,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(o)}}else b(4500,this.node.name)},n._uploadData=function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<t.length;i++){var r=t[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*T4);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indicesStart);o.indexBuffer.update(s),o.indexCount=r.indicesStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndices=r.indicesStart}}this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!e.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},L(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),t}(n2),z2.LineJoin=r2,z2.LineCap=i2,X((O2=U2).prototype,"lineWidth",[bl,x2],Object.getOwnPropertyDescriptor(O2.prototype,"lineWidth"),O2.prototype),X(O2.prototype,"lineJoin",[T2,E2],Object.getOwnPropertyDescriptor(O2.prototype,"lineJoin"),O2.prototype),X(O2.prototype,"lineCap",[b2,C2],Object.getOwnPropertyDescriptor(O2.prototype,"lineCap"),O2.prototype),X(O2.prototype,"strokeColor",[A2],Object.getOwnPropertyDescriptor(O2.prototype,"strokeColor"),O2.prototype),X(O2.prototype,"fillColor",[w2],Object.getOwnPropertyDescriptor(O2.prototype,"fillColor"),O2.prototype),X(O2.prototype,"miterLimit",[R2],Object.getOwnPropertyDescriptor(O2.prototype,"miterLimit"),O2.prototype),X(O2.prototype,"color",[Jl,I2],Object.getOwnPropertyDescriptor(O2.prototype,"color"),O2.prototype),D2=X(O2.prototype,"_lineWidth",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),M2=X(O2.prototype,"_strokeColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.BLACK.clone()}}),N2=X(O2.prototype,"_lineJoin",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return r2.MITER}}),L2=X(O2.prototype,"_lineCap",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i2.BUTT}}),B2=X(O2.prototype,"_fillColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.WHITE.clone()}}),F2=X(O2.prototype,"_miterLimit",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),P2=O2))||P2)||P2)||P2)||P2)),C4=new Ni,A4=new zi,w4=new Ni,R4=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(S4||(S4={})),$e(S4);var I4=function(t){return e({Mask:t,MaskComponent:t}),t}((K2=sl("cc.Mask"),Q2=El(),Z2=ll(110),J2=yl(),$2=Hl(S4),e4=Nl(),t4=Rl(),n4=Nl(),i4=Rl(),r4=Cl(),o4=Hl(JJ),a4=Cl(),s4=Cl(),c4=Il(),l4=Cl(),u4=Cl(),K2(h4=Q2(h4=Z2(h4=J2((y4=g4=function(e){function t(){var t;return(t=e.call(this)||this)._clearStencilMtl=null,t._clearModel=null,q(t,"_type",_4,V(t)),q(t,"_inverted",p4,V(t)),q(t,"_segments",d4,V(t)),q(t,"_spriteFrame",m4,V(t)),q(t,"_alphaThreshold",v4,V(t)),t._graphics=null,t._clearModelMesh=null,t._instanceMaterialType=U0.ADD_COLOR,t}F(t,e);var n=t.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),e.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){e.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._clearModel&&this._clearModelMesh&&(eN.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()},n.isHit=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,o=A4;this.node.getWorldMatrix(C4),Ni.invert(w4,C4),zi.transformMat4(o,e,w4);var a=t.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===S4.RECT||this.type===S4.GRAPHICS_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===S4.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(e){e.commitComp(this,null,this._assembler,null)},n._postRender=function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler,null)},n._nodeStateChange=function(t){e.prototype._nodeStateChange.call(this,t),this._updateGraphics()},n._canRender=function(){return!!e.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==S4.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var e=this._graphics=new b4;e._objFlags|=Qt.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=vi.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===S4.RECT||this._type===S4.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,o=e.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===S4.RECT)t.rect(a,s,i,r);else if(this._type===S4.ELLIPSE){for(var c=function(e,t,n){R4.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)R4.push(new yi(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return R4}(new yi(a+i/2,s+r/2,0),new yi(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}},n._createClearModel=function(){if(!this._clearModel){var e=Vv.get("default-clear-stencil");this._clearStencilMtl=new Qg({parent:e,owner:this,subModelIdx:0}),this._clearModel=eN.root.createModel(ag),this._clearModel.node=this._clearModel.transform=this.node;var t=Y2(V2),n=i.director.root.device,r=n.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.DEVICE,4*t,t)),o=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);r.update(o);var a=n.createBuffer(new wo(Rr.INDEX|Rr.TRANSFER_DST,Or.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),s=new Uint16Array([0,1,2,2,1,3]);a.update(s),this._clearModelMesh=new QA([r],V2,Qr.TRIANGLE_LIST,a),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=Q$.DISABLED,this._type===S4.IMAGE_STENCIL?(e=Vv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=Vv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==S4.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},L(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==S4.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=Q$.DISABLED,this._graphics&&(this._graphics.stencilStage=Q$.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=Jn(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===S4.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===S4.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),t}(n2),g4.Type=S4,X((f4=y4).prototype,"type",[$2,e4,t4],Object.getOwnPropertyDescriptor(f4.prototype,"type"),f4.prototype),X(f4.prototype,"inverted",[n4,i4],Object.getOwnPropertyDescriptor(f4.prototype,"inverted"),f4.prototype),X(f4.prototype,"segments",[r4],Object.getOwnPropertyDescriptor(f4.prototype,"segments"),f4.prototype),X(f4.prototype,"spriteFrame",[o4,a4],Object.getOwnPropertyDescriptor(f4.prototype,"spriteFrame"),f4.prototype),X(f4.prototype,"alphaThreshold",[s4,c4,Ml],Object.getOwnPropertyDescriptor(f4.prototype,"alphaThreshold"),f4.prototype),X(f4.prototype,"color",[Jl,l4],Object.getOwnPropertyDescriptor(f4.prototype,"color"),f4.prototype),X(f4.prototype,"customMaterial",[Jl,u4],Object.getOwnPropertyDescriptor(f4.prototype,"customMaterial"),f4.prototype),_4=X(f4.prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return S4.RECT}}),p4=X(f4.prototype,"_inverted",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),d4=X(f4.prototype,"_segments",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),m4=X(f4.prototype,"_spriteFrame",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v4=X(f4.prototype,"_alphaThreshold",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),h4=f4))||h4)||h4)||h4)||h4));FP._maskComp=I4,i.Mask=I4;var P4,O4,D4,M4,N4,L4,B4,F4,z4,U4,k4,G4,H4,V4,j4,W4,q4,X4,Y4,K4,Q4,Z4,J4,$4,e3,t3,n3,i3,r3,o3,a3,s3,c3,l3,u3,h3,f3,_3,p3,d3,m3,v3,g3,y3,S3,x3,T3,E3,b3,C3,A3,w3,R3,I3,P3,O3,D3,M3,N3,L3,B3=/^(click)(\s)*=|(param)(\s)*=/,F3=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,z3=e("HtmlTextParser",function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var o=e.substring(t,r),a=e.substring(r+1,i);""===a&&(o=e.substring(t,i+1)),this._processResult(o),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(a),t=i+1}}return this._resultObjectArray},t._attributeToObject=function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,o="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(o=e.substring(r+1).trim(),t.event=this._processEventHandler(o)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var a="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=F3.exec(e);for(var c=!1;n;){if(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),s=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}t.isImage=!0,t.src=s}else if("height"===i)t.imageHeight=parseInt(s);else if("width"===i)t.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}t.imageAlign=s.toLowerCase()}else"offset"===i?t.imageOffset=s:"click"===i&&(t.event=this._processEventHandler(i+"="+s));t.event&&"param"===i&&(t.event[i]=s.replace(/^"|"$/g,"")),n=F3.exec(e)}return c&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var l={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),u=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),"click"===i?t.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),t.event&&"param"===i&&(t.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(e)}t.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t._processEventHandler=function(e){for(var t={},n=0,i=!1,r=B3.exec(e);r;){var o=r[0],a="";if(i=!1,'"'===(e=e.substring(o.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(a=s?s[0]:"").length}i&&(t[o=o.substring(0,o.length-1).trim()]=a),e=e.substring(n).trim(),r=B3.exec(e)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,n=W(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],o=i[1];e=e.replace(r,o)}return e},e}()),U3=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}((P4=sl("cc.LabelOutline"),O4=El(),D4=ll(110),M4=yl(),N4=cl(a2),L4=Rl(),B4=Rl(),P4(F4=O4(F4=D4(F4=M4(F4=N4(F4=gl((G4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_color",U4,V(t)),q(t,"_width",k4,V(t)),t}F(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(a2);e&&e.updateRenderData(!0)},L(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(oh),U4=X((z4=G4).prototype,"_color",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(0,0,0,255)}}),k4=X(z4.prototype,"_width",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),X(z4.prototype,"color",[L4],Object.getOwnPropertyDescriptor(z4.prototype,"color"),z4.prototype),X(z4.prototype,"width",[B4],Object.getOwnPropertyDescriptor(z4.prototype,"width"),z4.prototype),F4=z4))||F4)||F4)||F4)||F4)||F4)||F4));!function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(D3||(D3={})),$e(D3),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(M3||(M3={})),$e(M3),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(N3||(N3={})),$e(N3),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(L3||(L3={}));var k3,G3,H3,V3,j3,W3,q3,X3,Y3,K3,Q3,Z3,J3,$3,e5=function(t){return e({Sprite:t,SpriteComponent:t}),t}((H4=sl("cc.Sprite"),V4=El(),j4=ll(110),W4=yl(),q4=Hl(Ng),X4=Nl(),Y4=wl(),K4=Hl(e$),Q4=Nl(),Z4=Rl(),J4=Hl(JJ),$4=Nl(),e3=Rl(),t3=Hl(D3),n3=Nl(),i3=Rl(),r3=Hl(M3),o3=Rl(),a3=Rl(),s3=Il(),c3=Rl(),l3=Il(),u3=Rl(),h3=Cl(),f3=Nl(),_3=Rl(),p3=Rl(),d3=Hl(N3),m3=Nl(),v3=Rl(),H4(g3=V4(g3=j4(g3=W4((O3=P3=function(e){function t(){var t;return q(t=e.call(this)||this,"_spriteFrame",S3,V(t)),q(t,"_type",x3,V(t)),q(t,"_fillType",T3,V(t)),q(t,"_sizeMode",E3,V(t)),q(t,"_fillCenter",b3,V(t)),q(t,"_fillStart",C3,V(t)),q(t,"_fillRange",A3,V(t)),q(t,"_isTrimmedMode",w3,V(t)),q(t,"_useGrayscale",R3,V(t)),q(t,"_atlas",I3,V(t)),t}F(t,e);var n=t.prototype;return n.__preload=function(){this.changeMaterialForDefine(),e.prototype.__preload.call(this)},n.onEnable=function(){e.prototype.onEnable.call(this),this._activateMaterial(),this._markForUpdateUvDirty()},n.onDestroy=function(){this.destroyRenderData(),e.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof Gm){var i=e.getPixelFormat();n=i===lm.RGBA_ETC1||i===lm.RGB_A_PVRTC_4BPPV1||i===lm.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=U0.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=U0.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=U0.GRAYSCALE:this._instanceMaterialType=U0.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var t=e.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof CT){var n=B({SAMPLE_FROM_RT:!0},t.passes[0].defines),i=new Ng;i.initialize({effectAsset:t.effectAsset,defines:n}),t=i}return t},n._render=function(e){e.commitComp(this,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!e.prototype._canRender.call(this))return!1;var t=this._spriteFrame;return!(!t||!t.texture)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this._colorDirty=!0,this._updateColor())},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(N3.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(N3.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},n._applySpriteFrame=function(e){var t=this._spriteFrame;this._renderData&&(this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty);var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize())},n._markForUpdateUvDirty=function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)},n._calculateSlicedData=function(e){var t=this.node._uiProps.uiTransformComp.contentSize,n=t.width,i=t.height,r=this.spriteFrame.insetLeft,o=n-r-this.spriteFrame.insetRight,a=this.spriteFrame.insetTop,s=i-a-this.spriteFrame.insetBottom;return e.length=0,e[0]=r/n,e[1]=a/i,e[2]=(r+o)/n,e[3]=(a+s)/i,e},n.calculateTiledData=function(e){var t=this.node._uiProps.uiTransformComp.contentSize,n=this.spriteFrame.rect;e.x=t.width/n.width,e.y=t.height/n.height},n._updateUVWithTrim=function(){this.tillingOffsetWithTrim.length=0;var e=this.spriteFrame,t=e.originalSize,n=e.rect,i=e.texture,r=i.width,o=i.height,a=0,s=0;e.original&&(a=n.x-e.original._x,s=n.y-e.original._y);var c=0===r?0:a/r,l=0===r?1:(a+t.width)/r,u=0===o?1:(s+t.height)/o,h=0===o?0:s/o;e.rotated&&(c=0===r?0:a/r,l=0===r?1:(a+t.height)/r,h=0===o?0:s/o,u=0===o?1:(s+t.width)/o),this.tillingOffsetWithTrim[0]=l-c,this.tillingOffsetWithTrim[1]=u-h,this.tillingOffsetWithTrim[2]=c,this.tillingOffsetWithTrim[3]=h,e.rotated&&(this.tillingOffsetWithTrim[0]=-this.tillingOffsetWithTrim[0])},L(t,[{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===M3.RADIAL||this._fillType===M3.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===D3.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=Jn(e,0,1),this._type===D3.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=Jn(e,-1,1),this._type===D3.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===D3.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?U0.GRAYSCALE:U0.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==N3.CUSTOM&&this._applySpriteSize())}}]),t}(n2),P3.FillType=M3,P3.Type=D3,P3.SizeMode=N3,P3.EventType=L3,X((y3=O3).prototype,"customMaterial",[q4,X4,Y4,Jl],Object.getOwnPropertyDescriptor(y3.prototype,"customMaterial"),y3.prototype),X(y3.prototype,"spriteAtlas",[K4,Q4,Z4],Object.getOwnPropertyDescriptor(y3.prototype,"spriteAtlas"),y3.prototype),X(y3.prototype,"spriteFrame",[J4,$4,e3],Object.getOwnPropertyDescriptor(y3.prototype,"spriteFrame"),y3.prototype),X(y3.prototype,"type",[t3,n3,i3],Object.getOwnPropertyDescriptor(y3.prototype,"type"),y3.prototype),X(y3.prototype,"fillType",[r3,o3],Object.getOwnPropertyDescriptor(y3.prototype,"fillType"),y3.prototype),X(y3.prototype,"fillCenter",[a3],Object.getOwnPropertyDescriptor(y3.prototype,"fillCenter"),y3.prototype),X(y3.prototype,"fillStart",[s3,c3],Object.getOwnPropertyDescriptor(y3.prototype,"fillStart"),y3.prototype),X(y3.prototype,"fillRange",[l3,u3],Object.getOwnPropertyDescriptor(y3.prototype,"fillRange"),y3.prototype),X(y3.prototype,"trim",[h3,f3,_3],Object.getOwnPropertyDescriptor(y3.prototype,"trim"),y3.prototype),X(y3.prototype,"grayscale",[bl,p3],Object.getOwnPropertyDescriptor(y3.prototype,"grayscale"),y3.prototype),X(y3.prototype,"sizeMode",[d3,m3,v3],Object.getOwnPropertyDescriptor(y3.prototype,"sizeMode"),y3.prototype),S3=X(y3.prototype,"_spriteFrame",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x3=X(y3.prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return D3.SIMPLE}}),T3=X(y3.prototype,"_fillType",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return M3.HORIZONTAL}}),E3=X(y3.prototype,"_sizeMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return N3.TRIMMED}}),b3=X(y3.prototype,"_fillCenter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,0)}}),C3=X(y3.prototype,"_fillStart",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A3=X(y3.prototype,"_fillRange",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),w3=X(y3.prototype,"_isTrimmedMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),R3=X(y3.prototype,"_useGrayscale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),I3=X(y3.prototype,"_atlas",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),g3=y3))||g3)||g3)||g3)||g3)),t5=e("RenderRoot2D",sl("cc.RenderRoot2D")(k3=ll(100)(k3=yl()(k3=cl(y0)(k3=ul(k3=gl(k3=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.onEnable=function(){i.director.root.batcher2D.addScreen(this)},n.onDisable=function(){i.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){i.director.root.batcher2D.removeScreen(this)},t}(oh))||k3)||k3)||k3)||k3)||k3)||k3),n5=new yi,i5=Qe({OVERLAY:0,INTERSPERSE:1}),r5=function(t){return e({Canvas:t,CanvasComponent:t}),t}((G3=sl("cc.Canvas"),H3=El(),V3=ll(100),j3=yl(),W3=Hl(pF),q3=Rl(),X3=Rl(),Y3=Hl(pF),G3(K3=H3(K3=V3(K3=j3(K3=gl(K3=ul((X((Q3=function(e){function t(){var t;return q(t=e.call(this)||this,"_cameraComponent",Z3,V(t)),q(t,"_alignCanvasWithScreen",J3,V(t)),t._thisOnCameraResized=void 0,t._fitDesignResolution=void 0,t._pos=new yi,t._renderMode=i5.OVERLAY,t._thisOnCameraResized=t._onResizeCamera.bind(V(t)),t}F(t,e);var n=t.prototype;return n.__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(pF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(JE.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){e.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(pF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){e.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(pF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.node.off(JE.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=iN.height/2;else{var e=ph.windowSize;this._cameraComponent.orthoHeight=e.height/uN.getScaleY()/2}this.node.getWorldPosition(n5),this._cameraComponent.node.setWorldPosition(n5.x,n5.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===i5.OVERLAY?t|1<<30:t&~(1<<30)}return 0},L(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),t}(t5)).prototype,"cameraComponent",[W3,q3],Object.getOwnPropertyDescriptor(Q3.prototype,"cameraComponent"),Q3.prototype),X(Q3.prototype,"alignCanvasWithScreen",[X3],Object.getOwnPropertyDescriptor(Q3.prototype,"alignCanvasWithScreen"),Q3.prototype),Z3=X(Q3.prototype,"_cameraComponent",[Y3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J3=X(Q3.prototype,"_alignCanvasWithScreen",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),K3=Q3))||K3)||K3)||K3)||K3)||K3)||K3));i.Canvas=r5;var o5,a5,s5,c5,l5,u5,h5,f5,_5,p5,d5,m5,v5,g5,y5,S5,x5,T5,E5,b5,C5,A5,w5,R5,I5,P5,O5,D5,M5,N5,L5,B5,F5,z5,U5,k5=e("UIComponent",sl("cc.UIComponent")($3=cl(y0)($3=ll(110)($3=ul($3=gl($3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastParent=null,t.stencilStage=Q$.DISABLED,t}F(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},t}(oh))||$3)||$3)||$3)||$3)||$3);Un(k5.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),zn(r5.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:vi.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),kn(n2.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),kn(y0.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),i.UITransformComponent=y0,He.setClassAlias(y0,"cc.UITransformComponent"),He.setClassAlias(n2,"cc.RenderComponent"),i.CanvasComponent=r5,He.setClassAlias(r5,"cc.CanvasComponent");var G5=new z3,H5="RICHTEXT_CHILD",V5="RICHTEXT_Image_CHILD",j5=new ke((function(e){if(!i.isValid(e.node))return!1;var t=e.node.getComponent(U3);return t&&(t.width=0),!0}),20),W5=new ke((function(e){return i.isValid(e.node)}),10);function q5(e){return{node:new eA(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function X5(e,t){var n;e===H5?n=j5._get():e===V5&&(n=W5._get());var i=(n=n||q5(e)).node;return i||(i=new eA(e)),i.hideFlags|=Qt.Flags.DontSave|Qt.Flags.HideInHierarchy,e===V5?(n.comp=i.getComponent(e5)||i.addComponent(e5),n.comp.spriteFrame=t,n.comp.type=e5.Type.SLICED,n.comp.sizeMode=e5.SizeMode.CUSTOM):(n.comp=i.getComponent(a2)||i.addComponent(a2),n.comp.string=t,n.comp.horizontalAlign=J1.LEFT,n.comp.verticalAlign=$1.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var Y5,K5=function(t){return e({RichText:t,RichTextComponent:t}),t}((o5=sl("cc.RichText"),a5=El(),s5=ll(110),c5=yl(),l5=Rl(),u5=Hl(J1),h5=Rl(),f5=Rl(),_5=Rl(),p5=Hl(o$),d5=Rl(),m5=Rl(),v5=Hl(t2),g5=Rl(),y5=Rl(),S5=Rl(),x5=Hl(e$),T5=Rl(),E5=Rl(),o5(b5=a5(b5=s5(b5=c5(b5=gl((U5=z5=function(e){function t(){var t;return q(t=e.call(this)||this,"_lineHeight",A5,V(t)),q(t,"_string",w5,V(t)),q(t,"_horizontalAlign",R5,V(t)),q(t,"_fontSize",I5,V(t)),q(t,"_maxWidth",P5,V(t)),q(t,"_fontFamily",O5,V(t)),q(t,"_font",D5,V(t)),q(t,"_isSystemFontUsed",M5,V(t)),q(t,"_userDefinedFont",N5,V(t)),q(t,"_cacheMode",L5,V(t)),q(t,"_imageAtlas",B5,V(t)),q(t,"_handleTouchEvent",F5,V(t)),t._textArray=[],t._segments=[],t._labelSegmentsCache=[],t._linesWidth=[],t._lineCount=1,t._labelWidth=0,t._labelHeight=0,t._layoutDirty=!0,t._lineOffsetX=0,t._updateRichTextStatus=void 0,t._updateRichTextStatus=t._updateRichText,t}F(t,e);var n=t.prototype;return n.onLoad=function(){this.node.on(JE.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(JE.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var e,t=W(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===H5?j5.put(n):n.type===V5&&W5.put(n)}this.node.off(JE.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(JE.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(JE.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(JE.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))},n._createFontLabel=function(e){return X5(H5,e)},n._createImage=function(e){return X5(V5,e)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(e,t){var n=this,i=function(t){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(t),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(a2).string=t,i.styleIndex=e,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return t?i(t):i},n._onTouchEnded=function(e){for(var t,n=this,i=this.node.getComponents(oh),r=function(){var r=t.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[o];t.enabledInHierarchy&&n&&n.call(t,e,a)})),e.propagationStopped=!0)},o=W(this._segments);!(t=o()).done;)r()},n._containsTouchLocation=function(e,t){var n=e.node.getComponent(y0);return!!n&&n.getBoundingBoxToWorld().contains(t)},n._resetState=function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===H5||n.name===V5){n.parent===this.node?n.parent=null:e.splice(t,1);var i=q5(n.name);i.node=n,n.name===H5?(i.comp=n.getComponent(a2),j5.put(i)):(i.comp=n.getComponent(e5),W5.put(i))}}e.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==H5&&n.name!==V5||(n.active=e)}},n._addLabelSegment=function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(a2);i&&(i.string=e)}return n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(e,r,e.length),a=e.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=L$(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],f=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=f.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)},n._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else b(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var e=G5.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+x$)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(e,t,n){var i=e.charAt(t);if(O$(i)||D$(i))return 1;for(var r=1,o=t+1;o<n&&!D$(i=e.charAt(o))&&!O$(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case J1.LEFT:break;case J1.CENTER:l-=this._linesWidth[c-1]/2;break;case J1.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(e5)){var h=s.node.position.clone(),f=this._lineHeight,_=this._lineHeight*(1+x$);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=f+(_-f)/2;break;case.5:h.y+=_/2;break;default:h.y+=(_-f)/2}if(s.imageOffset){var p=s.imageOffset.split(",");if(1===p.length&&p[0]){var d=parseFloat(p[0]);Number.isInteger(d)&&(h.y+=d)}else if(2===p.length){var m=parseFloat(p[0]),v=parseFloat(p[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(U3);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(e){var t=e.toUpperCase();return vi[t]?vi[t]:(new vi).fromHEX(e)},n._applyTextAttribute=function(e){var t=e.node.getComponent(a2);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(U3);r||(r=e.node.addComponent(U3)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var o=n.event;o&&(e.clickHandler=o.click||"",e.clickParam=o.param||"")}t.cacheMode=this._cacheMode,this._font instanceof o$&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var a=t._assembler;a&&a.updateRenderData(t)}},n._applyLayer=function(){for(var e,t=W(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},n._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=vi.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},L(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),t}(k5),z5.HorizontalAlign=J1,z5.VerticalAlign=$1,X((C5=U5).prototype,"string",[Bl,l5],Object.getOwnPropertyDescriptor(C5.prototype,"string"),C5.prototype),X(C5.prototype,"horizontalAlign",[u5,h5],Object.getOwnPropertyDescriptor(C5.prototype,"horizontalAlign"),C5.prototype),X(C5.prototype,"fontSize",[f5],Object.getOwnPropertyDescriptor(C5.prototype,"fontSize"),C5.prototype),X(C5.prototype,"fontFamily",[_5],Object.getOwnPropertyDescriptor(C5.prototype,"fontFamily"),C5.prototype),X(C5.prototype,"font",[p5,d5],Object.getOwnPropertyDescriptor(C5.prototype,"font"),C5.prototype),X(C5.prototype,"useSystemFont",[m5],Object.getOwnPropertyDescriptor(C5.prototype,"useSystemFont"),C5.prototype),X(C5.prototype,"cacheMode",[v5,g5],Object.getOwnPropertyDescriptor(C5.prototype,"cacheMode"),C5.prototype),X(C5.prototype,"maxWidth",[y5],Object.getOwnPropertyDescriptor(C5.prototype,"maxWidth"),C5.prototype),X(C5.prototype,"lineHeight",[S5],Object.getOwnPropertyDescriptor(C5.prototype,"lineHeight"),C5.prototype),X(C5.prototype,"imageAtlas",[x5,T5],Object.getOwnPropertyDescriptor(C5.prototype,"imageAtlas"),C5.prototype),X(C5.prototype,"handleTouchEvent",[E5],Object.getOwnPropertyDescriptor(C5.prototype,"handleTouchEvent"),C5.prototype),A5=X(C5.prototype,"_lineHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),w5=X(C5.prototype,"_string",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),R5=X(C5.prototype,"_horizontalAlign",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return J1.LEFT}}),I5=X(C5.prototype,"_fontSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),P5=X(C5.prototype,"_maxWidth",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),O5=X(C5.prototype,"_fontFamily",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),D5=X(C5.prototype,"_font",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M5=X(C5.prototype,"_isSystemFontUsed",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),N5=X(C5.prototype,"_userDefinedFont",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L5=X(C5.prototype,"_cacheMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return t2.NONE}}),B5=X(C5.prototype,"_imageAtlas",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F5=X(C5.prototype,"_handleTouchEvent",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),b5=C5))||b5)||b5)||b5)||b5)||b5)),Q5=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(sl("cc.UIMeshRenderer")(Y5=El()(Y5=ll(110)(Y5=yl()(Y5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._models=null,t._modelComponent=null,t}F(t,e);var n=t.prototype;return n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onEnable=function(){e.prototype.onEnable.call(this)},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(e){if(this._models){this._modelComponent._detachFromScene();for(var t,n=W(this._models);!(t=n()).done;){var i=t.value;e.commitModel.call(e,this,i,this._modelComponent.material)}return!0}return!1},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=Vp.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},L(t,[{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(k5))||Y5)||Y5)||Y5)||Y5),Z5=e("MeshBuffer",function(e){function t(t){var n;return(n=e.call(this)||this).vData=null,n.iData=null,n.byteStart=0,n.byteOffset=0,n.indicesStart=0,n.indicesOffset=0,n.vertexStart=0,n.vertexOffset=0,n.lastByteOffset=1,n._attributes=null,n._vertexBuffers=[],n._indexBuffer=null,n._iaInfo=null,n._batcher=void 0,n._dirty=!1,n._vertexFormatBytes=0,n._initVDataCount=0,n._initIDataCount=1536,n._outOfCallback=null,n._hInputAssemblers=[],n._nextFreeIAHandle=0,n._lastUsedVDataSize=0,n._lastUsedIDataSize=0,n._batcher=t,n}F(t,e);var n=t.prototype;return n.initialize=function(e,t){this._outOfCallback=t;var n=X2(e);this._vertexFormatBytes=n*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes;var i=Float32Array.BYTES_PER_ELEMENT*n;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,i,i)));var r=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this._indexBuffer=this._batcher.device.createBuffer(new wo(Rr.INDEX|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,r,r))),this._attributes=e,this._iaInfo=new qo(this.attributes,this.vertexBuffers,this.indexBuffer),this.vData&&this.iData||this._reallocBuffer()},n.request=function(e,t){void 0===e&&(e=4),void 0===t&&(t=6),this.lastByteOffset=this.byteOffset;var n=this.byteOffset+e*this._vertexFormatBytes,i=this.indicesOffset+t;if(e+this.vertexOffset>65535)return this._outOfCallback&&this._outOfCallback.call(this._batcher,e,t),!1;var r=this.vData.byteLength,o=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)this._initVDataCount*=2,this._initIDataCount*=2,r=4*this._initVDataCount,o=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indicesOffset+=t,this.byteOffset=n,this._dirty=!0,!0},n.reset=function(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1},n.tryShrink=function(){if(!this._dirty&&this.vData&&this.iData&&this.vData.byteLength>>2>this._lastUsedVDataSize&&this.iData.length>>2>this._lastUsedIDataSize){var e=Math.max(256*this._vertexFormatBytes,this._initVDataCount>>1),t=Math.max(1536,this._initIDataCount>>1);e===this._initVDataCount&&t===this._initIDataCount||(this._initIDataCount=t,this._initVDataCount=e,this._reallocBuffer())}},n.destroy=function(){this._attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this._indexBuffer=null;for(var t=0;t<this._hInputAssemblers.length;t++)this._hInputAssemblers[t].destroy();this._hInputAssemblers.length=0,e.prototype.destroy.call(this)},n.recordBatch=function(){var e=this.indicesOffset-this.indicesStart;if(!e)return null;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push(this._batcher.device.createInputAssembler(this._iaInfo));var t=this._hInputAssemblers[this._nextFreeIAHandle++];return t.firstIndex=this.indicesStart,t.indexCount=e,t},n.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(e),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(t),this._lastUsedVDataSize=this.byteOffset,this._lastUsedIDataSize=this.indicesOffset,this._dirty=!1}},n._reallocBuffer=function(){this._reallocVData(!0),this._reallocIData(!0)},n._reallocVData=function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var n=new Uint8Array(this.vData.buffer),i=0,r=t.length;i<r;i++)n[i]=t[i]},n._reallocIData=function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var n=this.iData,i=0,r=t.length;i<r;i++)n[i]=t[i]},L(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),t}(je));Z5.OPACITY_OFFSET=8;var J5,$5,e8,t8,n8,i8,r8,o8,a8,s8,c8,l8,u8,h8,f8,_8,p8,d8,m8,v8,g8,y8,S8,x8,T8,E8,b8,C8,A8,w8=Gp.Enum.NONE|Gp.Enum.UI_3D,R8=e("UIDrawBatch",function(){function e(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=w8,this._inputAssember=null,this._descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=w8,this.renderScene=null},t.fillPasses=function(e,t,n,r,o,a){if(e){var s=e.passes;if(!s)return;var c=0;this._shaders.length=s.length;for(var l=0;l<s.length;l++){this._passes[l]||(this._passes[l]=new Qv(i.director.root));var u=s[l],h=this._passes[l];u.update(),t||(t=u.depthStencilState,n=0),r||(r=u.blendState,o=0),-1===o&&(o=0),c=n<<16|o,h._initPassFromTarget(u,t,r,c),this._shaders[l]=h.getShaderVariant(a)}}},L(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssember},set:function(e){this._inputAssember=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}()),I8=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}((J5=sl("cc.UIStaticBatch"),$5=El(),e8=yl(),t8=ll(110),n8=Cl(),J5(i8=$5(i8=e8(i8=t8((X((r8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._init=!1,t._meshBuffer=null,t._dirty=!0,t._lastMeshBuffer=null,t._uiDrawBatchList=[],t}F(t,e);var n=t.prototype;return n.onLoad=function(){var e=this._getBatcher();if(e){var t=W2,n=new Z5(e);n.initialize(t,this._arrivalMaxBuffer.bind(this)),this._meshBuffer=n}},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)},n.updateAssembler=function(e){e.currIsStatic=!0,this._dirty&&(e.finishMergeBatches(),this._lastMeshBuffer=e.currBufferBatch,e.currBufferBatch=this._meshBuffer,e.currStaticRoot=this),this._init&&(e.finishMergeBatches(),e.commitStaticBatch(this))},n.postUpdateAssembler=function(e){this._dirty&&(e.finishMergeBatches(),e.currBufferBatch=this._lastMeshBuffer,e.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadBuffers()),e.currIsStatic=!1},n.markAsDirty=function(){this._getBatcher()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())},n._requireDrawBatch=function(){var e=new R8;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},n._clearData=function(){if(this._meshBuffer){this._meshBuffer.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return eN.root&&eN.root.batcher2D?eN.root.batcher2D:(b(9301),null)},n._arrivalMaxBuffer=function(){var e=this._getBatcher();e&&e.autoMergeBatches(),b(9300)},L(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(n2)).prototype,"color",[Jl,n8],Object.getOwnPropertyDescriptor(r8.prototype,"color"),r8.prototype),i8=r8))||i8)||i8)||i8)||i8)),P8=e("LabelShadow",(o8=sl("cc.LabelShadow"),a8=El(),s8=ll(110),c8=yl(),l8=cl(a2),u8=Rl(),h8=Rl(),f8=Rl(),o8(_8=a8(_8=s8(_8=c8(_8=l8(_8=gl((g8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_color",d8,V(t)),q(t,"_offset",m8,V(t)),q(t,"_blur",v8,V(t)),t}F(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(a2);e&&e.updateRenderData(!0)},L(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),t}(oh),d8=X((p8=g8).prototype,"_color",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(0,0,0,255)}}),m8=X(p8.prototype,"_offset",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(2,2)}}),v8=X(p8.prototype,"_blur",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),X(p8.prototype,"color",[u8],Object.getOwnPropertyDescriptor(p8.prototype,"color"),p8.prototype),X(p8.prototype,"offset",[h8],Object.getOwnPropertyDescriptor(p8.prototype,"offset"),p8.prototype),X(p8.prototype,"blur",[f8],Object.getOwnPropertyDescriptor(p8.prototype,"blur"),p8.prototype),_8=p8))||_8)||_8)||_8)||_8)||_8)||_8)),O8=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}((y8=sl("cc.UIOpacity"),S8=El(),x8=ll(110),T8=yl(),E8=Rl(),y8(b8=S8(b8=x8(b8=T8(b8=gl((X((C8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_opacity",A8,V(t)),t}F(t,e);var n=t.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},L(t,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=_t(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),t}(oh)).prototype,"opacity",[bl,E8],Object.getOwnPropertyDescriptor(C8.prototype,"opacity"),C8.prototype),A8=X(C8.prototype,"_opacity",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),b8=C8))||b8)||b8)||b8)||b8)||b8));i.MaskComponent=I4,He.setClassAlias(I4,"cc.MaskComponent"),i.LabelComponent=a2,He.setClassAlias(a2,"cc.LabelComponent"),i.LabelOutlineComponent=U3,He.setClassAlias(U3,"cc.LabelOutlineComponent"),i.RichTextComponent=K5,He.setClassAlias(K5,"cc.RichTextComponent"),i.SpriteComponent=e5,He.setClassAlias(e5,"cc.SpriteComponent"),i.UIModelComponent=Q5,He.setClassAlias(Q5,"cc.UIModelComponent"),i.GraphicsComponent=b4,He.setClassAlias(b4,"cc.GraphicsComponent"),He.setClassAlias(I8,"cc.UIStaticBatchComponent"),He.setClassAlias(O8,"cc.UIOpacityComponent");var D8=function(e,t,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=n};function M8(e,t,n,i,r){var o=0,a=null;if(r===function(e,t,n,i){for(var r=0,o=t,a=n-i;o<n;o+=i)r+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return r}(e,t,n,i)>0)for(o=t;o<n;o+=i)a=Z8(o,e[o],e[o+1],a);else for(o=n-i;o>=t;o-=i)a=Z8(o,e[o],e[o+1],a);return a&&X8(a,a.next)&&(J8(a),a=a.next),a}function N8(e,t){if(void 0===t&&(t=null),!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!X8(n,n.next)&&0!==q8(n.prev,n,n.next))n=n.next;else{if(J8(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function L8(e,t,n,i,r,o,a){if(void 0===a&&(a=0),e){!a&&o&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=H8(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:e=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(e,i,r,o);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,o?F8(e,i,r,o):B8(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),J8(e),e=l.next,s=l.next;else if((e=l)===s){a?1===a?L8(e=z8(e,t,n),t,n,i,r,o,2):2===a&&U8(e,t,n,i,r,o):L8(N8(e),t,n,i,r,o,1);break}}}function B8(e){var t=e.prev,n=e,i=e.next;if(q8(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(j8(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&q8(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function F8(e,t,n,i){var r=e.prev,o=e,a=e.next;if(q8(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=H8(s,c,t,n,i),f=H8(l,u,t,n,i),_=e.nextZ;_&&_.z<=f;){if(_!==e.prev&&_!==e.next&&j8(r.x,r.y,o.x,o.y,a.x,a.y,_.x,_.y)&&q8(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=e.prevZ;_&&_.z>=h;){if(_!==e.prev&&_!==e.next&&j8(r.x,r.y,o.x,o.y,a.x,a.y,_.x,_.y)&&q8(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}function z8(e,t,n){var i=e;do{var r=i.prev,o=i.next.next;!X8(r,o)&&Y8(r,i,i.next,o)&&K8(r,o)&&K8(o,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(o.i/n),J8(i),J8(i.next),i=e=o),i=i.next}while(i!==e);return i}function U8(e,t,n,i,r,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&W8(a,s)){var c=Q8(a,s);return a=N8(a,a.next),c=N8(c,c.next),L8(a,t,n,i,r,o),void L8(c,t,n,i,r,o)}s=s.next}a=a.next}while(a!==e)}function k8(e,t){return e.x-t.x}function G8(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,f=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&j8(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<f||c===f&&n.x>a.x)&&K8(n,e)&&(a=n,f=c),n=n.next;return a}(e,t)){var n=Q8(t,e);N8(n,n.next)}}function H8(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function V8(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function j8(e,t,n,i,r,o,a,s){return(r-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(i-s)-(n-a)*(t-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function W8(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&Y8(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&K8(e,t)&&K8(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function q8(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function X8(e,t){return e.x===t.x&&e.y===t.y}function Y8(e,t,n,i){return!!(X8(e,t)&&X8(n,i)||X8(e,i)&&X8(n,t))||q8(e,t,n)>0!=q8(e,t,i)>0&&q8(n,i,e)>0!=q8(n,i,t)>0}function K8(e,t){return q8(e.prev,e,e.next)<0?q8(e,t,e.next)>=0&&q8(e,e.prev,t)>=0:q8(e,t,e.prev)<0||q8(e,e.next,t)<0}function Q8(e,t){var n=new D8(e.i,e.x,e.y),i=new D8(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function Z8(e,t,n,i){var r=new D8(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function J8(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function $8(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,o=M8(e,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,f=0,_=0;if(i&&(o=function(e,t,n,i){var r,o=[],a=0,s=null;for(a=0,r=t.length;a<r;a++)(s=M8(e,t[a]*i,a<r-1?t[a+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(V8(s)));if(o.sort(k8),!n)return n;for(a=0;a<o.length;a++)G8(o[a],n),n=N8(n,n.next);return n}(e,t,o,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var p=n;p<r;p+=n)(h=e[p])<s&&(s=h),(f=e[p+1])<c&&(c=f),h>l&&(l=h),f>u&&(u=f);_=Math.max(l-s,u-c)}return L8(o,a,n,s,c,_),a}for(var e6=Math.PI,t6=Math.min,n6=Math.max,i6=Math.ceil,r6=Math.acos,o6=Math.cos,a6=Math.sin,s6=Math.atan2,c6=null,l6=null,u6=new vi,h6=[],f6=0;f6<4;f6++)h6.push(new yi);function _6(e,t,n){return e<t?t:e>n?n:e}var p6={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!l6)return null;var n=l6.getRenderDataList(),i=n[l6.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+t:0;return(o>65535||3*o>131070)&&(++l6.dataOffset,l6.dataOffset<n.length?i=n[l6.dataOffset]:(i=l6.requestRenderData(),n[l6.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(t,3*t),i},stroke:function(e){vi.copy(u6,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){vi.copy(u6,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t=.5*e.lineWidth,n=e.lineCap,i=e.lineJoin,r=e.miterLimit;if(l6=e.impl){var o=function(e,t,n){var i=2*r6(e/(e+n));return n6(2,i6(t/i))}(t,e6,l6.tessTol);this._calculateJoins(l6,t,i,r);for(var a=l6.paths,s=0,c=l6.pathOffset,l=l6.pathLength;c<l;c++){var u=a[c],h=u.points.length;i===r2.ROUND?s+=2*(h+u.bevel*(o+2)+1):s+=2*(h+5*u.bevel+1),u.closed||(n===i2.ROUND?s+=2*(2*o+2):s+=12)}var f=c6=this.getRenderData(e,s);if(f){for(var _=f.vData,p=f.iData,d=l6.pathOffset,m=l6.pathLength;d<m;d++){var v=a[d],g=v.points,y=g.length,S=f.vertexStart,x=void 0,T=void 0,E=0,b=0,C=v.closed;if(C?(x=g[y-1],T=g[0],E=0,b=y):(x=g[0],T=g[1],E=1,b=y-1),T=T||x,!C){var A=new k2(T.x,T.y);A.subtract(x),A.normalize();var w=A.x,R=A.y;n===i2.BUTT?this._buttCapStart(x,w,R,t,0):n===i2.SQUARE?this._buttCapStart(x,w,R,t,t):n===i2.ROUND&&this._roundCapStart(x,w,R,t,o)}for(var I=E;I<b;++I)i===r2.ROUND?this._roundJoin(x,T,t,t,o):0!=(T.flags&(o2.PT_BEVEL|o2.PT_INNERBEVEL))?this._bevelJoin(x,T,t,t):(this._vSet(T.x+T.dmx*t,T.y+T.dmy*t,1),this._vSet(T.x-T.dmx*t,T.y-T.dmy*t,-1)),x=T,T=g[I+1];if(C){var P=8*S;this._vSet(_[P],_[P+1],1),this._vSet(_[P+8],_[P+8+1],-1)}else{var O=new k2(T.x,T.y);O.subtract(x),O.normalize();var D=O.x,M=O.y;n===i2.BUTT?this._buttCapEnd(T,D,M,t,0):n===i2.SQUARE?this._buttCapEnd(T,D,M,t,t):n===i2.ROUND&&this._roundCapEnd(T,D,M,t,o)}for(var N=f.indicesStart,L=S+2,B=f.vertexStart;L<B;L++)p[N++]=L-2,p[N++]=L-1,p[N++]=L;f.indicesStart=N}c6=null,l6=null}}},_expandFill:function(e){if(l6=e.impl){for(var t=l6.paths,n=0,i=l6.pathOffset,r=l6.pathLength;i<r;i++)n+=t[i].points.length;var o=c6=this.getRenderData(e,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=l6.pathOffset,u=l6.pathLength;l<u;l++){var h=t[l],f=h.points,_=f.length;if(0!==_){for(var p=o.vertexStart,d=0;d<_;++d)this._vSet(f[d].x,f[d].y);var m=o.indicesStart;if(h.complex){for(var v=[],g=p,y=o.vertexStart;g<y;g++){var S=8*g;v.push(s[S++]),v.push(s[S++]),v.push(s[S++])}var x=$8(v,null,3);if(!x||0===x.length)continue;for(var T=0,E=x.length;T<E;T++)c[m++]=x[T]+p}else for(var b=p,C=p+2,A=a.vertexStart;C<A;C++)c[m++]=b,c[m++]=C-1,c[m++]=C;a.indicesStart=m}}c6=null,l6=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var o=e.paths,a=e.pathOffset,s=e.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],f=l[0];c.bevel=0;for(var _=0;_<u;_++){var p,d,m=h.dy,v=-h.dx,g=f.dy,y=-f.dx;if(f.dmx=.5*(m+g),f.dmy=.5*(v+y),(p=f.dmx*f.dmx+f.dmy*f.dmy)>1e-6){var S=1/p;S>600&&(S=600),f.dmx*=S,f.dmy*=S}f.dx*h.dy-h.dx*f.dy>0&&(f.flags|=o2.PT_LEFT),p*(d=n6(11,t6(h.len,f.len)*r))*d<1&&(f.flags|=o2.PT_INNERBEVEL),f.flags&o2.PT_CORNER&&(p*i*i<1||n===r2.BEVEL||n===r2.ROUND)&&(f.flags|=o2.PT_BEVEL),0!=(f.flags&(o2.PT_BEVEL|o2.PT_INNERBEVEL))&&c.bevel++,h=f,f=l[_+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new k2(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==e?(a=r+t.dy*i,s=o-t.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(e,t,n,i,r){var o=e.x-t*r,a=e.y-n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var o=e.x+t*r,a=e.y+n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var o=e.x,a=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*e6,h=o6(u)*i,f=a6(u)*i;this._vSet(o-s*h-t*f,a-c*h-n*f,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var o=e.x,a=e.y,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*e6,h=o6(u)*i,f=a6(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+t*f,a-c*h+n*f,1)}},_roundJoin:function(e,t,n,i,r){var o=e.dy,a=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&o2.PT_LEFT)){var h=this._chooseBevel(t.flags&o2.PT_INNERBEVEL,e,t,n),f=h[0],_=h[1],p=h[2],d=h[3],m=s6(-a,-o),v=s6(-c,-s);v>m&&(v-=2*e6),this._vSet(f,_,1),this._vSet(l-o*i,t.y-a*i,-1);for(var g=_6(i6((m-v)/e6)*r,2,r),y=0;y<g;y++){var S=m+y/(g-1)*(v-m),x=l+o6(S)*i,T=u+a6(S)*i;this._vSet(l,u,0),this._vSet(x,T,-1)}this._vSet(p,d,1),this._vSet(l-s*i,u-c*i,-1)}else{var E=this._chooseBevel(t.flags&o2.PT_INNERBEVEL,e,t,-i),b=E[0],C=E[1],A=E[2],w=E[3],R=s6(a,o),I=s6(c,s);I<R&&(I+=2*e6),this._vSet(l+o*i,u+a*i,1),this._vSet(b,C,-1);for(var P=_6(i6((I-R)/e6)*r,2,r),O=0;O<P;O++){var D=R+O/(P-1)*(I-R),M=l+o6(D)*n,N=u+a6(D)*n;this._vSet(M,N,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(A,w,-1)}},_bevelJoin:function(e,t,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,f=e.dy,_=-e.dx,p=t.dy,d=-t.dx;if(t.flags&o2.PT_LEFT){var m=this._chooseBevel(t.flags&o2.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-f*i,t.y-_*i,-1),this._vSet(u,h,1),this._vSet(t.x-p*i,t.y-d*i,-1)}else{var v=this._chooseBevel(t.flags&o2.PT_INNERBEVEL,e,t,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(t.x+f*n,t.y+_*n,1),this._vSet(r,o,-1),this._vSet(t.x+p*n,t.y+d*n,1),this._vSet(a,s,-1)}},_vSet:function(e,t,n){if(void 0===n&&(n=0),c6){var i=c6,r=8*i.vertexStart,o=i.vData;o[r++]=e,o[r++]=t,o[r++]=0,vi.toArray(o,u6,r),r+=4,o[r++]=n,i.vertexStart++}}},d6=e("graphicsAssembler",{getAssembler:function(){return p6}});b4.Assembler=d6;var m6=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},v6=new Xi,g6=null,y6=null,S6=[],x6=[],T6=[],E6=[],b6=new Wi,C6=new Wi,A6=new zi,w6=null,R6=0,I6=0,P6=0,O6=0,D6=0,M6=1,N6=null,L6="",B6=0,F6=0,z6=0,U6=0,k6=0,G6=0,H6=0,V6=!1,j6=0,W6=0,q6=0,X6={updateRenderData:function(e){e.renderData&&g6!==e&&(e.renderData.vertDirty&&(y6=(g6=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),g6.actualFontSize=B6,y6.setContentSize(C6),g6.renderData.vertDirty=g6.renderData.uvDirty=!1,g6.markForUpdateRenderData(!1),g6=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},_updateFontScale:function(){M6=B6/F6},_updateFontFamily:function(e){var t=e.font;N6=t.spriteFrame,w6=t.fntConfig,r0.fontAtlas=t.fontDefDictionary,qJ.packToDynamicAtlas(e,N6)},_updateLabelInfo:function(){r0.hash="",r0.margin=0},_updateProperties:function(e){L6=e.string.toString(),B6=e.fontSize,F6=w6?w6.fontSize:e.fontSize,z6=e.horizontalAlign,U6=e.verticalAlign,k6=e.spacingX,H6=e.overflow,G6=e._lineHeight;var t=y6.contentSize;C6.width=t.width,C6.height=t.height,H6===e2.NONE?(V6=!1,C6.width+=2*r0.margin,C6.height+=2*r0.margin):H6===e2.RESIZE_HEIGHT?(V6=!0,C6.height+=2*r0.margin):V6=e.enableWrapText,r0.lineHeight=G6,r0.fontSize=B6,this._setupBMFontOverflowMetrics()},_resetProperties:function(){w6=null,N6=null,r0.hash="",r0.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=L6,t=e.length,n=w6.kerningDict,i=S6,r=-1,o=0;o<t;++o){var a=e.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<t-1?s:0,r=a}},_multilineTextWrap:function(e){for(var t=L6.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<t;){var h=L6.charAt(u);if("\n"!==h){for(var f=e(L6,u,t),_=s,p=c,d=a,m=i,v=!1,g=0;g<f;++g){var y=u+g;if("\r"!==(h=L6.charAt(y)))if(l=r0.fontAtlas.getLetterDefinitionForChar(h,r0)){var S=m+l.offsetX*M6-r0.margin;if(V6&&q6>0&&i>0&&S+l.w*M6>q6&&!D$(h)){T6.push(a),a=0,n++,i=0,r-=G6*this._getFontScale()+0,v=!0;break}A6.x=S,A6.y=r-l.offsetY*M6,this._recordLetterInfo(A6,h,y,n),y+1<S6.length&&y<t-1&&(m+=S6[y+1]),m+=l.xAdvance*M6+k6,d=A6.x+l.w*M6,_<A6.y&&(_=A6.y),p>A6.y-l.h*M6&&(p=A6.y-l.h*M6)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+w6.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<_&&(s=_),c>p&&(c=p),o<(a=d)&&(o=a),u+=f)}else T6.push(a),a=0,n++,i=0,r-=G6*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return T6.push(a),I6=(R6=n+1)*G6*this._getFontScale(),R6>1&&(I6+=0*(R6-1)),C6.width=j6,C6.height=W6,j6<=0&&(C6.width=parseFloat(o.toFixed(2))+2*r0.margin),W6<=0&&(C6.height=parseFloat(I6.toFixed(2))+2*r0.margin),O6=C6.height,D6=0,s>0&&(O6=C6.height+s),c<-I6&&(D6=I6+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return H6===e2.SHRINK?M6:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(O$(i)||"\n"===i||D$(i))return 1;var r=1,o=r0.fontAtlas.getLetterDefinitionForChar(i,r0);if(!o)return r;for(var a=o.xAdvance*M6+k6,s=t+1;s<n&&(i=e.charAt(s),o=r0.fontAtlas.getLetterDefinitionForChar(i,r0));++s){if(a+o.offsetX*M6+o.w*M6>q6&&!D$(i)&&q6>0)return r;if(a+=o.xAdvance*M6+k6,"\n"===i||D$(i)||O$(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=x6.length){var n=new m6;x6.push(n)}x6[e].char=t,x6[e].hash=""+t.charCodeAt(0)+r0.hash,x6[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=x6.length){var r=new m6;x6.push(r)}var o=""+t.charCodeAt(0)+r0.hash;x6[n].line=i,x6[n].char=t,x6[n].hash=o,x6[n].valid=r0.fontAtlas.getLetter(o).valid,x6[n].x=e.x,x6[n].y=e.y},_alignText:function(){I6=0,T6.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),H6===e2.SHRINK&&B6>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||H6===e2.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),B6=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|B6,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;M6=r/F6,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return I6>C6.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=L6.length;t<n;++t){var i=x6[t];if(i.valid){var r=r0.fontAtlas.getLetterDefinitionForChar(i.char,r0);if(!r)continue;var o=i.x+r.w*M6,a=i.line;if(j6>0)if(V6){if(T6[a]>C6.width&&(o>C6.width||o<0)){e=!0;break}}else if(o>C6.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=T6[t],i=e>C6.width||e<0;return V6?n>C6.width&&i:i},_updateQuads:function(){if(!g6)return!1;var e=N6?N6.texture:r0.fontAtlas.getTexture(),t=g6.renderData;t.dataLength=t.vertexCount=t.indicesCount=0;for(var n=y6.anchorPoint,i=C6,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=L6.length;s<c;++s){var l=x6[s];if(l.valid){var u=r0.fontAtlas.getLetter(l.hash);if(u){v6.height=u.h,v6.width=u.w,v6.x=u.u,v6.y=u.v;var h=l.y+P6;if(W6>0){if(h>O6){var f=h-O6;v6.y+=f,v6.height-=f,h-=f}h-u.h*M6<D6&&H6===e2.CLAMP&&(v6.height=h<D6?0:(h-D6)/M6)}var _=l.line,p=l.x+u.w/2*M6+E6[_];if(j6>0&&this._isHorizontalClamped(p,_))if(H6===e2.CLAMP)v6.width=0;else if(H6===e2.SHRINK){if(C6.width>u.w){a=!1;break}v6.width=0}if(v6.height>0&&v6.width>0){var d=this._determineRect(),m=l.x+E6[l.line];this.appendQuad(g6,e,v6,d,m-r,h-o,M6)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var e=N6.isRotated(),t=N6.getOriginalSize(),n=N6.getRect(),i=N6.getOffset(),r=i.x+(t.width-n.width)/2,o=i.y-(t.height-n.height)/2;if(e){var a=v6.x;v6.x=n.x+n.height-v6.y-v6.height-o,v6.y=a+n.y-r,v6.y<0&&(v6.height+=o)}else v6.x+=n.x-r,v6.y+=n.y+o;return e},_computeAlignmentOffset:function(){switch(E6.length=0,z6){case J1.LEFT:for(var e=0;e<R6;++e)E6.push(0);break;case J1.CENTER:for(var t=0,n=T6.length;t<n;t++)E6.push((C6.width-T6[t])/2);break;case J1.RIGHT:for(var i=0,r=T6.length;i<r;i++)E6.push(C6.width-T6[i])}if(P6=C6.height,U6!==$1.TOP){var o=C6.height-I6+G6*this._getFontScale()-F6*M6;U6===$1.BOTTOM?P6-=o:P6-=o/2}},_setupBMFontOverflowMetrics:function(){var e=C6.width,t=C6.height;H6===e2.RESIZE_HEIGHT&&(t=0),H6===e2.NONE&&(e=0,t=0),j6=e,W6=t,b6.width=e,b6.height=t,q6=e}},Y6=new vi(255,255,255,255),K6={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){var n=e.node;Y6.set(e.color),Y6.a=255*n._uiProps.opacity,GJ(n,t,e.renderData,Y6)},appendQuad:function(e,t,n,i,r,o,a){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.vertexCount=s.dataLength,s.indicesCount=s.dataLength/2*3;var l=s.data,u=t.width,h=t.height,f=n.width,_=n.height,p=0,d=0,m=0,v=0;i?(p=n.x/u,v=(n.x+_)/u,d=(n.y+f)/h,m=n.y/h,l[c].u=p,l[c].v=m,l[c+1].u=p,l[c+1].v=d,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=d):(p=n.x/u,v=(n.x+f)/u,d=(n.y+_)/h,m=n.y/h,l[c].u=p,l[c].v=d,l[c+1].u=v,l[c+1].v=d,l[c+2].u=p,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-_*a,l[c+1].x=r+f*a,l[c+1].y=o-_*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+f*a,l[c+3].y=o}}};Ee(K6,X6);var Q6=null,Z6=be(X6,{getAssemblerData:function(){return Q6||(Q6=new i0(1024,1024)),Q6.getTexture()},_updateFontFamily:function(e){r0.fontAtlas=Q6,r0.fontFamily=this._getFontFamily(e);var t=e.getComponent(U3);t&&t.enabled?(r0.isOutlined=!0,r0.margin=t.width,r0.out=t.color.clone(),r0.out.a=t.color.a*e.color.a/255):(r0.isOutlined=!1,r0.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){r0.fontDesc=this._getFontDesc(),r0.color=e.color,r0.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(r0)},_getFontDesc:function(){return r0.fontSize.toString()+"px "+r0.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),J6=new vi(255,255,255,255),$6={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var n=e.node;J6.a=255*n._uiProps.opacity,GJ(n,t,e.renderData,J6)}},appendQuad:K6.appendQuad};Ee($6,Z6);var e7=a2.Overflow,t7=(1/255).toFixed(3),n7=null,i7=null,r7=null,o7="",a7="",s7=0,c7=0,l7=[],u7=new Wi,h7=0,f7=0,_7=0,p7=new vi,d7="",m7=e7.NONE,v7=!1,g7=null,y7=vi.BLACK.clone(),S7=null,x7=vi.BLACK.clone(),T7=new Xi,E7=Wi.ZERO.clone(),b7=Wi.ZERO.clone(),C7=zi.ZERO.clone(),A7=zi.ZERO.clone(),w7=0,R7=0,I7=!1,P7=!1,O7=!1,D7=["left","center","right"],M7={getAssemblerData:function(){return a2._canvasPool.get()},resetAssemblerData:function(e){e&&a2._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this.updateOpacity(e),this._calDynamicAtlas(e),e.actualFontSize=s7,t.setContentSize(u7),this.updateVertexData(e),this.updateUvs(e),e.markForUpdateRenderData(!1),n7=null,i7=null,r7=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUvs:function(){},updateOpacity:function(e){for(var t=e.renderData.vData,n=5,i=e.node._uiProps.opacity,r=0;r<4;r++)t[n+3]=i,n+=9},_updateFontFamily:function(e){d7=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(n7=n.context,i7=n.canvas,r7=e.spriteFrame,a7=e.string.toString(),s7=e.fontSize,c7=s7,m7=e.overflow,b7.width=u7.width=t.width,b7.height=u7.height=t.height,R7=e.underlineHeight,h7=e.lineHeight,f7=e.horizontalAlign,_7=e.verticalAlign,p7=e.color,e.node._uiProps.opacity,I7=e.isBold,P7=e.isItalic,O7=e.isUnderline,v7=m7!==e7.NONE&&(m7===e7.RESIZE_HEIGHT||e.enableWrapText),(g7=(g7=U3&&e.getComponent(U3))&&g7.enabled&&g7.width>0?g7:null)&&y7.set(g7.color),(S7=(S7=P8&&e.getComponent(P8))&&S7.enabled?S7:null)&&x7.set(S7.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(E7.width=E7.height=0,g7&&(e=t=n=i=r=g7.width,E7.width=E7.height=2*r),S7){var o=S7.blur+r,a=S7.offset.x,s=S7.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),e=Math.max(e,s+o),t=Math.max(t,-s+o)}if(P7){var c=c7*Math.tan(.20943951);i+=c,E7.width+=c}T7.x=n,T7.y=e,T7.width=n+i,T7.height=e+t},_calculateFillTextStartPosition:function(){var e=0;f7===J1.RIGHT?e=u7.width-T7.width:f7===J1.CENTER&&(e=(u7.width-T7.width)/2);var t=this._getLineHeight()*(l7.length-1),n=s7*(1-x$/2);if(_7!==$1.TOP){var i=t+T7.height+s7-u7.height;_7===$1.BOTTOM?n-=i+=x$/2*s7:n-=i/2}n+=0*s7,C7.set(e+T7.x,n+T7.y)},_updateTexture:function(e){if(n7&&i7){n7.clearRect(0,0,i7.width,i7.height),n7.font=o7,this._calculateFillTextStartPosition();var t=this._getLineHeight();n7.lineJoin="round",g7?(n7.fillStyle="rgba("+y7.r+", "+y7.g+", "+y7.b+", "+t7+")",n7.fillRect(0,0,i7.width,i7.height)):e._srcBlendFactor===Gr.SRC_ALPHA&&(n7.fillStyle="rgba("+p7.r+", "+p7.g+", "+p7.b+", "+t7+")",n7.fillRect(0,0,i7.width,i7.height)),n7.fillStyle="rgb("+p7.r+", "+p7.g+", "+p7.b+")";var n=C7.x,i=0;this._drawTextEffect(C7,t);for(var r=0;r<l7.length;++r)i=C7.y+r*t,g7&&n7.strokeText(l7[r],n,i),n7.fillText(l7[r],n,i);S7&&(n7.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===a2.CacheMode.BITMAP){var t=e.ttfSpriteFrame;qJ.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var n;r7&&i7&&(n=r7 instanceof JJ?r7.texture:r7,0!==i7.width&&0!==i7.height&&(n.reset({width:i7.width,height:i7.height,mipmapLevel:1}),n.uploadData(i7),r7 instanceof JJ&&(r7.rect=new Xi(0,0,i7.width,i7.height),r7._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),i.director.root&&i.director.root.batcher2D&&i.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(e){if(e.cacheMode===a2.CacheMode.BITMAP){var t=e.ttfSpriteFrame;qJ.packToDynamicAtlas(e,t),e.renderData.uvDirty=!0}},_setupOutline:function(){n7.strokeStyle="rgba("+y7.r+", "+y7.g+", "+y7.b+", "+y7.a/255+")",n7.lineWidth=2*g7.width},_setupShadow:function(){n7.shadowColor="rgba("+x7.r+", "+x7.g+", "+x7.b+", "+x7.a/255+")",n7.shadowBlur=S7.blur,n7.shadowOffsetX=S7.offset.x,n7.shadowOffsetY=-S7.offset.y},_drawTextEffect:function(e,t){if(S7||g7||O7){var n=l7.length>1&&S7,i=this._measureText(n7,o7),r=0,o=0;S7&&this._setupShadow(),g7&&this._setupOutline();for(var a=0;a<l7.length;++a)r=e.x,o=e.y+a*t,n&&(g7&&n7.strokeText(l7[a],r,o),n7.fillText(l7[a],r,o)),O7&&(w7=i(l7[a]),f7===J1.RIGHT?A7.x=e.x-w7:f7===J1.CENTER?A7.x=e.x-w7/2:A7.x=e.x,A7.y=o+c7/8,n7.fillRect(A7.x,A7.y,w7,R7));n&&(n7.shadowColor="transparent")}},_updateLabelDimensions:function(){u7.width=Math.min(u7.width,2048),u7.height=Math.min(u7.height,2048);var e=!1;i7.width!==u7.width&&(i7.width=u7.width,e=!0),i7.height!==u7.height&&(i7.height=u7.height,e=!0),e&&(n7.font=o7),n7.textAlign=D7[f7],n7.textBaseline="alphabetic"},_getFontDesc:function(){var e=s7.toString()+"px ";return e+=d7,I7&&(e="bold "+e),P7&&(e="italic "+e),e},_getLineHeight:function(){return 0|(0===h7?s7:h7*s7/c7)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=W(e);!(n=r()).done;){var o=M$(t,n.value,o7);i.push(o)}return i},_measureText:function(e,t){return function(n){return M$(e,n,t)}},_calculateShrinkFont:function(e){if(n7){var t=this._calculateParagraphLength(e,n7),n=0,i=0,r=0;if(v7){var o=b7.width,a=b7.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|s7+1,l=0;s<c;){if((l=s+c+1>>1)<=0){T(4003);break}s7=l,o7=this._getFontDesc(),n7.font=o7;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=M$(n7,e[n],o7);i+=L$(e[n],h,o,this._measureText(n7,o7)).length*u}i>a?c=l-1:s=l}0===s?T(4003):(s7=s,o7=this._getFontDesc(),n7.font=o7)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var f=(u7.width-T7.width)/r,_=u7.height/i;s7=c7*Math.min(1,f,_)|0,o7=this._getFontDesc(),n7.font=o7}}},_calculateWrapText:function(e){if(v7&&n7){l7=[];for(var t=b7.width,n=0;n<e.length;++n){var i=M$(n7,e[n],o7),r=L$(e[n],i,t,this._measureText(n7,o7));l7=l7.concat(r)}}},_calculateLabelFont:function(){if(n7){var e=a7.split("\n");switch(l7=e,o7=this._getFontDesc(),n7.font=o7,m7){case e7.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=M$(n7,e[i],o7);t=t>r?t:r}n=(l7.length+x$)*this._getLineHeight();var o=parseFloat(t.toFixed(2)),a=parseFloat(n.toFixed(2));u7.width=o+T7.width,u7.height=a+T7.height,b7.width=o+E7.width,b7.height=a+E7.height;break;case e7.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case e7.CLAMP:this._calculateWrapText(e);break;case e7.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(l7.length+x$)*this._getLineHeight();u7.height=s+T7.height,b7.height=s+E7.height}}}},N7=vi.WHITE.clone(),L7={createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indicesCount=6;var n=t.vData=new Float32Array(36);n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)vi.toArray(n,N7,i),i+=9;return t},fillBuffers:function(e,t){var n=e.renderData,i=n.data,r=e.node,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=o.indicesOffset,c=o.vertexOffset;o.request()||(o=t.currBufferBatch,s=0,c=0,a=0);var l=o.vData,u=o.iData,h=n.vData,f=i[0],_=i[3];r.updateWorldTransform();var p=r._pos,d=r._rot,m=r._scale,v=f.x*m.x,g=_.x*m.x,y=f.y*m.y,S=_.y*m.y,x=d.x,T=d.y,E=d.z,b=d.w,C=x*T,A=E*b,w=x*x-T*T,R=b*b-E*E,I=R+w,P=2*(C-A),O=R-w,D=2*(C+A),M=p.x,N=p.y;h[0]=I*v+P*y+M,h[1]=O*y+D*v+N,h[9]=I*g+P*y+M,h[10]=O*y+D*g+N,h[18]=I*v+P*S+M,h[19]=O*S+D*v+N,h[27]=I*g+P*S+M,h[28]=O*S+D*g+N,l.set(h,a),u[s++]=c,u[s++]=c+1,u[s++]=c+2,u[s++]=c+2,u[s++]=c+1,u[s++]=c+3},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.data;s[0].x=-o,s[0].y=-a,s[3].x=i-o,s[3].y=r-a}},updateUvs:function(e){var t=e.renderData;if(t){var n=t.vData;if(n&&t.uvDirty){var i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7],t.uvDirty=!1}}}};Ee(L7,M7);var B7=e("labelAssembler",{getAssembler:function(e){var t=L7;return e.font instanceof y$?t=K6:e.cacheMode===a2.CacheMode.CHAR&&(t=$6),t}});a2.Assembler=B7;var F7=e5.FillType,z7=new Ni,U7=new vi(255,255,255,255),k7={useModel:!1,updateRenderData:function(e){var t=e.spriteFrame;qJ.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){n.updateRenderData(e,t);var i=n.uvDirty,r=n.vertDirty;if(!i&&!r)return;var o=e.fillStart,a=e.fillRange;a<0&&(o+=a,a=-a),a=(a=(a=o+a)>1?1:a)<0?0:a;var s=(o=(o=o>1?1:o)<0?0:o)+(a=(a-=o)<0?0:a);s=s>1?1:s,i&&this.updateUVs(e,o,s),r&&(this.updateVertexData&&this.updateVertexData(e,o,s),this.updateWorldVertexData(e))}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData,o=r.data,a=i.width,s=i.height,c=i.getRect(),l=0,u=0,h=0,f=0,_=0,p=0,d=0,m=0,v=0,g=0;switch(i.isRotated()?(l=c.x/a,u=(c.y+c.width)/s,h=_=l,d=v=(c.x+c.height)/a,p=g=u,f=m=c.y/s):(l=c.x/a,u=(c.y+c.height)/s,h=d=l,_=v=(c.x+c.width)/a,f=p=u,m=g=c.y/s),e.fillType){case F7.HORIZONTAL:o[0].u=h+(_-h)*t,o[0].v=f+(p-f)*t,o[1].u=h+(_-h)*n,o[1].v=f+(p-f)*n,o[2].u=d+(v-d)*t,o[2].v=m+(g-m)*t,o[3].u=d+(v-d)*n,o[3].v=m+(g-m)*n;break;case F7.VERTICAL:o[0].u=h+(d-h)*t,o[0].v=f+(m-f)*t,o[1].u=_+(v-_)*t,o[1].v=p+(g-p)*t,o[2].u=h+(d-h)*n,o[2].v=f+(m-f)*n,o[3].u=_+(v-_)*n,o[3].v=p+(g-p)*n;break;default:A(2626)}r.uvDirty=!1},updateVertexData:function(e,t,n){var i=e.renderData,r=i.data,o=e.node._uiProps.uiTransformComp,a=o.width,s=o.height,c=o.anchorX*a,l=o.anchorY*s,u=-c,h=-l,f=a-c,_=s-l,p=0;switch(e.fillType){case F7.HORIZONTAL:p=u+(f-u)*n,u+=(f-u)*t,f=p;break;case F7.VERTICAL:p=h+(_-h)*n,h+=(_-h)*t,_=p;break;default:A(2626)}r[4].x=u,r[4].y=h,r[5].x=f,r[5].y=h,r[6].x=u,r[6].y=_,r[7].x=f,r[7].y=_,i.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indicesCount=6;for(var n,i=W(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e){var t=e.node,n=e.renderData.data;t.getWorldMatrix(z7);for(var i=0;i<4;i++){var r=n[i+4],o=n[i];yi.transformMat4(o,r,z7)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);var n=e.node;U7.set(e.color),U7.a=255*n._uiProps.opacity,function(e,t,n,i){var r=n.data,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(s,n.indicesCount)||(o=t.currBufferBatch,a=0,c=0,l=0);for(var u=o.vData,h=0;h<s;h++){var f=r[h];u[a++]=f.x,u[a++]=f.y,u[a++]=f.z,u[a++]=f.u,u[a++]=f.v,vi.toArray(u,i,a),a+=4}var _=o.iData;_[c++]=l,_[c++]=l+1,_[c++]=l+2,_[c++]=l+1,_[c++]=l+3,_[c++]=l+2}(0,t,e.renderData,U7)},updateColor:function(){}},G7=2*Math.PI,H7=1e-6,V7=new vi(255,255,255,255),j7=[new zi,new zi,new zi,new zi],W7=new Array(4),q7=new Array(8),X7=[new zi,new zi,new zi,new zi],Y7=[new zi,new zi,new zi,new zi],K7=new zi,Q7=[new zi,new zi,new zi,new zi];function Z7(e,t,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>H7?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>H7?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);a[0].x=e,a[0].y=h}if((t-r.x)*c>0){var f=r.y+l*(t-r.x);a[2].x=t,a[2].y=f}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var _=r.x+u*(i-r.y);a[3].x=_,a[3].y=i}if((n-r.y)*s>0){var p=r.x+u*(n-r.y);a[1].x=p,a[1].y=n}}}function J7(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function $7(e,t,n,i,r){var o=W7,a=o[0],s=o[1],c=o[2],l=o[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,e9((n.x-a)/(c-a),(n.y-s)/(l-s),e,t),e9((i.x-a)/(c-a),(i.y-s)/(l-s),e,t+1),e9((r.x-a)/(c-a),(r.y-s)/(l-s),e,t+2)}function e9(e,t,n,i){var r=q7,o=r[0]+(r[2]-r[0])*e,a=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=o+(a-o)*t,l.v=s+(c-s)*t}for(var t9={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;qJ.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){if(n.vertDirty||n.uvDirty){var i=n.data,r=e.fillStart,o=e.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=G7)+(o*=G7);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,o=t.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=W7;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,f=K7.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,_=K7.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;j7[0].x=j7[3].x=a,j7[1].x=j7[2].x=c,j7[0].y=j7[1].y=s,j7[2].y=j7[3].y=l;for(var p,d=W(Q7);!(p=d()).done;){var m=p.value;zi.set(m,0,0)}f!==u[0]&&zi.set(Q7[0],3,0),f!==u[2]&&zi.set(Q7[2],1,2),_!==u[1]&&zi.set(Q7[1],0,1),_!==u[3]&&zi.set(Q7[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,o=0,a=0,s=0,c=q7;e.isRotated()?(r=i.x/t,o=(i.x+i.height)/t,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/t,o=(i.x+i.width)/t,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(t),Z7(W7[0],W7[2],W7[1],W7[3],K7,r,X7),Z7(W7[0],W7[2],W7[1],W7[3],K7,r+o,Y7);for(var s=0,c=0;c<4;++c){var l=Q7[c];if(l)if(o>=G7)n.dataLength=s+3,$7(i,s,K7,j7[l.x],j7[l.y]),s+=3;else{var u=J7(K7,j7[l.x]),h=J7(K7,j7[l.y]);h<u&&(h+=G7),u-=G7,h-=G7;for(var f=0;f<3;++f)u>=a||(u>=r?(n.dataLength=s+3,$7(i,s,K7,j7[l.x],h>=a?Y7[c]:j7[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,$7(i,s,K7,X7[c],j7[l.y]),s+=3):(n.dataLength=s+3,$7(i,s,K7,X7[c],Y7[c]),s+=3))),u+=G7,h+=G7}}n.indicesCount=n.vertexCount=s,n.vertDirty=n.uvDirty=!1}n.updateRenderData(e,t)}},fillBuffers:function(e,t){var n=e.node,i=e.renderData;V7.set(e.color),V7.a=255*n._uiProps.opacity,function(e,t,n,i){var r=n.data,o=t.acquireBufferBatch(),a=o.byteOffset>>2,s=n.vertexCount,c=o.indicesOffset,l=o.vertexOffset;o.request(s,n.indicesCount)||(o=t.currBufferBatch,a=0,c=0,l=0);var u=o.vData;e.getWorldMatrix(kJ);for(var h=0;h<s;h++){var f=r[h];yi.set(UJ,f.x,f.y,0),yi.transformMat4(UJ,UJ,kJ),u[a++]=UJ.x,u[a++]=UJ.y,u[a++]=UJ.z,u[a++]=f.u,u[a++]=f.v,vi.toArray(u,i,a),a+=4}for(var _=o.iData,p=0;p<n.dataLength;p++)_[c+p]=l+p}(n,t,i,V7)},updateColor:function(){}},n9=[],i9=0;i9<4;i9++)n9.push(new yi);for(var r9={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame;qJ.packToDynamicAtlas(e,t);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.uvDirty&&this.updateUvs(e),n.updateRenderData(e,t))},updateWorldVerts:function(e,t){var n=e.renderData.data,i=e.node,r=n[0],o=n[3],a=i.worldMatrix,s=a.m00,c=a.m01,l=a.m04,u=a.m05,h=1===s&&0===c&&0===l&&1===u,f=a.m12,_=a.m13,p=r.x,d=o.x,m=r.y,v=o.y;if(h){var g=p+f,y=d+f,S=m+_,x=v+_;t[0]=g,t[1]=S,t[9]=y,t[10]=S,t[18]=g,t[19]=x,t[27]=y,t[28]=x}else{var T=s*p,E=s*d,b=c*p,C=c*d,A=l*m+f,w=l*v+f,R=u*m+_,I=u*v+_;t[0]=T+A,t[1]=b+R,t[9]=E+A,t[10]=C+R,t[18]=T+w,t[19]=b+I,t[27]=E+w,t[28]=C+I}},fillBuffers:function(e,t){if(null!==e){var n=e.renderData.vData;e.node.hasChangedFlags&&this.updateWorldVerts(e,n);var i=t.acquireBufferBatch(),r=i.byteOffset>>2,o=i.indicesOffset,a=i.vertexOffset;i.request()||(i=t.currBufferBatch,r=0,o=0,a=0);var s=i.vData,c=i.iData;s.set(n,r);var l=a,u=a+1,h=a+2,f=a+3;c[o++]=l,c[o++]=u,c[o++]=h,c[o++]=h,c[o++]=u,c[o++]=f}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(e.trim)c=-a,l=-s,u=r-a,h=o-s;else{var f=e.spriteFrame,_=f.getOriginalSize(),p=f.getRect(),d=_.width,m=_.height,v=p.width,g=p.height,y=f.getOffset(),S=r/d,x=o/m,T=y.x+(d-v)/2,E=y.x-(d-v)/2;c=T*S-a,l=(y.y+(m-g)/2)*x-s,u=r+E*S-a,h=o+(y.y-(m-g)/2)*x-s}i[0].x=c,i[0].y=l,i[3].x=u,i[3].y=h,t.vertDirty=!1,this.updateWorldVerts(e,t.vData)}},updateUvs:function(e){var t=e.renderData,n=t.vData,i=e.spriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,n=5,i=e.color,r=i.r/255,o=i.g/255,a=i.b/255,s=e.node._uiProps.opacity,c=0;c<4;c++)t[n]=r,t[n+1]=o,t[n+2]=a,t[n+3]=s,n+=9}},o9=new yi,a9=new Ni,s9={useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indicesCount=54,t},updateRenderData:function(e){var t=e.spriteFrame;qJ.packToDynamicAtlas(e,t);var n=e.renderData;n&&t&&(n.vertDirty&&(this.updateVertexData(e),this.updateWorldVertexData(e)),n.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData,n=t.data,i=e.node._uiProps.uiTransformComp,r=i.width,o=i.height,a=i.anchorX*r,s=i.anchorY*o,c=e.spriteFrame,l=c.insetLeft,u=c.insetRight,h=c.insetTop,f=c.insetBottom,_=r-l-u,p=o-h-f,d=r/(l+u),m=o/(h+f);d=Number.isNaN(d)||d>1?1:d,m=Number.isNaN(m)||m>1?1:m,_=_<0?0:_,p=p<0?0:p,n[0].x=-a,n[0].y=-s,n[1].x=l*d-a,n[1].y=f*m-s,n[2].x=n[1].x+_,n[2].y=n[1].y+p,n[3].x=r-a,n[3].y=o-s,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);var n=t.acquireBufferBatch(),i=e.renderData,r=i.data,o=n.byteOffset>>2,a=i.vertexCount,s=n.indicesOffset,c=n.vertexOffset,l=e.spriteFrame.uvSliced;n.request(a,i.indicesCount)||(n=t.currBufferBatch,o=0,s=0,c=0);for(var u=n.vData,h=n.iData,f=4;f<20;++f){var _=r[f],p=l[f-4];u[o++]=_.x,u[o++]=_.y,u[o++]=_.z,u[o++]=p.u,u[o++]=p.v,vi.toArray(u,r[f].color,o),o+=4}for(var d=0;d<3;++d)for(var m=0;m<3;++m){var v=c+4*d+m;h[s++]=v,h[s++]=v+1,h[s++]=v+4,h[s++]=v+1,h[s++]=v+5,h[s++]=v+4}},updateWorldVertexData:function(e){var t=e.node,n=e.renderData.data;t.getWorldMatrix(a9);for(var i=0;i<4;++i)for(var r=n[i],o=0;o<4;++o){var a=n[o],s=n[4+4*i+o];yi.set(o9,a.x,r.y,0),yi.transformMat4(s,o9,a9)}},updateColor:function(e){for(var t=e.renderData.data,n=e.color,i=n.r,r=n.g,o=n.b,a=255*e.node._uiProps.opacity,s=4;s<20;s++)t[s].color.r=i,t[s].color.g=r,t[s].color.b=o,t[s].color.a=a}},c9=[],l9=0;l9<4;l9++)c9.push(new yi);var u9={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.updateRenderData(e,n),t.uvDirty||t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,f=a.height-u-h,_=r-s-c,p=o-u-h;_=_>0?_:0,p=p>0?p:0;var d=0===l?_:_/l,m=0===f?p:p/f,v=Math.ceil(m+2),g=Math.ceil(d+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,_,p,v,g),t.vertexCount=v*g*4,t.indicesCount=v*g*6,t.uvDirty=!1,t.vertDirty=!1,this.updateColor(e)}},fillBuffers:function(e,t){var n=e.node,i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=e.renderData,s=t.acquireBufferBatch(),c=s.indicesOffset,l=s.byteOffset>>2,u=s.vertexOffset,h=a.vertexCount,f=a.indicesCount,_=s.vData,p=s.iData;s.request(h,f)||(s=t.currBufferBatch,l=0,c=0,u=0);var d=e.spriteFrame,m=d.isRotated(),v=d.uv,g=e.spriteFrame.uvSliced,y=d.getRect(),S=d.insetLeft,x=d.insetRight,T=y.width-S-x,E=d.insetTop,b=d.insetBottom,C=y.height-E-b,A=r-S-x,w=o-E-b;A=A>0?A:0,w=w>0?w:0;var R=0===T?A:A/T,I=0===C?w:w/C,P=Math.ceil(I+2),O=Math.ceil(R+2),D=n.worldMatrix,M=a.data;this.fillVertices(_,l,D,P,O,M);for(var N=0,L=0,B=[],F=[],z=0,U=P;z<U;++z){L=w>C?w>=z*C?1:I%1:I;for(var k=0,G=O;k<G;++k){N=A>T?A>=k*T?1:R%1:R;var H=l+3,V=H+1;m?(0===z?(B[0]=g[0].u,B[1]=g[0].u,B[2]=g[4].u+(g[8].u-g[4].u)*L):z<P-1?(B[0]=g[4].u,B[1]=g[4].u,B[2]=g[4].u+(g[8].u-g[4].u)*L):z===P-1&&(B[0]=g[8].u,B[1]=g[8].u,B[2]=g[12].u),0===k?(F[0]=g[0].v,F[1]=g[1].v+(g[2].v-g[1].v)*N,F[2]=g[0].v):k<O-1?(F[0]=g[1].v,F[1]=g[1].v+(g[2].v-g[1].v)*N,F[2]=g[1].v):k===O-1&&(F[0]=g[2].v,F[1]=g[3].v,F[2]=g[2].v),B[3]=B[2],F[3]=F[1]):(0===k?(B[0]=g[0].u,B[1]=g[1].u+(g[2].u-g[1].u)*N,B[2]=v[0]):k<O-1?(B[0]=g[1].u,B[1]=g[1].u+(g[2].u-g[1].u)*N,B[2]=g[1].u):k===O-1&&(B[0]=g[2].u,B[1]=g[3].u,B[2]=g[2].u),0===z?(F[0]=g[0].v,F[1]=g[0].v,F[2]=g[4].v+(g[8].v-g[4].v)*L):z<P-1?(F[0]=g[4].v,F[1]=g[4].v,F[2]=g[4].v+(g[8].v-g[4].v)*L):z===P-1&&(F[0]=g[8].v,F[1]=g[8].v,F[2]=g[12].v),B[3]=B[1],F[3]=F[2]),_[H]=B[0],_[V]=F[0],_[H+9]=B[1],_[V+9]=F[1],_[H+18]=B[2],_[V+18]=F[2],_[H+27]=B[3],_[V+27]=F[3],vi.toArray(_,M[0].color,V+1),vi.toArray(_,M[0].color,V+9+1),vi.toArray(_,M[0].color,V+18+1),vi.toArray(_,M[0].color,V+27+1),l+=36}}for(var j=0;j<f;j+=6)p[c++]=u,p[c++]=u+1,p[c++]=u+2,p[c++]=u+1,p[c++]=u+3,p[c++]=u+2,u+=4},fillVertices:function(e,t,n,i,r,o){for(var a=0,s=0,c=0,l=0,u=0,h=i;u<h;++u){c=o[u].y,l=o[u+1].y;for(var f=0,_=r;f<_;++f){a=o[f].x,s=o[f+1].x,yi.set(c9[0],a,c,0),yi.set(c9[1],s,c,0),yi.set(c9[2],a,l,0),yi.set(c9[3],s,l,0);for(var p=0;p<4;p++){var d=c9[p];yi.transformMat4(d,d,n);var m=9*p;e[t+m]=d.x,e[t+m+1]=d.y,e[t+m+2]=d.z}t+=36}}},updateVerts:function(e,t,n,i,r){var o,a,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.getRect(),h=Math.abs(s.width),f=Math.abs(s.height),_=s.anchorX*h,p=s.anchorY*f,d=l.insetLeft,m=l.insetRight,v=u.width-d-m,g=l.insetTop,y=l.insetBottom,S=u.height-g-y,x=s.width/(d+m)>1?1:s.width/(d+m),T=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,a=S>0?Math.floor(1e3*n)/1e3%S==0?S:n%S:n;for(var E=0;E<=r;E++)0===E?c[E].x=-_:E>0&&E<r?c[E].x=1===E?d*x+Math.min(v,t)-_:v>0?E===r-1?d+o+v*(E-2)-_:d+Math.min(v,t)+v*(E-2)-_:d+t-_:E===r&&(c[E].x=Math.min(d+t+m,h)-_);for(var b=0;b<=i;b++)0===b?c[b].y=-p:b>0&&b<i?c[b].y=1===b?y*T+Math.min(S,n)-p:S>0?b===i-1?y+a+(b-2)*S-p:y+Math.min(S,n)+(b-2)*S-p:y+n-p:b===i&&(c[b].y=Math.min(y+n+g,f)-p)},updateColor:function(e){var t=e.renderData.data,n=t.length;if(0!==n)for(var i=e.color,r=i.r,o=i.g,a=i.b,s=255*e.node._uiProps.opacity,c=0;c<n;c++)t[c].color.r=r,t[c].color.g=o,t[c].color.b=a,t[c].color.a=s}},h9=e5.Type,f9=e5.FillType,_9=e("spriteAssembler",{getAssembler:function(e){var t=r9,n=e;switch(n.type){case h9.SLICED:t=s9;break;case h9.TILED:t=u9;break;case h9.FILLED:t=n.fillType===f9.RADIAL?t9:k7}return t}});e5.Assembler=_9;var p9=k0.sharedManager,d9={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){e.type===S4.IMAGE_STENCIL&&(r9.updateRenderData(e),r9.updateColor(e))},fillBuffers:function(e,t){(e.type!==S4.IMAGE_STENCIL||e.spriteFrame)&&(p9.pushMask(e),t.finishMergeBatches(),function(e,t){p9.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(p9.enterLevel(e),e.type===S4.IMAGE_STENCIL){r9.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),p9.enableMask())}},m9={fillBuffers:function(){p9.exitMask()}},v9={getAssembler:function(){return d9}},g9={getAssembler:function(){return m9}};I4.Assembler=v9,I4.PostAssembler=g9,new(function(){function e(){this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],yO.on(vO.EventType.MOUSE_DOWN,this.dispatchEventMouse,this),yO.on(vO.EventType.MOUSE_MOVE,this.dispatchEventMouse,this),yO.on(vO.EventType.MOUSE_UP,this.dispatchEventMouse,this),yO.on(vO.EventType.MOUSE_WHEEL,this.dispatchEventMouse,this),yO.on(vO.EventType.TOUCH_START,this.dispatchEventTouch,this),yO.on(vO.EventType.TOUCH_MOVE,this.dispatchEventTouch,this),yO.on(vO.EventType.TOUCH_END,this.dispatchEventTouch,this),yO.on(vO.EventType.TOUCH_CANCEL,this.dispatchEventTouch,this),FP.callbacksInvoker.on(ZA.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),FP.callbacksInvoker.on(ZA.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this)}var t=e.prototype;return t.addPointerEventProcessor=function(e){0===this._inDispatchCount?(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.push(e)},t.removePointerEventProcessor=function(e){0===this._inDispatchCount?(He.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.push(e)},t.dispatchEventMouse=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=!0,r=0;r<n;++r){var o=t[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(e)&&(i=!1,!e.preventSwallow))break}var a=SO[e.type];i&&a&&yO._eventTarget.emit(a,e),--this._inDispatchCount<=0&&this._updatePointerEventProcessorList()},t.dispatchEventTouch=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=e.touch,r=!0,o=0;o<n;++o){var a=t[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(e.type===KA.TOUCH_START){if(a._handleEventTouch(e)&&(a.claimedTouchIdList.push(i.getID()),r=!1,!e.preventSwallow))break}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s&&(a._handleEventTouch(e),e.type!==KA.TOUCH_END&&e.type!==KA.TOUCH_CANCEL||He.array.removeAt(a.claimedTouchIdList,s),r=!1,!e.preventSwallow))break}}var c=SO[e.type];r&&c&&yO._eventTarget.emit(c,e.touch,e),--this._inDispatchCount<=0&&this._updatePointerEventProcessorList()},t._updatePointerEventProcessorList=function(){for(var e=this._processorListToAdd,t=e.length,n=0;n<t;++n)this.addPointerEventProcessor(e[n]);e.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},t._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,n=0;n<t;++n){var i=e[n],r=i.node._uiProps.uiTransformComp;i.cachedCameraPriority=r.cameraPriority}e.sort(this._sortByPriority),this._isListDirty=!1}},t._sortByPriority=function(e,t){var n=e.node,i=t.node;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,f;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(f=h.parent)||void 0===f?void 0:f.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var _=r?r.getSiblingIndex():0,p=o?o.getSiblingIndex():0;return a?_-p:p-_},e}());var y9=new ia(null),S9=new Ni,x9=e("UI",function(){var e=t.prototype;function t(e){var t=this;this.device=void 0,this._screens=[],this._bufferBatchPool=new qe((function(){return new Z5(t)}),128,(function(e){return e.destroy()})),this._drawBatchPool=void 0,this._meshBuffers=new Map,this._customMeshBuffers=new Map,this._meshBufferUseCount=new Map,this._batches=void 0,this._emptyMaterial=new Ng,this._currScene=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currBlendTargetHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._descriptorSetCache=new E9,this._root=e,this.device=e.device,this._batches=new Xe(64),this._drawBatchPool=new We((function(){return new R8}),128,(function(e){return e.destroy(t)}))}return e.acquireBufferBatch=function(e){void 0===e&&(e=W2);var t=e===W2?36:Y2(e);return this._currMeshBuffer&&this._currMeshBuffer.vertexFormatBytes===t||this._requireBufferBatch(e),this._currMeshBuffer},e.registerCustomBuffer=function(e,t){var n;e instanceof Z5?n=e:(n=this._bufferBatchPool.add()).initialize(e,t||this._recreateMeshBuffer.bind(this,e));var i=n.vertexFormatBytes,r=this._customMeshBuffers.get(i);return r||(r=[],this._customMeshBuffers.set(i,r)),r.push(n),n},e.unRegisterCustomBuffer=function(e){var t=this._customMeshBuffers.get(e.vertexFormatBytes);if(t)for(var n=0;n<t.length;n++)if(t[n]===e){t.splice(n,1);break}var i=this._bufferBatchPool.data.indexOf(e);-1!==i&&(e.reset(),this._bufferBatchPool.removeAt(i))},e.initialize=function(){return!0},e.destroy=function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy();for(var t,n=W(this._meshBuffers.keys());!(t=n()).done;){var i=t.value,r=this._meshBuffers.get(i);r&&r.forEach((function(e){return e.destroy()}))}this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),this._meshBuffers.clear(),k0.sharedManager.destroy()},e.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},e.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null},e.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},e.sortScreens=function(){this._screens.sort(this._screenSort)},e.update=function(){for(var e=this._screens,t=0;t<e.length;++t){var n=e[t];n.enabledInHierarchy&&this._recursiveScreenNode(n.node)}var i=0;if(this._batches.length)for(var r=0;r<this._batches.length;++r){var o=this._batches.array[r];if(o.renderScene){if(o.model)for(var a=o.model.subModels,s=0;s<a.length;s++)a[s].priority=i++;else o.descriptorSet=this._descriptorSetCache.getDescriptorSet(o);o.renderScene.addBatch(o)}}},e.uploadBuffers=function(){this._batches.length>0&&(this._meshBuffers.forEach((function(e){e.forEach((function(e){e.uploadBuffers(),e.reset()}))})),this._customMeshBuffers.forEach((function(e){e.forEach((function(e){e.uploadBuffers(),e.reset()}))})),this._descriptorSetCache.update())},e.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._currHash=0,this._currLayer=0,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._currScene=null,this._currMeshBuffer=null,this._meshBufferUseCount.clear(),this._batches.clear(),k0.sharedManager.reset(),this._descriptorSetCache.reset()},e.commitComp=function(e,t,n,i){var r,o=e,a=e.renderData,s=0;a&&(s=a.dataHash,r=a.material),o.stencilStage=k0.sharedManager.stage;var c=o.stencilStage;if(this._currHash!==s||0===s||this._currMaterial!==r||this._currDepthStencilStateStage!==c)if(this.autoMergeBatches(this._currComponent),a){this._currHash=a.dataHash,this._currScene=a.renderScene,this._currComponent=o,this._currTransform=i,this._currMaterial=a.material,this._currBlendTargetHash=a.blendHash,this._currDepthStencilStateStage=c,this._currLayer=a.layer;var l=a.frame;l?(this._currTexture=l.getGFXTexture(),this._currSampler=l.getGFXSampler(),this._currTextureHash=a.textureHash,this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)}else this._currHash=s,this._currScene=o._getRenderScene(),this._currComponent=o,this._currTransform=i,this._currMaterial=o.getRenderMaterial(0),this._currBlendTargetHash=o.blendHash,this._currDepthStencilStateStage=c,this._currLayer=o.node.layer,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0);n&&n.fillBuffers(o,this)},e.commitModel=function(e,t,n){var r;this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);var o=0;n&&(e.stencilStage!==Q$.ENABLED&&e.stencilStage!==Q$.DISABLED||(e.stencilStage=k0.sharedManager.stage),r=k0.sharedManager.getStencilStage(e.stencilStage,n),o=k0.sharedManager.getStencilHash(e.stencilStage));var a=i.director.getTotalFrames();t&&(t.updateTransform(a),t.updateUBOs(a));for(var s=0;s<t.subModels.length;s++){var c=this._drawBatchPool.alloc(),l=t.subModels[s];c.renderScene=e._getRenderScene(),c.visFlags=e.node.layer,c.model=t,c.bufferBatch=null,c.texture=null,c.sampler=null,c.useLocalData=null,r||(r=null),c.fillPasses(n,r,o,null,0,l.patches,this),c.inputAssembler=l.inputAssembler,c.model.visFlags=c.visFlags,c.descriptorSet=l.descriptorSet,this._batches.push(c)}this._currMaterial=this._emptyMaterial,this._currScene=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currLayer=0},e.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},e.autoMergeBatches=function(e){var t=this.currBufferBatch,n=null==t?void 0:t.recordBatch(),i=this._currMaterial;if(n&&i&&t){var r,o,a=0,s=0;e&&(r=-1===e.blendHash?null:e.getBlendState(),s=e.blendHash,o=null!==e.customMaterial?k0.sharedManager.getStencilStage(e.stencilStage,i):k0.sharedManager.getStencilStage(e.stencilStage),a=k0.sharedManager.getStencilHash(e.stencilStage));var c=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();c.renderScene=this._currScene,c.visFlags=this._currLayer,c.bufferBatch=t,c.texture=this._currTexture,c.sampler=this._currSampler,c.inputAssembler=n,c.useLocalData=this._currTransform,c.textureHash=this._currTextureHash,c.samplerHash=this._currSamplerHash,c.fillPasses(this._currMaterial,o,a,r,s,null,this),this._batches.push(c),t.vertexStart=t.vertexOffset,t.indicesStart=t.indicesOffset,t.byteStart=t.byteOffset,dh.__isWebIOS14OrIPadOS14Env&&!this._currIsStatic&&(this._currMeshBuffer=null)}},e.forceMergeBatches=function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this._currScene=n._getRenderScene(),this.autoMergeBatches(n)},e.finishMergeBatches=function(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.flushMaterial=function(e){this._currMaterial=e},e.walk=function(e,t){void 0===t&&(t=0);var n=e.children.length;if(this._preProcess(e),n>0&&!e._static)for(var i=e.children,r=0;r<i.length;++r){var o=i[r];this.walk(o,t)}this._postProcess(e),t+=1},e._preProcess=function(e){if(e._uiProps.opacityDirty){var t,n=1;if(null===(t=e.parent)||void 0===t?void 0:t._uiProps){n=e.parent._uiProps.opacity;var i=e._uiProps.uiComp;i&&i.markColorDirty&&(n*=i.color.a/255,i.markColorDirty())}e._uiProps.opacityDirty=!1,e._uiProps.applyOpacity(n)}var r=e._uiProps.uiComp;e._uiProps.uiTransformComp&&r&&r.enabledInHierarchy&&r.updateAssembler(this)},e._postProcess=function(e){var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)},e._recursiveScreenNode=function(e){this.walk(e),this.autoMergeBatches(this._currComponent)},e._createMeshBuffer=function(e){var t=this._bufferBatchPool.add();t.initialize(e,this._recreateMeshBuffer.bind(this,e));var n=Y2(e),i=this._meshBuffers.get(n);return i||(i=[],this._meshBuffers.set(n,i)),i.push(t),t},e._recreateMeshBuffer=function(e,t,n){this.autoMergeBatches(),this._requireBufferBatch(e,t,n)},e._requireBufferBatch=function(e,t,n){var i=Y2(e),r=this._meshBuffers.get(i);r||(r=[],this._meshBuffers.set(i,r));var o=this._meshBufferUseCount.get(i)||0;(t&&n||dh.__isWebIOS14OrIPadOS14Env)&&o++,this._currMeshBuffer=r[o],this._currMeshBuffer||(this._currMeshBuffer=this._createMeshBuffer(e)),this._meshBufferUseCount.set(i,o),t&&n&&this._currMeshBuffer.request(t,n)},e._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},e._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},L(t,[{key:"currBufferBatch",get:function(){return this._currMeshBuffer||(this._currMeshBuffer=this.acquireBufferBatch()),this._currMeshBuffer},set:function(e){e&&(this._currMeshBuffer=e)}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),t}()),T9=function(){function e(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=i.director.root.device;this._localData=new Float32Array(gd.COUNT),this._localBuffer=e.createBuffer(new wo(Rr.UNIFORM|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,gd.SIZE,gd.SIZE))}var t=e.prototype;return t.initialize=function(e){var t=i.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,y9.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(y9),this._descriptorSet.bindBuffer(gd.BINDING,this._localBuffer);var n=Qp.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},t.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},t.updateLocal=function(){this._transform&&this.uploadLocalData()},t.equals=function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n},t.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},t.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},t.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&e.updateWorldTransform(),this._transformUpdate){var t=e._mat;Ni.toArray(this._localData,t,gd.MAT_WORLD_OFFSET),Ni.inverseTranspose(S9,t);var n=Ni.determinant(S9),i=1/Math.sqrt(n);Ni.multiplyScalar(S9,S9,i),Ni.toArray(this._localData,S9,gd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},L(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),E9=function(){function e(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new We((function(){return new T9}),16,(function(e){return e.destroy()}))}var t=e.prototype;return t.getDescriptorSet=function(e){var t,n=i.director.root;if(e.useLocalData){for(var r=this._localDescriptorSetCache,o=0,a=r.length;o<a;o++){var s=r[o];if(s.equals(e.useLocalData,e.textureHash,e.samplerHash))return s.descriptorSet}var c=this._localCachePool.alloc();return c.initialize(e),this._localDescriptorSetCache.push(c),c.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);y9.layout=e.passes[0].localSetLayout;var l=n.device.createDescriptorSet(y9),u=Qp.SAMPLER_SPRITE;return l.bindTexture(u,e.texture),l.bindSampler(u,e.sampler),l.update(),this._descriptorSetCache.set(t,l),this._dsCacheHashByTexture.set(e.textureHash,t),l},t.update=function(){this._localDescriptorSetCache.forEach((function(e){e.updateLocal()}))},t.reset=function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},t.destroy=function(){this._descriptorSetCache.forEach((function(e){e.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},e}();i.internal.Batcher2D=x9;var b9,C9,A9,w9,R9,I9,P9,O9,D9,M9,N9,L9,B9,F9,z9,U9,k9,G9,H9,V9,j9,W9,q9,X9,Y9,K9,Q9,Z9,J9,$9,eee,tee,nee,iee,ree,oee,aee,see,cee,lee,uee,hee,fee,_ee,pee,dee,mee,vee,gee,yee,See,xee=null,Tee=-1,Eee="BES bswy:->@123",bee=Object.create(null),Cee=[],Aee=3e3;function wee(){for(var e=!0,t=Date.now(),n=Cee.length-1;n>=0;n--){var i=Cee[n],r=i.fontFamilyName;if(t-i.startTime>Aee)b(4933,r),i.onComplete(null,r),Cee.splice(n,1);else{var o=i.refWidth,a="40px "+r;xee.font=a,o!==M$(xee,Eee,a)?(Cee.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(Tee),Tee=-1)}function Ree(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(e);if(bee[i])n(null,i);else{if(!xee){var r=document.createElement("canvas");r.width=100,r.height=100,xee=r.getContext("2d")}var o=M$(xee,Eee,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+e+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===b9)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);b9=e?parseInt(e[1],10)>42:!t}else b9=!1;return b9}())!function(e,t,n){var i=new Promise((function(n,i){!function r(){Date.now()-e>=Aee?i():document.fonts.load("40px "+t).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,o=new Promise((function(e,t){r=setTimeout(t,Aee)}));Promise.race([o,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,t)}),(function(){b(4933,t),n(null,t)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};Cee.push(u),-1===Tee&&(Tee=setInterval(wee,100))}bee[i]=a}}function Iee(e,t,n,i){var r=new d$;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}jN.register({".font":Ree,".eot":Ree,".ttf":Ree,".woff":Ree,".svg":Ree,".ttc":Ree}),ZN.register({".font":Iee,".eot":Iee,".ttf":Iee,".woff":Iee,".svg":Iee,".ttc":Iee}),i.UI={MeshBuffer:Z5,spriteAssembler:_9,graphicsAssembler:d6,labelAssembler:B7};var Pee,Oee,Dee,Mee=new vi;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(Pee||(Pee={})),$e(Pee),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(Oee||(Oee={})),function(e){e.CLICK="click"}(Dee||(Dee={}));var Nee,Lee,Bee,Fee=function(t){return e({Button:t,ButtonComponent:t}),t}((C9=sl("cc.Button"),A9=El(),w9=ll(110),R9=yl(),I9=cl(y0),P9=Hl(eA),O9=Nl(),D9=Rl(),M9=Nl(),N9=Rl(),L9=Hl(Pee),B9=Nl(),F9=Rl(),z9=Rl(),U9=Rl(),k9=Rl(),G9=Rl(),H9=Pl(),V9=Ol(),j9=Rl(),W9=Rl(),q9=Hl(JJ),X9=Rl(),Y9=Hl(JJ),K9=Rl(),Q9=Hl(JJ),Z9=Rl(),J9=Hl(JJ),$9=Rl(),eee=Hl([KB]),tee=Nl(),nee=Rl(),C9(iee=A9(iee=w9(iee=R9(iee=I9(iee=gl((See=yee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"clickEvents",oee,V(t)),q(t,"_interactable",aee,V(t)),q(t,"_transition",see,V(t)),q(t,"_normalColor",cee,V(t)),q(t,"_hoverColor",lee,V(t)),q(t,"_pressedColor",uee,V(t)),q(t,"_disabledColor",hee,V(t)),q(t,"_normalSprite",fee,V(t)),q(t,"_hoverSprite",_ee,V(t)),q(t,"_pressedSprite",pee,V(t)),q(t,"_disabledSprite",dee,V(t)),q(t,"_duration",mee,V(t)),q(t,"_zoomScale",vee,V(t)),q(t,"_target",gee,V(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new vi,t._toColor=new vi,t._time=0,t._transitionFinished=!0,t._fromScale=new yi,t._toScale=new yi,t._originalScale=null,t._sprite=null,t._targetScale=new yi,t}F(t,e);var n=t.prototype;return n.__preload=function(){this.target||(this.target=this.node);var e=this.node.getComponent(e5);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===Pee.COLOR||this._transition===Pee.SCALE)){this._time+=e;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===Pee.COLOR){var i=t._uiProps.uiComp;vi.lerp(Mee,this._fromColor,this._toColor,n),i&&(i.color=Mee)}else this.transition===Pee.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=ei(this._fromScale.x,this._toScale.x,n),this._targetScale.y=ei(this._fromScale.y,this._toScale.y,n),t.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===Pee.COLOR&&this._interactable){var n=e.getComponent(n2);n&&(n.color=this._normalColor)}else t===Pee.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(JE.TOUCH_START,this._onTouchBegan,this),this.node.on(JE.TOUCH_MOVE,this._onTouchMove,this),this.node.on(JE.TOUCH_END,this._onTouchEnded,this),this.node.on(JE.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(JE.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(JE.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(e){e.on(JE.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(JE.TOUCH_START,this._onTouchBegan,this),this.node.off(JE.TOUCH_MOVE,this._onTouchMove,this),this.node.off(JE.TOUCH_END,this._onTouchEnded,this),this.node.off(JE.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(JE.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(JE.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(e){e.off(JE.TRANSFORM_CHANGED)},n._getTargetSprite=function(e){var t=null;return e&&(t=e.getComponent(e5)),t},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new yi),yi.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(e){this._transition===Pee.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)},n._setCurrentStateSpriteFrame=function(e){if(e)switch(this._getButtonState()){case Oee.NORMAL:this._normalSprite=e;break;case Oee.HOVER:this._hoverSprite=e;break;case Oee.PRESSED:this._pressedSprite=e;break;case Oee.DISABLED:this._disabledSprite=e}},n._onTargetColorChanged=function(e){this._transition===Pee.COLOR&&this._setCurrentStateColor(e)},n._setCurrentStateColor=function(e){switch(this._getButtonState()){case Oee.NORMAL:this._normalColor=e;break;case Oee.HOVER:this._hoverColor=e;break;case Oee.PRESSED:this._pressedColor=e;break;case Oee.DISABLED:this._disabledColor=e}},n._onTargetTransformChanged=function(e){e&ig.SCALE&&this._originalScale&&this._transition===Pee.SCALE&&this._transitionFinished&&yi.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchMove=function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var n,i=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());this._transition===Pee.SCALE&&this.target&&this._originalScale?i?(yi.copy(this._fromScale,this._originalScale),yi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?Oee.PRESSED:Oee.NORMAL,this._applyTransition(n)),e&&(e.propagationStopped=!0)}}},n._onTouchEnded=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(KB.emitEvents(this.clickEvents,e),this.node.emit(Dee.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==Pee.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var e=this._getButtonState();this._applyTransition(e)},n._getButtonState=function(){var e=Oee.NORMAL;return this._interactable?this._pressed?e=Oee.PRESSED:this._hovered&&(e=Oee.HOVER):e=Oee.DISABLED,e.toString()},n._updateColorTransition=function(e){var t,n=this[e+"Color"],i=null===(t=this.target)||void 0===t?void 0:t.getComponent(n2);i&&(e===Oee.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)},n._updateScaleTransition=function(e){this._interactable&&(e===Oee.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(yi.copy(this._fromScale,this._originalScale),yi.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(yi.copy(this._fromScale,this.target.getScale()),yi.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(e){var t=this._transition;t===Pee.COLOR?this._updateColorTransition(e):t===Pee.SPRITE?this._updateSpriteTransition(e):t===Pee.SCALE&&this._updateScaleTransition(e)},L(t,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===Pee.COLOR?this._updateColorTransition(Oee.NORMAL):this._transition===Pee.SPRITE&&this._updateSpriteTransition(Oee.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(e5);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(oh),yee.Transition=Pee,yee.EventType=Dee,X((ree=See).prototype,"target",[P9,O9,D9],Object.getOwnPropertyDescriptor(ree.prototype,"target"),ree.prototype),X(ree.prototype,"interactable",[M9,N9],Object.getOwnPropertyDescriptor(ree.prototype,"interactable"),ree.prototype),X(ree.prototype,"transition",[L9,B9,F9],Object.getOwnPropertyDescriptor(ree.prototype,"transition"),ree.prototype),X(ree.prototype,"normalColor",[z9],Object.getOwnPropertyDescriptor(ree.prototype,"normalColor"),ree.prototype),X(ree.prototype,"pressedColor",[U9],Object.getOwnPropertyDescriptor(ree.prototype,"pressedColor"),ree.prototype),X(ree.prototype,"hoverColor",[k9],Object.getOwnPropertyDescriptor(ree.prototype,"hoverColor"),ree.prototype),X(ree.prototype,"disabledColor",[G9],Object.getOwnPropertyDescriptor(ree.prototype,"disabledColor"),ree.prototype),X(ree.prototype,"duration",[H9,V9,j9],Object.getOwnPropertyDescriptor(ree.prototype,"duration"),ree.prototype),X(ree.prototype,"zoomScale",[W9],Object.getOwnPropertyDescriptor(ree.prototype,"zoomScale"),ree.prototype),X(ree.prototype,"normalSprite",[q9,X9],Object.getOwnPropertyDescriptor(ree.prototype,"normalSprite"),ree.prototype),X(ree.prototype,"pressedSprite",[Y9,K9],Object.getOwnPropertyDescriptor(ree.prototype,"pressedSprite"),ree.prototype),X(ree.prototype,"hoverSprite",[Q9,Z9],Object.getOwnPropertyDescriptor(ree.prototype,"hoverSprite"),ree.prototype),X(ree.prototype,"disabledSprite",[J9,$9],Object.getOwnPropertyDescriptor(ree.prototype,"disabledSprite"),ree.prototype),oee=X(ree.prototype,"clickEvents",[eee,_l,tee,nee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),aee=X(ree.prototype,"_interactable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),see=X(ree.prototype,"_transition",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pee.NONE}}),cee=X(ree.prototype,"_normalColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.WHITE.clone()}}),lee=X(ree.prototype,"_hoverColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(211,211,211,255)}}),uee=X(ree.prototype,"_pressedColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.WHITE.clone()}}),hee=X(ree.prototype,"_disabledColor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vi(124,124,124,255)}}),fee=X(ree.prototype,"_normalSprite",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_ee=X(ree.prototype,"_hoverSprite",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pee=X(ree.prototype,"_pressedSprite",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dee=X(ree.prototype,"_disabledSprite",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mee=X(ree.prototype,"_duration",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),vee=X(ree.prototype,"_zoomScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),gee=X(ree.prototype,"_target",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iee=ree))||iee)||iee)||iee)||iee)||iee)||iee)),zee=function(){function e(){}return e.add=function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)},e.remove=function(e){var t=this._tabIndexList,n=t.indexOf(e);-1!==n&&t.splice(n,1)},e.resort=function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))},e.next=function(e){var t=this._tabIndexList,n=t.indexOf(e);if(e.setFocus(!1),-1!==n){var i=t[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},e}();zee._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(Nee||(Nee={})),Qe(Nee),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(Lee||(Lee={})),Qe(Lee),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(Bee||(Bee={})),Qe(Bee);var Uee,kee,Gee,Hee,Vee,jee,Wee,qee,Xee,Yee,Kee,Qee,Zee,Jee,$ee,ete,tte,nte,ite,rte,ote,ate,ste,cte,lte,ute,hte,fte,_te,pte,dte,mte,vte,gte,yte,Ste,xte,Tte,Ete,bte,Cte,Ate,wte,Rte,Ite,Pte,Ote,Dte,Mte,Nte,Lte,Bte,Fte,zte,Ute,kte,Gte,Hte,Vte,jte,Wte,qte=function(){function e(){this._editing=!1,this._delegate=null}var t=e.prototype;return t.init=function(){},t.onEnable=function(){},t.update=function(){},t.onDisable=function(){this._editing&&this.endEditing()},t.clear=function(){this._delegate=null},t.setTabIndex=function(){},t.setSize=function(){},t.setFocus=function(e){e?this.beginEditing():this.endEditing()},t.isFocused=function(){return this._editing},t.beginEditing=function(){},t.endEditing=function(){},e}(),Xte=new Ni,Yte=new Ni,Kte=new yi,Qte=null,Zte=0,Jte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._delegate=null,t._inputMode=-1,t._inputFlag=-1,t._returnType=-1,t.__eventListeners={},t.__autoResize=!1,t.__orientationChanged=void 0,t._edTxt=null,t._isTextArea=!1,t._textLabelFont=null,t._textLabelFontSize=null,t._textLabelFontColor=null,t._textLabelAlign=null,t._placeholderLabelFont=null,t._placeholderLabelFontSize=null,t._placeholderLabelFontColor=null,t._placeholderLabelAlign=null,t._placeholderLineHeight=null,t._placeholderStyleSheet=null,t._domId="EditBoxId_"+ ++Zte,t}F(t,e);var n=t.prototype;return n.init=function(e){e&&(this._delegate=e,e.inputMode===Lee.ANY?this._createTextArea():this._createInput(),zee.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),zee.remove(this),Qte===this&&(Qte=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(e){this._edTxt.tabIndex=e,zee.resort()},n.setSize=function(e,t){var n=this._edTxt;n&&(n.style.width=e+"px",n.style.height=t+"px")},n.beginEditing=function(){Qte&&Qte!==this&&Qte.setFocus(!1),this._editing=!0,Qte=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){i.GAME_VIEW&&this._edTxt?(i.gameView.container.appendChild(this._edTxt),i.gameView.head.appendChild(this._placeholderStyleSheet)):JM.container&&this._edTxt&&(JM.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(i.GAME_VIEW?lt(i.gameView.container,this._edTxt):lt(JM.container,this._edTxt))&&this._edTxt&&(i.GAME_VIEW?i.gameView.container.removeChild(this._edTxt):JM.container.removeChild(this._edTxt)),(i.GAME_VIEW?lt(i.gameView.head,this._placeholderStyleSheet):lt(document.head,this._placeholderStyleSheet))&&(i.GAME_VIEW?i.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),dh.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),dh.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){dh.os!==hn.ANDROID&&dh.os!==hn.OHOS||(fh.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){dh.os!==hn.ANDROID&&dh.os!==hn.OHOS||(fh.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){dh.browserType!==cn.WECHAT||dh.os!==hn.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var e=this._delegate.node,t=uN.getScaleX(),n=uN.getScaleY(),r=1,o=1;i.GAME_VIEW&&(r=i.gameView.canvas.width/i.game.canvas.width,o=i.gameView.canvas.height/i.game.canvas.height),t*=r,n*=o;var a=uN.getViewportRect(),s=fh.devicePixelRatio;e.getWorldMatrix(Xte);var c=e._uiProps.uiTransformComp;if(c&&yi.set(Kte,-c.anchorX*c.width,-c.anchorY*c.height,Kte.z),Ni.transform(Xte,Xte,Kte),e._uiProps.uiTransformComp){var l=eN.root.batcher2D.getFirstRenderCamera(e);if(l){l.node.getWorldRT(Yte);var u=Yte.m12,h=Yte.m13,f=iN.center;Yte.m12=f.x-(Yte.m00*u+Yte.m04*h),Yte.m13=f.y-(Yte.m01*u+Yte.m05*h),Ni.multiply(Yte,Yte,Xte),t/=s,n/=s;var _=i.GAME_VIEW?i.gameView.container:JM.container,p=Yte.m00*t,d=Xte.m01,m=Xte.m04,v=Yte.m05*n,g=parseInt(_&&_.style.paddingLeft||"0");g+=a.x*r/s;var y=parseInt(_&&_.style.paddingBottom||"0");y+=a.y/s;var S="matrix("+p+","+-d+","+-m+","+v+","+(Yte.m12*t+g)+","+-(Yte.m13*n+y)+")";this._edTxt.style.transform=S,this._edTxt.style["-webkit-transform"]=S,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var e=this._delegate,t=e.inputMode,n=e.inputFlag,i=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=t,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===Bee.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===Bee.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===Bee.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;t===Lee.EMAIL_ADDR?a="email":t===Lee.NUMERIC||t===Lee.DECIMAL?a="number":t===Lee.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):t===Lee.URL?a="url":(a="text",i===Nee.SEARCH&&(a="search")),r.type=a;var s="none";n===Bee.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===Bee.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e},n._initStyleSheet=function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))},n._updateTextLabel=function(e){if(e){var t=e.font;t=!t||t instanceof y$?e.fontFamily:t._fontFamily;var n=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==n||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=n,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=e.color.toCSS(),i.style.fontFamily=t,e.horizontalAlign){case a2.HorizontalAlign.LEFT:i.style.textAlign="left";break;case a2.HorizontalAlign.CENTER:i.style.textAlign="center";break;case a2.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(e){if(e){var t=e.font;t=!t||t instanceof y$?e.fontFamily:e.font._fontFamily;var n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,r=e.color.toCSS(),o=e.fontSize,a="";switch(e.horizontalAlign){case a2.HorizontalAlign.LEFT:a="left";break;case a2.HorizontalAlign.CENTER:a="center";break;case a2.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",dh.browserType===cn.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var e=this;if(this._edTxt){var t=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,e._delegate._editBoxTextChanged(t.value)},i.onInput=function(){if(!n){var i=e._delegate,r=i.maxLength;r>=0&&(t.value=t.value.slice(0,r)),i._editBoxTextChanged(t.value)}},i.onClick=function(){e._editing&&dh.isMobile&&e._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===rO.ENTER?(n.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):n.keyCode===rO.TAB&&(n.propagationStopped=!0,n.preventDefault(),zee.next(e))},i.onBlur=function(){dh.isMobile&&n&&i.compositionEnd(),e._editing=!1,Qte=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}},t}(qte);!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(Wte||(Wte={}));var $te,ene,tne,nne,ine,rne,one,ane,sne,cne,lne,une,hne,fne,_ne,pne,dne,mne,vne,gne,yne,Sne,xne,Tne,Ene,bne,Cne,Ane,wne,Rne,Ine,Pne,One,Dne,Mne,Nne,Lne,Bne,Fne,zne,Une,kne,Gne,Hne,Vne,jne,Wne,qne,Xne,Yne,Kne,Qne,Zne,Jne,$ne,eie,tie,nie,iie,rie,oie=function(t){return e({EditBox:t,EditBoxComponent:t}),t}((Uee=sl("cc.EditBox"),kee=El(),Gee=ll(110),Hee=yl(),Vee=cl(y0),jee=Nl(),Wee=Rl(),qee=Nl(),Xee=Rl(),Yee=Hl(a2),Kee=Nl(),Qee=Rl(),Zee=Hl(a2),Jee=Nl(),$ee=Rl(),ete=Hl(JJ),tte=Nl(),nte=Rl(),ite=Hl(Bee),rte=Nl(),ote=Rl(),ate=Hl(Lee),ste=Nl(),cte=Rl(),lte=Hl(Nee),ute=Nl(),hte=Rl(),fte=Nl(),_te=Rl(),pte=Nl(),dte=Rl(),mte=Hl([KB]),vte=Nl(),gte=Rl(),yte=Hl([KB]),Ste=Nl(),xte=Rl(),Tte=Hl([KB]),Ete=Nl(),bte=Rl(),Cte=Hl([KB]),Ate=Nl(),wte=Rl(),Uee(Rte=kee(Rte=Gee(Rte=Hee(Rte=Vee(Rte=gl((jte=Vte=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"editingDidBegan",Pte,V(t)),q(t,"textChanged",Ote,V(t)),q(t,"editingDidEnded",Dte,V(t)),q(t,"editingReturn",Mte,V(t)),t._impl=null,t._background=null,q(t,"_textLabel",Nte,V(t)),q(t,"_placeholderLabel",Lte,V(t)),q(t,"_returnType",Bte,V(t)),q(t,"_string",Fte,V(t)),q(t,"_tabIndex",zte,V(t)),q(t,"_backgroundImage",Ute,V(t)),q(t,"_inputFlag",kte,V(t)),q(t,"_inputMode",Gte,V(t)),q(t,"_maxLength",Hte,V(t)),t._isLabelVisible=!1,t}F(t,e);var n=t.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){KB.emitEvents(this.editingDidBegan,this),this.node.emit(Wte.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){KB.emitEvents(this.editingDidEnded,this),this.node.emit(Wte.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,KB.emitEvents(this.textChanged,e,this),this.node.emit(Wte.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){KB.emitEvents(this.editingReturn,this),this.node.emit(Wte.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(e){e.propagationStopped=!0},n._onTouchCancel=function(e){e.propagationStopped=!0},n._onTouchEnded=function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(JE.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var e=this.node.getComponent(e5);e||(e=this.node.addComponent(e5)),e!==this._background&&(e.type=e5.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||(t=new eA("TEXT_LABEL")),(e=t.getComponent(a2))||(e=t.addComponent(a2)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=a2.Overflow.CLAMP,this._inputMode===Lee.ANY?(e.verticalAlign=$1.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||(t=new eA("PLACEHOLDER_LABEL")),(e=t.getComponent(a2))||(e=t.addComponent(a2)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=a2.Overflow.CLAMP,this._inputMode===Lee.ANY?(e.verticalAlign=$1.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this.placeholder},n._syncSize=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=e.anchorPoint,n.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)},n._updateLabels=function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}},n._updateString=function(e){var t=this._textLabel;if(t){var n=e;n&&(n=this._updateLabelStringStyle(n)),t.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(e,t){void 0===t&&(t=!1);var n,i=this._inputFlag;if(t||i!==Bee.PASSWORD)i===Bee.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===Bee.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()})):i===Bee.INITIAL_CAPS_SENTENCE&&(e=(n=e).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=e.length,a=0;a<o;++a)r+="";e=r}return e},n._registerEvent=function(){this.node.on(JE.TOUCH_START,this._onTouchBegan,this),this.node.on(JE.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(JE.TOUCH_START,this._onTouchBegan,this),this.node.off(JE.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.on(e5.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.off(e5.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=-t.anchorX*t.width,i=-t.anchorY*t.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),o.node.setPosition(n+2,i+e.height,o.node.position.z),this._inputMode===Lee.ANY&&(o.verticalAlign=$1.TOP),o.enableWrapText=this._inputMode===Lee.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(n+2,i+e.height,r.node.position.z),this._inputMode===Lee.ANY&&(r.verticalAlign=$1.TOP),r.enableWrapText=this._inputMode===Lee.ANY)},n._resizeChildNodes=function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-e.width/2,e.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(e.contentSize)},L(t,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(oh),Vte._EditBoxImpl=qte,Vte.KeyboardReturnType=Nee,Vte.InputFlag=Bee,Vte.InputMode=Lee,Vte.EventType=Wte,X((Ite=jte).prototype,"string",[jee,Wee],Object.getOwnPropertyDescriptor(Ite.prototype,"string"),Ite.prototype),X(Ite.prototype,"placeholder",[qee,Xee],Object.getOwnPropertyDescriptor(Ite.prototype,"placeholder"),Ite.prototype),X(Ite.prototype,"textLabel",[Yee,Kee,Qee],Object.getOwnPropertyDescriptor(Ite.prototype,"textLabel"),Ite.prototype),X(Ite.prototype,"placeholderLabel",[Zee,Jee,$ee],Object.getOwnPropertyDescriptor(Ite.prototype,"placeholderLabel"),Ite.prototype),X(Ite.prototype,"backgroundImage",[ete,tte,nte],Object.getOwnPropertyDescriptor(Ite.prototype,"backgroundImage"),Ite.prototype),X(Ite.prototype,"inputFlag",[ite,rte,ote],Object.getOwnPropertyDescriptor(Ite.prototype,"inputFlag"),Ite.prototype),X(Ite.prototype,"inputMode",[ate,ste,cte],Object.getOwnPropertyDescriptor(Ite.prototype,"inputMode"),Ite.prototype),X(Ite.prototype,"returnType",[lte,ute,hte],Object.getOwnPropertyDescriptor(Ite.prototype,"returnType"),Ite.prototype),X(Ite.prototype,"maxLength",[fte,_te],Object.getOwnPropertyDescriptor(Ite.prototype,"maxLength"),Ite.prototype),X(Ite.prototype,"tabIndex",[pte,dte],Object.getOwnPropertyDescriptor(Ite.prototype,"tabIndex"),Ite.prototype),Pte=X(Ite.prototype,"editingDidBegan",[mte,_l,vte,gte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ote=X(Ite.prototype,"textChanged",[yte,_l,Ste,xte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dte=X(Ite.prototype,"editingDidEnded",[Tte,_l,Ete,bte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mte=X(Ite.prototype,"editingReturn",[Cte,_l,Ate,wte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nte=X(Ite.prototype,"_textLabel",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lte=X(Ite.prototype,"_placeholderLabel",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bte=X(Ite.prototype,"_returnType",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nee.DEFAULT}}),Fte=X(Ite.prototype,"_string",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zte=X(Ite.prototype,"_tabIndex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ute=X(Ite.prototype,"_backgroundImage",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kte=X(Ite.prototype,"_inputFlag",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bee.DEFAULT}}),Gte=X(Ite.prototype,"_inputMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lee.ANY}}),Hte=X(Ite.prototype,"_maxLength",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),Rte=Ite))||Rte)||Rte)||Rte)||Rte)||Rte)||Rte));"object"==typeof window&&"object"==typeof document&&(oie._EditBoxImpl=Jte),function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}($ne||($ne={})),$e($ne),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(eie||(eie={})),$e(eie),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(tie||(tie={})),$e(tie),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(nie||(nie={})),$e(nie),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(iie||(iie={})),$e(iie),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(rie||(rie={})),$e(rie);var aie,sie,cie,lie,uie,hie,fie,_ie,pie,die,mie,vie,gie,yie,Sie,xie,Tie,Eie,bie,Cie,Aie,wie,Rie,Iie=new yi,Pie=function(t){return e({Layout:t,LayoutComponent:t}),t}(($te=sl("cc.Layout"),ene=El(),tne=ll(110),nne=yl(),ine=cl(y0),rne=Cl(),one=Rl(),ane=Cl(),sne=Rl(),cne=Hl($ne),lne=Rl(),une=Hl(eie),hne=Cl(),fne=Rl(),_ne=Cl(),pne=Rl(),dne=Hl(tie),mne=Rl(),vne=Rl(),gne=Rl(),yne=Rl(),Sne=Rl(),xne=Rl(),Tne=Rl(),Ene=Hl(nie),bne=Rl(),Cne=Hl(iie),Ane=Rl(),wne=Hl(rie),Rne=Cl(),Ine=Rl(),Pne=Cl(),One=Rl(),Dne=Rl(),$te(Mne=ene(Mne=tne(Mne=nne(Mne=ine(Mne=gl((Jne=Zne=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_resizeMode",Lne,V(t)),q(t,"_layoutType",Bne,V(t)),q(t,"_cellSize",Fne,V(t)),q(t,"_startAxis",zne,V(t)),q(t,"_paddingLeft",Une,V(t)),q(t,"_paddingRight",kne,V(t)),q(t,"_paddingTop",Gne,V(t)),q(t,"_paddingBottom",Hne,V(t)),q(t,"_spacingX",Vne,V(t)),q(t,"_spacingY",jne,V(t)),q(t,"_verticalDirection",Wne,V(t)),q(t,"_horizontalDirection",qne,V(t)),q(t,"_constraint",Xne,V(t)),q(t,"_constraintNum",Yne,V(t)),q(t,"_affectedByScale",Kne,V(t)),q(t,"_isAlign",Qne,V(t)),t._layoutSize=new Wi(300,200),t._layoutDirty=!0,t._childrenDirty=!1,t._usefulLayoutObj=[],t._init=!1,t}F(t,e);var n=t.prototype;return n.updateLayout=function(e){void 0===e&&(e=!1),(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(Wi.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){eN.on($M.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(JE.SIZE_CHANGED,this._resized,this),this.node.on(JE.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(JE.CHILD_ADDED,this._childAdded,this),this.node.on(JE.CHILD_REMOVED,this._childRemoved,this),this.node.on(JE.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){eN.off($M.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(JE.SIZE_CHANGED,this._resized,this),this.node.off(JE.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(JE.CHILD_ADDED,this._childAdded,this),this.node.off(JE.CHILD_REMOVED,this._childRemoved,this),this.node.off(JE.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.on(JE.SIZE_CHANGED,this._doLayoutDirty,this),n.on(JE.TRANSFORM_CHANGED,this._transformDirty,this),n.on(JE.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(JE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.off(JE.SIZE_CHANGED,this._doLayoutDirty,this),n.off(JE.TRANSFORM_CHANGED,this._transformDirty,this),n.off(JE.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(JE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(e){e.on(JE.SIZE_CHANGED,this._doLayoutDirty,this),e.on(JE.TRANSFORM_CHANGED,this._transformDirty,this),e.on(JE.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on(JE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(e){e.off(JE.SIZE_CHANGED,this._doLayoutDirty,this),e.off(JE.TRANSFORM_CHANGED,this._transformDirty,this),e.off(JE.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off(JE.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===iie.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*e+a*s,l=c-a*this._spacingX,u=0,h=0,f=0,_=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==$ne.GRID&&this._resizeMode===eie.CHILDREN&&(m=(e-v-(d-1)*this._spacingX)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var S=g[y],x=S.node,T=x.scale,E=this._getUsedScaleValue(T.x),b=this._getUsedScaleValue(T.y);this._resizeMode===eie.CHILDREN&&(S.width=m/E,this._layoutType===$ne.GRID&&(S.height=this._cellSize.height/b));var C=Math.abs(this._horizontalDirection-S.anchorX),A=S.width*E,w=S.height*b;w>f&&(_=Math.max(f,_),h=f||w,f=w),l+=a*(C*A+this._spacingX);var R=a*(1-C)*A;if(t){if(o>0)(p=y/o>0&&y%o==0)&&(h=f>w?f:h);else if(A>e-v)l>c+a*C*A&&(p=!0);else{var I=(1-this._horizontalDirection-r.x)*e,P=l+R+a*(a>0?this._paddingRight:this._paddingLeft);p=Math.abs(P)>Math.abs(I)}p&&(l=c+a*C*A,w!==f&&(h=f),u+=h+this._spacingY,h=f=w)}var O=n(x,S,u);i&&x.setPosition(l,O),l+=R}return h=Math.max(h,f),Math.max(_,u+h)+this._getPaddingV()},n._doLayoutVertically=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===nie.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*e+a*s,l=c-a*this._spacingY,u=0,h=0,f=0,_=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==$ne.GRID&&this._resizeMode===eie.CHILDREN&&(m=(e-v-(d-1)*this._spacingY)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var S=g[y],x=S.node,T=x.scale,E=this._getUsedScaleValue(T.x),b=this._getUsedScaleValue(T.y);this._resizeMode===eie.CHILDREN&&(S.height=m/b,this._layoutType===$ne.GRID&&(S.width=this._cellSize.width/E));var C=Math.abs(this._verticalDirection-S.anchorY),A=S.width*E,w=S.height*b;A>u&&(h=Math.max(u,h),f=u||A,u=A),l+=a*(C*w+this._spacingY);var R=a*(1-C)*w;if(t){if(o>0)(p=y/o>0&&y%o==0)&&(f=u>w?u:f);else if(w>e-v)l>c+a*C*w&&(p=!0);else{var I=(1-this._verticalDirection-r.y)*e,P=l+R+a*(a>0?this._paddingTop:this._paddingBottom);p=Math.abs(P)>Math.abs(I)}p&&(l=c+a*C*w,A!==u&&(f=u),_+=f+this._spacingX,f=u=A)}var O=n(x,S,_);i&&(x.getPosition(Iie),x.setPosition(O,l,Iie.z)),l+=R}return f=Math.max(f,u),Math.max(h,_+f)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(e,t){var n=this,i=t.width,r=1,o=-e.y*t.height,a=this._paddingBottom;this._verticalDirection===nie.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*t.height,a=this._paddingTop);var s=function(e,t,i){return o+r*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+a)},c=0;this._resizeMode===eie.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-e.y*c,this._verticalDirection===nie.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===eie.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(e,t){var n=this,i=t.height,r=1,o=-e.x*t.width,a=this._paddingLeft;this._horizontalDirection===iie.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*t.width,a=this._paddingRight);var s=function(e,t,i){return o+r*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+a)},c=0;this._resizeMode===eie.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-e.x*c,this._horizontalDirection===iie.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===eie.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,n=e.contentSize;this.startAxis===tie.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,n):this.startAxis===tie.VERTICAL&&this._doLayoutGridAxisVertical(t,n)},n._getHorizontalBaseWidth=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===eie.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.width*this._getUsedScaleValue(o.x)}t+=(n-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t},n._getVerticalBaseHeight=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===eie.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.height*this._getUsedScaleValue(o.y)}t+=(n-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t},n._doLayout=function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===$ne.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?yi.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===$ne.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(t){return(e._isAlign?yi.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===$ne.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(e){return this._affectedByScale?Math.abs(e):1},n._transformDirty=function(e){e&ig.SCALE&&e&ig.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==$ne.GRID||this._constraint===rie.NONE||this._constraintNum<=0)return 0;var e=this._constraint===rie.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===tie.VERTICAL&&(e=this._constraint===rie.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e},L(t,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===$ne.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===$ne.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==$ne.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==$ne.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==rie.NONE&&this._constraintNum!==e&&(e<=0&&p("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(oh),Zne.Type=$ne,Zne.VerticalDirection=nie,Zne.HorizontalDirection=iie,Zne.ResizeMode=eie,Zne.AxisDirection=tie,Zne.Constraint=rie,X((Nne=Jne).prototype,"alignHorizontal",[rne,one],Object.getOwnPropertyDescriptor(Nne.prototype,"alignHorizontal"),Nne.prototype),X(Nne.prototype,"alignVertical",[ane,sne],Object.getOwnPropertyDescriptor(Nne.prototype,"alignVertical"),Nne.prototype),X(Nne.prototype,"type",[cne,lne],Object.getOwnPropertyDescriptor(Nne.prototype,"type"),Nne.prototype),X(Nne.prototype,"resizeMode",[une,hne,fne],Object.getOwnPropertyDescriptor(Nne.prototype,"resizeMode"),Nne.prototype),X(Nne.prototype,"cellSize",[_ne,pne],Object.getOwnPropertyDescriptor(Nne.prototype,"cellSize"),Nne.prototype),X(Nne.prototype,"startAxis",[dne,mne],Object.getOwnPropertyDescriptor(Nne.prototype,"startAxis"),Nne.prototype),X(Nne.prototype,"paddingLeft",[vne],Object.getOwnPropertyDescriptor(Nne.prototype,"paddingLeft"),Nne.prototype),X(Nne.prototype,"paddingRight",[gne],Object.getOwnPropertyDescriptor(Nne.prototype,"paddingRight"),Nne.prototype),X(Nne.prototype,"paddingTop",[yne],Object.getOwnPropertyDescriptor(Nne.prototype,"paddingTop"),Nne.prototype),X(Nne.prototype,"paddingBottom",[Sne],Object.getOwnPropertyDescriptor(Nne.prototype,"paddingBottom"),Nne.prototype),X(Nne.prototype,"spacingX",[xne],Object.getOwnPropertyDescriptor(Nne.prototype,"spacingX"),Nne.prototype),X(Nne.prototype,"spacingY",[Tne],Object.getOwnPropertyDescriptor(Nne.prototype,"spacingY"),Nne.prototype),X(Nne.prototype,"verticalDirection",[Ene,bne],Object.getOwnPropertyDescriptor(Nne.prototype,"verticalDirection"),Nne.prototype),X(Nne.prototype,"horizontalDirection",[Cne,Ane],Object.getOwnPropertyDescriptor(Nne.prototype,"horizontalDirection"),Nne.prototype),X(Nne.prototype,"constraint",[wne,Rne,Ine],Object.getOwnPropertyDescriptor(Nne.prototype,"constraint"),Nne.prototype),X(Nne.prototype,"constraintNum",[Pne,One],Object.getOwnPropertyDescriptor(Nne.prototype,"constraintNum"),Nne.prototype),X(Nne.prototype,"affectedByScale",[Dne],Object.getOwnPropertyDescriptor(Nne.prototype,"affectedByScale"),Nne.prototype),Lne=X(Nne.prototype,"_resizeMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eie.NONE}}),Bne=X(Nne.prototype,"_layoutType",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $ne.NONE}}),Fne=X(Nne.prototype,"_cellSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wi(40,40)}}),zne=X(Nne.prototype,"_startAxis",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tie.HORIZONTAL}}),Une=X(Nne.prototype,"_paddingLeft",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kne=X(Nne.prototype,"_paddingRight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gne=X(Nne.prototype,"_paddingTop",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hne=X(Nne.prototype,"_paddingBottom",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vne=X(Nne.prototype,"_spacingX",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jne=X(Nne.prototype,"_spacingY",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wne=X(Nne.prototype,"_verticalDirection",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nie.TOP_TO_BOTTOM}}),qne=X(Nne.prototype,"_horizontalDirection",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iie.LEFT_TO_RIGHT}}),Xne=X(Nne.prototype,"_constraint",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rie.NONE}}),Yne=X(Nne.prototype,"_constraintNum",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Kne=X(Nne.prototype,"_affectedByScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qne=X(Nne.prototype,"_isAlign",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mne=Nne))||Mne)||Mne)||Mne)||Mne)||Mne)||Mne));!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(Rie||(Rie={})),Qe(Rie);var Oie,Die,Mie,Nie,Lie,Bie,Fie,zie,Uie,kie,Gie,Hie,Vie,jie,Wie,qie,Xie,Yie,Kie,Qie,Zie,Jie,$ie,ere,tre,nre=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((aie=sl("cc.ProgressBar"),sie=El(),cie=ll(110),lie=yl(),uie=cl(y0),hie=Hl(e5),fie=Rl(),_ie=Hl(Rie),pie=Rl(),die=Rl(),mie=Il(),vie=Rl(),gie=Rl(),aie(yie=sie(yie=cie(yie=lie(yie=uie((wie=Aie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_barSprite",xie,V(t)),q(t,"_mode",Tie,V(t)),q(t,"_totalLength",Eie,V(t)),q(t,"_progress",bie,V(t)),q(t,"_reverse",Cie,V(t)),t}F(t,e);var n=t.prototype;return n._initBarSprite=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===e5.FillType.RADIAL&&(this._mode=Rie.FILLED),this._mode===Rie.HORIZONTAL?this.totalLength=r.width:this._mode===Rie.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var o=-n.width*i.x;e.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,n=t.anchorPoint,i=t.contentSize,r=e.getPosition(),o=new zi(0,.5),a=$n(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case Rie.HORIZONTAL:this._reverse&&(o=new zi(1,.5)),c=new Wi(s,i.height),l=this._totalLength,u=i.height;break;case Rie.VERTICAL:o=this._reverse?new zi(.5,1):new zi(.5,0),c=new Wi(i.width,s),l=i.width,u=this._totalLength}if(this._mode===Rie.FILLED)this._barSprite.type!==e5.Type.FILLED?p("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==e5.Type.FILLED){var h=o.x-n.x,f=o.y-n.y,_=new yi(l*h,u*f,0);e.setPosition(r.x+_.x,r.y+_.y,r.z),t.setAnchorPoint(o),t.setContentSize(c)}else p("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},L(t,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var n=t._uiProps.uiTransformComp.contentSize;this._mode===Rie.HORIZONTAL?this.totalLength=n.width:this._mode===Rie.VERTICAL?this.totalLength=n.height:this._mode===Rie.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===Rie.FILLED&&(e=$n(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(oh),Aie.Mode=Rie,X((Sie=wie).prototype,"barSprite",[hie,fie],Object.getOwnPropertyDescriptor(Sie.prototype,"barSprite"),Sie.prototype),X(Sie.prototype,"mode",[_ie,pie],Object.getOwnPropertyDescriptor(Sie.prototype,"mode"),Sie.prototype),X(Sie.prototype,"totalLength",[die],Object.getOwnPropertyDescriptor(Sie.prototype,"totalLength"),Sie.prototype),X(Sie.prototype,"progress",[mie,Ml,vie],Object.getOwnPropertyDescriptor(Sie.prototype,"progress"),Sie.prototype),X(Sie.prototype,"reverse",[gie],Object.getOwnPropertyDescriptor(Sie.prototype,"reverse"),Sie.prototype),xie=X(Sie.prototype,"_barSprite",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tie=X(Sie.prototype,"_mode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rie.HORIZONTAL}}),Eie=X(Sie.prototype,"_totalLength",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bie=X(Sie.prototype,"_progress",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Cie=X(Sie.prototype,"_reverse",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yie=Sie))||yie)||yie)||yie)||yie)||yie)),ire=new yi,rre=new yi,ore=new yi,are=new zi,sre=new vi,cre=new zi;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(tre||(tre={})),$e(tre);var lre,ure,hre,fre,_re,pre,dre,mre,vre,gre,yre,Sre,xre,Tre,Ere,bre,Cre,Are,wre,Rre,Ire,Pre,Ore,Dre,Mre,Nre,Lre,Bre,Fre,zre,Ure,kre,Gre,Hre,Vre,jre,Wre,qre,Xre,Yre,Kre,Qre,Zre,Jre,$re,eoe,toe,noe,ioe,roe=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((Oie=sl("cc.ScrollBar"),Die=El(),Mie=ll(110),Nie=yl(),Lie=cl(y0),Bie=Hl(e5),Fie=Nl(),zie=Rl(),Uie=Hl(tre),kie=Nl(),Gie=Rl(),Hie=Nl(),Vie=Rl(),jie=Nl(),Wie=Rl(),Oie(qie=Die(qie=Mie(qie=Nie(qie=Lie((ere=$ie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_scrollView",Yie,V(t)),q(t,"_handle",Kie,V(t)),q(t,"_direction",Qie,V(t)),q(t,"_enableAutoHide",Zie,V(t)),q(t,"_autoHideTime",Jie,V(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}F(t,e);var n=t.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var n=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=cre;u.set(0,0),this._direction===tre.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=e.x,this._convertToScrollViewSpace(u,t),c=-u.x):this._direction===tre.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=e.y,this._convertToScrollViewSpace(u,t),c=-u.y);var h=this._calculateLength(o,a,l,s),f=cre;this._calculatePosition(f,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(f)}}}},n.setScrollView=function(e){this._scrollView=e},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var e=this.node.getComponent(e5);e&&(this._opacity=e.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(e){this._processAutoHide(e)},n._convertToScrollViewSpace=function(e,t){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp;if(n&&i){ire.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(ire,rre);var r=n.convertToNodeSpaceAR(rre);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,e.set(r.x,r.y)}else e.set(zi.ZERO)},n._setOpacity=function(e){if(this._handle){var t=this.node.getComponent(e5);t&&(sre.set(t.color),sre.a=e,t.color=sre),(t=this._handle.getComponent(e5))&&(sre.set(t.color),sre.a=e,t.color=sre)}},n._updateHandlerPosition=function(e){if(this._handle){var t=ore;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}},n._fixupHandlerPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;yi.set(ire,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(ire,rre),s=e;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===tre.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===tre.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(e,t){return e.width<=t.width&&this._direction===tre.HORIZONTAL||e.height<=t.height&&this._direction===tre.VERTICAL},n._calculateLength=function(e,t,n,i){var r=e;return i&&(r+=20*(i>0?i:-i)),n*(t/r)},n._calculatePosition=function(e,t,n,i,r,o,a){var s=t-n;o&&(s+=Math.abs(o));var c=0;s&&(c=$n(c=r/s));var l=(i-a)*c;this._direction===tre.VERTICAL?e.set(0,l):e.set(l,0)},n._updateLength=function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint;i.x===are.x&&i.y===are.y||t.setAnchorPoint(are),this._direction===tre.HORIZONTAL?t.setContentSize(e,n.height):t.setContentSize(n.width,e)}},n._processAutoHide=function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}},L(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(zi.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(zi.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(oh),$ie.Direction=tre,X((Xie=ere).prototype,"handle",[Bie,Fie,zie],Object.getOwnPropertyDescriptor(Xie.prototype,"handle"),Xie.prototype),X(Xie.prototype,"direction",[Uie,kie,Gie],Object.getOwnPropertyDescriptor(Xie.prototype,"direction"),Xie.prototype),X(Xie.prototype,"enableAutoHide",[Hie,Vie],Object.getOwnPropertyDescriptor(Xie.prototype,"enableAutoHide"),Xie.prototype),X(Xie.prototype,"autoHideTime",[jie,Wie],Object.getOwnPropertyDescriptor(Xie.prototype,"autoHideTime"),Xie.prototype),Yie=X(Xie.prototype,"_scrollView",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kie=X(Xie.prototype,"_handle",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qie=X(Xie.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tre.HORIZONTAL}}),Zie=X(Xie.prototype,"_enableAutoHide",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jie=X(Xie.prototype,"_autoHideTime",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qie=Xie))||qie)||qie)||qie)||qie)||qie)),ooe=e("ViewGroup",sl("cc.ViewGroup")(lre=ll(110)(lre=function(e){function t(){return e.apply(this,arguments)||this}return F(t,e),t}(oh))||lre)||lre);i.ViewGroup=ooe;var aoe,soe=1e-4,coe=new yi,loe=new yi,uoe=new zi,hoe=new zi,foe=function(){return(new Date).getMilliseconds()},_oe={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(aoe||(aoe={}));var poe,doe,moe,voe,goe,yoe,Soe,xoe,Toe,Eoe,boe,Coe,Aoe,woe,Roe,Ioe,Poe,Ooe,Doe,Moe,Noe,Loe,Boe=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((ure=sl("cc.ScrollView"),hre=El(),fre=ll(110),_re=yl(),pre=cl(y0),dre=Il(),mre=Nl(),vre=Rl(),gre=Il(),yre=Nl(),Sre=Rl(),xre=Nl(),Tre=Rl(),Ere=Nl(),bre=Rl(),Cre=Hl(eA),Are=Nl(),wre=Rl(),Rre=Nl(),Ire=Rl(),Pre=Hl(roe),Ore=Nl(),Dre=Rl(),Mre=Nl(),Nre=Rl(),Lre=Hl(roe),Bre=Nl(),Fre=Rl(),zre=Nl(),Ure=Rl(),kre=Hl([KB]),Gre=Nl(),Hre=Rl(),ure(Vre=hre(Vre=fre(Vre=_re(Vre=pre((ioe=noe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"bounceDuration",Wre,V(t)),q(t,"brake",qre,V(t)),q(t,"elastic",Xre,V(t)),q(t,"inertia",Yre,V(t)),q(t,"horizontal",Kre,V(t)),q(t,"vertical",Qre,V(t)),q(t,"cancelInnerEvents",Zre,V(t)),q(t,"scrollEvents",Jre,V(t)),t._autoScrolling=!1,t._scrolling=!1,q(t,"_content",$re,V(t)),q(t,"_horizontalScrollBar",eoe,V(t)),q(t,"_verticalScrollBar",toe,V(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new yi,t._autoScrollTargetDelta=new yi,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new yi,t._outOfBoundaryAmount=new yi,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new yi,t._deltaPos=new yi,t}F(t,e);var n=t.prototype;return n.scrollToBottom=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new zi(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n,!0)},n.scrollToTop=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new zi(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new zi(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new zi(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new zi(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new zi(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new zi(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new zi(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToOffset=function(e,t,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new zi(0,0);0===i.x?r.x=0:r.x=e.x/i.x,0===i.y?r.y=1:r.y=(i.y-e.y)/i.y,this.scrollTo(r,t,n)},n.getScrollOffset=function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new zi(t,e)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return zi.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,n=e.height-this.view.height;return new zi(t=t>=0?t:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new zi(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==n):this._moveContent(i)},n.scrollTo=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new zi(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.scrollToPercentVertical=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new zi(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(e){this._setContentPosition(e)},n._setContentPosition=function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<soe&&Math.abs(e.y-t.y)<soe||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):yi.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return soe},n.start=function(){this._calculateBoundary(),this._content&&eN.once($M.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(JE.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(JE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(JE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(JE.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(e){this._autoScrolling&&this._processAutoScrolling(e)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(JE.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(JE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(JE.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(JE.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(JE.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(JE.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(JE.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(JE.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(JE.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(JE.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(JE.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(JE.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(JE.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(JE.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var n=new yi,i=e.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}},n._onTouchBegan=function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))},n._onTouchMoved=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var n=e.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(uoe);if(i.subtract(n.getUIStartLocation(hoe)),i.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new iO(e.getTouches(),e.bubbles,YA.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}},n._onTouchEnded=function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(aoe.TOUCH_UP);var n=e.touch;this._handleReleaseLogic(n),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}},n._onTouchCancelled=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var n=e.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(e)}},n._calculateBoundary=function(){if(this._content&&this.view){var e=this._content.getComponent(Pie);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,n=t.width*t.anchorX,i=t.height*t.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}},n._hasNestedViewGroup=function(e,t){if(!e||e.eventPhase!==JP.CAPTURING_PHASE)return!1;if(t)for(var n,i=W(t);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!e.target||!e.target.getComponent(ooe));if(r.getComponent(ooe))return!0}return!1},n._startInertiaScroll=function(e){var t=new yi(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)},n._calculateAttenuatedFactor=function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))},n._startAttenuatingAutoScroll=function(e,t){var n=e.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=e.length(),u=n.length()/l;if(n.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=e.clone();h.multiplyScalar(u),n.set(h),n.add(e)}var f=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(f*=u=3),0===this.brake&&u>1&&(f*=u),this._startAutoScroll(n,f,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(e){return Math.sqrt(Math.sqrt(e/5))},n._startAutoScroll=function(e,t,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,yi.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(yi.ZERO,soe)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var e=new yi,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(yi.ZERO);else{var n=new yi;n=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),n),e.set(n.x*(1-this.brake)/t,n.y*(1-this.brake)/t,n.z)}return e},n._flattenVectorByDirection=function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t},n._moveContent=function(e,t){var n=this._flattenVectorByDirection(e);coe.set(this._getContentPosition()),coe.add(n),coe.set(Math.round(1e4*coe.x)*soe,Math.round(1e4*coe.y)*soe,coe.z),this._setContentPosition(coe);var i=this._getHowMuchOutOfBoundary();uoe.set(i.x,i.y),this._updateScrollBar(uoe),this.elastic&&t&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height},n._getHowMuchOutOfBoundary=function(e){if((e=e||new yi).equals(yi.ZERO,soe)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new yi,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+e.x>this._leftBoundary?t.x=this._leftBoundary-(n+e.x):i+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(i+e.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+e.y<this._topBoundary?t.y=this._topBoundary-(r+e.y):o+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(o+e.y)),e.equals(yi.ZERO,soe)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t},n._updateScrollBar=function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(e){if(e===aoe.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===aoe.SCROLL_TO_TOP||e===aoe.SCROLL_TO_BOTTOM||e===aoe.SCROLL_TO_LEFT||e===aoe.SCROLL_TO_RIGHT){var t=1<<_oe[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}KB.emitEvents(this.scrollEvents,this,_oe[e]),this.node.emit(e,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();coe.set(this._getContentPosition()),coe.add(e),this._content.setPosition(coe),this._updateScrollBar(zi.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(e){e.eventPhase===JP.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)},n._processDeltaMove=function(e){this._scrollChildren(e),this._gatherTouchMove(e)},n._handleMoveLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(aoe.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(e,t){var n=this.node._uiProps.uiTransformComp,i=new yi;n&&(t.getUILocation(uoe),t.getUIPreviousLocation(hoe),coe.set(uoe.x,uoe.y,0),loe.set(hoe.x,hoe.y,0),n.convertToNodeSpaceAR(coe,coe),n.convertToNodeSpaceAR(loe,loe),yi.subtract(i,coe,loe)),e.set(i)},n._scrollChildren=function(e){this._clampDelta(e);var t,n=e;this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||yi.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=aoe.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=aoe.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=aoe.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=aoe.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(aoe.SCROLL_BEGAN)),this._dispatchEvent(aoe.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(aoe.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=foe(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(e){if(this._content&&this.view){var t=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<t.width&&(e.x=0),n.height<t.height&&(e.y=0)}},n._gatherTouchMove=function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var n=foe();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(yi.ZERO,soe))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(aoe.BOUNCE_TOP),e.y<0&&this._dispatchEvent(aoe.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(aoe.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(aoe.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(coe,soe)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(yi.ZERO,soe)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(e){var t=this._isNecessaryAutoScrollBrake(),n=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=soe;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(aoe.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),t&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(yi.ZERO,soe)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(aoe.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(aoe.SCROLL_ENDED))},n._checkMouseWheel=function(e){if(!this._getHowMuchOutOfBoundary().equals(yi.ZERO,soe))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(aoe.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(aoe.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(e){var t=e.anchor,n=e.applyToHorizontal,i=e.applyToVertical;this._calculateBoundary(),t.clampf(zi.ZERO,zi.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new yi;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*t.x),i&&(s=c.height-l.height,a.y=r-s*t.y)}return a},n._moveContentToTopLeft=function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var n=new yi,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<e.height&&(i=o.height-e.height,n.y=t-i),o.width<e.width&&(i=o.width-e.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(e){e===ig.SCALE&&this._calculateBoundary()},L(t,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):T(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(zi.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(zi.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),t}(ooe),noe.EventType=aoe,Wre=X((jre=ioe).prototype,"bounceDuration",[_l,dre,mre,vre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qre=X(jre.prototype,"brake",[_l,gre,yre,Sre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Xre=X(jre.prototype,"elastic",[_l,xre,Tre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yre=X(jre.prototype,"inertia",[_l,Ere,bre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(jre.prototype,"content",[Cre,Are,wre],Object.getOwnPropertyDescriptor(jre.prototype,"content"),jre.prototype),Kre=X(jre.prototype,"horizontal",[_l,Rre,Ire],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(jre.prototype,"horizontalScrollBar",[Pre,Ore,Dre],Object.getOwnPropertyDescriptor(jre.prototype,"horizontalScrollBar"),jre.prototype),Qre=X(jre.prototype,"vertical",[_l,Mre,Nre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(jre.prototype,"verticalScrollBar",[Lre,Bre,Fre],Object.getOwnPropertyDescriptor(jre.prototype,"verticalScrollBar"),jre.prototype),Zre=X(jre.prototype,"cancelInnerEvents",[_l,zre,Ure],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Jre=X(jre.prototype,"scrollEvents",[kre,_l,Gre,Hre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$re=X(jre.prototype,"_content",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eoe=X(jre.prototype,"_horizontalScrollBar",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),toe=X(jre.prototype,"_verticalScrollBar",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vre=jre))||Vre)||Vre)||Vre)||Vre)||Vre)),Foe=new yi;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Loe||(Loe={})),$e(Loe);var zoe,Uoe,koe,Goe,Hoe,Voe,joe,Woe,qoe,Xoe,Yoe,Koe,Qoe,Zoe,Joe,$oe,eae,tae,nae,iae,rae=function(t){return e({Slider:t,SliderComponent:t}),t}((poe=sl("cc.Slider"),doe=El(),moe=ll(110),voe=yl(),goe=cl(y0),yoe=Hl(e5),Soe=Rl(),xoe=Hl(Loe),Toe=Rl(),Eoe=Il(),boe=Rl(),Coe=Hl([KB]),Aoe=Rl(),poe(woe=doe(woe=moe(woe=voe(woe=goe((Noe=Moe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"slideEvents",Ioe,V(t)),q(t,"_handle",Poe,V(t)),q(t,"_direction",Ooe,V(t)),q(t,"_progress",Doe,V(t)),t._offset=new yi,t._dragging=!1,t._touchHandle=!1,t._handleLocalPos=new yi,t._touchPos=new yi,t}F(t,e);var n=t.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(JE.TOUCH_START,this._onTouchBegan,this),this.node.on(JE.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(JE.TOUCH_END,this._onTouchEnded,this),this.node.on(JE.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(JE.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(JE.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(JE.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(JE.TOUCH_START,this._onTouchBegan,this),this.node.off(JE.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(JE.TOUCH_END,this._onTouchEnded,this),this.node.off(JE.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(JE.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(JE.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(JE.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();yi.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}},n._onTouchBegan=function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchMoved=function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchEnded=function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new yi,e&&(e.propagationStopped=!0)},n._onTouchCancelled=function(e){this._dragging=!1,e&&(e.propagationStopped=!0)},n._handleSliderLogic=function(e){this._updateProgress(e),this._emitSlideEvent()},n._emitSlideEvent=function(){KB.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(e){if(this._handle&&e){var t=e.getUILocation();yi.set(this._touchPos,t.x,t.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,Foe);this.direction===Loe.Horizontal?this.progress=$n(.5+(i.x-this._offset.x)/n.width):this.progress=$n(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===Loe.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var n=this._handle.node.position;this._direction===Loe.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},L(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(oh),Moe.Direction=Loe,X((Roe=Noe).prototype,"handle",[yoe,Soe],Object.getOwnPropertyDescriptor(Roe.prototype,"handle"),Roe.prototype),X(Roe.prototype,"direction",[xoe,Toe],Object.getOwnPropertyDescriptor(Roe.prototype,"direction"),Roe.prototype),X(Roe.prototype,"progress",[Ml,Eoe,boe],Object.getOwnPropertyDescriptor(Roe.prototype,"progress"),Roe.prototype),Ioe=X(Roe.prototype,"slideEvents",[Coe,_l,Aoe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Poe=X(Roe.prototype,"_handle",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ooe=X(Roe.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Loe.Horizontal}}),Doe=X(Roe.prototype,"_progress",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),woe=Roe))||woe)||woe)||woe)||woe)||woe));function oae(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(t))}!function(e){e.TOGGLE="toggle"}(iae||(iae={}));var aae,sae,cae,lae,uae,hae,fae,_ae,pae,dae,mae,vae,gae,yae,Sae,xae,Tae,Eae,bae,Cae,Aae,wae,Rae,Iae,Pae,Oae,Dae,Mae,Nae,Lae,Bae,Fae,zae,Uae,kae,Gae,Hae,Vae,jae,Wae,qae,Xae,Yae,Kae,Qae,Zae,Jae,$ae,ese,tse,nse,ise,rse,ose,ase,sse,cse,lse,use,hse=function(t){return e({Toggle:t,ToggleComponent:t}),t}((zoe=sl("cc.Toggle"),Uoe=El(),koe=ll(110),Goe=yl(),Hoe=cl(y0),Voe=Nl(),joe=Rl(),Woe=Hl(e5),qoe=Nl(),Xoe=Rl(),Yoe=Hl([KB]),Koe=Rl(),zoe(Qoe=Uoe(Qoe=koe(Qoe=Goe(Qoe=Hoe((nae=tae=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"checkEvents",Joe,V(t)),q(t,"_isChecked",$oe,V(t)),q(t,"_checkMark",eae,V(t)),t}F(t,e);var n=t.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(e,t){if(void 0===t&&(t=!0),this._isChecked!=e){this._isChecked=e;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(e||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(e){this._set(e,!1)},n.onEnable=function(){e.prototype.onEnable.call(this),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(t.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var e=this._toggleContainer;e&&e.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&KB.emitEvents(this.checkEvents,this)},L(t,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return i.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),t}(Fee),tae.EventType=oae(iae,Dee),X((Zoe=nae).prototype,"isChecked",[Voe,joe],Object.getOwnPropertyDescriptor(Zoe.prototype,"isChecked"),Zoe.prototype),X(Zoe.prototype,"checkMark",[Woe,qoe,Xoe],Object.getOwnPropertyDescriptor(Zoe.prototype,"checkMark"),Zoe.prototype),Joe=X(Zoe.prototype,"checkEvents",[Yoe,_l,Koe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$oe=X(Zoe.prototype,"_isChecked",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eae=X(Zoe.prototype,"_checkMark",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qoe=Zoe))||Qoe)||Qoe)||Qoe)||Qoe)||Qoe)),fse=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((aae=sl("cc.ToggleContainer"),sae=El(),cae=ll(110),lae=yl(),uae=Rl(),hae=Hl([KB]),fae=Rl(),aae(_ae=sae(_ae=cae(_ae=lae(_ae=gl((vae=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_allowSwitchOff",dae,V(t)),q(t,"checkEvents",mae,V(t)),t}F(t,e);var n=t.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(JE.CHILD_ADDED,this.ensureValidState,this),this.node.on(JE.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(JE.CHILD_ADDED,this.ensureValidState,this),this.node.off(JE.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(e){return e.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(e){return e.isChecked}))},n.notifyToggleCheck=function(e,t){if(void 0===t&&(t=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var r=this.toggleItems[n];r!==e&&(t?r.isChecked=!1:r.setIsCheckedWithoutNotify(!1))}this.checkEvents&&i.Component.EventHandler.emitEvents(this.checkEvents,e)}},n.ensureValidState=function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},L(t,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}}]),t}(oh),dae=X((pae=vae).prototype,"_allowSwitchOff",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(pae.prototype,"allowSwitchOff",[uae],Object.getOwnPropertyDescriptor(pae.prototype,"allowSwitchOff"),pae.prototype),mae=X(pae.prototype,"checkEvents",[hae,_l,fae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_ae=pae))||_ae)||_ae)||_ae)||_ae)||_ae)),_se=new zi;function pse(e){return e instanceof DO?iN:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:Wi.ZERO}function dse(e,t,n,i){e.parent?_se.set(e.parent.getScale().x,e.parent.getScale().y):_se.set(0,0);for(var r=_se.x,o=_se.y,a=0,s=0,c=e.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===t)break;c?_se.set(c.getScale().x,c.getScale().y):_se.set(0,0);var u=_se.x,h=_se.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(lse||(lse={})),$e(lse),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(use||(use={}));var mse,vse,gse,yse,Sse,xse,Tse,Ese,bse,Cse,Ase,wse,Rse,Ise,Pse,Ose,Dse,Mse,Nse,Lse=use.TOP|use.BOT,Bse=use.LEFT|use.RIGHT,Fse=function(t){return e({Widget:t,WidgetComponent:t}),t}((gae=sl("cc.Widget"),yae=El(),Sae=ll(110),xae=yl(),Tae=cl(y0),Eae=Hl(eA),bae=Rl(),Cae=Rl(),Aae=Rl(),wae=Rl(),Rae=Rl(),Iae=Rl(),Pae=Rl(),Oae=Cl(),Dae=Cl(),Mae=Rl(),Nae=Rl(),Lae=Rl(),Bae=Rl(),Fae=Rl(),zae=Rl(),Uae=Hl(lse),kae=Rl(),gae(Gae=yae(Gae=Sae(Gae=xae(Gae=Tae(Gae=gl((cse=sse=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastPos=new yi,t._lastSize=new Wi,t._dirty=!0,t._hadAlignOnce=!1,q(t,"_alignFlags",Vae,V(t)),q(t,"_target",jae,V(t)),q(t,"_left",Wae,V(t)),q(t,"_right",qae,V(t)),q(t,"_top",Xae,V(t)),q(t,"_bottom",Yae,V(t)),q(t,"_horizontalCenter",Kae,V(t)),q(t,"_verticalCenter",Qae,V(t)),q(t,"_isAbsLeft",Zae,V(t)),q(t,"_isAbsRight",Jae,V(t)),q(t,"_isAbsTop",$ae,V(t)),q(t,"_isAbsBottom",ese,V(t)),q(t,"_isAbsHorizontalCenter",tse,V(t)),q(t,"_isAbsVerticalCenter",nse,V(t)),q(t,"_originalWidth",ise,V(t)),q(t,"_originalHeight",rse,V(t)),q(t,"_alignMode",ose,V(t)),q(t,"_lockFlags",ase,V(t)),t}F(t,e);var n=t.prototype;return n.updateAlignment=function(){i._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),i._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){i._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(JE.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(JE.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(JE.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(JE.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(JE.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(JE.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(JE.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(JE.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(e,t){if((this._alignFlags&e)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:iN;this.isAlignLeft&&e===use.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===use.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===use.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===use.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===use.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===use.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var e=this._target||this.node.parent;e&&e.getComponent(y0)&&(e.on(JE.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(JE.SIZE_CHANGED,this._setDirtyByMode,this),e.on(JE.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var e=this._target||this.node.parent;e&&(e.off(JE.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(JE.SIZE_CHANGED,this._setDirtyByMode,this),e.off(JE.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(e){var t=this._target||e;t&&(t.off(JE.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(JE.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===lse.ALWAYS&&this._recursiveDirty()},n._setAlign=function(e,t){if(t!==(this._alignFlags&e)>0){var n=(e&Bse)>0,i=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~e)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},L(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&use.TOP)>0},set:function(e){this._setAlign(use.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&use.BOT)>0},set:function(e){this._setAlign(use.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&use.LEFT)>0},set:function(e){this._setAlign(use.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&use.RIGHT)>0},set:function(e){this._setAlign(use.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&use.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=use.MID):this._alignFlags&=~use.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&use.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=use.CENTER):this._alignFlags&=~use.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&Bse)===Bse}},{key:"isStretchHeight",get:function(){return(this._alignFlags&Lse)===Lse}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(use.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(use.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(use.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(use.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(use.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(use.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(oh),sse.AlignMode=lse,X((Hae=cse).prototype,"target",[Eae,bae],Object.getOwnPropertyDescriptor(Hae.prototype,"target"),Hae.prototype),X(Hae.prototype,"isAlignTop",[Cae],Object.getOwnPropertyDescriptor(Hae.prototype,"isAlignTop"),Hae.prototype),X(Hae.prototype,"isAlignBottom",[Aae],Object.getOwnPropertyDescriptor(Hae.prototype,"isAlignBottom"),Hae.prototype),X(Hae.prototype,"isAlignLeft",[wae],Object.getOwnPropertyDescriptor(Hae.prototype,"isAlignLeft"),Hae.prototype),X(Hae.prototype,"isAlignRight",[Rae],Object.getOwnPropertyDescriptor(Hae.prototype,"isAlignRight"),Hae.prototype),X(Hae.prototype,"isAlignVerticalCenter",[Iae],Object.getOwnPropertyDescriptor(Hae.prototype,"isAlignVerticalCenter"),Hae.prototype),X(Hae.prototype,"isAlignHorizontalCenter",[Pae],Object.getOwnPropertyDescriptor(Hae.prototype,"isAlignHorizontalCenter"),Hae.prototype),X(Hae.prototype,"isStretchWidth",[Oae],Object.getOwnPropertyDescriptor(Hae.prototype,"isStretchWidth"),Hae.prototype),X(Hae.prototype,"isStretchHeight",[Dae],Object.getOwnPropertyDescriptor(Hae.prototype,"isStretchHeight"),Hae.prototype),X(Hae.prototype,"top",[Mae],Object.getOwnPropertyDescriptor(Hae.prototype,"top"),Hae.prototype),X(Hae.prototype,"editorTop",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"editorTop"),Hae.prototype),X(Hae.prototype,"bottom",[Nae],Object.getOwnPropertyDescriptor(Hae.prototype,"bottom"),Hae.prototype),X(Hae.prototype,"editorBottom",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"editorBottom"),Hae.prototype),X(Hae.prototype,"left",[Lae],Object.getOwnPropertyDescriptor(Hae.prototype,"left"),Hae.prototype),X(Hae.prototype,"editorLeft",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"editorLeft"),Hae.prototype),X(Hae.prototype,"right",[Bae],Object.getOwnPropertyDescriptor(Hae.prototype,"right"),Hae.prototype),X(Hae.prototype,"editorRight",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"editorRight"),Hae.prototype),X(Hae.prototype,"horizontalCenter",[Fae],Object.getOwnPropertyDescriptor(Hae.prototype,"horizontalCenter"),Hae.prototype),X(Hae.prototype,"editorHorizontalCenter",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"editorHorizontalCenter"),Hae.prototype),X(Hae.prototype,"verticalCenter",[zae],Object.getOwnPropertyDescriptor(Hae.prototype,"verticalCenter"),Hae.prototype),X(Hae.prototype,"editorVerticalCenter",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"editorVerticalCenter"),Hae.prototype),X(Hae.prototype,"isAbsoluteTop",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"isAbsoluteTop"),Hae.prototype),X(Hae.prototype,"isAbsoluteBottom",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"isAbsoluteBottom"),Hae.prototype),X(Hae.prototype,"isAbsoluteLeft",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"isAbsoluteLeft"),Hae.prototype),X(Hae.prototype,"isAbsoluteRight",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"isAbsoluteRight"),Hae.prototype),X(Hae.prototype,"isAbsoluteHorizontalCenter",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"isAbsoluteHorizontalCenter"),Hae.prototype),X(Hae.prototype,"isAbsoluteVerticalCenter",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"isAbsoluteVerticalCenter"),Hae.prototype),X(Hae.prototype,"alignMode",[Uae,kae],Object.getOwnPropertyDescriptor(Hae.prototype,"alignMode"),Hae.prototype),X(Hae.prototype,"alignFlags",[bl],Object.getOwnPropertyDescriptor(Hae.prototype,"alignFlags"),Hae.prototype),Vae=X(Hae.prototype,"_alignFlags",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jae=X(Hae.prototype,"_target",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wae=X(Hae.prototype,"_left",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qae=X(Hae.prototype,"_right",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xae=X(Hae.prototype,"_top",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yae=X(Hae.prototype,"_bottom",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kae=X(Hae.prototype,"_horizontalCenter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qae=X(Hae.prototype,"_verticalCenter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zae=X(Hae.prototype,"_isAbsLeft",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Jae=X(Hae.prototype,"_isAbsRight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$ae=X(Hae.prototype,"_isAbsTop",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ese=X(Hae.prototype,"_isAbsBottom",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tse=X(Hae.prototype,"_isAbsHorizontalCenter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nse=X(Hae.prototype,"_isAbsVerticalCenter",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ise=X(Hae.prototype,"_originalWidth",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rse=X(Hae.prototype,"_originalHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ose=X(Hae.prototype,"_alignMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lse.ON_WINDOW_RESIZE}}),ase=X(Hae.prototype,"_lockFlags",[_l,dl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gae=Hae))||Gae)||Gae)||Gae)||Gae)||Gae)||Gae));i.internal.computeInverseTransForTarget=dse,i.internal.getReadonlyNodeSize=pse;var zse,Use=new vi;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(zse||(zse={})),$e(zse);var kse,Gse,Hse,Vse,jse,Wse,qse,Xse,Yse,Kse,Qse,Zse,Jse,$se,ece,tce,nce,ice,rce,oce,ace,sce,cce,lce,uce,hce,fce,_ce,pce,dce,mce,vce,gce,yce,Sce,xce,Tce,Ece,bce,Cce,Ace,wce,Rce,Ice,Pce,Oce,Dce=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((mse=sl("cc.PageViewIndicator"),vse=El(),gse=ll(110),yse=yl(),Sse=Hl(JJ),xse=Rl(),Tse=Hl(zse),Ese=Rl(),bse=Hl(Wi),Cse=Rl(),Ase=Rl(),mse(wse=vse(wse=gse(wse=yse((Nse=Mse=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"spacing",Ise,V(t)),q(t,"_spriteFrame",Pse,V(t)),q(t,"_direction",Ose,V(t)),q(t,"_cellSize",Dse,V(t)),t._layout=null,t._pageView=null,t._indicators=[],t}F(t,e);var n=t.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(e){this._pageView=e,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(Pie),this._layout||(this._layout=this.addComponent(Pie));var e=this._layout;this.direction===zse.HORIZONTAL?(e.type=Pie.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===zse.VERTICAL&&(e.type=Pie.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=Pie.ResizeMode.CONTAINER},n._createIndicator=function(){var e=new eA;e.layer=this.node.layer;var t=e.addComponent(e5);return t.spriteFrame=this.spriteFrame,t.sizeMode=e5.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e},n._changedState=function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var n=0;n<e.length;++n){var i=e[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;Use.set(r.color),Use.a=127.5,r.color=Use}}if(e[t]._uiProps.uiComp){var o=e[t]._uiProps.uiComp;Use.set(o.color),Use.a=255,o.color=Use}}}},n._refresh=function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var n=0;if(t.length>e.length)for(n=0;n<t.length;++n)e[n]||(e[n]=this._createIndicator());else for(n=e.length-t.length;n>0;--n){var i=e[n-1];this.node.removeChild(i),e.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},L(t,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(oh),Mse.Direction=zse,X((Rse=Nse).prototype,"spriteFrame",[Sse,xse],Object.getOwnPropertyDescriptor(Rse.prototype,"spriteFrame"),Rse.prototype),X(Rse.prototype,"direction",[Tse,Ese],Object.getOwnPropertyDescriptor(Rse.prototype,"direction"),Rse.prototype),X(Rse.prototype,"cellSize",[bse,Cse],Object.getOwnPropertyDescriptor(Rse.prototype,"cellSize"),Rse.prototype),Ise=X(Rse.prototype,"spacing",[_l,Ase],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pse=X(Rse.prototype,"_spriteFrame",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ose=X(Rse.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zse.HORIZONTAL}}),Dse=X(Rse.prototype,"_cellSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wi(20,20)}}),wse=Rse))||wse)||wse)||wse)||wse)),Mce=new zi;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(Ice||(Ice={})),$e(Ice),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Pce||(Pce={})),$e(Pce),function(e){e.PAGE_TURNING="page-turning"}(Oce||(Oce={}));var Nce=function(t){return e({PageView:t,PageViewComponent:t}),t}((kse=sl("cc.PageView"),Gse=El(),Hse=ll(110),Vse=yl(),jse=Hl(Ice),Wse=Rl(),qse=Hl(Pce),Xse=Rl(),Yse=Il(),Kse=Rl(),Qse=Il(),Zse=Rl(),Jse=Hl(Dce),$se=Rl(),ece=Rl(),tce=Hl(roe),nce=Cl(),ice=Hl(roe),rce=Cl(),oce=Cl(),ace=Cl(),sce=Cl(),cce=Hl([KB]),lce=Cl(),uce=Rl(),hce=Hl([KB]),fce=Rl(),kse(_ce=Gse(_ce=Hse(_ce=Vse((Rce=wce=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"autoPageTurningThreshold",dce,V(t)),q(t,"horizontal",mce,V(t)),q(t,"vertical",vce,V(t)),q(t,"cancelInnerEvents",gce,V(t)),q(t,"scrollEvents",yce,V(t)),q(t,"pageTurningSpeed",Sce,V(t)),q(t,"pageEvents",xce,V(t)),q(t,"_sizeMode",Tce,V(t)),q(t,"_direction",Ece,V(t)),q(t,"_scrollThreshold",bce,V(t)),q(t,"_pageTurningEventTiming",Cce,V(t)),q(t,"_indicator",Ace,V(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new yi,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new zi,t._touchEndPosition=new zi,t}F(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this.node.on(JE.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(JE.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(e){this.scrollToPage(e,1)},n.getPages=function(){return this._pages},n.addPage=function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):T(4301))},n.insertPage=function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void T(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}},n.removePage=function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):b(4300,e.name)}},n.removePageAtIndex=function(e){var t=this._pages;if(!(e<0||e>=t.length)){var n=t[e];n&&this.content&&(this.content.removeChild(n),t.splice(e,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var e=this._pages,t=0,n=e.length;t<n;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(e,t){void 0===t&&(t=.3),e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var e=this.content.getComponent(Pie);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<t;++i){var r=this._pages[i].position;this.direction===Pce.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var e=this.view;if(this.content&&e&&this._sizeMode===Ice.Unified)for(var t=this._pages,n=e.contentSize,i=0,r=t.length;i<r;i++)t[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))},n._onTouchBegan=function(t,n){t.touch.getUILocation(Mce),zi.set(this._touchBeganPosition,Mce.x,Mce.y),e.prototype._onTouchBegan.call(this,t,n)},n._onTouchMoved=function(t,n){e.prototype._onTouchMoved.call(this,t,n)},n._onTouchEnded=function(t,n){t.touch.getUILocation(Mce),zi.set(this._touchEndPosition,Mce.x,Mce.y),e.prototype._onTouchEnded.call(this,t,n)},n._onTouchCancelled=function(t,n){t.touch.getUILocation(Mce),zi.set(this._touchEndPosition,Mce.x,Mce.y),e.prototype._onTouchCancelled.call(this,t,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===Pce.Horizontal,this.vertical=this.direction===Pce.Vertical},n._syncSizeMode=function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(Pie);if(t){if(this._sizeMode===Ice.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===Pce.Horizontal?(t.paddingLeft=(e.width-n.width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===Pce.Vertical&&(t.paddingTop=(e.height-n.height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var n=e[t];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,KB.emitEvents(this.pageEvents,this,Oce.PAGE_TURNING),this.node.emit(Oce.PAGE_TURNING,this))},n._isQuicklyScrollable=function(e){if(this.direction===Pce.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===Pce.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(e){var t=new zi;if(this._sizeMode===Ice.Free)this.direction===Pce.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===Pce.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var n=this.view;if(!n)return t;this.direction===Pce.Horizontal?t.x=e*n.width:this.direction===Pce.Vertical&&(t.y=e*n.height)}return t},n._getDragDirection=function(e){return this._direction===Pce.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1},n._isScrollable=function(e,t,n){if(this._sizeMode===Ice.Free){var i=0,r=0;if(this.direction===Pce.Horizontal)return i=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[n],Math.abs(e.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===Pce.Vertical)return i=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[n],Math.abs(e.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===Pce.Horizontal)return Math.abs(e.x)>=o.width*this.scrollThreshold;if(this.direction===Pce.Vertical)return Math.abs(e.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new zi;zi.subtract(t,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(t,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},L(t,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return e.prototype.verticalScrollBar},set:function(e){this.verticalScrollBar=e}},{key:"horizontalScrollBar",get:function(){return e.prototype.horizontalScrollBar},set:function(e){this.horizontalScrollBar=e}}]),t}(Boe),wce.SizeMode=Ice,wce.Direction=Pce,wce.EventType=oae(Oce,aoe),X((pce=Rce).prototype,"sizeMode",[jse,Wse],Object.getOwnPropertyDescriptor(pce.prototype,"sizeMode"),pce.prototype),X(pce.prototype,"direction",[qse,Xse],Object.getOwnPropertyDescriptor(pce.prototype,"direction"),pce.prototype),X(pce.prototype,"scrollThreshold",[Ml,Yse,Kse],Object.getOwnPropertyDescriptor(pce.prototype,"scrollThreshold"),pce.prototype),X(pce.prototype,"pageTurningEventTiming",[Ml,Qse,Zse],Object.getOwnPropertyDescriptor(pce.prototype,"pageTurningEventTiming"),pce.prototype),X(pce.prototype,"indicator",[Jse,$se],Object.getOwnPropertyDescriptor(pce.prototype,"indicator"),pce.prototype),dce=X(pce.prototype,"autoPageTurningThreshold",[_l,ece],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),X(pce.prototype,"verticalScrollBar",[tce,Jl,nce],Object.getOwnPropertyDescriptor(pce.prototype,"verticalScrollBar"),pce.prototype),X(pce.prototype,"horizontalScrollBar",[ice,Jl,rce],Object.getOwnPropertyDescriptor(pce.prototype,"horizontalScrollBar"),pce.prototype),mce=X(pce.prototype,"horizontal",[Jl,_l,oce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),vce=X(pce.prototype,"vertical",[Jl,_l,ace],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),gce=X(pce.prototype,"cancelInnerEvents",[Jl,_l,sce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yce=X(pce.prototype,"scrollEvents",[cce,_l,Jl,lce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sce=X(pce.prototype,"pageTurningSpeed",[_l,bl,uce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),xce=X(pce.prototype,"pageEvents",[hce,_l,fce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tce=X(pce.prototype,"_sizeMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ice.Unified}}),Ece=X(pce.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pce.Horizontal}}),bce=X(pce.prototype,"_scrollThreshold",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Cce=X(pce.prototype,"_pageTurningEventTiming",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Ace=X(pce.prototype,"_indicator",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_ce=pce))||_ce)||_ce)||_ce)||_ce)),Lce=new yi,Bce=new zi,Fce=new zi,zce=new zi(1,1),Uce=new zi,kce=new zi;function Gce(e,t){if(!t._hadAlignOnce){t.alignMode===lse.ONCE&&(t._hadAlignOnce=!0);var n,i=t.target,r=Fce,o=zce;i?dse(e,n=i,r,o):n=e.parent;var a=pse(n),s=n instanceof DO||!n.getComponent(y0),c=s?Bce:n.getComponent(y0).anchorPoint,l=s;e.getPosition(Lce);var u=e._uiProps.uiTransformComp,h=Lce.x,f=Lce.y,_=u.anchorPoint,p=e.getScale();if(t.alignFlags&use.HORIZONTAL){var d=0,m=0,v=a.width;l?(d=iN.left.x,m=iN.right.x):m=(d=-c.x*v)+v,d+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,i&&(d+=r.x,d*=o.x,m+=r.x,m*=o.x);var g=0,y=_.x,S=p.x;if(S<0&&(y=1-y,S=-S),t.isStretchWidth)g=m-d,0!==S&&(u.width=g/S),h=d+y*g;else if(g=u.width*S,t.isAlignHorizontalCenter){var x=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,T=(.5-c.x)*a.width;i&&(x*=o.x,T+=r.x,T*=o.x),h=T+(y-.5)*g+x}else h=t.isAlignLeft?d+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&use.VERTICAL){var E=0,b=0,C=a.height;l?(b=iN.bottom.y,E=iN.top.y):E=(b=-c.y*C)+C,b+=t.isAbsoluteBottom?t.bottom:t.bottom*C,E-=t.isAbsoluteTop?t.top:t.top*C,i&&(b+=r.y,b*=o.y,E+=r.y,E*=o.y);var A=0,w=_.y,R=p.y;if(R<0&&(w=1-w,R=-R),t.isStretchHeight)A=E-b,0!==R&&(u.height=A/R),f=b+w*A;else if(A=u.height*R,t.isAlignVerticalCenter){var I=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*C,P=(.5-c.y)*a.height;i&&(I*=o.y,P+=r.y,P*=o.y),f=P+(w-.5)*A+I}else f=t.isAlignBottom?b+w*A:E+(w-1)*A;t._lastSize.height=A}e.setPosition(h,f,Lce.z),yi.set(t._lastPos,h,f,Lce.z)}}function Hce(e){var t=e.getComponent(Fse);if(t&&t.enabled){if(!i.isValid(e,!0))return;Wce.push(t)}for(var n,r=W(e.children);!(n=r()).done;){var o=n.value;o.active&&Hce(o)}}function Vce(){var e=eN.getScene();if(e){qce.isAligning=!0,qce._nodesOrderDirty&&(Wce.length=0,Hce(e),qce._nodesOrderDirty=!1);var t=null,n=qce._activeWidgetsIterator;for(n.i=0;n.i<Wce.length;++n.i)(t=Wce[n.i])._dirty&&(Gce(t.node,t),t._dirty=!1);qce.isAligning=!1}}var jce,Wce=[],qce=e("widgetManager",i._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Ge.MutableForwardIterator(Wce),animationState:null,init:function(){eN.on($M.EVENT_AFTER_SCENE_LAUNCH,Vce),eN.on($M.EVENT_AFTER_UPDATE,Vce),aN.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);aN.instance.on("canvas-resize",e),fh.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=eN.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=eA.isNode(e)&&e.getComponent(Fse);t&&t.enabled&&(t.alignMode===lse.ON_WINDOW_RESIZE||t.alignMode===lse.ALWAYS)&&t.setDirty();for(var n,i=W(e.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function n(e,t){return Math.abs(e-t)>1e-10?t:e}var i=e.node,r=i.parent;if(r){var o=Uce;o.set(0,0);var a=kce;if(a.set(1,1),e.target&&dse(i,r=e.target,o,a),!t)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:Bce,l=i._uiProps.uiTransformComp,u=pse(r),h=l.anchorPoint,f=i.getPosition(),_=use,p=i.getScale(),d=0;if(t&_.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,d=f.x-h.x*l.width*p.x-m,e.isAbsoluteLeft||(d/=u.width),d/=a.x,e.left=n(e.left,d)}if(t&_.RIGHT){var v=(1-c.x)*u.width;v+=o.x,d=(v*=a.x)-(f.x+(1-h.x)*l.width*p.x),e.isAbsoluteRight||(d/=u.width),d/=a.x,e.right=n(e.right,d)}if(t&_.TOP){var g=(1-c.y)*u.height;g+=o.y,d=(g*=a.y)-(f.y+(1-h.y)*l.height*p.y),e.isAbsoluteTop||(d/=u.height),d/=a.y,e.top=n(e.top,d)}if(t&_.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,d=f.y-h.y*l.height*p.y-y,e.isAbsoluteBottom||(d/=u.height),d/=a.y,e.bottom=n(e.bottom,d)}}},updateAlignment:function e(t){var n=t.parent;n&&eA.isNode(n)&&e(n);var i=t.getComponent(Fse);i&&n&&Gce(t,i)},AlignMode:lse,AlignFlags:use});eN.on($M.EVENT_INIT,(function(){qce.init()}));var Xce,Yce,Kce,Qce,Zce,Jce,$ce,ele,tle,nle,ile,rle,ole,ale,sle,cle,lle,ule,hle,fle,_le=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(sl("cc.SafeArea")(jce=El()(jce=ll(110)(jce=gl(jce=yl()(jce=cl(Fse)(jce=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.onEnable=function(){this.updateArea(),fh.on("window-resize",this.updateArea,this),fh.on("orientation-change",this.updateArea,this)},n.onDisable=function(){fh.off("window-resize",this.updateArea,this),fh.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var e=this.node.getComponent(Fse),t=this.node.getComponent(y0);if(e&&t){e.updateAlignment();var n=this.node.position.clone(),i=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=uN.getVisibleSize(),o=r.width,a=r.height,s=dh.getSafeAreaRect();e.top=a-s.y-s.height,e.bottom=s.y,e.left=s.x,e.right=o-s.x-s.width,e.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/t.width,u=i.y-(c.y-n.y)/t.height;t.setAnchorPoint(l,u),qce.add(e)}},t}(oh))||jce)||jce)||jce)||jce)||jce)||jce),ple=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((Xce=sl("cc.UICoordinateTracker"),Yce=El(),Kce=yl(),Qce=ll(110),Zce=Hl(eA),Jce=Rl(),$ce=Hl(pF),ele=Rl(),tle=Rl(),nle=Rl(),ile=Hl([KB]),rle=Rl(),Xce(ole=Yce(ole=Kce(ole=Qce((X((ale=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"syncEvents",sle,V(t)),q(t,"_target",cle,V(t)),q(t,"_camera",lle,V(t)),q(t,"_useScale",ule,V(t)),q(t,"_distance",hle,V(t)),t._transformPos=new yi,t._viewPos=new yi,t._canMove=!0,t._lastWPos=new yi,t._lastCameraPos=new yi,t}F(t,e);var n=t.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&yi.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);KB.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},L(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(oh)).prototype,"target",[Zce,Jce],Object.getOwnPropertyDescriptor(ale.prototype,"target"),ale.prototype),X(ale.prototype,"camera",[$ce,ele],Object.getOwnPropertyDescriptor(ale.prototype,"camera"),ale.prototype),X(ale.prototype,"useScale",[tle],Object.getOwnPropertyDescriptor(ale.prototype,"useScale"),ale.prototype),X(ale.prototype,"distance",[nle],Object.getOwnPropertyDescriptor(ale.prototype,"distance"),ale.prototype),sle=X(ale.prototype,"syncEvents",[ile,_l,rle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cle=X(ale.prototype,"_target",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lle=X(ale.prototype,"_camera",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ule=X(ale.prototype,"_useScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hle=X(ale.prototype,"_distance",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ole=ale))||ole)||ole)||ole)||ole)),dle=[JE.TOUCH_START,JE.TOUCH_END,JE.TOUCH_MOVE,JE.MOUSE_DOWN,JE.MOUSE_MOVE,JE.MOUSE_UP,JE.MOUSE_ENTER,JE.MOUSE_LEAVE,JE.MOUSE_WHEEL];function mle(e){e.propagationStopped=!0}var vle,gle,yle,Sle,xle,Tle,Ele,ble,Cle,Ale,wle,Rle,Ile=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(sl("cc.BlockInputEvents")(fle=El()(fle=yl()(fle=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.onEnable=function(){for(var e=0;e<dle.length;e++)this.node.on(dle[e],mle,this)},n.onDisable=function(){for(var e=0;e<dle.length;e++)this.node.off(dle[e],mle,this)},t}(oh))||fle)||fle)||fle),Ple={},Ole=e("SubContextView",(vle=sl("cc.SubContextView"),gle=El(),yle=ll(110),Sle=cl(y0),xle=yl(),Tle=Rl(),Ele=Rl(),vle(ble=gle(ble=yle(ble=Sle(ble=xle((X((Cle=function(e){function t(){var t;return q(t=e.call(this)||this,"_fps",Ale,V(t)),t._sprite=void 0,t._imageAsset=void 0,t._texture=void 0,t._updatedTime=0,t._updateInterval=0,t._openDataContext=void 0,t._content=void 0,q(t,"_designResolutionSize",wle,V(t)),t._content=new eA("content"),t._content.hideFlags|=Qt.Flags.DontSave|Qt.Flags.HideInHierarchy,t._sprite=null,t._imageAsset=new Um,t._openDataContext=null,t._updatedTime=performance.now(),t._texture=new uv,t}F(t,e);var n=t.prototype;return n.onLoad=function(){Ple.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=Ple.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var e=this._openDataContext.canvas;e.width=this._designResolutionSize.width,e.height=this._designResolutionSize.height}},n._initContentNode=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(e5),this._sprite||(this._sprite=this._content.addComponent(e5)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new JJ;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var e=this.node.getComponent(y0),t=this._content.getComponent(y0),n=e.width/t.width,i=e.height/t.height,r=n>i?i:n;t.width*=r,t.height*=r;var o=uN.getViewportRect(),a=t.getBoundingBoxToWorld(),s=uN.getVisibleSize(),c=fh.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,f=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:f})}},n._updateSubContextTexture=function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}},n._registerNodeEvent=function(){this.node.on(JE.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(JE.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(JE.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(JE.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(JE.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(JE.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},L(t,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}}]),t}(oh)).prototype,"designResolutionSize",[Tle],Object.getOwnPropertyDescriptor(Cle.prototype,"designResolutionSize"),Cle.prototype),X(Cle.prototype,"fps",[Ele],Object.getOwnPropertyDescriptor(Cle.prototype,"fps"),Cle.prototype),Ale=X(Cle.prototype,"_fps",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),wle=X(Cle.prototype,"_designResolutionSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wi(640,960)}}),ble=Cle))||ble)||ble)||ble)||ble)||ble));i.SubContextView=Ole;var Dle,Mle,Nle,Lle,Ble,Fle,zle,Ule,kle,Gle,Hle,Vle,jle,Wle,qle,Xle,Yle=e("UIReorderComponent",sl("cc.UIReorderComponent")(Rle=function(){b(1408,"UIReorderComponent")})||Rle);i.UIReorderComponent=Yle,i.ButtonComponent=Fee,He.setClassAlias(Fee,"cc.ButtonComponent"),i.EditBoxComponent=oie,He.setClassAlias(oie,"cc.EditBoxComponent"),i.LayoutComponent=Pie,He.setClassAlias(Pie,"cc.LayoutComponent"),i.ProgressBarComponent=nre,He.setClassAlias(nre,"cc.ProgressBarComponent"),i.ScrollViewComponent=Boe,He.setClassAlias(Boe,"cc.ScrollViewComponent"),i.ScrollBarComponent=roe,He.setClassAlias(roe,"cc.ScrollBarComponent"),i.SliderComponent=rae,He.setClassAlias(rae,"cc.SliderComponent"),i.ToggleComponent=hse,He.setClassAlias(hse,"cc.ToggleComponent"),i.ToggleContainerComponent=fse,He.setClassAlias(fse,"cc.ToggleContainerComponent"),i.WidgetComponent=Fse,He.setClassAlias(Fse,"cc.WidgetComponent"),i.PageViewComponent=Nce,He.setClassAlias(Nce,"cc.PageViewComponent"),i.PageViewIndicatorComponent=Dce,He.setClassAlias(Dce,"cc.PageViewIndicatorComponent"),i.SafeAreaComponent=_le,He.setClassAlias(_le,"cc.SafeAreaComponent"),He.setClassAlias(ple,"cc.UICoordinateTrackerComponent"),i.BlockInputEventsComponent=Ile,He.setClassAlias(Ile,"cc.BlockInputEventsComponent");var Kle,Qle,Zle,Jle,$le,eue,tue,nue,iue,rue,oue,aue,sue,cue,lue,uue,hue,fue,_ue,pue,due,mue,vue,gue,yue,Sue,xue,Tue,Eue,bue,Cue,Aue,wue=function(t){return e({Billboard:t,BillboardComponent:t}),t}((Dle=sl("cc.Billboard"),Mle=El(),Nle=yl(),Lle=Hl(uv),Ble=Hl(uv),Fle=Rl(),zle=Rl(),Ule=Rl(),kle=Rl(),Dle(Gle=Mle(Gle=Nle(Gle=gl((Xle=function(e){function t(){var t;return q(t=e.call(this)||this,"_texture",Vle,V(t)),q(t,"_height",jle,V(t)),q(t,"_width",Wle,V(t)),q(t,"_rotation",qle,V(t)),t._model=null,t._mesh=null,t._material=null,t._uniform=new Hi(1,1,0,0),t}F(t,e);var n=t.prototype;return n.onLoad=function(){this.createModel()},n.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},n.onDisable=function(){this.detachFromScene()},n.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},n.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n.createModel=function(){this._mesh=EY({primitiveMode:Qr.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[vi.WHITE.r,vi.WHITE.g,vi.WHITE.b,vi.WHITE.a,vi.WHITE.r,vi.WHITE.g,vi.WHITE.b,vi.WHITE.a,vi.WHITE.r,vi.WHITE.g,vi.WHITE.b,vi.WHITE.a,vi.WHITE.r,vi.WHITE.g,vi.WHITE.b,vi.WHITE.a],attributes:[new jo(uo.ATTR_POSITION,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD,Cr.RG32F),new jo(uo.ATTR_COLOR,Cr.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var e=this._model=i.director.root.createModel(ag,this.node);e.node=e.transform=this.node,null==this._material&&(this._material=new Ng,this._material.copy(Vv.get("default-billboard-material"))),e.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},L(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*ni(this._rotation))/100},set:function(e){this._rotation=ti(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),t}(oh),Vle=X((Hle=Xle).prototype,"_texture",[Lle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Hle.prototype,"texture",[Ble,Fle],Object.getOwnPropertyDescriptor(Hle.prototype,"texture"),Hle.prototype),jle=X(Hle.prototype,"_height",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(Hle.prototype,"height",[zle],Object.getOwnPropertyDescriptor(Hle.prototype,"height"),Hle.prototype),Wle=X(Hle.prototype,"_width",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(Hle.prototype,"width",[Ule],Object.getOwnPropertyDescriptor(Hle.prototype,"width"),Hle.prototype),qle=X(Hle.prototype,"_rotation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(Hle.prototype,"rotation",[kle],Object.getOwnPropertyDescriptor(Hle.prototype,"rotation"),Hle.prototype),Gle=Hle))||Gle)||Gle)||Gle)||Gle)),Rue=[new jo(uo.ATTR_POSITION,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD,Cr.RGBA32F),new jo(uo.ATTR_TEX_COORD1,Cr.RGB32F),new jo(uo.ATTR_COLOR,Cr.RGBA8,!0)],Iue=new yi,Pue=new yi,Oue=function(e){function t(){var t;return(t=e.call(this)||this)._capacity=void 0,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=null,t._vertCount=0,t._indexCount=0,t._material=null,t.type=Zv.LINE,t._capacity=100,t._iaInfo=new Oo([new Io]),t._iaInfoBuffer=t._device.createBuffer(new wo(Rr.INDIRECT,Or.DEVICE,ga,ga)),t}F(t,e);var n=t.prototype;return n.setCapacity=function(e){this._capacity=e,this.createBuffer()},n.createBuffer=function(){this._vertSize=0;for(var e,t=W(Rue);!(e=t()).done;){var n=e.value;n.offset=this._vertSize,this._vertSize+=pa[n.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.updateMaterial=function(t){this._material=t,e.prototype.setSubModelMaterial.call(this,0,t)},n.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var n=new Uint16Array((this._capacity-1)*this._indexCount),i=0,r=0;r<this._capacity-1;++r){var o=2*r;n[i++]=o,n[i++]=o+1,n[i++]=o+2,n[i++]=o+3,n[i++]=o+2,n[i++]=o+1}var a=this._device.createBuffer(new wo(Rr.INDEX|Rr.TRANSFER_DST,Or.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return a.update(n),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new QA([e],Rue,Qr.TRIANGLE_LIST,a,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},n.addLineVertexData=function(e,t,n){if(e.length>1){var i=0;yi.subtract(Iue,e[1],e[0]),this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=0,this._vdataF32[i++]=Iue.x,this._vdataF32[i++]=Iue.y,this._vdataF32[i++]=Iue.z,this._vdataUint32[i++]=n.evaluate(0,1)._val,this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=1,this._vdataF32[i++]=Iue.x,this._vdataF32[i++]=Iue.y,this._vdataF32[i++]=Iue.z,this._vdataUint32[i++]=n.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){yi.subtract(Iue,e[r-1],e[r]),yi.subtract(Pue,e[r+1],e[r]),yi.subtract(Pue,Pue,Iue);var o=r/e.length;this._vdataF32[i++]=e[r].x,this._vdataF32[i++]=e[r].y,this._vdataF32[i++]=e[r].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=0,this._vdataF32[i++]=Pue.x,this._vdataF32[i++]=Pue.y,this._vdataF32[i++]=Pue.z,this._vdataUint32[i++]=n.evaluate(o,1)._val,this._vdataF32[i++]=e[r].x,this._vdataF32[i++]=e[r].y,this._vdataF32[i++]=e[r].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=1,this._vdataF32[i++]=Pue.x,this._vdataF32[i++]=Pue.y,this._vdataF32[i++]=Pue.z,this._vdataUint32[i++]=n.evaluate(o,1)._val}yi.subtract(Iue,e[e.length-1],e[e.length-2]),this._vdataF32[i++]=e[e.length-1].x,this._vdataF32[i++]=e[e.length-1].y,this._vdataF32[i++]=e[e.length-1].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=0,this._vdataF32[i++]=Iue.x,this._vdataF32[i++]=Iue.y,this._vdataF32[i++]=Iue.z,this._vdataUint32[i++]=n.evaluate(1,1)._val,this._vdataF32[i++]=e[e.length-1].x,this._vdataF32[i++]=e[e.length-1].y,this._vdataF32[i++]=e[e.length-1].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=1,this._vdataF32[i++]=Iue.x,this._vdataF32[i++]=Iue.y,this._vdataF32[i++]=Iue.z,this._vdataUint32[i++]=n.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))},n.updateIA=function(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},t}(ag),Due=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],Mue=Qe({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),Nue=e("CurveRange",(Kle=sl("cc.CurveRange"),Qle=Hl(Mue),Zle=Hl(x_),Jle=Hl(x_),$le=Hl(x_),Kle((hue=uue=function(){function e(){q(this,"mode",nue,this),q(this,"spline",iue,this),q(this,"splineMin",rue,this),q(this,"splineMax",oue,this),q(this,"constant",aue,this),q(this,"constantMin",sue,this),q(this,"constantMax",cue,this),q(this,"multiplier",lue,this),this._curve=new Cp(this.spline),this._curveMin=new Cp(this.splineMin),this._curveMax=new Cp(this.splineMax)}var t=e.prototype;return t.evaluate=function(e,t){switch(this.mode){default:case Mue.Constant:return this.constant;case Mue.Curve:return this.spline.evaluate(e)*this.multiplier;case Mue.TwoCurves:return ei(this.splineMin.evaluate(e),this.splineMax.evaluate(e),t)*this.multiplier;case Mue.TwoConstants:return ei(this.constantMin,this.constantMax,t)}},t.getMax=function(){switch(this.mode){default:case Mue.Constant:return this.constant;case Mue.Curve:return this.multiplier;case Mue.TwoConstants:return this.constantMax;case Mue.TwoCurves:return this.multiplier}},t._onBeforeSerialize=function(){return Due[this.mode]},L(e,[{key:"curve",get:function(){return this._curve},set:function(e){this._curve=e,this.spline=e._internalCurve}},{key:"curveMin",get:function(){return this._curveMin},set:function(e){this._curveMin=e,this.splineMin=e._internalCurve}},{key:"curveMax",get:function(){return this._curveMax},set:function(e){this._curveMax=e,this.splineMax=e._internalCurve}}]),e}(),uue.Mode=Mue,nue=X((tue=hue).prototype,"mode",[Qle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mue.Constant}}),iue=X(tue.prototype,"spline",[Zle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rp()}}),rue=X(tue.prototype,"splineMin",[Jle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rp()}}),oue=X(tue.prototype,"splineMax",[$le],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rp()}}),aue=X(tue.prototype,"constant",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sue=X(tue.prototype,"constantMin",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cue=X(tue.prototype,"constantMax",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lue=X(tue.prototype,"multiplier",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),eue=tue))||eue));function Lue(e,t,n){switch(e.mode){case Mue.Constant:return e.constant;case Mue.Curve:return e.spline.evaluate(t)*e.multiplier;case Mue.TwoCurves:return 0===n?e.splineMin.evaluate(t)*e.multiplier:e.splineMax.evaluate(t)*e.multiplier;case Mue.TwoConstants:return 0===n?e.constantMin:e.constantMax;default:return 0}}function Bue(e){switch(e.mode){case Mue.TwoConstants:case Mue.TwoCurves:return 2;default:return 1}}function Fue(e,t,n){var i=new Um({width:t,height:n,_data:e,_compressed:!1,format:lm.RGBA32F}),r=new uv;return r.setFilters(hm.NEAREST,hm.NEAREST),r.setMipFilter(hm.NONE),r.setWrapMode(um.CLAMP_TO_EDGE,um.CLAMP_TO_EDGE,um.CLAMP_TO_EDGE),r.image=i,r}function zue(e,t,n,i,r){for(var o=Math.max(Bue(t),Bue(n),Bue(i)),a=new Float32Array(e*o*4),s=[t,n,i],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<3;u++)for(var h=s[u],f=0,_=0,p=0;p<e;p++){var d=Lue(h,c*p,l);_=r?d:(f+=d)/(p+1),a[4*p+u]=_}return Fue(a,e,o)}var Uue,kue,Gue,Hue,Vue,jue,Wue,que,Xue,Yue,Kue,Que,Zue,Jue,$ue,ehe,the,nhe,ihe,rhe,ohe,ahe,she,che,lhe,uhe,hhe,fhe,_he,phe,dhe,mhe,vhe,ghe,yhe,She,xhe,The,Ehe,bhe,Che,Ahe,whe,Rhe,Ihe,Phe,Ohe,Dhe,Mhe,Nhe,Lhe,Bhe,Fhe,zhe,Uhe,khe=Qe({Blend:0,Fixed:1}),Ghe=(e("ColorKey",sl("cc.ColorKey")((pue=X((_ue=function(){q(this,"color",pue,this),q(this,"time",due,this)}).prototype,"color",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.WHITE.clone()}}),due=X(_ue.prototype,"time",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fue=_ue))||fue),e("AlphaKey",sl("cc.AlphaKey")((gue=X((vue=function(){q(this,"alpha",gue,this),q(this,"time",yue,this)}).prototype,"alpha",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yue=X(vue.prototype,"time",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mue=vue))||mue),e("Gradient",sl("cc.Gradient")((Aue=Cue=function(){function e(){q(this,"colorKeys",Tue,this),q(this,"alphaKeys",Eue,this),q(this,"mode",bue,this),this._color=void 0,this._color=vi.WHITE.clone()}var t=e.prototype;return t.setKeys=function(e,t){this.colorKeys=e,this.alphaKeys=t},t.sortKeys=function(){this.colorKeys.length>1&&this.colorKeys.sort((function(e,t){return e.time-t.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(e,t){return e.time-t.time}))},t.evaluate=function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color},t.randomColor=function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color},t.getRGB=function(e){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(vi.WHITE),this._color);e=ui(e,1);for(var t=1;t<this.colorKeys.length;++t){var n=this.colorKeys[t-1].time,i=this.colorKeys[t].time;if(e>=n&&e<i){if(this.mode===khe.Fixed)return this.colorKeys[t].color;var r=(e-n)/(i-n);return vi.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var o=this.colorKeys.length-1;e<this.colorKeys[0].time?vi.lerp(this._color,vi.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[o].time&&vi.lerp(this._color,this.colorKeys[o].color,vi.BLACK,(e-this.colorKeys[o].time)/(1-this.colorKeys[o].time))},t.getAlpha=function(e){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=ui(e,1);for(var t=1;t<this.alphaKeys.length;++t){var n=this.alphaKeys[t-1].time,i=this.alphaKeys[t].time;if(e>=n&&e<i){if(this.mode===khe.Fixed)return this.alphaKeys[t].alpha;var r=(e-n)/(i-n);return ei(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var o=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?ei(0,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[o].time?ei(this.alphaKeys[o].alpha,0,(e-this.alphaKeys[o].time)/(1-this.alphaKeys[o].time)):void 0},e}(),Cue.Mode=khe,Tue=X((xue=Aue).prototype,"colorKeys",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),Eue=X(xue.prototype,"alphaKeys",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),bue=X(xue.prototype,"mode",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return khe.Blend}}),Sue=xue))||Sue)),Hhe=Qe({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),Vhe=e("GradientRange",(Uue=sl("cc.GradientRange"),kue=Hl(Hhe),Gue=Hl(Ghe),Hue=Hl(Ghe),Vue=Hl(Ghe),jue=Hl(Hhe),Uue((the=ehe=function(){function e(){q(this,"color",Xue,this),q(this,"colorMin",Yue,this),q(this,"colorMax",Kue,this),q(this,"gradient",Que,this),q(this,"gradientMin",Zue,this),q(this,"gradientMax",Jue,this),q(this,"_mode",$ue,this),this._color=vi.WHITE.clone()}var t=e.prototype;return t.evaluate=function(e,t){switch(this._mode){case Hhe.Color:return this.color;case Hhe.TwoColors:return vi.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case Hhe.RandomColor:return this.gradient.randomColor();case Hhe.Gradient:return this.gradient.evaluate(e);case Hhe.TwoGradients:return vi.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}},t._onBeforeSerialize=function(){return(!1)[this._mode]},L(e,[{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),ehe.Mode=Hhe,X((que=the).prototype,"mode",[kue],Object.getOwnPropertyDescriptor(que.prototype,"mode"),que.prototype),Xue=X(que.prototype,"color",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.WHITE.clone()}}),Yue=X(que.prototype,"colorMin",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.WHITE.clone()}}),Kue=X(que.prototype,"colorMax",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.WHITE.clone()}}),Que=X(que.prototype,"gradient",[Gue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ghe}}),Zue=X(que.prototype,"gradientMin",[Hue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ghe}}),Jue=X(que.prototype,"gradientMax",[Vue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ghe}}),$ue=X(que.prototype,"_mode",[jue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hhe.Color}}),Wue=que))||Wue));function jhe(e,t,n){switch(e.mode){case Hhe.Color:return e.color;case Hhe.TwoColors:return 0===n?e.colorMin:e.colorMax;case Hhe.RandomColor:return e.gradient.randomColor();case Hhe.Gradient:return e.gradient.evaluate(t);case Hhe.TwoGradients:return 0===n?e.gradientMin.evaluate(t):e.gradientMax.evaluate(t);default:return e.color}}var Whe={parent:null,owner:null,subModelIdx:0},qhe={CC_USE_WORLD_SPACE:!1},Xhe=function(t){return e({Line:t,LineComponent:t}),t}((nhe=sl("cc.Line"),ihe=El(),rhe=yl(),ohe=Hl(uv),ahe=Hl(uv),she=Nl(),che=Rl(),lhe=Nl(),uhe=Rl(),hhe=Hl([yi]),fhe=Hl([yi]),_he=Nl(),phe=Rl(),dhe=Hl(Nue),mhe=Hl(Nue),vhe=Il(),ghe=Nl(),yhe=Rl(),She=Hl(zi),xhe=Nl(),The=Rl(),Ehe=Hl(zi),bhe=Nl(),Che=Rl(),Ahe=Hl(Vhe),whe=Hl(Vhe),Rhe=Nl(),Ihe=Rl(),nhe(Phe=ihe(Phe=rhe(Phe=gl((Uhe=function(e){function t(){var t;return q(t=e.call(this)||this,"_texture",Dhe,V(t)),t._material=null,t._materialInstance=null,q(t,"_worldSpace",Mhe,V(t)),q(t,"_positions",Nhe,V(t)),q(t,"_width",Lhe,V(t)),q(t,"_tile",Bhe,V(t)),q(t,"_offset",Fhe,V(t)),q(t,"_color",zhe,V(t)),t._model=null,t._tile_offset=new Hi,t}F(t,e);var n=t.prototype;return n.onLoad=function(){var e=this._model=i.director.root.createModel(Oue);e.node=e.transform=this.node,null===this._material&&(this._material=new Ng,this._material.copy(Vv.get("default-trail-material")),qhe.CC_USE_WORLD_SPACE=this.worldSpace,Whe.parent=this._material,Whe.subModelIdx=0,this._materialInstance=new Qg(Whe),Whe.parent=null,Whe.subModelIdx=0,this._materialInstance.recompileShaders(qhe)),e.updateMaterial(this._materialInstance),e.setCapacity(100)},n.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},n.onDisable=function(){this._model&&this._detachFromScene()},n._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},L(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._materialInstance&&this._materialInstance.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._materialInstance&&(qhe.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(qhe),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),t}(oh),Dhe=X((Ohe=Uhe).prototype,"_texture",[ohe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(Ohe.prototype,"texture",[ahe,she,che],Object.getOwnPropertyDescriptor(Ohe.prototype,"texture"),Ohe.prototype),Mhe=X(Ohe.prototype,"_worldSpace",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Ohe.prototype,"worldSpace",[lhe,uhe],Object.getOwnPropertyDescriptor(Ohe.prototype,"worldSpace"),Ohe.prototype),Nhe=X(Ohe.prototype,"_positions",[hhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X(Ohe.prototype,"positions",[fhe,_he,phe],Object.getOwnPropertyDescriptor(Ohe.prototype,"positions"),Ohe.prototype),Lhe=X(Ohe.prototype,"_width",[dhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),X(Ohe.prototype,"width",[mhe,vhe,ghe,yhe],Object.getOwnPropertyDescriptor(Ohe.prototype,"width"),Ohe.prototype),Bhe=X(Ohe.prototype,"_tile",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(1,1)}}),X(Ohe.prototype,"tile",[She,xhe,The],Object.getOwnPropertyDescriptor(Ohe.prototype,"tile"),Ohe.prototype),Fhe=X(Ohe.prototype,"_offset",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zi(0,0)}}),X(Ohe.prototype,"offset",[Ehe,bhe,Che],Object.getOwnPropertyDescriptor(Ohe.prototype,"offset"),Ohe.prototype),zhe=X(Ohe.prototype,"_color",[Ahe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vhe}}),X(Ohe.prototype,"color",[whe,Rhe,Ihe],Object.getOwnPropertyDescriptor(Ohe.prototype,"color"),Ohe.prototype),Phe=Ohe))||Phe)||Phe)||Phe)||Phe)),Yhe=function(){function e(e){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new yi(0,0,0),this.velocity=new yi(0,0,0),this.animatedVelocity=new yi(0,0,0),this.ultimateVelocity=new yi(0,0,0),this.angularVelocity=new yi(0,0,0),this.axisOfRotation=new yi(0,0,0),this.rotation=new yi(0,0,0),this.startEuler=new yi(0,0,0),this.startRotation=new Ai,this.startRotated=!1,this.deltaQuat=new Ai,this.deltaMat=new Ni,this.localMat=new Ni,this.startSize=new yi(0,0,0),this.size=new yi(0,0,0),this.startColor=vi.WHITE.clone(),this.color=vi.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return e.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},e}();Yhe.INDENTIFY_NEG_QUAT=10,Yhe.R2D=180/Math.PI;var Khe,Qhe,Zhe,Jhe,$he,efe,tfe,nfe,ife,rfe,ofe,afe,sfe,cfe,lfe,ufe,hfe,ffe,_fe,pfe,dfe,mfe,vfe,gfe,yfe,Sfe,xfe,Tfe,Efe,bfe,Cfe,Afe,wfe,Rfe,Ife="colorModule",Pfe="rotationModule",Ofe="sizeModule",Dfe="textureModule",Mfe=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],Nfe=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],Lfe=function(){function e(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var t=e.prototype;return t.bindTarget=function(e){this.target=e},t.update=function(){},e}(),Bfe=Qe({World:0,Local:1,Custom:2}),Ffe=Qe({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),zfe=Qe({World:0,Local:1,View:2}),Ufe=Qe({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),kfe=Qe({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),Gfe=Qe({Base:0,Edge:1,Shell:2,Volume:3}),Hfe=Qe({Random:0,Loop:1,PingPong:2}),Vfe=Qe({Particles:0}),jfe=Qe({Stretch:0}),Wfe=(Khe=sl("cc.ColorOvertimeModule"),Qhe=Nl(),Zhe=Hl(Vhe),Jhe=Nl(),Khe((ife=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_enable",tfe,V(t)),q(t,"color",nfe,V(t)),t.name=Ife,t}return F(t,e),t.prototype.animate=function(e){e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,ai(e.randomSeed+91041)))},L(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(Lfe),tfe=X((efe=ife).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(efe.prototype,"enable",[Qhe],Object.getOwnPropertyDescriptor(efe.prototype,"enable"),efe.prototype),nfe=X(efe.prototype,"color",[Zhe,_l,Jhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vhe}}),$he=efe))||$he),qfe=new yi(0,0,-1);function Xfe(e,t,n,i){return t!==e?(e===Bfe.World||Ni.invert(n,n),Ni.getRotation(i,n),!0):(Ai.set(i,0,0,0,1),!1)}function Yfe(e,t){zi.set(e,Math.cos(t),Math.sin(t))}function Kfe(e){var t=ri(-1,1),n=ri(0,2*Math.PI),i=Math.sqrt(1-t*t),r=i*Math.cos(n),o=i*Math.sin(n);yi.set(e,r,o,t)}function Qfe(e,t,n){Kfe(e),yi.multiplyScalar(e,e,t+(n-t)*ii())}function Zfe(e,t,n,i){Yfe(e,i),e.z=0,yi.multiplyScalar(e,e,t+(n-t)*ii())}function Jfe(e){for(var t=0;t<e.length;t++){var n=t+oi(0,e.length-t),i=e[n];e[n]=e[t],e[t]=i}}function $fe(){var e=ri(-1,1);return 0===e&&e++,Dn(e)}var e_e,t_e,n_e,i_e,r_e,o_e,a_e,s_e,c_e,l_e,u_e,h_e,f_e,__e,p_e,d_e,m_e,v_e,g_e,y_e,S_e,x_e,T_e,E_e,b_e,C_e,A_e,w_e,R_e,I_e,P_e,O_e,D_e,M_e,N_e,L_e,B_e,F_e,z_e,U_e,k_e,G_e,H_e,V_e,j_e,W_e,q_e,X_e,Y_e,K_e,Q_e,Z_e,J_e,$_e,epe,tpe,npe,ipe,rpe,ope,ape=212165,spe=new yi,cpe=(rfe=sl("cc.ForceOvertimeModule"),ofe=Nl(),afe=Hl(Nue),sfe=Il(),cfe=Nl(),lfe=Rl(),ufe=Hl(Nue),hfe=Il(),ffe=Nl(),_fe=Rl(),pfe=Hl(Nue),dfe=Il(),mfe=Nl(),vfe=Rl(),gfe=Hl(Bfe),yfe=Nl(),Sfe=Rl(),rfe((Rfe=function(e){function t(){var t;return q(t=e.call(this)||this,"_enable",Efe,V(t)),q(t,"x",bfe,V(t)),q(t,"y",Cfe,V(t)),q(t,"z",Afe,V(t)),q(t,"space",wfe,V(t)),t.randomized=!1,t.rotation=void 0,t.needTransform=void 0,t.name="forceModule",t.rotation=new Ai,t.needTransform=!1,t.needUpdate=!0,t}F(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=Xfe(e,this.space,t,this.rotation)},n.animate=function(e,t){var n=1-e.remainingLifetime/e.startLifetime,i=yi.set(spe,this.x.evaluate(n,ai(e.randomSeed+ape)),this.y.evaluate(n,ai(e.randomSeed+ape)),this.z.evaluate(n,ai(e.randomSeed+ape)));this.needTransform&&yi.transformQuat(i,i,this.rotation),yi.scaleAndAdd(e.velocity,e.velocity,i,t),yi.copy(e.ultimateVelocity,e.velocity)},L(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(Lfe),Efe=X((Tfe=Rfe).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Tfe.prototype,"enable",[ofe],Object.getOwnPropertyDescriptor(Tfe.prototype,"enable"),Tfe.prototype),bfe=X(Tfe.prototype,"x",[afe,_l,sfe,cfe,lfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),Cfe=X(Tfe.prototype,"y",[ufe,_l,hfe,ffe,_fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),Afe=X(Tfe.prototype,"z",[pfe,_l,dfe,mfe,vfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),wfe=X(Tfe.prototype,"space",[gfe,_l,yfe,Sfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bfe.Local}}),xfe=Tfe))||xfe),lpe=23541,upe=new yi,hpe=new yi,fpe=(e_e=sl("cc.LimitVelocityOvertimeModule"),t_e=Nl(),n_e=Hl(Nue),i_e=Il(),r_e=Nl(),o_e=Rl(),a_e=Hl(Nue),s_e=Il(),c_e=Nl(),l_e=Rl(),u_e=Hl(Nue),h_e=Il(),f_e=Nl(),__e=Rl(),p_e=Hl(Nue),d_e=Il(),m_e=Nl(),v_e=Rl(),g_e=Nl(),y_e=Rl(),S_e=Nl(),x_e=Rl(),T_e=Hl(Bfe),E_e=Nl(),b_e=Rl(),e_e((L_e=function(e){function t(){var t;return q(t=e.call(this)||this,"_enable",w_e,V(t)),q(t,"limitX",R_e,V(t)),q(t,"limitY",I_e,V(t)),q(t,"limitZ",P_e,V(t)),q(t,"limit",O_e,V(t)),q(t,"dampen",D_e,V(t)),q(t,"separateAxes",M_e,V(t)),q(t,"space",N_e,V(t)),t.drag=null,t.multiplyDragByParticleSize=!1,t.multiplyDragByParticleVelocity=!1,t.name="limitModule",t.rotation=void 0,t.needTransform=void 0,t.rotation=new Ai,t.needTransform=!1,t.needUpdate=!0,t}F(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=Xfe(e,this.space,t,this.rotation)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=upe;this.separateAxes?(yi.set(hpe,this.limitX.evaluate(t,ai(e.randomSeed+lpe)),this.limitY.evaluate(t,ai(e.randomSeed+lpe)),this.limitZ.evaluate(t,ai(e.randomSeed+lpe))),this.needTransform&&yi.transformQuat(hpe,hpe,this.rotation),yi.set(n,_pe(e.ultimateVelocity.x,hpe.x,this.dampen),_pe(e.ultimateVelocity.y,hpe.y,this.dampen),_pe(e.ultimateVelocity.z,hpe.z,this.dampen))):(yi.normalize(n,e.ultimateVelocity),yi.multiplyScalar(n,n,_pe(e.ultimateVelocity.length(),this.limit.evaluate(t,ai(e.randomSeed+lpe)),this.dampen))),yi.copy(e.ultimateVelocity,n)},L(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(Lfe),w_e=X((A_e=L_e).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(A_e.prototype,"enable",[t_e],Object.getOwnPropertyDescriptor(A_e.prototype,"enable"),A_e.prototype),R_e=X(A_e.prototype,"limitX",[n_e,_l,i_e,r_e,o_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),I_e=X(A_e.prototype,"limitY",[a_e,_l,s_e,c_e,l_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),P_e=X(A_e.prototype,"limitZ",[u_e,_l,h_e,f_e,__e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),O_e=X(A_e.prototype,"limit",[p_e,_l,d_e,m_e,v_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),D_e=X(A_e.prototype,"dampen",[_l,g_e,y_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),M_e=X(A_e.prototype,"separateAxes",[_l,S_e,x_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),N_e=X(A_e.prototype,"space",[T_e,_l,E_e,b_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bfe.Local}}),C_e=A_e))||C_e);function _pe(e,t,n){var i=Math.sign(e),r=Math.abs(e);return r>t&&(r=ei(r,t,n)),r*i}var ppe,dpe,mpe,vpe,gpe,ype,Spe,xpe,Tpe,Epe,bpe,Cpe,Ape,wpe,Rpe,Ipe,Ppe,Ope,Dpe,Mpe,Npe,Lpe,Bpe,Fpe,zpe,Upe,kpe,Gpe,Hpe,Vpe,jpe,Wpe,qpe,Xpe,Ype,Kpe,Qpe,Zpe,Jpe,$pe,ede,tde,nde,ide,rde,ode,ade,sde,cde,lde,ude,hde,fde,_de,pde,dde,mde,vde,gde,yde,Sde,xde,Tde,Ede,bde,Cde,Ade,wde,Rde,Ide,Pde,Ode,Dde,Mde,Nde,Lde,Bde,Fde,zde,Ude,kde,Gde,Hde,Vde,jde,Wde,qde,Xde,Yde,Kde,Qde,Zde,Jde,$de,eme,tme,nme,ime,rme,ome,ame,sme,cme,lme,ume,hme,fme,_me,pme,dme,mme,vme,gme,yme,Sme,xme,Tme,Eme,bme,Cme,Ame,wme,Rme,Ime,Pme,Ome,Dme,Mme,Nme,Lme,Bme,Fme,zme,Ume,kme,Gme,Hme,Vme,jme,Wme,qme,Xme,Yme,Kme,Qme,Zme,Jme,$me,eve,tve,nve,ive,rve,ove,ave,sve,cve,lve,uve,hve,fve,_ve,pve,dve,mve,vve,gve,yve,Sve,xve,Tve,Eve,bve,Cve,Ave,wve,Rve,Ive,Pve,Ove,Dve,Mve,Nve=(B_e=sl("cc.RotationOvertimeModule"),F_e=Nl(),z_e=Nl(),U_e=Rl(),k_e=Hl(Nue),G_e=Il(),H_e=Nl(),V_e=Rl(),j_e=Hl(Nue),W_e=Il(),q_e=Nl(),X_e=Rl(),Y_e=Hl(Nue),K_e=Il(),Q_e=Nl(),Z_e=Rl(),B_e((ope=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_enable",epe,V(t)),q(t,"_separateAxes",tpe,V(t)),q(t,"x",npe,V(t)),q(t,"y",ipe,V(t)),q(t,"z",rpe,V(t)),t.name=Pfe,t._startMat=new Ni,t._matRot=new Ni,t._quatRot=new Ai,t._otherEuler=new yi,t}F(t,e);var n=t.prototype;return n._processRotation=function(e){var t=e.particleSystem.processor.getInfo().renderMode;t!==Ufe.Mesh&&t===Ufe.StrecthedBillboard&&this._quatRot.set(0,0,0,1),Ai.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=Yhe.INDENTIFY_NEG_QUAT)},n.animate=function(e,t){var n=1-e.remainingLifetime/e.startLifetime,i=ai(e.randomSeed+125292),r=e.particleSystem.processor.getInfo().renderMode;this._separateAxes&&r!==Ufe.VerticalBillboard&&r!==Ufe.HorizontalBillboard?Ai.fromEuler(e.deltaQuat,this.x.evaluate(n,i)*t*Yhe.R2D,this.y.evaluate(n,i)*t*Yhe.R2D,this.z.evaluate(n,i)*t*Yhe.R2D):Ai.fromEuler(e.deltaQuat,0,0,this.z.evaluate(n,i)*t*Yhe.R2D),e.deltaMat=Ni.fromQuat(e.deltaMat,e.deltaQuat),e.localMat=e.localMat.multiply(e.deltaMat),e.startRotated||(r!==Ufe.Mesh&&(r===Ufe.StrecthedBillboard?e.startEuler.set(0,0,0):r!==Ufe.Billboard&&e.startEuler.set(0,0,e.startEuler.z)),Ai.fromEuler(e.startRotation,e.startEuler.x*Yhe.R2D,e.startEuler.y*Yhe.R2D,e.startEuler.z*Yhe.R2D),e.startRotated=!0),this._startMat=Ni.fromQuat(this._startMat,e.startRotation),this._matRot=this._startMat.multiply(e.localMat),Ni.getRotation(this._quatRot,this._matRot),this._processRotation(e,Yhe.R2D),e.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},L(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),t}(Lfe),epe=X(($_e=ope).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X($_e.prototype,"enable",[F_e],Object.getOwnPropertyDescriptor($_e.prototype,"enable"),$_e.prototype),tpe=X($_e.prototype,"_separateAxes",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X($_e.prototype,"separateAxes",[z_e,U_e],Object.getOwnPropertyDescriptor($_e.prototype,"separateAxes"),$_e.prototype),npe=X($_e.prototype,"x",[k_e,_l,G_e,Ll,H_e,V_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),ipe=X($_e.prototype,"y",[j_e,_l,W_e,Ll,q_e,X_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),rpe=X($_e.prototype,"z",[Y_e,_l,K_e,Ll,Q_e,Z_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),J_e=$_e))||J_e),Lve=(ppe=sl("cc.SizeOvertimeModule"),dpe=Nl(),mpe=Nl(),vpe=Rl(),gpe=Hl(Nue),ype=Il(),Spe=Nl(),xpe=Rl(),Tpe=Hl(Nue),Epe=Il(),bpe=Nl(),Cpe=Rl(),Ape=Hl(Nue),wpe=Il(),Rpe=Nl(),Ipe=Rl(),Ppe=Hl(Nue),Ope=Il(),Dpe=Nl(),Mpe=Rl(),ppe((Hpe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_enable",Bpe,V(t)),q(t,"separateAxes",Fpe,V(t)),q(t,"size",zpe,V(t)),q(t,"x",Upe,V(t)),q(t,"y",kpe,V(t)),q(t,"z",Gpe,V(t)),t.name=Ofe,t}return F(t,e),t.prototype.animate=function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,n=ai(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,n),e.size.y=e.startSize.y*this.y.evaluate(t,n),e.size.z=e.startSize.z*this.z.evaluate(t,n)}else yi.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,ai(e.randomSeed+39825)))},L(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(Lfe),Bpe=X((Lpe=Hpe).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(Lpe.prototype,"enable",[dpe],Object.getOwnPropertyDescriptor(Lpe.prototype,"enable"),Lpe.prototype),Fpe=X(Lpe.prototype,"separateAxes",[_l,mpe,vpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zpe=X(Lpe.prototype,"size",[gpe,_l,ype,Spe,xpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),Upe=X(Lpe.prototype,"x",[Tpe,_l,Epe,bpe,Cpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),kpe=X(Lpe.prototype,"y",[Ape,_l,wpe,Rpe,Ipe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),Gpe=X(Lpe.prototype,"z",[Ppe,_l,Ope,Dpe,Mpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),Npe=Lpe))||Npe),Bve=90794,Fve=Qe({Grid:0}),zve=Qe({WholeSheet:0,SingleRow:1}),Uve=(Vpe=sl("cc.TextureAnimationModule"),jpe=pl("numTilesX"),Wpe=pl("numTilesY"),qpe=Nl(),Xpe=Hl(Fve),Ype=Hl(Fve),Kpe=Nl(),Qpe=Rl(),Zpe=Nl(),Jpe=Rl(),$pe=Nl(),ede=Rl(),tde=Hl(zve),nde=Nl(),ide=Rl(),rde=Hl(Nue),ode=Il(),ade=Nl(),sde=Rl(),cde=Hl(Nue),lde=Il(),ude=Nl(),hde=Rl(),fde=Nl(),_de=Rl(),pde=Nl(),dde=Rl(),mde=Nl(),vde=Rl(),Vpe((Mde=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_enable",Sde,V(t)),q(t,"_numTilesX",xde,V(t)),q(t,"_numTilesY",Tde,V(t)),q(t,"_mode",Ede,V(t)),q(t,"animation",bde,V(t)),q(t,"frameOverTime",Cde,V(t)),q(t,"startFrame",Ade,V(t)),q(t,"cycleCount",wde,V(t)),q(t,"_flipU",Rde,V(t)),q(t,"_flipV",Ide,V(t)),q(t,"_uvChannelMask",Pde,V(t)),q(t,"randomRow",Ode,V(t)),q(t,"rowIndex",Dde,V(t)),t.name=Dfe,t}F(t,e);var n=t.prototype;return n.init=function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=this.startFrame.evaluate(t,ai(e.randomSeed+Bve))/(this.numTilesX*this.numTilesY);if(this.animation===zve.WholeSheet)e.frameIndex=ui(this.cycleCount*(this.frameOverTime.evaluate(t,ai(e.randomSeed+Bve))+n),1);else if(this.animation===zve.SingleRow){var i=1/this.numTilesY;if(this.randomRow){var r=ui(this.cycleCount*(this.frameOverTime.evaluate(t,ai(e.randomSeed+Bve))+n),1),o=e.startRow*i,a=o+i;e.frameIndex=ei(o,a,r)}else{var s=this.rowIndex*i,c=s+i;e.frameIndex=ei(s,c,ui(this.cycleCount*(this.frameOverTime.evaluate(t,ai(e.randomSeed+Bve))+n),1))}}},L(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,e,this)))}},{key:"mode",get:function(){return this._mode},set:function(e){e!==Fve.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(e){this._numTilesX!==e&&(this._numTilesX=e,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(e){this._numTilesY!==e&&(this._numTilesY=e,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),t}(Lfe),Sde=X((yde=Mde).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xde=X(yde.prototype,"_numTilesX",[jpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tde=X(yde.prototype,"_numTilesY",[Wpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(yde.prototype,"enable",[qpe],Object.getOwnPropertyDescriptor(yde.prototype,"enable"),yde.prototype),Ede=X(yde.prototype,"_mode",[Xpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fve.Grid}}),X(yde.prototype,"mode",[Ype,Kpe,Qpe],Object.getOwnPropertyDescriptor(yde.prototype,"mode"),yde.prototype),X(yde.prototype,"numTilesX",[Zpe,Jpe],Object.getOwnPropertyDescriptor(yde.prototype,"numTilesX"),yde.prototype),X(yde.prototype,"numTilesY",[$pe,ede],Object.getOwnPropertyDescriptor(yde.prototype,"numTilesY"),yde.prototype),bde=X(yde.prototype,"animation",[tde,_l,nde,ide],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zve.WholeSheet}}),Cde=X(yde.prototype,"frameOverTime",[rde,_l,ode,ade,sde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),Ade=X(yde.prototype,"startFrame",[cde,_l,lde,ude,hde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),wde=X(yde.prototype,"cycleCount",[_l,fde,_de],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rde=X(yde.prototype,"_flipU",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ide=X(yde.prototype,"_flipV",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pde=X(yde.prototype,"_uvChannelMask",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ode=X(yde.prototype,"randomRow",[_l,pde,dde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Dde=X(yde.prototype,"rowIndex",[_l,mde,vde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gde=yde))||gde),kve=197866,Gve=new yi,Hve=(Nde=sl("cc.VelocityOvertimeModule"),Lde=Nl(),Bde=Hl(Nue),Fde=Il(),zde=Nl(),Ude=Rl(),kde=Hl(Nue),Gde=Il(),Hde=Nl(),Vde=Rl(),jde=Hl(Nue),Wde=Il(),qde=Nl(),Xde=Rl(),Yde=Hl(Nue),Kde=Il(),Qde=Nl(),Zde=Rl(),Jde=Hl(Bfe),$de=Nl(),eme=Rl(),Nde((lme=function(e){function t(){var t;return q(t=e.call(this)||this,"_enable",ime,V(t)),q(t,"x",rme,V(t)),q(t,"y",ome,V(t)),q(t,"z",ame,V(t)),q(t,"speedModifier",sme,V(t)),q(t,"space",cme,V(t)),t.rotation=void 0,t.needTransform=void 0,t.name="velocityModule",t.rotation=new Ai,t.speedModifier.constant=1,t.needTransform=!1,t.needUpdate=!0,t}F(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=Xfe(e,this.space,t,this.rotation)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=yi.set(Gve,this.x.evaluate(t,ai(e.randomSeed^kve)),this.y.evaluate(t,ai(156497^e.randomSeed)),this.z.evaluate(t,ai(984136^e.randomSeed)));this.needTransform&&yi.transformQuat(n,n,this.rotation),yi.add(e.animatedVelocity,e.animatedVelocity,n),yi.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),yi.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,ai(e.randomSeed+kve)))},L(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(Lfe),ime=X((nme=lme).prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(nme.prototype,"enable",[Lde],Object.getOwnPropertyDescriptor(nme.prototype,"enable"),nme.prototype),rme=X(nme.prototype,"x",[Bde,_l,Fde,zde,Ude],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),ome=X(nme.prototype,"y",[kde,_l,Gde,Hde,Vde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),ame=X(nme.prototype,"z",[jde,_l,Wde,qde,Xde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),sme=X(nme.prototype,"speedModifier",[Yde,_l,Kde,Qde,Zde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),cme=X(nme.prototype,"space",[Jde,_l,$de,eme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bfe.Local}}),tme=nme))||tme),Vve=e("Burst",(ume=sl("cc.Burst"),hme=Hl(Nue),fme=Il(),ume((yme=function(){function e(){q(this,"_time",dme,this),q(this,"_repeatCount",mme,this),q(this,"repeatInterval",vme,this),q(this,"count",gme,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var t=e.prototype;return t.update=function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var n=ui(e._time-e.startDelay.evaluate(0,1),e.duration)-t;n=n>0?n:0;var i=ui(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=n&&this._curTime<i&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(i-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},t.getMaxCount=function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)},L(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),e}(),dme=X((pme=yme).prototype,"_time",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(pme.prototype,"time",[bl],Object.getOwnPropertyDescriptor(pme.prototype,"time"),pme.prototype),mme=X(pme.prototype,"_repeatCount",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X(pme.prototype,"repeatCount",[bl],Object.getOwnPropertyDescriptor(pme.prototype,"repeatCount"),pme.prototype),vme=X(pme.prototype,"repeatInterval",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),gme=X(pme.prototype,"count",[hme,_l,fme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),_me=pme))||_me)),jve=new yi(0,0,0),Wve=[],qve=new yi(.5,.5,.5),Xve=(Sme=sl("cc.ShapeModule"),xme=Nl(),Tme=Rl(),Eme=Nl(),bme=Rl(),Cme=Nl(),Ame=Rl(),wme=Nl(),Rme=Rl(),Ime=Nl(),Pme=Rl(),Ome=Nl(),Dme=Hl(kfe),Mme=pl("shapeType"),Nme=Nl(),Lme=Hl(kfe),Bme=Rl(),Fme=Hl(Gfe),zme=Nl(),Ume=Rl(),kme=Nl(),Gme=Rl(),Hme=Nl(),Vme=Rl(),jme=Nl(),Wme=Rl(),qme=Nl(),Xme=Rl(),Yme=Nl(),Kme=Rl(),Qme=Nl(),Zme=Rl(),Jme=Hl(Hfe),$me=Nl(),eve=Rl(),tve=Cl(),nve=Nl(),ive=Rl(),rve=Hl(Nue),ove=Cl(),ave=Il(),sve=Nl(),cve=Rl(),lve=Nl(),uve=Rl(),hve=Nl(),fve=Rl(),Sme((X((pve=function(){function e(){q(this,"_enable",dve,this),q(this,"_shapeType",mve,this),q(this,"emitFrom",vve,this),q(this,"alignToDirection",gve,this),q(this,"randomDirectionAmount",yve,this),q(this,"sphericalDirectionAmount",Sve,this),q(this,"randomPositionAmount",xve,this),q(this,"radius",Tve,this),q(this,"radiusThickness",Eve,this),q(this,"arcMode",bve,this),q(this,"arcSpread",Cve,this),q(this,"arcSpeed",Ave,this),q(this,"length",wve,this),q(this,"boxThickness",Rve,this),q(this,"_position",Ive,this),q(this,"_rotation",Pve,this),q(this,"_scale",Ove,this),q(this,"_arc",Dve,this),q(this,"_angle",Mve,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Ni,this.quat=new Ai,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var t=e.prototype;return t.onInit=function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time},t.emit=function(e){switch(this.shapeType){case kfe.Box:!function(e,t,n,i){switch(e){case Gfe.Volume:r=n,o=qve,yi.set(r,ri(-o.x,o.x),ri(-o.y,o.y),ri(-o.z,o.z));break;case Gfe.Shell:Wve.splice(0,Wve.length),Wve.push(ri(-.5,.5)),Wve.push(ri(-.5,.5)),Wve.push(.5*$fe()),Jfe(Wve),Yve(Wve,t),yi.set(n,Wve[0],Wve[1],Wve[2]);break;case Gfe.Edge:Wve.splice(0,Wve.length),Wve.push(ri(-.5,.5)),Wve.push(.5*$fe()),Wve.push(.5*$fe()),Jfe(Wve),Yve(Wve,t),yi.set(n,Wve[0],Wve[1],Wve[2]);break;default:console.warn(e+" is not supported for box emitter.")}var r,o;yi.copy(i,qfe)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case kfe.Circle:!function(e,t,n,i,r){Zfe(i,e*(1-t),e,n),yi.normalize(r,i)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case kfe.Cone:!function(e,t,n,i,r,o,a,s){switch(e){case Gfe.Base:Zfe(a,t*(1-n),t,i),zi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*t,yi.normalize(s,s),a.z=0;break;case Gfe.Shell:Yfe(a,i),zi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r),yi.normalize(s,s),zi.multiplyScalar(a,a,t),a.z=0;break;case Gfe.Volume:Zfe(a,t*(1-n),t,i),zi.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*t,yi.normalize(s,s),a.z=0,yi.add(a,a,yi.multiplyScalar(jve,s,o*ii()/-s.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case kfe.Sphere:!function(e,t,n,i,r){switch(e){case Gfe.Volume:Qfe(i,t*(1-n),t),yi.normalize(r,i);break;case Gfe.Shell:Kfe(i),yi.multiplyScalar(i,i,t),yi.normalize(r,i);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case kfe.Hemisphere:!function(e,t,n,i,r){switch(e){case Gfe.Volume:Qfe(i,t*(1-n),t),i.z>0&&(i.z*=-1),yi.normalize(r,i);break;case Gfe.Shell:Kfe(i),yi.multiplyScalar(i,i,t),i.z>0&&(i.z*=-1),yi.normalize(r,i);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(e.position.x+=ri(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=ri(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=ri(-this.randomPositionAmount,this.randomPositionAmount)),yi.transformQuat(e.velocity,e.velocity,this.quat),yi.transformMat4(e.position,e.position,this.mat),this.sphericalDirectionAmount>0){var t=yi.normalize(jve,e.position);yi.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},t.constructMat=function(){Ai.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Ni.fromRTS(this.mat,this.quat,this._position,this._scale)},t.generateArcAngle=function(){if(this.arcMode===Hfe.Random)return ri(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case Hfe.Loop:return ui(e,this._arc);case Hfe.PingPong:return hi(e,this._arc);default:return ui(e,this._arc)}},L(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return ni(this._arc)},set:function(e){this._arc=ti(e)}},{key:"angle",get:function(){return Math.round(100*ni(this._angle))/100},set:function(e){this._angle=ti(e)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case kfe.Box:this.emitFrom===Gfe.Base&&(this.emitFrom=Gfe.Volume);break;case kfe.Cone:this.emitFrom===Gfe.Edge&&(this.emitFrom=Gfe.Base);break;case kfe.Sphere:case kfe.Hemisphere:this.emitFrom!==Gfe.Base&&this.emitFrom!==Gfe.Edge||(this.emitFrom=Gfe.Volume)}}}]),e}()).prototype,"position",[xme,Tme],Object.getOwnPropertyDescriptor(pve.prototype,"position"),pve.prototype),X(pve.prototype,"rotation",[Eme,bme],Object.getOwnPropertyDescriptor(pve.prototype,"rotation"),pve.prototype),X(pve.prototype,"scale",[Cme,Ame],Object.getOwnPropertyDescriptor(pve.prototype,"scale"),pve.prototype),X(pve.prototype,"arc",[wme,Rme],Object.getOwnPropertyDescriptor(pve.prototype,"arc"),pve.prototype),X(pve.prototype,"angle",[Ime,Pme],Object.getOwnPropertyDescriptor(pve.prototype,"angle"),pve.prototype),dve=X(pve.prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(pve.prototype,"enable",[Ome],Object.getOwnPropertyDescriptor(pve.prototype,"enable"),pve.prototype),mve=X(pve.prototype,"_shapeType",[Dme,Mme,Nme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kfe.Cone}}),X(pve.prototype,"shapeType",[Lme,Bme],Object.getOwnPropertyDescriptor(pve.prototype,"shapeType"),pve.prototype),vve=X(pve.prototype,"emitFrom",[Fme,_l,zme,Ume],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Gfe.Volume}}),gve=X(pve.prototype,"alignToDirection",[_l,kme,Gme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yve=X(pve.prototype,"randomDirectionAmount",[_l,Hme,Vme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sve=X(pve.prototype,"sphericalDirectionAmount",[_l,jme,Wme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xve=X(pve.prototype,"randomPositionAmount",[_l,qme,Xme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tve=X(pve.prototype,"radius",[_l,Yme,Kme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Eve=X(pve.prototype,"radiusThickness",[_l,Qme,Zme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bve=X(pve.prototype,"arcMode",[Jme,_l,$me,eve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Hfe.Random}}),Cve=X(pve.prototype,"arcSpread",[tve,_l,nve,ive],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ave=X(pve.prototype,"arcSpeed",[rve,ove,ave,_l,sve,cve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),wve=X(pve.prototype,"length",[_l,lve,uve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Rve=X(pve.prototype,"boxThickness",[_l,hve,fve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(0,0,0)}}),Ive=X(pve.prototype,"_position",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(0,0,0)}}),Pve=X(pve.prototype,"_rotation",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(0,0,0)}}),Ove=X(pve.prototype,"_scale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(1,1,1)}}),Dve=X(pve.prototype,"_arc",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ti(360)}}),Mve=X(pve.prototype,"_angle",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ti(25)}}),_ve=pve))||_ve);function Yve(e,t){t.x>0&&(e[0]+=.5*ri(-t.x,t.x),e[0]=Jn(e[0],-.5,.5)),t.y>0&&(e[1]+=.5*ri(-t.y,t.y),e[1]=Jn(e[1],-.5,.5)),t.z>0&&(e[2]+=.5*ri(-t.z,t.z),e[2]=Jn(e[2],-.5,.5))}var Kve,Qve,Zve,Jve,$ve,ege,tge,nge,ige,rge,oge,age,sge,cge,lge,uge,hge,fge,_ge,pge,dge,mge,vge,gge,yge,Sge,xge,Tge,Ege,bge,Cge,Age,wge,Rge,Ige=[0,0,1,0,0,1,1,1],Pge=function(e){function t(){var t;return(t=e.call(this)||this)._capacity=void 0,t._vertAttrs=void 0,t._vertSize=void 0,t._vBuffer=void 0,t._vertAttrsFloatCount=void 0,t._vdataF32=void 0,t._vdataUint32=void 0,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=void 0,t._mesh=void 0,t._vertCount=0,t._indexCount=0,t._startTimeOffset=0,t._lifeTimeOffset=0,t._material=null,t.type=Zv.PARTICLE_BATCH,t._capacity=0,t._vertAttrs=null,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=new Oo([new Io]),t._iaInfoBuffer=t._device.createBuffer(new wo(Rr.INDIRECT,Or.HOST|Or.DEVICE,ga,ga)),t._subMeshData=null,t._mesh=null,t}F(t,e);var n=t.prototype;return n.setCapacity=function(e){var t=this._capacity!==e;this._capacity=e,this._subMeshData&&t&&this.rebuild()},n.setVertexAttributes=function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;for(var n,i=W(this._vertAttrs);!(n=i()).done;){var r=n.value;r.offset=this._vertSize,this._vertSize+=pa[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}},n.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var n=this._vertAttrs[this._vertAttrs.findIndex((function(e){return e.name===uo.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,uo.ATTR_TEX_COORD,t,this._vertSize,n);var i=this._vertAttrs.findIndex((function(e){return e.name===uo.ATTR_TEX_COORD3}));if(n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,uo.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,uo.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,uo.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),o=0;o<this._vertCount;++o)r[o*this._vertAttrsFloatCount+n/4]=vi.WHITE._val;for(var a=new Float32Array(t),s=1;s<this._capacity;s++)a.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,c);for(var l=1;l<this._capacity;l++)for(var u=0;u<this._indexCount;u++)c[l*this._indexCount+u]=c[u]+l*this._vertCount}else for(var h=0,f=0;f<this._capacity;++f){var _=4*f;c[h++]=_,c[h++]=_+1,c[h++]=_+2,c[h++]=_+3,c[h++]=_+2,c[h++]=_+1}var p=this._device.createBuffer(new wo(Rr.INDEX|Rr.TRANSFER_DST,Or.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return p.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new wo(Rr.INDIRECT,Or.HOST|Or.DEVICE,ga,ga))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new QA([e],this._vertAttrs,Qr.TRIANGLE_LIST,p,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},n.updateMaterial=function(e){this._material=e,this.setSubModelMaterial(0,e)},n.addParticleVertexData=function(e,t){if(this._mesh)for(var n=0;n<this._vertCount;n++){var i=(e*this._vertCount+n)*this._vertAttrsFloatCount;this._vdataF32[i++]=t[0].x,this._vdataF32[i++]=t[0].y,this._vdataF32[i++]=t[0].z,i+=2,this._vdataF32[i++]=t[1].z,this._vdataF32[i++]=t[2].x,this._vdataF32[i++]=t[2].y,this._vdataF32[i++]=t[2].z,this._vdataF32[i++]=t[3].x,this._vdataF32[i++]=t[3].y,this._vdataF32[i++]=t[3].z,this._vdataUint32[i++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}},n.addGPUParticleVertexData=function(e,t,n){for(var i=t*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var o=i;this._vdataF32[o++]=e.position.x,this._vdataF32[o++]=e.position.y,this._vdataF32[o++]=e.position.z,this._vdataF32[o++]=n,this._vdataF32[o++]=e.startSize.x,this._vdataF32[o++]=e.startSize.y,this._vdataF32[o++]=e.startSize.z,this._vdataF32[o++]=Ige[2*r],this._vdataF32[o++]=e.rotation.x,this._vdataF32[o++]=e.rotation.y,this._vdataF32[o++]=e.rotation.z,this._vdataF32[o++]=Ige[2*r+1],this._vdataF32[o++]=e.startColor.r/255,this._vdataF32[o++]=e.startColor.g/255,this._vdataF32[o++]=e.startColor.b/255,this._vdataF32[o++]=e.startColor.a/255,this._vdataF32[o++]=e.velocity.x,this._vdataF32[o++]=e.velocity.y,this._vdataF32[o++]=e.velocity.z,this._vdataF32[o++]=e.startLifetime,this._vdataF32[o++]=e.randomSeed,i+=this._vertAttrsFloatCount}},n.updateGPUParticles=function(e,t,n){for(var i=this._vertAttrsFloatCount*this._vertCount,r=0,o=0,a=0,s=0;s<e;++s)r=s*i,o=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(t-o)<n&&(a=--e*i,this._vdataF32.copyWithin(r,a,a+i),s--);return e},n.constructAttributeIndex=function(){if(this._vertAttrs){var e=this._vertAttrs.findIndex((function(e){return"a_position_starttime"===e.name})),t=this._vertAttrs[e].offset;this._startTimeOffset=t/4+3,e=this._vertAttrs.findIndex((function(e){return"a_dir_life"===e.name})),t=this._vertAttrs[e].offset,this._lifeTimeOffset=t/4+3}},n.updateIA=function(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)},n.clear=function(){this._subModels[0].inputAssembler.indexCount=0},n.destroy=function(){e.prototype.destroy.call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)},n.rebuild=function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)},t}(ag),Oge=function(){function e(e){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=e}var t=e.prototype;return t.getInfo=function(){return this._renderInfo},t.onInit=function(e){this._particleSystem=e},t.onEnable=function(){if(this._particleSystem){this.attachToScene();var e=this._model;e&&(e.node=e.transform=this._particleSystem.node,e.enabled=this._particleSystem.enabledInHierarchy)}},t.onDisable=function(){this.detachFromScene()},t.onDestroy=function(){this._model&&(i.director.root.destroyModel(this._model),this._model=null)},t.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},t.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},t.setVertexAttributes=function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===Ufe.Mesh?this._renderInfo.mesh:null,this._vertAttrs)},t.clear=function(){this._model&&(this._model.enabled=!1)},t.getModel=function(){return this._model},t._initModel=function(){this._model||(this._model=i.director.root.createModel(Pge),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},t.updateTrailMaterial=function(){},t.getDefaultTrailMaterial=function(){return null},e}(),Dge=new yi,Mge=new Ni,Nge=new Ai,Lge=(new yi,["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"]),Bge=[0,0,1,0,0,1,1,1],Fge=[new jo(uo.ATTR_POSITION,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD1,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD2,Cr.RGB32F),new jo(uo.ATTR_COLOR,Cr.RGBA8,!0)],zge=[new jo(uo.ATTR_POSITION,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD1,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD2,Cr.RGB32F),new jo(uo.ATTR_COLOR,Cr.RGBA8,!0),new jo(uo.ATTR_COLOR1,Cr.RGB32F)],Uge=[new jo(uo.ATTR_POSITION,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD1,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD2,Cr.RGB32F),new jo(uo.ATTR_COLOR,Cr.RGBA8,!0),new jo(uo.ATTR_TEX_COORD3,Cr.RGB32F),new jo(uo.ATTR_NORMAL,Cr.RGB32F),new jo(uo.ATTR_COLOR1,Cr.RGBA8,!0)],kge={parent:null,owner:null,subModelIdx:0},Gge=function(e){function t(t){var n;return(n=e.call(this,t)||this)._defines=void 0,n._trailDefines=void 0,n._frameTile_velLenScale=void 0,n._tmp_velLenScale=void 0,n._defaultMat=null,n._node_scale=void 0,n._attrs=void 0,n._particles=null,n._defaultTrailMat=null,n._updateList=new Map,n._animateList=new Map,n._runAnimateList=new Array,n._fillDataFunc=null,n._uScaleHandle=0,n._uLenHandle=0,n._uNodeRotHandle=0,n._alignSpace=zfe.View,n._inited=!1,n._localMat=new Ni,n._gravity=new Hi,n._model=null,n._frameTile_velLenScale=new Hi(1,1,0,0),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new Hi,n._attrs=new Array(5),n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},n._trailDefines={CC_USE_WORLD_SPACE:!0},n}F(t,e);var n=t.prototype;return n.onInit=function(t){var n=this;e.prototype.onInit.call(this,t),this._particles=new qe((function(){return new Yhe(n)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},n.clear=function(){e.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},n.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},n.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},n.getDefaultTrailMaterial=function(){return this._defaultTrailMat},n.setNewParticle=function(){},n._initModuleList=function(){var e=this;Lge.forEach((function(t){var n=e._particleSystem[t];n&&n.enable&&(n.needUpdate&&(e._updateList[n.name]=n),n.needAnimate&&(e._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var t=0,n=Mfe.length;t<n;t++){var i=this._animateList[Mfe[t]];i&&this._runAnimateList.push(i)}},n.enableModule=function(e,t,n){t?(n.needUpdate&&(this._updateList[n.name]=n),n.needAnimate&&(this._animateList[n.name]=n)):(delete this._animateList[e],delete this._updateList[e]),this._runAnimateList.length=0;for(var i=0,r=Mfe.length;i<r;i++){var o=this._animateList[Mfe[i]];o&&this._runAnimateList.push(o)}this.updateMaterialParams()},n.updateAlignSpace=function(e){this._alignSpace=e},n.updateRotation=function(){var e=this._particleSystem;if(e){var t=(e.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateRotation(t)}},n.doUpdateRotation=function(e){if(this._alignSpace===zfe.Local)this._particleSystem.node.getRotation(Nge);else if(this._alignSpace===zfe.World)this._particleSystem.node.getWorldRotation(Nge);else if(this._alignSpace===zfe.View){var t;Nge.set(0,0,0,1);var n=null===(t=this._particleSystem.node.scene.renderScene)||void 0===t?void 0:t.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Ai.fromViewUp(Nge,r.forward);break}}}else Nge.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,Nge)},n.updateScale=function(){var e=this._particleSystem;if(e){var t=(e.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(t)}},n.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case Bfe.Local:this._particleSystem.node.getScale(this._node_scale);break;case Bfe.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(this._uScaleHandle,this._node_scale)},n.updateParticles=function(e){var t=this,n=this._particleSystem;if(!n)return this._particles.length;n.node.getWorldMatrix(Mge);var i=(n.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(i),this.doUpdateRotation(i),this._updateList.forEach((function(e){e.update(n._simulationSpace,Mge)}));var r=n._trailModule,o=r&&r.enable;if(o&&r.update(),n.simulationSpace===Bfe.Local){var a=n.node.getRotation();Ni.fromQuat(this._localMat,a),this._localMat.transpose()}for(var s=function(i){var a=t._particles.data[i];if(a.remainingLifetime-=e,yi.set(a.animatedVelocity,0,0,0),a.remainingLifetime<0)return o&&r.removeParticle(a),t._particles.removeAt(i),--i,c=i,"continue";if(n.simulationSpace===Bfe.Local){var s=9.8*-n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,ai(a.randomSeed))*e;t._gravity.x=0,t._gravity.y=s,t._gravity.z=0,t._gravity.w=1,t._gravity=t._gravity.transformMat4(t._localMat),a.velocity.x+=t._gravity.x,a.velocity.y+=t._gravity.y,a.velocity.z+=t._gravity.z}else a.velocity.y-=9.8*n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,ai(a.randomSeed))*e;yi.copy(a.ultimateVelocity,a.velocity),t._runAnimateList.forEach((function(t){t.animate(a,e)})),yi.scaleAndAdd(a.position,a.position,a.ultimateVelocity,e),o&&r.animate(a,e),c=i},c=0;c<this._particles.length;++c)s(c);return this._model.enabled=this._particles.length>0,this._particles.length},n.updateRenderData=function(){for(var e=0,t=0;t<this._particles.length;++t){var n=this._particles.data[t],i=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(i=n.frameIndex),e=4*t,this._fillDataFunc(n,e,i)}},n.beforeRender=function(){this._model.updateIA(this._particles.length)},n.getParticleCount=function(){return this._particles.length},n.onMaterialModified=function(e){this._inited&&(0===e?this.updateMaterialParams():this.updateTrailMaterial())},n.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t);var n=this._particleSystem._trailModule;n&&n._trailModel&&1===e&&n._trailModel.setSubModelMaterial(0,t)},n._setFillFunc=function(){this._renderInfo.renderMode===Ufe.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===Ufe.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},n._fillMeshData=function(e,t,n){var i=t/4;this._attrs[0]=e.position,Dge.z=n,this._attrs[1]=Dge,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._model.addParticleVertexData(i,this._attrs)},n._fillStrecthedData=function(e,t,n){for(var i=0;i<4;++i)this._attrs[0]=e.position,Dge.x=Bge[2*i],Dge.y=Bge[2*i+1],Dge.z=n,this._attrs[1]=Dge,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=e.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(t++,this._attrs)},n._fillNormalData=function(e,t,n){for(var i=0;i<4;++i)this._attrs[0]=e.position,Dge.x=Bge[2*i],Dge.y=Bge[2*i+1],Dge.z=n,this._attrs[1]=Dge,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=null,this._model.addParticleVertexData(t++,this._attrs)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case Ufe.StrecthedBillboard:this._vertAttrs=zge.slice();break;case Ufe.Mesh:this._vertAttrs=Uge.slice();break;default:this._vertAttrs=Fge.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!=t){var n=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1!==n.indexOf("particle")&&-1===n.indexOf("particle-gpu")||e.setMaterial(null,0)}null==e.sharedMaterial&&null==this._defaultMat&&(kge.parent=Vv.get("default-particle-material"),kge.owner=this._particleSystem,kge.subModelIdx=0,this._defaultMat=new Qg(kge),kge.parent=null,kge.owner=null,kge.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=e.getMaterialInstance(0)||this._defaultMat;e._simulationSpace===Bfe.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=i.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=r.getHandle("nodeRotation");var o=this._renderInfo.renderMode,a=this._frameTile_velLenScale;o===Ufe.Billboard?this._defines.CC_RENDER_MODE=0:o===Ufe.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,a.z=this._renderInfo.velocityScale,a.w=this._renderInfo.lengthScale):o===Ufe.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:o===Ufe.VerticalBillboard?this._defines.CC_RENDER_MODE=3:o===Ufe.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+o+" not support.");var s=e._textureAnimationModule;s&&s.enable?(Hi.copy(this._tmp_velLenScale,a),zi.set(this._tmp_velLenScale,s.numTilesX,s.numTilesY),r.setUniform(this._uLenHandle,this._tmp_velLenScale)):r.setUniform(this._uLenHandle,a);var c,l=this._particleSystem._rotationOvertimeModule;c=l&&l.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=c,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},n.updateTrailMaterial=function(){if(this._particleSystem){var e=this._particleSystem,t=e._trailModule;if(t&&t.enable){e.simulationSpace===Bfe.World||t.space===Bfe.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var n=e.getMaterialInstance(1);null===n&&null===this._defaultTrailMat&&(kge.parent=Vv.get("default-trail-material"),kge.owner=this._particleSystem,kge.subModelIdx=1,this._defaultTrailMat=new Qg(kge),kge.parent=null,kge.owner=null,kge.subModelIdx=0),(n=n||this._defaultTrailMat).recompileShaders(this._trailDefines),t.updateMaterial()}}},t}(Oge),Hge=new Ni,Vge=new Hi,jge=new Ai,Wge=new Ai,qge=(new yi,32),Xge="a_position_starttime",Yge="a_size_uv",Kge="a_rotation_uv",Qge="a_color",Zge="a_dir_life",Jge="a_rndSeed",$ge=[new jo(Xge,Cr.RGBA32F),new jo(Yge,Cr.RGBA32F),new jo(Kge,Cr.RGBA32F),new jo(Qge,Cr.RGBA32F),new jo(Zge,Cr.RGBA32F),new jo(Jge,Cr.R32F)],eye=[new jo(Xge,Cr.RGBA32F),new jo(Yge,Cr.RGBA32F),new jo(Kge,Cr.RGBA32F),new jo(Qge,Cr.RGBA32F),new jo(Zge,Cr.RGBA32F),new jo(Jge,Cr.R32F),new jo(uo.ATTR_TEX_COORD,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD3,Cr.RGB32F),new jo(uo.ATTR_NORMAL,Cr.RGB32F),new jo(uo.ATTR_COLOR1,Cr.RGBA8,!0)],tye={parent:null,owner:null,subModelIdx:0},nye=function(e){function t(t){var n;return(n=e.call(this,t)||this)._defines=void 0,n._frameTile_velLenScale=void 0,n._unifrom_velLenScale=void 0,n._tmp_velLenScale=void 0,n._node_scale=void 0,n._vertAttrs=[],n._defaultMat=null,n._particleNum=0,n._tempParticle=null,n._colorTexture=null,n._forceTexture=null,n._velocityTexture=null,n._rotationTexture=null,n._sizeTexture=null,n._animTexture=null,n._uTimeHandle=0,n._uRotHandle=0,n._uNodeRotHandle=0,n._alignSpace=zfe.View,n._inited=!1,n._frameTile_velLenScale=new Hi(1,1,0,0),n._unifrom_velLenScale=n._frameTile_velLenScale.clone(),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new Hi,n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},n._tempParticle=new Yhe(null),n._particleNum=0,n}F(t,e);var n=t.prototype;return n.onInit=function(t){e.prototype.onInit.call(this,t),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},n.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},n.setVertexAttributes=function(){e.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},n.clear=function(){e.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()},n.enableModule=function(){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;e&&(this.initShaderUniform(e),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,e))},n.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},n.setNewParticle=function(e){this._model.addGPUParticleVertexData(e,this._particleNum,this._particleSystem._time),this._particleNum++},n.updateRotation=function(){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var t=e.passes[0];this.doUpdateRotation(t)}},n.doUpdateRotation=function(e){if(this._alignSpace===zfe.Local)this._particleSystem.node.getRotation(Wge);else if(this._alignSpace===zfe.World)this._particleSystem.node.getWorldRotation(Wge);else if(this._alignSpace===zfe.View){var t;Wge.set(0,0,0,1);var n=null===(t=this._particleSystem.node.scene.renderScene)||void 0===t?void 0:t.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Ai.fromViewUp(Wge,r.forward);break}}}else Wge.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,Wge)},n.updateScale=function(){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var t=e.passes[0];this.doUpdateScale(t)}},n.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case Bfe.Local:this._particleSystem.node.getScale(this._node_scale);break;case Bfe.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(e.getHandle("scale"),this._node_scale)},n.updateParticles=function(e){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,e),this.updateShaderUniform(e),this._model.enabled=this._particleNum>0,this._particleNum},n.updateRenderData=function(){},n.beforeRender=function(){this._model.updateIA(this._particleNum)},n.updateAlignSpace=function(e){this._alignSpace=e},n.updateShaderUniform=function(e){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(t){var n=t.passes[0];Vge.x=this._particleSystem._time,Vge.y=e,n.setUniform(this._uTimeHandle,Vge),this._particleSystem.node.getWorldRotation(jge),n.setUniform(this._uRotHandle,jge),this.doUpdateRotation(n)}},n.initShaderUniform=function(e){var t=e.passes[0];this._uTimeHandle=t.getHandle("u_timeDelta"),this._uRotHandle=t.getHandle("u_worldRot"),this._uNodeRotHandle=t.getHandle("nodeRotation"),this.doUpdateScale(t),t.setUniform(t.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),Vge.x=qge,Vge.y=.03125,t.setUniform(t.getHandle("u_sampleInfo"),Vge);var n=!1,i=this._particleSystem._forceOvertimeModule;if(n=i&&i.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=n,n){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=zue(qge,i.x,i.y,i.z);var r=t.getHandle("force_over_time_tex0"),o=Qv.getBindingFromHandle(r);t.bindSampler(o,this._forceTexture.getGFXSampler()),t.bindTexture(o,this._forceTexture.getGFXTexture());var a=t.getHandle("u_force_space");t.setUniform(a,i.space);var s=t.getHandle("u_force_mode");t.setUniform(s,this._forceTexture.height)}var c=this._particleSystem._velocityOvertimeModule;if(n=c&&c.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=n,n){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(e,t,n,i,r){for(var o=Math.max(Bue(t),Bue(n),Bue(i),Bue(r)),a=new Float32Array(e*o*4),s=[t,n,i,r],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<4;u++)for(var h=s[u],f=0,_=0,p=0;p<e;p++){var d=Lue(h,c*p,l);_=(f+=d)/(p+1),a[4*p+u]=_}return Fue(a,e,o)}(qge,c.x,c.y,c.z,c.speedModifier);var l=t.getHandle("velocity_over_time_tex0"),u=Qv.getBindingFromHandle(l);t.bindSampler(u,this._velocityTexture.getGFXSampler()),t.bindTexture(u,this._velocityTexture.getGFXTexture());var h=t.getHandle("u_velocity_space");t.setUniform(h,c.space);var f=t.getHandle("u_velocity_mode");t.setUniform(f,this._velocityTexture.height)}var _=this._particleSystem._colorOverLifetimeModule;if(n=_&&_.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=n,n){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(e,t){for(var n=function(e){switch(e.mode){case Hhe.TwoColors:case Hhe.TwoGradients:return 2;default:return 1}}(t),i=new Uint8Array(e*n*4),r=1/(e-1),o=0,a=0;a<n;a++)for(var s=0;s<e;s++){var c=jhe(t,r*s,a);i[o]=c.r,i[o+1]=c.g,i[o+2]=c.b,i[o+3]=c.a,o+=4}var l=new uv;return l.create(e,n,lm.RGBA8888),l.setFilters(hm.LINEAR,hm.LINEAR),l.setWrapMode(um.CLAMP_TO_EDGE,um.CLAMP_TO_EDGE),l.uploadData(i),l}(qge,_.color);var p=t.getHandle("color_over_time_tex0"),d=Qv.getBindingFromHandle(p);t.bindSampler(d,this._colorTexture.getGFXSampler()),t.bindTexture(d,this._colorTexture.getGFXTexture());var m=t.getHandle("u_color_mode");t.setUniform(m,this._colorTexture.height)}var v=this._particleSystem._rotationOvertimeModule;if(n=v&&v.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=n,n){this._rotationTexture&&this._rotationTexture.destroy(),v.separateAxes?this._rotationTexture=zue(qge,v.x,v.y,v.z):this._rotationTexture=function(e,t){for(var n=Bue(t),i=new Float32Array(e*n*4),r=1/(e-1),o=0,a=0;a<n;a++)for(var s=0;s<e;s++){var c=Lue(t,r*s,a);i[o+2]=c,o+=4}return Fue(i,e,n)}(qge,v.z);var g=t.getHandle("rotation_over_time_tex0"),y=Qv.getBindingFromHandle(g);t.bindSampler(y,this._rotationTexture.getGFXSampler()),t.bindTexture(y,this._rotationTexture.getGFXTexture());var S=t.getHandle("u_rotation_mode");t.setUniform(S,this._rotationTexture.height)}var x=this._particleSystem._sizeOvertimeModule;if(n=x&&x.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=n,n){this._sizeTexture&&this._sizeTexture.destroy(),x.separateAxes?this._sizeTexture=zue(qge,x.x,x.y,x.z,!0):this._sizeTexture=function(e,t){for(var n=Bue(t),i=new Float32Array(e*n*4),r=1/(e-1),o=0,a=0,s=0;s<n;s++){0;for(var c=0;c<e;c++){var l=Lue(t,r*c,s);o=l,i[a]=o,i[a+1]=o,i[a+2]=o,a+=4}}return Fue(i,e,n)}(qge,x.size);var T=t.getHandle("size_over_time_tex0"),E=Qv.getBindingFromHandle(T);t.bindSampler(E,this._sizeTexture.getGFXSampler()),t.bindTexture(E,this._sizeTexture.getGFXTexture());var b=t.getHandle("u_size_mode");t.setUniform(b,this._sizeTexture.height)}var C=this._particleSystem._textureAnimationModule;if(n=C&&C.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=n,n){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(e,t,n){for(var i=Math.max(Bue(t),Bue(n)),r=new Float32Array(e*i*4),o=[t,n],a=1/(e-1),s=0;s<i;s++)for(var c=0;c<2;c++)for(var l=o[c],u=0,h=0,f=0;f<e;f++){var _=Lue(l,a*f,s);h=(u+=_)/(f+1),r[4*f+c]=h}return Fue(r,e,i)}(qge,C.startFrame,C.frameOverTime);var A=t.getHandle("texture_animation_tex0"),w=Qv.getBindingFromHandle(A);t.bindSampler(w,this._animTexture.getGFXSampler()),t.bindTexture(w,this._animTexture.getGFXTexture());var R=t.getHandle("u_anim_info");Vge.x=this._animTexture.height,Vge.y=C.numTilesX*C.numTilesY,Vge.z=C.cycleCount,t.setUniform(R,Vge)}},n.getParticleCount=function(){return this._particleNum},n.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},n.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case Ufe.StrecthedBillboard:this._vertAttrs=$ge.slice();break;case Ufe.Mesh:this._vertAttrs=eye.slice();break;default:this._vertAttrs=$ge.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!==t){var n=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1===n.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=t.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==e.sharedMaterial&&null==this._defaultMat&&(tye.parent=Vv.get("default-particle-gpu-material"),tye.owner=e,tye.subModelIdx=0,this._defaultMat=new Qg(tye),tye.parent=null,tye.owner=null,tye.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=e.getMaterialInstance(0)||this._defaultMat;e.node.getWorldMatrix(Hge),e._simulationSpace===Bfe.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=this._renderInfo.renderMode;r===Ufe.Billboard?this._defines.CC_RENDER_MODE=0:r===Ufe.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===Ufe.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===Ufe.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===Ufe.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+r+" not support.");var o=e._textureAnimationModule;o&&o.enable?(zi.set(this._frameTile_velLenScale,o.numTilesX,o.numTilesY),Hi.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,Hi.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},t}(Oge);function iye(){var e=eN.root.device;return!!(e.capabilities.maxVertexTextureUnits>=8&&e.hasFeature(br.TEXTURE_FLOAT))||(i.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var rye,oye,aye,sye,cye,lye,uye,hye,fye,_ye,pye,dye,mye,vye,gye,yye,Sye,xye,Tye,Eye,bye,Cye,Aye,wye,Rye,Iye,Pye,Oye,Dye,Mye,Nye,Lye,Bye,Fye,zye,Uye,kye,Gye,Hye,Vye,jye,Wye,qye,Xye,Yye,Kye,Qye,Zye,Jye,$ye,eSe,tSe,nSe,iSe,rSe,oSe,aSe,sSe,cSe,lSe,uSe,hSe,fSe,_Se,pSe,dSe,mSe,vSe,gSe,ySe,SSe,xSe,TSe,ESe,bSe,CSe,ASe,wSe,RSe,ISe,PSe,OSe,DSe,MSe,NSe,LSe,BSe,FSe,zSe,USe,kSe,GSe,HSe,VSe,jSe,WSe,qSe,XSe,YSe,KSe,QSe,ZSe,JSe,$Se,exe,txe,nxe,ixe,rxe,oxe,axe,sxe,cxe,lxe,uxe,hxe,fxe,_xe,pxe,dxe,mxe,vxe,gxe,yxe,Sxe,xxe,Txe,Exe,bxe,Cxe,Axe,wxe,Rxe,Ixe,Pxe,Oxe,Dxe,Mxe,Nxe,Lxe,Bxe,Fxe,zxe,Uxe,kxe,Gxe,Hxe,Vxe,jxe,Wxe,qxe,Xxe,Yxe,Kxe,Qxe,Zxe,Jxe,$xe,eTe,tTe,nTe,iTe,rTe,oTe,aTe,sTe,cTe,lTe,uTe,hTe,fTe,_Te,pTe,dTe,mTe,vTe,gTe,yTe,STe,xTe,TTe,ETe,bTe,CTe,ATe,wTe,RTe,ITe,PTe,OTe,DTe,MTe,NTe,LTe,BTe,FTe,zTe,UTe,kTe,GTe,HTe,VTe,jTe,WTe,qTe,XTe,YTe,KTe,QTe,ZTe,JTe,$Te,eEe,tEe,nEe,iEe,rEe,oEe,aEe,sEe,cEe,lEe,uEe,hEe,fEe,_Ee,pEe,dEe,mEe,vEe,gEe,yEe,SEe,xEe=(Kve=sl("cc.ParticleSystemRenderer"),Qve=Hl(Ufe),Zve=Nl(),Jve=Rl(),$ve=Nl(),ege=Rl(),tge=Nl(),nge=Rl(),ige=Hl(Ufe),rge=Hl(dY),oge=Nl(),age=Rl(),sge=Hl(Ng),cge=Nl(),lge=Rl(),uge=Hl(Ng),hge=Nl(),fge=Rl(),_ge=Nl(),pge=Rl(),dge=Hl(zfe),mge=Nl(),vge=Rl(),Kve((Rge=wge=function(){function e(){q(this,"_renderMode",Sge,this),q(this,"_velocityScale",xge,this),q(this,"_lengthScale",Tge,this),q(this,"_mesh",Ege,this),q(this,"_mainTexture",bge,this),q(this,"_useGPU",Cge,this),q(this,"_alignSpace",Age,this),this._particleSystem=null}var t=e.prototype;return t.create=function(e){null===this._particleSystem?this._particleSystem=e:this._particleSystem!==e&&A(6033)},t.onInit=function(e){if(this.create(e),this._particleSystem.processor)A(6034);else{var t=this._useGPU&&iye();this._particleSystem.processor=t?new nye(this):new Gge(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(e)}},t._switchProcessor=function(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new nye(this):new Gge(this),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())},L(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(e){this._mainTexture=e}},{key:"useGPU",get:function(){return this._useGPU},set:function(e){this._useGPU!==e&&(iye()?this._useGPU=e:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(e){this._alignSpace=e,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),e}(),wge.AlignmentSpace=zfe,X((yge=Rge).prototype,"renderMode",[Qve,Zve,Jve],Object.getOwnPropertyDescriptor(yge.prototype,"renderMode"),yge.prototype),X(yge.prototype,"velocityScale",[$ve,ege],Object.getOwnPropertyDescriptor(yge.prototype,"velocityScale"),yge.prototype),X(yge.prototype,"lengthScale",[tge,nge],Object.getOwnPropertyDescriptor(yge.prototype,"lengthScale"),yge.prototype),Sge=X(yge.prototype,"_renderMode",[ige,_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ufe.Billboard}}),xge=X(yge.prototype,"_velocityScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Tge=X(yge.prototype,"_lengthScale",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ege=X(yge.prototype,"_mesh",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(yge.prototype,"mesh",[rge,oge,age],Object.getOwnPropertyDescriptor(yge.prototype,"mesh"),yge.prototype),X(yge.prototype,"particleMaterial",[sge,cge,lge],Object.getOwnPropertyDescriptor(yge.prototype,"particleMaterial"),yge.prototype),X(yge.prototype,"trailMaterial",[uge,hge,fge],Object.getOwnPropertyDescriptor(yge.prototype,"trailMaterial"),yge.prototype),bge=X(yge.prototype,"_mainTexture",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cge=X(yge.prototype,"_useGPU",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(yge.prototype,"useGPU",[_ge,pge],Object.getOwnPropertyDescriptor(yge.prototype,"useGPU"),yge.prototype),X(yge.prototype,"alignSpace",[dge,mge,vge],Object.getOwnPropertyDescriptor(yge.prototype,"alignSpace"),yge.prototype),Age=X(yge.prototype,"_alignSpace",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zfe.View}}),gge=yge))||gge),TEe=Math.cos(ti(100)),EEe={position:new yi,velocity:new yi},bEe=new Ai,CEe=new Ni,AEe=new yi,wEe=new yi,REe=new vi,IEe=function(){function e(e){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new yi,lifetime:0,width:0,velocity:new yi,direction:0,color:new vi})}var t=e.prototype;return t.getElement=function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])},t.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new yi,lifetime:0,width:0,velocity:new yi,direction:0,color:new vi}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]},t.iterateElement=function(e,t,n,i){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,o=this.start;o<r;o++)t(e,this.trailElements[o%this.trailElements.length],n,i)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},t.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},t.clear=function(){this.start=-1,this.end=-1},e}(),PEe=(rye=sl("cc.TrailModule"),oye=Nl(),aye=Hl(Vfe),sye=Nl(),cye=Rl(),lye=Hl(Nue),uye=Il(),hye=Nl(),fye=Rl(),_ye=Nl(),pye=Rl(),dye=Hl(Bfe),mye=Nl(),vye=Rl(),gye=Hl(jfe),yye=Nl(),Sye=Rl(),xye=Nl(),Tye=Rl(),Eye=Hl(Nue),bye=Il(),Cye=Nl(),Aye=Rl(),wye=Nl(),Rye=Rl(),Iye=Hl(Vhe),Pye=Nl(),Oye=Rl(),Dye=Hl(Vhe),Mye=Nl(),Nye=Rl(),Lye=Hl(Bfe),rye((X((Fye=function(){function e(){q(this,"_enable",zye,this),q(this,"mode",Uye,this),q(this,"lifeTime",kye,this),q(this,"_minParticleDistance",Gye,this),q(this,"existWithParticles",Hye,this),q(this,"textureMode",Vye,this),q(this,"widthFromParticle",jye,this),q(this,"widthRatio",Wye,this),q(this,"colorFromParticle",qye,this),q(this,"colorOverTrail",Xye,this),q(this,"colorOvertime",Yye,this),q(this,"_space",Kye,this),q(this,"_particleSystem",Qye,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new Oo([new Io]),this._vertAttrs=[new jo(uo.ATTR_POSITION,Cr.RGB32F),new jo(uo.ATTR_TEX_COORD,Cr.RGBA32F),new jo(uo.ATTR_TEX_COORD1,Cr.RGB32F),new jo(uo.ATTR_COLOR,Cr.RGBA8,!0)],this._vertSize=0;for(var e,t=W(this._vertAttrs);!(e=t()).done;){var n=e.value;this._vertSize+=pa[n.format].size}this._particleTrail=new Map}var t=e.prototype;return t.onInit=function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;for(var t=0,n=e.startLifetime.getMax(),i=e.rateOverTime.getMax(),r=e.duration,o=0,a=e.bursts.length;o<a;o++)t+=e.bursts[o].getMaxCount(e)*Math.ceil(n/r);this._trailNum=Math.ceil(n*this.lifeTime.getMax()*60*(i*r+t)),this._trailSegments=new We((function(){return new IEe(10)}),Math.ceil(i*r),(function(e){return e.trailElements.length=0})),this._enable&&(this.enable=this._enable)},t.onEnable=function(){this._attachToScene()},t.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},t._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},t._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},t.destroy=function(){this.destroySubMeshData(),this._trailModel&&(eN.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},t.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},t.clear=function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},t.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},t.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===Bfe.World&&this._particleSystem._simulationSpace===Bfe.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(CEe),this._particleSystem.node.getWorldRotation(bEe)):this._needTransform=!1},t.animate=function(e,t){if(this._trailSegments)if(e.loopCount>e.lastLoop)e.trailDelay>1?(e.lastLoop=e.loopCount,e.trailDelay=0):e.trailDelay++;else{var n=this._particleTrail.get(e);if(!n)return n=this._trailSegments.alloc(),void this._particleTrail.set(e,n);var i=n.getElement(n.end-1);if(this._needTransform?yi.transformMat4(AEe,e.position,CEe):yi.copy(AEe,e.position),!(i&&(n.iterateElement(this,this._updateTrailElement,e,t),yi.squaredDistance(i.position,AEe)<this._minSquaredDistance))&&(i=n.addElement())){yi.copy(i.position,AEe),i.lifetime=0,this.widthFromParticle?i.width=e.size.x*this.widthRatio.evaluate(0,1):i.width=this.widthRatio.evaluate(0,1);var r=n.count();if(2===r){var o=n.getElement(n.end-2);yi.subtract(o.velocity,i.position,o.position)}else if(r>2){var a=n.getElement(n.end-2),s=n.getElement(n.end-3);yi.subtract(AEe,s.position,a.position),yi.subtract(wEe,i.position,a.position),yi.subtract(a.velocity,wEe,AEe),yi.equals(yi.ZERO,a.velocity)&&yi.copy(a.velocity,AEe),yi.normalize(a.velocity,a.velocity),this._checkDirectionReverse(a,s)}this.colorFromParticle?i.color.set(e.color):i.color.set(this.colorOvertime.evaluate(0,1))}}},t.removeParticle=function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))},t.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var e,t=W(this._particleTrail.keys());!(e=t()).done;){var n=e.value,i=this._particleTrail.get(n);if(-1!==i.start){var r=4*this.vbOffset/this._vertSize,o=i.start>=i.end?i.end+i.trailElements.length:i.end,a=o-i.start,s=1/a,c=i.trailElements[i.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var l=i.start+1;l<o;l++){var u=i.trailElements[l%i.trailElements.length],h=l-i.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-h/a,1),r,1-h*s,h,5)}this._needTransform?yi.transformMat4(EEe.position,n.position,CEe):yi.copy(EEe.position,n.position);var f=this._trailModel;if(f&&f.node.invalidateChildren(ig.POSITION),1===a||2===a){var _=i.getElement(i.end-1);yi.subtract(_.velocity,EEe.position,_.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=_.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=_.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=_.velocity.z,this._vbF32[this.vbOffset-4]=_.velocity.x,this._vbF32[this.vbOffset-3]=_.velocity.y,this._vbF32[this.vbOffset-2]=_.velocity.z,yi.subtract(EEe.velocity,EEe.position,_.position),this._checkDirectionReverse(EEe,_)}else if(a>2){var p=i.getElement(i.end-1),d=i.getElement(i.end-2);yi.subtract(AEe,d.position,p.position),yi.subtract(wEe,EEe.position,p.position),yi.normalize(AEe,AEe),yi.normalize(wEe,wEe),yi.subtract(p.velocity,wEe,AEe),yi.normalize(p.velocity,p.velocity),this._checkDirectionReverse(p,d),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(p,this.colorOverTrail.evaluate(s,1),r,s,a-1,5),yi.subtract(EEe.velocity,EEe.position,p.position),yi.normalize(EEe.velocity,EEe.velocity),this._checkDirectionReverse(EEe,p)}this.widthFromParticle?EEe.width=n.size.x*this.widthRatio.evaluate(0,1):EEe.width=this.widthRatio.evaluate(0,1),EEe.color=n.color,yi.equals(EEe.velocity,yi.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(EEe,this.colorOverTrail.evaluate(0,1),r,0,a,1)}}this._trailModel.enabled=this.ibOffset>0},t.updateIA=function(e){var t=this._trailModel&&this._trailModel.subModels;if(t&&t.length>0){var n=t[0];n.inputAssembler.vertexBuffers[0].update(this._vbF32),n.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=e,this._iaInfoBuffer.update(this._iaInfo)}},t.beforeRender=function(){this.updateIA(this.ibOffset)},t._createModel=function(){this._trailModel||(this._trailModel=i.director.root.createModel(ag))},t.rebuild=function(){var e=eN.root.device,t=e.createBuffer(new wo(Rr.VERTEX|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),n=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(n),this._vbUint32=new Uint32Array(n),t.update(n);var i=e.createBuffer(new wo(Rr.INDEX|Rr.TRANSFER_DST,Or.HOST|Or.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),i.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer(new wo(Rr.INDIRECT,Or.HOST|Or.DEVICE,ga,ga)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new QA([t],this._vertAttrs,Qr.TRIANGLE_LIST,i,this._iaInfoBuffer);var r=this._trailModel;r&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},t._updateTrailElement=function(e,t,n,i){return t.lifetime+=i,e.colorFromParticle?(t.color.set(n.color),t.color.multiply(e.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1)),e.widthFromParticle?t.width=n.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime},t._fillVertexBuffer=function(e,t,n,i,r,o){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,REe.set(e.color),REe.multiply(t),this._vbUint32[this.vbOffset++]=REe._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=REe._val,1&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r-1,this._iBuffer[this.ibOffset++]=n+2*r+1),4&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r+1,this._iBuffer[this.ibOffset++]=n+2*r+2)},t._checkDirectionReverse=function(e,t){yi.dot(e.velocity,t.velocity)<TEe?e.direction=1-t.direction:e.direction=t.direction},t.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},L(e,[{key:"enable",get:function(){return this._enable},set:function(e){e===this._enable&&this._trailModel||(e&&!this._enable&&(this._enable=e,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),e&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e),e?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e;var t=this._particleSystem;t&&t.processor&&t.processor.updateTrailMaterial()}}]),e}()).prototype,"enable",[oye],Object.getOwnPropertyDescriptor(Fye.prototype,"enable"),Fye.prototype),zye=X(Fye.prototype,"_enable",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Uye=X(Fye.prototype,"mode",[aye,_l,sye,cye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vfe.Particles}}),kye=X(Fye.prototype,"lifeTime",[lye,_l,uye,hye,fye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),Gye=X(Fye.prototype,"_minParticleDistance",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),X(Fye.prototype,"minParticleDistance",[_ye,pye],Object.getOwnPropertyDescriptor(Fye.prototype,"minParticleDistance"),Fye.prototype),X(Fye.prototype,"space",[dye,mye,vye],Object.getOwnPropertyDescriptor(Fye.prototype,"space"),Fye.prototype),Hye=X(Fye.prototype,"existWithParticles",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Vye=X(Fye.prototype,"textureMode",[gye,_l,yye,Sye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jfe.Stretch}}),jye=X(Fye.prototype,"widthFromParticle",[_l,xye,Tye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Wye=X(Fye.prototype,"widthRatio",[Eye,_l,bye,Cye,Aye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),qye=X(Fye.prototype,"colorFromParticle",[_l,wye,Rye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Xye=X(Fye.prototype,"colorOverTrail",[Iye,_l,Pye,Oye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vhe}}),Yye=X(Fye.prototype,"colorOvertime",[Dye,_l,Mye,Nye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vhe}}),Kye=X(Fye.prototype,"_space",[Lye],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bfe.World}}),Qye=X(Fye.prototype,"_particleSystem",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bye=Fye))||Bye),OEe=new Ni,DEe=new Ai,MEe=new yi,NEe=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],LEe=function(){function e(e){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new Ni,this._gravity=new Hi,this.minPos=new yi,this.maxPos=new yi,this._nodePos=new yi,this._nodeSize=new yi,this._particleSystem=e,this._processor=this._particleSystem.processor,this._node=e.node,this._particlesAll=[],this._initModuleList()}var t=e.prototype;return t._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},t.setBoundingBoxSize=function(e){this.maxPos.x=this._nodePos.x+e.x,this.maxPos.y=this._nodePos.y+e.y,this.maxPos.z=this._nodePos.z+e.z,this.minPos.x=this._nodePos.x-e.x,this.minPos.y=this._nodePos.y-e.y,this.minPos.z=this._nodePos.z-e.z,this._updateBoundingNode()},t.setBoundingBoxCenter=function(e,t,n){this.maxPos.x=e+.5*this._nodeSize.x,this.maxPos.y=t+.5*this._nodeSize.y,this.maxPos.z=n+.5*this._nodeSize.z,this.minPos.x=e-.5*this._nodeSize.x,this.minPos.y=t-.5*this._nodeSize.y,this.minPos.z=n-.5*this._nodeSize.z,this._updateBoundingNode()},t._initModuleList=function(){var e=this;NEe.forEach((function(t){var n=e._particleSystem[t];n&&n.enable&&(n.needUpdate&&(e._updateList[n.name]=n),n.needAnimate&&(e._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var t=0,n=Mfe.length;t<n;t++){var i=this._animateList[Mfe[t]];i&&this._runAnimateList.push(i)}},t._emit=function(e,t,n){var i=this._particleSystem,r=this._node,o=i.time%i.duration/i.duration;r.invalidateChildren(ig.POSITION),i.simulationSpace===Bfe.World&&(r.getWorldMatrix(OEe),r.getWorldRotation(DEe));for(var a=0;a<e;++a){var s=new Yhe(i);s.particleSystem=i,s.reset();var c=ai(oi(0,On));i._shapeModule&&i._shapeModule.enable?i._shapeModule.emit(s):(yi.set(s.position,0,0,0),yi.copy(s.velocity,qfe)),i._textureAnimationModule&&i._textureAnimationModule.enable&&i._textureAnimationModule.init(s);var l=i.startSpeed.evaluate(o,c);yi.multiplyScalar(s.velocity,s.velocity,l),i.simulationSpace===Bfe.World&&(yi.transformMat4(s.position,s.position,OEe),yi.transformQuat(s.velocity,s.velocity,DEe)),yi.copy(s.ultimateVelocity,s.velocity),yi.set(s.rotation,0,0,0),i.startSize3D?yi.set(s.startSize,i.startSizeX.evaluate(o,c),i.startSizeY.evaluate(o,c),i.startSizeZ.evaluate(o,c)):(yi.set(s.startSize,i.startSizeX.evaluate(o,c),1,1),s.startSize.y=s.startSize.x),yi.copy(s.size,s.startSize),s.startLifetime=i.startLifetime.evaluate(o,c)+t,s.remainingLifetime=s.startLifetime,n.push(s)}},t._updateParticles=function(e,t){var n=this,i=this._particleSystem;switch(i.node.getWorldMatrix(OEe),i.scaleSpace){case Bfe.Local:i.node.getScale(MEe);break;case Bfe.World:i.node.getWorldScale(MEe)}if(this._updateList.forEach((function(e){e.update(i.simulationSpace,OEe)})),i.simulationSpace===Bfe.Local){var r=i.node.getRotation();Ni.fromQuat(this._localMat,r),this._localMat.transpose()}for(var o=function(r){var o=t[r];if(o.remainingLifetime-=e,yi.set(o.animatedVelocity,0,0,0),i.simulationSpace===Bfe.Local){var a=9.8*-i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,ai(o.randomSeed))*e;n._gravity.x=0,n._gravity.y=a,n._gravity.z=0,n._gravity.w=1,n._gravity=n._gravity.transformMat4(n._localMat),o.velocity.x+=n._gravity.x,o.velocity.y+=n._gravity.y,o.velocity.z+=n._gravity.z}else o.velocity.y-=9.8*i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,ai(o.randomSeed))*e;yi.copy(o.ultimateVelocity,o.velocity),n._runAnimateList.forEach((function(t){t.animate(o,e)})),yi.scaleAndAdd(o.position,o.position,o.ultimateVelocity,e)},a=0;a<t.length;++a)o(a)},t._calculateBounding=function(e){var t=new yi,n=new yi,i=new yi,r=new yi,o=new yi(1,1,1);if(this._processor.getInfo().renderMode===Ufe.Mesh){var a=this._processor.getInfo().mesh;if(a&&a.struct.minPosition&&a.struct.maxPosition){var s=new zc;zc.fromPoints(s,a.struct.minPosition,a.struct.maxPosition);var c=Math.max(s.halfExtents.x,s.halfExtents.y,s.halfExtents.z);o.set(c,c,c)}}for(var l=0;l<this._particlesAll.length;++l){var u=this._particlesAll[l];yi.multiply(t,MEe,u.size),yi.multiply(t,t,o),n.set(u.position),this._particleSystem.simulationSpace!==Bfe.World&&yi.transformMat4(n,n,this._particleSystem.node._mat),e&&0===l?(yi.subtract(this.minPos,n,t),yi.add(this.maxPos,n,t)):(yi.subtract(i,n,t),yi.add(r,n,t),yi.min(this.minPos,this.minPos,i),yi.max(this.maxPos,this.maxPos,r))}},t.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var e=ai(oi(0,On));this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,e),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},t.clear=function(){this._particlesAll.length=0},t.destroy=function(){},e}(),BEe=new Ni,FEe=new Ai,zEe=Object.getOwnPropertyDescriptor(bF.prototype,"sharedMaterials"),UEe=function(t){return e({ParticleSystem:t,ParticleSystemComponent:t}),t}((Zye=sl("cc.ParticleSystem"),Jye=El(),$ye=yl(),eSe=ll(99),tSe=Nl(),nSe=Rl(),iSe=Hl(Vhe),rSe=Nl(),oSe=Rl(),aSe=Hl(Bfe),sSe=Nl(),cSe=Rl(),lSe=Nl(),uSe=Rl(),hSe=pl("startSize"),fSe=Il(),_Se=Hl(Nue),pSe=Nl(),dSe=Rl(),mSe=Hl(Nue),vSe=Il(),gSe=Nl(),ySe=Rl(),SSe=Hl(Nue),xSe=Il(),TSe=Nl(),ESe=Rl(),bSe=Hl(Nue),CSe=Il(),ASe=Nl(),wSe=Rl(),RSe=Nl(),ISe=Rl(),PSe=Hl(Nue),OSe=Il(),DSe=Nl(),MSe=Rl(),NSe=Hl(Nue),LSe=Il(),BSe=Nl(),FSe=Rl(),zSe=Hl(Nue),USe=pl("startRotation"),kSe=Il(),GSe=Nl(),HSe=Rl(),VSe=Hl(Nue),jSe=Il(),WSe=Nl(),qSe=Rl(),XSe=Hl(Nue),YSe=Il(),KSe=Nl(),QSe=Rl(),ZSe=Nl(),JSe=Rl(),$Se=Nl(),exe=Rl(),txe=Nl(),nxe=Rl(),ixe=Hl(Bfe),rxe=Nl(),oxe=Rl(),axe=Nl(),sxe=Rl(),cxe=Nl(),lxe=Rl(),uxe=Hl(Nue),hxe=Il(),fxe=Nl(),_xe=Rl(),pxe=Hl(Nue),dxe=Il(),mxe=Nl(),vxe=Rl(),gxe=Hl(Nue),yxe=Il(),Sxe=Nl(),xxe=Rl(),Txe=Hl([Vve]),Exe=Nl(),bxe=Rl(),Cxe=Hl(Boolean),Axe=Nl(),wxe=Rl(),Rxe=Hl(Ffe),Ixe=Nl(),Pxe=Rl(),Oxe=Hl(Number),Dxe=Nl(),Mxe=Rl(),Nxe=Hl(Number),Lxe=Nl(),Bxe=Rl(),Fxe=Hl(Number),zxe=Nl(),Uxe=Rl(),kxe=Nl(),Gxe=Rl(),Hxe=pl("enableCulling"),Vxe=Cl(),jxe=Hl(Ng),Wxe=wl(),qxe=Hl(Wfe),Xxe=Hl(Wfe),Yxe=Nl(),Kxe=Rl(),Qxe=Hl(Xve),Zxe=Hl(Xve),Jxe=Nl(),$xe=Rl(),eTe=Hl(Lve),tTe=Hl(Lve),nTe=Nl(),iTe=Rl(),rTe=Hl(Hve),oTe=Hl(Hve),aTe=Nl(),sTe=Rl(),cTe=Hl(cpe),lTe=Hl(cpe),uTe=Nl(),hTe=Rl(),fTe=Hl(fpe),_Te=Hl(fpe),pTe=Nl(),dTe=Rl(),mTe=Hl(Nve),vTe=Hl(Nve),gTe=Nl(),yTe=Rl(),STe=Hl(Uve),xTe=Hl(Uve),TTe=Nl(),ETe=Rl(),bTe=Hl(PEe),CTe=Hl(PEe),ATe=Nl(),wTe=Rl(),RTe=Hl(xEe),ITe=Nl(),PTe=Rl(),Zye(OTe=Jye(OTe=$ye(OTe=eSe(OTe=gl((SEe=yEe=function(e){function t(){var t;return q(t=e.call(this)||this,"startColor",MTe,V(t)),q(t,"scaleSpace",NTe,V(t)),q(t,"startSize3D",LTe,V(t)),q(t,"startSizeX",BTe,V(t)),q(t,"startSizeY",FTe,V(t)),q(t,"startSizeZ",zTe,V(t)),q(t,"startSpeed",UTe,V(t)),q(t,"startRotation3D",kTe,V(t)),q(t,"startRotationX",GTe,V(t)),q(t,"startRotationY",HTe,V(t)),q(t,"startRotationZ",VTe,V(t)),q(t,"startDelay",jTe,V(t)),q(t,"startLifetime",WTe,V(t)),q(t,"duration",qTe,V(t)),q(t,"loop",XTe,V(t)),q(t,"simulationSpeed",YTe,V(t)),q(t,"playOnAwake",KTe,V(t)),q(t,"gravityModifier",QTe,V(t)),q(t,"rateOverTime",ZTe,V(t)),q(t,"rateOverDistance",JTe,V(t)),q(t,"bursts",$Te,V(t)),q(t,"_renderCulling",eEe,V(t)),q(t,"_cullingMode",tEe,V(t)),q(t,"_aabbHalfX",nEe,V(t)),q(t,"_aabbHalfY",iEe,V(t)),q(t,"_aabbHalfZ",rEe,V(t)),q(t,"_dataCulling",oEe,V(t)),q(t,"_colorOverLifetimeModule",aEe,V(t)),q(t,"_shapeModule",sEe,V(t)),q(t,"_sizeOvertimeModule",cEe,V(t)),q(t,"_velocityOvertimeModule",lEe,V(t)),q(t,"_forceOvertimeModule",uEe,V(t)),q(t,"_limitVelocityOvertimeModule",hEe,V(t)),q(t,"_rotationOvertimeModule",fEe,V(t)),q(t,"_textureAnimationModule",_Ee,V(t)),q(t,"_trailModule",pEe,V(t)),q(t,"renderer",dEe,V(t)),t._isPlaying=void 0,t._isPaused=void 0,t._isStopped=void 0,t._isEmitting=void 0,t._needRefresh=void 0,t._time=void 0,t._emitRateTimeCounter=void 0,t._emitRateDistanceCounter=void 0,t._oldWPos=void 0,t._curWPos=void 0,t._boundingBox=void 0,t._culler=void 0,t._oldPos=void 0,t._curPos=void 0,t._isCulled=void 0,t._customData1=void 0,t._customData2=void 0,t._subEmitters=void 0,q(t,"_prewarm",mEe,V(t)),q(t,"_capacity",vEe,V(t)),q(t,"_simulationSpace",gEe,V(t)),t.processor=null,t.rateOverTime.constant=10,t.startLifetime.constant=5,t.startSizeX.constant=1,t.startSpeed.constant=5,t._isPlaying=!1,t._isPaused=!1,t._isStopped=!0,t._isEmitting=!1,t._needRefresh=!0,t._time=0,t._emitRateTimeCounter=0,t._emitRateDistanceCounter=0,t._oldWPos=new yi,t._curWPos=new yi,t._boundingBox=null,t._culler=null,t._oldPos=null,t._curPos=null,t._isCulled=!1,t._customData1=new zi,t._customData2=new zi,t._subEmitters=[],t}F(t,e);var n=t.prototype;return n.onFocusInEditor=function(){this.renderer.create(this)},n.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},n._onMaterialModified=function(e,t){null!==this.processor&&this.processor.onMaterialModified(e,t)},n._onRebuildPSO=function(e,t){this.processor.onRebuildPSO(e,t)},n._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},n._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},n._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)},n.play=function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play()},n.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},n.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0},n.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!0)},n.getParticleCount=function(){return this.processor.getParticleCount()},n.setCustomData1=function(e,t){zi.set(this._customData1,e,t)},n.setCustomData2=function(e,t){zi.set(this._customData2,e,t)},n.onDestroy=function(){i.director.off(i.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n.onEnable=function(){i.director.on(i.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},n.onDisable=function(){i.director.off(i.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},n._calculateBounding=function(e){this._boundingBox&&(this._culler||(this._culler=new LEe(this)),this._culler.calculatePositions(),zc.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),e?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},n.update=function(e){var t=e*this.simulationSpeed;if(this.renderCulling){var n;if(this._boundingBox||(this._boundingBox=new zc,this._calculateBounding(!1)),this._curPos||(this._curPos=new yi),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new yi,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var i=this._curPos.x-this._oldPos.x,r=this._curPos.y-this._oldPos.y,o=this._curPos.z-this._oldPos.z,a=this._boundingBox.center;a.x+=i,a.y+=r,a.z+=o,this._culler.setBoundingBoxCenter(a.x,a.y,a.z),this._oldPos.set(this._curPos)}var s=null===(n=this.node.scene.renderScene)||void 0===n?void 0:n.cameras,c=!0;if(void 0!==s&&this._boundingBox)for(var l=0;l<s.length;++l){var u=s[l];if((u.visibility&this.node.layer)===this.node.layer&&rc.aabbFrustum(this._boundingBox,u.frustum)){c=!1;break}}if(c){if(this._cullingMode!==Ffe.AlwaysSimulate&&this.pause(),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===Ffe.PauseAndCatchup&&(this._time+=t),this._cullingMode!==Ffe.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isPlaying||this.play()}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null);this._isPlaying?(this._time+=t,this._emit(t),0!==this.processor.updateParticles(t)||this._isEmitting||this.stop()):(this.processor.updateRotation(),this.processor.updateScale()),this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData()},n.beforeRender=function(){this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender())},n._onVisibilityChange=function(e){this.processor._model&&(this.processor._model.visFlags=e)},n.emit=function(e,t){var n=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(ig.POSITION),this._needRefresh=!1),this._simulationSpace===Bfe.World&&(this.node.getWorldMatrix(BEe),this.node.getWorldRotation(FEe));for(var i=0;i<e;++i){var r=this.processor.getFreeParticle();if(null===r)return;r.particleSystem=this,r.reset();var o=ai(oi(0,On));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(r):(yi.set(r.position,0,0,0),yi.copy(r.velocity,qfe)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(r);var a=this.startSpeed.evaluate(n,o);yi.multiplyScalar(r.velocity,r.velocity,a),this._simulationSpace===Bfe.World&&(yi.transformMat4(r.position,r.position,BEe),yi.transformQuat(r.velocity,r.velocity,FEe)),yi.copy(r.ultimateVelocity,r.velocity),this.startRotation3D?r.startEuler.set(this.startRotationX.evaluate(n,o),this.startRotationY.evaluate(n,o),this.startRotationZ.evaluate(n,o)):r.startEuler.set(0,0,this.startRotationZ.evaluate(n,o)),yi.set(r.rotation,r.startEuler.x,r.startEuler.y,r.startEuler.z),this.startSize3D?yi.set(r.startSize,this.startSizeX.evaluate(n,o),this.startSizeY.evaluate(n,o),this.startSizeZ.evaluate(n,o)):(yi.set(r.startSize,this.startSizeX.evaluate(n,o),1,1),r.startSize.y=r.startSize.x),yi.copy(r.size,r.startSize),r.startColor.set(this.startColor.evaluate(n,o)),r.color.set(r.startColor),r.startLifetime=this.startLifetime.evaluate(n,o)+t,r.remainingLifetime=r.startLifetime,r.randomSeed=oi(0,233280),r.loopCount++,this.processor.setNewParticle(r)}},n._prewarmSystem=function(){this.startDelay.mode=Mue.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.processor.updateParticles(1)},n._emit=function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,this._emitRateTimeCounter>1&&this._isEmitting){var n=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=n,this.emit(n,e)}this.node.getWorldPosition(this._curWPos);var i=yi.distance(this._curWPos,this._oldWPos);if(yi.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=i*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}for(var o,a=W(this.bursts);!(o=a()).done;)o.value.update(this,e)}},n._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),yi.copy(this._curWPos,this._oldWPos)},n.addSubEmitter=function(e){this._subEmitters.push(e)},n.removeSubEmitter=function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)},n.addBurst=function(e){this.bursts.push(e)},n.removeBurst=function(e){this.bursts.splice(this.bursts.indexOf(e),1)},n.getBoundingX=function(){return this._aabbHalfX},n.getBoundingY=function(){return this._aabbHalfY},n.getBoundingZ=function(){return this._aabbHalfZ},n.setBoundingX=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=e)},n.setBoundingY=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=e)},n.setBoundingZ=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=e)},n._onBeforeSerialize=function(e){var t=this;return this.dataCulling?e.filter((function(e){return!Nfe.includes(e)||t[e]&&t[e].enable})):e},L(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=Math.floor(e),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(e){this._renderCulling=e,e&&(this._boundingBox||(this._boundingBox=new zc,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(e){this._cullingMode=e}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(e){this.setBoundingX(e)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(e){this.setBoundingY(e)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(e){this.setBoundingZ(e)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(e){this._dataCulling=e}},{key:"sharedMaterials",get:function(){return zEe.get.call(this)},set:function(e){zEe.set.call(this,e)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(e){e&&(this._colorOverLifetimeModule=e)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(e){e&&(this._shapeModule=e)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(e){e&&(this._sizeOvertimeModule=e)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(e){e&&(this._velocityOvertimeModule=e)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(e){e&&(this._forceOvertimeModule=e)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(e){e&&(this._limitVelocityOvertimeModule=e)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(e){e&&(this._rotationOvertimeModule=e)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(e){e&&(this._textureAnimationModule=e)}},{key:"trailModule",get:function(){return this._trailModule},set:function(e){e&&(this._trailModule=e)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}(bF),yEe.CullingMode=Ffe,X((DTe=SEe).prototype,"capacity",[tSe,nSe],Object.getOwnPropertyDescriptor(DTe.prototype,"capacity"),DTe.prototype),MTe=X(DTe.prototype,"startColor",[iSe,_l,rSe,oSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vhe}}),NTe=X(DTe.prototype,"scaleSpace",[aSe,_l,sSe,cSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bfe.Local}}),LTe=X(DTe.prototype,"startSize3D",[_l,lSe,uSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BTe=X(DTe.prototype,"startSizeX",[hSe,fSe,_Se,pSe,dSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),FTe=X(DTe.prototype,"startSizeY",[mSe,_l,vSe,gSe,ySe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),zTe=X(DTe.prototype,"startSizeZ",[SSe,_l,xSe,TSe,ESe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),UTe=X(DTe.prototype,"startSpeed",[bSe,_l,CSe,ASe,wSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),kTe=X(DTe.prototype,"startRotation3D",[_l,RSe,ISe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GTe=X(DTe.prototype,"startRotationX",[PSe,_l,OSe,Ll,DSe,MSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),HTe=X(DTe.prototype,"startRotationY",[NSe,_l,LSe,Ll,BSe,FSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),VTe=X(DTe.prototype,"startRotationZ",[zSe,USe,kSe,Ll,GSe,HSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),jTe=X(DTe.prototype,"startDelay",[VSe,_l,jSe,WSe,qSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),WTe=X(DTe.prototype,"startLifetime",[XSe,_l,YSe,KSe,QSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),qTe=X(DTe.prototype,"duration",[_l,ZSe,JSe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),XTe=X(DTe.prototype,"loop",[_l,$Se,exe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X(DTe.prototype,"prewarm",[txe,nxe],Object.getOwnPropertyDescriptor(DTe.prototype,"prewarm"),DTe.prototype),X(DTe.prototype,"simulationSpace",[ixe,_l,rxe,oxe],Object.getOwnPropertyDescriptor(DTe.prototype,"simulationSpace"),DTe.prototype),YTe=X(DTe.prototype,"simulationSpeed",[_l,axe,sxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),KTe=X(DTe.prototype,"playOnAwake",[_l,cxe,lxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),QTe=X(DTe.prototype,"gravityModifier",[uxe,_l,hxe,fxe,_xe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),ZTe=X(DTe.prototype,"rateOverTime",[pxe,_l,dxe,mxe,vxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),JTe=X(DTe.prototype,"rateOverDistance",[gxe,_l,yxe,Sxe,xxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nue}}),$Te=X(DTe.prototype,"bursts",[Txe,_l,Exe,bxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),X(DTe.prototype,"renderCulling",[Cxe,Axe,wxe],Object.getOwnPropertyDescriptor(DTe.prototype,"renderCulling"),DTe.prototype),eEe=X(DTe.prototype,"_renderCulling",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(DTe.prototype,"cullingMode",[Rxe,Ixe,Pxe],Object.getOwnPropertyDescriptor(DTe.prototype,"cullingMode"),DTe.prototype),tEe=X(DTe.prototype,"_cullingMode",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ffe.Pause}}),X(DTe.prototype,"aabbHalfX",[Oxe,Dxe,Mxe],Object.getOwnPropertyDescriptor(DTe.prototype,"aabbHalfX"),DTe.prototype),nEe=X(DTe.prototype,"_aabbHalfX",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(DTe.prototype,"aabbHalfY",[Nxe,Lxe,Bxe],Object.getOwnPropertyDescriptor(DTe.prototype,"aabbHalfY"),DTe.prototype),iEe=X(DTe.prototype,"_aabbHalfY",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(DTe.prototype,"aabbHalfZ",[Fxe,zxe,Uxe],Object.getOwnPropertyDescriptor(DTe.prototype,"aabbHalfZ"),DTe.prototype),rEe=X(DTe.prototype,"_aabbHalfZ",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(DTe.prototype,"dataCulling",[kxe,Gxe],Object.getOwnPropertyDescriptor(DTe.prototype,"dataCulling"),DTe.prototype),oEe=X(DTe.prototype,"_dataCulling",[_l,Hxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X(DTe.prototype,"sharedMaterials",[Jl,Vxe,jxe,_l,Wxe],Object.getOwnPropertyDescriptor(DTe.prototype,"sharedMaterials"),DTe.prototype),aEe=X(DTe.prototype,"_colorOverLifetimeModule",[qxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(DTe.prototype,"colorOverLifetimeModule",[Xxe,Yxe,Kxe],Object.getOwnPropertyDescriptor(DTe.prototype,"colorOverLifetimeModule"),DTe.prototype),sEe=X(DTe.prototype,"_shapeModule",[Qxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(DTe.prototype,"shapeModule",[Zxe,Jxe,$xe],Object.getOwnPropertyDescriptor(DTe.prototype,"shapeModule"),DTe.prototype),cEe=X(DTe.prototype,"_sizeOvertimeModule",[eTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(DTe.prototype,"sizeOvertimeModule",[tTe,nTe,iTe],Object.getOwnPropertyDescriptor(DTe.prototype,"sizeOvertimeModule"),DTe.prototype),lEe=X(DTe.prototype,"_velocityOvertimeModule",[rTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(DTe.prototype,"velocityOvertimeModule",[oTe,aTe,sTe],Object.getOwnPropertyDescriptor(DTe.prototype,"velocityOvertimeModule"),DTe.prototype),uEe=X(DTe.prototype,"_forceOvertimeModule",[cTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(DTe.prototype,"forceOvertimeModule",[lTe,uTe,hTe],Object.getOwnPropertyDescriptor(DTe.prototype,"forceOvertimeModule"),DTe.prototype),hEe=X(DTe.prototype,"_limitVelocityOvertimeModule",[fTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(DTe.prototype,"limitVelocityOvertimeModule",[_Te,pTe,dTe],Object.getOwnPropertyDescriptor(DTe.prototype,"limitVelocityOvertimeModule"),DTe.prototype),fEe=X(DTe.prototype,"_rotationOvertimeModule",[mTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(DTe.prototype,"rotationOvertimeModule",[vTe,gTe,yTe],Object.getOwnPropertyDescriptor(DTe.prototype,"rotationOvertimeModule"),DTe.prototype),_Ee=X(DTe.prototype,"_textureAnimationModule",[STe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(DTe.prototype,"textureAnimationModule",[xTe,TTe,ETe],Object.getOwnPropertyDescriptor(DTe.prototype,"textureAnimationModule"),DTe.prototype),pEe=X(DTe.prototype,"_trailModule",[bTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),X(DTe.prototype,"trailModule",[CTe,ATe,wTe],Object.getOwnPropertyDescriptor(DTe.prototype,"trailModule"),DTe.prototype),dEe=X(DTe.prototype,"renderer",[RTe,_l,ITe,PTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xEe}}),mEe=X(DTe.prototype,"_prewarm",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vEe=X(DTe.prototype,"_capacity",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),gEe=X(DTe.prototype,"_simulationSpace",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bfe.Local}}),OTe=DTe))||OTe)||OTe)||OTe)||OTe)||OTe)),kEe=e("ParticleUtils",function(){function e(){}return e.instantiate=function(e){return this.registeredSceneEvent||(eN.on($M.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new We((function(){return af(e)||new eA}),1,(function(e){return e.destroy()}))),this.particleSystemPool.get(e._uuid).alloc()},e.destroy=function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))},e.play=function(e){for(var t,n=W(e.getComponentsInChildren(UEe));!(t=n()).done;)t.value.play()},e.stop=function(e){for(var t,n=W(e.getComponentsInChildren(UEe));!(t=n()).done;)t.value.stop()},e.onSceneUnload=function(){this.particleSystemPool.forEach((function(e){return e.destroy()})),this.particleSystemPool.clear()},e}());function GEe(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}kEe.particleSystemPool=new Map,kEe.registeredSceneEvent=!1,Un(Vve.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),zn(UEe.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),i.ParticleSystemComponent=UEe,He.setClassAlias(UEe,"cc.ParticleSystemComponent"),i.BillboardComponent=wue,He.setClassAlias(wue,"cc.BillboardComponent"),i.LineComponent=Xhe,He.setClassAlias(Xhe,"cc.LineComponent"),i.ParticleUtils=kEe;var HEe,VEe,jEe,WEe,qEe,XEe,YEe,KEe=function(e,t){return function(e){e.exports=function e(t,n,i){function r(a,s){if(!n[a]){if(!t[a]){if(!s&&GEe)return GEe();if(o)return o(a,!0);throw new Error("Cannot find module '"+a+"'")}var c=n[a]={exports:{}};t[a][0].call(c.exports,(function(e){return r(t[a][1][e]||e)}),c,c.exports,e,t,n,i)}return n[a].exports}for(var o=GEe,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(e,t){t.exports={name:"@cocos/cannon",version:"1.2.8",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se), JayceLai",keywords:["cannon.js","cocos","creator","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -c -m",postpublish:"cnpm sync @cocos/cannon"},main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Transform:e("./math/Transform"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World"),Octree:e("./utils/Octree")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Octree":51,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(e,t){var n=e("../math/Vec3");function i(e){e=e||{},this.lowerBound=new n,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new n,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=i;var r=new n;i.prototype.setFromPoints=function(e,t,n,i){var o=this.lowerBound,a=this.upperBound,s=n;o.copy(e[0]),s&&s.vmult(o,o),a.copy(o);for(var c=1;c<e.length;c++){var l=e[c];s&&(s.vmult(l,r),l=r),l.x>a.x&&(a.x=l.x),l.x<o.x&&(o.x=l.x),l.y>a.y&&(a.y=l.y),l.y<o.y&&(o.y=l.y),l.z>a.z&&(a.z=l.z),l.z<o.z&&(o.z=l.z)}return t&&(t.vadd(o,o),t.vadd(a,a)),i&&(o.x-=i,o.y-=i,o.z-=i,a.x+=i,a.y+=i,a.z+=i),this},i.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},i.prototype.clone=function(){return(new i).copy(this)},i.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},i.prototype.overlaps=function(e){var t=this.lowerBound,n=this.upperBound,i=e.lowerBound,r=e.upperBound,o=i.x<=n.x&&n.x<=r.x||t.x<=r.x&&r.x<=n.x,a=i.y<=n.y&&n.y<=r.y||t.y<=r.y&&r.y<=n.y,s=i.z<=n.z&&n.z<=r.z||t.z<=r.z&&r.z<=n.z;return o&&a&&s},i.prototype.volume=function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)},i.prototype.contains=function(e){var t=this.lowerBound,n=this.upperBound,i=e.lowerBound,r=e.upperBound;return t.x<=i.x&&n.x>=r.x&&t.y<=i.y&&n.y>=r.y&&t.z<=i.z&&n.z>=r.z},i.prototype.getCorners=function(e,t,n,i,r,o,a,s){var c=this.lowerBound,l=this.upperBound;e.copy(c),t.set(l.x,c.y,c.z),n.set(l.x,l.y,c.z),i.set(c.x,l.y,l.z),r.set(l.x,c.y,l.z),o.set(c.x,l.y,c.z),a.set(c.x,c.y,l.z),s.copy(l)};var o=[new n,new n,new n,new n,new n,new n,new n,new n];i.prototype.toLocalFrame=function(e,t){var n=o,i=n[0],r=n[1],a=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7];this.getCorners(i,r,a,s,c,l,u,h);for(var f=0;8!==f;f++){var _=n[f];e.pointToLocal(_,_)}return t.setFromPoints(n)},i.prototype.toWorldFrame=function(e,t){var n=o,i=n[0],r=n[1],a=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7];this.getCorners(i,r,a,s,c,l,u,h);for(var f=0;8!==f;f++){var _=n[f];e.pointToWorld(_,_)}return t.setFromPoints(n)},i.prototype.overlapsRay=function(e){var t=1/e._direction.x,n=1/e._direction.y,i=1/e._direction.z,r=(this.lowerBound.x-e.from.x)*t,o=(this.upperBound.x-e.from.x)*t,a=(this.lowerBound.y-e.from.y)*n,s=(this.upperBound.y-e.from.y)*n,c=(this.lowerBound.z-e.from.z)*i,l=(this.upperBound.z-e.from.z)*i,u=Math.max(Math.max(Math.min(r,o),Math.min(a,s)),Math.min(c,l)),h=Math.min(Math.min(Math.max(r,o),Math.max(a,s)),Math.max(c,l));return!(h<0||u>h)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(e,t){function n(){this.matrix=[]}t.exports=n,n.prototype.get=function(e,t){if(e=e.index,(t=t.index)>e){var n=t;t=e,e=n}return this.matrix[(e*(e+1)>>1)+t-1]},n.prototype.set=function(e,t,n){if(e=e.index,(t=t.index)>e){var i=t;t=e,e=i}this.matrix[(e*(e+1)>>1)+t-1]=n?1:0},n.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},n.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t){var n=e("../objects/Body"),i=e("../math/Vec3"),r=e("../math/Quaternion");function o(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),t.exports=o,o.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")},o.prototype.needBroadphaseCollision=function(e,t){if(0==(e.collisionFilterGroup&t.collisionFilterMask)||0==(t.collisionFilterGroup&e.collisionFilterMask))return!1;var i=0!=(e.type&n.STATIC),r=0!=(t.type&n.STATIC);return!(i&&r||!e.hasTrigger&&!t.hasTrigger&&e.sleepState===n.SLEEPING&&t.sleepState===n.SLEEPING)},o.prototype.intersectionTest=function(e,t,n,i){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,n,i):this.doBoundingSphereBroadphase(e,t,n,i)};var a=new i;new i,new r,new i,o.prototype.doBoundingSphereBroadphase=function(e,t,n,i){var r=a;t.position.vsub(e.position,r);var o=Math.pow(e.boundingRadius+t.boundingRadius,2);r.norm2()<o&&(n.push(e),i.push(t))},o.prototype.doBoundingBoxBroadphase=function(e,t,n,i){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(n.push(e),i.push(t))};var s={keys:[]},c=[],l=[];o.prototype.makePairsUnique=function(e,t){for(var n=s,i=c,r=l,o=e.length,a=0;a!==o;a++)i[a]=e[a],r[a]=t[a];for(e.length=0,t.length=0,a=0;a!==o;a++){var u=i[a].id,h=r[a].id;n[f=u<h?u+","+h:h+","+u]=a,n.keys.push(f)}for(a=0;a!==n.keys.length;a++){var f=n.keys.pop(),_=n[f];e.push(i[_]),t.push(r[_]),delete n[f]}},o.prototype.setWorld=function(){};var u=new i;o.boundingSphereCheck=function(e,t){var n=u;return e.position.vsub(t.position,n),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>n.norm2()},o.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(e,t){t.exports=o;var n=e("./Broadphase"),i=e("../math/Vec3"),r=e("../shapes/Shape");function o(e,t,r,o,a){n.apply(this),this.nx=r||10,this.ny=o||10,this.nz=a||10,this.aabbMin=e||new i(100,100,100),this.aabbMax=t||new i(-100,-100,-100);var s=this.nx*this.ny*this.nz;if(s<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=s,this.binLengths.length=s;for(var c=0;c<s;c++)this.bins[c]=[],this.binLengths[c]=0}o.prototype=new n,o.prototype.constructor=o;var a=new i;new i,o.prototype.collisionPairs=function(e,t,n){for(var i=e.numObjects(),o=e.bodies,s=this.aabbMax,c=this.aabbMin,l=this.nx,u=this.ny,h=this.nz,f=u*h,_=h,p=1,d=s.x,m=s.y,v=s.z,g=c.x,y=c.y,S=c.z,x=l/(d-g),T=u/(m-y),E=h/(v-S),b=(d-g)/l,C=(m-y)/u,A=(v-S)/h,w=.5*Math.sqrt(b*b+C*C+A*A),R=r.types,I=R.SPHERE,P=R.PLANE,O=(R.BOX,R.COMPOUND,R.CONVEXPOLYHEDRON,this.bins),D=this.binLengths,M=this.bins.length,N=0;N!==M;N++)D[N]=0;var L=Math.ceil;function B(e,t,n,i,r,o,a){var s=(e-g)*x|0,c=(t-y)*T|0,d=(n-S)*E|0,m=L((i-g)*x),v=L((r-y)*T),b=L((o-S)*E);s<0?s=0:s>=l&&(s=l-1),c<0?c=0:c>=u&&(c=u-1),d<0?d=0:d>=h&&(d=h-1),m<0?m=0:m>=l&&(m=l-1),v<0?v=0:v>=u&&(v=u-1),b<0?b=0:b>=h&&(b=h-1),c*=_,d*=p,m*=f,v*=_,b*=p;for(var C=s*=f;C<=m;C+=f)for(var A=c;A<=v;A+=_)for(var w=d;w<=b;w+=p){var R=C+A+w;O[R][D[R]++]=a}}for(c=Math.min,s=Math.max,N=0;N!==i;N++){var F=(ne=o[N]).shape;switch(F.type){case I:var z=ne.position.x,U=ne.position.y,k=ne.position.z,G=F.radius;B(z-G,U-G,k-G,z+G,U+G,k+G,ne);break;case P:F.worldNormalNeedsUpdate&&F.computeWorldNormal(ne.quaternion);var H=F.worldNormal,V=g+.5*b-ne.position.x,j=y+.5*C-ne.position.y,W=S+.5*A-ne.position.z,q=a;q.set(V,j,W);for(var X=0,Y=0;X!==l;X++,Y+=f,q.y=j,q.x+=b)for(var K=0,Q=0;K!==u;K++,Q+=_,q.z=W,q.y+=C)for(var Z=0,J=0;Z!==h;Z++,J+=p,q.z+=A)if(q.dot(H)<w){var $=Y+Q+J;O[$][D[$]++]=ne}break;default:ne.aabbNeedsUpdate&&ne.computeAABB(),B(ne.aabb.lowerBound.x,ne.aabb.lowerBound.y,ne.aabb.lowerBound.z,ne.aabb.upperBound.x,ne.aabb.upperBound.y,ne.aabb.upperBound.z,ne)}}for(N=0;N!==M;N++){var ee=D[N];if(ee>1){var te=O[N];for(X=0;X!==ee;X++){var ne=te[X];for(K=0;K!==X;K++){var ie=te[K];this.needBroadphaseCollision(ne,ie)&&this.intersectionTest(ne,ie,t,n)}}}}this.makePairsUnique(t,n)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(e,t){t.exports=r;var n=e("./Broadphase"),i=e("./AABB");function r(){n.apply(this)}r.prototype=new n,r.prototype.constructor=r,r.prototype.collisionPairs=function(e,t,n){var i,r,o,a,s=e.bodies,c=s.length;for(i=0;i!==c;i++)for(r=0;r!==i;r++)o=s[i],a=s[r],this.needBroadphaseCollision(o,a)&&this.intersectionTest(o,a,t,n)},new i,r.prototype.aabbQuery=function(e,t,n){n=n||[];for(var i=0;i<e.bodies.length;i++){var r=e.bodies[i];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(t)&&n.push(r)}return n}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t){function n(){this.matrix={}}t.exports=n,n.prototype.get=function(e,t){if(e=e.id,(t=t.id)>e){var n=t;t=e,e=n}return e+"-"+t in this.matrix},n.prototype.set=function(e,t,n){if(e=e.id,(t=t.id)>e){var i=t;t=e,e=i}n?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(){}},{}],9:[function(e,t){function n(){this.current=[],this.previous=[]}function i(e,t){e.push((4294901760&t)>>16,65535&t)}t.exports=n,n.prototype.getKey=function(e,t){if(t<e){var n=t;t=e,e=n}return e<<16|t},n.prototype.set=function(e,t){for(var n=this.getKey(e,t),i=this.current,r=0;n>i[r];)r++;if(n!==i[r]){for(t=i.length-1;t>=r;t--)i[t+1]=i[t];i[r]=n}},n.prototype.tick=function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0},n.prototype.getDiff=function(e,t){for(var n=this.current,r=this.previous,o=n.length,a=r.length,s=0,c=0;c<o;c++){for(var l=n[c];l>r[s];)s++;l===r[s]||i(e,l)}for(s=0,c=0;c<a;c++){for(var u=r[c];u>n[s];)s++;n[s]===u||i(t,u)}}},{}],10:[function(e,t){t.exports=c;var n=e("../math/Vec3"),i=e("../math/Quaternion"),r=e("../math/Transform"),o=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),a=e("../shapes/Shape"),s=e("../collision/AABB");function c(e,t){this.from=e?e.clone():new n,this.to=t?t.clone():new n,this._direction=new n,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new o,this.hasHit=!1,this.callback=function(){}}c.prototype.constructor=c,c.CLOSEST=1,c.ANY=2,c.ALL=4;var l=new s,u=[];c.prototype.intersectWorld=function(e,t){return this.mode=t.mode||c.ANY,this.result=t.result||new o,this.skipBackfaces=!!t.skipBackfaces,this.checkCollisionResponse=!!t.checkCollisionResponse,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(l),u.length=0,e.broadphase.aabbQuery(e,l,u),this.intersectBodies(u),this.hasHit};var h=new n,f=new n;function _(e,t,n,i){i.vsub(t,B),n.vsub(t,h),e.vsub(t,f);var r,o,a=B.dot(B),s=B.dot(h),c=B.dot(f),l=h.dot(h),u=h.dot(f);return(r=l*c-s*u)>=0&&(o=a*u-s*c)>=0&&r+o<a*l-s*s}c.pointInTriangle=_;var p=new n,d=new i;c.prototype.intersectBody=function(e,t){if(t&&(this.result=t,this._updateDirection()),(!this.checkCollisionResponse||e.collisionResponse)&&c.perBodyFilter(this,e))for(var n=p,i=d,r=0,o=e.shapes.length;r<o;r++){var a=e.shapes[r];if(c.perShapeFilter(this,a)&&(e.quaternion.mult(e.shapeOrientations[r],i),e.quaternion.vmult(e.shapeOffsets[r],n),n.vadd(e.position,n),this.intersectShape(a,i,n,e),this.result._shouldStop))break}},c.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var n=0,i=e.length;!this.result._shouldStop&&n<i;n++)this.intersectBody(e[n])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(e,t,n,i){if(!(z(this.from,this._direction,n)>e.boundingSphereRadius)){var r=this[e.type];r&&r.call(this,e,t,n,i,e)}},new n,new n;var m=new n,v=new n,g=new n,y=new n;new n,new o,c.prototype.intersectBox=function(e,t,n,i,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,n,i,r)},c.prototype[a.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(e,t,i,r,o){var a=this.from,s=this.to,c=this._direction,l=new n(0,0,1);t.vmult(l,l);var u=new n;a.vsub(i,u);var h=u.dot(l);if(s.vsub(i,u),!(h*u.dot(l)>0||a.distanceTo(s)<h)){var f=l.dot(c);if(!(Math.abs(f)<this.precision)){var _=new n,p=new n,d=new n;a.vsub(i,_);var m=-l.dot(_)/f;c.scale(m,p),a.vadd(p,d),this.reportIntersection(l,d,o,r,-1)}}},c.prototype[a.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(e){var t=this.to,n=this.from;e.lowerBound.x=Math.min(t.x,n.x),e.lowerBound.y=Math.min(t.y,n.y),e.lowerBound.z=Math.min(t.z,n.z),e.upperBound.x=Math.max(t.x,n.x),e.upperBound.y=Math.max(t.y,n.y),e.upperBound.z=Math.max(t.z,n.z)};var S={faceList:[0]},x=new n,T=new c,E=[];c.prototype.intersectHeightfield=function(e,t,n,i,o){e.data,e.elementSize;var a=T;a.from.copy(this.from),a.to.copy(this.to),r.pointToLocalFrame(n,t,a.from,a.from),r.pointToLocalFrame(n,t,a.to,a.to),a._updateDirection();var c,l,u,h,f=E;c=l=0,u=h=e.data.length-1;var _=new s;a.getAABB(_),e.getIndexOfPosition(_.lowerBound.x,_.lowerBound.y,f,!0),c=Math.max(c,f[0]),l=Math.max(l,f[1]),e.getIndexOfPosition(_.upperBound.x,_.upperBound.y,f,!0),u=Math.min(u,f[0]+1),h=Math.min(h,f[1]+1);for(var p=c;p<u;p++)for(var d=l;d<h;d++){if(this.result._shouldStop)return;if(e.getAabbAtIndex(p,d,_),_.overlapsRay(a)){if(e.getConvexTrianglePillar(p,d,!1),r.pointToWorldFrame(n,t,e.pillarOffset,x),this.intersectConvex(e.pillarConvex,t,x,i,o,S),this.result._shouldStop)return;e.getConvexTrianglePillar(p,d,!0),r.pointToWorldFrame(n,t,e.pillarOffset,x),this.intersectConvex(e.pillarConvex,t,x,i,o,S)}}},c.prototype[a.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var b=new n,C=new n;c.prototype.intersectSphere=function(e,t,n,i,r){var o=this.from,a=this.to,s=e.radius,c=Math.pow(a.x-o.x,2)+Math.pow(a.y-o.y,2)+Math.pow(a.z-o.z,2),l=2*((a.x-o.x)*(o.x-n.x)+(a.y-o.y)*(o.y-n.y)+(a.z-o.z)*(o.z-n.z)),u=Math.pow(o.x-n.x,2)+Math.pow(o.y-n.y,2)+Math.pow(o.z-n.z,2)-Math.pow(s,2),h=Math.pow(l,2)-4*c*u,f=b,_=C;if(!(h<0))if(0===h)o.lerp(a,h,f),f.vsub(n,_),_.normalize(),this.reportIntersection(_,f,r,i,-1);else{var p=(-l-Math.sqrt(h))/(2*c),d=(-l+Math.sqrt(h))/(2*c);if(p>=0&&p<=1&&(o.lerp(a,p,f),f.vsub(n,_),_.normalize(),this.reportIntersection(_,f,r,i,-1)),this.result._shouldStop)return;d>=0&&d<=1&&(o.lerp(a,d,f),f.vsub(n,_),_.normalize(),this.reportIntersection(_,f,r,i,-1))}},c.prototype[a.types.SPHERE]=c.prototype.intersectSphere;var A=new n,w=(new n,new n,new n);c.prototype.intersectConvex=function(e,t,n,i,r,o){for(var a=A,s=w,c=o&&o.faceList||null,l=e.faces,u=e.vertices,h=e.faceNormals,f=this._direction,p=this.from,d=this.to,S=p.distanceTo(d),x=c?c.length:l.length,T=this.result,E=0;!T._shouldStop&&E<x;E++){var b=c?c[E]:E,C=l[b],R=h[b],I=t,P=n;s.copy(u[C[0]]),I.vmult(s,s),s.vadd(P,s),s.vsub(p,s),I.vmult(R,a);var O=f.dot(a);if(!(Math.abs(O)<this.precision)){var D=a.dot(s)/O;if(!(D<0)){f.mult(D,m),m.vadd(p,m),v.copy(u[C[0]]),I.vmult(v,v),P.vadd(v,v);for(var M=1;!T._shouldStop&&M<C.length-1;M++){g.copy(u[C[M]]),y.copy(u[C[M+1]]),I.vmult(g,g),I.vmult(y,y),P.vadd(g,g),P.vadd(y,y);var N=m.distanceTo(p);!_(m,v,g,y)&&!_(m,g,v,y)||N>S||this.reportIntersection(a,m,r,i,b)}}}}},c.prototype[a.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var R=new n,I=new n,P=new n,O=new n,D=new n,M=new n,N=(new s,[]),L=new r;c.prototype.intersectTrimesh=function(e,t,n,i,o,a){var s=R,c=N,l=L,u=w,h=I,f=P,p=O,d=M,S=D,x=(a&&a.faceList,e.indices),T=(e.vertices,e.faceNormals,this.from),E=this.to,b=this._direction;l.position.copy(n),l.quaternion.copy(t),r.vectorToLocalFrame(n,t,b,h),r.pointToLocalFrame(n,t,T,f),r.pointToLocalFrame(n,t,E,p),p.x*=e.scale.x,p.y*=e.scale.y,p.z*=e.scale.z,f.x*=e.scale.x,f.y*=e.scale.y,f.z*=e.scale.z,p.vsub(f,h),h.normalize();var C=f.distanceSquared(p);e.tree.rayQuery(this,l,c);for(var A=0,B=c.length;!this.result._shouldStop&&A!==B;A++){var F=c[A];e.getNormal(F,s),e.getVertex(x[3*F],v),v.vsub(f,u);var z=h.dot(s),U=s.dot(u)/z;if(!(U<0)){h.scale(U,m),m.vadd(f,m),e.getVertex(x[3*F+1],g),e.getVertex(x[3*F+2],y);var k=m.distanceSquared(f);!_(m,g,v,y)&&!_(m,v,g,y)||k>C||(r.vectorToWorldFrame(t,s,S),r.pointToWorldFrame(n,t,m,d),this.reportIntersection(S,d,o,i,F))}}c.length=0},c.prototype[a.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(e,t,n,i,r){var o=this.from,a=this.to,s=o.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&e.dot(this._direction)>0))switch(l.hitFaceIndex=void 0!==r?r:-1,this.mode){case c.ALL:this.hasHit=!0,l.set(o,a,e,t,n,i,s),l.hasHit=!0,this.callback(l);break;case c.CLOSEST:(s<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(o,a,e,t,n,i,s));break;case c.ANY:this.hasHit=!0,l.hasHit=!0,l.set(o,a,e,t,n,i,s),l._shouldStop=!0}};var B=new n,F=new n;function z(e,t,n){n.vsub(e,B);var i=B.dot(t);return t.mult(i,F),F.vadd(e,F),n.distanceTo(F)}c.perBodyFilter=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)},c.perShapeFilter=function(e,t){return!(e.checkCollisionResponse&&!t.collisionResponse)}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(e,t){var n=e("../math/Vec3");function i(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}t.exports=i,i.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},i.prototype.abort=function(){this._shouldStop=!0},i.prototype.set=function(e,t,n,i,r,o,a){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(n),this.hitPointWorld.copy(i),this.shape=r,this.body=o,this.distance=a}},{"../math/Vec3":31}],12:[function(e,t){e("../shapes/Shape");var n=e("../collision/Broadphase");function i(e){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(e){t.push(e.body)},this._removeBodyHandler=function(e){var n=t.indexOf(e.body);-1!==n&&t.splice(n,1)},e&&this.setWorld(e)}t.exports=i,i.prototype=new n,i.prototype.setWorld=function(e){this.axisList.length=0;for(var t=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},i.insertionSortX=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],r=t-1;r>=0&&!(e[r].aabb.lowerBound.x<=i.aabb.lowerBound.x);r--)e[r+1]=e[r];e[r+1]=i}return e},i.insertionSortY=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],r=t-1;r>=0&&!(e[r].aabb.lowerBound.y<=i.aabb.lowerBound.y);r--)e[r+1]=e[r];e[r+1]=i}return e},i.insertionSortZ=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],r=t-1;r>=0&&!(e[r].aabb.lowerBound.z<=i.aabb.lowerBound.z);r--)e[r+1]=e[r];e[r+1]=i}return e},i.prototype.collisionPairs=function(e,t,n){var r,o,a=this.axisList,s=a.length,c=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),r=0;r!==s;r++){var l=a[r];for(o=r+1;o<s;o++){var u=a[o];if(this.needBroadphaseCollision(l,u)){if(!i.checkBounds(l,u,c))break;this.intersectionTest(l,u,t,n)}}}},i.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,n=e.length,r=0;r!==n;r++){var o=e[r];o.aabbNeedsUpdate&&o.computeAABB()}0===t?i.insertionSortX(e):1===t?i.insertionSortY(e):2===t&&i.insertionSortZ(e)},i.checkBounds=function(e,t,n){var i,r;0===n?(i=e.position.x,r=t.position.x):1===n?(i=e.position.y,r=t.position.y):2===n&&(i=e.position.z,r=t.position.z);var o=e.boundingRadius;return r-t.boundingRadius<i+o},i.prototype.autoDetectAxis=function(){for(var e=0,t=0,n=0,i=0,r=0,o=0,a=this.axisList,s=a.length,c=1/s,l=0;l!==s;l++){var u=a[l],h=u.position.x;e+=h,t+=h*h;var f=u.position.y;n+=f,i+=f*f;var _=u.position.z;r+=_,o+=_*_}var p=t-e*e*c,d=i-n*n*c,m=o-r*r*c;this.axisIndex=p>d?p>m?0:2:d>m?1:2},i.prototype.aabbQuery=function(e,t,n){n=n||[],this.dirty&&(this.sortList(),this.dirty=!1);var i=this.axisIndex,r="x";1===i&&(r="y"),2===i&&(r="z");for(var o=this.axisList,a=(t.lowerBound[r],t.upperBound[r],0);a<o.length;a++){var s=o[a];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(t)&&n.push(s)}return n}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(e,t){t.exports=a,e("./Constraint");var n=e("./PointToPointConstraint"),i=e("../equations/ConeEquation"),r=e("../equations/RotationalEquation"),o=(e("../equations/ContactEquation"),e("../math/Vec3"));function a(e,t,a){var s=void 0!==(a=a||{}).maxForce?a.maxForce:1e6,c=a.pivotA?a.pivotA.clone():new o,l=a.pivotB?a.pivotB.clone():new o;this.axisA=a.axisA?a.axisA.clone():new o,this.axisB=a.axisB?a.axisB.clone():new o,n.call(this,e,c,t,l,s),this.collideConnected=!!a.collideConnected,this.angle=void 0!==a.angle?a.angle:0;var u=this.coneEquation=new i(e,t,a),h=this.twistEquation=new r(e,t,a);this.twistAngle=void 0!==a.twistAngle?a.twistAngle:0,u.maxForce=0,u.minForce=-s,h.maxForce=0,h.minForce=-s,this.equations.push(u,h)}a.prototype=new n,a.constructor=a,new o,new o,a.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,r=this.twistEquation;n.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(r.axisA,r.axisA),e.vectorToWorldFrame(r.axisA,r.axisA),this.axisB.tangents(r.axisB,r.axisB),t.vectorToWorldFrame(r.axisB,r.axisB),i.angle=this.angle,r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(e,t){t.exports=i;var n=e("../utils/Utils");function i(e,t,r){r=n.defaults(r,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=i.idCounter++,this.collideConnected=r.collideConnected,r.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}i.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},i.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},i.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},i.idCounter=0},{"../utils/Utils":54}],15:[function(e,t){t.exports=r;var n=e("./Constraint"),i=e("../equations/ContactEquation");function r(e,t,r,o){n.call(this,e,t),void 0===r&&(r=e.position.distanceTo(t.position)),void 0===o&&(o=1e6),this.distance=r;var a=this.distanceEquation=new i(e,t);this.equations.push(a),a.minForce=-o,a.maxForce=o}r.prototype=new n,r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.distanceEquation,i=.5*this.distance,r=n.ni;t.position.vsub(e.position,r),r.normalize(),r.mult(i,n.ri),r.mult(-i,n.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(e,t){t.exports=a,e("./Constraint");var n=e("./PointToPointConstraint"),i=e("../equations/RotationalEquation"),r=e("../equations/RotationalMotorEquation"),o=(e("../equations/ContactEquation"),e("../math/Vec3"));function a(e,t,a){var s=void 0!==(a=a||{}).maxForce?a.maxForce:1e6,c=a.pivotA?a.pivotA.clone():new o,l=a.pivotB?a.pivotB.clone():new o;n.call(this,e,c,t,l,s),(this.axisA=a.axisA?a.axisA.clone():new o(1,0,0)).normalize(),(this.axisB=a.axisB?a.axisB.clone():new o(1,0,0)).normalize();var u=this.rotationalEquation1=new i(e,t,a),h=this.rotationalEquation2=new i(e,t,a),f=this.motorEquation=new r(e,t,s);f.enabled=!1,this.equations.push(u,h,f)}a.prototype=new n,a.constructor=a,a.prototype.enableMotor=function(){this.motorEquation.enabled=!0},a.prototype.disableMotor=function(){this.motorEquation.enabled=!1},a.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},a.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var s=new o,c=new o;a.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,r=this.rotationalEquation1,o=this.rotationalEquation2,a=s,l=c,u=this.axisA,h=this.axisB;n.prototype.update.call(this),e.quaternion.vmult(u,a),t.quaternion.vmult(h,l),a.tangents(r.axisA,o.axisA),r.axisB.copy(l),o.axisB.copy(l),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(e,t){t.exports=o,e("./Constraint");var n=e("./PointToPointConstraint"),i=e("../equations/RotationalEquation"),r=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function o(e,t,o){var a=void 0!==(o=o||{}).maxForce?o.maxForce:1e6,s=new r,c=new r,l=new r;e.position.vadd(t.position,l),l.scale(.5,l),t.pointToLocalFrame(l,c),e.pointToLocalFrame(l,s),n.call(this,e,s,t,c,a),this.xA=e.vectorToLocalFrame(r.UNIT_X),this.xB=t.vectorToLocalFrame(r.UNIT_X),this.yA=e.vectorToLocalFrame(r.UNIT_Y),this.yB=t.vectorToLocalFrame(r.UNIT_Y),this.zA=e.vectorToLocalFrame(r.UNIT_Z),this.zB=t.vectorToLocalFrame(r.UNIT_Z);var u=this.rotationalEquation1=new i(e,t,o),h=this.rotationalEquation2=new i(e,t,o),f=this.rotationalEquation3=new i(e,t,o);this.equations.push(u,h,f)}o.prototype=new n,o.constructor=o,new r,new r,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,o=this.rotationalEquation3;n.prototype.update.call(this),e.vectorToWorldFrame(this.xA,i.axisA),t.vectorToWorldFrame(this.yB,i.axisB),e.vectorToWorldFrame(this.yA,r.axisA),t.vectorToWorldFrame(this.zB,r.axisB),e.vectorToWorldFrame(this.zA,o.axisA),t.vectorToWorldFrame(this.xB,o.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(e,t){t.exports=o;var n=e("./Constraint"),i=e("../equations/ContactEquation"),r=e("../math/Vec3");function o(e,t,o,a,s){n.call(this,e,o),s=void 0!==s?s:1e6,this.pivotA=t?t.clone():new r,this.pivotB=a?a.clone():new r;var c=this.equationX=new i(e,o),l=this.equationY=new i(e,o),u=this.equationZ=new i(e,o);this.equations.push(c,l,u),c.minForce=l.minForce=u.minForce=-s,c.maxForce=l.maxForce=u.maxForce=s,c.ni.set(1,0,0),l.ni.set(0,1,0),u.ni.set(0,0,1)}o.prototype=new n,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.equationX,i=this.equationY,r=this.equationZ;e.quaternion.vmult(this.pivotA,n.ri),t.quaternion.vmult(this.pivotB,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),r.ri.copy(n.ri),r.rj.copy(n.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(e,t){t.exports=r;var n=e("../math/Vec3"),i=(e("../math/Mat3"),e("./Equation"));function r(e,t,r){var o=void 0!==(r=r||{}).maxForce?r.maxForce:1e6;i.call(this,e,t,-o,o),this.axisA=r.axisA?r.axisA.clone():new n(1,0,0),this.axisB=r.axisB?r.axisB.clone():new n(0,1,0),this.angle=void 0!==r.angle?r.angle:0}r.prototype=new i,r.prototype.constructor=r;var o=new n,a=new n;r.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.axisA,r=this.axisB,s=o,c=a,l=this.jacobianElementA,u=this.jacobianElementB;return i.cross(r,s),r.cross(i,c),l.rotational.copy(c),u.rotational.copy(s),-(Math.cos(this.angle)-i.dot(r))*t-this.computeGW()*n-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(e,t){t.exports=r;var n=e("./Equation"),i=e("../math/Vec3");function r(e,t,r){r=void 0!==r?r:1e6,n.call(this,e,t,0,r),this.si=null,this.sj=null,this.restitution=0,this.ri=new i,this.rj=new i,this.ni=new i}e("../math/Mat3"),r.prototype=new n,r.prototype.constructor=r;var o=new i,a=new i,s=new i;r.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.bi,r=this.bj,c=this.ri,l=this.rj,u=o,h=a,f=i.velocity,_=i.angularVelocity,p=(i.force,i.torque,r.velocity),d=r.angularVelocity,m=(r.force,r.torque,s),v=this.jacobianElementA,g=this.jacobianElementB,y=this.ni;c.cross(y,u),l.cross(y,h),y.negate(v.spatial),u.negate(v.rotational),g.spatial.copy(y),g.rotational.copy(h),m.copy(r.position),m.vadd(l,m),m.vsub(i.position,m),m.vsub(c,m);var S=y.dot(m),x=this.restitution+1;return-S*t-(x*p.dot(y)-x*f.dot(y)+d.dot(h)-_.dot(u))*n-e*this.computeGiMf()};var c=new i,l=new i,u=new i,h=new i,f=new i;r.prototype.getImpactVelocityAlongNormal=function(){var e=c,t=l,n=u,i=h,r=f;return this.bi.position.vadd(this.ri,n),this.bj.position.vadd(this.rj,i),this.bi.getVelocityAtWorldPoint(n,e),this.bj.getVelocityAtWorldPoint(i,t),e.vsub(t,r),this.ni.dot(r)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(e,t){t.exports=r;var n=e("../math/JacobianElement"),i=e("../math/Vec3");function r(e,t,i,o){this.id=r.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===o?1e6:o,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}r.prototype.constructor=r,r.id=0,r.prototype.setSpookParams=function(e,t,n){var i=t,r=e,o=n;this.a=4/(o*(1+4*i)),this.b=4*i/(1+4*i),this.eps=4/(o*o*r*(1+4*i))},r.prototype.computeB=function(e,t,n){var i=this.computeGW();return-this.computeGq()*e-i*t-this.computeGiMf()*n},r.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,r=n.position,o=i.position;return e.spatial.dot(r)+t.spatial.dot(o)},new i,r.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,r=n.velocity,o=i.velocity,a=n.angularVelocity,s=i.angularVelocity;return e.multiplyVectors(r,a)+t.multiplyVectors(o,s)},r.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,r=n.vlambda,o=i.vlambda,a=n.wlambda,s=i.wlambda;return e.multiplyVectors(r,a)+t.multiplyVectors(o,s)};var o=new i,a=new i,s=new i,c=new i;r.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,r=n.force,l=n.torque,u=i.force,h=i.torque,f=n.invMassSolve,_=i.invMassSolve;return r.scale(f,o),u.scale(_,a),n.invInertiaWorldSolve.vmult(l,s),i.invInertiaWorldSolve.vmult(h,c),e.multiplyVectors(o,s)+t.multiplyVectors(a,c)};var l=new i;r.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,r=n.invMassSolve,o=i.invMassSolve,a=n.invInertiaWorldSolve,s=i.invInertiaWorldSolve,c=r+o;return a.vmult(e.rotational,l),c+=l.dot(e.rotational),s.vmult(t.rotational,l),c+l.dot(t.rotational)};var u=new i;new i,new i,new i,new i,new i,r.prototype.addToWlambda=function(e){var t=this.jacobianElementA,n=this.jacobianElementB,i=this.bi,r=this.bj,o=u;i.vlambda.addScaledVector(i.invMassSolve*e,t.spatial,i.vlambda),r.vlambda.addScaledVector(r.invMassSolve*e,n.spatial,r.vlambda),i.invInertiaWorldSolve.vmult(t.rotational,o),i.wlambda.addScaledVector(e,o,i.wlambda),r.invInertiaWorldSolve.vmult(n.rotational,o),r.wlambda.addScaledVector(e,o,r.wlambda)},r.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(e,t){t.exports=r;var n=e("./Equation"),i=e("../math/Vec3");function r(e,t,r){n.call(this,e,t,-r,r),this.ri=new i,this.rj=new i,this.t=new i}e("../math/Mat3"),r.prototype=new n,r.prototype.constructor=r;var o=new i,a=new i;r.prototype.computeB=function(e){this.a;var t=this.b,n=(this.bi,this.bj,this.ri),i=this.rj,r=o,s=a,c=this.t;n.cross(c,r),i.cross(c,s);var l=this.jacobianElementA,u=this.jacobianElementB;return c.negate(l.spatial),r.negate(l.rotational),u.spatial.copy(c),u.rotational.copy(s),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(e,t){t.exports=r;var n=e("../math/Vec3"),i=(e("../math/Mat3"),e("./Equation"));function r(e,t,r){var o=void 0!==(r=r||{}).maxForce?r.maxForce:1e6;i.call(this,e,t,-o,o),this.axisA=r.axisA?r.axisA.clone():new n(1,0,0),this.axisB=r.axisB?r.axisB.clone():new n(0,1,0),this.maxAngle=Math.PI/2}r.prototype=new i,r.prototype.constructor=r;var o=new n,a=new n;r.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.axisA,r=this.axisB,s=o,c=a,l=this.jacobianElementA,u=this.jacobianElementB;return i.cross(r,s),r.cross(i,c),l.rotational.copy(c),u.rotational.copy(s),-(Math.cos(this.maxAngle)-i.dot(r))*t-this.computeGW()*n-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(e,t){t.exports=r;var n=e("../math/Vec3"),i=(e("../math/Mat3"),e("./Equation"));function r(e,t,r){r=void 0!==r?r:1e6,i.call(this,e,t,-r,r),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}r.prototype=new i,r.prototype.constructor=r,r.prototype.computeB=function(e){this.a;var t=this.b,n=(this.bi,this.bj,this.axisA),i=this.axisB,r=this.jacobianElementA,o=this.jacobianElementB;return r.rotational.copy(n),i.negate(o.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(e,t){var n=e("../utils/Utils");function i(e,t,r){r=n.defaults(r,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=i.idCounter++,this.materials=[e,t],this.friction=r.friction,this.restitution=r.restitution,this.contactEquationStiffness=r.contactEquationStiffness,this.contactEquationRelaxation=r.contactEquationRelaxation,this.frictionEquationStiffness=r.frictionEquationStiffness,this.frictionEquationRelaxation=r.frictionEquationRelaxation}t.exports=i,i.idCounter=0},{"../utils/Utils":54}],26:[function(e,t){function n(e){var t="";"string"==typeof(e=e||{})?(t=e,e={}):"object"==typeof e&&(t=""),this.name=t,this.id=n.idCounter++,this.friction=void 0!==e.friction?e.friction:-1,this.restitution=void 0!==e.restitution?e.restitution:-1,this.correctInelastic=0}t.exports=n,n.idCounter=0},{}],27:[function(e,t){t.exports=i;var n=e("./Vec3");function i(){this.spatial=new n,this.rotational=new n}i.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},i.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":31}],28:[function(e,t){t.exports=i;var n=e("./Vec3");function i(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}i.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},i.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},i.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},i.prototype.getTrace=function(e){e=e||new n;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},i.prototype.vmult=function(e,t){t=t||new n;var i=this.elements,r=e.x,o=e.y,a=e.z;return t.x=i[0]*r+i[1]*o+i[2]*a,t.y=i[3]*r+i[4]*o+i[5]*a,t.z=i[6]*r+i[7]*o+i[8]*a,t},i.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},i.prototype.mmult=function(e,t){for(var n=t||new i,r=0;r<3;r++)for(var o=0;o<3;o++){for(var a=0,s=0;s<3;s++)a+=e.elements[r+3*s]*this.elements[s+3*o];n.elements[r+3*o]=a}return n},i.prototype.scale=function(e,t){t=t||new i;for(var n=this.elements,r=t.elements,o=0;3!==o;o++)r[3*o+0]=e.x*n[3*o+0],r[3*o+1]=e.y*n[3*o+1],r[3*o+2]=e.z*n[3*o+2];return t},i.prototype.solve=function(e,t){t=t||new n;for(var i,r=3,o=4,a=[],s=0;s<r*o;s++)a.push(0);for(s=0;s<3;s++)for(i=0;i<3;i++)a[s+o*i]=this.elements[s+3*i];a[3]=e.x,a[7]=e.y,a[11]=e.z;var c,l,u=3,h=u,f=4;do{if(0===a[(s=h-u)+o*s])for(i=s+1;i<h;i++)if(0!==a[s+o*i]){c=f;do{a[(l=f-c)+o*s]+=a[l+o*i]}while(--c);break}if(0!==a[s+o*s])for(i=s+1;i<h;i++){var _=a[s+o*i]/a[s+o*s];c=f;do{a[(l=f-c)+o*i]=l<=s?0:a[l+o*i]-a[l+o*s]*_}while(--c)}}while(--u);if(t.z=a[2*o+3]/a[2*o+2],t.y=(a[1*o+3]-a[1*o+2]*t.z)/a[1*o+1],t.x=(a[0*o+3]-a[0*o+2]*t.z-a[0*o+1]*t.y)/a[0*o+0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},i.prototype.e=function(e,t,n){if(void 0===n)return this.elements[t+3*e];this.elements[t+3*e]=n},i.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},i.prototype.toString=function(){for(var e="",t=",",n=0;n<9;n++)e+=this.elements[n]+t;return e},i.prototype.reverse=function(e){e=e||new i;for(var t,n=3,r=6,o=[],a=0;a<n*r;a++)o.push(0);for(a=0;a<3;a++)for(t=0;t<3;t++)o[a+r*t]=this.elements[a+3*t];o[3]=1,o[9]=0,o[15]=0,o[4]=0,o[10]=1,o[16]=0,o[5]=0,o[11]=0,o[17]=1;var s,c,l=3,u=l,h=r;do{if(0===o[(a=u-l)+r*a])for(t=a+1;t<u;t++)if(0!==o[a+r*t]){s=h;do{o[(c=h-s)+r*a]+=o[c+r*t]}while(--s);break}if(0!==o[a+r*a])for(t=a+1;t<u;t++){var f=o[a+r*t]/o[a+r*a];s=h;do{o[(c=h-s)+r*t]=c<=a?0:o[c+r*t]-o[c+r*a]*f}while(--s)}}while(--l);a=2;do{t=a-1;do{f=o[a+r*t]/o[a+r*a],s=r;do{o[(c=r-s)+r*t]=o[c+r*t]-o[c+r*a]*f}while(--s)}while(t--)}while(--a);a=2;do{f=1/o[a+r*a],s=r;do{o[(c=r-s)+r*a]=o[c+r*a]*f}while(--s)}while(a--);a=2;do{t=2;do{if(c=o[n+t+r*a],isNaN(c)||c===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(a,t,c)}while(t--)}while(a--);return e},i.prototype.setRotationFromQuaternion=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=t*a,u=t*s,h=n*a,f=n*s,_=i*s,p=r*o,d=r*a,m=r*s,v=this.elements;return v[0]=1-(h+_),v[1]=l-m,v[2]=u+d,v[3]=l+m,v[4]=1-(c+_),v[5]=f-p,v[6]=u-d,v[7]=f+p,v[8]=1-(c+h),this},i.prototype.transpose=function(e){for(var t=(e=e||new i).elements,n=this.elements,r=0;3!==r;r++)for(var o=0;3!==o;o++)t[3*r+o]=n[3*o+r];return e}},{"./Vec3":31}],29:[function(e,t){t.exports=i;var n=e("./Vec3");function i(e,t,n,i){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==n?n:0,this.w=void 0!==i?i:1}i.prototype.set=function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this},i.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},i.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},i.prototype.setFromAxisAngle=function(e,t){var n=Math.sin(.5*t);return this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(.5*t),this},i.prototype.toAxisAngle=function(e){e=e||new n,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]};var r=new n,o=new n;i.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var n=r,i=o;e.tangents(n,i),this.setFromAxisAngle(n,Math.PI)}else{var a=e.cross(t);this.x=a.x,this.y=a.y,this.z=a.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}return this},new n,new n,new n,i.prototype.mult=function(e,t){t=t||new i;var n=this.x,r=this.y,o=this.z,a=this.w,s=e.x,c=e.y,l=e.z,u=e.w;return t.x=n*u+a*s+r*l-o*c,t.y=r*u+a*c+o*s-n*l,t.z=o*u+a*l+n*c-r*s,t.w=a*u-n*s-r*c-o*l,t},i.prototype.inverse=function(e){var t=this.x,n=this.y,r=this.z,o=this.w;e=e||new i,this.conjugate(e);var a=1/(t*t+n*n+r*r+o*o);return e.x*=a,e.y*=a,e.z*=a,e.w*=a,e},i.prototype.conjugate=function(e){return(e=e||new i).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},i.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},i.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},i.prototype.vmult=function(e,t){t=t||new n;var i=e.x,r=e.y,o=e.z,a=this.x,s=this.y,c=this.z,l=this.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,f=l*o+a*r-s*i,_=-a*i-s*r-c*o;return t.x=u*l+_*-a+h*-c-f*-s,t.y=h*l+_*-s+f*-a-u*-c,t.z=f*l+_*-c+u*-s-h*-a,t},i.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},i.prototype.toEuler=function(e,t){var n,i,r;t=t||"YZX";var o=this.x,a=this.y,s=this.z,c=this.w;switch(t){case"YZX":var l=o*a+s*c;if(l>.499&&(n=2*Math.atan2(o,c),i=Math.PI/2,r=0),l<-.499&&(n=-2*Math.atan2(o,c),i=-Math.PI/2,r=0),isNaN(n)){var u=o*o,h=a*a,f=s*s;n=Math.atan2(2*a*c-2*o*s,1-2*h-2*f),i=Math.asin(2*l),r=Math.atan2(2*o*c-2*a*s,1-2*u-2*f)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=n,e.z=i,e.x=r},i.prototype.setFromEuler=function(e,t,n,i){i=i||"XYZ";var r=Math.cos(e/2),o=Math.cos(t/2),a=Math.cos(n/2),s=Math.sin(e/2),c=Math.sin(t/2),l=Math.sin(n/2);return"XYZ"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a-s*c*l):"YXZ"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a+s*c*l):"ZXY"===i?(this.x=s*o*a-r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a-s*c*l):"ZYX"===i?(this.x=s*o*a-r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a+s*c*l):"YZX"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a-s*c*l):"XZY"===i&&(this.x=s*o*a-r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a+s*c*l),this},i.prototype.clone=function(){return new i(this.x,this.y,this.z,this.w)},i.prototype.slerp=function(e,t,n){n=n||new i;var r,o,a,s,c,l=this.x,u=this.y,h=this.z,f=this.w,_=e.x,p=e.y,d=e.z,m=e.w;return(o=l*_+u*p+h*d+f*m)<0&&(o=-o,_=-_,p=-p,d=-d,m=-m),1-o>1e-6?(r=Math.acos(o),a=Math.sin(r),s=Math.sin((1-t)*r)/a,c=Math.sin(t*r)/a):(s=1-t,c=t),n.x=s*l+c*_,n.y=s*u+c*p,n.z=s*h+c*d,n.w=s*f+c*m,n},i.prototype.integrate=function(e,t,n,r){r=r||new i;var o=e.x*n.x,a=e.y*n.y,s=e.z*n.z,c=this.x,l=this.y,u=this.z,h=this.w,f=.5*t;return r.x+=f*(o*h+a*u-s*l),r.y+=f*(a*h+s*c-o*u),r.z+=f*(s*h+o*l-a*c),r.w+=f*(-o*c-a*l-s*u),r},i.prototype.euqals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{"./Vec3":31}],30:[function(e,t){var n=e("./Vec3"),i=e("./Quaternion");function r(e){e=e||{},this.position=new n,e.position&&this.position.copy(e.position),this.quaternion=new i,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=r;var o=new i;r.pointToLocalFrame=function(e,t,i,r){return r=r||new n,i.vsub(e,r),t.conjugate(o),o.vmult(r,r),r},r.prototype.pointToLocal=function(e,t){return r.pointToLocalFrame(this.position,this.quaternion,e,t)},r.pointToWorldFrame=function(e,t,i,r){return r=r||new n,t.vmult(i,r),r.vadd(e,r),r},r.prototype.pointToWorld=function(e,t){return r.pointToWorldFrame(this.position,this.quaternion,e,t)},r.prototype.vectorToWorldFrame=function(e,t){return t=t||new n,this.quaternion.vmult(e,t),t},r.vectorToWorldFrame=function(e,t,n){return e.vmult(t,n),n},r.vectorToLocalFrame=function(e,t,i,r){return r=r||new n,t.w*=-1,t.vmult(i,r),t.w*=-1,r}},{"./Quaternion":29,"./Vec3":31}],31:[function(e,t){t.exports=i;var n=e("./Mat3");function i(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0}i.ZERO=new i(0,0,0),i.UNIT_X=new i(1,0,0),i.UNIT_Y=new i(0,1,0),i.UNIT_Z=new i(0,0,1),i.prototype.cross=function(e,t){var n=e.x,r=e.y,o=e.z,a=this.x,s=this.y,c=this.z;return(t=t||new i).x=s*o-c*r,t.y=c*n-a*o,t.z=a*r-s*n,t},i.prototype.set=function(e,t,n){return this.x=e,this.y=t,this.z=n,this},i.prototype.setZero=function(){this.x=this.y=this.z=0},i.prototype.vadd=function(e,t){if(!t)return new i(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},i.prototype.vsub=function(e,t){if(!t)return new i(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},i.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},i.prototype.normalize=function(){var e=this.x,t=this.y,n=this.z,i=Math.sqrt(e*e+t*t+n*n);if(i>0){var r=1/i;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return i},i.prototype.unit=function(e){e=e||new i;var t=this.x,n=this.y,r=this.z,o=Math.sqrt(t*t+n*n+r*r);return o>0?(o=1/o,e.x=t*o,e.y=n*o,e.z=r*o):(e.x=1,e.y=0,e.z=0),e},i.prototype.norm=function(){var e=this.x,t=this.y,n=this.z;return Math.sqrt(e*e+t*t+n*n)},i.prototype.length=i.prototype.norm,i.prototype.norm2=function(){return this.dot(this)},i.prototype.lengthSquared=i.prototype.norm2,i.prototype.distanceTo=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return Math.sqrt((r-t)*(r-t)+(o-n)*(o-n)+(a-i)*(a-i))},i.prototype.distanceSquared=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return(r-t)*(r-t)+(o-n)*(o-n)+(a-i)*(a-i)},i.prototype.mult=function(e,t){t=t||new i;var n=this.x,r=this.y,o=this.z;return t.x=e*n,t.y=e*r,t.z=e*o,t},i.prototype.vmul=function(e,t){return(t=t||new i).x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t},i.prototype.scale=i.prototype.mult,i.prototype.addScaledVector=function(e,t,n){return(n=n||new i).x=this.x+e*t.x,n.y=this.y+e*t.y,n.z=this.z+e*t.z,n},i.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},i.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},i.prototype.negate=function(e){return(e=e||new i).x=-this.x,e.y=-this.y,e.z=-this.z,e};var r=new i,o=new i;i.prototype.tangents=function(e,t){var n=this.norm();if(n>0){var i=r,a=1/n;i.set(this.x*a,this.y*a,this.z*a);var s=o;Math.abs(i.x)<.9?(s.set(1,0,0),i.cross(s,e)):(s.set(0,1,0),i.cross(s,e)),i.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},i.prototype.toString=function(){return this.x+","+this.y+","+this.z},i.prototype.toArray=function(){return[this.x,this.y,this.z]},i.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},i.prototype.lerp=function(e,t,n){var i=this.x,r=this.y,o=this.z;n.x=i+(e.x-i)*t,n.y=r+(e.y-r)*t,n.z=o+(e.z-o)*t},i.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},i.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var a=new i;i.prototype.isAntiparallelTo=function(e,t){return this.negate(a),a.almostEquals(e,t)},i.prototype.clone=function(){return new i(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(e,t){t.exports=h;var n=e("../utils/EventTarget"),i=e("../shapes/Shape"),r=e("../math/Vec3"),o=e("../math/Mat3"),a=e("../math/Quaternion"),s=(e("../material/Material"),e("../collision/AABB")),c=e("../shapes/Box"),l=e("../collision/RaycastResult"),u=e("../world/World");function h(e){e=e||{},n.apply(this),this.id=h.idCounter++,this.world=null,this.preStep=null,this.ccdSpeedThreshold=void 0!==e.ccdSpeedThreshold?e.ccdSpeedThreshold:-1,this.ccdIterations=void 0!==e.ccdIterations?e.ccdIterations:5,this.postStep=null,this.vlambda=new r,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new r,this.previousPosition=new r,this.interpolatedPosition=new r,this.initPosition=new r,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new r,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new r,this.force=new r;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=t>0?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?h.STATIC:h.DYNAMIC,typeof e.type==typeof h.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new r,this.quaternion=new a,this.initQuaternion=new a,this.previousQuaternion=new a,this.interpolatedQuaternion=new a,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new r,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new r,this.invInertia=new r,this.invInertiaWorld=new o,this.invMassSolve=0,this.invInertiaSolve=new r,this.invInertiaWorldSolve=new o,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new r(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new r(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new s,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new r,e.shape&&this.addShape(e.shape),this.hasTrigger=!0,this.updateMassProperties()}h.prototype=new n,h.prototype.constructor=h,h.COLLIDE_EVENT_NAME="collide",h.DYNAMIC=1,h.STATIC=2,h.KINEMATIC=4,h.AWAKE=0,h.SLEEPY=1,h.SLEEPING=2,h.idCounter=0,h.wakeupEvent={type:"wakeup"},h.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,e===h.SLEEPING&&this.dispatchEvent(h.wakeupEvent)},h.prototype.sleep=function(){this.sleepState=h.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},h.sleepyEvent={type:"sleepy"},h.sleepEvent={type:"sleep"},h.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,n=this.velocity.norm2()+this.angularVelocity.norm2(),i=Math.pow(this.sleepSpeedLimit,2);t===h.AWAKE&&n<i?(this.sleepState=h.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(h.sleepyEvent)):t===h.SLEEPY&&n>i?this.wakeUp():t===h.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(h.sleepEvent))}},h.prototype.updateSolveMassProperties=function(){this.sleepState===h.SLEEPING||this.type===h.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},h.prototype.pointToLocalFrame=function(e,t){return t=t||new r,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},h.prototype.vectorToLocalFrame=function(e,t){return t=t||new r,this.quaternion.conjugate().vmult(e,t),t},h.prototype.pointToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},h.prototype.vectorToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t};var f=new r,_=new a;h.prototype.addShape=function(e,t,n){var i=new r,o=new a;return t&&i.copy(t),n&&o.copy(n),this.shapes.push(e),this.shapeOffsets.push(i),this.shapeOrientations.push(o),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger(),u.idToShapeMap[e.id]=e,e.body=this,this},h.prototype.removeShape=function(e){var t=this.shapes.indexOf(e);-1!==t&&(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger())},h.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,n=e.length,i=0,r=0;r!==n;r++){var o=e[r];o.updateBoundingSphereRadius();var a=t[r].norm(),s=o.boundingSphereRadius;a+s>i&&(i=a+s)}this.boundingRadius=i};var p=new s;h.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,n=this.shapeOrientations,i=e.length,r=f,o=_,a=this.quaternion,s=this.aabb,c=p,l=0;l!==i;l++){var u=e[l];a.vmult(t[l],r),r.vadd(this.position,r),n[l].mult(a,o),u.calculateWorldAABB(r,o,c.lowerBound,c.upperBound),0===l?s.copy(c):s.extend(c)}this.aabbNeedsUpdate=!1};var d=new o,m=new o;new o,h.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var n=d,i=m;n.setRotationFromQuaternion(this.quaternion),n.transpose(i),n.scale(t,n),n.mmult(i,this.invInertiaWorld)}},new r;var v=new r;h.prototype.applyForce=function(e,t){if(this.type===h.DYNAMIC){var n=v;t.cross(e,n),this.force.vadd(e,this.force),this.torque.vadd(n,this.torque)}};var g=new r,y=new r;h.prototype.applyLocalForce=function(e,t){if(this.type===h.DYNAMIC){var n=g,i=y;this.vectorToWorldFrame(e,n),this.vectorToWorldFrame(t,i),this.applyForce(n,i)}},new r;var S=new r,x=new r;h.prototype.applyImpulse=function(e,t){if(this.type===h.DYNAMIC){var n=t,i=S;i.copy(e),i.mult(this.invMass,i),this.velocity.vadd(i,this.velocity);var r=x;n.cross(e,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var T=new r,E=new r;h.prototype.applyLocalImpulse=function(e,t){if(this.type===h.DYNAMIC){var n=T,i=E;this.vectorToWorldFrame(e,n),this.vectorToWorldFrame(t,i),this.applyImpulse(n,i)}};var b=new r;h.prototype.updateMassProperties=function(){var e=b;this.invMass=this.mass>0?1/this.mass:0;var t=this.inertia,n=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),c.calculateInertia(e,this.mass,t),this.invInertia.set(t.x>0&&!n?1/t.x:0,t.y>0&&!n?1/t.y:0,t.z>0&&!n?1/t.z:0),this.updateInertiaWorld(!0)},h.prototype.getVelocityAtWorldPoint=function(e,t){var n=new r;return e.vsub(this.position,n),this.angularVelocity.cross(n,t),this.velocity.vadd(t,t),t},new r,new r;var C=new r,A=(new a,new a);h.prototype.integrate=function(e,t,n){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===h.DYNAMIC||u.integrateKinematic&&this.type===h.KINEMATIC)&&this.sleepState!==h.SLEEPING){var i=this.velocity,r=this.angularVelocity,o=this.position,a=this.force,s=this.torque,c=this.quaternion,l=this.invMass,f=this.invInertiaWorld,_=this.linearFactor,p=l*e;i.x+=a.x*p*_.x,i.y+=a.y*p*_.y,i.z+=a.z*p*_.z;var d=f.elements,m=this.angularFactor,v=s.x*m.x,g=s.y*m.y,y=s.z*m.z;r.x+=e*(d[0]*v+d[1]*g+d[2]*y),r.y+=e*(d[3]*v+d[4]*g+d[5]*y),r.z+=e*(d[6]*v+d[7]*g+d[8]*y),c.integrate(this.angularVelocity,e,this.angularFactor,c),t&&(n?c.normalizeFast():c.normalize()),this.type===h.DYNAMIC&&this.ccdSpeedThreshold>0&&this.velocity.length()>=Math.pow(this.ccdSpeedThreshold,2)&&this.integrateToTimeOfImpact(e)||(i.mult(e,C),o.vadd(C,o)),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},h.prototype.updateKinematic=function(e){if(this.type===h.KINEMATIC&&0!==e){this.velocity.setZero(),this.angularVelocity.setZero();var t=1/e;this.previousPosition.almostEquals(this.position)||(this.position.vsub(this.previousPosition,this.velocity),this.velocity.mult(t,this.velocity),this.aabbNeedsUpdate=!0),this.previousQuaternion.euqals(this.quaternion)||(this.previousQuaternion.conjugate(A),A.mult(this.quaternion,A),A.toEuler(this.angularVelocity),this.angularVelocity.mult(t,this.angularVelocity),this.aabbNeedsUpdate=!0)}},h.prototype.applyGravity=function(e){if(this.type===h.DYNAMIC){if(1==this.linearDamping)this.force.setZero();else if(this.useGravity){var t=e.x,n=e.y,i=e.z,r=this.force,o=this.mass;r.x+=o*t,r.y+=o*n,r.z+=o*i}1==this.angularDamping&&this.torque.setZero()}};var w=new r,R=new r,I=new r,P=new r,O=new r,D=new r,M=new l,N=new l,L=new l,B=new r,F=new r,z=new r,U=new o;h.prototype.integrateToTimeOfImpact=function(e){w.copy(this.velocity),w.normalize(),this.velocity.mult(e,I),I.vadd(this.position,R),R.vsub(this.position,O);var t,n=O.length(),r=this.collisionFilterGroup;this.collisionFilterGroup=0;for(var o=1,a=0;a<this.shapes.length;a++){var s=this.shapes[a],c={collisionFilterMask:s.collisionFilterMask,collisionFilterGroup:s.collisionFilterGroup,skipBackfaces:!0};if(B.copy(this.position),B.vadd(O,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,M),t=M.body,s.type===i.types.SPHERE&&(o=s.radius,u.ccdSphereAdvance)){if(z.copy(this.velocity),z.y=0,z.normalize(),B.copy(z),U.identity(),U.elements[0]=B.x,U.elements[1]=-B.z,U.elements[3]=B.z,U.elements[4]=B.x,P.set(0,s.radius,0),U.vmult(P,P),P.z=P.y,P.y=0,P.vadd(this.position,B),I.vadd(B,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,N),P.negate(P),P.vadd(this.position,B),I.vadd(B,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,L),N.hasHit){N.hitPointWorld.vsub(this.position,B);var l=w.dot(B);(!M.hasHit||M.distance>l)&&(M.hasHit=!0,M.distance=l,t=N.body,w.mult(l,B),B.vadd(this.position,M.hitPointWorld))}L.hasHit&&(L.hitPointWorld.vsub(this.position,B),l=w.dot(B),(!M.hasHit||M.distance>l)&&(M.hasHit=!0,M.distance=l,t=L.body,w.mult(l,B),B.vadd(this.position,M.hitPointWorld)))}if(t)break}if(this.collisionFilterGroup=r,!t)return!1;M.hasHit&&h.DrawSphere(M.hitPointWorld,.05),N.hasHit&&h.DrawSphere(N.hitPointWorld,.05),L.hasHit&&h.DrawSphere(L.hitPointWorld,.05);var f=1;(R=M.hitPointWorld).vsub(this.position,O),f=M.distance/n,D.copy(this.position);for(var _=0,p=0,d=f,m=1;m>=p&&_<this.ccdIterations;){_++,d=(m+p)/2,O.mult(d,C),D.vadd(C,this.position),this.computeAABB(),h.DrawSphere(this.position,o);var v=this.aabb.overlaps(t.aabb);if(v){var g=[];this.world.narrowphase.getContacts([this],[t],this.world,g,[],[],[]),v=g.length>0}v?m=d:p=d}return f=m,this.position.copy(D),O.mult(f,C),this.position.vadd(C,this.position),!0},h.DrawSphere=h.DrawLine=function(){},h.prototype.isSleeping=function(){return this.sleepState===h.SLEEPING},h.prototype.isSleepy=function(){return this.sleepState===h.SLEEPY},h.prototype.isAwake=function(){return this.sleepState===h.AWAKE},h.prototype.updateHasTrigger=function(){for(var e=this.shapes.length;e--&&(this.hasTrigger=!this.shapes[e].collisionResponse,!this.hasTrigger););}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(e,t){e("./Body");var n=e("../math/Vec3"),i=e("../math/Quaternion"),r=(e("../collision/RaycastResult"),e("../collision/Ray")),o=e("../objects/WheelInfo");function a(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=a,new n,new n,new n;var s=new n,c=new n,l=new n;new r,a.prototype.addWheel=function(e){var t=new o(e=e||{}),n=this.wheelInfos.length;return this.wheelInfos.push(t),n},a.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new n,a.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},a.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},a.prototype.addToWorld=function(e){this.constraints,e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},a.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},a.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,r=this.chassisBody,o=0;o<i;o++)this.updateWheelTransform(o);this.currentVehicleSpeedKmHour=3.6*r.velocity.norm();var a=new n;for(this.getVehicleAxisWorld(this.indexForwardAxis,a),a.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),o=0;o<i;o++)this.castRay(t[o]);this.updateSuspension(e);var s=new n,c=new n;for(o=0;o<i;o++){var l=(_=t[o]).suspensionForce;l>_.maxSuspensionForce&&(l=_.maxSuspensionForce),_.raycastResult.hitNormalWorld.scale(l*e,s),_.raycastResult.hitPointWorld.vsub(r.position,c),r.applyImpulse(s,c)}this.updateFriction(e);var u=new n,h=new n,f=new n;for(o=0;o<i;o++){var _=t[o];r.getVelocityAtWorldPoint(_.chassisConnectionPointWorld,f);var p=1;switch(this.indexUpAxis){case 1:p=-1}if(_.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,h);var d=h.dot(_.raycastResult.hitNormalWorld);_.raycastResult.hitNormalWorld.scale(d,u),h.vsub(u,h);var m=h.dot(f);_.deltaRotation=p*m*e/_.radius}!_.sliding&&_.isInContact||0===_.engineForce||!_.useCustomSlidingRotationalSpeed||(_.deltaRotation=(_.engineForce>0?1:-1)*_.customSlidingRotationalSpeed*e),Math.abs(_.brake)>Math.abs(_.engineForce)&&(_.deltaRotation=0),_.rotation+=_.deltaRotation,_.deltaRotation*=.99}},a.prototype.updateSuspension=function(){for(var e=this.chassisBody.mass,t=this.wheelInfos,n=t.length,i=0;i<n;i++){var r=t[i];if(r.isInContact){var o,a=r.suspensionRestLength-r.suspensionLength;o=r.suspensionStiffness*a*r.clippedInvContactDotSuspension;var s=r.suspensionRelativeVelocity;o-=(s<0?r.dampingCompression:r.dampingRelaxation)*s,r.suspensionForce=o*e,r.suspensionForce<0&&(r.suspensionForce=0)}else r.suspensionForce=0}},a.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var u=new n,h=new n;a.prototype.castRay=function(e){var t=u,i=h;this.updateWheelTransformWorld(e);var r=this.chassisBody,o=-1,a=e.suspensionRestLength+e.radius;e.directionWorld.scale(a,t);var s=e.chassisConnectionPointWorld;s.vadd(t,i);var c=e.raycastResult;c.reset();var l=r.collisionResponse;r.collisionResponse=!1,this.world.rayTest(s,i,c),r.collisionResponse=l;var f=c.body;if(e.raycastResult.groundObject=0,f){o=c.distance,e.raycastResult.hitNormalWorld=c.hitNormalWorld,e.isInContact=!0;var _=c.distance;e.suspensionLength=_-e.radius;var p=e.suspensionRestLength-e.maxSuspensionTravel,d=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<p&&(e.suspensionLength=p),e.suspensionLength>d&&(e.suspensionLength=d,e.raycastResult.reset());var m=e.raycastResult.hitNormalWorld.dot(e.directionWorld),v=new n;r.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,v);var g=e.raycastResult.hitNormalWorld.dot(v);if(m>=-.1)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var y=-1/m;e.suspensionRelativeVelocity=g*y,e.clippedInvContactDotSuspension=y}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return o},a.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},a.prototype.updateWheelTransform=function(e){var t=s,n=c,r=l,o=this.wheelInfos[e];this.updateWheelTransformWorld(o),o.directionLocal.scale(-1,t),n.copy(o.axleLocal),t.cross(n,r),r.normalize(),n.normalize();var a=o.steering,u=new i;u.setFromAxisAngle(t,a);var h=new i;h.setFromAxisAngle(n,o.rotation);var f=o.worldTransform.quaternion;this.chassisBody.quaternion.mult(u,f),f.mult(h,f),f.normalize();var _=o.worldTransform.position;_.copy(o.directionWorld),_.scale(o.suspensionLength,_),_.vadd(o.chassisConnectionPointWorld,_)};var f=[new n(1,0,0),new n(0,1,0),new n(0,0,1)];a.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var _=new n,p=[],d=[],m=1;a.prototype.updateFriction=function(e){for(var t=_,i=this.wheelInfos,r=i.length,o=this.chassisBody,a=d,s=p,c=0;c<r;c++){var l=(O=i[c]).raycastResult.body;O.sideImpulse=0,O.forwardImpulse=0,a[c]||(a[c]=new n),s[c]||(s[c]=new n)}for(c=0;c<r;c++)if(l=(O=i[c]).raycastResult.body){var u=s[c];this.getWheelTransformWorld(c).vectorToWorldFrame(f[this.indexRightAxis],u);var h=O.raycastResult.hitNormalWorld,v=u.dot(h);h.scale(v,t),u.vsub(t,u),u.normalize(),h.cross(u,a[c]),a[c].normalize(),O.sideImpulse=I(o,O.raycastResult.hitPointWorld,l,O.raycastResult.hitPointWorld,u),O.sideImpulse*=m}var g=1,y=.5;for(this.sliding=!1,c=0;c<r;c++){l=(O=i[c]).raycastResult.body;var x=0;if(O.slipInfo=1,l){var T=0,E=O.brake?O.brake:T;x=S(o,l,O.raycastResult.hitPointWorld,a[c],E);var b=E/(x+=O.engineForce*e);O.slipInfo*=b}if(O.forwardImpulse=0,O.skidInfo=1,l){O.skidInfo=1;var C=O.suspensionForce*e*O.frictionSlip,A=C*C;O.forwardImpulse=x;var w=O.forwardImpulse*y,R=O.sideImpulse*g,P=w*w+R*R;O.sliding=!1,P>A&&(this.sliding=!0,O.sliding=!0,b=C/Math.sqrt(P),O.skidInfo*=b)}}if(this.sliding)for(c=0;c<r;c++)0!==(O=i[c]).sideImpulse&&O.skidInfo<1&&(O.forwardImpulse*=O.skidInfo,O.sideImpulse*=O.skidInfo);for(c=0;c<r;c++){var O=i[c],D=new n;if(O.raycastResult.hitPointWorld.vsub(o.position,D),0!==O.forwardImpulse){var M=new n;a[c].scale(O.forwardImpulse,M),o.applyImpulse(M,D)}if(0!==O.sideImpulse){l=O.raycastResult.body;var N=new n;O.raycastResult.hitPointWorld.vsub(l.position,N);var L=new n;s[c].scale(O.sideImpulse,L),o.vectorToLocalFrame(D,D),D["xyz"[this.indexUpAxis]]*=O.rollInfluence,o.vectorToWorldFrame(D,D),o.applyImpulse(L,D),L.scale(-1,L),l.applyImpulse(L,N)}}};var v=new n,g=new n,y=new n;function S(e,t,n,i,r){var o=0,a=n,s=v,c=g,l=y;return e.getVelocityAtWorldPoint(a,s),t.getVelocityAtWorldPoint(a,c),s.vsub(c,l),r<(o=-i.dot(l)*(1/(C(e,n,i)+C(t,n,i))))&&(o=r),o<-r&&(o=-r),o}var x=new n,T=new n,E=new n,b=new n;function C(e,t,n){var i=x,r=T,o=E,a=b;return t.vsub(e.position,i),i.cross(n,r),e.invInertiaWorld.vmult(r,a),a.cross(i,o),e.invMass+n.dot(o)}var A=new n,w=new n,R=new n;function I(e,t,n,i,r){if(r.norm2()>1.1)return 0;var o=A,a=w,s=R;return e.getVelocityAtWorldPoint(t,o),n.getVelocityAtWorldPoint(i,a),o.vsub(a,s),-.2*r.dot(s)*(1/(e.invMass+n.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(e,t){var n=e("./Body"),i=e("../shapes/Sphere"),r=e("../shapes/Box"),o=e("../math/Vec3"),a=e("../constraints/HingeConstraint");function s(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new o(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new r(new o(5,2,.5));this.chassisBody=new n(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}t.exports=s,s.prototype.addWheel=function(e){var t=(e=e||{}).body;t||(t=new n(1,new i(1.2))),this.wheelBodies.push(t),this.wheelForces.push(0),new o;var r=void 0!==e.position?e.position.clone():new o,s=new o;this.chassisBody.pointToWorldFrame(r,s),t.position.set(s.x,s.y,s.z);var c=void 0!==e.axis?e.axis.clone():new o(0,1,0);this.wheelAxes.push(c);var l=new a(this.chassisBody,t,{pivotA:r,axisA:c,pivotB:o.ZERO,axisB:c,collideConnected:!1});return this.constraints.push(l),this.wheelBodies.length-1},s.prototype.setSteeringValue=function(e,t){var n=this.wheelAxes[t],i=Math.cos(e),r=Math.sin(e),o=n.x,a=n.y;this.constraints[t].axisA.set(i*o-r*a,r*o+i*a,0)},s.prototype.setMotorSpeed=function(e,t){var n=this.constraints[t];n.enableMotor(),n.motorTargetVelocity=e},s.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var c=new o;s.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},s.prototype.applyWheelForce=function(e,t){var n=this.wheelAxes[t],i=this.wheelBodies[t],r=i.torque;n.scale(e,c),i.vectorToWorldFrame(c,c),r.vadd(c,r)},s.prototype.addToWorld=function(e){for(var t=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)e.addBody(n[i]);for(i=0;i<t.length;i++)e.addConstraint(t[i]);e.addEventListener("preStep",this._update.bind(this))},s.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},s.prototype.removeFromWorld=function(e){for(var t=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)e.remove(n[i]);for(i=0;i<t.length;i++)e.removeConstraint(t[i])};var l=new o;s.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],n=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,l),n.dot(l)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(e,t){t.exports=i,e("../shapes/Shape");var n=e("../math/Vec3");function i(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),i.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},i.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var r=new n;i.prototype.getNeighbors=function(e,t){for(var n=this.particles.length,i=e.id,o=this.smoothingRadius*this.smoothingRadius,a=r,s=0;s!==n;s++){var c=this.particles[s];c.position.vsub(e.position,a),i!==c.id&&a.norm2()<o&&t.push(c)}};var o=new n,a=new n,s=new n,c=new n,l=new n,u=new n;i.prototype.update=function(){for(var e=this.particles.length,t=o,n=this.speedOfSound,i=this.eps,r=0;r!==e;r++){var h=this.particles[r];(b=this.neighbors[r]).length=0,this.getNeighbors(h,b),b.push(this.particles[r]);for(var f=b.length,_=0,p=0;p!==f;p++){h.position.vsub(b[p].position,t);var d=t.norm(),m=this.w(d);_+=b[p].mass*m}this.densities[r]=_,this.pressures[r]=n*n*(this.densities[r]-this.density)}var v=a,g=s,y=c,S=l,x=u;for(r=0;r!==e;r++){var T,E,b,C=this.particles[r];for(v.set(0,0,0),g.set(0,0,0),f=(b=this.neighbors[r]).length,p=0;p!==f;p++){var A=b[p];C.position.vsub(A.position,S);var w=S.norm();T=-A.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+i)+this.pressures[p]/(this.densities[p]*this.densities[p]+i)),this.gradw(S,y),y.mult(T,y),v.vadd(y,v),A.velocity.vsub(C.velocity,x),x.mult(1/(1e-4+this.densities[r]*this.densities[p])*this.viscosity*A.mass,x),E=this.nablaw(w),x.mult(E,x),g.vadd(x,g)}g.mult(C.mass,g),v.mult(C.mass,v),C.force.vadd(g,C.force),C.force.vadd(v,C.force)}},i.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},i.prototype.gradw=function(e,t){var n=e.norm(),i=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(i,9))*Math.pow(i*i-n*n,2),t)},i.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(e,t){var n=e("../math/Vec3");function i(e,t,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}t.exports=i,i.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},i.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},i.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},i.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var r=new n,o=new n,a=new n,s=new n,c=new n,l=new n,u=new n,h=new n,f=new n,_=new n,p=new n;i.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,n=this.restLength,i=this.bodyA,d=this.bodyB,m=r,v=o,g=a,y=s,S=p,x=c,T=l,E=u,b=h,C=f,A=_;this.getWorldAnchorA(x),this.getWorldAnchorB(T),x.vsub(i.position,E),T.vsub(d.position,b),T.vsub(x,m);var w=m.norm();v.copy(m),v.normalize(),d.velocity.vsub(i.velocity,g),d.angularVelocity.cross(b,S),g.vadd(S,g),i.angularVelocity.cross(E,S),g.vsub(S,g),v.mult(-e*(w-n)-t*g.dot(v),y),i.force.vsub(y,i.force),d.force.vadd(y,d.force),E.cross(y,C),b.cross(y,A),i.torque.vsub(C,i.torque),d.torque.vadd(A,d.torque)}},{"../math/Vec3":31}],37:[function(e,t){var n=e("../math/Vec3"),i=e("../math/Transform"),r=e("../collision/RaycastResult"),o=e("../utils/Utils");function a(e){e=o.defaults(e,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new r,this.worldTransform=new i,this.isInContact=!1}t.exports=a;var s=new n,c=new n;s=new n,a.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var n=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,c),e.getVelocityAtWorldPoint(c,s);var i=t.hitNormalWorld.dot(s);if(n>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/n;this.suspensionRelativeVelocity=i*r,this.clippedInvContactDotSuspension=r}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(e,t){t.exports=o;var n=e("./Shape"),i=e("../math/Vec3"),r=e("./ConvexPolyhedron");function o(e){n.call(this,{type:n.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}o.prototype=new n,o.prototype.constructor=o,o.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,n=this.halfExtents.z,o=i,a=[new o(-e,-t,-n),new o(e,-t,-n),new o(e,t,-n),new o(-e,t,-n),new o(-e,-t,n),new o(e,-t,n),new o(e,t,n),new o(-e,t,n)],s=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],c=(new o(0,0,1),new o(0,1,0),new o(1,0,0),new r(a,s));this.convexPolyhedronRepresentation=c,c.material=this.material},o.prototype.calculateLocalInertia=function(e,t){return t=t||new i,o.calculateInertia(this.halfExtents,e,t),t},o.calculateInertia=function(e,t,n){var i=e;i.isZero()?(n.x=2/12*t,n.y=2/12*t,n.z=2/12*t):(n.x=1/12*t*(4*i.y*i.y+4*i.z*i.z),n.y=1/12*t*(4*i.x*i.x+4*i.z*i.z),n.z=1/12*t*(4*i.y*i.y+4*i.x*i.x))},o.prototype.getSideNormals=function(e,t){var n=e,i=this.halfExtents;if(n[0].set(i.x,0,0),n[1].set(0,i.y,0),n[2].set(0,0,i.z),n[3].set(-i.x,0,0),n[4].set(0,-i.y,0),n[5].set(0,0,-i.z),void 0!==t)for(var r=0;r!==n.length;r++)t.vmult(n[r],n[r]);return n},o.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var a=new i;new i,o.prototype.forEachWorldCorner=function(e,t,n){for(var i=this.halfExtents,r=[[i.x,i.y,i.z],[-i.x,i.y,i.z],[-i.x,-i.y,i.z],[-i.x,-i.y,-i.z],[i.x,-i.y,-i.z],[i.x,i.y,-i.z],[-i.x,i.y,-i.z],[i.x,-i.y,i.z]],o=0;o<r.length;o++)a.set(r[o][0],r[o][1],r[o][2]),t.vmult(a,a),e.vadd(a,a),n(a.x,a.y,a.z)};var s=[new i,new i,new i,new i,new i,new i,new i,new i];o.prototype.calculateWorldAABB=function(e,t,n,i){var r=this.halfExtents;s[0].set(r.x,r.y,r.z),s[1].set(-r.x,r.y,r.z),s[2].set(-r.x,-r.y,r.z),s[3].set(-r.x,-r.y,-r.z),s[4].set(r.x,-r.y,-r.z),s[5].set(r.x,r.y,-r.z),s[6].set(-r.x,r.y,-r.z),s[7].set(r.x,-r.y,r.z);var o=s[0];t.vmult(o,o),e.vadd(o,o),i.copy(o),n.copy(o);for(var a=1;a<8;a++){o=s[a],t.vmult(o,o),e.vadd(o,o);var c=o.x,l=o.y,u=o.z;c>i.x&&(i.x=c),l>i.y&&(i.y=l),u>i.z&&(i.z=u),c<n.x&&(n.x=c),l<n.y&&(n.y=l),u<n.z&&(n.z=u)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(e,t){t.exports=o;var n=e("./Shape"),i=e("../math/Vec3"),r=(e("../math/Quaternion"),e("../math/Transform"));function o(e,t,i){n.call(this,{type:n.types.CONVEXPOLYHEDRON}),this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}o.prototype=new n,o.prototype.constructor=o;var a=new i;o.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,n=(t.length,this.uniqueEdges);n.length=0;for(var i=a,r=0;r!==e.length;r++)for(var o=e[r],s=o.length,c=0;c!==s;c++){var l=(c+1)%s;t[o[c]].vsub(t[o[l]],i),i.normalize();for(var u=!1,h=0;h!==n.length;h++)if(n[h].almostEquals(i)||n[h].almostEquals(i)){u=!0;break}u||n.push(i.clone())}},o.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var n=this.faceNormals[e]||new i;this.getFaceNormal(e,n),n.negate(n),this.faceNormals[e]=n}};var s=new i,c=new i;o.computeNormal=function(e,t,n,i){t.vsub(e,c),n.vsub(t,s),s.cross(c,i),i.isZero()||i.normalize()},o.prototype.getFaceNormal=function(e,t){var n=this.faces[e],i=this.vertices[n[0]],r=this.vertices[n[1]],a=this.vertices[n[2]];return o.computeNormal(i,r,a,t)};var l=new i;o.prototype.clipAgainstHull=function(e,t,n,r,o,a,s,c,u){for(var h=l,f=-1,_=-Number.MAX_VALUE,p=0;p<n.faces.length;p++){h.copy(n.faceNormals[p]),o.vmult(h,h);var d=h.dot(a);d>_&&(_=d,f=p)}for(var m=[],v=n.faces[f],g=v.length,y=0;y<g;y++){var S=n.vertices[v[y]],x=new i;x.copy(S),o.vmult(x,x),r.vadd(x,x),m.push(x)}f>=0&&this.clipFaceAgainstHull(a,e,t,m,s,c,u)};var u=new i,h=new i,f=new i,_=new i,p=new i,d=new i;o.prototype.findSeparatingAxis=function(e,t,n,i,r,o,a,s){var c=u,l=h,m=f,v=_,g=p,y=d,S=Number.MAX_VALUE,x=this;if(x.uniqueAxes)for(E=0;E!==x.uniqueAxes.length;E++){if(n.vmult(x.uniqueAxes[E],c),!1===(A=x.testSepAxis(c,e,t,n,i,r)))return!1;A<S&&(S=A,o.copy(c))}else for(var T=a?a.length:x.faces.length,E=0;E<T;E++){var b=a?a[E]:E;if(c.copy(x.faceNormals[b]),n.vmult(c,c),!1===(A=x.testSepAxis(c,e,t,n,i,r)))return!1;A<S&&(S=A,o.copy(c))}if(e.uniqueAxes)for(E=0;E!==e.uniqueAxes.length;E++){if(r.vmult(e.uniqueAxes[E],l),!1===(A=x.testSepAxis(l,e,t,n,i,r)))return!1;A<S&&(S=A,o.copy(l))}else{var C=s?s.length:e.faces.length;for(E=0;E<C;E++){var A;if(b=s?s[E]:E,l.copy(e.faceNormals[b]),r.vmult(l,l),!1===(A=x.testSepAxis(l,e,t,n,i,r)))return!1;A<S&&(S=A,o.copy(l))}}for(var w=0;w!==x.uniqueEdges.length;w++){n.vmult(x.uniqueEdges[w],v);for(var R=0;R!==e.uniqueEdges.length;R++)if(r.vmult(e.uniqueEdges[R],g),v.cross(g,y),!y.almostZero()){y.normalize();var I=x.testSepAxis(y,e,t,n,i,r);if(!1===I)return!1;I<S&&(S=I,o.copy(y))}}return i.vsub(t,m),m.dot(o)>0&&o.negate(o),!0};var m=[],v=[];o.prototype.testSepAxis=function(e,t,n,i,r,a){var s=this;o.project(s,e,n,i,m),o.project(t,e,r,a,v);var c=m[0],l=m[1],u=v[0],h=v[1];if(c<h||u<l)return!1;var f=c-h,_=u-l;return f<_?f:_};var g=new i,y=new i;o.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(g,y);var n=y.x-g.x,i=y.y-g.y,r=y.z-g.z;t.x=1/12*e*(4*i*i+4*r*r),t.y=1/12*e*(4*n*n+4*r*r),t.z=1/12*e*(4*i*i+4*n*n)},o.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],n=this.faceNormals[e],i=this.vertices[t[0]];return-n.dot(i)};var S=new i,x=new i,T=new i,E=new i,b=new i,C=new i,A=new i,w=new i;o.prototype.clipFaceAgainstHull=function(e,t,n,i,r,o,a){for(var s=S,c=x,l=T,u=E,h=b,f=C,_=A,p=w,d=this,m=i,v=[],g=-1,y=Number.MAX_VALUE,R=0;R<d.faces.length;R++){s.copy(d.faceNormals[R]),n.vmult(s,s);var I=s.dot(e);I<y&&(y=I,g=R)}if(!(g<0)){var P=d.faces[g];P.connectedFaces=[];for(var O=0;O<d.faces.length;O++)for(var D=0;D<d.faces[O].length;D++)-1!==P.indexOf(d.faces[O][D])&&O!==g&&-1===P.connectedFaces.indexOf(O)&&P.connectedFaces.push(O);m.length;for(var M=P.length,N=0;N<M;N++){var L=d.vertices[P[N]],B=d.vertices[P[(N+1)%M]];L.vsub(B,c),l.copy(c),n.vmult(l,l),t.vadd(l,l),u.copy(this.faceNormals[g]),n.vmult(u,u),t.vadd(u,u),l.cross(u,h),h.negate(h),f.copy(L),n.vmult(f,f),t.vadd(f,f),f.dot(h);var F=P.connectedFaces[N];_.copy(this.faceNormals[F]);var z=this.getPlaneConstantOfFace(F);p.copy(_),n.vmult(p,p);var U=z-p.dot(t);for(this.clipFaceAgainstPlane(m,v,p,U);m.length;)m.shift();for(;v.length;)m.push(v.shift())}for(_.copy(this.faceNormals[g]),z=this.getPlaneConstantOfFace(g),p.copy(_),n.vmult(p,p),U=z-p.dot(t),O=0;O<m.length;O++){var k=p.dot(m[O])+U;if(k<=r&&(k=r),k<=o){var G=m[O];if(k<=0){var H={point:G,normal:p,depth:k};a.push(H)}}}}},o.prototype.clipFaceAgainstPlane=function(e,t,n,r){var o,a,s=e.length;if(s<2)return t;var c=e[e.length-1],l=e[0];o=n.dot(c)+r;for(var u=0;u<s;u++){if(l=e[u],a=n.dot(l)+r,o<0)if(a<0)(h=new i).copy(l),t.push(h);else{var h=new i;c.lerp(l,o/(o-a),h),t.push(h)}else a<0&&(h=new i,c.lerp(l,o/(o-a),h),t.push(h),t.push(l));c=l,o=a}return t},o.prototype.computeWorldVertices=function(e,t){for(var n=this.vertices.length;this.worldVertices.length<n;)this.worldVertices.push(new i);for(var r=this.vertices,o=this.worldVertices,a=0;a!==n;a++)t.vmult(r[a],o[a]),e.vadd(o[a],o[a]);this.worldVerticesNeedsUpdate=!1},new i,o.prototype.computeLocalAABB=function(e,t){var n=this.vertices.length,i=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<n;r++){var o=i[r];o.x<e.x?e.x=o.x:o.x>t.x&&(t.x=o.x),o.y<e.y?e.y=o.y:o.y>t.y&&(t.y=o.y),o.z<e.z?e.z=o.z:o.z>t.z&&(t.z=o.z)}},o.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new i);for(var n=this.faceNormals,r=this.worldFaceNormals,o=0;o!==t;o++)e.vmult(n[o],r[o]);this.worldFaceNormalsNeedsUpdate=!1},o.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,n=0,i=t.length;n!==i;n++){var r=t[n].norm2();r>e&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)};var R=new i;o.prototype.calculateWorldAABB=function(e,t,n,i){for(var r,o,a,s,c,l,u=this.vertices.length,h=this.vertices,f=0;f<u;f++){R.copy(h[f]),t.vmult(R,R),e.vadd(R,R);var _=R;(_.x<r||void 0===r)&&(r=_.x),(_.x>s||void 0===s)&&(s=_.x),(_.y<o||void 0===o)&&(o=_.y),(_.y>c||void 0===c)&&(c=_.y),(_.z<a||void 0===a)&&(a=_.z),(_.z>l||void 0===l)&&(l=_.z)}n.set(r,o,a),i.set(s,c,l)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.prototype.getAveragePointLocal=function(e){e=e||new i;for(var t=this.vertices.length,n=this.vertices,r=0;r<t;r++)e.vadd(n[r],e);return e.mult(1/t,e),e},o.prototype.transformAllPoints=function(e,t){var n=this.vertices.length,i=this.vertices;if(t){for(var r=0;r<n;r++){var o=i[r];t.vmult(o,o)}for(r=0;r<this.faceNormals.length;r++)o=this.faceNormals[r],t.vmult(o,o)}if(e)for(r=0;r<n;r++)(o=i[r]).vadd(e,o)};var I=new i,P=new i,O=new i;o.prototype.pointIsInside=function(e){var t=this.vertices.length,n=this.vertices,i=this.faces,r=this.faceNormals,o=this.faces.length,a=I;this.getAveragePointLocal(a);for(var s=0;s<o;s++){this.faces[s].length,t=r[s];var c=n[i[s][0]],l=P;e.vsub(c,l);var u=t.dot(l),h=O;a.vsub(c,h);var f=t.dot(h);if(u<0&&f>0||u>0&&f<0)return!1}return-1},new i;var D=new i,M=new i;o.project=function(e,t,n,i,o){var a=e.vertices.length,s=D,c=0,l=0,u=M,h=e.vertices;u.setZero(),r.vectorToLocalFrame(n,i,t,s),r.pointToLocalFrame(n,i,u,u);var f=u.dot(s);l=c=h[0].dot(s);for(var _=1;_<a;_++){var p=h[_].dot(s);p>c&&(c=p),p<l&&(l=p)}if((l-=f)>(c-=f)){var d=l;l=c,c=d}o[0]=c,o[1]=l}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(e,t){t.exports=r,e("./Shape");var n=e("../math/Vec3"),i=(e("../math/Quaternion"),e("./ConvexPolyhedron"));function r(e,t,r,o,a){if(a){for(var s=o,c=Math.cos,l=Math.sin,u=r/2,h=[],f=[],_=[0],p=[1],d=[],m=2*Math.PI/s,v=0;v<s;v++)h.push(new n(e*c(m*v),u,e*l(m*v))),h.push(new n(e*c(m*v),-u,e*l(m*v))),v<s-1?(f.push([2*v+2,2*v+3,2*v+1,2*v]),_.push(2*v+2),p.push(2*v+3)):f.push([0,1,2*v+1,2*v]),(s%2==1||v<s/2)&&d.push(new n(c(m*(v+.5)),0,l(m*(v+.5))));f.push(p);var g=[];for(v=0;v<_.length;v++)g.push(_[_.length-v-1]);return f.push(g),d.push(new n(0,1,0)),void i.call(this,h,f,d)}s=o;var y=[],S=(d=[],[]),x=[],T=[];for(c=Math.cos,l=Math.sin,y.push(new n(t*c(0),t*l(0),.5*-r)),x.push(0),y.push(new n(e*c(0),e*l(0),.5*r)),T.push(1),v=0;v<s;v++){m=2*Math.PI/s*(v+1);var E=2*Math.PI/s*(v+.5);v<s-1?(y.push(new n(t*c(m),t*l(m),.5*-r)),x.push(2*v+2),y.push(new n(e*c(m),e*l(m),.5*r)),T.push(2*v+3),S.push([2*v+2,2*v+3,2*v+1,2*v])):S.push([0,1,2*v+1,2*v]),(s%2==1||v<s/2)&&d.push(new n(c(E),l(E),0))}for(S.push(T),d.push(new n(0,0,1)),g=[],v=0;v<x.length;v++)g.push(x[x.length-v-1]);S.push(g),i.call(this,y,S,d)}r.prototype=new i},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(e,t){var n=e("./Shape"),i=e("./ConvexPolyhedron"),r=e("../math/Vec3"),o=e("../utils/Utils");function a(e,t){t=o.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this,{type:n.types.HEIGHTFIELD}),this.pillarConvex=new i,this.pillarOffset=new r,this.updateBoundingSphereRadius(),this._cachedPillars={}}t.exports=a,a.prototype=new n,a.prototype.update=function(){this._cachedPillars={}},a.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],n=0;n!==e.length;n++)for(var i=0;i!==e[n].length;i++){var r=e[n][i];r<t&&(t=r)}this.minValue=t},a.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],n=0;n!==e.length;n++)for(var i=0;i!==e[n].length;i++){var r=e[n][i];r>t&&(t=r)}this.maxValue=t},a.prototype.setHeightValueAtIndex=function(e,t,n){this.data[e][t]=n,this.clearCachedConvexTrianglePillar(e,t,!1),e>0&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),t>0&&e>0&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},a.prototype.getRectMinMax=function(e,t,n,i,r){r=r||[];for(var o=this.data,a=this.minValue,s=e;s<=n;s++)for(var c=t;c<=i;c++){var l=o[s][c];l>a&&(a=l)}r[0]=this.minValue,r[1]=a},a.prototype.getIndexOfPosition=function(e,t,n,i){var r=this.elementSize,o=this.data,a=Math.floor(e/r),s=Math.floor(t/r);return n[0]=a,n[1]=s,i&&(a<0&&(a=0),s<0&&(s=0),a>=o.length-1&&(a=o.length-1),s>=o[0].length-1&&(s=o[0].length-1)),!(a<0||s<0||a>=o.length-1||s>=o[0].length-1)};var s=[],c=new r,l=new r,u=new r,h=new r;a.prototype.getTriangleAt=function(e,t,n,i,r,o){var a=s;this.getIndexOfPosition(e,t,a,n);var c=a[0],l=a[1],u=this.data;n&&(c=Math.min(u.length-2,Math.max(0,c)),l=Math.min(u[0].length-2,Math.max(0,l)));var h=this.elementSize,f=Math.pow(e/h-c,2)+Math.pow(t/h-l,2)>Math.pow(e/h-(c+1),2)+Math.pow(t/h-(l+1),2);return this.getTriangle(c,l,f,i,r,o),f};var f=new r,_=new r,p=new r,d=new r,m=new r;function v(e,t,n,i,r,o,a,s,c){c.x=((o-s)*(e-a)+(a-r)*(t-s))/((o-s)*(n-a)+(a-r)*(i-s)),c.y=((s-i)*(e-a)+(n-a)*(t-s))/((o-s)*(n-a)+(a-r)*(i-s)),c.z=1-c.x-c.y}a.prototype.getNormalAt=function(e,t,n,i){var r=f,o=_,a=p,s=d,c=m;this.getTriangleAt(e,t,n,r,o,a),o.vsub(r,s),a.vsub(r,c),s.cross(c,i),i.normalize()},a.prototype.getAabbAtIndex=function(e,t,n){var i=this.data,r=this.elementSize;n.lowerBound.set(e*r,t*r,i[e][t]),n.upperBound.set((e+1)*r,(t+1)*r,i[e+1][t+1])},a.prototype.getHeightAt=function(e,t,n){var i=this.data,r=l,o=u,a=h,f=s;this.getIndexOfPosition(e,t,f,n);var _=f[0],p=f[1];n&&(_=Math.min(i.length-2,Math.max(0,_)),p=Math.min(i[0].length-2,Math.max(0,p)));var d=this.getTriangleAt(e,t,n,r,o,a);v(e,t,r.x,r.y,o.x,o.y,a.x,a.y,c);var m=c;return d?i[_+1][p+1]*m.x+i[_][p+1]*m.y+i[_+1][p]*m.z:i[_][p]*m.x+i[_+1][p]*m.y+i[_][p+1]*m.z},a.prototype.getCacheConvexTrianglePillarKey=function(e,t,n){return e+"_"+t+"_"+(n?1:0)},a.prototype.getCachedConvexTrianglePillar=function(e,t,n){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]},a.prototype.setCachedConvexTrianglePillar=function(e,t,n,i,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]={convex:i,offset:r}},a.prototype.clearCachedConvexTrianglePillar=function(e,t,n){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]},a.prototype.getTriangle=function(e,t,n,i,r,o){var a=this.data,s=this.elementSize;n?(i.set((e+1)*s,(t+1)*s,a[e+1][t+1]),r.set(e*s,(t+1)*s,a[e][t+1]),o.set((e+1)*s,t*s,a[e+1][t])):(i.set(e*s,t*s,a[e][t]),r.set((e+1)*s,t*s,a[e+1][t]),o.set(e*s,(t+1)*s,a[e][t+1]))},a.prototype.getConvexTrianglePillar=function(e,t,n){var o=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){if(s=this.getCachedConvexTrianglePillar(e,t,n))return this.pillarConvex=s.convex,void(this.pillarOffset=s.offset);o=new i,a=new r,this.pillarConvex=o,this.pillarOffset=a}var s=this.data,c=this.elementSize,l=o.faces;o.vertices.length=6;for(var u=0;u<6;u++)o.vertices[u]||(o.vertices[u]=new r);for(l.length=5,u=0;u<5;u++)l[u]||(l[u]=[]);var h=o.vertices,f=(Math.min(s[e][t],s[e+1][t],s[e][t+1],s[e+1][t+1])-this.minValue)/2+this.minValue;n?(a.set((e+.75)*c,(t+.75)*c,f),h[0].set(.25*c,.25*c,s[e+1][t+1]-f),h[1].set(-.75*c,.25*c,s[e][t+1]-f),h[2].set(.25*c,-.75*c,s[e+1][t]-f),h[3].set(.25*c,.25*c,-f-1),h[4].set(-.75*c,.25*c,-f-1),h[5].set(.25*c,-.75*c,-f-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=2,l[2][1]=5,l[2][2]=3,l[2][3]=0,l[3][0]=3,l[3][1]=4,l[3][2]=1,l[3][3]=0,l[4][0]=1,l[4][1]=4,l[4][2]=5,l[4][3]=2):(a.set((e+.25)*c,(t+.25)*c,f),h[0].set(-.25*c,-.25*c,s[e][t]-f),h[1].set(.75*c,-.25*c,s[e+1][t]-f),h[2].set(-.25*c,.75*c,s[e][t+1]-f),h[3].set(-.25*c,-.25*c,-f-1),h[4].set(.75*c,-.25*c,-f-1),h[5].set(-.25*c,.75*c,-f-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=0,l[2][1]=2,l[2][2]=5,l[2][3]=3,l[3][0]=1,l[3][1]=0,l[3][2]=3,l[3][3]=4,l[4][0]=4,l[4][1]=5,l[4][2]=2,l[4][3]=1),o.computeNormals(),o.computeEdges(),o.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,n,o,a)},a.prototype.calculateLocalInertia=function(e,t){return(t=t||new r).set(0,0,0),t},a.prototype.volume=function(){return Number.MAX_VALUE},a.prototype.calculateWorldAABB=function(e,t,n,i){n.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},a.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new r(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},a.prototype.setHeightsFromImage=function(e,t){var n=document.createElement("canvas");n.width=e.width,n.height=e.height;var i=n.getContext("2d");i.drawImage(e,0,0);var r=i.getImageData(0,0,e.width,e.height),o=this.data;o.length=0,this.elementSize=Math.abs(t.x)/r.width;for(var a=0;a<r.height;a++){for(var s=[],c=0;c<r.width;c++){var l=(r.data[4*(a*r.height+c)]+r.data[4*(a*r.height+c)+1]+r.data[4*(a*r.height+c)+2])/4/255*t.z;t.x<0?s.push(l):s.unshift(l)}t.y<0?o.unshift(s):o.push(s)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(e,t){t.exports=r;var n=e("./Shape"),i=e("../math/Vec3");function r(){n.call(this,{type:n.types.PARTICLE})}r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(e,t){return(t=t||new i).set(0,0,0),t},r.prototype.volume=function(){return 0},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},r.prototype.calculateWorldAABB=function(e,t,n,i){n.copy(e),i.copy(e)}},{"../math/Vec3":31,"./Shape":44}],43:[function(e,t){t.exports=r;var n=e("./Shape"),i=e("../math/Vec3");function r(){n.call(this,{type:n.types.PLANE}),this.worldNormal=new i,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}r.prototype=new n,r.prototype.constructor=r,r.prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},r.prototype.calculateLocalInertia=function(e,t){return t||new i},r.prototype.volume=function(){return Number.MAX_VALUE};var o=new i;r.prototype.calculateWorldAABB=function(e,t,n,i){o.set(0,0,1),t.vmult(o,o);var r=Number.MAX_VALUE;n.set(-r,-r,-r),i.set(r,r,r),1===o.x&&(i.x=e.x),1===o.y&&(i.y=e.y),1===o.z&&(i.z=e.z),-1===o.x&&(n.x=e.x),-1===o.y&&(n.y=e.y),-1===o.z&&(n.z=e.z)},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(e,t){t.exports=i;var n=e("../utils/EventTarget"),i=e("./Shape");function i(e){e=e||{},n.apply(this),this.id=i.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),i.prototype=new n,i.prototype.constructor=i,i.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},i.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},i.idCounter=0,i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(e,t){t.exports=r;var n=e("./Shape"),i=e("../math/Vec3");function r(e){if(n.call(this,{type:n.types.SPHERE}),this.radius=void 0!==e?e:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(e,t){t=t||new i;var n=2*e*this.radius*this.radius/5;return t.x=n,t.y=n,t.z=n,t},r.prototype.volume=function(){return 4*Math.PI*this.radius/3},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},r.prototype.calculateWorldAABB=function(e,t,n,i){for(var r=this.radius,o=["x","y","z"],a=0;a<o.length;a++){var s=o[a];n[s]=e[s]-r,i[s]=e[s]+r}}},{"../math/Vec3":31,"./Shape":44}],46:[function(e,t){t.exports=s;var n=e("./Shape"),i=e("../math/Vec3"),r=(e("../math/Quaternion"),e("../math/Transform")),o=e("../collision/AABB"),a=e("../utils/Octree");function s(e,t){n.call(this,{type:n.types.TRIMESH}),this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new o,this.edges=null,this.scale=new i(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}s.prototype=new n,s.prototype.constructor=s;var c=new i;s.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var n=new o,r=new i,a=new i,s=new i,c=[r,a,s],l=0;l<this.indices.length/3;l++){var u=3*l;this._getUnscaledVertex(this.indices[u],r),this._getUnscaledVertex(this.indices[u+1],a),this._getUnscaledVertex(this.indices[u+2],s),n.setFromPoints(c),e.insert(n,l)}e.removeEmptyNodes()};var l=new o;s.prototype.getTrianglesInAABB=function(e,t){l.copy(e);var n=this.scale,i=n.x,r=n.y,o=n.z,a=l.lowerBound,s=l.upperBound;return a.x/=i,a.y/=r,a.z/=o,s.x/=i,s.y/=r,s.z/=o,this.tree.aabbQuery(l,t)},s.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,n=e.x===e.y===e.z;t&&n||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},s.prototype.updateNormals=function(){for(var e=c,t=this.normals,n=0;n<this.indices.length/3;n++){var i=3*n,r=this.indices[i],o=this.indices[i+1],a=this.indices[i+2];this.getVertex(r,p),this.getVertex(o,d),this.getVertex(a,m),s.computeNormal(d,p,m,e),t[i]=e.x,t[i+1]=e.y,t[i+2]=e.z}},s.prototype.updateEdges=function(){for(var e={},t=function(){e[r<o?r+"_"+o:o+"_"+r]=!0},n=0;n<this.indices.length/3;n++){var i=3*n,r=this.indices[i],o=this.indices[i+1];this.indices[i+2],t(),t(),t()}var a=Object.keys(e);for(this.edges=new Int16Array(2*a.length),n=0;n<a.length;n++){var s=a[n].split("_");this.edges[2*n]=parseInt(s[0],10),this.edges[2*n+1]=parseInt(s[1],10)}},s.prototype.getEdgeVertex=function(e,t,n){var i=this.edges[2*e+(t?1:0)];this.getVertex(i,n)};var u=new i,h=new i;s.prototype.getEdgeVector=function(e,t){var n=u,i=h;this.getEdgeVertex(e,0,n),this.getEdgeVertex(e,1,i),i.vsub(n,t)};var f=new i,_=new i;s.computeNormal=function(e,t,n,i){t.vsub(e,_),n.vsub(t,f),f.cross(_,i),i.isZero()||i.normalize()};var p=new i,d=new i,m=new i;s.prototype.getVertex=function(e,t){var n=this.scale;return this._getUnscaledVertex(e,t),t.x*=n.x,t.y*=n.y,t.z*=n.z,t},s.prototype._getUnscaledVertex=function(e,t){var n=3*e,i=this.vertices;return t.set(i[n],i[n+1],i[n+2])},s.prototype.getWorldVertex=function(e,t,n,i){return this.getVertex(e,i),r.pointToWorldFrame(t,n,i,i),i},s.prototype.getTriangleVertices=function(e,t,n,i){var r=3*e;this.getVertex(this.indices[r],t),this.getVertex(this.indices[r+1],n),this.getVertex(this.indices[r+2],i)},s.prototype.getNormal=function(e,t){var n=3*e;return t.set(this.normals[n],this.normals[n+1],this.normals[n+2])};var v=new o;s.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(v);var n=v.upperBound.x-v.lowerBound.x,i=v.upperBound.y-v.lowerBound.y,r=v.upperBound.z-v.lowerBound.z;return t.set(1/12*e*(4*i*i+4*r*r),1/12*e*(4*n*n+4*r*r),1/12*e*(4*i*i+4*n*n))};var g=new i;s.prototype.computeLocalAABB=function(e){var t=e.lowerBound,n=e.upperBound,i=this.vertices.length/3,r=g;if(0!==i){this.getVertex(0,r),t.copy(r),n.copy(r);for(var o=0;o!==i;o++)this.getVertex(o,r),r.x<t.x?t.x=r.x:r.x>n.x&&(n.x=r.x),r.y<t.y?t.y=r.y:r.y>n.y&&(n.y=r.y),r.z<t.z?t.z=r.z:r.z>n.z&&(n.z=r.z)}},s.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},s.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,n=new i,r=0,o=t.length/3;r!==o;r++){this.getVertex(r,n);var a=n.norm2();a>e&&(e=a)}this.boundingSphereRadius=Math.sqrt(e)},new i;var y=new r,S=new o;s.prototype.calculateWorldAABB=function(e,t,n,i){var r=y,o=S;r.position=e,r.quaternion=t,this.aabb.toWorldFrame(r,o),n.copy(o.lowerBound),i.copy(o.upperBound)},s.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},s.createTorus=function(e,t,n,i,r){e=e||1,t=t||.5,n=n||8,i=i||6,r=r||2*Math.PI;for(var o=[],a=[],c=0;c<=n;c++)for(var l=0;l<=i;l++){var u=l/i*r,h=c/n*Math.PI*2,f=(e+t*Math.cos(h))*Math.cos(u),_=(e+t*Math.cos(h))*Math.sin(u),p=t*Math.sin(h);o.push(f,_,p)}for(c=1;c<=n;c++)for(l=1;l<=i;l++){var d=(i+1)*c+l-1,m=(i+1)*(c-1)+l-1,v=(i+1)*(c-1)+l,g=(i+1)*c+l;a.push(d,m,g),a.push(m,v,g)}return new s(o,a)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(e,t){t.exports=i,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver");function i(){n.call(this),this.iterations=10,this.tolerance=1e-7}i.prototype=new n;var r=[],o=[],a=[];i.prototype.solve=function(e,t){var n,i,s,c,l,u=0,h=this.iterations,f=this.tolerance*this.tolerance,_=this.equations,p=_.length,d=t.bodies,m=d.length,v=e;if(0!==p)for(var g=0;g!==m;g++)d[g].updateSolveMassProperties();var y=o,S=a,x=r;for(y.length=p,S.length=p,x.length=p,g=0;g!==p;g++){var T=_[g];x[g]=0,S[g]=T.computeB(v),y[g]=1/T.computeC()}if(0!==p){for(g=0;g!==m;g++){var E=(A=d[g]).vlambda,b=A.wlambda;E.set(0,0,0),b.set(0,0,0)}for(u=0;u!==h;u++){c=0;for(var C=0;C!==p;C++)T=_[C],n=S[C],i=y[C],(l=x[C])+(s=i*(n-T.computeGWlambda()-T.eps*l))<T.minForce?s=T.minForce-l:l+s>T.maxForce&&(s=T.maxForce-l),x[C]+=s,c+=s>0?s:-s,T.addToWlambda(s);if(c*c<f)break}for(g=0;g!==m;g++){var A,w=(A=d[g]).velocity,R=A.angularVelocity;A.vlambda.vmul(A.linearFactor,A.vlambda),w.vadd(A.vlambda,w),A.wlambda.vmul(A.angularFactor,A.wlambda),R.vadd(A.wlambda,R)}for(var I=_.length,P=1/v;I--;)_[I].multiplier=x[I]*P}return u}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(e,t){function n(){this.equations=[]}t.exports=n,n.prototype.solve=function(){return 0},n.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},n.prototype.removeEquation=function(e){var t=this.equations,n=t.indexOf(e);-1!==n&&t.splice(n,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(e,t){t.exports=r,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver"),i=e("../objects/Body");function r(e){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}r.prototype=new n;var o=[],a=[],s={bodies:[]},c=i.STATIC;function l(e){for(var t=e.length,n=0;n!==t;n++){var i=e[n];if(!(i.visited||i.body.type&c))return i}return!1}var u=[];function h(e,t,n,i){for(u.push(e),e.visited=!0,t(e,n,i);u.length;)for(var r,o=u.pop();r=l(o.children);)r.visited=!0,t(r,n,i),u.push(r)}function f(e,t,n){t.push(e.body);for(var i=e.eqs.length,r=0;r!==i;r++){var o=e.eqs[r];-1===n.indexOf(o)&&n.push(o)}}function _(e,t){return t.id-e.id}r.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},r.prototype.solve=function(e,t){for(var n=o,i=this.nodePool,r=t.bodies,c=this.equations,u=c.length,p=r.length,d=this.subsolver;i.length<p;)i.push(this.createNode());n.length=p;for(var m=0;m<p;m++)n[m]=i[m];for(m=0;m!==p;m++){var v=n[m];v.body=r[m],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var g=0;g!==u;g++){var y=c[g],S=(m=r.indexOf(y.bi),r.indexOf(y.bj)),x=n[m],T=n[S];x.children.push(T),x.eqs.push(y),T.children.push(x),T.eqs.push(y)}var E,b=0,C=a;d.tolerance=this.tolerance,d.iterations=this.iterations;for(var A=s;E=l(n);){C.length=0,A.bodies.length=0,h(E,f,A.bodies,C);var w=C.length;for(C=C.sort(_),m=0;m!==w;m++)d.addEquation(C[m]);d.solve(e,A),d.removeAllEquations(),b++}return b}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(e,t){var n=function(){};t.exports=n,n.prototype={constructor:n,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var n=this._listeners;return void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)},hasAnyEventListener:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var n=this._listeners;if(void 0===n[e])return this;var i=n[e].indexOf(t);return-1!==i&&n[e].splice(i,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var n=0,i=t.length;n<i;n++)t[n].call(this,e)}return this}}},{}],51:[function(e,t){var n=e("../collision/AABB"),i=e("../math/Vec3");function r(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new n,this.data=[],this.children=[]}function o(e,t){(t=t||{}).root=null,t.aabb=e,r.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}t.exports=o,o.prototype=new r,r.prototype.reset=function(){this.children.length=this.data.length=0},r.prototype.insert=function(e,t,n){var i=this.data;if(n=n||0,!this.aabb.contains(e))return!1;var r=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var o=!1;r.length||(this.subdivide(),o=!0);for(var a=0;8!==a;a++)if(r[a].insert(e,t,n+1))return!0;o&&(r.length=0)}return i.push(t),!0};var a=new i;r.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,o=e.upperBound,s=this.children;s.push(new r({aabb:new n({lowerBound:new i(0,0,0)})}),new r({aabb:new n({lowerBound:new i(1,0,0)})}),new r({aabb:new n({lowerBound:new i(1,1,0)})}),new r({aabb:new n({lowerBound:new i(1,1,1)})}),new r({aabb:new n({lowerBound:new i(0,1,1)})}),new r({aabb:new n({lowerBound:new i(0,0,1)})}),new r({aabb:new n({lowerBound:new i(1,0,1)})}),new r({aabb:new n({lowerBound:new i(0,1,0)})})),o.vsub(t,a),a.scale(.5,a);for(var c=this.root||this,l=0;8!==l;l++){var u=s[l];u.root=c;var h=u.aabb.lowerBound;h.x*=a.x,h.y*=a.y,h.z*=a.z,h.vadd(t,h),h.vadd(a,u.aabb.upperBound)}},r.prototype.aabbQuery=function(e,t){this.data,this.children;for(var n=[this];n.length;){var i=n.pop();i.aabb.overlaps(e)&&Array.prototype.push.apply(t,i.data),Array.prototype.push.apply(n,i.children)}return t};var s=new n;r.prototype.rayQuery=function(e,t,n){return e.getAABB(s),s.toLocalFrame(t,s),this.aabbQuery(s,n),n},r.prototype.removeEmptyNodes=function(){for(var e=this.children.length-1;e>=0;e--)this.children[e].removeEmptyNodes(),this.children[e].children.length||this.children[e].data.length||this.children.splice(e,1)}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(e,t){function n(){this.objects=[],this.type=Object}t.exports=n,n.prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t]);return this},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},n.prototype.resize=function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}},{}],53:[function(e,t){function n(){this.data={keys:[]}}t.exports=n,n.prototype.get=function(e,t){if(e>t){var n=t;t=e,e=n}return this.data[e+"-"+t]},n.prototype.set=function(e,t,n){if(e>t){var i=t;t=e,e=i}var r=e+"-"+t;return this.get(e,t)||this.data.keys.push(r),this.data[r]=n,this.data[r]},n.prototype.del=function(e,t){if(e>t){var n=t;t=e,e=n}var i=e+"-"+t,r=this.data.keys.indexOf(i);return r>=0&&(this.data.keys.splice(r,1),delete this.data[i],!0)},n.prototype.reset=function(){this.data={keys:[]}},n.prototype.getLength=function(){return this.data.keys.length},n.prototype.getKeyByIndex=function(e){return this.data.keys[e]},n.prototype.getDataByKey=function(e){return this.data[e]}},{}],54:[function(e,t){function n(){}t.exports=n,n.defaults=function(e,t){for(var n in e=e||{},t)n in e||(e[n]=t[n]);return e}},{}],55:[function(e,t){t.exports=r;var n=e("../math/Vec3"),i=e("./Pool");function r(){i.call(this),this.type=n}r.prototype=new i,r.prototype.constructObject=function(){return new n}},{"../math/Vec3":31,"./Pool":52}],56:[function(e,t){t.exports=h;var n=e("../collision/AABB"),i=(e("../objects/Body"),e("../shapes/Shape")),r=e("../collision/Ray"),o=e("../math/Vec3"),a=e("../math/Transform"),s=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),c=(e("../solver/Solver"),e("../utils/Vec3Pool")),l=e("../equations/ContactEquation"),u=e("../equations/FrictionEquation");function h(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new c,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}h.prototype.createContactEquation=function(e,t,n,i,r,o){var a;this.contactPointPool.length?((a=this.contactPointPool.pop()).bi=e,a.bj=t):a=new l(e,t),a.enabled=e.collisionResponse&&t.collisionResponse&&n.collisionResponse&&i.collisionResponse;var s=this.currentContactMaterial,c=s.contactEquationRelaxation;a.restitution=s.restitution;var u=n.material||e.material,h=i.material||t.material;if(u&&h){u.restitution>=0&&h.restitution>=0&&(a.restitution=u.restitution*h.restitution);var f=u.correctInelastic||h.correctInelastic;f&&(c*=f)}return a.setSpookParams(s.contactEquationStiffness,c,this.world.dt),a.si=r||n,a.sj=o||i,a},h.prototype.createFrictionEquationsFromContact=function(e,t){var n=e.bi,i=e.bj,r=e.si,o=e.sj,a=this.world,s=this.currentContactMaterial,c=s.friction,l=r.material||n.material,h=o.material||i.material;if(l&&h&&l.friction>=0&&h.friction>=0&&(c=l.friction*h.friction),c>0){var f=c*a.gravity.length(),_=n.invMass+i.invMass;_>0&&(_=1/_);var p=this.frictionEquationPool,d=p.length?p.pop():new u(n,i,f*_),m=p.length?p.pop():new u(n,i,f*_);return d.bi=m.bi=n,d.bj=m.bj=i,d.minForce=m.minForce=-f*_,d.maxForce=m.maxForce=f*_,d.ri.copy(e.ri),d.rj.copy(e.rj),m.ri.copy(e.ri),m.rj.copy(e.rj),e.ni.tangents(d.t,m.t),d.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),m.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),d.enabled=m.enabled=e.enabled,t.push(d,m),!0}return!1};var f=new o,_=new o,p=new o;h.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var n=this.frictionResult[this.frictionResult.length-2],i=this.frictionResult[this.frictionResult.length-1];f.setZero(),_.setZero(),p.setZero();for(var r=t.bi,o=(t.bj,0);o!==e;o++)(t=this.result[this.result.length-1-o]).bodyA!==r?(f.vadd(t.ni,f),_.vadd(t.ri,_),p.vadd(t.rj,p)):(f.vsub(t.ni,f),_.vadd(t.rj,_),p.vadd(t.ri,p));var a=1/e;_.scale(a,n.ri),p.scale(a,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),f.normalize(),f.tangents(n.t,i.t)}};var d=new o,m=new o,v=new s,g=new s;h.prototype.getContacts=function(e,t,n,i,r,o,a){this.contactPointPool=r,this.frictionEquationPool=a,this.result=i,this.frictionResult=o;for(var s=v,c=g,l=d,u=m,h=0,f=e.length;h!==f;h++){var _=e[h],p=t[h],y=null;_.material&&p.material&&(y=n.getContactMaterial(_.material,p.material)||null);for(var S=0==_.collisionResponse||0==p.collisionResponse,x=0;x<_.shapes.length;x++){_.quaternion.mult(_.shapeOrientations[x],s),_.quaternion.vmult(_.shapeOffsets[x],l),l.vadd(_.position,l);for(var T=_.shapes[x],E=0;E<p.shapes.length;E++){p.quaternion.mult(p.shapeOrientations[E],c),p.quaternion.vmult(p.shapeOffsets[E],u),u.vadd(p.position,u);var b=p.shapes[E];if(T.collisionFilterMask&b.collisionFilterGroup&&b.collisionFilterMask&T.collisionFilterGroup&&!(l.distanceTo(u)>T.boundingSphereRadius+b.boundingSphereRadius)){S|=0==T.collisionResponse||0==b.collisionResponse;var C=null;T.material&&b.material&&(C=n.getContactMaterial(T.material,b.material)||null),this.currentContactMaterial=C||y||n.defaultContactMaterial;var A=this[T.type|b.type];if(A&&(T.type<b.type?A.call(this,T,b,l,u,s,c,_,p,T,b,S):A.call(this,b,T,u,l,c,s,p,_,T,b,S))&&S){n.shapeOverlapKeeper.set(T.id,b.id),n.bodyOverlapKeeper.set(_.id,p.id);var w={si:T,sj:b};n.triggerDic.set(T.id,b.id,w),n.oldTriggerDic.set(T.id,b.id,w)}}}}}},h.prototype[i.types.BOX|i.types.BOX]=h.prototype.boxBox=function(e,t,n,i,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,n,i,r,o,a,s,e,t,u)},h.prototype[i.types.BOX|i.types.CONVEXPOLYHEDRON]=h.prototype.boxConvex=function(e,t,n,i,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,n,i,r,o,a,s,e,t,u)},h.prototype[i.types.BOX|i.types.PARTICLE]=h.prototype.boxParticle=function(e,t,n,i,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,n,i,r,o,a,s,e,t,u)},h.prototype[i.types.SPHERE]=h.prototype.sphereSphere=function(e,t,n,i,r,o,a,s,c,l,u){if(u)return n.distanceSquared(i)<Math.pow(e.radius+t.radius,2);var h=this.createContactEquation(a,s,e,t,c,l);i.vsub(n,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(e.radius,h.ri),h.rj.mult(-t.radius,h.rj),h.ri.vadd(n,h.ri),h.ri.vsub(a.position,h.ri),h.rj.vadd(i,h.rj),h.rj.vsub(s.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var y=new o,S=new o,x=new o;h.prototype[i.types.PLANE|i.types.TRIMESH]=h.prototype.planeTrimesh=function(e,t,n,i,r,s,c,l,u,h,f){var _=new o,p=y;p.set(0,0,1),r.vmult(p,p);for(var d=0;d<t.vertices.length/3;d++){t.getVertex(d,_);var m=new o;m.copy(_),a.pointToWorldFrame(i,s,m,_);var v=S;if(_.vsub(n,v),p.dot(v)<=0){if(f)return!0;var g=this.createContactEquation(c,l,e,t,u,h);g.ni.copy(p);var T=x;p.scale(v.dot(p),T),_.vsub(T,T),g.ri.copy(T),g.ri.vsub(c.position,g.ri),g.rj.copy(_),g.rj.vsub(l.position,g.rj),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}}};var T=new o,E=new o,b=(new o,new o),C=new o,A=new o,w=new o,R=new o,I=new o,P=new o,O=new o,D=new o,M=new o,N=new o,L=new n,B=[];h.prototype[i.types.SPHERE|i.types.TRIMESH]=h.prototype.sphereTrimesh=function(e,t,n,i,o,s,c,l,u,h,f){var _=A,p=w,d=R,m=I,v=P,g=O,y=L,S=C,x=E,F=B;a.pointToLocalFrame(i,s,n,v);var z=e.radius;y.lowerBound.set(v.x-z,v.y-z,v.z-z),y.upperBound.set(v.x+z,v.y+z,v.z+z),t.getTrianglesInAABB(y,F);for(var U=b,k=e.radius*e.radius,G=0;G<F.length;G++)for(var H=0;H<3;H++)if(t.getVertex(t.indices[3*F[G]+H],U),U.vsub(v,x),x.norm2()<=k){if(S.copy(U),a.pointToWorldFrame(i,s,S,U),U.vsub(n,x),f)return!0;(W=this.createContactEquation(c,l,e,t,u,h)).ni.copy(x),W.ni.normalize(),W.ri.copy(W.ni),W.ri.scale(e.radius,W.ri),W.ri.vadd(n,W.ri),W.ri.vsub(c.position,W.ri),W.rj.copy(U),W.rj.vsub(l.position,W.rj),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}for(G=0;G<F.length;G++)for(H=0;H<3;H++){t.getVertex(t.indices[3*F[G]+H],_),t.getVertex(t.indices[3*F[G]+(H+1)%3],p),p.vsub(_,d),v.vsub(p,g);var V=g.dot(d);v.vsub(_,g);var j=g.dot(d);if(j>0&&V<0&&(v.vsub(_,g),m.copy(d),m.normalize(),j=g.dot(m),m.scale(j,g),g.vadd(_,g),(Z=g.distanceTo(v))<e.radius)){if(f)return!0;var W=this.createContactEquation(c,l,e,t,u,h);g.vsub(v,W.ni),W.ni.normalize(),W.ni.scale(e.radius,W.ri),a.pointToWorldFrame(i,s,g,g),g.vsub(l.position,W.rj),a.vectorToWorldFrame(s,W.ni,W.ni),a.vectorToWorldFrame(s,W.ri,W.ri),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}}for(var q=D,X=M,Y=N,K=T,Q=(G=0,F.length);G!==Q;G++){t.getTriangleVertices(F[G],q,X,Y),t.getNormal(F[G],K),v.vsub(q,g);var Z=g.dot(K);if(K.scale(Z,g),v.vsub(g,g),Z=g.distanceTo(v),r.pointInTriangle(g,q,X,Y)&&Z<e.radius){if(f)return!0;W=this.createContactEquation(c,l,e,t,u,h),g.vsub(v,W.ni),W.ni.normalize(),W.ni.scale(e.radius,W.ri),a.pointToWorldFrame(i,s,g,g),g.vsub(l.position,W.rj),a.vectorToWorldFrame(s,W.ni,W.ni),a.vectorToWorldFrame(s,W.ri,W.ri),this.result.push(W),this.createFrictionEquationsFromContact(W,this.frictionResult)}}F.length=0};var F=new o,z=new o,U=new o,k=new o,G=new o;h.prototype[i.types.SPHERE|i.types.PLANE]=h.prototype.spherePlane=function(e,t,n,i,r,o,a,s,c,l,u){if(U.set(0,0,1),o.vmult(U,U),U.negate(U),U.normalize(),U.mult(e.radius,k),n.vsub(i,F),U.mult(U.dot(F),z),F.vsub(z,G),-F.dot(U)<=e.radius){if(u)return!0;var h=this.createContactEquation(a,s,e,t,c,l);h.ni.copy(U),h.ri.copy(k),h.rj.copy(G);var f=h.ri,_=h.rj;f.vadd(n,f),f.vsub(a.position,f),_.vadd(i,_),_.vsub(s.position,_),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}return!1};var H=new o,V=new o,j=new o;function W(e,t,n){for(var i=null,r=e.length,o=0;o!==r;o++){var a=e[o],s=H;e[(o+1)%r].vsub(a,s);var c=V;s.cross(t,c);var l=j;n.vsub(a,l);var u=c.dot(l);if(!(null===i||u>0&&!0===i||u<=0&&!1===i))return!1;null===i&&(i=u>0)}return!0}var q=new o,X=new o,Y=new o,K=new o,Q=[new o,new o,new o,new o,new o,new o],Z=new o,J=new o,$=new o,ee=new o;h.prototype[i.types.SPHERE|i.types.BOX]=h.prototype.sphereBox=function(e,t,n,i,r,o,a,s,c,l,u){var h=this.v3pool,f=Q;n.vsub(i,q),t.getSideNormals(f,o);for(var _=e.radius,p=!1,d=J,m=$,v=ee,g=null,y=0,S=0,x=0,T=null,E=0,b=f.length;E!==b&&!1===p;E++){var C=X;C.copy(f[E]);var A=C.norm();C.normalize();var w=q.dot(C);if(w<A+_&&w>0){var R=Y,I=K;R.copy(f[(E+1)%3]),I.copy(f[(E+2)%3]);var P=R.norm(),O=I.norm();R.normalize(),I.normalize();var D=q.dot(R),M=q.dot(I);if(D<P&&D>-P&&M<O&&M>-O){var N=Math.abs(w-A-_);if((null===T||N<T)&&(T=N,S=D,x=M,g=A,d.copy(C),m.copy(R),v.copy(I),y++,u))return!0}}}if(y){p=!0;var L=this.createContactEquation(a,s,e,t,c,l);d.mult(-_,L.ri),L.ni.copy(d),L.ni.negate(L.ni),d.mult(g,d),m.mult(S,m),d.vadd(m,d),v.mult(x,v),d.vadd(v,L.rj),L.ri.vadd(n,L.ri),L.ri.vsub(a.position,L.ri),L.rj.vadd(i,L.rj),L.rj.vsub(s.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}for(var B=h.get(),F=Z,z=0;2!==z&&!p;z++)for(var U=0;2!==U&&!p;U++)for(var k=0;2!==k&&!p;k++)if(B.set(0,0,0),z?B.vadd(f[0],B):B.vsub(f[0],B),U?B.vadd(f[1],B):B.vsub(f[1],B),k?B.vadd(f[2],B):B.vsub(f[2],B),i.vadd(B,F),F.vsub(n,F),F.norm2()<_*_){if(u)return!0;p=!0,(L=this.createContactEquation(a,s,e,t,c,l)).ri.copy(F),L.ri.normalize(),L.ni.copy(L.ri),L.ri.mult(_,L.ri),L.rj.copy(B),L.ri.vadd(n,L.ri),L.ri.vsub(a.position,L.ri),L.rj.vadd(i,L.rj),L.rj.vsub(s.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}h.release(B),B=null;var G=h.get(),H=h.get(),V=(L=h.get(),h.get()),j=(N=h.get(),f.length);for(z=0;z!==j&&!p;z++)for(U=0;U!==j&&!p;U++)if(z%3!=U%3){f[U].cross(f[z],G),G.normalize(),f[z].vadd(f[U],H),L.copy(n),L.vsub(H,L),L.vsub(i,L);var W=L.dot(G);for(G.mult(W,V),k=0;k===z%3||k===U%3;)k++;N.copy(n),N.vsub(V,N),N.vsub(H,N),N.vsub(i,N);var te=Math.abs(W),ne=N.norm();if(te<f[k].norm()&&ne<_){if(u)return!0;p=!0;var ie=this.createContactEquation(a,s,e,t,c,l);H.vadd(V,ie.rj),ie.rj.copy(ie.rj),N.negate(ie.ni),ie.ni.normalize(),ie.ri.copy(ie.rj),ie.ri.vadd(i,ie.ri),ie.ri.vsub(n,ie.ri),ie.ri.normalize(),ie.ri.mult(_,ie.ri),ie.ri.vadd(n,ie.ri),ie.ri.vsub(a.position,ie.ri),ie.rj.vadd(i,ie.rj),ie.rj.vsub(s.position,ie.rj),this.result.push(ie),this.createFrictionEquationsFromContact(ie,this.frictionResult)}}h.release(G,H,L,V,N)};var te=new o,ne=new o,ie=new o,re=new o,oe=new o,ae=new o,se=new o,ce=new o,le=new o,ue=new o;h.prototype[i.types.SPHERE|i.types.CONVEXPOLYHEDRON]=h.prototype.sphereConvex=function(e,t,n,i,r,o,a,s,c,l,u){var h=this.v3pool;n.vsub(i,te);for(var f=t.faceNormals,_=t.faces,p=t.vertices,d=e.radius,m=0;m!==p.length;m++){var v=p[m],g=oe;o.vmult(v,g),i.vadd(g,g);var y=re;if(g.vsub(n,y),y.norm2()<d*d)return!!u||(S=!0,(N=this.createContactEquation(a,s,e,t,c,l)).ri.copy(y),N.ri.normalize(),N.ni.copy(N.ri),N.ri.mult(d,N.ri),g.vsub(i,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),this.result.push(N),void this.createFrictionEquationsFromContact(N,this.frictionResult))}for(var S=!1,x=(m=0,_.length);m!==x&&!1===S;m++){var T=f[m],E=_[m],b=ae;o.vmult(T,b);var C=se;o.vmult(p[E[0]],C),C.vadd(i,C);var A=ce;b.mult(-d,A),n.vadd(A,A);var w=le;A.vsub(C,w);var R=w.dot(b),I=ue;if(n.vsub(C,I),R<0&&I.dot(b)>0){for(var P=[],O=0,D=E.length;O!==D;O++){var M=h.get();o.vmult(p[E[O]],M),i.vadd(M,M),P.push(M)}if(W(P,b,n)){if(u)return!0;S=!0;var N=this.createContactEquation(a,s,e,t,c,l);b.mult(-d,N.ri),b.negate(N.ni);var L=h.get();b.mult(-R,L);var B=h.get();b.mult(-d,B),n.vsub(i,N.rj),N.rj.vadd(B,N.rj),N.rj.vadd(L,N.rj),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),h.release(L),h.release(B),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult),O=0;for(var F=P.length;O!==F;O++)h.release(P[O]);return}for(O=0;O!==E.length;O++){var z=h.get(),U=h.get();o.vmult(p[E[(O+1)%E.length]],z),o.vmult(p[E[(O+2)%E.length]],U),i.vadd(z,z),i.vadd(U,U);var k=ne;U.vsub(z,k);var G=ie;k.unit(G);var H=h.get(),V=h.get();n.vsub(z,V);var j=V.dot(G);G.mult(j,H),H.vadd(z,H);var q=h.get();if(H.vsub(n,q),j>0&&j*j<k.norm2()&&q.norm2()<d*d){if(u)return!0;for(N=this.createContactEquation(a,s,e,t,c,l),H.vsub(i,N.rj),H.vsub(n,N.ni),N.ni.normalize(),N.ni.mult(d,N.ri),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult),O=0,F=P.length;O!==F;O++)h.release(P[O]);return h.release(z),h.release(U),h.release(H),h.release(q),void h.release(V)}h.release(z),h.release(U),h.release(H),h.release(q),h.release(V)}for(O=0,F=P.length;O!==F;O++)h.release(P[O])}}},new o,new o,h.prototype[i.types.PLANE|i.types.BOX]=h.prototype.planeBox=function(e,t,n,i,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,n,i,r,o,a,s,e,t,u)};var he=new o,fe=new o,_e=new o,pe=new o;h.prototype[i.types.PLANE|i.types.CONVEXPOLYHEDRON]=h.prototype.planeConvex=function(e,t,n,i,r,o,a,s,c,l,u){var h=he,f=fe;f.set(0,0,1),r.vmult(f,f);for(var _=0,p=_e,d=0;d!==t.vertices.length;d++)if(h.copy(t.vertices[d]),o.vmult(h,h),i.vadd(h,h),h.vsub(n,p),f.dot(p)<=0){if(u)return!0;var m=this.createContactEquation(a,s,e,t,c,l),v=pe;f.mult(f.dot(p),v),h.vsub(v,v),v.vsub(n,m.ri),m.ni.copy(f),h.vsub(i,m.rj),m.ri.vadd(n,m.ri),m.ri.vsub(a.position,m.ri),m.rj.vadd(i,m.rj),m.rj.vsub(s.position,m.rj),this.result.push(m),_++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&_&&this.createFrictionFromAverage(_)};var de=new o,me=new o;h.prototype[i.types.CONVEXPOLYHEDRON]=h.prototype.convexConvex=function(e,t,n,i,r,o,a,s,c,l,u,h,f){var _=de;if(!(n.distanceTo(i)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,n,r,i,o,_,h,f)){var p=[],d=me;e.clipAgainstHull(n,r,t,i,o,_,-100,100,p);for(var m=0,v=0;v!==p.length;v++){if(u)return!0;var g=this.createContactEquation(a,s,e,t,c,l),y=g.ri,S=g.rj;_.negate(g.ni),p[v].normal.negate(d),d.mult(p[v].depth,d),p[v].point.vadd(d,y),S.copy(p[v].point),y.vsub(n,y),S.vsub(i,S),y.vadd(n,y),y.vsub(a.position,y),S.vadd(i,S),S.vsub(s.position,S),this.result.push(g),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(g,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}};var ve=new o,ge=new o,ye=new o;h.prototype[i.types.PLANE|i.types.PARTICLE]=h.prototype.planeParticle=function(e,t,n,i,r,o,a,s,c,l,u){var h=ve;h.set(0,0,1),a.quaternion.vmult(h,h);var f=ge;if(i.vsub(a.position,f),h.dot(f)<=0){if(u)return!0;var _=this.createContactEquation(s,a,t,e,c,l);_.ni.copy(h),_.ni.negate(_.ni),_.ri.set(0,0,0);var p=ye;h.mult(h.dot(i),p),i.vsub(p,p),_.rj.copy(p),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult)}};var Se=new o;h.prototype[i.types.PARTICLE|i.types.SPHERE]=h.prototype.sphereParticle=function(e,t,n,i,r,o,a,s,c,l,u){var h=Se;if(h.set(0,0,1),i.vsub(n,h),h.norm2()<=e.radius*e.radius){if(u)return!0;var f=this.createContactEquation(s,a,t,e,c,l);h.normalize(),f.rj.copy(h),f.rj.mult(e.radius,f.rj),f.ni.copy(h),f.ni.negate(f.ni),f.ri.set(0,0,0),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}};var xe=new s,Te=new o,Ee=(new o,new o),be=new o,Ce=new o;h.prototype[i.types.PARTICLE|i.types.CONVEXPOLYHEDRON]=h.prototype.convexParticle=function(e,t,n,i,r,o,a,s,c,l,u){var h=-1,f=Ee,_=Ce,p=null,d=Te;if(d.copy(i),d.vsub(n,d),r.conjugate(xe),xe.vmult(d,d),e.pointIsInside(d)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(n,r),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(r);for(var m=0,v=e.faces.length;m!==v;m++){var g=[e.worldVertices[e.faces[m][0]]],y=e.worldFaceNormals[m];i.vsub(g[0],be);var S=-y.dot(be);if(null===p||Math.abs(S)<Math.abs(p)){if(u)return!0;p=S,h=m,f.copy(y)}}if(-1!==h){var x=this.createContactEquation(s,a,t,e,c,l);f.mult(p,_),_.vadd(i,_),_.vsub(n,_),x.rj.copy(_),f.negate(x.ni),x.ri.set(0,0,0);var T=x.ri,E=x.rj;T.vadd(i,T),T.vsub(s.position,T),E.vadd(n,E),E.vsub(a.position,E),this.result.push(x),this.createFrictionEquationsFromContact(x,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},h.prototype[i.types.BOX|i.types.HEIGHTFIELD]=h.prototype.boxHeightfield=function(e,t,n,i,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,n,i,r,o,a,s,e,t,u)};var Ae=new o,we=new o,Re=[0];h.prototype[i.types.CONVEXPOLYHEDRON|i.types.HEIGHTFIELD]=h.prototype.convexHeightfield=function(e,t,n,i,r,o,s,c,l,u,h){var f=t.data,_=t.elementSize,p=e.boundingSphereRadius,d=we,m=Re,v=Ae;a.pointToLocalFrame(i,o,n,v);var g=Math.floor((v.x-p)/_)-1,y=Math.ceil((v.x+p)/_)+1,S=Math.floor((v.y-p)/_)-1,x=Math.ceil((v.y+p)/_)+1;if(!(y<0||x<0||g>f.length||S>f[0].length)){g<0&&(g=0),y<0&&(y=0),S<0&&(S=0),x<0&&(x=0),g>=f.length&&(g=f.length-1),y>=f.length&&(y=f.length-1),x>=f[0].length&&(x=f[0].length-1),S>=f[0].length&&(S=f[0].length-1);var T=[];t.getRectMinMax(g,S,y,x,T);var E=T[0],b=T[1];if(!(v.z-p>b||v.z+p<E))for(var C=g;C<y;C++)for(var A=S;A<x;A++){var w=!1;if(t.getConvexTrianglePillar(C,A,!1),a.pointToWorldFrame(i,o,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(w=this.convexConvex(e,t.pillarConvex,n,d,r,o,s,c,l,u,h,m,null)),h&&w)return!0;if(t.getConvexTrianglePillar(C,A,!0),a.pointToWorldFrame(i,o,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(w=this.convexConvex(e,t.pillarConvex,n,d,r,o,s,c,l,u,h,m,null)),h&&w)return!0}}};var Ie=new o,Pe=new o;h.prototype[i.types.SPHERE|i.types.HEIGHTFIELD]=h.prototype.sphereHeightfield=function(e,t,n,i,r,o,s,c,l,u,h){var f=t.data,_=e.radius,p=t.elementSize,d=Pe,m=Ie;a.pointToLocalFrame(i,o,n,m);var v=Math.floor((m.x-_)/p)-1,g=Math.ceil((m.x+_)/p)+1,y=Math.floor((m.y-_)/p)-1,S=Math.ceil((m.y+_)/p)+1;if(!(g<0||S<0||v>f.length||y>f[0].length)){v<0&&(v=0),g<0&&(g=0),y<0&&(y=0),S<0&&(S=0),v>=f.length&&(v=f.length-1),g>=f.length&&(g=f.length-1),S>=f[0].length&&(S=f[0].length-1),y>=f[0].length&&(y=f[0].length-1);var x=[];t.getRectMinMax(v,y,g,S,x);var T=x[0],E=x[1];if(!(m.z-_>E||m.z+_<T))for(var b=this.result,C=v;C<g;C++)for(var A=y;A<S;A++){var w=b.length,R=!1;if(t.getConvexTrianglePillar(C,A,!1),a.pointToWorldFrame(i,o,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(R=this.sphereConvex(e,t.pillarConvex,n,d,r,o,s,c,e,t,h)),h&&R)return!0;if(t.getConvexTrianglePillar(C,A,!0),a.pointToWorldFrame(i,o,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(R=this.sphereConvex(e,t.pillarConvex,n,d,r,o,s,c,e,t,h)),h&&R)return!0;if(b.length-w>2)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(e,t){t.exports=g,e("../shapes/Shape");var n=e("../math/Vec3"),i=e("../math/Quaternion"),r=e("../solver/GSSolver"),o=(e("../equations/ContactEquation"),e("../equations/FrictionEquation"),e("./Narrowphase")),a=e("../utils/EventTarget"),s=e("../collision/ArrayCollisionMatrix"),c=e("../collision/ObjectCollisionMatrix"),l=e("../collision/OverlapKeeper"),u=e("../material/Material"),h=e("../material/ContactMaterial"),f=e("../objects/Body"),_=e("../utils/TupleDictionary"),p=e("../collision/RaycastResult"),d=e("../collision/AABB"),m=e("../collision/Ray"),v=e("../collision/NaiveBroadphase");function g(e){e=e||{},a.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new n,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new v,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new r,this.constraints=[],this.narrowphase=new o(this),this.collisionMatrix=new s,this.collisionMatrixPrevious=new s,this.bodyOverlapKeeper=new l,this.shapeOverlapKeeper=new l,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new _,this.defaultMaterial=new u("default"),this.defaultContactMaterial=new h(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this),this.substeps=0,this.cm=new c,this.tm=new c,this.triggerDic=new _,this.oldTriggerDic=new _,this.contactsDic=new _,this.oldContactsDic=new _}g.idToBodyMap={},g.idToShapeMap={},g.integrateKinematic=!1,g.ccdSphereAdvance=!1,g.prototype=new a,new d;var y=new m;if(g.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},g.prototype.numObjects=function(){return this.bodies.length},g.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()},g.prototype.add=g.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof f&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.cm.setNumObjects(this.bodies.length),g.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))},g.prototype.addConstraint=function(e){this.constraints.push(e)},g.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},g.prototype.rayTest=function(e,t,n){n instanceof p?this.raycastClosest(e,t,{skipBackfaces:!0},n):this.raycastAll(e,t,{skipBackfaces:!0},n)},g.prototype.raycastAll=function(e,t,n,i){return n.mode=m.ALL,n.from=e,n.to=t,n.callback=i,y.intersectWorld(this,n)},g.prototype.raycastAny=function(e,t,n,i){return n.mode=m.ANY,n.from=e,n.to=t,n.result=i,y.intersectWorld(this,n)},g.prototype.raycastClosest=function(e,t,n,i){return n.mode=m.CLOSEST,n.from=e,n.to=t,n.result=i,y.intersectWorld(this,n)},g.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,n=this.bodies,i=n.indexOf(e);if(-1!==i){n.splice(i,1);for(var r=0;r!==n.length;r++)n[r].index=r;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete g.idToBodyMap[e.id],this.cm.setNumObjects(t),this.dispatchEvent(this.removeBodyEvent)}},g.prototype.removeBody=g.prototype.remove,g.prototype.getBodyById=function(e){return g.idToBodyMap[e]},g.prototype.getShapeById=function(e){return g.idToShapeMap[e]},g.prototype.addMaterial=function(e){this.materials.push(e)},g.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var S=Date.now();performance.timing&&performance.timing.navigationStart&&(S=performance.timing.navigationStart),performance.now=function(){return Date.now()-S}}g.prototype.saveKinematicAndApplyGravity=function(e){for(var t=this.bodies,n=this.bodies.length,i=0;i!==n;i++){var r=t[i];r.type===f.DYNAMIC?r.applyGravity(this.gravity):r.type===f.KINEMATIC&&r.updateKinematic(e)}},g.prototype.step=function(e,t,n){if(n=n||10,0===(t=t||0))this.saveKinematicAndApplyGravity(e),this.internalStep(e),this.time+=e,this.substeps=1;else{for(this.saveKinematicAndApplyGravity(t),this.accumulator+=t,this.substeps=0;this.accumulator>=e&&this.substeps<n;)this.internalStep(e),this.accumulator-=e,this.substeps++;for(var i=this.accumulator%e/e,r=0;r!==this.bodies.length;r++){var o=this.bodies[r];o.previousPosition.lerp(o.position,i,o.interpolatedPosition),o.previousQuaternion.slerp(o.quaternion,i,o.interpolatedQuaternion),o.previousQuaternion.normalize()}this.time+=t}this.clearForces()};var x,T,E,b,C,A,w={type:"postStep"},R={type:"preStep"},I={type:"collide",body:null,contact:null},P=[],O=[],D=[],M=[];new n,new n,new n,new n,new n,new n,new n,new n,new n,new i,new i,new i,new n,g.prototype.internalStep=function(e){this.dt=e;var t,n=this.contacts,i=D,r=M,o=this.numObjects(),a=this.bodies,s=this.solver,c=this.doProfiling,l=this.profile,u=f.DYNAMIC,h=this.constraints,_=O,p=0;c&&(t=performance.now()),p=0;for(var d=this.subsystems.length;p!==d;p++)this.subsystems[p].update();c&&(t=performance.now()),i.length=0,r.length=0,this.broadphase.collisionPairs(this,i,r),c&&(l.broadphase=performance.now()-t);var m=h.length;for(p=0;p!==m;p++)if(!(N=h[p]).collideConnected)for(var v=i.length-1;v>=0;v-=1)(N.bodyA===i[v]&&N.bodyB===r[v]||N.bodyB===i[v]&&N.bodyA===r[v])&&(i.splice(v,1),r.splice(v,1));this.collisionMatrixTick(),c&&(t=performance.now());var g=P,y=n.length;for(p=0;p!==y;p++)g.push(n[p]);n.length=0;var S=this.frictionEquations.length;for(p=0;p!==S;p++)_.push(this.frictionEquations[p]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,r,this,n,g,this.frictionEquations,_),c&&(l.narrowphase=performance.now()-t),c&&(t=performance.now()),p=0;p<this.frictionEquations.length;p++)s.addEquation(this.frictionEquations[p]);for(var x=n.length,T=0;T!==x;T++){var E=(N=n[T]).bi,b=N.bj,C=N.si,A=N.sj;C.material&&A.material?C.material.restitution>=0&&A.material.restitution>=0&&(N.restitution=C.material.restitution*A.material.restitution):E.material&&b.material&&E.material.restitution>=0&&b.material.restitution>=0&&(N.restitution=E.material.restitution*b.material.restitution),s.addEquation(N),E.allowSleep&&E.type===f.DYNAMIC&&E.sleepState===f.SLEEPING&&b.sleepState===f.AWAKE&&b.type!==f.STATIC&&b.velocity.norm2()+b.angularVelocity.norm2()>=2*Math.pow(b.sleepSpeedLimit,2)&&(E._wakeUpAfterNarrowphase=!0),b.allowSleep&&b.type===f.DYNAMIC&&b.sleepState===f.SLEEPING&&E.sleepState===f.AWAKE&&E.type!==f.STATIC&&E.velocity.norm2()+E.angularVelocity.norm2()>=2*Math.pow(E.sleepSpeedLimit,2)&&(b._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(E,b,!0),this.collisionMatrixPrevious.get(E,b)||(I.body=b,I.contact=N,E.dispatchEvent(I),I.body=E,b.dispatchEvent(I)),this.bodyOverlapKeeper.set(E.id,b.id),this.shapeOverlapKeeper.set(C.id,A.id)}for(this.emitContactEvents(),c&&(l.makeContactConstraints=performance.now()-t,t=performance.now()),p=0;p!==o;p++)(E=a[p])._wakeUpAfterNarrowphase&&(E.wakeUp(),E._wakeUpAfterNarrowphase=!1);for(m=h.length,p=0;p!==m;p++){var N;(N=h[p]).update(),v=0;for(var L=N.equations.length;v!==L;v++){var B=N.equations[v];s.addEquation(B)}}for(s.solve(e,this),c&&(l.solve=performance.now()-t),s.removeAllEquations(),this.dispatchEvent(R),p=0;p!==o;p++)(E=a[p]).preStep&&E.preStep.call(E);c&&(t=performance.now());var F=this.stepnumber%(this.quatNormalizeSkip+1)==0,z=this.quatNormalizeFast;for(p=0;p!==o;p++)a[p].integrate(e,F,z);var U=Math.pow;for(p=0;p!==o;p++)if((E=a[p]).type&u){var k=U(1-E.linearDamping,e),G=E.velocity;G.mult(k,G);var H=E.angularVelocity;if(H){var V=U(1-E.angularDamping,e);H.mult(V,H)}}for(this.broadphase.dirty=!0,c&&(l.integrate=performance.now()-t),this.time+=e,this.stepnumber+=1,this.dispatchEvent(w),p=0;p!==o;p++){var j=(E=a[p]).postStep;j&&j.call(E)}if(this.allowSleep)for(p=0;p!==o;p++)a[p].sleepTick(this.time)},g.prototype.emitContactEvents=(x=[],T=[],E={type:"beginContact",bodyA:null,bodyB:null},b={type:"endContact",bodyA:null,bodyB:null},C={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},A={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},function(){var e=this.hasAnyEventListener("beginContact"),t=this.hasAnyEventListener("endContact");if((e||t)&&this.bodyOverlapKeeper.getDiff(x,T),e){for(var n=0,i=x.length;n<i;n+=2)E.bodyA=this.getBodyById(x[n]),E.bodyB=this.getBodyById(x[n+1]),this.dispatchEvent(E);E.bodyA=E.bodyB=null}if(t){for(n=0,i=T.length;n<i;n+=2)b.bodyA=this.getBodyById(T[n]),b.bodyB=this.getBodyById(T[n+1]),this.dispatchEvent(b);b.bodyA=b.bodyB=null}x.length=T.length=0;var r=this.hasAnyEventListener("beginShapeContact"),o=this.hasAnyEventListener("endShapeContact");if((r||o)&&this.shapeOverlapKeeper.getDiff(x,T),r){for(n=0,i=x.length;n<i;n+=2){var a=this.getShapeById(x[n]),s=this.getShapeById(x[n+1]);C.shapeA=a,C.shapeB=s,C.bodyA=a.body,C.bodyB=s.body,this.dispatchEvent(C)}C.bodyA=C.bodyB=C.shapeA=C.shapeB=null}if(o){for(n=0,i=T.length;n<i;n+=2)a=this.getShapeById(T[n]),s=this.getShapeById(T[n+1]),A.shapeA=a,A.shapeB=s,A.bodyA=a.body,A.bodyB=s.body,this.dispatchEvent(A);A.bodyA=A.bodyB=A.shapeA=A.shapeB=null}}),g.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,n=0;n!==t;n++){var i=e[n];i.force,i.torque,i.force.set(0,0,0),i.torque.set(0,0,0)}};var N={type:"cc-trigger",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null},L={type:"cc-collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},B=[];g.prototype.emitTriggeredEvents=function(){if(0!=this.substeps){for(var e,t,n=this.triggerDic.getLength();n--;)if(e=this.triggerDic.getKeyByIndex(n),null!=(t=this.triggerDic.getDataByKey(e))){var i=t.si,r=t.sj;this.tm.get(i,r)?N.event="onTriggerStay":(this.tm.set(i,r,!0),N.event="onTriggerEnter"),N.selfShape=i,N.otherShape=r,N.selfBody=i.body,N.otherBody=r.body,i.dispatchEvent(N),N.selfShape=r,N.otherShape=i,N.selfBody=r.body,N.otherBody=i.body,r.dispatchEvent(N)}for(n=this.oldTriggerDic.getLength();n>0;)n--,e=this.oldTriggerDic.getKeyByIndex(n),null==this.triggerDic.getDataByKey(e)&&null!=(t=this.oldTriggerDic.getDataByKey(e))&&(i=t.si,r=t.sj,this.tm.set(i,r,!1),this.oldTriggerDic.del(i.id,r.id)&&n--,N.event="onTriggerExit",N.selfShape=i,N.otherShape=r,N.selfBody=i.body,N.otherBody=r.body,i.dispatchEvent(N),N.selfShape=r,N.otherShape=i,N.selfBody=r.body,N.otherBody=i.body,r.dispatchEvent(N));this.triggerDic.reset()}},g.prototype.emitCollisionEvents=function(){if(0!=this.substeps){for(var e,t,n=this.contacts,i=this.contacts.length;i--;){var r=(u=n[i]).si,o=u.sj,a=this.contactsDic.get(r.id,o.id);null==a&&(a=this.contactsDic.set(r.id,o.id,[])),a.push(u)}for(i=this.contactsDic.getLength();i--;)if(e=this.contactsDic.getKeyByIndex(i),null!=(t=this.contactsDic.getDataByKey(e))){r=t[0].si,o=t[0].sj;var s=r.body,c=o.body;this.cm.get(s,c)?L.event="onCollisionStay":(this.cm.set(s,c,!0),L.event="onCollisionEnter"),L.bi=s,L.contact=t[0],L.contacts=t,L.body=c,L.selfShape=r,L.otherShape=o,s.dispatchEvent(L),L.body=s,L.selfShape=o,L.otherShape=r,c.dispatchEvent(L)}var l=B;for(i=l.length;i--;){var u;r=(u=l[i]).si,o=u.sj,null==this.oldContactsDic.get(r.id,o.id)&&this.oldContactsDic.set(r.id,o.id,u)}for(i=this.oldContactsDic.getLength();i--;)e=this.oldContactsDic.getKeyByIndex(i),null==this.contactsDic.getDataByKey(e)&&(r=(t=this.oldContactsDic.getDataByKey(e)).si,o=t.sj,s=r.body,c=o.body,this.cm.get(s,c)&&(s.isSleeping()&&c.isSleeping()||(this.cm.set(s,c,!1),L.bi=s,L.contact=t,L.event="onCollisionExit",L.body=c,L.selfShape=r,L.otherShape=o,L.contacts.length=0,L.contacts.push(t),s.dispatchEvent(L),L.body=s,L.selfShape=o,L.otherShape=r,c.dispatchEvent(L))));this.contactsDic.reset(),this.oldContactsDic.reset(),P=B,B=this.contacts.slice(),this.contacts.length=0}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2)}(t={exports:{}}),t.exports}();function QEe(e){i._global.CC_PHYSICS_BUILTIN="builtin"===e,i._global.CC_PHYSICS_CANNON="cannon.js"===e,i._global.CC_PHYSICS_AMMO="ammo.js"===e}!function(e){e[e.DYNAMIC=1]="DYNAMIC",e[e.STATIC=2]="STATIC",e[e.KINEMATIC=4]="KINEMATIC"}(HEe||(HEe=e("ERigidBodyType",{}))),Qe(HEe),function(e){e[e.X_AXIS=0]="X_AXIS",e[e.Y_AXIS=1]="Y_AXIS",e[e.Z_AXIS=2]="Z_AXIS"}(VEe||(VEe=e("EAxisDirection",{}))),Qe(VEe),function(e){e[e.VERTEX=1]="VERTEX",e[e.LINE=2]="LINE",e[e.TRIANGLE=3]="TRIANGLE",e[e.TETRAHEDRON=4]="TETRAHEDRON"}(jEe||(jEe={})),Qe(jEe),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CAPSULE=2]="CAPSULE",e[e.CYLINDER=3]="CYLINDER",e[e.CONE=4]="CONE",e[e.MESH=5]="MESH",e[e.PLANE=6]="PLANE",e[e.SIMPLEX=7]="SIMPLEX",e[e.TERRAIN=8]="TERRAIN"}(WEe||(WEe={})),Qe(WEe),function(e){e[e.POINT_TO_POINT=0]="POINT_TO_POINT",e[e.HINGE=1]="HINGE",e[e.CONE_TWIST=2]="CONE_TWIST"}(qEe||(qEe={})),Qe(qEe),function(e){e[e.DEFAULT=1]="DEFAULT"}(XEe||(XEe={})),Qe(XEe);var ZEe,JEe={id:"",switchTo:function(e){if(JEe.runInEditor){var t=JEe;if(JEe.physicsWorld&&e!==JEe.id&&null!=JEe.backend[e]?(JEe.physicsWorld.destroy(),console.info("[PHYSICS]: switch from "+JEe.id+" to "+e+"."),QEe(e),t.id=e,t.wrapper=JEe.backend[e],t.physicsWorld=nbe()):(console.info("[PHYSICS]: using "+e+"."),t.physicsWorld=nbe()),YEe){var n=t.physicsWorld;n.setGravity(YEe.gravity),n.setAllowSleep(YEe.allowSleep),n.setDefaultMaterial(YEe.defaultMaterial)}}},register:function(e,t){if(console.info("[PHYSICS]: register "+e+"."),JEe.backend[e]=t,!JEe.physicsWorld||JEe.id===e){QEe(e);var n=JEe;n.id=e,n.wrapper=t}},wrapper:{},backend:{},physicsWorld:null,runInEditor:!0},$Ee=function(){return 0},ebe={impl:null,setGravity:$Ee,setAllowSleep:$Ee,setDefaultMaterial:$Ee,step:$Ee,syncAfterEvents:$Ee,syncSceneToPhysics:$Ee,raycast:$Ee,raycastClosest:$Ee,emitEvents:$Ee,destroy:$Ee};function tbe(e,t){return null==e&&(JEe.id?p(JEe.id+" physics does not support "+ZEe[t]):A(9600),!0)}function nbe(){return tbe(JEe.wrapper.PhysicsWorld,ZEe.World)?ebe:new JEe.wrapper.PhysicsWorld}!function(e){e[e.World=0]="World",e[e.RigidBody=1]="RigidBody",e[e.BoxCollider=2]="BoxCollider",e[e.SphereCollider=3]="SphereCollider",e[e.CapsuleCollider=4]="CapsuleCollider",e[e.MeshCollider=5]="MeshCollider",e[e.CylinderCollider=6]="CylinderCollider",e[e.ConeCollider=7]="ConeCollider",e[e.TerrainCollider=8]="TerrainCollider",e[e.SimplexCollider=9]="SimplexCollider",e[e.PlaneCollider=10]="PlaneCollider",e[e.PointToPointConstraint=11]="PointToPointConstraint",e[e.HingeConstraint=12]="HingeConstraint",e[e.ConeTwistConstraint=13]="ConeTwistConstraint"}(ZEe||(ZEe={}));var ibe={impl:null,rigidBody:null,isAwake:!1,isSleepy:!1,isSleeping:!1,initialize:$Ee,onEnable:$Ee,onDisable:$Ee,onDestroy:$Ee,setType:$Ee,setMass:$Ee,setLinearDamping:$Ee,setAngularDamping:$Ee,useGravity:$Ee,setLinearFactor:$Ee,setAngularFactor:$Ee,setAllowSleep:$Ee,wakeUp:$Ee,sleep:$Ee,clearState:$Ee,clearForces:$Ee,clearVelocity:$Ee,setSleepThreshold:$Ee,getSleepThreshold:$Ee,getLinearVelocity:$Ee,setLinearVelocity:$Ee,getAngularVelocity:$Ee,setAngularVelocity:$Ee,applyForce:$Ee,applyLocalForce:$Ee,applyImpulse:$Ee,applyLocalImpulse:$Ee,applyTorque:$Ee,applyLocalTorque:$Ee,setGroup:$Ee,getGroup:$Ee,addGroup:$Ee,removeGroup:$Ee,setMask:$Ee,getMask:$Ee,addMask:$Ee,removeMask:$Ee,isUsingCCD:$Ee,useCCD:$Ee},rbe={INITED:!1},obe={impl:null,collider:null,attachedRigidBody:null,initialize:$Ee,onLoad:$Ee,onEnable:$Ee,onDisable:$Ee,onDestroy:$Ee,setGroup:$Ee,getGroup:$Ee,addGroup:$Ee,removeGroup:$Ee,setMask:$Ee,getMask:$Ee,addMask:$Ee,removeMask:$Ee,setMaterial:$Ee,setAsTrigger:$Ee,setCenter:$Ee,getAABB:$Ee,getBoundingSphere:$Ee,updateSize:$Ee,updateRadius:$Ee,setRadius:$Ee,setCylinderHeight:$Ee,setDirection:$Ee,setHeight:$Ee,setShapeType:$Ee,setVertices:$Ee,setMesh:$Ee,setTerrain:$Ee,setNormal:$Ee,setConstant:$Ee,updateEventListener:$Ee};var abe,sbe,cbe,lbe,ube,hbe,fbe,_be,pbe={INITED:!1},dbe={impl:null,initialize:$Ee,onLoad:$Ee,onEnable:$Ee,onDisable:$Ee,onDestroy:$Ee,setEnableCollision:$Ee,setConnectedBody:$Ee,setPivotA:$Ee,setPivotB:$Ee,setAxis:$Ee};var mbe=function(t){return e({PhysicsMaterial:t,PhysicMaterial:t}),t}(sl("cc.PhysicsMaterial")((_be=fbe=function(e){function t(){var n;return(n=e.call(this)||this).id=void 0,q(n,"_friction",cbe,V(n)),q(n,"_rollingFriction",lbe,V(n)),q(n,"_spinningFriction",ube,V(n)),q(n,"_restitution",hbe,V(n)),t.allMaterials.push(V(n)),n.id=t._idCounter++,n._uuid||(n._uuid="pm_"+n.id),n}F(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._friction=this._friction,e._restitution=this._restitution,e._rollingFriction=this._rollingFriction,e._spinningFriction=this._spinningFriction,e},n.destroy=function(){if(e.prototype.destroy.call(this)){var n=t.allMaterials.indexOf(this);return n>=0&&t.allMaterials.splice(n,1),!0}return!1},n.setValues=function(e,n,i,r){var o=this._friction!==e||this._rollingFriction!==n||this._spinningFriction!==i||this._restitution!==r;this._friction=e,this._rollingFriction=n,this._spinningFriction=i,this._restitution=r,o&&this.emit(t.EVENT_UPDATE)},L(t,[{key:"friction",get:function(){return this._friction},set:function(e){Qn(this._friction,e)||(this._friction=e,this.emit(t.EVENT_UPDATE))}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){Qn(this._rollingFriction,e)||(this._rollingFriction=e,this.emit(t.EVENT_UPDATE))}},{key:"spinningFriction",get:function(){return this._spinningFriction},set:function(e){Qn(this._spinningFriction,e)||(this._spinningFriction=e,this.emit(t.EVENT_UPDATE))}},{key:"restitution",get:function(){return this._restitution},set:function(e){Qn(this._restitution,e)||(this._restitution=e,this.emit(t.EVENT_UPDATE))}}]),t}(zu),fbe.allMaterials=[],fbe.EVENT_UPDATE="event_update",fbe._idCounter=0,X((sbe=_be).prototype,"friction",[bl],Object.getOwnPropertyDescriptor(sbe.prototype,"friction"),sbe.prototype),X(sbe.prototype,"rollingFriction",[bl],Object.getOwnPropertyDescriptor(sbe.prototype,"rollingFriction"),sbe.prototype),X(sbe.prototype,"spinningFriction",[bl],Object.getOwnPropertyDescriptor(sbe.prototype,"spinningFriction"),sbe.prototype),X(sbe.prototype,"restitution",[bl],Object.getOwnPropertyDescriptor(sbe.prototype,"restitution"),sbe.prototype),cbe=X(sbe.prototype,"_friction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.6}}),lbe=X(sbe.prototype,"_rollingFriction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ube=X(sbe.prototype,"_spinningFriction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hbe=X(sbe.prototype,"_restitution",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),abe=sbe))||abe),vbe=e("PhysicsRayResult",function(){function e(){this._hitPoint=new yi,this._hitNormal=new yi,this._distance=0,this._collider=null}var t=e.prototype;return t._assign=function(e,t,n,i){yi.copy(this._hitPoint,e),yi.copy(this._hitNormal,i),this._distance=t,this._collider=n},t.clone=function(){var t=new e;return yi.copy(t._hitPoint,this._hitPoint),yi.copy(t._hitNormal,this._hitNormal),t._distance=this._distance,t._collider=this._collider,t},L(e,[{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collider}},{key:"hitNormal",get:function(){return this._hitNormal}}]),e}()),gbe=function(e){if(1===e){for(var t=this,n=function(e){var n="_"+(1<<e);t[n]=0,t.updateArray=[],Object.defineProperty(t,1<<e,{get:function(){return this[n]},set:function(t){this[n]!==t&&(this[n]=t,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})},i=0;i<32;i++)n(i);this._1=XEe.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=XEe.DEFAULT}};i.internal.PhysicsGroup=XEe;var ybe,Sbe,xbe,Tbe,Ebe,bbe,Cbe,Abe,wbe,Rbe,Ibe,Pbe,Obe,Dbe,Mbe,Nbe,Lbe,Bbe,Fbe,zbe,Ube,kbe,Gbe,Hbe,Vbe,jbe,Wbe,qbe,Xbe,Ybe,Kbe,Qbe,Zbe,Jbe,$be,eCe,tCe,nCe,iCe,rCe,oCe,aCe,sCe,cCe,lCe=e("PhysicsSystem",function(e){function t(){var t;return(t=e.call(this)||this).raycastClosestResult=new vbe,t.raycastResults=[],t.collisionMatrix=new gbe(1),t.minVolumeSize=1e-5,t.useNodeChains=!1,t._enable=!0,t._allowSleep=!0,t._maxSubSteps=1,t._subStepCount=0,t._fixedTimeStep=1/60,t._autoSimulation=!0,t._accumulator=0,t._sleepThreshold=.1,t._gravity=new yi(0,-10,0),t._material=new mbe,t.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},t.raycastResultPool=new qe((function(){return new vbe}),1),t._material.on(mbe.EVENT_UPDATE,t._updateMaterial,V(t)),t}F(t,e);var n=t.prototype;return n.postUpdate=function(e){if(this.physicsWorld)if(this._enable){if(this._autoSimulation){for(this._subStepCount=0,this._accumulator+=e,eN.emit($M.EVENT_BEFORE_PHYSICS);this._subStepCount<this._maxSubSteps;){if(!(this._accumulator>=this._fixedTimeStep)){this.physicsWorld.syncSceneToPhysics();break}this.physicsWorld.syncSceneToPhysics(),this.physicsWorld.step(this._fixedTimeStep),this.physicsWorld.emitEvents(),this.physicsWorld.syncAfterEvents(),this._accumulator-=this._fixedTimeStep,this._subStepCount++}eN.emit($M.EVENT_AFTER_PHYSICS)}}else this.physicsWorld.syncSceneToPhysics()},n.resetConfiguration=function(e){var t=e||(JM.config?JM.config.physics:null);if(t){if("boolean"==typeof t.allowSleep&&(this._allowSleep=t.allowSleep),"number"==typeof t.fixedTimeStep&&(this._fixedTimeStep=t.fixedTimeStep),"number"==typeof t.maxSubSteps&&(this._maxSubSteps=t.maxSubSteps),"number"==typeof t.sleepThreshold&&(this._sleepThreshold=t.sleepThreshold),"boolean"==typeof t.autoSimulation&&(this.autoSimulation=t.autoSimulation),t.gravity&&yi.copy(this._gravity,t.gravity),t.defaultMaterial&&this._material.setValues(t.defaultMaterial.friction,t.defaultMaterial.rollingFriction,t.defaultMaterial.spinningFriction,t.defaultMaterial.restitution),t.collisionMatrix)for(var n in t.collisionMatrix)this.collisionMatrix[""+(1<<parseInt(n))]=t.collisionMatrix[n];if(t.collisionGroups){var i=t.collisionGroups;i instanceof Array&&(i.forEach((function(e){XEe[e.name]=1<<e.index})),Qe.update(XEe))}}this.physicsWorld&&(this.physicsWorld.setGravity(this._gravity),this.physicsWorld.setAllowSleep(this._allowSleep),this.physicsWorld.setDefaultMaterial(this._material))},n.resetAccumulator=function(e){void 0===e&&(e=0),this._accumulator=e},n.step=function(e,t,n){this.physicsWorld&&this.physicsWorld.step(e,t,n)},n.syncSceneToPhysics=function(){this.physicsWorld&&this.physicsWorld.syncSceneToPhysics()},n.emitEvents=function(){this.physicsWorld&&this.physicsWorld.emitEvents()},n.raycast=function(e,t,n,i){return void 0===t&&(t=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycast(e,this.raycastOptions,this.raycastResultPool,this.raycastResults))},n.raycastClosest=function(e,t,n,i){return void 0===t&&(t=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycastClosest(e,this.raycastOptions,this.raycastClosestResult))},n._updateMaterial=function(){this.physicsWorld&&this.physicsWorld.setDefaultMaterial(this._material)},t.constructAndRegister=function(){if(!t._instance){var e=new t;e.resetConfiguration(),function(e){if(YEe||(YEe=e),JEe.runInEditor&&!JEe.physicsWorld){console.info("[PHYSICS]: using "+JEe.id+".");var t=JEe.physicsWorld=nbe();t.setGravity(YEe.gravity),t.setAllowSleep(YEe.allowSleep),t.setDefaultMaterial(YEe.defaultMaterial)}}(e),t._instance=e,eN.registerSystem(t.ID,e,e.priority)}},L(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.physicsWorld&&this.physicsWorld.setAllowSleep(e)}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(e){this._maxSubSteps=e}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(e){this._fixedTimeStep=e}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity.set(e),this.physicsWorld&&this.physicsWorld.setGravity(e)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){this._sleepThreshold=e}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(e){this._autoSimulation=e}},{key:"defaultMaterial",get:function(){return this._material}},{key:"physicsWorld",get:function(){return JEe.physicsWorld}}],[{key:"PHYSICS_NONE",get:function(){return!JEe.id}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===JEe.id}},{key:"PHYSICS_CANNON",get:function(){return"cannon.js"===JEe.id}},{key:"PHYSICS_BULLET",get:function(){return"bullet"===JEe.id}},{key:"PHYSICS_PHYSX",get:function(){return"physx"===JEe.id}},{key:"PhysicsGroup",get:function(){return XEe}},{key:"instance",get:function(){return t._instance}}]),t}(kM));lCe.ID="PHYSICS",lCe._instance=null,eN.once($M.EVENT_INIT,(function(){lCe.constructAndRegister()}));var uCe,hCe,fCe,_Ce,pCe,dCe,mCe,vCe,gCe,yCe,SCe,xCe,TCe,ECe,bCe,CCe,ACe,wCe,RCe,ICe,PCe,OCe,DCe=function(t){return e({RigidBody:t,RigidBodyComponent:t}),t}((ybe=sl("cc.RigidBody"),Sbe=El(),xbe=yl(),Tbe=ll(-1),Ebe=Hl(lCe.PhysicsGroup),bbe=Nl(),Cbe=Rl(),Abe=Hl(HEe),wbe=Nl(),Rbe=Rl(),Ibe=Cl(),Pbe=Nl(),Obe=Rl(),Dbe=Cl(),Mbe=Nl(),Nbe=Rl(),Lbe=Cl(),Bbe=Nl(),Fbe=Rl(),zbe=Cl(),Ube=Nl(),kbe=Rl(),Gbe=Cl(),Hbe=Nl(),Vbe=Rl(),jbe=Cl(),Wbe=Nl(),qbe=Rl(),Xbe=Cl(),Ybe=Nl(),Kbe=Rl(),ybe(Qbe=Sbe(Qbe=xbe(Qbe=gl(Qbe=ul(Qbe=Tbe((cCe=sCe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._body=null,q(t,"_group",Jbe,V(t)),q(t,"_type",$be,V(t)),q(t,"_mass",eCe,V(t)),q(t,"_allowSleep",tCe,V(t)),q(t,"_linearDamping",nCe,V(t)),q(t,"_angularDamping",iCe,V(t)),q(t,"_useGravity",rCe,V(t)),q(t,"_linearFactor",oCe,V(t)),q(t,"_angularFactor",aCe,V(t)),t}F(t,e);var n=t.prototype;return n.onLoad=function(){JEe.runInEditor&&(this._body=tbe(JEe.wrapper.RigidBody,ZEe.RigidBody)?ibe:new JEe.wrapper.RigidBody,this._body.initialize(this))},n.onEnable=function(){this._body&&this._body.onEnable()},n.onDisable=function(){this._body&&this._body.onDisable()},n.onDestroy=function(){this._body&&this._body.onDestroy()},n.applyForce=function(e,t){this._isInitialized&&this._body.applyForce(e,t)},n.applyLocalForce=function(e,t){this._isInitialized&&this._body.applyLocalForce(e,t)},n.applyImpulse=function(e,t){this._isInitialized&&this._body.applyImpulse(e,t)},n.applyLocalImpulse=function(e,t){this._isInitialized&&this._body.applyLocalImpulse(e,t)},n.applyTorque=function(e){this._isInitialized&&this._body.applyTorque(e)},n.applyLocalTorque=function(e){this._isInitialized&&this._body.applyLocalTorque(e)},n.wakeUp=function(){this._isInitialized&&this._body.wakeUp()},n.sleep=function(){this._isInitialized&&this._body.sleep()},n.clearState=function(){this._isInitialized&&this._body.clearState()},n.clearForces=function(){this._isInitialized&&this._body.clearForces()},n.clearVelocity=function(){this._isInitialized&&this._body.clearVelocity()},n.getLinearVelocity=function(e){this._isInitialized&&this._body.getLinearVelocity(e)},n.setLinearVelocity=function(e){this._isInitialized&&this._body.setLinearVelocity(e)},n.getAngularVelocity=function(e){this._isInitialized&&this._body.getAngularVelocity(e)},n.setAngularVelocity=function(e){this._isInitialized&&this._body.setAngularVelocity(e)},n.getGroup=function(){return this._isInitialized?this._body.getGroup():0},n.setGroup=function(e){this._isInitialized&&this._body.setGroup(e)},n.addGroup=function(e){this._isInitialized&&this._body.addGroup(e)},n.removeGroup=function(e){this._isInitialized&&this._body.removeGroup(e)},n.getMask=function(){return this._isInitialized?this._body.getMask():0},n.setMask=function(e){this._isInitialized&&this._body.setMask(e)},n.addMask=function(e){this._isInitialized&&this._body.addMask(e)},n.removeMask=function(e){this._isInitialized&&this._body.removeMask(e)},L(t,[{key:"group",get:function(){return this._group},set:function(e){this._group=e,this._body&&this._body.getGroup()!==e&&this._body.setGroup(e)}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._body&&this._body.setType(e))}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass!==e&&(e=e<=0?1e-4:e,this._mass=e,this._body&&this._body.setMass(e))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._body&&this._body.setAllowSleep(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body&&this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body&&this._body.setAngularDamping(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body&&this._body.useGravity(e)}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){yi.copy(this._linearFactor,e),this._body&&this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){yi.copy(this._angularFactor,e),this._body&&this._body.setAngularFactor(this._angularFactor)}},{key:"sleepThreshold",get:function(){return this._isInitialized?this._body.getSleepThreshold():.1},set:function(e){this._isInitialized&&this._body.setSleepThreshold(e)}},{key:"useCCD",get:function(){return!!this._isInitialized&&this._body.isUsingCCD()},set:function(e){this._isInitialized&&this._body.useCCD(e)}},{key:"isAwake",get:function(){return!!this._isInitialized&&this._body.isAwake}},{key:"isSleepy",get:function(){return!!this._isInitialized&&this._body.isSleepy}},{key:"isSleeping",get:function(){return!!this._isInitialized&&this._body.isSleeping}},{key:"isStatic",get:function(){return this._type===HEe.STATIC},set:function(e){e&&this.isStatic||!e&&!this.isStatic||(this.type=e?HEe.STATIC:HEe.DYNAMIC)}},{key:"isDynamic",get:function(){return this._type===HEe.DYNAMIC},set:function(e){e&&this.isDynamic||!e&&!this.isDynamic||(this.type=e?HEe.DYNAMIC:HEe.KINEMATIC)}},{key:"isKinematic",get:function(){return this._type===HEe.KINEMATIC},set:function(e){e&&this.isKinematic||!e&&!this.isKinematic||(this.type=e?HEe.KINEMATIC:HEe.DYNAMIC)}},{key:"body",get:function(){return this._body}},{key:"_isInitialized",get:function(){var e=null===this._body;return e&&d("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}}]),t}(oh),sCe.Type=HEe,X((Zbe=cCe).prototype,"group",[Ebe,bbe,Cbe],Object.getOwnPropertyDescriptor(Zbe.prototype,"group"),Zbe.prototype),X(Zbe.prototype,"type",[Abe,wbe,Rbe],Object.getOwnPropertyDescriptor(Zbe.prototype,"type"),Zbe.prototype),X(Zbe.prototype,"mass",[Ibe,Pbe,Obe],Object.getOwnPropertyDescriptor(Zbe.prototype,"mass"),Zbe.prototype),X(Zbe.prototype,"allowSleep",[Dbe,Mbe,Nbe],Object.getOwnPropertyDescriptor(Zbe.prototype,"allowSleep"),Zbe.prototype),X(Zbe.prototype,"linearDamping",[Lbe,Bbe,Fbe],Object.getOwnPropertyDescriptor(Zbe.prototype,"linearDamping"),Zbe.prototype),X(Zbe.prototype,"angularDamping",[zbe,Ube,kbe],Object.getOwnPropertyDescriptor(Zbe.prototype,"angularDamping"),Zbe.prototype),X(Zbe.prototype,"useGravity",[Gbe,Hbe,Vbe],Object.getOwnPropertyDescriptor(Zbe.prototype,"useGravity"),Zbe.prototype),X(Zbe.prototype,"linearFactor",[jbe,Wbe,qbe],Object.getOwnPropertyDescriptor(Zbe.prototype,"linearFactor"),Zbe.prototype),X(Zbe.prototype,"angularFactor",[Xbe,Ybe,Kbe],Object.getOwnPropertyDescriptor(Zbe.prototype,"angularFactor"),Zbe.prototype),Jbe=X(Zbe.prototype,"_group",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lCe.PhysicsGroup.DEFAULT}}),$be=X(Zbe.prototype,"_type",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HEe.DYNAMIC}}),eCe=X(Zbe.prototype,"_mass",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tCe=X(Zbe.prototype,"_allowSleep",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nCe=X(Zbe.prototype,"_linearDamping",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),iCe=X(Zbe.prototype,"_angularDamping",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),rCe=X(Zbe.prototype,"_useGravity",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),oCe=X(Zbe.prototype,"_linearFactor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(1,1,1)}}),aCe=X(Zbe.prototype,"_angularFactor",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(1,1,1)}}),Qbe=Zbe))||Qbe)||Qbe)||Qbe)||Qbe)||Qbe)||Qbe));DCe||(DCe=function(t){return e({RigidBody:t,RigidBodyComponent:t}),t}({}));var MCe=function(t){return e({Collider:t,ColliderComponent:t}),t}((uCe=sl("cc.Collider"),hCe=Hl(DCe),fCe=wl(),_Ce=Nl(),pCe=Rl(),dCe=Hl(mbe),mCe=wl(),vCe=Nl(),gCe=Rl(),yCe=Nl(),SCe=Rl(),xCe=Hl(yi),TCe=Nl(),ECe=Rl(),bCe=Hl(mbe),uCe((OCe=PCe=function(e){function t(t){var n;return(n=e.call(this)||this).type=void 0,n._shape=null,n._aabb=null,n._boundingSphere=null,n._isSharedMaterial=!0,n._needTriggerEvent=!1,n._needCollisionEvent=!1,q(n,"_material",wCe,V(n)),q(n,"_isTrigger",RCe,V(n)),q(n,"_center",ICe,V(n)),n.type=t,n}F(t,e);var n=t.prototype;return n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return this._updateNeedEvent(t),o},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),this._updateNeedEvent()},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return this._updateNeedEvent(t),r},n.removeAll=function(t){e.prototype.removeAll.call(this,t),this._updateNeedEvent()},n.getGroup=function(){return this._isInitialized?this._shape.getGroup():0},n.setGroup=function(e){this._isInitialized&&this._shape.setGroup(e)},n.addGroup=function(e){this._isInitialized&&this._shape.addGroup(e)},n.removeGroup=function(e){this._isInitialized&&this._shape.removeGroup(e)},n.getMask=function(){return this._isInitialized?this._shape.getMask():0},n.setMask=function(e){this._isInitialized&&this._shape.setMask(e)},n.addMask=function(e){this._isInitialized&&this._shape.addMask(e)},n.removeMask=function(e){this._isInitialized&&this._shape.removeMask(e)},n.onLoad=function(){JEe.runInEditor&&(this.sharedMaterial=null==this._material?lCe.instance.defaultMaterial:this._material,this._shape=function(e){return rbe.INITED||(rbe.INITED=!0,rbe[WEe.BOX]=function(){return tbe(JEe.wrapper.BoxShape,ZEe.BoxCollider)?obe:new JEe.wrapper.BoxShape},rbe[WEe.SPHERE]=function(){return tbe(JEe.wrapper.SphereShape,ZEe.SphereCollider)?obe:new JEe.wrapper.SphereShape},rbe[WEe.CAPSULE]=function(){return tbe(JEe.wrapper.CapsuleShape,ZEe.CapsuleCollider)?obe:new JEe.wrapper.CapsuleShape},rbe[WEe.CYLINDER]=function(){return tbe(JEe.wrapper.CylinderShape,ZEe.CylinderCollider)?obe:new JEe.wrapper.CylinderShape},rbe[WEe.CONE]=function(){return tbe(JEe.wrapper.ConeShape,ZEe.ConeCollider)?obe:new JEe.wrapper.ConeShape},rbe[WEe.MESH]=function(){return tbe(JEe.wrapper.TrimeshShape,ZEe.MeshCollider)?obe:new JEe.wrapper.TrimeshShape},rbe[WEe.TERRAIN]=function(){return tbe(JEe.wrapper.TerrainShape,ZEe.TerrainCollider)?obe:new JEe.wrapper.TerrainShape},rbe[WEe.SIMPLEX]=function(){return tbe(JEe.wrapper.SimplexShape,ZEe.SimplexCollider)?obe:new JEe.wrapper.SimplexShape},rbe[WEe.PLANE]=function(){return tbe(JEe.wrapper.PlaneShape,ZEe.PlaneCollider)?obe:new JEe.wrapper.PlaneShape}),rbe[e]()}(this.type),this._shape.initialize(this),this._shape.onLoad())},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&(this._needTriggerEvent=!1,this._needCollisionEvent=!1,this._shape.updateEventListener(),this._material&&this._material.off(mbe.EVENT_UPDATE,this._updateMaterial,this),this._shape.onDestroy()),this._boundingSphere&&this._boundingSphere.destroy()},n._updateMaterial=function(){this._shape&&this._shape.setMaterial(this._material)},n._updateNeedEvent=function(e){this.isValid&&(void 0!==e?("onCollisionEnter"!==e&&"onCollisionStay"!==e&&"onCollisionExit"!==e||(this._needCollisionEvent=!0),"onTriggerEnter"!==e&&"onTriggerStay"!==e&&"onTriggerExit"!==e||(this._needTriggerEvent=!0)):(this.hasEventListener("onTriggerEnter")||this.hasEventListener("onTriggerStay")||this.hasEventListener("onTriggerExit")||(this._needTriggerEvent=!1),this.hasEventListener("onCollisionEnter")||this.hasEventListener("onCollisionStay")||this.hasEventListener("onCollisionExit")||(this._needCollisionEvent=!1)),this._shape&&this._shape.updateEventListener())},L(t,[{key:"attachedRigidBody",get:function(){return e=this.node,(t=e.getComponent(DCe))&&t.isValid?t:null;var e,t}},{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._isSharedMaterial&&this._material&&(this._material.off(mbe.EVENT_UPDATE,this._updateMaterial,this),this._material=this._material.clone(),this._material.on(mbe.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(e){this._shape?(e&&this._material?this._material.id!==e.id&&(this._material.off(mbe.EVENT_UPDATE,this._updateMaterial,this),e.on(mbe.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):e&&!this._material?(e.on(mbe.EVENT_UPDATE,this._updateMaterial,this),this._material=e):!e&&this._material&&(this._material.off(mbe.EVENT_UPDATE,this._updateMaterial,this),this._material=e),this._updateMaterial()):this._material=e}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e,this._shape&&this._shape.setAsTrigger(this._isTrigger)}},{key:"center",get:function(){return this._center},set:function(e){yi.copy(this._center,e),this._shape&&this._shape.setCenter(this._center)}},{key:"shape",get:function(){return this._shape}},{key:"worldBounds",get:function(){return null==this._aabb&&(this._aabb=new zc),this._shape&&this._shape.getAABB(this._aabb),this._aabb}},{key:"boundingSphere",get:function(){return null==this._boundingSphere&&(this._boundingSphere=new so),this._shape&&this._shape.getBoundingSphere(this._boundingSphere),this._boundingSphere}},{key:"needTriggerEvent",get:function(){return this._needTriggerEvent}},{key:"needCollisionEvent",get:function(){return this._needCollisionEvent}},{key:"_isInitialized",get:function(){var e=null===this._shape;return e&&d("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}}]),t}(sn(oh)),PCe.Type=WEe,PCe.Axis=VEe,X((ACe=OCe).prototype,"attachedRigidBody",[hCe,Al,fCe,_Ce,pCe],Object.getOwnPropertyDescriptor(ACe.prototype,"attachedRigidBody"),ACe.prototype),X(ACe.prototype,"sharedMaterial",[dCe,mCe,vCe,gCe],Object.getOwnPropertyDescriptor(ACe.prototype,"sharedMaterial"),ACe.prototype),X(ACe.prototype,"isTrigger",[yCe,SCe],Object.getOwnPropertyDescriptor(ACe.prototype,"isTrigger"),ACe.prototype),X(ACe.prototype,"center",[xCe,TCe,ECe],Object.getOwnPropertyDescriptor(ACe.prototype,"center"),ACe.prototype),wCe=X(ACe.prototype,"_material",[bCe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RCe=X(ACe.prototype,"_isTrigger",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ICe=X(ACe.prototype,"_center",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),CCe=ACe))||CCe));function NCe(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}MCe||(MCe=function(t){return e({Collider:t,ColliderComponent:t}),t}({}));var LCe=new yi,BCe=new yi,FCe=new yi,zCe=new yi,UCe=new yi,kCe=new yi,GCe=new yi,HCe=new yi,VCe=new yi,jCe=new yi,WCe=new yi,qCe=new yi,XCe=new yi(0,0,0),YCe=new yi(0,0,0);function KCe(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=.5*n,o=i.radialSegments||32,a=i.heightSegments||1,s=void 0===i.capped||i.capped,c=i.arc||2*Math.PI,l=0;s||(e>0&&l++,t>0&&l++);var u=(o+1)*(a+1);s&&(u+=(o+1)*l+o*l);var h=o*a*6;s&&(h+=o*l*3);var f=new Array(h),_=new Array(3*u),p=new Array(3*u),d=new Array(2*u),m=Math.max(e,t),v=new yi(-m,-r,-m),g=new yi(m,r,m),y=Math.sqrt(m*m+r*r),S=0,x=0;return function(){for(var i=[],s=e-t,l=s*s/n*Math.sign(s),u=0;u<=a;u++){for(var h=[],m=u/a,v=m*s+t,g=0;g<=o;++g){var y=g/o,T=y*c,E=Math.sin(T),b=Math.cos(T);_[3*S]=v*E,_[3*S+1]=m*n-r,_[3*S+2]=v*b,yi.normalize(XCe,yi.set(YCe,E,-l,b)),p[3*S]=XCe.x,p[3*S+1]=XCe.y,p[3*S+2]=XCe.z,d[2*S]=2*(1-y)%1,d[2*S+1]=m,h.push(S),++S}i.push(h)}for(var C=0;C<a;++C)for(var A=0;A<o;++A){var w=i[C][A],R=i[C+1][A],I=i[C+1][A+1],P=i[C][A+1];f[x]=w,++x,f[x]=P,++x,f[x]=R,++x,f[x]=P,++x,f[x]=I,++x,f[x]=R,++x}}(),s&&(t>0&&T(!1),e>0&&T(!0)),{positions:_,normals:p,uvs:d,indices:f,minPos:v,maxPos:g,boundingRadius:y};function T(n){for(var i=n?e:t,a=n?1:-1,s=S,l=1;l<=o;++l)_[3*S]=0,_[3*S+1]=r*a,_[3*S+2]=0,p[3*S]=0,p[3*S+1]=a,p[3*S+2]=0,d[2*S]=.5,d[2*S+1]=.5,++S;for(var u=S,h=0;h<=o;++h){var m=h/o*c,v=Math.cos(m),g=Math.sin(m);_[3*S]=i*g,_[3*S+1]=r*a,_[3*S+2]=i*v,p[3*S]=0,p[3*S+1]=a,p[3*S+2]=0,d[2*S]=.5-.5*g*a,d[2*S+1]=.5+.5*v,++S}for(var y=0;y<o;++y){var T=s+y,E=u+y;n?(f[x]=E+1,++x,f[x]=T,++x,f[x]=E,++x):(f[x]=T,++x,f[x]=E+1,++x,f[x]=E,++x)}}}var QCe=new yi(0,0,0),ZCe=new yi(0,0,0),JCe=new yi(0,0,0),$Ce=new yi(0,0,0),eAe=new yi(0,0,0),tAe=new yi(0,0,0),nAe=new yi(0,0,0),iAe=new yi(0,0,0),rAe=new yi(0,0,0),oAe=Object.freeze({__proto__:null,box:function(e){var t=(e=e||{}).widthSegments||1,n=e.heightSegments||1,i=e.lengthSegments||1,r=(e.width||1)/2,o=(e.height||1)/2,a=(e.length||1)/2,s=[yi.set(UCe,-r,-o,a),yi.set(kCe,r,-o,a),yi.set(GCe,r,o,a),yi.set(HCe,-r,o,a),yi.set(VCe,r,-o,-a),yi.set(jCe,-r,-o,-a),yi.set(WCe,-r,o,-a),yi.set(qCe,r,o,-a)],c=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],u=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],h=[],f=[],_=[],p=[],d=[],m=new yi(-r,-o,-a),v=new yi(r,o,a),g=Math.sqrt(r*r+o*o+a*a);function y(e,t,n){var i,r,o,a,m=h.length/3,v=c[e],g=l[e],y=u[e];for(a=0;a<=n;a++)for(o=0;o<=t;o++)if(i=o/t,r=a/n,yi.lerp(LCe,s[v[0]],s[v[1]],i),yi.lerp(BCe,s[v[0]],s[v[2]],r),yi.subtract(FCe,BCe,s[v[0]]),yi.add(zCe,LCe,FCe),h.push(zCe.x,zCe.y,zCe.z),f.push(g[0],g[1],g[2]),_.push(i,r),p.push(y[0],y[1],y[2],y[3]),o<t&&a<n){var S=t+1,x=o+a*S,T=o+(a+1)*S,E=o+1+(a+1)*S,b=o+1+a*S;d.push(m+x,m+b,m+T),d.push(m+T,m+b,m+E)}}return y(0,t,n),y(4,i,n),y(1,t,n),y(5,i,n),y(3,t,i),y(2,t,i),{positions:h,normals:f,uvs:_,tangents:p,indices:d,minPos:m,maxPos:v,boundingRadius:g}},cone:function(e,t,n){return void 0===e&&(e=.5),void 0===t&&(t=1),void 0===n&&(n={}),KCe(0,e,t,n)},cylinder:KCe,plane:function(e){var t=function(e){return(e=NCe(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),n=t.width,i=t.length,r=t.widthSegments,o=t.lengthSegments,a=.5*n,s=.5*i,c=[],l=[],u=[],h=new yi(-a,0,-s),f=new yi(a,0,s),_=Math.sqrt(n*n+i*i);yi.set(eAe,-a,0,s),yi.set(tAe,a,0,s),yi.set(nAe,-a,0,-s);for(var p=0;p<=o;p++)for(var d=0;d<=r;d++){var m=d/r,v=p/o;if(yi.lerp(QCe,eAe,tAe,m),yi.lerp(ZCe,eAe,nAe,v),yi.subtract(JCe,ZCe,eAe),yi.add($Ce,QCe,JCe),c.push($Ce.x,$Ce.y,$Ce.z),t.includeUV&&l.push(m,v),d<r&&p<o){var g=r+1,y=d+p*g,S=d+(p+1)*g,x=d+1+(p+1)*g,T=d+1+p*g;u.push(y,T,S),u.push(T,x,S)}}var E={positions:c,indices:u,minPos:h,maxPos:f,boundingRadius:_};if(t.includeNormal){var b=(o+1)*(r+1),C=new Array(3*b);E.normals=C;for(var A=0;A<b;++A)C[3*A+0]=0,C[3*A+1]=1,C[3*A+2]=0}return t.includeUV&&(E.uvs=l),E},quad:function(e){var t=NCe(e),n={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(n.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(n.uvs=[0,0,0,1,1,1,1,0]),n},sphere:function(e,t){void 0===e&&(e=.5),void 0===t&&(t={});for(var n=void 0!==t.segments?t.segments:32,i=[],r=[],o=[],a=[],s=new yi(-e,-e,-e),c=new yi(e,e,e),l=e,u=0;u<=n;++u)for(var h=u*Math.PI/n,f=Math.sin(h),_=-Math.cos(h),p=0;p<=n;++p){var d=2*p*Math.PI/n-Math.PI/2,m=Math.sin(d)*f,v=_,g=Math.cos(d)*f,y=p/n,S=u/n;if(i.push(m*e,v*e,g*e),r.push(m,v,g),o.push(y,S),u<n&&p<n){var x=n+1,T=x*u+p,E=x*(u+1)+p,b=x*(u+1)+p+1,C=x*u+p+1;a.push(T,C,E),a.push(C,b,E)}}return{positions:i,indices:a,normals:r,uvs:o,minPos:s,maxPos:c,boundingRadius:l}},torus:function(e,t,n){void 0===e&&(e=.4),void 0===t&&(t=.1),void 0===n&&(n={});for(var i=n.radialSegments||32,r=n.tubularSegments||32,o=n.arc||2*Math.PI,a=[],s=[],c=[],l=[],u=new yi(-e-t,-t,-e-t),h=new yi(e+t,t,e+t),f=e+t,_=0;_<=i;_++)for(var p=0;p<=r;p++){var d=p/r,m=_/i,v=d*o,g=m*Math.PI*2,y=(e+t*Math.cos(g))*Math.sin(v),S=t*Math.sin(g),x=(e+t*Math.cos(g))*Math.cos(v),T=Math.sin(v)*Math.cos(g),E=Math.sin(g),b=Math.cos(v)*Math.cos(g);if(a.push(y,S,x),s.push(T,E,b),c.push(d,m),p<r&&_<i){var C=r+1,A=C*_+p,w=C*(_+1)+p,R=C*(_+1)+p+1,I=C*_+p+1;l.push(A,I,w),l.push(I,R,w)}}return{positions:a,normals:s,uvs:c,indices:l,minPos:u,maxPos:h,boundingRadius:f}},capsule:function(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=n-e-t,o=i.sides||32,a=i.heightSegments||32,s=t/n,c=r/n,l=e/n,u=Math.floor(a*s),h=Math.floor(a*l),f=Math.floor(a*c),_=r+t-n/2,p=t-n/2,d=t-n/2,m=i.arc||2*Math.PI,v=[],g=[],y=[],S=[],x=Math.max(e,t),T=new yi(-x,-n/2,-x),E=new yi(x,n/2,x),b=n/2,C=0,A=[];return function(){for(var e=0;e<=u;++e)for(var n=e*Math.PI/u/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,h=r,f=Math.cos(c)*i,_=s/o,p=e/a;if(v.push(l*t,h*t+d,f*t),g.push(l,h,f),y.push(_,p),e<u&&s<o){var m=o+1,x=m*e+s,T=m*(e+1)+s,E=m*(e+1)+s+1,b=m*e+s+1;S.push(x,b,T),S.push(b,E,T)}++C}}(),function(){for(var n=(e-t)/r,i=0;i<=f;i++){for(var a=[],l=i/f,u=l*(e-t)+t,h=0;h<=o;++h){var _=h/o,d=l*c+s,x=_*m-m/4,T=Math.sin(x),E=Math.cos(x);v.push(u*T),v.push(l*r+p),v.push(u*E),yi.normalize(iAe,yi.set(rAe,T,-n,E)),g.push(iAe.x),g.push(iAe.y),g.push(iAe.z),y.push(_,d),a.push(C),++C}A.push(a)}for(var b=0;b<f;++b)for(var w=0;w<o;++w){var R=A[b][w],I=A[b+1][w],P=A[b+1][w+1],O=A[b][w+1];S.push(R),S.push(O),S.push(I),S.push(O),S.push(P),S.push(I)}}(),function(){for(var t=0;t<=h;++t)for(var n=t*Math.PI/h/2+Math.PI/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,u=Math.sin(c)*i,p=r,d=Math.cos(c)*i,m=s/o,x=t/a+(1-l);if(v.push(u*e,p*e+_,d*e),g.push(u,p,d),y.push(m,x),t<h&&s<o){var T=o+1,E=T*t+s+A[f][o]+1,b=T*(t+1)+s+A[f][o]+1,C=T*(t+1)+s+1+A[f][o]+1,w=T*t+s+1+A[f][o]+1;S.push(E,w,b),S.push(w,C,b)}}}(),{positions:v,normals:g,uvs:y,indices:S,minPos:T,maxPos:E,boundingRadius:b}},circle:function(e){var t=function(e){return(e=NCe(e)).segments=64,e}(e).segments,n=new Array(3*(t+1));n[0]=0,n[1]=0,n[2]=0;var i=new Array(1+2*t);i[0]=0;for(var r=2*Math.PI/t,o=0;o<t;++o){var a=r*o,s=Math.cos(a),c=Math.sin(a),l=3*(o+1);n[l+0]=s,n[l+1]=c,n[l+2]=0;var u=2*o;i[1+u]=o+1,i[1+(u+1)]=o+2}return t>0&&(i[i.length-1]=1),{positions:n,indices:i,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Qr.TRIANGLE_FAN}},translate:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]+=n,e.positions[c]+=i,e.positions[l]+=r}return e.minPos&&(e.minPos.x+=n,e.minPos.y+=i,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=n,e.maxPos.y+=i,e.maxPos.z+=r),e},scale:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]*=n,e.positions[c]*=i,e.positions[l]*=r}return e.minPos&&(e.minPos.x*=n,e.minPos.y*=i,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=n,e.maxPos.y*=i,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(n,i),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==Qr.TRIANGLE_LIST)return e;for(var n=[[0,1],[1,2],[2,0]],i=[],r={},o=0;o<t.length;o+=3)for(var a=0;a<3;++a){var s=t[o+n[a][0]],c=t[o+n[a][1]],l=s>c?c<<16|s:s<<16|c;void 0===r[l]&&(r[l]=0,i.push(s,c))}return e.indices=i,e.primitiveMode=Qr.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],n=[],i={},r=0;r<e.length;r+=3)for(var o=0;o<3;++o){var a=e[r+t[o][0]],s=e[r+t[o][1]],c=a>s?s<<16|a:a<<16|s;void 0===i[c]&&(i[c]=0,n.push(a,s))}return n},invWinding:function(e){for(var t=[],n=0;n<e.length;n+=3)t.push(e[n],e[n+2],e[n+1]);return t},toWavefrontOBJ:function(e,t){if(void 0===t&&(t=1),!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==Qr.TRIANGLE_LIST)return"";for(var n=e.positions,i=e.uvs,r=e.normals,o=e.indices,a=function(e){return o[e]+1+"/"+(o[e]+1)+"/"+(o[e]+1)},s="",c=0;c<n.length;c+=3)s+="v "+n[c]*t+" "+n[c+1]*t+" "+n[c+2]*t+"\n";for(var l=0;l<i.length;l+=2)s+="vt "+i[l]+" "+i[l+1]+"\n";for(var u=0;u<r.length;u+=3)s+="vn "+r[u]+" "+r[u+1]+" "+r[u+2]+"\n";for(var h=0;h<o.length;h+=3)s+="f "+a(h)+" "+a(h+1)+" "+a(h+2)+"\n";return s},normals:function(e,t,n){void 0===n&&(n=1);for(var i=new Array(2*e.length),r=0;r<e.length/3;++r){var o=3*r,a=6*r;i[a+0]=e[o+0],i[a+1]=e[o+1],i[a+2]=e[o+2],i[a+3]=e[o+0]+t[o+0]*n,i[a+4]=e[o+1]+t[o+1]*n,i[a+5]=e[o+2]+t[o+2]*n}return i},applyDefaultGeometryOptions:NCe});function aAe(e,t){e.__cc_wrapper__=t}function sAe(e){return e.__cc_wrapper__}e("primitives",oAe);var cAe=new yi;function lAe(e){return e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z),e}var uAe,hAe,fAe,_Ae,pAe,dAe,mAe,vAe,gAe,yAe,SAe,xAe,TAe,EAe,bAe,CAe,AAe,wAe,RAe,IAe,PAe,OAe,DAe,MAe,NAe,LAe,BAe,FAe,zAe,UAe,kAe,GAe,HAe,VAe,jAe,WAe,qAe,XAe,YAe,KAe,QAe,ZAe,JAe,$Ae,ewe,twe,nwe,iwe,rwe,owe,awe,swe,cwe,lwe,uwe,hwe,fwe,_we,pwe,dwe,mwe,vwe,gwe,ywe,Swe,xwe,Twe,Ewe,bwe,Cwe,Awe,wwe,Rwe,Iwe,Pwe,Owe,Dwe,Mwe,Nwe,Lwe,Bwe,Fwe,zwe,Uwe,kwe,Gwe,Hwe,Vwe,jwe,Wwe,qwe,Xwe,Ywe,Kwe,Qwe,Zwe,Jwe,$we,eRe,tRe,nRe,iRe,rRe,oRe,aRe,sRe,cRe,lRe,uRe,hRe,fRe,_Re,pRe,dRe,mRe,vRe,gRe,yRe,SRe,xRe,TRe,ERe,bRe,CRe,ARe,wRe,RRe,IRe,PRe=Object.freeze({__proto__:null,setWrap:aAe,getWrap:sAe,maxComponent:function(e){return Math.max(e.x,Math.max(e.y,e.z))},VEC3_0:cAe,TriggerEventObject:{type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},CollisionEventObject:{type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},shrinkPositions:function(e){var t=[];if(e.length>=3){t[0]=e[0],t[1]=e[1],t[2]=e[2];for(var n=e.length,i=3;i<n;i+=3){for(var r=e[i],o=e[i+1],a=e[i+2],s=t.length,c=!0,l=0;l<s;l+=3)if(Qn(r,t[l])&&Qn(o,t[l+1])&&Qn(a,t[l+2])){c=!1;break}c&&(t.push(r),t.push(o),t.push(a))}}return t},absolute:lAe,cylinder:KCe}),ORe=function(t){return e({BoxCollider:t,BoxColliderComponent:t}),t}((uAe=sl("cc.BoxCollider"),hAe=El(),fAe=yl(),_Ae=Hl(yi),pAe=Rl(),uAe(dAe=hAe(dAe=fAe(dAe=gl((X((mAe=function(e){function t(){var t;return q(t=e.call(this,WEe.BOX)||this,"_size",vAe,V(t)),t}return F(t,e),L(t,[{key:"size",get:function(){return this._size},set:function(e){yi.strictEquals(this._size,e)||(yi.copy(this._size,e),lAe(this._size),this._shape&&this.shape.updateSize())}},{key:"shape",get:function(){return this._shape}}]),t}(MCe)).prototype,"size",[_Ae,pAe],Object.getOwnPropertyDescriptor(mAe.prototype,"size"),mAe.prototype),vAe=X(mAe.prototype,"_size",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(1,1,1)}}),dAe=mAe))||dAe)||dAe)||dAe)||dAe)),DRe=function(t){return e({SphereCollider:t,SphereColliderComponent:t}),t}((gAe=sl("cc.SphereCollider"),yAe=El(),SAe=yl(),xAe=Rl(),gAe(TAe=yAe(TAe=SAe(TAe=gl((X((EAe=function(e){function t(){var t;return q(t=e.call(this,WEe.SPHERE)||this,"_radius",bAe,V(t)),t}return F(t,e),L(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.updateRadius())}},{key:"shape",get:function(){return this._shape}}]),t}(MCe)).prototype,"radius",[xAe],Object.getOwnPropertyDescriptor(EAe.prototype,"radius"),EAe.prototype),bAe=X(EAe.prototype,"_radius",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),TAe=EAe))||TAe)||TAe)||TAe)||TAe)),MRe=function(t){return e({CapsuleCollider:t,CapsuleColliderComponent:t}),t}((CAe=sl("cc.CapsuleCollider"),AAe=El(),wAe=yl(),RAe=Rl(),IAe=Rl(),PAe=Hl(VEe),OAe=Rl(),CAe(DAe=AAe(DAe=wAe(DAe=gl((X((MAe=function(e){function t(){var t;return q(t=e.call(this,WEe.CAPSULE)||this,"_radius",NAe,V(t)),q(t,"_cylinderHeight",LAe,V(t)),q(t,"_direction",BAe,V(t)),t}F(t,e);var n=t.prototype;return n._getRadiusScale=function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction===VEe.Y_AXIS?Math.abs(pi(e.x,e.z)):this._direction===VEe.X_AXIS?Math.abs(pi(e.y,e.z)):Math.abs(pi(e.x,e.y))},n._getHeightScale=function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction===VEe.Y_AXIS?Math.abs(e.y):this._direction===VEe.X_AXIS?Math.abs(e.x):Math.abs(e.z)},L(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"cylinderHeight",get:function(){return this._cylinderHeight},set:function(e){this._cylinderHeight!==e&&(this._cylinderHeight=Math.abs(e),this._shape&&this.shape.setCylinderHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){(e=Math.floor(e))<VEe.X_AXIS||e>VEe.Z_AXIS||this._direction!==e&&(this._direction=e,this._shape&&this.shape.setDirection(e))}},{key:"height",get:function(){return 2*this._radius+this._cylinderHeight},set:function(e){var t=e-2*this._radius;t<0&&(t=0),this.cylinderHeight=t}},{key:"worldHeight",get:function(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}},{key:"shape",get:function(){return this._shape}}]),t}(MCe)).prototype,"radius",[RAe],Object.getOwnPropertyDescriptor(MAe.prototype,"radius"),MAe.prototype),X(MAe.prototype,"cylinderHeight",[IAe],Object.getOwnPropertyDescriptor(MAe.prototype,"cylinderHeight"),MAe.prototype),X(MAe.prototype,"direction",[PAe,OAe],Object.getOwnPropertyDescriptor(MAe.prototype,"direction"),MAe.prototype),NAe=X(MAe.prototype,"_radius",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),LAe=X(MAe.prototype,"_cylinderHeight",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),BAe=X(MAe.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VEe.Y_AXIS}}),DAe=MAe))||DAe)||DAe)||DAe)||DAe)),NRe=function(t){return e({CylinderCollider:t,CylinderColliderComponent:t}),t}((FAe=sl("cc.CylinderCollider"),zAe=El(),UAe=yl(),kAe=Rl(),GAe=Rl(),HAe=Hl(VEe),VAe=Rl(),FAe(jAe=zAe(jAe=UAe(jAe=gl((X((WAe=function(e){function t(){var t;return q(t=e.call(this,WEe.CYLINDER)||this,"_radius",qAe,V(t)),q(t,"_height",XAe,V(t)),q(t,"_direction",YAe,V(t)),t}return F(t,e),L(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=Math.abs(e),this._shape&&this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(e<VEe.X_AXIS||e>VEe.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}(MCe)).prototype,"radius",[kAe],Object.getOwnPropertyDescriptor(WAe.prototype,"radius"),WAe.prototype),X(WAe.prototype,"height",[GAe],Object.getOwnPropertyDescriptor(WAe.prototype,"height"),WAe.prototype),X(WAe.prototype,"direction",[HAe,VAe],Object.getOwnPropertyDescriptor(WAe.prototype,"direction"),WAe.prototype),qAe=X(WAe.prototype,"_radius",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),XAe=X(WAe.prototype,"_height",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),YAe=X(WAe.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VEe.Y_AXIS}}),jAe=WAe))||jAe)||jAe)||jAe)||jAe)),LRe=e("ConeCollider",(KAe=sl("cc.ConeCollider"),QAe=El(),ZAe=yl(),JAe=Rl(),$Ae=Rl(),ewe=Hl(VEe),twe=Rl(),KAe(nwe=QAe(nwe=ZAe(nwe=gl((X((iwe=function(e){function t(){var t;return q(t=e.call(this,WEe.CONE)||this,"_radius",rwe,V(t)),q(t,"_height",owe,V(t)),q(t,"_direction",awe,V(t)),t}return F(t,e),L(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(e<0&&(e=0),this._height=e,this._shape&&this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(e<VEe.X_AXIS||e>VEe.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}(MCe)).prototype,"radius",[JAe],Object.getOwnPropertyDescriptor(iwe.prototype,"radius"),iwe.prototype),X(iwe.prototype,"height",[$Ae],Object.getOwnPropertyDescriptor(iwe.prototype,"height"),iwe.prototype),X(iwe.prototype,"direction",[ewe,twe],Object.getOwnPropertyDescriptor(iwe.prototype,"direction"),iwe.prototype),rwe=X(iwe.prototype,"_radius",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),owe=X(iwe.prototype,"_height",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),awe=X(iwe.prototype,"_direction",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VEe.Y_AXIS}}),nwe=iwe))||nwe)||nwe)||nwe)||nwe)),BRe=function(t){return e({MeshCollider:t,MeshColliderComponent:t}),t}((swe=sl("cc.MeshCollider"),cwe=El(),lwe=yl(),uwe=Hl(dY),hwe=Rl(),fwe=Rl(),swe(_we=cwe(_we=lwe(_we=gl((X((pwe=function(e){function t(){var t;return q(t=e.call(this,WEe.MESH)||this,"_mesh",dwe,V(t)),q(t,"_convex",mwe,V(t)),t}return F(t,e),L(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e,this._shape&&this.shape.setMesh(this._mesh))}},{key:"convex",get:function(){return this._convex},set:function(e){this._convex!==e&&(this._convex=e)}},{key:"shape",get:function(){return this._shape}}]),t}(MCe)).prototype,"mesh",[uwe,hwe],Object.getOwnPropertyDescriptor(pwe.prototype,"mesh"),pwe.prototype),X(pwe.prototype,"convex",[bl,fwe],Object.getOwnPropertyDescriptor(pwe.prototype,"convex"),pwe.prototype),dwe=X(pwe.prototype,"_mesh",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mwe=X(pwe.prototype,"_convex",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_we=pwe))||_we)||_we)||_we)||_we)),FRe=e("ConstantForce",(vwe=sl("cc.ConstantForce"),gwe=El(),ywe=cl(DCe),Swe=yl(),xwe=Nl(),Twe=Rl(),Ewe=Nl(),bwe=Rl(),Cwe=Nl(),Awe=Rl(),wwe=Nl(),Rwe=Rl(),vwe(Iwe=gwe(Iwe=ywe(Iwe=Swe(Iwe=ul(Iwe=gl((Lwe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._rigidBody=null,q(t,"_force",Owe,V(t)),q(t,"_localForce",Dwe,V(t)),q(t,"_torque",Mwe,V(t)),q(t,"_localTorque",Nwe,V(t)),t._mask=0,t}F(t,e);var n=t.prototype;return n.onLoad=function(){this._rigidBody=this.node.getComponent(DCe),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)},n.lateUpdate=function(){null!=this._rigidBody&&0!==this._mask&&(1&this._mask&&this._rigidBody.applyForce(this._force),2&this._mask&&this._rigidBody.applyLocalForce(this.localForce),4&this._mask&&this._rigidBody.applyTorque(this._torque),8&this._mask&&this._rigidBody.applyLocalTorque(this._localTorque))},n._maskUpdate=function(e,t){e.strictEquals(yi.ZERO)?this._mask&=~t:this._mask|=t},L(t,[{key:"force",get:function(){return this._force},set:function(e){yi.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){yi.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){yi.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){yi.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),t}(oh),Owe=X((Pwe=Lwe).prototype,"_force",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),Dwe=X(Pwe.prototype,"_localForce",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),Mwe=X(Pwe.prototype,"_torque",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),Nwe=X(Pwe.prototype,"_localTorque",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),X(Pwe.prototype,"force",[xwe,Twe],Object.getOwnPropertyDescriptor(Pwe.prototype,"force"),Pwe.prototype),X(Pwe.prototype,"localForce",[Ewe,bwe],Object.getOwnPropertyDescriptor(Pwe.prototype,"localForce"),Pwe.prototype),X(Pwe.prototype,"torque",[Cwe,Awe],Object.getOwnPropertyDescriptor(Pwe.prototype,"torque"),Pwe.prototype),X(Pwe.prototype,"localTorque",[wwe,Rwe],Object.getOwnPropertyDescriptor(Pwe.prototype,"localTorque"),Pwe.prototype),Iwe=Pwe))||Iwe)||Iwe)||Iwe)||Iwe)||Iwe)||Iwe)),zRe=16842754,URe=16842755,kRe=16842756,GRe=16842757,HRe=16843025,VRe=function(){function e(){this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}var t=e.prototype;return t.reserve=function(e){if(!(this.buffer.byteLength>e)){for(var t=this.buffer.byteLength;t<e;)t+=t;for(var n=new Uint8Array(t),i=0;i<this.length;++i)n[i]=this.buffer[i];this.buffer=n,this._buffView=new DataView(this.buffer.buffer)}},t.assign=function(e){this.buffer=e,this.length=e.length,this._seekPos=e.byteOffset,this._buffView=new DataView(e.buffer)},t.writeInt8=function(e){this.reserve(this.length+1),this._buffView.setInt8(this.length,e),this.length+=1},t.writeInt16=function(e){this.reserve(this.length+2),this._buffView.setInt16(this.length,e,!0),this.length+=2},t.writeInt32=function(e){this.reserve(this.length+4),this._buffView.setInt32(this.length,e,!0),this.length+=4},t.writeIntArray=function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setInt32(this.length+4*t,e[t],!0);this.length+=4*e.length},t.writeFloat=function(e){this.reserve(this.length+4),this._buffView.setFloat32(this.length,e,!0),this.length+=4},t.writeFloatArray=function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setFloat32(this.length+4*t,e[t],!0);this.length+=4*e.length},t.writeString=function(e){this.reserve(this.length+e.length+4),this._buffView.setInt32(this.length,e.length,!0);for(var t=0;t<e.length;++t)this._buffView.setInt8(this.length+4+t,e.charCodeAt(t));this.length+=e.length+4},t.readInt8=function(){var e=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,e},t.readInt16=function(){var e=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,e},t.readInt=function(){var e=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,e},t.readIntArray=function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getInt32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e},t.readFloat=function(){var e=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,e},t.readFloatArray=function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getFloat32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e},t.readString=function(){for(var e=this.readInt(),t="",n=0;n<e;++n)t+=String.fromCharCode(this.readInt8());return t},e}(),jRe=(sl("cc.TerrainLayerInfo")((Fwe=X((Bwe=function(){q(this,"slot",Fwe,this),q(this,"tileSize",zwe,this),q(this,"detailMap",Uwe,this),q(this,"normalMap",kwe,this),q(this,"roughness",Gwe,this),q(this,"metallic",Hwe,this)}).prototype,"slot",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zwe=X(Bwe.prototype,"tileSize",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Uwe=X(Bwe.prototype,"detailMap",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kwe=X(Bwe.prototype,"normalMap",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gwe=X(Bwe.prototype,"roughness",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Hwe=X(Bwe.prototype,"metallic",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bwe)),sl("cc.TerrainLayerBinaryInfo")(Vwe=function(){this.slot=0,this.tileSize=1,this.roughness=1,this.metallic=0,this.detailMapId="",this.normalMapId=""})||Vwe),WRe=sl("cc.TerrainAsset")((Xwe=function(e){function t(){var t;return(t=e.call(this)||this)._version=0,t._data=null,t._tileSize=1,t._blockCount=[1,1],t._weightMapSize=128,t._lightMapSize=128,t._heights=new Uint16Array,t._weights=new Uint8Array,t._layerBuffer=[-1,-1,-1,-1],t._layerBinaryInfos=[],q(t,"_layerInfos",qwe,V(t)),t}F(t,e);var n=t.prototype;return n.getLayer=function(e,t,n){var i=4*(t*this.blockCount[0]+e)+n;return e<this.blockCount[0]&&t<this.blockCount[1]&&i<this._layerBuffer.length?this._layerBuffer[i]:-1},n.getHeight=function(e,t){var n=32*this._blockCount[0]+1;return.001953125*(this._heights[t*n+e]-32768)},n.getVertexCountI=function(){return this._blockCount.length<1?0:32*this._blockCount[0]+1},n.getVertexCountJ=function(){return this._blockCount.length<2?0:32*this._blockCount[1]+1},n._setNativeData=function(e){this._data=e},n._loadNativeData=function(e){if(!e||0===e.length)return!1;var t=new VRe;if(t.assign(e),this._version=t.readInt(),this._version===HRe)return!0;if(16842753!==this._version&&this._version!==zRe&&this._version!==URe&&this._version!==kRe&&this._version!==GRe)return!1;this.tileSize=t.readFloat(),t.readIntArray(this._blockCount),this.weightMapSize=t.readInt16(),this.lightMapSize=t.readInt16();var n=t.readInt();this.heights=new Uint16Array(n);for(var i=0;i<this.heights.length;++i)this.heights[i]=t.readInt16();var r=t.readInt();this.weights=new Uint8Array(r);for(var o=0;o<this.weights.length;++o)this.weights[o]=t.readInt8();if(this._version>=zRe){var a=t.readInt();this.layerBuffer=new Array(a);for(var s=0;s<this.layerBuffer.length;++s)this.layerBuffer[s]=t.readInt16()}if(this._version>=URe){var c=t.readInt();this._layerBinaryInfos=new Array(c);for(var l=0;l<this._layerBinaryInfos.length;++l)this._layerBinaryInfos[l]=new jRe,this._layerBinaryInfos[l].slot=t.readInt(),this._layerBinaryInfos[l].tileSize=t.readFloat(),this._layerBinaryInfos[l].detailMapId=t.readString(),this._version>=kRe&&(this._layerBinaryInfos[l].normalMapId=t.readString(),this._layerBinaryInfos[l].roughness=t.readFloat(),this._layerBinaryInfos[l].metallic=t.readFloat())}return!0},n._exportNativeData=function(){var e=new VRe;e.writeInt32(GRe),e.writeFloat(this.tileSize),e.writeIntArray(this._blockCount),e.writeInt16(this.weightMapSize),e.writeInt16(this.lightMapSize),e.writeInt32(this.heights.length);for(var t=0;t<this.heights.length;++t)e.writeInt16(this.heights[t]);e.writeInt32(this.weights.length);for(var n=0;n<this.weights.length;++n)e.writeInt8(this.weights[n]);e.writeInt32(this.layerBuffer.length);for(var i=0;i<this.layerBuffer.length;++i)e.writeInt16(this.layerBuffer[i]);var r=[];r.length=this.layerInfos.length;for(var o=0;o<r.length;++o){var a=this.layerInfos[o],s=new jRe;s.slot=o,s.tileSize=a.tileSize,s.detailMapId=a.detailMap?a.detailMap._uuid:"",s.normalMapId=a.normalMap?a.normalMap._uuid:"",s.metallic=a.metallic,s.roughness=a.roughness,r[o]=s}e.writeInt32(r.length);for(var c=0;c<r.length;++c)e.writeInt32(r[c].slot),e.writeFloat(r[c].tileSize),e.writeString(r[c].detailMapId),e.writeString(r[c].normalMapId),e.writeFloat(r[c].roughness),e.writeFloat(r[c].metallic);return e.buffer},n._exportDefaultNativeData=function(){var e=new VRe;return e.writeInt32(HRe),e.buffer},L(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?this._data.set(new Uint8Array(e)):this._data=new Uint8Array(e),this._loadNativeData(this._data)}},{key:"version",get:function(){return this._version}},{key:"tileSize",get:function(){return this._tileSize},set:function(e){this._tileSize=e}},{key:"blockCount",get:function(){return this._blockCount},set:function(e){this._blockCount=e}},{key:"lightMapSize",get:function(){return this._lightMapSize},set:function(e){this._lightMapSize=e}},{key:"weightMapSize",get:function(){return this._weightMapSize},set:function(e){this._weightMapSize=e}},{key:"heights",get:function(){return this._heights},set:function(e){this._heights=e}},{key:"weights",get:function(){return this._weights},set:function(e){this._weights=e}},{key:"layerBuffer",get:function(){return this._layerBuffer},set:function(e){this._layerBuffer=e}},{key:"layerInfos",get:function(){return this._layerInfos},set:function(e){this._layerInfos=e}},{key:"layerBinaryInfos",get:function(){return this._layerBinaryInfos}}]),t}(zu),qwe=X((Wwe=Xwe).prototype,"_layerInfos",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jwe=Wwe))||jwe,qRe=e("TerrainCollider",(Ywe=sl("cc.TerrainCollider"),Kwe=El(),Qwe=yl(),Zwe=Hl(WRe),Jwe=Rl(),Ywe($we=Kwe($we=Qwe($we=gl((X((eRe=function(e){function t(){var t;return q(t=e.call(this,WEe.TERRAIN)||this,"_terrain",tRe,V(t)),t}return F(t,e),L(t,[{key:"terrain",get:function(){return this._terrain},set:function(e){this._terrain=e,this._shape&&this.shape.setTerrain(this._terrain)}},{key:"shape",get:function(){return this._shape}}]),t}(MCe)).prototype,"terrain",[Zwe,Jwe],Object.getOwnPropertyDescriptor(eRe.prototype,"terrain"),eRe.prototype),tRe=X(eRe.prototype,"_terrain",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$we=eRe))||$we)||$we)||$we)||$we)),XRe=e("SimplexCollider",(nRe=sl("cc.SimplexCollider"),iRe=El(),rRe=yl(),oRe=Hl(jEe),aRe=Rl(),sRe=Rl(),cRe=Cl(),lRe=Rl(),uRe=Cl(),hRe=Rl(),fRe=Cl(),_Re=Rl(),nRe(pRe=iRe(pRe=rRe(pRe=gl((yRe=gRe=function(e){function t(){var t;return q(t=e.call(this,WEe.SIMPLEX)||this,"_shapeType",mRe,V(t)),q(t,"_vertices",vRe,V(t)),t}return F(t,e),t.prototype.updateVertices=function(){this._shape&&this.shape.setVertices(this._vertices)},L(t,[{key:"shapeType",get:function(){return this._shapeType},set:function(e){this._shapeType=e,this._shape&&this.shape.setShapeType(e)}},{key:"vertex0",get:function(){return this._vertices[0]},set:function(e){yi.copy(this._vertices[0],e),this.updateVertices()}},{key:"vertex1",get:function(){return this._vertices[1]},set:function(e){yi.copy(this._vertices[1],e),this.updateVertices()}},{key:"vertex2",get:function(){return this._vertices[2]},set:function(e){yi.copy(this._vertices[2],e),this.updateVertices()}},{key:"vertex3",get:function(){return this._vertices[3]},set:function(e){yi.copy(this._vertices[3],e),this.updateVertices()}},{key:"shape",get:function(){return this._shape}},{key:"vertices",get:function(){return this._vertices}}]),t}(MCe),gRe.ESimplexType=jEe,X((dRe=yRe).prototype,"shapeType",[oRe,aRe],Object.getOwnPropertyDescriptor(dRe.prototype,"shapeType"),dRe.prototype),X(dRe.prototype,"vertex0",[bl,sRe],Object.getOwnPropertyDescriptor(dRe.prototype,"vertex0"),dRe.prototype),X(dRe.prototype,"vertex1",[cRe,lRe],Object.getOwnPropertyDescriptor(dRe.prototype,"vertex1"),dRe.prototype),X(dRe.prototype,"vertex2",[uRe,hRe],Object.getOwnPropertyDescriptor(dRe.prototype,"vertex2"),dRe.prototype),X(dRe.prototype,"vertex3",[fRe,_Re],Object.getOwnPropertyDescriptor(dRe.prototype,"vertex3"),dRe.prototype),mRe=X(dRe.prototype,"_shapeType",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jEe.TETRAHEDRON}}),vRe=X(dRe.prototype,"_vertices",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new yi(0,0,0),new yi(0,0,1),new yi(1,0,0),new yi(0,1,0)]}}),pRe=dRe))||pRe)||pRe)||pRe)||pRe));XRe||(XRe=e("SimplexCollider",{}));var YRe,KRe,QRe,ZRe,JRe,$Re,eIe,tIe,nIe,iIe,rIe,oIe,aIe,sIe,cIe,lIe,uIe,hIe,fIe,_Ie,pIe,dIe,mIe,vIe,gIe,yIe,SIe,xIe,TIe=e("PlaneCollider",(SRe=sl("cc.PlaneCollider"),xRe=El(),TRe=yl(),ERe=Hl(yi),bRe=Rl(),CRe=Rl(),SRe(ARe=xRe(ARe=TRe(ARe=gl((X((wRe=function(e){function t(){var t;return q(t=e.call(this,WEe.PLANE)||this,"_normal",RRe,V(t)),q(t,"_constant",IRe,V(t)),t}return F(t,e),L(t,[{key:"normal",get:function(){return this._normal},set:function(e){yi.strictEquals(this._normal,e)||(yi.copy(this._normal,e),this._shape&&this.shape.setNormal(this._normal))}},{key:"constant",get:function(){return this._constant},set:function(e){this._constant!==e&&(this._constant=e,this._shape&&this.shape.setConstant(this._constant))}},{key:"shape",get:function(){return this._shape}}]),t}(MCe)).prototype,"normal",[ERe,bRe],Object.getOwnPropertyDescriptor(wRe.prototype,"normal"),wRe.prototype),X(wRe.prototype,"constant",[bl,CRe],Object.getOwnPropertyDescriptor(wRe.prototype,"constant"),wRe.prototype),RRe=X(wRe.prototype,"_normal",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi(0,1,0)}}),IRe=X(wRe.prototype,"_constant",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ARe=wRe))||ARe)||ARe)||ARe)||ARe)),EIe=e("Constraint",(YRe=sl("cc.Constraint"),KRe=cl(DCe),QRe=Hl(DCe),ZRe=Nl(),JRe=Hl(DCe),$Re=Nl(),eIe=Nl(),tIe=Hl(DCe),YRe(nIe=KRe((sIe=aIe=function(e){function t(t){var n;return(n=e.call(this)||this).TYPE=void 0,q(n,"_enableCollision",rIe,V(n)),q(n,"_connectedBody",oIe,V(n)),n._constraint=null,n.TYPE=t,n}F(t,e);var n=t.prototype;return n.onLoad=function(){JEe.runInEditor&&(this._constraint=function(e){return pbe.INITED||(pbe.INITED=!0,pbe[qEe.POINT_TO_POINT]=function(){return tbe(JEe.wrapper.PointToPointConstraint,ZEe.PointToPointConstraint)?dbe:new JEe.wrapper.PointToPointConstraint},pbe[qEe.HINGE]=function(){return tbe(JEe.wrapper.HingeConstraint,ZEe.HingeConstraint)?dbe:new JEe.wrapper.HingeConstraint},pbe[qEe.CONE_TWIST]=function(){return tbe(JEe.wrapper.ConeTwistConstraint,ZEe.ConeTwistConstraint)?dbe:new JEe.wrapper.ConeTwistConstraint}),pbe[e]()}(this.TYPE),this._constraint.initialize(this))},n.onEnable=function(){this._constraint&&this._constraint.onEnable()},n.onDisable=function(){this._constraint&&this._constraint.onDisable()},n.onDestroy=function(){this._constraint&&this._constraint.onDestroy()},L(t,[{key:"attachedBody",get:function(){return this.getComponent(DCe)}},{key:"connectedBody",get:function(){return this._connectedBody},set:function(e){this._connectedBody=e,this._constraint&&this._constraint.setConnectedBody(e)}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(e){this._enableCollision=e,this._constraint&&this._constraint.setEnableCollision(e)}}]),t}(sn(oh)),aIe.Type=qEe,X((iIe=sIe).prototype,"attachedBody",[QRe,Al,ZRe],Object.getOwnPropertyDescriptor(iIe.prototype,"attachedBody"),iIe.prototype),X(iIe.prototype,"connectedBody",[JRe,$Re],Object.getOwnPropertyDescriptor(iIe.prototype,"connectedBody"),iIe.prototype),X(iIe.prototype,"enableCollision",[eIe],Object.getOwnPropertyDescriptor(iIe.prototype,"enableCollision"),iIe.prototype),rIe=X(iIe.prototype,"_enableCollision",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),oIe=X(iIe.prototype,"_connectedBody",[tIe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nIe=iIe))||nIe)||nIe));EIe||(EIe=e("Constraint",{}));var bIe,CIe,AIe,wIe,RIe,IIe,PIe,OIe,DIe,MIe=e("HingeConstraint",(cIe=sl("cc.HingeConstraint"),lIe=El(),uIe=yl(),hIe=Hl(yi),fIe=Hl(yi),_Ie=Hl(yi),pIe=pl("axisA"),dIe=pl("pivotA"),mIe=pl("pivotB"),cIe(vIe=lIe(vIe=uIe((X((gIe=function(e){function t(){var t;return q(t=e.call(this,qEe.HINGE)||this,"_axis",yIe,V(t)),q(t,"_pivotA",SIe,V(t)),q(t,"_pivotB",xIe,V(t)),t}return F(t,e),L(t,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){yi.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){yi.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"axis",get:function(){return this._axis},set:function(e){yi.copy(this._axis,e),this.constraint.setAxis(this._axis)}},{key:"constraint",get:function(){return this._constraint}}]),t}(EIe)).prototype,"pivotA",[hIe],Object.getOwnPropertyDescriptor(gIe.prototype,"pivotA"),gIe.prototype),X(gIe.prototype,"pivotB",[fIe],Object.getOwnPropertyDescriptor(gIe.prototype,"pivotB"),gIe.prototype),X(gIe.prototype,"axis",[_Ie],Object.getOwnPropertyDescriptor(gIe.prototype,"axis"),gIe.prototype),yIe=X(gIe.prototype,"_axis",[_l,pIe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),SIe=X(gIe.prototype,"_pivotA",[_l,dIe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),xIe=X(gIe.prototype,"_pivotB",[_l,mIe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),vIe=gIe))||vIe)||vIe)||vIe)),NIe=e("PointToPointConstraint",(bIe=sl("cc.PointToPointConstraint"),CIe=El(),AIe=yl(),wIe=Hl(yi),RIe=Hl(yi),bIe(IIe=CIe(IIe=AIe((X((PIe=function(e){function t(){var t;return q(t=e.call(this,qEe.POINT_TO_POINT)||this,"_pivotA",OIe,V(t)),q(t,"_pivotB",DIe,V(t)),t}return F(t,e),L(t,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){yi.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){yi.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"constraint",get:function(){return this._constraint}}]),t}(EIe)).prototype,"pivotA",[wIe],Object.getOwnPropertyDescriptor(PIe.prototype,"pivotA"),PIe.prototype),X(PIe.prototype,"pivotB",[RIe],Object.getOwnPropertyDescriptor(PIe.prototype,"pivotB"),PIe.prototype),OIe=X(PIe.prototype,"_pivotA",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),DIe=X(PIe.prototype,"_pivotB",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yi}}),IIe=PIe))||IIe)||IIe)||IIe));i.PhysicsSystem=lCe,i.PhysicsMaterial=mbe,i.PhysicsRayResult=vbe,i.ConstantForce=FRe;var LIe=Object.freeze({__proto__:null,PhysicsSystem:lCe,PhysicsRayResult:vbe,get Collider(){return MCe},BoxCollider:ORe,SphereCollider:DRe,CapsuleCollider:MRe,MeshCollider:BRe,CylinderCollider:NRe,ConeCollider:LRe,TerrainCollider:qRe,get SimplexCollider(){return XRe},PlaneCollider:TIe,get Constraint(){return EIe},HingeConstraint:MIe,PointToPointConstraint:NIe,get RigidBody(){return DCe},PhysicsMaterial:mbe,ConstantForce:FRe,selector:JEe,utils:PRe,get ERigidBodyType(){return HEe},get EAxisDirection(){return VEe},get ESimplexType(){return jEe},get EColliderType(){return WEe},get EConstraintType(){return qEe},get PhysicsGroup(){return XEe}});e("physics",LIe);var BIe=new KEe.Vec3,FIe=new KEe.Vec3,zIe=function(){function e(){this._isEnabled=!1}var t=e.prototype;return t.setAllowSleep=function(e){this.impl.type===KEe.Body.DYNAMIC&&(this.impl.allowSleep=e,this._wakeUpIfSleep())},t.setMass=function(e){this.impl.type===KEe.Body.DYNAMIC&&(this.impl.mass=e,this.impl.updateMassProperties(),this._wakeUpIfSleep())},t.setType=function(e){switch(e){case HEe.DYNAMIC:this.impl.type=KEe.Body.DYNAMIC,this.impl.allowSleep=this._rigidBody.allowSleep,this.setMass(this._rigidBody.mass);break;case HEe.KINEMATIC:this.impl.type=KEe.Body.KINEMATIC,this.impl.mass=0,this.impl.allowSleep=!1,this.impl.sleepState=KEe.Body.AWAKE,this.impl.updateMassProperties();break;case HEe.STATIC:default:this.impl.type=KEe.Body.STATIC,this.impl.mass=0,this.impl.allowSleep=!0,this.impl.updateMassProperties(),this.clearState()}},t.setLinearDamping=function(e){this.impl.linearDamping=e},t.setAngularDamping=function(e){this.impl.angularDamping=e},t.useGravity=function(e){this.impl.useGravity=e,this._wakeUpIfSleep()},t.useCCD=function(e){this.impl.ccdSpeedThreshold=e?.01:-1},t.isUsingCCD=function(){return-1!==this.impl.ccdSpeedThreshold},t.setLinearFactor=function(e){yi.copy(this.impl.linearFactor,e),this._wakeUpIfSleep()},t.setAngularFactor=function(e){yi.copy(this.impl.angularFactor,e);var t=yi.equals(this.impl.angularFactor,yi.ZERO);t!==this.impl.fixedRotation&&(this.impl.fixedRotation=t,this.impl.updateMassProperties()),this._wakeUpIfSleep()},t.initialize=function(e){this._rigidBody=e,this._sharedBody=lCe.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0,this._sharedBody.wrappedBody=this},t.onLoad=function(){},t.onEnable=function(){this._isEnabled=!0,this.setType(this._rigidBody.type),this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.useGravity(this._rigidBody.useGravity),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this._sharedBody.enabled=!0},t.onDisable=function(){this._isEnabled=!1,this._sharedBody.enabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},t.clearVelocity=function(){this.impl.velocity.setZero(),this.impl.angularVelocity.setZero()},t.clearForces=function(){this.impl.force.setZero(),this.impl.torque.setZero()},t.clearState=function(){this.clearVelocity(),this.clearForces()},t.wakeUp=function(){return this.impl.wakeUp()},t.sleep=function(){return this.impl.sleep()},t.setSleepThreshold=function(e){this.impl.sleepSpeedLimit=e,this._wakeUpIfSleep()},t.getSleepThreshold=function(){return this.impl.sleepSpeedLimit},t.getLinearVelocity=function(e){return yi.copy(e,this.impl.velocity),e},t.setLinearVelocity=function(e){this._wakeUpIfSleep(),yi.copy(this.impl.velocity,e)},t.getAngularVelocity=function(e){return yi.copy(e,this.impl.angularVelocity),e},t.setAngularVelocity=function(e){this._wakeUpIfSleep(),yi.copy(this.impl.angularVelocity,e)},t.applyForce=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=yi.ZERO),this.impl.applyForce(yi.copy(BIe,e),yi.copy(FIe,t))},t.applyImpulse=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=yi.ZERO),this.impl.applyImpulse(yi.copy(BIe,e),yi.copy(FIe,t))},t.applyLocalForce=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=yi.ZERO),this.impl.applyLocalForce(yi.copy(BIe,e),yi.copy(FIe,t))},t.applyLocalImpulse=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=yi.ZERO),this.impl.applyLocalImpulse(yi.copy(BIe,e),yi.copy(FIe,t))},t.applyTorque=function(e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),yi.add(this.impl.torque,this.impl.torque,e)},t.applyLocalTorque=function(e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),yi.copy(BIe,e),this.impl.vectorToWorldFrame(BIe,BIe),yi.add(this.impl.torque,this.impl.torque,BIe)},t.getGroup=function(){return this.impl.collisionFilterGroup},t.setGroup=function(e){this.impl.collisionFilterGroup=e,this._wakeUpIfSleep()},t.addGroup=function(e){this.impl.collisionFilterGroup|=e,this._wakeUpIfSleep()},t.removeGroup=function(e){this.impl.collisionFilterGroup&=~e,this._wakeUpIfSleep()},t.getMask=function(){return this.impl.collisionFilterMask},t.setMask=function(e){this.impl.collisionFilterMask=e,this._wakeUpIfSleep()},t.addMask=function(e){this.impl.collisionFilterMask|=e,this._wakeUpIfSleep()},t.removeMask=function(e){this.impl.collisionFilterMask&=~e,this._wakeUpIfSleep()},t._wakeUpIfSleep=function(){this.impl.isAwake()||this.impl.wakeUp()},L(e,[{key:"isAwake",get:function(){return this.impl.isAwake()}},{key:"isSleepy",get:function(){return this.impl.isSleepy()}},{key:"isSleeping",get:function(){return this.impl.isSleeping()}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isEnabled",get:function(){return this._isEnabled}}]),e}();function UIe(e,t){e.checkCollisionResponse=!t.queryTrigger,e.collisionFilterGroup=-1,e.collisionFilterMask=t.mask}function kIe(e,t){e._assign(t.hitPointWorld,t.distance,sAe(t.shape).collider,t.hitNormalWorld)}function GIe(e){e.aabbNeedsUpdate=!0,e.updateMassProperties(),e.updateBoundingRadius()}var HIe={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},VIe=new KEe.Quaternion,jIe=new KEe.Vec3,WIe=new KEe.Vec3,qIe=function(){function e(){this._offset=new KEe.Vec3,this._orient=new KEe.Quaternion,this._index=-1,this.onTriggerListener=this._onTrigger.bind(this),this._isBinding=!1}var t=e.prototype;return t.updateEventListener=function(){},t.setMaterial=function(t){if(null==t)this._shape.material=null;else{null==e.idToMaterial[t.id]&&(e.idToMaterial[t.id]=new KEe.Material(t.id)),this._shape.material=e.idToMaterial[t.id];var n=this._shape.material;n.friction=t.friction,n.restitution=t.restitution;var i=KEe.CC_CONFIG.correctInelastic;n.correctInelastic=0===n.restitution?i:0}},t.setAsTrigger=function(e){this._shape.collisionResponse=!e,this._index>=0&&this._body.updateHasTrigger()},t.setCenter=function(e){this._setCenter(e),this._index>=0&&GIe(this._body)},t.setAttachedBody=function(e){if(e){if(this._sharedBody){if(this._sharedBody.wrappedBody===e.body)return;this._sharedBody.reference=!1}this._sharedBody=lCe.instance.physicsWorld.getSharedBody(e.node),this._sharedBody.reference=!0}else this._sharedBody&&(this._sharedBody.reference=!1),this._sharedBody=lCe.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0},t.getAABB=function(e){Ai.copy(VIe,this._collider.node.worldRotation),this._shape.calculateWorldAABB(KEe.Vec3.ZERO,VIe,jIe,WIe),yi.subtract(e.halfExtents,WIe,jIe),yi.multiplyScalar(e.halfExtents,e.halfExtents,.5),yi.add(e.center,this._collider.node.worldPosition,this._collider.center)},t.getBoundingSphere=function(e){e.radius=this._shape.boundingSphereRadius,yi.add(e.center,this._collider.node.worldPosition,this._collider.center)},t.initialize=function(e){this._collider=e,this._isBinding=!0,this._sharedBody=lCe.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),aAe(this._shape,this),this._shape.addEventListener("cc-trigger",this.onTriggerListener)},t.onComponentSet=function(){},t.onLoad=function(){this.setMaterial(this._collider.sharedMaterial),this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},t.onEnable=function(){this._sharedBody.addShape(this),this._sharedBody.enabled=!0},t.onDisable=function(){this._sharedBody.removeShape(this),this._sharedBody.enabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._shape.removeEventListener("cc-trigger",this.onTriggerListener),delete KEe.World.idToShapeMap[this._shape.id],this._sharedBody=null,aAe(this._shape,null),this._offset=null,this._orient=null,this._shape=null,this._collider=null,this.onTriggerListener=null},t.getGroup=function(){return this._body.collisionFilterGroup},t.setGroup=function(e){this._body.collisionFilterGroup=e,this._body.isAwake()||this._body.wakeUp()},t.addGroup=function(e){this._body.collisionFilterGroup|=e,this._body.isAwake()||this._body.wakeUp()},t.removeGroup=function(e){this._body.collisionFilterGroup&=~e,this._body.isAwake()||this._body.wakeUp()},t.getMask=function(){return this._body.collisionFilterMask},t.setMask=function(e){this._body.collisionFilterMask=e,this._body.isAwake()||this._body.wakeUp()},t.addMask=function(e){this._body.collisionFilterMask|=e,this._body.isAwake()||this._body.wakeUp()},t.removeMask=function(e){this._body.collisionFilterMask&=~e,this._body.isAwake()||this._body.wakeUp()},t.setScale=function(){this._setCenter(this._collider.center)},t.setIndex=function(e){this._index=e},t.setOffsetAndOrient=function(e,t){yi.copy(e,this._offset),Ai.copy(t,this._orient),this._offset=e,this._orient=t},t._setCenter=function(e){var t=this._offset;yi.subtract(t,this._sharedBody.node.worldPosition,this._collider.node.worldPosition),yi.add(t,t,e),yi.multiply(t,t,this._collider.node.worldScale)},t._onTrigger=function(e){HIe.type=e.event;var t=sAe(e.selfShape),n=sAe(e.otherShape);t&&t.collider.needTriggerEvent&&(HIe.selfCollider=t.collider,HIe.otherCollider=n?n.collider:null,HIe.impl=e,this._collider.emit(HIe.type,HIe))},L(e,[{key:"impl",get:function(){return this._shape}},{key:"collider",get:function(){return this._collider}},{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_body",get:function(){return this._sharedBody.body}}]),e}();qIe.idToMaterial={},zn(lCe,"PhysicsSystem",[{name:"ins",newName:"instance"},{name:"PHYSICS_AMMO",newName:"PHYSICS_BULLET"}]),zn(lCe.prototype,"PhysicsSystem.prototype",[{name:"deltaTime",newName:"fixedTimeStep"},{name:"maxSubStep",newName:"maxSubSteps"}]),Un(lCe.prototype,"PhysicsSystem.prototype",[{name:"useFixedTime"},{name:"useCollisionMatrix"},{name:"updateCollisionMatrix"},{name:"resetCollisionMatrix"},{name:"isCollisionGroup"},{name:"setCollisionGroup"}]),zn(MCe.prototype,"Collider.prototype",[{name:"attachedRigidbody",newName:"attachedRigidBody"},{name:"TYPE",newName:"type"}]),zn(MCe,"Collider",[{name:"EColliderType",newName:"Type"},{name:"EAxisDirection",newName:"Axis"}]),zn(EIe,"Constraint",[{name:"EConstraintType",newName:"Type"}]),zn(ORe.prototype,"BoxCollider.prototype",[{name:"boxShape",newName:"shape"}]),zn(DRe.prototype,"SphereCollider.prototype",[{name:"sphereShape",newName:"shape"}]),zn(MRe.prototype,"CapsuleCollider.prototype",[{name:"capsuleShape",newName:"shape"}]),zn(DCe.prototype,"RigidBody.prototype",[{name:"rigidBody",newName:"body"}]),zn(DCe,"RigidBody",[{name:"ERigidBodyType",newName:"Type"}]),Un(DCe.prototype,"RigidBody.prototype",[{name:"fixedRotation"}]),i.RigidBodyComponent=DCe,He.setClassAlias(DCe,"cc.RigidBodyComponent"),i.ColliderComponent=MCe,He.setClassAlias(MCe,"cc.ColliderComponent"),i.BoxColliderComponent=ORe,He.setClassAlias(ORe,"cc.BoxColliderComponent"),i.SphereColliderComponent=DRe,He.setClassAlias(DRe,"cc.SphereColliderComponent"),He.setClassAlias(MRe,"cc.CapsuleColliderComponent"),He.setClassAlias(BRe,"cc.MeshColliderComponent"),He.setClassAlias(NRe,"cc.CylinderColliderComponent"),i.PhysicMaterial=mbe,He.setClassAlias(mbe,"cc.PhysicMaterial"),i.physics=LIe;var XIe=new Ai,YIe=function(){function e(e){this.impl=null,this.event=void 0,this.event=e}var t=e.prototype;return t.getLocalPointOnA=function(e){this.impl&&yi.copy(e,this.impl.rj)},t.getLocalPointOnB=function(e){this.impl&&yi.copy(e,this.impl.ri)},t.getWorldPointOnA=function(e){this.impl&&yi.add(e,this.impl.rj,this.impl.bj.position)},t.getWorldPointOnB=function(e){this.impl&&yi.add(e,this.impl.ri,this.impl.bi.position)},t.getLocalNormalOnA=function(e){this.impl&&(this.getWorldNormalOnA(e),Ai.conjugate(XIe,this.impl.bi.quaternion),yi.transformQuat(e,e,XIe))},t.getLocalNormalOnB=function(e){this.impl&&(Ai.conjugate(XIe,this.impl.bj.quaternion),yi.transformQuat(e,this.impl.ni,XIe))},t.getWorldNormalOnA=function(e){this.impl&&(this.getWorldNormalOnB(e),this.isBodyA||yi.negate(e,e))},t.getWorldNormalOnB=function(e){this.impl&&yi.copy(e,this.impl.ni)},L(e,[{key:"isBodyA",get:function(){if(this.impl){var e=this.event.selfCollider.shape.impl,t=this.impl.bj;return e.body.id===t.id}return!1}}]),e}(),KIe=new yi,QIe=new Ai,ZIe=[],JIe={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},$Ie=function(){function e(e,t){this.node=void 0,this.wrappedWorld=void 0,this.body=void 0,this.wrappedShapes=[],this.wrappedJoints0=[],this.wrappedJoints1=[],this.wrappedBody=null,this.index=-1,this.ref=0,this.onCollidedListener=this.onCollided.bind(this),this.wrappedWorld=t,this.node=e,this.body=new KEe.Body,aAe(this.body,this),this.body.collisionFilterGroup=lCe.PhysicsGroup.DEFAULT,this.body.sleepSpeedLimit=lCe.instance.sleepThreshold,this.body.material=this.wrappedWorld.impl.defaultMaterial,this.body.addEventListener("cc-collide",this.onCollidedListener)}e.getSharedBody=function(t,n,i){var r,o=t.uuid;if(e.sharedBodesMap.has(o))r=e.sharedBodesMap.get(o);else{r=new e(t,n);var a=XEe.DEFAULT,s=lCe.instance.collisionMatrix[a];r.body.collisionFilterGroup=a,r.body.collisionFilterMask=s,e.sharedBodesMap.set(t.uuid,r)}if(i){r.wrappedBody=i;var c=i.rigidBody.group,l=lCe.instance.collisionMatrix[c];r.body.collisionFilterGroup=c,r.body.collisionFilterMask=l}return r};var t=e.prototype;return t.addShape=function(e){if(this.wrappedShapes.indexOf(e)<0){var t=this.body.shapes.length;this.body.addShape(e.impl),this.wrappedShapes.push(e),e.setIndex(t);var n=this.body.shapeOffsets[t],i=this.body.shapeOrientations[t];e.setOffsetAndOrient(n,i),this.body.isSleeping()&&this.body.wakeUp()}},t.removeShape=function(e){var t=this.wrappedShapes.indexOf(e);t>=0&&(Q(this.wrappedShapes,t),this.body.removeShape(e.impl),e.setIndex(-1),this.body.isSleeping()&&this.body.wakeUp())},t.addJoint=function(e,t){t?this.wrappedJoints1.indexOf(e)<0&&this.wrappedJoints1.push(e):this.wrappedJoints0.indexOf(e)<0&&this.wrappedJoints0.push(e)},t.removeJoint=function(e,t){if(t){var n=this.wrappedJoints1.indexOf(e);n>=0&&Q(this.wrappedJoints1,n)}else{var i=this.wrappedJoints0.indexOf(e);i>=0&&Q(this.wrappedJoints0,i)}},t.syncSceneToPhysics=function(){var e=this.node,t=this.body;e.hasChangedFlags&&(t.isSleeping()&&t.wakeUp(),yi.copy(t.position,e.worldPosition),Ai.copy(t.quaternion,e.worldRotation),t.aabbNeedsUpdate=!0,e.hasChangedFlags&ig.SCALE&&this.syncScale())},t.syncPhysicsToScene=function(){var e=this.node,t=this.body;t.type===HEe.DYNAMIC&&(t.isSleeping()||(yi.copy(KIe,t.position),Ai.copy(QIe,t.quaternion),e.worldPosition=KIe,e.worldRotation=QIe))},t.syncInitial=function(){var e=this.node,t=this.body;yi.copy(t.position,e.worldPosition),Ai.copy(t.quaternion,e.worldRotation),yi.copy(t.previousPosition,e.worldPosition),Ai.copy(t.previousQuaternion,e.worldRotation),t.aabbNeedsUpdate=!0,this.syncScale(),t.isSleeping()&&t.wakeUp()},t.syncScale=function(){for(var e=0;e<this.wrappedShapes.length;e++)this.wrappedShapes[e].setScale(this.node.worldScale);for(var t=0;t<this.wrappedJoints0.length;t++)this.wrappedJoints0[t].updateScale0();for(var n=0;n<this.wrappedJoints1.length;n++)this.wrappedJoints1[n].updateScale1();GIe(this.body)},t.destroy=function(){aAe(this.body,null),this.body.removeEventListener("cc-collide",this.onCollidedListener),e.sharedBodesMap.delete(this.node.uuid),delete KEe.World.idToBodyMap[this.body.id],this.node=null,this.wrappedWorld=null,this.body=null,this.wrappedShapes=null,this.wrappedJoints0=null,this.wrappedJoints1=null,this.onCollidedListener=null},t.onCollided=function(e){JIe.type=e.event;var t=sAe(e.selfShape),n=sAe(e.otherShape);if(t&&t.collider.needCollisionEvent){ZIe.push.apply(ZIe,JIe.contacts),JIe.contacts.length=0,JIe.impl=e,JIe.selfCollider=t.collider,JIe.otherCollider=n?n.collider:null;var i=0;if("onCollisionExit"!==JIe.type)for(i=0;i<e.contacts.length;i++){var r=e.contacts[i];if(ZIe.length>0){var o=ZIe.pop();o.impl=r,JIe.contacts.push(o)}else{var a=new YIe(JIe);a.impl=r,JIe.contacts.push(a)}}for(i=0;i<this.wrappedShapes.length;i++)this.wrappedShapes[i].collider.emit(JIe.type,JIe)}},L(e,[{key:"enabled",set:function(e){e?this.index<0&&(this.index=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitial()):this.index>=0&&(0===this.wrappedShapes.length&&null==this.wrappedBody||0===this.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled)&&(this.body.sleep(),this.index=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"reference",set:function(e){e?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),e}();$Ie.sharedBodesMap=new Map;var ePe=function(){var e=t.prototype;function t(){this.bodies=[],this.constraints=[],this._world=void 0,this._world=new KEe.World,this._world.broadphase=new KEe.NaiveBroadphase,this._world.solver.iterations=10,this._world.solver.tolerance=1e-4,this._world.defaultContactMaterial.contactEquationStiffness=1e6,this._world.defaultContactMaterial.frictionEquationStiffness=1e6,this._world.defaultContactMaterial.contactEquationRelaxation=3,this._world.defaultContactMaterial.frictionEquationRelaxation=3}return e.setDefaultMaterial=function(e){this._world.defaultMaterial.friction=e.friction,this._world.defaultMaterial.restitution=e.restitution,null!=qIe.idToMaterial[e.id]&&(qIe.idToMaterial[e.id]=this._world.defaultMaterial)},e.setAllowSleep=function(e){this._world.allowSleep=e},e.setGravity=function(e){yi.copy(this._world.gravity,e)},e.destroy=function(){(this.constraints.length||this.bodies.length)&&d("You should destroy all physics component first."),this._world.broadphase=null,this._world=null},e.emitEvents=function(){this._world.emitTriggeredEvents(),this._world.emitCollisionEvents()},e.syncSceneToPhysics=function(){for(var e=0;e<this.bodies.length;e++)this.bodies[e].syncSceneToPhysics()},e.syncAfterEvents=function(){this.syncSceneToPhysics()},e.step=function(e,t,n){if(0!==this.bodies.length){this._world.step(e,t,n);for(var i=0;i<this.bodies.length;i++)this.bodies[i].syncPhysicsToScene()}},e.raycastClosest=function(e,n,i){iPe(e,n.maxDistance),UIe(rPe,n);var r=this._world.raycastClosest(tPe,nPe,rPe,t.rayResult);return r&&kIe(i,t.rayResult),r},e.raycast=function(e,t,n,i){return iPe(e,t.maxDistance),UIe(rPe,t),this._world.raycastAll(tPe,nPe,rPe,(function(e){var t=n.add();kIe(t,e),i.push(t)}))},e.getSharedBody=function(e,t){return $Ie.getSharedBody(e,this,t)},e.addSharedBody=function(e){this.bodies.indexOf(e)<0&&(this.bodies.push(e),this._world.addBody(e.body))},e.removeSharedBody=function(e){var t=this.bodies.indexOf(e);t>=0&&(Q(this.bodies,t),this._world.remove(e.body))},e.addConstraint=function(e){this.constraints.indexOf(e)<0&&(this.constraints.push(e),this._world.addConstraint(e.impl))},e.removeConstraint=function(e){var t=this.constraints.indexOf(e);t>=0&&(Q(this.constraints,t),this._world.removeConstraint(e.impl))},L(t,[{key:"impl",get:function(){return this._world}}]),t}();ePe.rayResult=new KEe.RaycastResult;var tPe=new KEe.Vec3,nPe=new KEe.Vec3;function iPe(e,t){yi.copy(tPe,e.o),e.computeHit(nPe,t)}var rPe={checkCollisionResponse:!1,collisionFilterGroup:-1,collisionFilterMask:-1,skipBackfaces:!0},oPe=function(e){function t(){var t;return(t=e.call(this)||this).halfExtent=void 0,t.halfExtent=new KEe.Vec3(.5,.5,.5),t._shape=new KEe.Box(t.halfExtent.clone()),t}F(t,e);var n=t.prototype;return n.updateSize=function(){yi.multiplyScalar(this.halfExtent,this.collider.size,.5);var e=lAe(cAe.set(this.collider.node.worldScale)),t=this.halfExtent.x*e.x,n=this.halfExtent.y*e.y,i=this.halfExtent.z*e.z,r=lCe.instance.minVolumeSize;this.impl.halfExtents.x=Jn(t,r,Number.MAX_VALUE),this.impl.halfExtents.y=Jn(n,r,Number.MAX_VALUE),this.impl.halfExtents.z=Jn(i,r,Number.MAX_VALUE),this.impl.updateConvexPolyhedronRepresentation(),-1!==this._index&&GIe(this._body)},n.onLoad=function(){e.prototype.onLoad.call(this),this.updateSize()},n.setScale=function(t){e.prototype.setScale.call(this,t),this.updateSize()},L(t,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),t}(qIe),aPe=function(e){F(n,e);var t=n.prototype;function n(t){var n;return void 0===t&&(t=.5),(n=e.call(this)||this)._shape=new KEe.Sphere(t),n}return t.updateRadius=function(){var e=Math.abs(_i(this.collider.node.worldScale));this.impl.radius=Jn(this.collider.radius*Math.abs(e),lCe.instance.minVolumeSize,Number.MAX_VALUE),this.impl.updateBoundingSphereRadius(),-1!==this._index&&GIe(this._body)},t.onLoad=function(){e.prototype.onLoad.call(this),this.updateRadius()},t.setScale=function(t){e.prototype.setScale.call(this,t),this.updateRadius()},L(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(qIe),sPe=new KEe.Vec3,cPe=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.setMesh=function(e){if(this._isBinding){var t=e;if(null!=this._shape)if(t&&t.renderingSubMeshes.length>0){var n=t.renderingSubMeshes[0].geometricInfo.positions,i=t.renderingSubMeshes[0].geometricInfo.indices;this.updateProperties(n,i)}else this.updateProperties(new Float32Array,new Uint16Array);else if(t&&t.renderingSubMeshes.length>0){var r=t.renderingSubMeshes[0].geometricInfo.positions,o=t.renderingSubMeshes[0].geometricInfo.indices;this._shape=new KEe.Trimesh(r,o)}else this._shape=new KEe.Trimesh(new Float32Array,new Uint16Array)}},n.onComponentSet=function(){this.setMesh(this.collider.mesh)},n.onLoad=function(){e.prototype.onLoad.call(this),this.setMesh(this.collider.mesh)},n.setScale=function(t){e.prototype.setScale.call(this,t),yi.copy(sPe,t),this.impl.setScale(sPe)},n.updateProperties=function(e,t){this.impl.vertices=new Float32Array(e),this.impl.indices=new Int16Array(t),this.impl.normals=new Float32Array(t.length),this.impl.aabb=new KEe.AABB,this.impl.edges=[],this.impl.tree=new KEe.Octree(new KEe.AABB),this.impl.updateEdges(),this.impl.updateNormals(),this.impl.updateAABB(),this.impl.updateBoundingSphereRadius(),this.impl.updateTree(),this.impl.setScale(this.impl.scale),this._index>=0&&GIe(this._body)},L(t,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),t}(qIe),lPe=function(e){F(n,e);var t=n.prototype;function n(t,n,i){var r;return void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i=VEe.Y_AXIS),(r=e.call(this)||this)._shape=new KEe.Cylinder(t,t,n,KEe.CC_CONFIG.numSegmentsCylinder,i===VEe.Y_AXIS),r}return t.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,KEe.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&GIe(this._body)},t.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,KEe.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&GIe(this._body)},t.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,KEe.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&GIe(this._body)},t.onLoad=function(){e.prototype.onLoad.call(this),this.setRadius(this.collider.radius)},t.setScale=function(t){e.prototype.setScale.call(this,t),this.setRadius(this.collider.radius)},t.updateProperties=function(e,t,n,i,r){var o=t,a=e,s=Math.cos,c=Math.sin,l=Math.abs,u=Math.max;1===i?(o=l(r.y)*t,a=u(l(r.x),l(r.z))*e):2===i?(o=l(r.z)*t,a=u(l(r.x),l(r.y))*e):(o=l(r.x)*t,a=u(l(r.y),l(r.z))*e);var h=n,f=o/2,_=[],p=[],d=[],m=2*Math.PI/h;if(1===i){for(var v=[1],g=[0],y=0;y<h;y++){var S=a*s(m*y),x=a*c(m*y);_.push(new KEe.Vec3(S,f,x)),_.push(new KEe.Vec3(S,-f,x)),y<h-1?(p.push([2*y+2,2*y+3,2*y+1,2*y]),g.push(2*y+2),v.push(2*y+3)):p.push([0,1,2*y+1,2*y]),(h%2==1||y<h/2)&&d.push(new KEe.Vec3(s(m*(y+.5)),0,c(m*(y+.5))))}p.push(v);for(var T=[],E=0;E<g.length;E++)T.push(g[g.length-E-1]);p.push(T),d.push(new KEe.Vec3(0,1,0))}else if(2===i){for(var b=[0],C=[1],A=0;A<h;A++){var w=a*s(m*A),R=a*c(m*A);_.push(new KEe.Vec3(w,R,f)),_.push(new KEe.Vec3(w,R,-f)),A<h-1?(p.push([2*A,2*A+1,2*A+3,2*A+2]),b.push(2*A+2),C.push(2*A+3)):p.push([2*A,2*A+1,0,1]),(h%2==1||A<h/2)&&d.push(new KEe.Vec3(s(m*(A+.5)),c(m*(A+.5)),0))}p.push(b);for(var I=[],P=0;P<C.length;P++)I.push(C[C.length-P-1]);p.push(I),d.push(new KEe.Vec3(0,0,1))}else{for(var O=[0],D=[1],M=0;M<h;M++){var N=a*s(m*M),L=a*c(m*M);_.push(new KEe.Vec3(f,N,L)),_.push(new KEe.Vec3(-f,N,L)),M<h-1?(p.push([2*M,2*M+1,2*M+3,2*M+2]),O.push(2*M+2),D.push(2*M+3)):p.push([2*M,2*M+1,0,1]),(h%2==1||M<h/2)&&d.push(new KEe.Vec3(0,s(m*(M+.5)),c(m*(M+.5))))}p.push(O);for(var B=[],F=0;F<D.length;F++)B.push(D[D.length-F-1]);p.push(B),d.push(new KEe.Vec3(1,0,0))}this.impl.vertices=_,this.impl.faces=p,this.impl.uniqueAxes=d,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()},L(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(qIe),uPe=new yi,hPe=new yi,fPe=function(e){F(n,e);var t=n.prototype;function n(t,n,i){var r;return void 0===t&&(t=.5),void 0===n&&(n=1),void 0===i&&(i=VEe.Y_AXIS),(r=e.call(this)||this)._shape=new KEe.Cylinder(0,t,n,KEe.CC_CONFIG.numSegmentsCone,i===VEe.Y_AXIS),r}return t.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,KEe.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&GIe(this._body)},t.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,KEe.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&GIe(this._body)},t.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,KEe.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&GIe(this._body)},t.onLoad=function(){e.prototype.onLoad.call(this),this.setRadius(this.collider.radius)},t.setScale=function(t){e.prototype.setScale.call(this,t),this.setRadius(this.collider.radius)},t.updateProperties=function(e,t,n,i,r){var o=t,a=e,s=Math.cos,c=Math.sin,l=Math.abs,u=Math.max;1===i?(o=l(r.y)*t,a=u(l(r.x),l(r.z))*e):2===i?(o=l(r.z)*t,a=u(l(r.x),l(r.y))*e):(o=l(r.x)*t,a=u(l(r.y),l(r.z))*e);var h=n,f=o/2,_=[],p=[],d=[],m=2*Math.PI/h;if(1===i){var v=[];p.push(v),_.push(new KEe.Vec3(0,f,0));for(var g=0;g<h;g++){var y=a*s(m*g),S=a*c(m*g);_.push(new KEe.Vec3(y,-f,S))}for(var x=0;x<h;x++){0!==x&&v.push(x);var T;T=x<h-1?[0,x+2,x+1]:[0,1,x+1],p.push(T),yi.subtract(uPe,_[0],_[T[1]]),yi.subtract(hPe,_[T[2]],_[T[1]]),yi.cross(uPe,hPe,uPe),uPe.normalize(),d.push(new KEe.Vec3(uPe.x,uPe.y,uPe.z))}d.push(new KEe.Vec3(0,-1,0))}else if(2===i){var E=[];p.push(E),_.push(new KEe.Vec3(0,0,f));for(var b=0;b<h;b++){var C=a*s(m*b),A=a*c(m*b);_.push(new KEe.Vec3(C,A,-f))}for(var w=0;w<h;w++){0!==w&&E.push(h-w);var R;R=w<h-1?[0,w+1,w+2]:[0,w+1,1],p.push(R),yi.subtract(uPe,_[0],_[R[1]]),yi.subtract(hPe,_[R[2]],_[R[1]]),yi.cross(uPe,uPe,hPe),uPe.normalize(),d.push(new KEe.Vec3(uPe.x,uPe.y,uPe.z))}d.push(new KEe.Vec3(0,0,-1))}else{var I=[];p.push(I),_.push(new KEe.Vec3(f,0,0));for(var P=0;P<h;P++){var O=a*s(m*P),D=a*c(m*P);_.push(new KEe.Vec3(-f,O,D))}for(var M=0;M<h;M++){0!==M&&I.push(h-M);var N;N=M<h-1?[0,M+1,M+2]:[0,M+1,1],p.push(N),yi.subtract(uPe,_[0],_[N[1]]),yi.subtract(hPe,_[N[2]],_[N[1]]),yi.cross(uPe,uPe,hPe),uPe.normalize(),d.push(new KEe.Vec3(uPe.x,uPe.y,uPe.z))}d.push(new KEe.Vec3(-1,0,0))}this.impl.vertices=_,this.impl.faces=p,this.impl.uniqueAxes=d,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()},L(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(qIe),_Pe=new KEe.AABB,pPe=new KEe.AABB,dPe=new KEe.Transform;KEe.Heightfield.prototype.calculateWorldAABB=function(e,t,n,i){var r=dPe,o=pPe;yi.copy(r.position,e),Ai.copy(r.quaternion,t);var a=this.elementSize,s=this.data;_Pe.lowerBound.set(0,0,this.minValue),_Pe.upperBound.set((s.length-1)*a,(s[0].length-1)*a,this.maxValue),_Pe.toWorldFrame(r,o),n.copy(o.lowerBound),i.copy(o.upperBound)};var mPe,vPe=function(e){F(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this).data=void 0,t.options=void 0,t._terrainID=void 0,t.data=[[]],t.options={elementSize:0},t._terrainID="",t}return t.setTerrain=function(e){if(e){if(this._terrainID!==e._uuid){var t=e,n=t.getVertexCountI(),i=t.getVertexCountJ();this._terrainID=t._uuid,this.data.length=n-1;for(var r=0;r<n;r++){null==this.data[r]&&(this.data[r]=[]),this.data[r].length=i-1;for(var o=0;o<i;o++)this.data[r][o]=t.getHeight(r,i-1-o)}this.options.elementSize=t.tileSize,this.updateProperties(this.data,this.options.elementSize)}}else""!==this._terrainID&&(this._terrainID="",this.data.length=1,this.data[0]=this.data[0]||[],this.data[0].length=0,this.options.elementSize=0,this.updateProperties(this.data,this.options.elementSize))},t.onComponentSet=function(){var e=this.collider.terrain;if(e){for(var t=e.getVertexCountI(),n=e.getVertexCountJ(),i=0;i<t;i++){null==this.data[i]&&(this.data[i]=[]);for(var r=0;r<n;r++)this.data[i][r]=e.getHeight(i,n-1-r)}this.options.elementSize=e.tileSize,this._terrainID=e._uuid}this._shape=new KEe.Heightfield(this.data,this.options)},t.onLoad=function(){e.prototype.onLoad.call(this),this.setTerrain(this.collider.terrain)},t.updateProperties=function(e,t){var n=this.impl;n.data=e,n.elementSize=t,n.updateMinValue(),n.updateMaxValue(),n.updateBoundingSphereRadius(),n.update(),this._index>=0&&GIe(this._body)},t._setCenter=function(e){var t=this.collider.terrain;if(t){Ai.fromEuler(this._orient,-90,0,0);var n=this._offset;yi.set(n,0,0,(t.getVertexCountJ()-1)*t.tileSize),yi.add(n,n,e)}},L(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(qIe),gPe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).vertices=[],t}F(t,e);var n=t.prototype;return n.setShapeType=function(){this._isBinding},n.setVertices=function(e){var t=this.vertices.length;if(4===t){for(var n=this._collider.node.worldScale,i=0;i<t;i++)yi.multiply(this.vertices[i],n,e[i]);var r=this.impl;r.computeNormals(),r.computeEdges(),r.updateBoundingSphereRadius()}-1!==this._index&&GIe(this._body)},n.onComponentSet=function(){if(this.collider.shapeType===XRe.ESimplexType.TETRAHEDRON){for(var e=0;e<4;e++)this.vertices[e]=new KEe.Vec3(0,0,0);this._shape=yPe(this.vertices)}else XRe.ESimplexType.VERTEX,this._shape=new KEe.Particle},n.onLoad=function(){e.prototype.onLoad.call(this),this.collider.updateVertices()},n.setScale=function(t){e.prototype.setScale.call(this,t),this.collider.updateVertices()},L(t,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),t}(qIe),yPe=(mPe=[[0,3,2],[0,1,3],[0,2,1],[1,2,3]],function(e){return new KEe.ConvexPolyhedron(e,mPe)}),SPe=function(e){function t(){var t;return(t=e.call(this)||this)._shape=new KEe.Plane,t}F(t,e);var n=t.prototype;return n.setNormal=function(e){Ai.rotationTo(this._orient,yi.UNIT_Z,e),-1!==this._index&&GIe(this._body)},n.setConstant=function(e){yi.scaleAndAdd(this._offset,this._collider.center,this.collider.normal,e)},n.onLoad=function(){e.prototype.onLoad.call(this),this.setConstant(this.collider.constant),this.setNormal(this.collider.normal)},n._setCenter=function(t){e.prototype._setCenter.call(this,t),this.setConstant(this.collider.constant)},L(t,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),t}(qIe);KEe.World.staticBody=new KEe.Body,KEe.World.idToConstraintMap={};var xPe,TPe,EPe,bPe,CPe,APe,wPe,RPe,IPe,PPe=function(){function e(){}var t=e.prototype;return t.setConnectedBody=function(e){var t=sAe(this.impl.bodyB);t&&t.removeJoint(this,1),e?(this._impl.bodyB=e.body.impl,e.body.sharedBody.addJoint(this,1)):this._impl.bodyB=KEe.World.staticBody;var n=this._impl.bodyB;this._impl.equations.forEach((function(e){e.bj=n}))},t.setEnableCollision=function(e){this._impl.collideConnected=e},t.initialize=function(e){this._com=e,this._rigidBody=e.attachedBody,this.onComponentSet(),this.setEnableCollision(e.enableCollision),KEe.World.idToConstraintMap[this._impl.id]=this._impl},t.onComponentSet=function(){},t.updateScale0=function(){},t.updateScale1=function(){},t.onEnable=function(){var e=this._rigidBody.body.sharedBody;e.wrappedWorld.addConstraint(this),e.addJoint(this,0);var t=this.constraint.connectedBody;t&&t.body.sharedBody.addJoint(this,1)},t.onDisable=function(){var e=this._rigidBody.body.sharedBody;e.wrappedWorld.removeConstraint(this),e.removeJoint(this,0);var t=this.constraint.connectedBody;t&&t.body.sharedBody.removeJoint(this,1)},t.onDestroy=function(){delete KEe.World.idToConstraintMap[this._impl.id],this._com=null,this._rigidBody=null,this._impl=null},L(e,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),e}(),OPe=new yi,DPe=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.setPivotA=function(){var e=this.constraint;yi.multiply(this.impl.pivotA,e.node.worldScale,e.pivotA),e.connectedBody||this.setPivotB(e.pivotB)},n.setPivotB=function(){var e=this.constraint,t=e.connectedBody;if(t)yi.multiply(this.impl.pivotB,t.node.worldScale,e.pivotB);else{var n=e.node;yi.multiply(OPe,n.worldScale,e.pivotA),yi.add(OPe,OPe,n.worldPosition),yi.add(OPe,OPe,e.pivotB),yi.copy(this.impl.pivotB,OPe)}},n.onComponentSet=function(){var e=this._rigidBody.body.impl,t=this.constraint.connectedBody,n=KEe.World.staticBody;t&&(n=t.body.impl),this._impl=new KEe.PointToPointConstraint(e,null,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},n.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},n.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},L(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(PPe),MPe=new yi,NPe=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.setPivotA=function(){var e=this.constraint;yi.multiply(this.impl.pivotA,this.constraint.node.worldScale,e.pivotA),e.connectedBody||this.setPivotB(e.pivotB)},n.setPivotB=function(){var e=this.constraint,t=e.connectedBody;if(t)yi.multiply(this.impl.pivotB,t.node.worldScale,e.pivotB);else{var n=this.constraint.node;yi.multiply(MPe,n.worldScale,e.pivotA),yi.add(MPe,MPe,n.worldPosition),yi.add(MPe,MPe,e.pivotB),yi.copy(this.impl.pivotB,MPe)}},n.setAxis=function(e){yi.copy(this.impl.axisA,e),yi.copy(this.impl.equations[3].axisA,e),yi.copy(this.impl.equations[4].axisA,e),yi.copy(this.impl.equations[5].axisA,e),this.constraint.connectedBody?(yi.copy(this.impl.axisB,e),yi.copy(this.impl.equations[3].axisB,e),yi.copy(this.impl.equations[4].axisB,e),yi.copy(this.impl.equations[5].axisB,e)):(yi.transformQuat(this.impl.axisB,e,this.constraint.node.worldRotation),yi.copy(this.impl.equations[3].axisB,this.impl.axisB),yi.copy(this.impl.equations[4].axisB,this.impl.axisB),yi.copy(this.impl.equations[5].axisB,this.impl.axisB))},n.onComponentSet=function(){var e=this._rigidBody.body.impl,t=this.constraint.connectedBody,n=KEe.World.staticBody;t&&(n=t.body.impl),this._impl=new KEe.HingeConstraint(e,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this.setAxis(this.constraint.axis)},n.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},n.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},L(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(PPe);JM.once(ZM.EVENT_ENGINE_INITED,(function(){JEe.register("cannon.js",{PhysicsWorld:ePe,RigidBody:zIe,BoxShape:oPe,SphereShape:aPe,TrimeshShape:cPe,CylinderShape:lPe,ConeShape:fPe,TerrainShape:vPe,SimplexShape:gPe,PlaneShape:SPe,PointToPointConstraint:DPe,HingeConstraint:NPe})})),window&&(window.CANNON=KEe),KEe.CC_CONFIG={numSegmentsCone:12,numSegmentsCylinder:12,ignoreSelfBody:!0,correctInelastic:3},KEe.ArrayCollisionMatrix.prototype.reset=function(){for(var e in this.matrix)delete this.matrix[e]},KEe.Ray.perBodyFilter=function(e,t){return 0!=(e.collisionFilterMask&t.collisionFilterGroup)},function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(IPe||(IPe={})),$e(IPe);var LPe=e("Primitive",(xPe=sl("cc.Primitive"),TPe=Hl(IPe),xPe((RPe=wPe=function(e){function t(t){var n;return void 0===t&&(t=IPe.BOX),q(n=e.call(this)||this,"type",CPe,V(n)),q(n,"info",APe,V(n)),n.type=t,n}return F(t,e),t.prototype.onLoaded=function(){EY(oAe[IPe[this.type].toLowerCase()](this.info),this)},t}(dY),wPe.PrimitiveType=IPe,CPe=X((bPe=RPe).prototype,"type",[TPe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return IPe.BOX}}),APe=X(bPe.prototype,"info",[_l,bl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),EPe=bPe))||EPe));i.Primitive=LPe,i.primitives=oAe;var BPe,FPe,zPe,UPe,kPe=function(){function e(e,t,n){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=n}var t=e.prototype;return t.sample=function(e){this._average(this._value,e)},t.human=function(){var e=this._opts,t=e.average,n=e.isInteger,i=t?this._averageValue:this._value;return n?Math.round(i):Math.round(100*i)/100},t.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},t._average=function(e,t){if(void 0===t&&(t=0),this._opts.average){this._accumValue+=e,++this._accumSamples;var n=t;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}},L(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),e}(),GPe=sl("cc.PerfCounter")(BPe=function(e){function t(t,n,i){var r;return(r=e.call(this,t,n,i)||this)._time=void 0,r._time=i,r}F(t,e);var n=t.prototype;return n.start=function(e){void 0===e&&(e=0),this._time=e},n.end=function(e){void 0===e&&(e=0),this._value=e-this._time,this._average(this._value)},n.tick=function(){this.end(),this.start()},n.frame=function(e){var t=e,n=t-this._time;this._total++,n>(this._opts.average||1e3)&&(this._value=1e3*this._total/n,this._total=0,this._time=t,this._average(this._value))},t}(kPe))||BPe,HPe="0123456789. ",VPe=500,jPe={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},WPe={fps:{desc:"Framerate (FPS)",below:30,average:VPe,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:VPe},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:VPe,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:VPe},render:{desc:"Renderer (ms)",min:0,max:50,average:VPe,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},qPe=e("Profiler",function(){function e(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new xo,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(WPe).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}var t=e.prototype;return t.isShowingStats=function(){return this._showFPS},t.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),i.game.off(i.Game.EVENT_RESTART,this.generateNode,this),i.director.off(i.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),i.director.off(i.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),i.director.off(i.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),i.director.off(i.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),i.director.off(i.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),i.director.off(i.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,this._pipeline.profiler=null,i.game.config.showFPS=!1)},t.showStats=function(){if(!this._showFPS){if(!this._device){var e=i.director.root;this._device=e.device,this._swapchain=e.mainWindow.swapchain,this._pipeline=e.pipeline}this.generateCanvas(),this.generateStats(),i.game.once(i.Game.EVENT_ENGINE_INITED,this.generateNode,this),i.game.on(i.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),i.director.on(i.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),i.director.on(i.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),i.director.on(i.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),i.director.on(i.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),i.director.on(i.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),i.director.on(i.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,i.game.config.showFPS=!0}},t.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new Do(Dr.TEX2D,Mr.SAMPLED|Mr.TRANSFER_DST,Cr.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},t.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var e=performance.now();this._ctx.textAlign="left";var t=0;for(var n in WPe){var i=WPe[n];this._ctx.fillText(i.desc,0,t*this._lineHeight),i.counter=new GPe(n,i,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<HPe.length;++r){var o=this._ctx.measureText(HPe[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,o)}for(var a=0;a<HPe.length;++a)this._ctx.fillText(HPe[a],a*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=WPe,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},t.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new eA("PROFILER_NODE"),i.game.addPersistRootNode(this._rootNode);var e=new eA("Profiler_Root");e.parent=this._rootNode;for(var t=.4,n=t/this._totalLines,r=t/this._wordHeight,o=n/23,a=this._eachNumWidth*this._canvas.width*o,s=[0,t,0,r,t,0,r,0,0,0,0,0],c=[0,2,1,0,3,2],l=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],u=0,h=0;h<this._totalLines;h++)for(var f=0;f<8;f++){s.push(r+f*a,t-h*n,0),s.push(r+(f+1)*a,t-h*n,0),s.push(r+(f+1)*a,t-(h+1)*n,0),s.push(r+f*a,t-(h+1)*n,0),u=4*(8*h+f+1),c.push(0+u,2+u,1+u,0+u,3+u,2+u);var _=8*h+f,p=Math.floor(_/4),d=_-4*p;l.push(0,this._wordHeight,p,d),l.push(this._eachNumWidth,this._wordHeight,p,d),l.push(this._eachNumWidth,1,p,d),l.push(0,1,p,d)}this._meshRenderer=e.addComponent(dK),this._meshRenderer.mesh=EY({positions:s,indices:c,colors:l});var m=new Ng;m.initialize({effectName:"profiler"});var v=this.pass=m.passes[0],g=v.getBinding("mainTexture"),y=v.getBinding("digits"),S=v.getBinding("offset");v.bindTexture(g,this._texture),this.digitsData=v.blocks[y],this.offsetData=v.blocks[S],this.offsetData[3]=-1,this._meshRenderer.material=m,this._meshRenderer.node.layer=Gp.Enum.PROFILER,this._inited=!0}},t.beforeUpdate=function(){if(this._stats){var e=performance.now();this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}},t.afterUpdate=function(){if(this._stats){var e=performance.now();i.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}},t.beforePhysics=function(){if(this._stats){var e=performance.now();this._stats.physics.counter.start(e)}},t.afterPhysics=function(){if(this._stats){var e=performance.now();this._stats.physics.counter.end(e)}},t.beforeDraw=function(){if(this._stats&&this._inited){var e=this._swapchain.surfaceTransform,t=this._device.capabilities.clipSpaceSignY;if(e!==this.offsetData[3]){var n=Mi[e],i=-.9*t;this.offsetData[0]=-.9*n[0]+i*n[2],this.offsetData[1]=-.9*n[1]+i*n[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=e}this.pass._setRootBufferDirty(!0),this._meshRenderer.model&&(this._pipeline.profiler=this._meshRenderer.model);var r=performance.now();this._stats.render.counter.start(r)}},t.afterDraw=function(){if(this._stats&&this._inited){var e=performance.now();if(this._stats.frame.counter.end(e),this._stats.fps.counter.frame(e),this._stats.render.counter.end(e),!(e-this.lastTime<VPe)){this.lastTime=e;var t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;var n=0,i=this.digitsData;for(var r in this._stats){var o=this._stats[r];o.counter.sample(e);for(var a=o.counter.human().toString(),s=7;s>=0;s--){var c=8*n+s,l=a[a.length-(8-s)],u=jPe[l];void 0===u&&(u=11),i[c]=u}n++}}}},e}()),XPe=e("profiler",new qPe);i.profiler=XPe,function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(FPe||(FPe={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(zPe||(zPe={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}(UPe||(UPe={}));var YPe,KPe=0;function QPe(e,t){var n;t.invoking||(t.invoking=!0,(n=t.func).call.apply(n,[e].concat(t.args)).then((function(){t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());var n=e._operationQueue[0];n&&QPe(e,n)})).catch((function(){})))}function ZPe(e,t,n){var i=n.value;n.value=function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return new Promise((function(t){var r=KPe++,o=e;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),t),QPe(o,o._operationQueue[0])}))}}function JPe(e){return new Promise((function(t){var n=e.play();return void 0===n?t():(n.then(t).catch((function(){var n=function(){e.play().catch((function(){})),t()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var $Pe,eOe,tOe=function(){function e(e,t){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=e,e.volume=t}var t=e.prototype;return t.play=function(){var e=this;JPe(this._domAudio).then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e)})).catch((function(){}))},t.stop=function(){this._domAudio.pause()},L(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=e,e&&this._domAudio.addEventListener("ended",e)}}]),e}(),nOe=(X((YPe=function(){function e(e){var t=this;this._domAudio=void 0,this._state=UPe.INIT,this._onEnded=void 0,this._eventTarget=new pn,this._operationQueue=[],this._domAudio=e,dn.on("hide",this._onHide,this),dn.on("show",this._onShow,this),this._onEnded=function(){t.seek(0).catch((function(){})),t._state=UPe.INIT,t._eventTarget.emit(FPe.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var t=e.prototype;return t.destroy=function(){dn.off("hide",this._onHide,this),dn.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(t){n(new e(t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=document.createElement("audio"),r="canplaythrough";dn.os===hn.IOS?r="loadedmetadata":dn.browserType===cn.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),t(i)},c=function(){a(),n("load audio failure - "+e)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=e}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var t=new tOe(e,n);i(t)})).catch(r)}))},t._onHide=function(){var e=this;this._state===UPe.PLAYING&&this.pause().then((function(){e._state=UPe.INTERRUPTED,e._eventTarget.emit(FPe.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===UPe.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(FPe.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){return e=Jn(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()},t.play=function(){var e=this;return new Promise((function(t){JPe(e._domAudio).then((function(){e._state=UPe.PLAYING,t()})).catch((function(){}))}))},t.pause=function(){return this._domAudio.pause(),this._state=UPe.PAUSED,Promise.resolve()},t.stop=function(){var e=this;return new Promise((function(t){e._domAudio.pause(),e._domAudio.currentTime=0,e._state=UPe.STOPPED,t()}))},t.onInterruptionBegin=function(e){this._eventTarget.on(FPe.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(FPe.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(FPe.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(FPe.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(FPe.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(FPe.ENDED,e)},L(e,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return zPe.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=$n(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),e}()).prototype,"seek",[ZPe],Object.getOwnPropertyDescriptor(YPe.prototype,"seek"),YPe.prototype),X(YPe.prototype,"play",[ZPe],Object.getOwnPropertyDescriptor(YPe.prototype,"play"),YPe.prototype),X(YPe.prototype,"pause",[ZPe],Object.getOwnPropertyDescriptor(YPe.prototype,"pause"),YPe.prototype),X(YPe.prototype,"stop",[ZPe],Object.getOwnPropertyDescriptor(YPe.prototype,"stop"),YPe.prototype),YPe),iOe=function(){function e(e){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=e}var t=e.prototype;return t.destroy=function(){this._nativeAudio=void 0},t._now=function(){return performance.now()/1e3},t._calculateCurrentTime=function(){var e=this._now()-this._startTime,t=this._startOffset+e;return t>=this.duration&&(this._startTime=this._now(),this._startOffset=0),t%this.duration},t.start=function(){this._isPaused=!1,this._startTime=this._now()},t.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},t.stop=function(){this._isPaused=!0,this._startOffset=0},t.seek=function(e){this._startTime=this._now(),this._startOffset=Jn(e,0,this.duration)},L(e,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),e}(),rOe=new(function(){function e(){this._audioBufferDataMap={}}var t=e.prototype;return t.addCache=function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer "+e+" has been cached"):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}},t.retainCache=function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache "+e+" has not been added.")},t.getCache=function(e){var t=this._audioBufferDataMap[e];return null==t?void 0:t.audioBuffer},t.tryReleasingCache=function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache "+e+" has not been added.")},e}()),oOe=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,aOe=function(){function e(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var t=e.prototype;return t.decodeAudioData=function(e){var t=this;return new Promise((function(n){var i=t._context.decodeAudioData(e,(function(e){n(e)}),(function(e){console.error("failed to load Web Audio",e)}));null==i||i.catch((function(){}))}))},t.runContext=function(){var e=this;return new Promise((function(t){var n=e._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(t).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else t();else t()}))},t.createBufferSource=function(e,t){var n=this._context.createBufferSource();return void 0!==e&&(n.buffer=e),void 0!==t&&(n.loop=t),n},t.createGain=function(e){void 0===e&&(e=1);var t=this._context.createGain();return this.setGainValue(t,e),t},t.setGainValue=function(e,t){if(e.gain.setTargetAtTime)try{e.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(n){e.gain.setTargetAtTime(t,this._context.currentTime,.01)}else e.gain.value=t},t.connectContext=function(e){this._context&&e.connect(this._context.destination)},L(e,[{key:"currentTime",get:function(){return this._context.currentTime}}]),e}();aOe.support=!!oOe,aOe.support&&(eOe=new aOe);var sOe,cOe,lOe,uOe,hOe,fOe=function(){function e(e,t,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=e.duration,this._url=n,this._bufferSourceNode=eOe.createBufferSource(e,!1);var i=eOe.createGain(t);this._bufferSourceNode.connect(i),eOe.connectContext(i)}var t=e.prototype;return t.play=function(){var e=this;this._bufferSourceNode.start(),eOe.runContext().then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e),e._currentTimer=window.setTimeout((function(){var t;rOe.tryReleasingCache(e._url),null===(t=e.onEnd)||void 0===t||t.call(e)}),1e3*e._duration)})).catch((function(){}))},t.stop=function(){clearTimeout(this._currentTimer),rOe.tryReleasingCache(this._url),this._bufferSourceNode.stop()},L(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}}]),e}(),_Oe=(X(($Pe=function(){function e(e,t){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=UPe.INIT,this._audioTimer=void 0,this._eventTarget=new pn,this._operationQueue=[],this._audioBuffer=e,this._audioTimer=new iOe(e),this._gainNode=eOe.createGain(),eOe.connectContext(this._gainNode),this._src=t,dn.on("hide",this._onHide,this),dn.on("show",this._onShow,this)}var t=e.prototype;return t.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),rOe.tryReleasingCache(this._src),dn.off("hide",this._onHide,this),dn.off("show",this._onShow,this)},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(i){n(new e(i,t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=rOe.getCache(e);if(i)return rOe.retainCache(e),void t(i);var r=new XMLHttpRequest,o="load audio failed: "+e+", status: ";r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?eOe.decodeAudioData(r.response).then((function(n){rOe.addCache(e,n),t(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var r=new fOe(e,n,t);i(r)})).catch(r)}))},t._onHide=function(){var e=this;this._state===UPe.PLAYING&&this.pause().then((function(){e._state=UPe.INTERRUPTED,e._eventTarget.emit(FPe.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===UPe.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(FPe.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){var t=this;return new Promise((function(n){t._audioTimer.seek(e),t._state===UPe.PLAYING?t._doPlay().then(n).catch((function(){})):n()}))},t.play=function(){return this._doPlay()},t._doPlay=function(){var e=this;return new Promise((function(t){e._stopSourceNode(),e._sourceNode=eOe.createBufferSource(e._audioBuffer,e.loop),e._sourceNode.connect(e._gainNode),e._sourceNode.start(0,e._audioTimer.currentTime),eOe.runContext().then((function(){e._state=UPe.PLAYING,e._audioTimer.start(),window.clearTimeout(e._currentTimer),e._currentTimer=window.setTimeout((function t(){e.loop?e._currentTimer=window.setTimeout(t,1e3*e._audioBuffer.duration):(e._audioTimer.stop(),e._eventTarget.emit(FPe.ENDED),e._state=UPe.INIT)}),1e3*(e._audioBuffer.duration-e._audioTimer.currentTime)),t()})).catch((function(){}))}))},t._stopSourceNode=function(){try{var e;null===(e=this._sourceNode)||void 0===e||e.stop()}catch(e){}},t.pause=function(){return this._state===UPe.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=UPe.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=UPe.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.onInterruptionBegin=function(e){this._eventTarget.on(FPe.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(FPe.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(FPe.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(FPe.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(FPe.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(FPe.ENDED,e)},L(e,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return zPe.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=$n(e),this._volume=e,eOe.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),e}()).prototype,"seek",[ZPe],Object.getOwnPropertyDescriptor($Pe.prototype,"seek"),$Pe.prototype),X($Pe.prototype,"play",[ZPe],Object.getOwnPropertyDescriptor($Pe.prototype,"play"),$Pe.prototype),X($Pe.prototype,"pause",[ZPe],Object.getOwnPropertyDescriptor($Pe.prototype,"pause"),$Pe.prototype),X($Pe.prototype,"stop",[ZPe],Object.getOwnPropertyDescriptor($Pe.prototype,"stop"),$Pe.prototype),$Pe),pOe=function(){function e(e){this._audio=void 0,this._audio=e}var t=e.prototype;return t.play=function(){this._audio.play()},t.stop=function(){this._audio.stop()},L(e,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}}]),e}(),dOe=function(){function e(e){this._player=void 0,this._player=e}e.load=function(t,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==zPe.DOM_AUDIO&&aOe.support?_Oe.load(t).then((function(t){i(new e(t))})).catch((function(){})):(aOe.support||b(5201),nOe.load(t).then((function(t){i(new e(t))})).catch((function(){})))}))};var t=e.prototype;return t.destroy=function(){this._player.destroy()},e.loadNative=function(e,t){return(null==t?void 0:t.audioLoadMode)!==zPe.DOM_AUDIO&&aOe.support?_Oe.loadNative(e):(aOe.support||b(5201),nOe.loadNative(e))},e.loadOneShotAudio=function(e,t,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==zPe.DOM_AUDIO&&aOe.support?_Oe.loadOneShotAudio(e,t).then((function(e){i(new pOe(e))})).catch(r):(aOe.support||b(5201),nOe.loadOneShotAudio(e,t).then((function(e){i(new pOe(e))})).catch(r))}))},t.seek=function(e){return this._player.seek(e)},t.play=function(){return this._player.play()},t.pause=function(){return this._player.pause()},t.stop=function(){return this._player.stop()},t.onInterruptionBegin=function(e){this._player.onInterruptionBegin(e)},t.offInterruptionBegin=function(e){this._player.offInterruptionBegin(e)},t.onInterruptionEnd=function(e){this._player.onInterruptionEnd(e)},t.offInterruptionEnd=function(e){this._player.offInterruptionEnd(e)},t.onEnded=function(e){this._player.onEnded(e)},t.offEnded=function(e){this._player.offEnded(e)},L(e,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),e}();dOe.maxAudioChannel=24;var mOe=e("AudioClip",sl("cc.AudioClip")((hOe=uOe=function(e){function t(){var t;return q(t=e.call(this)||this,"_duration",lOe,V(t)),t._loadMode=zPe.UNKNOWN_AUDIO,t._meta=null,t._player=void 0,t}F(t,e);var n=t.prototype;return n.destroy=function(){var t,n=e.prototype.destroy.call(this);return null===(t=this._player)||void 0===t||t.destroy(),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((function(){}))},n.setVolume=function(e){this._player&&(this._player.volume=e)},n.setLoop=function(e){this._player&&(this._player.loop=e)},n.play=function(){var e;null===(e=this._player)||void 0===e||e.play().catch((function(){}))},n.pause=function(){var e;null===(e=this._player)||void 0===e||e.pause().catch((function(){}))},n.stop=function(){var e;null===(e=this._player)||void 0===e||e.stop().catch((function(){}))},n.playOneShot=function(e){void 0===e&&(e=1),this._nativeAsset&&dOe.loadOneShotAudio(this._nativeAsset.url,e).then((function(e){e.play()})).catch((function(){}))},L(t,[{key:"_nativeAsset",get:function(){return this._meta},set:function(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=zPe.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:UPe.INIT}}]),t}(zu),uOe.AudioType=zPe,lOe=X((cOe=hOe).prototype,"_duration",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X(cOe.prototype,"_nativeDep",[Jl],Object.getOwnPropertyDescriptor(cOe.prototype,"_nativeDep"),cOe.prototype),sOe=cOe))||sOe);function vOe(e,t,n){dOe.load(e,{audioLoadMode:t.audioLoadMode}).then((function(t){var i={player:t,url:e,duration:t.duration,type:t.type};n(null,i)})).catch((function(e){n(e)}))}function gOe(e,t,n,i){var r=new mOe;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,i(null,r)}i.AudioClip=mOe,jN.register({".mp3":vOe,".ogg":vOe,".wav":vOe,".m4a":vOe}),ZN.register({".mp3":gOe,".ogg":gOe,".wav":gOe,".m4a":gOe});var yOe,SOe,xOe,TOe,EOe,bOe,COe,AOe,wOe,ROe,IOe,POe,OOe,DOe,MOe,NOe,LOe,BOe,FOe,zOe=new(function(){function e(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var t=e.prototype;return t._findIndex=function(e,t){return e.findIndex((function(e){return e.audio===t}))},t._tryAddPlaying=function(e,t){var n=this._findIndex(e,t);return n>-1?(e[n].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)},t.addPlaying=function(e){if(e instanceof dOe){if(this._tryAddPlaying(this._audioPlayerInfoList,e))return}else this._tryAddPlaying(this._oneShotAudioInfoList,e)},t._tryRemovePlaying=function(e,t){var n=this._findIndex(e,t);return-1!==n&&(Q(e,n),!0)},t.removePlaying=function(e){if(e instanceof dOe){if(this._tryRemovePlaying(this._audioPlayerInfoList,e))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,e)},t.discardOnePlayingIfNeeded=function(){var e;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<dOe.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio)))},e}());!function(e){e.STARTED="started",e.ENDED="ended"}(FOe||(FOe={}));var UOe=function(t){return e({AudioSource:t,AudioSourceComponent:t}),t}((yOe=sl("cc.AudioSource"),SOe=El(),xOe=yl(),TOe=Hl(mOe),EOe=Hl(mOe),bOe=Rl(),COe=Rl(),AOe=Rl(),wOe=Il(),ROe=Rl(),yOe(IOe=SOe(IOe=xOe((BOe=LOe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return q(t=e.call.apply(e,[this].concat(i))||this,"_clip",OOe,V(t)),t._player=null,q(t,"_loop",DOe,V(t)),q(t,"_playOnAwake",MOe,V(t)),q(t,"_volume",NOe,V(t)),t._cachedCurrentTime=0,t._operationsBeforeLoading=[],t._isLoaded=!1,t._lastSetClip=void 0,t}F(t,e);var n=t.prototype;return n._syncPlayer=function(){var e=this,t=this._clip;this._isLoaded=!1,t&&this._lastSetClip!==t&&(t._nativeAsset?(this._lastSetClip=t,dOe.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((function(n){e._lastSetClip===t&&(e._isLoaded=!0,e._player&&(e._player.offEnded(),e._player.offInterruptionBegin(),e._player.offInterruptionEnd(),e._player.destroy()),e._player=n,n.onEnded((function(){zOe.removePlaying(n),e.node.emit(FOe.ENDED,e)})),n.onInterruptionBegin((function(){zOe.removePlaying(n)})),n.onInterruptionEnd((function(){zOe.addPlaying(n)})),e._syncStates())})).catch((function(){}))):console.error("Invalid audio clip"))},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var e=this._getRootNode();(null==e?void 0:e._persistNode)||this.pause()},n.onDestroy=function(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy()},n._getRootNode=function(){for(var e,t,n=this.node,i=null===(e=n)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var e,t,n=this;this._isLoaded?(zOe.discardOnePlayingIfNeeded(),this.state===UPe.PLAYING&&(null===(t=this._player)||void 0===t||t.stop().catch((function(){}))),null===(e=this._player)||void 0===e||e.play().then((function(){zOe.addPlaying(n._player),n.node.emit(FOe.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.pause().then((function(){zOe.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.stop().then((function(){zOe.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(e,t){void 0===t&&(t=1),e._nativeAsset?dOe.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((function(e){zOe.discardOnePlayingIfNeeded(),e.onPlay=function(){zOe.addPlaying(e)},e.onEnd=function(){zOe.removePlaying(e)},e.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var e=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){e._player&&(e._player.loop=e._loop,e._player.volume=e._volume,e._operationsBeforeLoading.forEach((function(t){var n;null===(n=e[t])||void 0===n||n.call(e)})),e._operationsBeforeLoading.length=0)})).catch((function(){}))},L(t,[{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=Jn(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=Jn(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:UPe.INIT}},{key:"playing",get:function(){return this.state===t.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return dOe.maxAudioChannel}}]),t}(oh),LOe.AudioState=UPe,LOe.EventType=FOe,OOe=X((POe=BOe).prototype,"_clip",[TOe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DOe=X(POe.prototype,"_loop",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),MOe=X(POe.prototype,"_playOnAwake",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),NOe=X(POe.prototype,"_volume",[_l],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),X(POe.prototype,"clip",[EOe,bOe],Object.getOwnPropertyDescriptor(POe.prototype,"clip"),POe.prototype),X(POe.prototype,"loop",[COe],Object.getOwnPropertyDescriptor(POe.prototype,"loop"),POe.prototype),X(POe.prototype,"playOnAwake",[AOe],Object.getOwnPropertyDescriptor(POe.prototype,"playOnAwake"),POe.prototype),X(POe.prototype,"volume",[wOe,ROe],Object.getOwnPropertyDescriptor(POe.prototype,"volume"),POe.prototype),IOe=POe))||IOe)||IOe)||IOe));zn(mOe,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:UOe,targetName:"AudioSource"}]),kn(mOe.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(e){return{name:e,suggest:"please use AudioSource.prototype."+e+" instead"}}))),i.AudioSourceComponent=UOe,He.setClassAlias(UOe,"cc.AudioSourceComponent");var kOe=function(){function e(){this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}var t=e.prototype;return t.clone=function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t},t.isDone=function(){return!0},t.startWithTarget=function(e){this.originalTarget=e,this.target=e},t.stop=function(){this.target=null},t.step=function(){T(1006)},t.update=function(){T(1007)},t.getTarget=function(){return this.target},t.setTarget=function(e){this.target=e},t.getOriginalTarget=function(){return this.originalTarget},t.setOriginalTarget=function(e){this.originalTarget=e},t.getTag=function(){return this.tag},t.setTag=function(e){this.tag=e},t.reverse=function(){return T(1008),null},t.retain=function(){},t.release=function(){},e}();kOe.TAG_INVALID=-1;var GOe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._duration=0,t._timesForRepeat=1,t}F(t,e);var n=t.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(e){this._duration=e},n.clone=function(){return new t},t}(kOe),HOe=(function(e){function t(t,n){var i;return void 0===n&&(n=1),(i=e.call(this)||this)._speed=0,i._innerAction=null,t&&i.initWithAction(t,n),i}F(t,e);var n=t.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(e){this._speed=e},n.initWithAction=function(e,t){return e?(this._innerAction=e,this._speed=t,!0):(A(1021),!1)},n.clone=function(){var e=new t;return e.initWithAction(this._innerAction.clone(),this._speed),e},n.startWithTarget=function(e){kOe.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),kOe.prototype.stop.call(this)},n.step=function(e){this._innerAction.step(e*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new t(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction}}(kOe),0),VOe=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},jOe=function(){function e(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var t=e.prototype;return t._searchElementByTarget=function(e,t){for(var n=0;n<e.length;n++)if(t===e[n].target)return e[n];return null},t._getElement=function(e,t){var n=this._elementPool.pop();return n||(n=new VOe),n.target=e,n.paused=!!t,n},t._putElement=function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)},t.addAction=function(e,t,n){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+HOe++);var i=this._hashTargets.get(t);i?i.actions||(i.actions=[]):(i=this._getElement(t,n),this._hashTargets.set(t,i),this._arrayTargets.push(i)),i.target=t,i.actions.push(e),e.startWithTarget(t)}else A(1e3)},t.removeAllActions=function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var n=e[t];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},t.removeAllActionsFromTarget=function(e){if(null!=e){var t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}},t.removeAction=function(e){if(null!=e){var t=e.getOriginalTarget(),n=this._hashTargets.get(t);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===e){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},t._removeActionByTag=function(e,t,n){for(var i=0,r=t.actions.length;i<r;++i){var o=t.actions[i];if(o&&o.getTag()===e){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t);break}}},t.removeActionByTag=function(e,t){var n=this;e===kOe.TAG_INVALID&&T(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeActionByTag(e,r,t)}else i.forEach((function(t){n._removeActionByTag(e,t)}))},t.getActionByTag=function(e,t){e===kOe.TAG_INVALID&&T(1004);var n=this._hashTargets.get(t);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===e)return r}T(1005,e)}return null},t.getNumberOfRunningActionsInTarget=function(e){var t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0},t.pauseTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!0)},t.resumeTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!1)},t.pauseAllRunningActions=function(){for(var e=[],t=this._arrayTargets,n=0;n<t.length;n++){var i=t[n];i&&!i.paused&&(i.paused=!0,e.push(i.target))}return e},t.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])},t.pauseTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])},t.purgeSharedManager=function(){i.director.getScheduler().unscheduleUpdate(this)},t._removeActionAtIndex=function(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)},t._deleteHashElement=function(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}this._putElement(e),t=!0}return t},t.update=function(e){for(var t,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(t=this._currentTarget).target;if(r instanceof Qt&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var o=t.currentAction;t.currentAction=null,this.removeAction(o)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&i--}}},e}(),WOe=e("TweenSystem",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).actionMgr=new jOe,t}return F(t,e),t.prototype.update=function(e){this.actionMgr.update(e)},L(t,[{key:"ActionManager",get:function(){return this.actionMgr}}]),t}(kM));WOe.ID="TWEEN",WOe.instance=void 0,eN.on($M.EVENT_INIT,(function(){var e=new WOe;WOe.instance=e,eN.registerSystem(WOe.ID,e,kM.Priority.MEDIUM)}));var qOe=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new t},t}(GOe),XOe=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(bF),t=0;t<e.length;++t)e[t].enabled=!0},n.reverse=function(){return new YOe},n.clone=function(){return new t},t}(qOe),YOe=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(bF),t=0;t<e.length;++t)e[t].enabled=!1},n.reverse=function(){return new XOe},n.clone=function(){return new t},t}(qOe);!function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;n.update=function(){for(var e=this.target.getComponentsInChildren(bF),t=0;t<e.length;++t){var n=e[t];n.enabled=!n.enabled}},n.reverse=function(){return new t},n.clone=function(){return new t}}(qOe);var KOe=function(e){function t(t){var n;return(n=e.call(this)||this)._isNeedCleanUp=!0,void 0!==t&&n.init(t),n}F(t,e);var n=t.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(e){return this._isNeedCleanUp=e,!0},n.reverse=function(){return new t(this._isNeedCleanUp)},n.clone=function(){return new t(this._isNeedCleanUp)},t}(qOe),QOe=function(e){function t(t,n,i){var r;return(r=e.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(t,n,i),r}F(t,e);var n=t.prototype;return n.initWithFunction=function(e,t,n){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)},n.clone=function(){var e=new t;return e.initWithFunction(this._function,this._selectorTarget,this._data),e},t}(qOe),ZOe=function(e){function t(t){var n;return(n=e.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===t||isNaN(t)||n.initWithDuration(t),n}F(t,e);var n=t.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(e){return this._duration=0===e?tt.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod},n._reverseEaseList=function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}},n.clone=function(){var e=new t(this._duration);return this._cloneDecoration(e),e},n.easing=function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this},n._computeEaseTime=function(e){return e},n.step=function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=t<1?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(e){kOe.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return T(1010),this},n.setAmplitudeRate=function(){T(1011)},n.getAmplitudeRate=function(){return T(1012),0},n.speed=function(e){return e<=0?(T(1013),this):(this._speedMethod=!0,this._speed*=e,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(e){return this._speed=e,this},n.repeat=function(e){return e=Math.round(e),isNaN(e)||e<1?(T(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},t}(GOe),JOe=function(e){function t(n){var i;(i=e.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return A(1019),V(i);var o=r.length-1;if(o>=0&&null==r[o]&&T(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}F(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return A(1025),!1;var n=e._duration,i=t._duration,r=(n*=e._repeatMethod?e._timesForRepeat:1)+(i*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e},n.startWithTarget=function(e){ZOe.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),kOe.prototype.stop.call(this)},n.update=function(e){var t,n,i=0,r=this._split,o=this._actions,a=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,t=1===r?1:(e-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),t*=n._timesForRepeat,n.update(t>1?t%1:t),this._last=i)},n.reverse=function(){var e=t._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e},t}(ZOe);function $Oe(e){var t=e instanceof Array?e:arguments;if(1===t.length)return A(1019),null;var n=t.length-1;n>=0&&null==t[n]&&T(1015);var i=null;if(n>=0){i=t[0];for(var r=1;r<=n;r++)t[r]&&(i=JOe._actionOneTwo(i,t[r]))}return i}JOe._actionOneTwo=function(e,t){var n=new JOe;return n.initWithTwoActions(e,t),n};var eDe=function(e){function t(t,n){var i;return(i=e.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(t,n),i}F(t,e);var n=t.prototype;return n.initWithAction=function(e,t){var n=e._duration*t;return!!this.initWithDuration(n)&&(this._times=t,this._innerAction=e,e instanceof qOe&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e},n.startWithTarget=function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,ZOe.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),kOe.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e);var t=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<i;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/n,this._nextDt=r>1?1:r;e>=1&&this._total<i&&(t.update(1),this._total++),this._actionInstant||(this._total===i?t.stop():t.update(e-(r-t._duration/n)))}else t.update(e*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var e=new t(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(ZOe),tDe=function(e){function t(t){var n;return(n=e.call(this)||this)._innerAction=null,t&&n.initWithAction(t),n}F(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?(this._innerAction=e,!0):(A(1026),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e},n.startWithTarget=function(e){ZOe.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.step=function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))},n.isDone=function(){return!1},n.reverse=function(){var e=new t(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(ZOe),nDe=function(e){function t(n){var i;(i=e.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return A(1020),V(i);var o=r.length-1;if(o>=0&&null==r[o]&&T(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}F(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return A(1027),!1;var n=!1,i=e._duration,r=t._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=e,this._two=t,i>r?this._two=JOe._actionOneTwo(t,oDe(i-r)):i<r&&(this._one=JOe._actionOneTwo(e,oDe(r-i))),n=!0),n},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e},n.startWithTarget=function(e){ZOe.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)},n.stop=function(){this._one.stop(),this._two.stop(),kOe.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)},n.reverse=function(){var e=t._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},t}(ZOe);function iDe(e){var t=e instanceof Array?e:arguments;if(1===t.length)return A(1020),null;t.length>0&&null==t[t.length-1]&&T(1015);for(var n=t[0],i=1;i<t.length;i++)null!=t[i]&&(n=nDe._actionOneTwo(n,t[i]));return n}nDe._actionOneTwo=function(e,t){var n=new nDe;return n.initWithTwoActions(e,t),n};var rDe=function(e){function t(){return e.apply(this,arguments)||this}F(t,e);var n=t.prototype;return n.update=function(){},n.reverse=function(){var e=new t(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithDuration(this._duration),e},t}(ZOe);function oDe(e){return new rDe(e)}var aDe=function(e){function t(t){var n;return(n=e.call(this)||this)._other=null,t&&n.initWithAction(t),n}F(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?e===this._other?(A(1029),!1):!!ZOe.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(A(1028),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e},n.startWithTarget=function(e){ZOe.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)},n.update=function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),kOe.prototype.stop.call(this)},t}(ZOe),sDe=e("TweenAction",function(e){function t(t,n,i){var o;if((o=e.call(this)||this)._opts=void 0,o._props=void 0,o._originProps=void 0,null==i)i=Object.create(null);else if(function(e){var t=" [Tween:] ",n=" option is not support in v + "+r,i=e;i.delay&&p(t+"delay"+n),i.repeat&&p(t+"repeat"+n),i.repeatDelay&&p(t+"repeatDelay"+n),i.interpolation&&p(t+"interpolation"+n),i.onStop&&p(t+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var n=(e=e.replace(t,t.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)e="linear";else{var r=n[1];switch(i){case"quadratic":e="quad"+r;break;case"quartic":e="quart"+r;break;case"quintic":e="quint"+r;break;case"sinusoidal":e="sine"+r;break;case"exponential":e="expo"+r;break;case"circular":e="circ"+r;break;default:e=i+r}}}}return e}(i.easing)),i.progress||(i.progress=o.progress),i.easing&&"string"==typeof i.easing){var a=i.easing;i.easing=s_[a],i.easing||b(1031,a)}for(var s in o._opts=i,o._props=Object.create(null),n)if(n.hasOwnProperty(s)){var c=n[s];if("function"==typeof c&&(c=c()),null!=c&&"string"!=typeof c){var l=void 0,u=void 0;void 0!==c.value&&(c.easing||c.progress)&&("string"==typeof c.easing?(l=s_[c.easing])||b(1031,c.easing):l=c.easing,u=c.progress,c=c.value);var h=Object.create(null);h.value=c,h.easing=l,h.progress=u,o._props[s]=h}}return o._originProps=n,o.initWithDuration(t),o}F(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e},n.startWithTarget=function(e){ZOe.prototype.startWithTarget.call(this,e);var t=!!this._opts.relative,n=this._props;for(var i in n){var r=e[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=t?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=t?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(e){var t=this.target;if(t){var n=this._props,i=this._opts,r=e;i.easing&&(r=i.easing(e));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(e):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var f in u)s.current[f]=l(u[f],h[f],s.current[f],c);t[a]=s.current}i.onUpdate&&i.onUpdate(this.target,e),1===e&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(e,t,n,i){return e+(t-e)*i},t}(ZOe)),cDe=function(e){function t(t){var n;return(n=e.call(this)||this)._props=void 0,n._props={},void 0!==t&&n.init(t),n}F(t,e);var n=t.prototype;return n.init=function(e){for(var t in e)this._props[t]=e[t];return!0},n.update=function(){var e=this._props,t=this.target;for(var n in e)t[n]=e[n]},n.clone=function(){var e=new t;return e.init(this._props),e},t}(qOe),lDe=e("Tween",function(){function e(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=kOe.TAG_INVALID,this._target=void 0===e?null:e}var t=e.prototype;return t.tag=function(e){return this._tag=e,this},t.then=function(e){return e instanceof kOe?this._actions.push(e.clone()):this._actions.push(e._union()),this},t.target=function(e){return this._target=e,this},t.start=function(){return this._target?(this._finalAction&&WOe.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),WOe.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(p("Please set target to tween first"),this)},t.stop=function(){return this._finalAction&&WOe.instance.ActionManager.removeAction(this._finalAction),this},t.clone=function(e){var t=this._union();return uDe(e).then(t.clone())},t.union=function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this},t.to=function(e,t,n){(n=n||Object.create(null)).relative=!1;var i=new sDe(e,t,n);return this._actions.push(i),this},t.by=function(e,t,n){(n=n||Object.create(null)).relative=!0;var i=new sDe(e,t,n);return this._actions.push(i),this},t.set=function(e){var t=new cDe(e);return this._actions.push(t),this},t.delay=function(e){var t=oDe(e);return this._actions.push(t),this},t.call=function(e){var t=function(e){return new QOe(e,void 0,void 0)}(e);return this._actions.push(t),this},t.sequence=function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this},t.parallel=function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this},t.repeat=function(t,n){if(t==1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof e?n._union():r.pop(),r.push(function(e,t){return new eDe(e,t)}(i,t)),this},t.repeatForever=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new tDe(e)}(n)),this},t.reverseTime=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new aDe(e)}(n)),this},t.hide=function(){var e=new YOe;return this._actions.push(e),this},t.show=function(){var e=new XOe;return this._actions.push(e),this},t.removeSelf=function(){var e=new KOe(!1);return this._actions.push(e),this},e.stopAll=function(){WOe.instance.ActionManager.removeAllActions()},e.stopAllByTag=function(e,t){WOe.instance.ActionManager.removeActionByTag(e,t)},e.stopAllByTarget=function(e){WOe.instance.ActionManager.removeAllActionsFromTarget(e)},t._union=function(){var e=this._actions;return 1===e.length?e[0]:$Oe(e)},t._destroy=function(){this.stop()},e._wrappedSequence=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return $Oe.apply($Oe,t)},e._wrappedParallel=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return iDe.apply(iDe,t)},e}());function uDe(e){return new lDe(e)}function hDe(e){return p("tweenUtil' is deprecated, please use 'tween' instead "),new lDe(e)}lDe._tmp_args=[],i.Tween=lDe,i.tween=uDe,i.tweenUtil=hDe}}}));
